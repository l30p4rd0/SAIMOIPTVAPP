import{n as e,t}from"./rolldown-runtime-DF2fYuay.js";import{i as n,r}from"./catalog-D3FyGHSq.js";var i=Number.isFinite||function(e){return typeof e==`number`&&isFinite(e)},a=Number.isSafeInteger||function(e){return typeof e==`number`&&Math.abs(e)<=o},o=2**53-1||9007199254740991,s=function(e){return e.NETWORK_ERROR=`networkError`,e.MEDIA_ERROR=`mediaError`,e.KEY_SYSTEM_ERROR=`keySystemError`,e.MUX_ERROR=`muxError`,e.OTHER_ERROR=`otherError`,e}({}),c=function(e){return e.KEY_SYSTEM_NO_KEYS=`keySystemNoKeys`,e.KEY_SYSTEM_NO_ACCESS=`keySystemNoAccess`,e.KEY_SYSTEM_NO_SESSION=`keySystemNoSession`,e.KEY_SYSTEM_NO_CONFIGURED_LICENSE=`keySystemNoConfiguredLicense`,e.KEY_SYSTEM_LICENSE_REQUEST_FAILED=`keySystemLicenseRequestFailed`,e.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED=`keySystemServerCertificateRequestFailed`,e.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED=`keySystemServerCertificateUpdateFailed`,e.KEY_SYSTEM_SESSION_UPDATE_FAILED=`keySystemSessionUpdateFailed`,e.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED=`keySystemStatusOutputRestricted`,e.KEY_SYSTEM_STATUS_INTERNAL_ERROR=`keySystemStatusInternalError`,e.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR=`keySystemDestroyMediaKeysError`,e.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR=`keySystemDestroyCloseSessionError`,e.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR=`keySystemDestroyRemoveSessionError`,e.MANIFEST_LOAD_ERROR=`manifestLoadError`,e.MANIFEST_LOAD_TIMEOUT=`manifestLoadTimeOut`,e.MANIFEST_PARSING_ERROR=`manifestParsingError`,e.MANIFEST_INCOMPATIBLE_CODECS_ERROR=`manifestIncompatibleCodecsError`,e.LEVEL_EMPTY_ERROR=`levelEmptyError`,e.LEVEL_LOAD_ERROR=`levelLoadError`,e.LEVEL_LOAD_TIMEOUT=`levelLoadTimeOut`,e.LEVEL_PARSING_ERROR=`levelParsingError`,e.LEVEL_SWITCH_ERROR=`levelSwitchError`,e.AUDIO_TRACK_LOAD_ERROR=`audioTrackLoadError`,e.AUDIO_TRACK_LOAD_TIMEOUT=`audioTrackLoadTimeOut`,e.SUBTITLE_LOAD_ERROR=`subtitleTrackLoadError`,e.SUBTITLE_TRACK_LOAD_TIMEOUT=`subtitleTrackLoadTimeOut`,e.FRAG_LOAD_ERROR=`fragLoadError`,e.FRAG_LOAD_TIMEOUT=`fragLoadTimeOut`,e.FRAG_DECRYPT_ERROR=`fragDecryptError`,e.FRAG_PARSING_ERROR=`fragParsingError`,e.FRAG_GAP=`fragGap`,e.REMUX_ALLOC_ERROR=`remuxAllocError`,e.KEY_LOAD_ERROR=`keyLoadError`,e.KEY_LOAD_TIMEOUT=`keyLoadTimeOut`,e.BUFFER_ADD_CODEC_ERROR=`bufferAddCodecError`,e.BUFFER_INCOMPATIBLE_CODECS_ERROR=`bufferIncompatibleCodecsError`,e.BUFFER_APPEND_ERROR=`bufferAppendError`,e.BUFFER_APPENDING_ERROR=`bufferAppendingError`,e.BUFFER_STALLED_ERROR=`bufferStalledError`,e.BUFFER_FULL_ERROR=`bufferFullError`,e.BUFFER_SEEK_OVER_HOLE=`bufferSeekOverHole`,e.BUFFER_NUDGE_ON_STALL=`bufferNudgeOnStall`,e.ASSET_LIST_LOAD_ERROR=`assetListLoadError`,e.ASSET_LIST_LOAD_TIMEOUT=`assetListLoadTimeout`,e.ASSET_LIST_PARSING_ERROR=`assetListParsingError`,e.INTERSTITIAL_ASSET_ITEM_ERROR=`interstitialAssetItemError`,e.INTERNAL_EXCEPTION=`internalException`,e.INTERNAL_ABORTED=`aborted`,e.ATTACH_MEDIA_ERROR=`attachMediaError`,e.UNKNOWN=`unknown`,e}({}),l=function(e){return e.MEDIA_ATTACHING=`hlsMediaAttaching`,e.MEDIA_ATTACHED=`hlsMediaAttached`,e.MEDIA_DETACHING=`hlsMediaDetaching`,e.MEDIA_DETACHED=`hlsMediaDetached`,e.MEDIA_ENDED=`hlsMediaEnded`,e.STALL_RESOLVED=`hlsStallResolved`,e.BUFFER_RESET=`hlsBufferReset`,e.BUFFER_CODECS=`hlsBufferCodecs`,e.BUFFER_CREATED=`hlsBufferCreated`,e.BUFFER_APPENDING=`hlsBufferAppending`,e.BUFFER_APPENDED=`hlsBufferAppended`,e.BUFFER_EOS=`hlsBufferEos`,e.BUFFERED_TO_END=`hlsBufferedToEnd`,e.BUFFER_FLUSHING=`hlsBufferFlushing`,e.BUFFER_FLUSHED=`hlsBufferFlushed`,e.MANIFEST_LOADING=`hlsManifestLoading`,e.MANIFEST_LOADED=`hlsManifestLoaded`,e.MANIFEST_PARSED=`hlsManifestParsed`,e.LEVEL_SWITCHING=`hlsLevelSwitching`,e.LEVEL_SWITCHED=`hlsLevelSwitched`,e.LEVEL_LOADING=`hlsLevelLoading`,e.LEVEL_LOADED=`hlsLevelLoaded`,e.LEVEL_UPDATED=`hlsLevelUpdated`,e.LEVEL_PTS_UPDATED=`hlsLevelPtsUpdated`,e.LEVELS_UPDATED=`hlsLevelsUpdated`,e.AUDIO_TRACKS_UPDATED=`hlsAudioTracksUpdated`,e.AUDIO_TRACK_SWITCHING=`hlsAudioTrackSwitching`,e.AUDIO_TRACK_SWITCHED=`hlsAudioTrackSwitched`,e.AUDIO_TRACK_LOADING=`hlsAudioTrackLoading`,e.AUDIO_TRACK_LOADED=`hlsAudioTrackLoaded`,e.AUDIO_TRACK_UPDATED=`hlsAudioTrackUpdated`,e.SUBTITLE_TRACKS_UPDATED=`hlsSubtitleTracksUpdated`,e.SUBTITLE_TRACKS_CLEARED=`hlsSubtitleTracksCleared`,e.SUBTITLE_TRACK_SWITCH=`hlsSubtitleTrackSwitch`,e.SUBTITLE_TRACK_LOADING=`hlsSubtitleTrackLoading`,e.SUBTITLE_TRACK_LOADED=`hlsSubtitleTrackLoaded`,e.SUBTITLE_TRACK_UPDATED=`hlsSubtitleTrackUpdated`,e.SUBTITLE_FRAG_PROCESSED=`hlsSubtitleFragProcessed`,e.CUES_PARSED=`hlsCuesParsed`,e.NON_NATIVE_TEXT_TRACKS_FOUND=`hlsNonNativeTextTracksFound`,e.INIT_PTS_FOUND=`hlsInitPtsFound`,e.FRAG_LOADING=`hlsFragLoading`,e.FRAG_LOAD_EMERGENCY_ABORTED=`hlsFragLoadEmergencyAborted`,e.FRAG_LOADED=`hlsFragLoaded`,e.FRAG_DECRYPTED=`hlsFragDecrypted`,e.FRAG_PARSING_INIT_SEGMENT=`hlsFragParsingInitSegment`,e.FRAG_PARSING_USERDATA=`hlsFragParsingUserdata`,e.FRAG_PARSING_METADATA=`hlsFragParsingMetadata`,e.FRAG_PARSED=`hlsFragParsed`,e.FRAG_BUFFERED=`hlsFragBuffered`,e.FRAG_CHANGED=`hlsFragChanged`,e.FPS_DROP=`hlsFpsDrop`,e.FPS_DROP_LEVEL_CAPPING=`hlsFpsDropLevelCapping`,e.MAX_AUTO_LEVEL_UPDATED=`hlsMaxAutoLevelUpdated`,e.ERROR=`hlsError`,e.DESTROYING=`hlsDestroying`,e.KEY_LOADING=`hlsKeyLoading`,e.KEY_LOADED=`hlsKeyLoaded`,e.LIVE_BACK_BUFFER_REACHED=`hlsLiveBackBufferReached`,e.BACK_BUFFER_REACHED=`hlsBackBufferReached`,e.STEERING_MANIFEST_LOADED=`hlsSteeringManifestLoaded`,e.ASSET_LIST_LOADING=`hlsAssetListLoading`,e.ASSET_LIST_LOADED=`hlsAssetListLoaded`,e.INTERSTITIALS_UPDATED=`hlsInterstitialsUpdated`,e.INTERSTITIALS_BUFFERED_TO_BOUNDARY=`hlsInterstitialsBufferedToBoundary`,e.INTERSTITIAL_ASSET_PLAYER_CREATED=`hlsInterstitialAssetPlayerCreated`,e.INTERSTITIAL_STARTED=`hlsInterstitialStarted`,e.INTERSTITIAL_ASSET_STARTED=`hlsInterstitialAssetStarted`,e.INTERSTITIAL_ASSET_ENDED=`hlsInterstitialAssetEnded`,e.INTERSTITIAL_ASSET_ERROR=`hlsInterstitialAssetError`,e.INTERSTITIAL_ENDED=`hlsInterstitialEnded`,e.INTERSTITIALS_PRIMARY_RESUMED=`hlsInterstitialsPrimaryResumed`,e.PLAYOUT_LIMIT_REACHED=`hlsPlayoutLimitReached`,e.EVENT_CUE_ENTER=`hlsEventCueEnter`,e}({}),u={MANIFEST:`manifest`,LEVEL:`level`,AUDIO_TRACK:`audioTrack`,SUBTITLE_TRACK:`subtitleTrack`},d={MAIN:`main`,AUDIO:`audio`,SUBTITLE:`subtitle`},f=class{constructor(e,t=0,n=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=n}sample(e,t){let n=this.alpha_**+e;this.estimate_=t*(1-n)+n*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){let e=1-this.alpha_**+this.totalWeight_;if(e)return this.estimate_/e}return this.estimate_}},p=class{constructor(e,t,n,r=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=n,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new f(e),this.fast_=new f(t),this.defaultTTFB_=r,this.ttfb_=new f(e)}update(e,t){let{slow_:n,fast_:r,ttfb_:i}=this;n.halfLife!==e&&(this.slow_=new f(e,n.getEstimate(),n.getTotalWeight())),r.halfLife!==t&&(this.fast_=new f(t,r.getEstimate(),r.getTotalWeight())),i.halfLife!==e&&(this.ttfb_=new f(e,i.getEstimate(),i.getTotalWeight()))}sample(e,t){e=Math.max(e,this.minDelayMs_);let n=8*t,r=e/1e3,i=n/r;this.fast_.sample(r,i),this.slow_.sample(r,i)}sampleTTFB(e){let t=e/1e3,n=Math.sqrt(2)*Math.exp(-(t**2)/2);this.ttfb_.sample(n,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}};function m(e,t,n){return(t=y(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function h(){return h=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)({}).hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},h.apply(null,arguments)}function g(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function _(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]==null?{}:arguments[t];t%2?g(Object(n),!0).forEach(function(t){m(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):g(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function v(e,t){if(typeof e!=`object`||!e)return e;var n=e[Symbol.toPrimitive];if(n!==void 0){var r=n.call(e,t);if(typeof r!=`object`)return r;throw TypeError(`@@toPrimitive must return a primitive value.`)}return(t===`string`?String:Number)(e)}function y(e){var t=v(e,`string`);return typeof t==`symbol`?t:t+``}var b=class{constructor(e,t){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;let n=`[${e}]:`;this.trace=x,this.debug=t.debug.bind(null,n),this.log=t.log.bind(null,n),this.warn=t.warn.bind(null,n),this.info=t.info.bind(null,n),this.error=t.error.bind(null,n)}},x=function(){},S={trace:x,debug:x,log:x,warn:x,info:x,error:x};function C(){return h({},S)}function w(e,t){let n=self.console[e];return n?n.bind(self.console,`${t?`[`+t+`] `:``}[${e}] >`):x}function T(e,t,n){return t[e]?t[e].bind(t):w(e,n)}var E=C();function D(e,t,n){let r=C();if(typeof console==`object`&&e===!0||typeof e==`object`){let i=[`debug`,`log`,`info`,`warn`,`error`];i.forEach(t=>{r[t]=T(t,e,n)});try{r.log(`Debug logs enabled for "${t}" in hls.js version 1.6.15`)}catch{return C()}i.forEach(t=>{E[t]=T(t,e)})}else h(E,r);return r}var O=E;function k(e=!0){if(!(typeof self>`u`))return(e||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function A(e){return typeof self<`u`&&e===self.ManagedMediaSource}function j(e,t){let n=Object.keys(e),r=Object.keys(t),i=n.length,a=r.length;return!i||!a||i===a&&!n.some(e=>r.indexOf(e)===-1)}function M(e,t=!1){if(typeof TextDecoder<`u`){let n=new TextDecoder(`utf-8`).decode(e);if(t){let e=n.indexOf(`\0`);return e===-1?n:n.substring(0,e)}return n.replace(/\0/g,``)}let n=e.length,r,i,a,o=``,s=0;for(;s<n;){if(r=e[s++],r===0&&t)return o;if(!(r===0||r===3))switch(r>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(r);break;case 12:case 13:i=e[s++],o+=String.fromCharCode((r&31)<<6|i&63);break;case 14:i=e[s++],a=e[s++],o+=String.fromCharCode((r&15)<<12|(i&63)<<6|(a&63)<<0);break}}return o}function N(e){let t=``;for(let n=0;n<e.length;n++){let r=e[n].toString(16);r.length<2&&(r=`0`+r),t+=r}return t}function P(e){return Uint8Array.from(e.replace(/^0x/,``).replace(/([\da-fA-F]{2}) ?/g,`0x$1 `).replace(/ +$/,``).split(` `)).buffer}function F(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,`default`)?e.default:e}var I={exports:{}},L;function R(){return L?I.exports:(L=1,(function(e,t){(function(t){var n=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,r=/^(?=([^\/?#]*))\1([^]*)$/,i=/(?:\/|^)\.(?=\/)/g,a=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,o={buildAbsoluteURL:function(e,t,n){if(n||={},e=e.trim(),t=t.trim(),!t){if(!n.alwaysNormalize)return e;var i=o.parseURL(e);if(!i)throw Error(`Error trying to parse base URL.`);return i.path=o.normalizePath(i.path),o.buildURLFromParts(i)}var a=o.parseURL(t);if(!a)throw Error(`Error trying to parse relative URL.`);if(a.scheme)return n.alwaysNormalize?(a.path=o.normalizePath(a.path),o.buildURLFromParts(a)):t;var s=o.parseURL(e);if(!s)throw Error(`Error trying to parse base URL.`);if(!s.netLoc&&s.path&&s.path[0]!==`/`){var c=r.exec(s.path);s.netLoc=c[1],s.path=c[2]}s.netLoc&&!s.path&&(s.path=`/`);var l={scheme:s.scheme,netLoc:a.netLoc,path:null,params:a.params,query:a.query,fragment:a.fragment};if(!a.netLoc&&(l.netLoc=s.netLoc,a.path[0]!==`/`))if(!a.path)l.path=s.path,a.params||(l.params=s.params,a.query||(l.query=s.query));else{var u=s.path,d=u.substring(0,u.lastIndexOf(`/`)+1)+a.path;l.path=o.normalizePath(d)}return l.path===null&&(l.path=n.alwaysNormalize?o.normalizePath(a.path):a.path),o.buildURLFromParts(l)},parseURL:function(e){var t=n.exec(e);return t?{scheme:t[1]||``,netLoc:t[2]||``,path:t[3]||``,params:t[4]||``,query:t[5]||``,fragment:t[6]||``}:null},normalizePath:function(e){for(e=e.split(``).reverse().join(``).replace(i,``);e.length!==(e=e.replace(a,``)).length;);return e.split(``).reverse().join(``)},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}};e.exports=o})()})(I),I.exports)}var z=R(),B=class{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}},V={AUDIO:`audio`,VIDEO:`video`,AUDIOVIDEO:`audiovideo`},ee=class{constructor(e){this._byteRange=null,this._url=null,this._stats=null,this._streams=null,this.base=void 0,this.relurl=void 0,typeof e==`string`&&(e={url:e}),this.base=e,ie(this,`stats`)}setByteRange(e,t){let n=e.split(`@`,2),r;r=n.length===1?t?.byteRangeEndOffset||0:parseInt(n[1]),this._byteRange=[r,parseInt(n[0])+r]}get baseurl(){return this.base.url}get byteRange(){return this._byteRange===null?[]:this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get elementaryStreams(){return this._streams===null&&(this._streams={[V.AUDIO]:null,[V.VIDEO]:null,[V.AUDIOVIDEO]:null}),this._streams}set elementaryStreams(e){this._streams=e}get hasStats(){return this._stats!==null}get hasStreams(){return this._streams!==null}get stats(){return this._stats===null&&(this._stats=new B),this._stats}set stats(e){this._stats=e}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=z.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||``}set url(e){this._url=e}clearElementaryStreamInfo(){let{elementaryStreams:e}=this;e[V.AUDIO]=null,e[V.VIDEO]=null,e[V.AUDIOVIDEO]=null}};function H(e){return e.sn!==`initSegment`}var te=class extends ee{constructor(e,t){super(t),this._decryptdata=null,this._programDateTime=null,this._ref=null,this._bitrate=void 0,this.rawProgramDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.playlistOffset=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get byteLength(){if(this.hasStats){let e=this.stats.total;if(e)return e}if(this.byteRange.length){let e=this.byteRange[0],t=this.byteRange[1];if(i(e)&&i(t))return t-e}return null}get bitrate(){return this.byteLength?this.byteLength*8/this.duration:this._bitrate?this._bitrate:null}set bitrate(e){this._bitrate=e}get decryptdata(){var e;let{levelkeys:t}=this;if(!t||t.NONE)return null;if(t.identity)this._decryptdata||=t.identity.getDecryptData(this.sn);else if(!((e=this._decryptdata)!=null&&e.keyId)){let e=Object.keys(t);if(e.length===1){let n=this._decryptdata=t[e[0]]||null;n&&(this._decryptdata=n.getDecryptData(this.sn,t))}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null)return null;let e=i(this.duration)?this.duration:0;return this.programDateTime+e*1e3}get encrypted(){var e;if((e=this._decryptdata)!=null&&e.encrypted)return!0;if(this.levelkeys){var t;let e=Object.keys(this.levelkeys),n=e.length;if(n>1||n===1&&(t=this.levelkeys[e[0]])!=null&&t.encrypted)return!0}return!1}get programDateTime(){return this._programDateTime===null&&this.rawProgramDateTime&&(this.programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime}set programDateTime(e){if(!i(e)){this._programDateTime=this.rawProgramDateTime=null;return}this._programDateTime=e}get ref(){return H(this)?(this._ref||={base:this.base,start:this.start,duration:this.duration,sn:this.sn,programDateTime:this.programDateTime},this._ref):null}addStart(e){this.setStart(this.start+e)}setStart(e){this.start=e,this._ref&&(this._ref.start=e)}setDuration(e){this.duration=e,this._ref&&(this._ref.duration=e)}setKeyFormat(e){let t=this.levelkeys;if(t){var n;let r=t[e];r&&!((n=this._decryptdata)!=null&&n.keyId)&&(this._decryptdata=r.getDecryptData(this.sn,t))}}abortRequests(){var e,t;(e=this.loader)==null||e.abort(),(t=this.keyLoader)==null||t.abort()}setElementaryStreamInfo(e,t,n,r,i,a=!1){let{elementaryStreams:o}=this,s=o[e];if(!s){o[e]={startPTS:t,endPTS:n,startDTS:r,endDTS:i,partial:a};return}s.startPTS=Math.min(s.startPTS,t),s.endPTS=Math.max(s.endPTS,n),s.startDTS=Math.min(s.startDTS,r),s.endDTS=Math.max(s.endDTS,i)}},ne=class extends ee{constructor(e,t,n,r,i){super(n),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.duration=e.decimalFloatingPoint(`DURATION`),this.gap=e.bool(`GAP`),this.independent=e.bool(`INDEPENDENT`),this.relurl=e.enumeratedString(`URI`),this.fragment=t,this.index=r;let a=e.enumeratedString(`BYTERANGE`);a&&this.setByteRange(a,i),i&&(this.fragOffset=i.fragOffset+i.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){let{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}};function re(e,t){let n=Object.getPrototypeOf(e);if(n)return Object.getOwnPropertyDescriptor(n,t)||re(n,t)}function ie(e,t){let n=re(e,t);n&&(n.enumerable=!0,Object.defineProperty(e,t,n))}var ae=2**32-1,oe=[].push,se={video:1,audio:2,id3:3,text:4};function U(e){return String.fromCharCode.apply(null,e)}function ce(e,t){let n=e[t]<<8|e[t+1];return n<0?65536+n:n}function W(e,t){let n=G(e,t);return n<0?4294967296+n:n}function le(e,t){let n=W(e,t);return n*=2**32,n+=W(e,t+4),n}function G(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function ue(e){let t=e.byteLength;for(let n=0;n<t;){let r=W(e,n);if(r>8&&e[n+4]===109&&e[n+5]===111&&e[n+6]===111&&e[n+7]===102)return!0;n=r>1?n+r:t}return!1}function K(e,t){let n=[];if(!t.length)return n;let r=e.byteLength;for(let i=0;i<r;){let a=W(e,i),o=U(e.subarray(i+4,i+8)),s=a>1?i+a:r;if(o===t[0])if(t.length===1)n.push(e.subarray(i+8,s));else{let r=K(e.subarray(i+8,s),t.slice(1));r.length&&oe.apply(n,r)}i=s}return n}function de(e){let t=[],n=e[0],r=8,i=W(e,r);r+=4;let a=0,o=0;n===0?(a=W(e,r),o=W(e,r+4),r+=8):(a=le(e,r),o=le(e,r+8),r+=16),r+=2;let s=e.length+o,c=ce(e,r);r+=2;for(let n=0;n<c;n++){let n=r,a=W(e,n);n+=4;let o=a&2147483647;if((a&2147483648)>>>31==1)return O.warn(`SIDX has hierarchical references (not supported)`),null;let c=W(e,n);n+=4,t.push({referenceSize:o,subsegmentDuration:c,info:{duration:c/i,start:s,end:s+o-1}}),s+=o,n+=4,r=n}return{earliestPresentationTime:a,timescale:i,version:n,referencesCount:c,references:t}}function fe(e){let t=[],n=K(e,[`moov`,`trak`]);for(let e=0;e<n.length;e++){let r=n[e],i=K(r,[`tkhd`])[0];if(i){let e=i[0],n=W(i,e===0?12:20),a=K(r,[`mdia`,`mdhd`])[0];if(a){e=a[0];let i=W(a,e===0?12:20),o=K(r,[`mdia`,`hdlr`])[0];if(o){let e=U(o.subarray(8,12)),a={soun:V.AUDIO,vide:V.VIDEO}[e],s=K(r,[`mdia`,`minf`,`stbl`,`stsd`])[0],c=pe(s);a?(t[n]={timescale:i,type:a,stsd:c},t[a]=_({timescale:i,id:n},c)):t[n]={timescale:i,type:e,stsd:c}}}}}return K(e,[`moov`,`mvex`,`trex`]).forEach(e=>{let n=t[W(e,4)];n&&(n.default={duration:W(e,12),flags:W(e,20)})}),t}function pe(e){let t=e.subarray(8),n=t.subarray(86),r=U(t.subarray(4,8)),i=r,a,o=r===`enca`||r===`encv`;o&&K(K(t,[r])[0].subarray(r===`enca`?28:78),[`sinf`]).forEach(e=>{let t=K(e,[`schm`])[0];if(t){let n=U(t.subarray(4,8));if(n===`cbcs`||n===`cenc`){let t=K(e,[`frma`])[0];t&&(i=U(t))}}});let s=i;switch(i){case`avc1`:case`avc2`:case`avc3`:case`avc4`:{let e=K(n,[`avcC`])[0];e&&e.length>3&&(i+=`.`+_e(e[1])+_e(e[2])+_e(e[3]),a=me(s===`avc1`?`dva1`:`dvav`,n));break}case`mp4a`:{let e=K(t,[r])[0],n=K(e.subarray(28),[`esds`])[0];if(n&&n.length>7){let e=4;if(n[e++]!==3)break;e=ge(n,e),e+=2;let t=n[e++];if(t&128&&(e+=2),t&64&&(e+=n[e++]),n[e++]!==4)break;e=ge(n,e);let r=n[e++];if(r===64)i+=`.`+_e(r);else break;if(e+=12,n[e++]!==5)break;e=ge(n,e);let a=n[e++],o=(a&248)>>3;o===31&&(o+=1+((a&7)<<3)+((n[e]&224)>>5)),i+=`.`+o}break}case`hvc1`:case`hev1`:{let e=K(n,[`hvcC`])[0];if(e&&e.length>12){let t=e[1],n=[``,`A`,`B`,`C`][t>>6],r=t&31,a=W(e,2),o=(t&32)>>5?`H`:`L`,s=e[12],c=e.subarray(6,12);i+=`.`+n+r,i+=`.`+he(a).toString(16).toUpperCase(),i+=`.`+o+s;let l=``;for(let e=c.length;e--;){let t=c[e];(t||l)&&(l=`.`+t.toString(16).toUpperCase()+l)}i+=l}a=me(s==`hev1`?`dvhe`:`dvh1`,n);break}case`dvh1`:case`dvhe`:case`dvav`:case`dva1`:case`dav1`:i=me(i,n)||i;break;case`vp09`:{let e=K(n,[`vpcC`])[0];if(e&&e.length>6){let t=e[4],n=e[5],r=e[6]>>4&15;i+=`.`+ve(t)+`.`+ve(n)+`.`+ve(r)}break}case`av01`:{let e=K(n,[`av1C`])[0];if(e&&e.length>2){let t=e[1]>>>5,r=e[1]&31,o=e[2]>>>7?`H`:`M`,s=(e[2]&64)>>6,c=(e[2]&32)>>5,l=t===2&&s?c?12:10:s?10:8,u=(e[2]&16)>>4,d=(e[2]&8)>>3,f=(e[2]&4)>>2,p=e[2]&3;i+=`.`+t+`.`+ve(r)+o+`.`+ve(l)+`.`+u+`.`+d+f+p+`.`+ve(1)+`.`+ve(1)+`.`+ve(1)+`.0`,a=me(`dav1`,n)}break}}return{codec:i,encrypted:o,supplemental:a}}function me(e,t){let n=K(t,[`dvvC`]),r=n.length?n[0]:K(t,[`dvcC`])[0];if(r){let t=r[2]>>1&127,n=r[2]<<5&32|r[3]>>3&31;return e+`.`+ve(t)+`.`+ve(n)}}function he(e){let t=0;for(let n=0;n<32;n++)t|=(e>>n&1)<<31-n;return t>>>0}function ge(e,t){let n=t+5;for(;e[t++]&128&&t<n;);return t}function _e(e){return(`0`+e.toString(16).toUpperCase()).slice(-2)}function ve(e){return(e<10?`0`:``)+e}function ye(e,t){if(!e||!t)return;let n=t.keyId;n&&t.isCommonEncryption&&xe(e,(e,t)=>{let r=e.subarray(8,24);r.some(e=>e!==0)||(O.log(`[eme] Patching keyId in 'enc${t?`a`:`v`}>sinf>>tenc' box: ${N(r)} -> ${N(n)}`),e.set(n,8))})}function be(e){let t=[];return xe(e,e=>t.push(e.subarray(8,24))),t}function xe(e,t){K(e,[`moov`,`trak`]).forEach(e=>{let n=K(e,[`mdia`,`minf`,`stbl`,`stsd`])[0];if(!n)return;let r=n.subarray(8),i=K(r,[`enca`]),a=i.length>0;a||(i=K(r,[`encv`])),i.forEach(e=>{K(a?e.subarray(28):e.subarray(78),[`sinf`]).forEach(e=>{let n=Se(e);n&&t(n,a)})})})}function Se(e){let t=K(e,[`schm`])[0];if(t){let n=U(t.subarray(4,8));if(n===`cbcs`||n===`cenc`){let t=K(e,[`schi`,`tenc`])[0];if(t)return t}}}function Ce(e,t,n){let r={},a=K(e,[`moof`,`traf`]);for(let e=0;e<a.length;e++){let o=a[e],s=K(o,[`tfhd`])[0],c=W(s,4),l=t[c];if(!l)continue;r[c]||(r[c]={start:NaN,duration:0,sampleCount:0,timescale:l.timescale,type:l.type});let u=r[c],d=K(o,[`tfdt`])[0];if(d){let e=d[0],t=W(d,4);e===1&&(t===ae?n.warn(`[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time`):(t*=ae+1,t+=W(d,8))),i(t)&&(!i(u.start)||t<u.start)&&(u.start=t)}let f=l.default,p=W(s,0)|f?.flags,m=f?.duration||0;p&8&&(m=p&2?W(s,12):W(s,8));let h=K(o,[`trun`]),g=u.start||0,_=0,v=m;for(let e=0;e<h.length;e++){let t=h[e],n=W(t,4),r=u.sampleCount;u.sampleCount+=n;let i=t[3]&1,a=t[3]&4,o=t[2]&1,s=t[2]&2,c=t[2]&4,l=t[2]&8,d=8,f=n;for(i&&(d+=4),a&&n&&(!(t[d+1]&1)&&u.keyFrameIndex===void 0&&(u.keyFrameIndex=r),d+=4,o?(v=W(t,d),d+=4):v=m,s&&(d+=4),l&&(d+=4),g+=v,_+=v,f--);f--;)o?(v=W(t,d),d+=4):v=m,s&&(d+=4),c&&(t[d+1]&1||u.keyFrameIndex===void 0&&(u.keyFrameIndex=u.sampleCount-(f+1),u.keyFrameStart=g),d+=4),l&&(d+=4),g+=v,_+=v;!_&&m&&(_+=m*n)}u.duration+=_}if(!Object.keys(r).some(e=>r[e].duration)){let t=1/0,n=0,a=K(e,[`sidx`]);for(let e=0;e<a.length;e++){let r=de(a[e]);if(r!=null&&r.references){t=Math.min(t,r.earliestPresentationTime/r.timescale);let e=r.references.reduce((e,t)=>e+t.info.duration||0,0);n=Math.max(n,e+r.earliestPresentationTime/r.timescale)}}n&&i(n)&&Object.keys(r).forEach(e=>{r[e].duration||(r[e].duration=n*r[e].timescale-r[e].start)})}return r}function we(e){let t={valid:null,remainder:null},n=K(e,[`moof`]);if(n.length<2)return t.remainder=e,t;let r=n[n.length-1];return t.valid=e.slice(0,r.byteOffset-8),t.remainder=e.slice(r.byteOffset-8),t}function Te(e,t){let n=new Uint8Array(e.length+t.length);return n.set(e),n.set(t,e.length),n}function Ee(e,t){let n=[],r=t.samples,i=t.timescale,a=t.id,o=!1;return K(r,[`moof`]).map(s=>{let c=s.byteOffset-8;K(s,[`traf`]).map(s=>{let l=K(s,[`tfdt`]).map(e=>{let t=e[0],n=W(e,4);return t===1&&(n*=2**32,n+=W(e,8)),n/i})[0];return l!==void 0&&(e=l),K(s,[`tfhd`]).map(l=>{let u=W(l,4),d=W(l,0)&16777215,f=(d&1)!=0,p=(d&2)!=0,m=(d&8)!=0,h=0,g=(d&16)!=0,_=0,v=(d&32)!=0,y=8;u===a&&(f&&(y+=8),p&&(y+=4),m&&(h=W(l,y),y+=4),g&&(_=W(l,y),y+=4),v&&(y+=4),t.type===`video`&&(o=De(t.codec)),K(s,[`trun`]).map(a=>{let s=a[0],l=W(a,0)&16777215,u=(l&1)!=0,d=0,f=(l&4)!=0,p=(l&256)!=0,m=0,g=(l&512)!=0,v=0,y=(l&1024)!=0,b=(l&2048)!=0,x=0,S=W(a,4),C=8;u&&(d=W(a,C),C+=4),f&&(C+=4);let w=d+c;for(let c=0;c<S;c++){if(p?(m=W(a,C),C+=4):m=h,g?(v=W(a,C),C+=4):v=_,y&&(C+=4),b&&(x=s===0?W(a,C):G(a,C),C+=4),t.type===V.VIDEO){let t=0;for(;t<v;){let a=W(r,w);w+=4,Oe(o,r[w])&&ke(r.subarray(w,w+a),o?2:1,e+x/i,n),w+=a,t+=a+4}}e+=m/i}}))})})}),n}function De(e){if(!e)return!1;let t=e.substring(0,4);return t===`hvc1`||t===`hev1`||t===`dvh1`||t===`dvhe`}function Oe(e,t){if(e){let e=t>>1&63;return e===39||e===40}else return(t&31)==6}function ke(e,t,n,r){let i=Ae(e),a=0;a+=t;let o=0,s=0,c=0;for(;a<i.length;){o=0;do{if(a>=i.length)break;c=i[a++],o+=c}while(c===255);s=0;do{if(a>=i.length)break;c=i[a++],s+=c}while(c===255);let e=i.length-a,t=a;if(s<e)a+=s;else if(s>e){O.error(`Malformed SEI payload. ${s} is too small, only ${e} bytes left to parse.`);break}if(o===4){if(i[t++]===181){let e=ce(i,t);if(t+=2,e===49){let e=W(i,t);if(t+=4,e===1195456820){let e=i[t++];if(e===3){let a=i[t++],s=31&a,c=64&a,l=c?2+s*3:0,u=new Uint8Array(l);if(c){u[0]=a;for(let e=1;e<l;e++)u[e]=i[t++]}r.push({type:e,payloadType:o,pts:n,bytes:u})}}}}}else if(o===5&&s>16){let e=[];for(let n=0;n<16;n++){let r=i[t++].toString(16);e.push(r.length==1?`0`+r:r),(n===3||n===5||n===7||n===9)&&e.push(`-`)}let a=s-16,c=new Uint8Array(a);for(let e=0;e<a;e++)c[e]=i[t++];r.push({payloadType:o,pts:n,uuid:e.join(``),userData:M(c),userDataBytes:c})}}}function Ae(e){let t=e.byteLength,n=[],r=1;for(;r<t-2;)e[r]===0&&e[r+1]===0&&e[r+2]===3?(n.push(r+2),r+=2):r++;if(n.length===0)return e;let i=t-n.length,a=new Uint8Array(i),o=0;for(r=0;r<i;o++,r++)o===n[0]&&(o++,n.shift()),a[r]=e[o];return a}function je(e){let t=e[0],n=``,r=``,i=0,o=0,s=0,c=0,l=0,u=0;if(t===0){for(;U(e.subarray(u,u+1))!==`\0`;)n+=U(e.subarray(u,u+1)),u+=1;for(n+=U(e.subarray(u,u+1)),u+=1;U(e.subarray(u,u+1))!==`\0`;)r+=U(e.subarray(u,u+1)),u+=1;r+=U(e.subarray(u,u+1)),u+=1,i=W(e,12),o=W(e,16),c=W(e,20),l=W(e,24),u=28}else if(t===1){u+=4,i=W(e,u),u+=4;let t=W(e,u);u+=4;let o=W(e,u);for(u+=4,s=2**32*t+o,a(s)||(s=2**53-1,O.warn(`Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box`)),c=W(e,u),u+=4,l=W(e,u),u+=4;U(e.subarray(u,u+1))!==`\0`;)n+=U(e.subarray(u,u+1)),u+=1;for(n+=U(e.subarray(u,u+1)),u+=1;U(e.subarray(u,u+1))!==`\0`;)r+=U(e.subarray(u,u+1)),u+=1;r+=U(e.subarray(u,u+1)),u+=1}let d=e.subarray(u,e.byteLength);return{schemeIdUri:n,value:r,timeScale:i,presentationTime:s,presentationTimeDelta:o,eventDuration:c,id:l,payload:d}}function Me(e,...t){let n=t.length,r=8,i=n;for(;i--;)r+=t[i].byteLength;let a=new Uint8Array(r);for(a[0]=r>>24&255,a[1]=r>>16&255,a[2]=r>>8&255,a[3]=r&255,a.set(e,4),i=0,r=8;i<n;i++)a.set(t[i],r),r+=t[i].byteLength;return a}function Ne(e,t,n){if(e.byteLength!==16)throw RangeError(`Invalid system id`);let r,i;r=0,i=new Uint8Array;let a;r>0?(a=new Uint8Array(4),t.length>0&&new DataView(a.buffer).setUint32(0,t.length,!1)):a=new Uint8Array;let o=new Uint8Array(4);return n.byteLength>0&&new DataView(o.buffer).setUint32(0,n.byteLength,!1),Me([112,115,115,104],new Uint8Array([r,0,0,0]),e,a,i,o,n)}function Pe(e){let t=[];if(e instanceof ArrayBuffer){let n=e.byteLength,r=0;for(;r+32<n;){let n=Fe(new DataView(e,r));t.push(n),r+=n.size}}return t}function Fe(e){let t=e.getUint32(0),n=e.byteOffset,r=e.byteLength;if(r<t)return{offset:n,size:r};if(e.getUint32(4)!==1886614376)return{offset:n,size:t};let i=e.getUint32(8)>>>24;if(i!==0&&i!==1)return{offset:n,size:t};let a=e.buffer,o=N(new Uint8Array(a,n+12,16)),s=null,c=null,l=0;if(i===0)l=28;else{let i=e.getUint32(28);if(!i||r<32+i*16)return{offset:n,size:t};s=[];for(let e=0;e<i;e++)s.push(new Uint8Array(a,n+32+e*16,16));l=32+i*16}if(!l)return{offset:n,size:t};let u=e.getUint32(l);return t-32<u?{offset:n,size:t}:(c=new Uint8Array(a,n+l+4,u),{version:i,systemId:o,kids:s,data:c,offset:n,size:t})}var Ie=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),Le={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function Re(e,t){let n=Le[t];return!!n&&!!n[e.slice(0,4)]}function ze(e,t,n=!0){return!e.split(`,`).some(e=>!Be(e,t,n))}function Be(e,t,n=!0){return k(n)?.isTypeSupported(Ve(e,t))??!1}function Ve(e,t){return`${t}/mp4;codecs=${e}`}function He(e){if(e){let t=e.substring(0,4);return Le.video[t]}return 2}function Ue(e){let t=Ie();return e.split(`,`).reduce((e,n)=>{let r=t&&De(n)?9:Le.video[n];return r?(r*2+e)/(e?3:2):(Le.audio[n]+e)/(e?2:1)},0)}var We={};function Ge(e,t=!0){if(We[e])return We[e];let n={flac:[`flac`,`fLaC`,`FLAC`],opus:[`opus`,`Opus`],"mp4a.40.34":[`mp3`]}[e];for(let i=0;i<n.length;i++){var r;if(Be(n[i],`audio`,t))return We[e]=n[i],n[i];if(n[i]===`mp3`&&(r=k(t))!=null&&r.isTypeSupported(`audio/mpeg`))return``}return e}var Ke=/flac|opus|mp4a\.40\.34/i;function qe(e,t=!0){return e.replace(Ke,e=>Ge(e.toLowerCase(),t))}function Je(e,t){let n=[];if(e){let t=e.split(`,`);for(let e=0;e<t.length;e++)Re(t[e],`video`)||n.push(t[e])}return t&&n.push(t),n.join(`,`)}function Ye(e,t){if(e&&(e.length>4||[`ac-3`,`ec-3`,`alac`,`fLaC`,`Opus`].indexOf(e)!==-1)&&(Xe(e,`audio`)||Xe(e,`video`)))return e;if(t){let n=t.split(`,`);if(n.length>1){if(e){for(let t=n.length;t--;)if(n[t].substring(0,4)===e.substring(0,4))return n[t]}return n[0]}}return t||e}function Xe(e,t){return Re(e,t)&&Be(e,t)}function Ze(e){let t=e.split(`,`);for(let e=0;e<t.length;e++){let n=t[e].split(`.`);n.length>2&&n[0]===`avc1`&&(t[e]=`avc1.${parseInt(n[1]).toString(16)}${(`000`+parseInt(n[2]).toString(16)).slice(-4)}`)}return t.join(`,`)}function Qe(e){if(e.startsWith(`av01.`)){let t=e.split(`.`),n=[`0`,`111`,`01`,`01`,`01`,`0`];for(let e=t.length;e>4&&e<10;e++)t[e]=n[e-4];return t.join(`.`)}return e}function $e(e){let t=k(e)||{isTypeSupported:()=>!1};return{mpeg:t.isTypeSupported(`audio/mpeg`),mp3:t.isTypeSupported(`audio/mp4; codecs="mp3"`),ac3:t.isTypeSupported(`audio/mp4; codecs="ac-3"`)}}function et(e){return e.replace(/^.+codecs=["']?([^"']+).*$/,`$1`)}var tt={supported:!0,powerEfficient:!0,smooth:!0},nt={supported:!1,smooth:!1,powerEfficient:!1},rt={supported:!0,configurations:[],decodingInfoResults:[tt]};function it(e,t){return{supported:!1,configurations:t,decodingInfoResults:[nt],error:e}}function at(e,t,n,r,a,o){let s=e.videoCodec,c=e.audioCodec?e.audioGroups:null,l=o?.audioCodec,u=o?.channels,d=u?parseInt(u):l?1/0:2,f=null;if(c!=null&&c.length)try{f=c.length===1&&c[0]?t.groups[c[0]].channels:c.reduce((e,n)=>{if(n){let r=t.groups[n];if(!r)throw Error(`Audio track group ${n} not found`);Object.keys(r.channels).forEach(t=>{e[t]=(e[t]||0)+r.channels[t]})}return e},{2:0})}catch{return!0}return s!==void 0&&(s.split(`,`).some(e=>De(e))||e.width>1920&&e.height>1088||e.height>1920&&e.width>1088||e.frameRate>Math.max(r,30)||e.videoRange!==`SDR`&&e.videoRange!==n||e.bitrate>Math.max(a,8e6))||!!f&&i(d)&&Object.keys(f).some(e=>parseInt(e)>d)}function ot(e,t,n,r={}){let i=e.videoCodec;if(!i&&!e.audioCodec||!n)return Promise.resolve(rt);let a=[],o=st(e),s=o.length,c=ct(e,t,s>0),l=c.length;for(let e=s||1*l||1;e--;){let t={type:`media-source`};if(s&&(t.video=o[e%s]),l){t.audio=c[e%l];let n=t.audio.bitrate;t.video&&n&&(t.video.bitrate-=n)}a.push(t)}if(i){let e=navigator.userAgent;if(i.split(`,`).some(e=>De(e))&&Ie())return Promise.resolve(it(Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent string: (${e})`),a))}return Promise.all(a.map(e=>{let t=dt(e);return r[t]||(r[t]=n.decodingInfo(e))})).then(e=>({supported:!e.some(e=>!e.supported),configurations:a,decodingInfoResults:e})).catch(e=>({supported:!1,configurations:a,decodingInfoResults:[],error:e}))}function st(e){let t=e.videoCodec?.split(`,`),n=ut(e),r=e.width||640,i=e.height||480,a=e.frameRate||30,o=e.videoRange.toLowerCase();return t?t.map(e=>{let t={contentType:Ve(Qe(e),`video`),width:r,height:i,bitrate:n,framerate:a};return o!==`sdr`&&(t.transferFunction=o),t}):[]}function ct(e,t,n){let r=e.audioCodec?.split(`,`),i=ut(e);return r&&e.audioGroups?e.audioGroups.reduce((e,a)=>{let o=a?t.groups[a]?.tracks:null;return o?o.reduce((e,t)=>{if(t.groupId===a){let a=parseFloat(t.channels||``);r.forEach(t=>{let r={contentType:Ve(t,`audio`),bitrate:n?lt(t,i):i};a&&(r.channels=``+a),e.push(r)})}return e},e):e},[]):[]}function lt(e,t){if(t<=1)return 1;let n=128e3;return e===`ec-3`?n=768e3:e===`ac-3`&&(n=64e4),Math.min(t/2,n)}function ut(e){return Math.ceil(Math.max(e.bitrate*.9,e.averageBitrate)/1e3)*1e3||1}function dt(e){let t=``,{audio:n,video:r}=e;if(r){let e=et(r.contentType);t+=`${e}_r${r.height}x${r.width}f${Math.ceil(r.framerate)}${r.transferFunction||`sd`}_${Math.ceil(r.bitrate/1e5)}`}if(n){let e=et(n.contentType);t+=`${r?`_`:``}${e}_c${n.channels}`}return t}var ft=[`NONE`,`TYPE-0`,`TYPE-1`,null];function pt(e){return ft.indexOf(e)>-1}var mt=[`SDR`,`PQ`,`HLG`];function ht(e){return!!e&&mt.indexOf(e)>-1}var gt={No:``,Yes:`YES`,v2:`v2`};function _t(e){let{canSkipUntil:t,canSkipDateRanges:n,age:r}=e,i=r<t/2;return t&&i?n?gt.v2:gt.Yes:gt.No}var vt=class{constructor(e,t,n){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=n}addDirectives(e){let t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set(`_HLS_msn`,this.msn.toString()),this.part!==void 0&&t.searchParams.set(`_HLS_part`,this.part.toString()),this.skip&&t.searchParams.set(`_HLS_skip`,this.skip),t.href}},yt=class{constructor(e){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat(`FRAME-RATE`,0),this._avgBitrate=e.attrs.decimalInteger(`AVERAGE-BANDWIDTH`),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(e=>!!e).map(e=>e.substring(0,4)).join(`,`),`supplemental`in e){this.supplemental=e.supplemental;let t=e.supplemental?.videoCodec;t&&t!==e.videoCodec&&(this.codecSet+=`,${t.substring(0,4)}`)}this.addGroupId(`audio`,e.attrs.AUDIO),this.addGroupId(`text`,e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||``}get pathwayId(){return this.attrs[`PATHWAY-ID`]||`.`}get videoRange(){return this.attrs[`VIDEO-RANGE`]||`SDR`}get score(){return this.attrs.optionalFloat(`SCORE`,0)}get uri(){return this.url[0]||``}hasAudioGroup(e){return bt(this._audioGroups,e)}hasSubtitleGroup(e){return bt(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t){if(e===`audio`){let e=this._audioGroups;e||=this._audioGroups=[],e.indexOf(t)===-1&&e.push(t)}else if(e===`text`){let e=this._subtitleGroups;e||=this._subtitleGroups=[],e.indexOf(t)===-1&&e.push(t)}}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){return this.audioGroups?.[0]}get textGroupId(){return this.subtitleGroups?.[0]}addFallback(){}};function bt(e,t){return!t||!e?!1:e.indexOf(t)!==-1}function xt(){if(typeof matchMedia==`function`){let e=matchMedia(`(dynamic-range: high)`),t=matchMedia(`bad query`);if(e.media!==t.media)return e.matches===!0}return!1}function St(e,t){let n=!1,r=[];if(e&&(n=e!==`SDR`,r=[e]),t){r=t.allowedVideoRanges||mt.slice(0);let e=r.join(``)!==`SDR`&&!t.videoCodec;n=t.preferHDR===void 0?e&&xt():t.preferHDR,n||(r=[`SDR`])}return{preferHDR:n,allowedVideoRanges:r}}var Ct=e=>{let t=new WeakSet;return(n,r)=>{if(e&&(r=e(n,r)),typeof r==`object`&&r){if(t.has(r))return;t.add(r)}return r}},q=(e,t)=>JSON.stringify(e,Ct(t));function wt(e,t,n,r,a){let o=Object.keys(e),s=r?.channels,c=r?.audioCodec,l=a?.videoCodec,u=s&&parseInt(s)===2,d=!1,f=!1,p=1/0,m=1/0,h=1/0,g=1/0,_=0,v=[],{preferHDR:y,allowedVideoRanges:b}=St(t,a);for(let t=o.length;t--;){let n=e[o[t]];d||=n.channels[2]>0,p=Math.min(p,n.minHeight),m=Math.min(m,n.minFramerate),h=Math.min(h,n.minBitrate),b.filter(e=>n.videoRanges[e]>0).length>0&&(f=!0)}p=i(p)?p:0,m=i(m)?m:0;let x=Math.max(1080,p),S=Math.max(30,m);h=i(h)?h:n,n=Math.max(h,n),f||(t=void 0);let C=o.length>1;return{codecSet:o.reduce((t,r)=>{let i=e[r];if(r===t)return t;if(v=f?b.filter(e=>i.videoRanges[e]>0):[],C){if(i.minBitrate>n)return Tt(r,`min bitrate of ${i.minBitrate} > current estimate of ${n}`),t;if(!i.hasDefaultAudio)return Tt(r,`no renditions with default or auto-select sound found`),t;if(c&&r.indexOf(c.substring(0,4))%5!=0)return Tt(r,`audio codec preference "${c}" not found`),t;if(s&&!u){if(!i.channels[s])return Tt(r,`no renditions with ${s} channel sound found (channels options: ${Object.keys(i.channels)})`),t}else if((!c||u)&&d&&i.channels[2]===0)return Tt(r,`no renditions with stereo sound found`),t;if(i.minHeight>x)return Tt(r,`min resolution of ${i.minHeight} > maximum of ${x}`),t;if(i.minFramerate>S)return Tt(r,`min framerate of ${i.minFramerate} > maximum of ${S}`),t;if(!v.some(e=>i.videoRanges[e]>0))return Tt(r,`no variants with VIDEO-RANGE of ${q(v)} found`),t;if(l&&r.indexOf(l.substring(0,4))%5!=0)return Tt(r,`video codec preference "${l}" not found`),t;if(i.maxScore<_)return Tt(r,`max score of ${i.maxScore} < selected max of ${_}`),t}return t&&(Ue(r)>=Ue(t)||i.fragmentError>e[t].fragmentError)?t:(g=i.minIndex,_=i.maxScore,r)},void 0),videoRanges:v,preferHDR:y,minFramerate:m,minBitrate:h,minIndex:g}}function Tt(e,t){O.log(`[abr] start candidates with "${e}" ignored because ${t}`)}function Et(e){return e.reduce((e,t)=>{let n=e.groups[t.groupId];n||=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1},n.tracks.push(t);let r=t.channels||`2`;return n.channels[r]=(n.channels[r]||0)+1,n.hasDefault=n.hasDefault||t.default,n.hasAutoSelect=n.hasAutoSelect||t.autoselect,n.hasDefault&&(e.hasDefaultAudio=!0),n.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function Dt(e,t,n,r){return e.slice(n,r+1).reduce((e,n,r)=>{if(!n.codecSet)return e;let i=n.audioGroups,a=e[n.codecSet];a||(e[n.codecSet]=a={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:r,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!i,fragmentError:0}),a.minBitrate=Math.min(a.minBitrate,n.bitrate);let o=Math.min(n.height,n.width);return a.minHeight=Math.min(a.minHeight,o),a.minFramerate=Math.min(a.minFramerate,n.frameRate),a.minIndex=Math.min(a.minIndex,r),a.maxScore=Math.max(a.maxScore,n.score),a.fragmentError+=n.fragmentError,a.videoRanges[n.videoRange]=(a.videoRanges[n.videoRange]||0)+1,i&&i.forEach(e=>{if(!e)return;let n=t.groups[e];n&&(a.hasDefaultAudio=a.hasDefaultAudio||t.hasDefaultAudio?n.hasDefault:n.hasAutoSelect||!t.hasDefaultAudio&&!t.hasAutoSelectAudio,Object.keys(n.channels).forEach(e=>{a.channels[e]=(a.channels[e]||0)+n.channels[e]}))}),e},{})}function Ot(e){if(!e)return e;let{lang:t,assocLang:n,characteristics:r,channels:i,audioCodec:a}=e;return{lang:t,assocLang:n,characteristics:r,channels:i,audioCodec:a}}function kt(e,t,n){if(`attrs`in e){let n=t.indexOf(e);if(n!==-1)return n}for(let r=0;r<t.length;r++){let i=t[r];if(At(e,i,n))return r}return-1}function At(e,t,n){let{groupId:r,name:i,lang:a,assocLang:o,default:s}=e,c=e.forced;return(r===void 0||t.groupId===r)&&(i===void 0||t.name===i)&&(a===void 0||jt(a,t.lang))&&(a===void 0||t.assocLang===o)&&(s===void 0||t.default===s)&&(c===void 0||t.forced===c)&&(!(`characteristics`in e)||Mt(e.characteristics||``,t.characteristics))&&(n===void 0||n(e,t))}function jt(e,t=`--`){return e.length===t.length?e===t:e.startsWith(t)||t.startsWith(e)}function Mt(e,t=``){let n=e.split(`,`),r=t.split(`,`);return n.length===r.length&&!n.some(e=>r.indexOf(e)===-1)}function Nt(e,t){let{audioCodec:n,channels:r}=e;return(n===void 0||(t.audioCodec||``).substring(0,4)===n.substring(0,4))&&(r===void 0||r===(t.channels||`2`))}function Pt(e,t,n,r,i){let a=t[r],o=t.reduce((e,t,n)=>{let r=t.uri;return(e[r]||(e[r]=[])).push(n),e},{})[a.uri];o.length>1&&(r=Math.max.apply(Math,o));let s=a.videoRange,c=a.frameRate,l=a.codecSet.substring(0,4),u=Ft(t,r,t=>{if(t.videoRange!==s||t.frameRate!==c||t.codecSet.substring(0,4)!==l)return!1;let r=t.audioGroups;return kt(e,n.filter(e=>!r||r.indexOf(e.groupId)!==-1),i)>-1});return u>-1?u:Ft(t,r,t=>{let r=t.audioGroups;return kt(e,n.filter(e=>!r||r.indexOf(e.groupId)!==-1),i)>-1})}function Ft(e,t,n){for(let r=t;r>-1;r--)if(n(e[r]))return r;for(let r=t+1;r<e.length;r++)if(n(e[r]))return r;return-1}function It(e,t){return!!e&&e!==t.loadLevelObj?.uri}var Lt=class extends b{constructor(e){super(`abr`,e.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey=``,this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.supportedCache={},this.bwEstimator=void 0,this._abandonRulesCheck=e=>{let{fragCurrent:t,partCurrent:n,hls:r}=this,{autoLevelEnabled:a,media:o}=r;if(!t||!o)return;let s=performance.now(),c=n?n.stats:t.stats,u=n?n.duration:t.duration,d=s-c.loading.start,f=r.minAutoLevel,p=t.level,m=this._nextAutoLevel;if(c.aborted||c.loaded&&c.loaded===c.total||p<=f){this.clearTimer(),this._nextAutoLevel=-1;return}if(!a)return;let h=m>-1&&m!==p,g=!!e||h;if(!g&&(o.paused||!o.playbackRate||!o.readyState))return;let _=r.mainForwardBufferInfo;if(!g&&_===null)return;let v=this.bwEstimator.getEstimateTTFB(),y=Math.abs(o.playbackRate);if(d<=Math.max(v,1e3*(u/(y*2))))return;let b=_?_.len/y:0,x=c.loading.first?c.loading.first-c.loading.start:-1,S=c.loaded&&x>-1,C=this.getBwEstimate(),w=r.levels,T=w[p],E=Math.max(c.loaded,Math.round(u*(t.bitrate||T.averageBitrate)/8)),D=S?d-x:d;D<1&&S&&(D=Math.min(d,c.loaded*8/C));let O=S?c.loaded*1e3/D:0,k=v/1e3,A=O?(E-c.loaded)/O:E*8/C+k;if(A<=b)return;let j=O?O*8:C,M=(e?.details||this.hls.latestLevelDetails)?.live===!0,N=this.hls.config.abrBandWidthUpFactor,P=1/0,F;for(F=p-1;F>f;F--){let e=w[F].maxBitrate,t=!w[F].details||M;if(P=this.getTimeToLoadFrag(k,j,u*e,t),P<Math.min(b,u+k))break}if(P>=A||P>u*10)return;S?this.bwEstimator.sample(d-Math.min(v,x),c.loaded):this.bwEstimator.sampleTTFB(d);let I=w[F].maxBitrate;this.getBwEstimate()*N>I&&this.resetEstimator(I);let L=this.findBestLevel(I,f,F,0,b,1,1);L>-1&&(F=L),this.warn(`Fragment ${t.sn}${n?` part `+n.index:``} of level ${p} is loading too slowly;
      Fragment duration: ${t.duration.toFixed(3)}
      Time to underbuffer: ${b.toFixed(3)} s
      Estimated load time for current fragment: ${A.toFixed(3)} s
      Estimated load time for down switch fragment: ${P.toFixed(3)} s
      TTFB estimate: ${x|0} ms
      Current BW estimate: ${i(C)?C|0:`Unknown`} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${F} @ ${I|0} bps`),r.nextLoadLevel=r.nextAutoLevel=F,this.clearTimer();let R=()=>{if(this.clearTimer(),this.fragCurrent===t&&this.hls.loadLevel===F&&F>0){let e=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${F>0?`and switching down`:``}
      Fragment duration: ${t.duration.toFixed(3)} s
      Time to underbuffer: ${e.toFixed(3)} s`),t.abortRequests(),this.fragCurrent=this.partCurrent=null,F>f){let t=this.findBestLevel(this.hls.levels[f].bitrate,f,F,0,e,1,1);t===-1&&(t=f),this.hls.nextLoadLevel=this.hls.nextAutoLevel=t,this.resetEstimator(this.hls.levels[t].bitrate)}}};h||A>P*2?R():this.timer=self.setInterval(R,P*1e3),r.trigger(l.FRAG_LOAD_EMERGENCY_ABORTED,{frag:t,part:n,stats:c})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(this.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){let e=this.hls.config;return new p(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){let{hls:e}=this;e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.FRAG_LOADING,this.onFragLoading,this),e.on(l.FRAG_LOADED,this.onFragLoaded,this),e.on(l.FRAG_BUFFERED,this.onFragBuffered,this),e.on(l.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(l.LEVEL_LOADED,this.onLevelLoaded,this),e.on(l.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(l.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(l.ERROR,this.onError,this)}unregisterListeners(){let{hls:e}=this;e&&(e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.FRAG_LOADING,this.onFragLoading,this),e.off(l.FRAG_LOADED,this.onFragLoaded,this),e.off(l.FRAG_BUFFERED,this.onFragBuffered,this),e.off(l.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(l.LEVEL_LOADED,this.onLevelLoaded,this),e.off(l.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(l.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(l.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=this.supportedCache=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.supportedCache={},this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=``}onFragLoading(e,t){let n=t.frag;this.ignoreFragment(n)||(n.bitrateTest||(this.fragCurrent=n,this.partCurrent=t.part??null),this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100))}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case c.BUFFER_ADD_CODEC_ERROR:case c.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case c.FRAG_LOAD_TIMEOUT:{let e=t.frag,{fragCurrent:n,partCurrent:r}=this;if(e&&n&&e.sn===n.sn&&e.level===n.level){let t=performance.now(),n=r?r.stats:e.stats,i=t-n.loading.start,a=n.loading.first?n.loading.first-n.loading.start:-1;if(n.loaded&&a>-1){let e=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(i-Math.min(e,a),n.loaded)}else this.bwEstimator.sampleTTFB(i)}break}}}getTimeToLoadFrag(e,t,n,r){return e+n/t+(r?e+this.lastLevelLoadSec:0)}onLevelLoaded(e,t){let n=this.hls.config,{loading:r}=t.stats,a=r.end-r.first;i(a)&&(this.lastLevelLoadSec=a/1e3),t.details.live?this.bwEstimator.update(n.abrEwmaSlowLive,n.abrEwmaFastLive):this.bwEstimator.update(n.abrEwmaSlowVoD,n.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(t.levelInfo)}onFragLoaded(e,{frag:t,part:n}){let r=n?n.stats:t.stats;if(t.type===d.MAIN&&this.bwEstimator.sampleTTFB(r.loading.first-r.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){let e=n?n.duration:t.duration,i=this.hls.levels[t.level],a=(i.loaded?i.loaded.bytes:0)+r.loaded,o=(i.loaded?i.loaded.duration:0)+e;i.loaded={bytes:a,duration:o},i.realBitrate=Math.round(8*a/o)}if(t.bitrateTest){let e={stats:r,frag:t,part:n,id:t.type};this.onFragBuffered(l.FRAG_BUFFERED,e),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){let{frag:n,part:r}=t,i=r!=null&&r.stats.loaded?r.stats:n.stats;if(i.aborted||this.ignoreFragment(n))return;let a=i.parsing.end-i.loading.start-Math.min(i.loading.first-i.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(a,i.loaded),i.bwEstimate=this.getBwEstimate(),n.bitrateTest?this.bitrateTestDelay=a/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==d.MAIN||e.sn===`initSegment`}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){let{maxAutoLevel:e,minAutoLevel:t}=this.hls,n=this.getBwEstimate(),r=this.hls.config.maxStarvationDelay,i=this.findBestLevel(n,t,e,0,r,1,1);if(i>-1)return i;let a=this.hls.firstLevel,o=Math.min(Math.max(a,t),e);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${a} clamped to ${o}`),o}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){let e=this.forcedAutoLevel,t=this.bwEstimator.canEstimate(),n=this.lastLoadedFragLevel>-1;if(e!==-1&&(!t||!n||this.nextAutoLevelKey===this.getAutoLevelKey()))return e;let r=t&&n?this.getNextABRAutoLevel():this.firstAutoLevel;if(e!==-1){let t=this.hls.levels;if(t.length>Math.max(e,r)&&t[e].loadError<=t[r].loadError)return e}return this._nextAutoLevel=r,this.nextAutoLevelKey=this.getAutoLevelKey(),r}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){let{fragCurrent:e,partCurrent:t,hls:n}=this;if(n.levels.length<=1)return n.loadLevel;let{maxAutoLevel:r,config:i,minAutoLevel:a}=n,o=t?t.duration:e?e.duration:0,s=this.getBwEstimate(),c=this.getStarvationDelay(),l=i.abrBandWidthFactor,u=i.abrBandWidthUpFactor;if(c){let e=this.findBestLevel(s,a,r,c,0,l,u);if(e>=0)return this.rebufferNotice=-1,e}let d=o?Math.min(o,i.maxStarvationDelay):i.maxStarvationDelay;if(!c){let e=this.bitrateTestDelay;e&&(d=(o?Math.min(o,i.maxLoadingDelay):i.maxLoadingDelay)-e,this.info(`bitrate test took ${Math.round(1e3*e)}ms, set first fragment max fetchDuration to ${Math.round(1e3*d)} ms`),l=u=1)}let f=this.findBestLevel(s,a,r,c,d,l,u);if(this.rebufferNotice!==f&&(this.rebufferNotice=f,this.info(`${c?`rebuffering expected`:`buffer is empty`}, optimal quality level ${f}`)),f>-1)return f;let p=n.levels[a],m=n.loadLevelObj;return m&&p?.bitrate<m.bitrate?a:n.loadLevel}getStarvationDelay(){let e=this.hls,t=e.media;if(!t)return 1/0;let n=t&&t.playbackRate!==0?Math.abs(t.playbackRate):1,r=e.mainForwardBufferInfo;return(r?r.len:0)/n}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,n,r,a,o,s){var c;let l=r+a,u=this.lastLoadedFragLevel,d=u===-1?this.hls.firstLevel:u,{fragCurrent:f,partCurrent:p}=this,{levels:m,allAudioTracks:h,loadLevel:g,config:_}=this.hls;if(m.length===1)return 0;let v=m[d],y=!!((c=this.hls.latestLevelDetails)!=null&&c.live),b=g===-1||u===-1,x,S=`SDR`,C=v?.frameRate||0,{audioPreference:w,videoPreference:T}=_,E=this.audioTracksByGroup||=Et(h),D=-1;if(b){if(this.firstSelection!==-1)return this.firstSelection;let r=wt(this.codecTiers||=Dt(m,E,t,n),S,e,w,T),{codecSet:i,videoRanges:a,minFramerate:o,minBitrate:s,minIndex:c,preferHDR:l}=r;D=c,x=i,S=l?a[a.length-1]:a[0],C=o,e=Math.max(e,s),this.log(`picked start tier ${q(r)}`)}else x=v?.codecSet,S=v?.videoRange;let O=p?p.duration:f?f.duration:0,k=this.bwEstimator.getEstimateTTFB()/1e3,A=[];for(let c=n;c>=t;c--){var j;let t=m[c],f=c>d;if(!t)continue;if(_.useMediaCapabilities&&!t.supportedResult&&!t.supportedPromise){let n=navigator.mediaCapabilities;typeof n?.decodingInfo==`function`&&at(t,E,S,C,e,w)?(t.supportedPromise=ot(t,E,n,this.supportedCache),t.supportedPromise.then(e=>{if(!this.hls)return;t.supportedResult=e;let n=this.hls.levels,r=n.indexOf(t);e.error?this.warn(`MediaCapabilities decodingInfo error: "${e.error}" for level ${r} ${q(e)}`):e.supported?e.decodingInfoResults.some(e=>e.smooth===!1||e.powerEfficient===!1)&&this.log(`MediaCapabilities decodingInfo for level ${r} not smooth or powerEfficient: ${q(e)}`):(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${r} ${q(e)}`),r>-1&&n.length>1&&(this.log(`Removing unsupported level ${r}`),this.hls.removeLevel(r),this.hls.loadLevel===-1&&(this.hls.nextLoadLevel=0)))}).catch(e=>{this.warn(`Error handling MediaCapabilities decodingInfo: ${e}`)})):t.supportedResult=rt}if((x&&t.codecSet!==x||S&&t.videoRange!==S||f&&C>t.frameRate||!f&&C>0&&C<t.frameRate||(j=t.supportedResult)!=null&&(j=j.decodingInfoResults)!=null&&j.some(e=>e.smooth===!1))&&(!b||c!==D)){A.push(c);continue}let h=t.details,v=(p?h?.partTarget:h?.averagetargetduration)||O,T;T=f?s*e:o*e;let M=O&&r>=O*2&&a===0?t.averageBitrate:t.maxBitrate,N=this.getTimeToLoadFrag(k,T,M*v,h===void 0);if(T>=M&&(c===u||t.loadError===0&&t.fragmentError===0)&&(N<=k||!i(N)||y&&!this.bitrateTestDelay||N<l)){let e=this.forcedAutoLevel;return c!==g&&(e===-1||e!==g)&&(A.length&&this.trace(`Skipped level(s) ${A.join(`,`)} of ${n} max with CODECS and VIDEO-RANGE:"${m[A[0]].codecs}" ${m[A[0]].videoRange}; not compatible with "${x}" ${S}`),this.info(`switch candidate:${d}->${c} adjustedbw(${Math.round(T)})-bitrate=${Math.round(T-M)} ttfb:${k.toFixed(1)} avgDuration:${v.toFixed(1)} maxFetchDuration:${l.toFixed(1)} fetchDuration:${N.toFixed(1)} firstSelection:${b} codecSet:${t.codecSet} videoRange:${t.videoRange} hls.loadLevel:${g}`)),b&&(this.firstSelection=c),c}}return-1}set nextAutoLevel(e){let t=this.deriveNextAutoLevel(e);this._nextAutoLevel!==t&&(this.nextAutoLevelKey=``,this._nextAutoLevel=t)}deriveNextAutoLevel(e){let{maxAutoLevel:t,minAutoLevel:n}=this.hls;return Math.min(Math.max(e,n),t)}},Rt={search:function(e,t){let n=0,r=e.length-1,i=null,a=null;for(;n<=r;){i=(n+r)/2|0,a=e[i];let o=t(a);if(o>0)n=i+1;else if(o<0)r=i-1;else return a}return null}};function zt(e,t,n){if(t===null||!Array.isArray(e)||!e.length||!i(t)||t<(e[0].programDateTime||0)||t>=(e[e.length-1].endProgramDateTime||0))return null;for(let r=0;r<e.length;++r){let i=e[r];if(Ut(t,n,i))return i}return null}function Bt(e,t,n=0,r=0,i=.005){let a=null;if(e){a=t[1+e.sn-t[0].sn]||null;let r=e.endDTS-n;r>0&&r<15e-7&&(n+=15e-7),a&&e.level!==a.level&&a.end<=e.end&&(a=t[2+e.sn-t[0].sn]||null)}else n===0&&t[0].start===0&&(a=t[0]);if(a&&((!e||e.level===a.level)&&Ht(n,r,a)===0||Vt(a,e,Math.min(i,r))))return a;let o=Rt.search(t,Ht.bind(null,n,r));return o&&(o!==e||!a)?o:a}function Vt(e,t,n){if(t&&t.start===0&&t.level<e.level&&(t.endPTS||0)>0){let r=t.tagList.reduce((e,t)=>(t[0]===`INF`&&(e+=parseFloat(t[1])),e),n);return e.start<=r}return!1}function Ht(e=0,t=0,n){if(n.start<=e&&n.start+n.duration>e)return 0;let r=Math.min(t,n.duration+(n.deltaPTS?n.deltaPTS:0));return n.start+n.duration-r<=e?1:n.start-r>e&&n.start?-1:0}function Ut(e,t,n){let r=Math.min(t,n.duration+(n.deltaPTS?n.deltaPTS:0))*1e3;return(n.endProgramDateTime||0)-r>e}function Wt(e,t,n){if(e&&e.startCC<=t&&e.endCC>=t){let r=e.fragments,{fragmentHint:i}=e;i&&(r=r.concat(i));let a;return Rt.search(r,e=>e.cc<t?1:e.cc>t?-1:(a=e,e.end<=n?1:e.start>n?-1:0)),a||null}return null}function Gt(e){switch(e.details){case c.FRAG_LOAD_TIMEOUT:case c.KEY_LOAD_TIMEOUT:case c.LEVEL_LOAD_TIMEOUT:case c.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function Kt(e){return e.details.startsWith(`key`)}function qt(e){return Kt(e)&&!!e.frag&&!e.frag.decryptdata}function Jt(e,t){let n=Gt(t);return e.default[`${n?`timeout`:`error`}Retry`]}function Yt(e,t){let n=e.backoff===`linear`?1:2**t;return Math.min(n*e.retryDelayMs,e.maxRetryDelayMs)}function Xt(e){return _(_({},e),{errorRetry:null,timeoutRetry:null})}function Zt(e,t,n,r){if(!e)return!1;let i=r?.code,a=t<e.maxNumRetry&&(Qt(i)||!!n);return e.shouldRetry?e.shouldRetry(e,t,n,r,a):a}function Qt(e){return $t(e)||!!e&&(e<400||e>499)}function $t(e){return e===0&&navigator.onLine===!1}var en={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},tn={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,MoveAllAlternatesMatchingKey:4,SwitchToSDR:8},nn=class extends b{constructor(e){super(`error-controller`,e.logger),this.hls=void 0,this.playlistError=0,this.hls=e,this.registerListeners()}registerListeners(){let e=this.hls;e.on(l.ERROR,this.onError,this),e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){let e=this.hls;e&&(e.off(l.ERROR,this.onError,this),e.off(l.ERROR,this.onErrorOut,this),e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return e?.type===d.MAIN?e.level:this.getVariantIndex()}getVariantIndex(){var e;let t=this.hls,n=t.currentLevel;return(e=t.loadLevelObj)!=null&&e.details||n===-1?t.loadLevel:n}variantHasKey(e,t){if(e){var n;if((n=e.details)!=null&&n.hasKey(t))return!0;let r=e.audioGroups;if(r)return this.hls.allAudioTracks.filter(e=>r.indexOf(e.groupId)>=0).some(e=>e.details?.hasKey(t))}return!1}onManifestLoading(){this.playlistError=0}onLevelUpdated(){this.playlistError=0}onError(e,t){var n;if(t.fatal)return;let r=this.hls,i=t.context;switch(t.details){case c.FRAG_LOAD_ERROR:case c.FRAG_LOAD_TIMEOUT:case c.KEY_LOAD_ERROR:case c.KEY_LOAD_TIMEOUT:t.errorAction=this.getFragRetryOrSwitchAction(t);return;case c.FRAG_PARSING_ERROR:if((n=t.frag)!=null&&n.gap){t.errorAction=rn();return}case c.FRAG_GAP:case c.FRAG_DECRYPT_ERROR:t.errorAction=this.getFragRetryOrSwitchAction(t),t.errorAction.action=en.SendAlternateToPenaltyBox;return;case c.LEVEL_EMPTY_ERROR:case c.LEVEL_PARSING_ERROR:{var a;let e=t.parent===d.MAIN?t.level:r.loadLevel;t.details===c.LEVEL_EMPTY_ERROR&&(a=t.context)!=null&&(a=a.levelDetails)!=null&&a.live?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,e):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,e))}return;case c.LEVEL_LOAD_ERROR:case c.LEVEL_LOAD_TIMEOUT:typeof i?.level==`number`&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,i.level));return;case c.AUDIO_TRACK_LOAD_ERROR:case c.AUDIO_TRACK_LOAD_TIMEOUT:case c.SUBTITLE_LOAD_ERROR:case c.SUBTITLE_TRACK_LOAD_TIMEOUT:if(i){let e=r.loadLevelObj;if(e&&(i.type===u.AUDIO_TRACK&&e.hasAudioGroup(i.groupId)||i.type===u.SUBTITLE_TRACK&&e.hasSubtitleGroup(i.groupId))){t.errorAction=this.getPlaylistRetryOrSwitchAction(t,r.loadLevel),t.errorAction.action=en.SendAlternateToPenaltyBox,t.errorAction.flags=tn.MoveAllAlternatesMatchingHost;return}}return;case c.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:t.errorAction={action:en.SendAlternateToPenaltyBox,flags:tn.MoveAllAlternatesMatchingHDCP};return;case c.KEY_SYSTEM_SESSION_UPDATE_FAILED:case c.KEY_SYSTEM_STATUS_INTERNAL_ERROR:case c.KEY_SYSTEM_NO_SESSION:t.errorAction={action:en.SendAlternateToPenaltyBox,flags:tn.MoveAllAlternatesMatchingKey};return;case c.BUFFER_ADD_CODEC_ERROR:case c.REMUX_ALLOC_ERROR:case c.BUFFER_APPEND_ERROR:t.errorAction||=this.getLevelSwitchAction(t,t.level??r.loadLevel);return;case c.INTERNAL_EXCEPTION:case c.BUFFER_APPENDING_ERROR:case c.BUFFER_FULL_ERROR:case c.LEVEL_SWITCH_ERROR:case c.BUFFER_STALLED_ERROR:case c.BUFFER_SEEK_OVER_HOLE:case c.BUFFER_NUDGE_ON_STALL:t.errorAction=rn();return}t.type===s.KEY_SYSTEM_ERROR&&(t.levelRetry=!1,t.errorAction=rn())}getPlaylistRetryOrSwitchAction(e,t){let n=this.hls,r=Jt(n.config.playlistLoadPolicy,e),i=this.playlistError++;if(Zt(r,i,Gt(e),e.response))return{action:en.RetryRequest,flags:tn.None,retryConfig:r,retryCount:i};let a=this.getLevelSwitchAction(e,t);return r&&(a.retryConfig=r,a.retryCount=i),a}getFragRetryOrSwitchAction(e){let t=this.hls,n=this.getVariantLevelIndex(e.frag),r=t.levels[n],{fragLoadPolicy:i,keyLoadPolicy:a}=t.config,o=Jt(Kt(e)?a:i,e),s=t.levels.reduce((e,t)=>e+t.fragmentError,0);if(r&&(e.details!==c.FRAG_GAP&&r.fragmentError++,!qt(e)&&Zt(o,s,Gt(e),e.response)))return{action:en.RetryRequest,flags:tn.None,retryConfig:o,retryCount:s};let l=this.getLevelSwitchAction(e,n);return o&&(l.retryConfig=o,l.retryCount=s),l}getLevelSwitchAction(e,t){let n=this.hls;t??=n.loadLevel;let r=this.hls.levels[t];if(r){let t=e.details;r.loadError++,t===c.BUFFER_APPEND_ERROR&&r.fragmentError++;let o=-1,{levels:s,loadLevel:l,minAutoLevel:f,maxAutoLevel:p}=n;!n.autoLevelEnabled&&!n.config.preserveManualLevelOnError&&(n.loadLevel=-1);let m=e.frag?.type,h=(m===d.AUDIO&&t===c.FRAG_PARSING_ERROR||e.sourceBufferName===`audio`&&(t===c.BUFFER_ADD_CODEC_ERROR||t===c.BUFFER_APPEND_ERROR))&&s.some(({audioCodec:e})=>r.audioCodec!==e),g=e.sourceBufferName===`video`&&(t===c.BUFFER_ADD_CODEC_ERROR||t===c.BUFFER_APPEND_ERROR)&&s.some(({codecSet:e,audioCodec:t})=>r.codecSet!==e&&r.audioCodec===t),{type:_,groupId:v}=e.context??{};for(let n=s.length;n--;){let y=(n+l)%s.length;if(y!==l&&y>=f&&y<=p&&s[y].loadError===0){var i,a;let n=s[y];if(t===c.FRAG_GAP&&m===d.MAIN&&e.frag){let t=s[y].details;if(t){let n=Bt(e.frag,t.fragments,e.frag.start);if(n!=null&&n.gap)continue}}else if(_===u.AUDIO_TRACK&&n.hasAudioGroup(v)||_===u.SUBTITLE_TRACK&&n.hasSubtitleGroup(v))continue;else if(m===d.AUDIO&&(i=r.audioGroups)!=null&&i.some(e=>n.hasAudioGroup(e))||m===d.SUBTITLE&&(a=r.subtitleGroups)!=null&&a.some(e=>n.hasSubtitleGroup(e))||h&&r.audioCodec===n.audioCodec||g&&r.codecSet===n.codecSet||!h&&r.codecSet!==n.codecSet)continue;o=y;break}}if(o>-1&&n.loadLevel!==o)return e.levelRetry=!0,this.playlistError=0,{action:en.SendAlternateToPenaltyBox,flags:tn.None,nextAutoLevel:o}}return{action:en.SendAlternateToPenaltyBox,flags:tn.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){switch(t.errorAction?.action){case en.DoNothing:break;case en.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),!t.errorAction.resolved&&t.details!==c.FRAG_GAP?t.fatal=!0:/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break;case en.RetryRequest:break}if(t.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(e){let t=this.hls,n=e.errorAction;if(!n)return;let{flags:r}=n,i=n.nextAutoLevel;switch(r){case tn.None:this.switchLevel(e,i);break;case tn.MoveAllAlternatesMatchingHDCP:{let r=this.getVariantLevelIndex(e.frag),i=t.levels[r]?.attrs[`HDCP-LEVEL`];if(n.hdcpLevel=i,i===`NONE`)this.warn(`HDCP policy resticted output with HDCP-LEVEL=NONE`);else if(i){t.maxHdcpLevel=ft[ft.indexOf(i)-1],n.resolved=!0,this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`);break}}case tn.MoveAllAlternatesMatchingKey:{let t=e.decryptdata;if(t){let r=this.hls.levels,i=r.length;for(let n=i;n--;)this.variantHasKey(r[n],t)&&(this.log(`Banned key found in level ${n} (${r[n].bitrate}bps) or audio group "${r[n].audioGroups?.join(`,`)}" (${e.frag?.type} fragment) ${N(t.keyId||[])}`),r[n].fragmentError++,r[n].loadError++,this.log(`Removing level ${n} with key error (${e.error})`),this.hls.removeLevel(n));let a=e.frag;if(this.hls.levels.length<i)n.resolved=!0;else if(a&&a.type!==d.MAIN){let e=a.decryptdata;e&&!t.matches(e)&&(n.resolved=!0)}}break}}n.resolved||this.switchLevel(e,i)}switchLevel(e,t){if(t!==void 0&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,e.details===c.BUFFER_ADD_CODEC_ERROR&&e.mimeType&&e.sourceBufferName!==`audiovideo`)){let t=et(e.mimeType),n=this.hls.levels;for(let r=n.length;r--;)n[r][`${e.sourceBufferName}Codec`]===t&&(this.log(`Removing level ${r} for ${e.details} ("${t}" not supported)`),this.hls.removeLevel(r))}}};function rn(e){let t={action:en.DoNothing,flags:tn.None};return e&&(t.resolved=!0),t}var an={NOT_LOADED:`NOT_LOADED`,APPENDING:`APPENDING`,PARTIAL:`PARTIAL`,OK:`OK`},on=class{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){let{hls:e}=this;e&&(e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.BUFFER_APPENDED,this.onBufferAppended,this),e.on(l.FRAG_BUFFERED,this.onFragBuffered,this),e.on(l.FRAG_LOADED,this.onFragLoaded,this))}_unregisterListeners(){let{hls:e}=this;e&&(e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.BUFFER_APPENDED,this.onBufferAppended,this),e.off(l.FRAG_BUFFERED,this.onFragBuffered,this),e.off(l.FRAG_LOADED,this.onFragLoaded,this))}destroy(){this._unregisterListeners(),this.hls=this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){let n=this.activePartLists[t];if(n)for(let t=n.length;t--;){let r=n[t];if(!r)break;if(r.start<=e&&e<=r.end&&r.loaded)return r}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){return this.getFragAtPos(e,t,!0)}getFragAtPos(e,t,n){let{fragments:r}=this,i=Object.keys(r);for(let a=i.length;a--;){let o=r[i[a]];if(o?.body.type===t&&(!n||o.buffered)){let t=o.body;if(t.start<=e&&e<=t.end)return t}}return null}detectEvictedFragments(e,t,n,r,i){this.timeRanges&&(this.timeRanges[e]=t);let a=r?.fragment.sn||-1;Object.keys(this.fragments).forEach(r=>{let o=this.fragments[r];if(!o||a>=o.body.sn)return;if(!o.buffered&&(!o.loaded||i)){o.body.type===n&&this.removeFragment(o.body);return}let s=o.range[e];if(s){if(s.time.length===0){this.removeFragment(o.body);return}s.time.some(e=>{let n=!this.isTimeBuffered(e.startPTS,e.endPTS,t);return n&&this.removeFragment(o.body),n})}})}detectPartialFragments(e){let t=this.timeRanges;if(!t||e.frag.sn===`initSegment`)return;let n=e.frag,r=cn(n),i=this.fragments[r];if(!i||i.buffered&&n.gap)return;let a=!n.relurl;Object.keys(t).forEach(r=>{let o=n.elementaryStreams[r];if(!o)return;let s=t[r],c=a||o.partial===!0;i.range[r]=this.getBufferedTimes(n,e.part,c,s)}),i.loaded=null,Object.keys(i.range).length?(this.bufferedEnd(i,n),sn(i)||this.removeParts(n.sn-1,n.type)):this.removeFragment(i.body)}bufferedEnd(e,t){e.buffered=!0,(e.body.endList=t.endList||e.body.endList)&&(this.endListFragments[e.body.type]=e)}removeParts(e,t){let n=this.activePartLists[t];n&&(this.activePartLists[t]=ln(n,t=>t.fragment.sn>=e))}fragBuffered(e,t){let n=cn(e),r=this.fragments[n];!r&&t&&(r=this.fragments[n]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),r&&(r.loaded=null,this.bufferedEnd(r,e))}getBufferedTimes(e,t,n,r){let i={time:[],partial:n},a=e.start,o=e.end,s=e.minEndPTS||o,c=e.maxStartPTS||a;for(let e=0;e<r.length;e++){let t=r.start(e)-this.bufferPadding,n=r.end(e)+this.bufferPadding;if(c>=t&&s<=n){i.time.push({startPTS:Math.max(a,r.start(e)),endPTS:Math.min(o,r.end(e))});break}else if(a<n&&o>t){let t=Math.max(a,r.start(e)),n=Math.min(o,r.end(e));n>t&&(i.partial=!0,i.time.push({startPTS:t,endPTS:n}))}else if(o<=t)break}return i}getPartialFragment(e){let t=null,n,r,i,a=0,{bufferPadding:o,fragments:s}=this;return Object.keys(s).forEach(c=>{let l=s[c];l&&sn(l)&&(r=l.body.start-o,i=l.body.end+o,e>=r&&e<=i&&(n=Math.min(e-r,i-e),a<=n&&(t=l.body,a=n)))}),t}isEndListAppended(e){let t=this.endListFragments[e];return t!==void 0&&(t.buffered||sn(t))}getState(e){let t=cn(e),n=this.fragments[t];return n?n.buffered?sn(n)?an.PARTIAL:an.OK:an.APPENDING:an.NOT_LOADED}isTimeBuffered(e,t,n){let r,i;for(let a=0;a<n.length;a++){if(r=n.start(a)-this.bufferPadding,i=n.end(a)+this.bufferPadding,e>=r&&t<=i)return!0;if(t<=r)return!1}return!1}onManifestLoading(){this.removeAllFragments()}onFragLoaded(e,t){if(t.frag.sn===`initSegment`||t.frag.bitrateTest)return;let n=t.frag,r=t.part?null:t,i=cn(n);this.fragments[i]={body:n,appendedPTS:null,loaded:r,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){let{frag:n,part:r,timeRanges:i,type:a}=t;if(n.sn===`initSegment`)return;let o=n.type;if(r){let e=this.activePartLists[o];e||(this.activePartLists[o]=e=[]),e.push(r)}this.timeRanges=i;let s=i[a];this.detectEvictedFragments(a,s,o,r)}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){let t=cn(e);return!!this.fragments[t]}hasFragments(e){let{fragments:t}=this,n=Object.keys(t);if(!e)return n.length>0;for(let r=n.length;r--;)if(t[n[r]]?.body.type===e)return!0;return!1}hasParts(e){var t;return!!((t=this.activePartLists[e])!=null&&t.length)}removeFragmentsInRange(e,t,n,r,i){r&&!this.hasGaps||Object.keys(this.fragments).forEach(a=>{let o=this.fragments[a];if(!o)return;let s=o.body;s.type!==n||r&&!s.gap||s.start<t&&s.end>e&&(o.buffered||i)&&this.removeFragment(s)})}removeFragment(e){let t=cn(e);e.clearElementaryStreamInfo();let n=this.activePartLists[e.type];if(n){let t=e.sn;this.activePartLists[e.type]=ln(n,e=>e.fragment.sn!==t)}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){var e;this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1;let t=(e=this.hls)==null||(e=e.latestLevelDetails)==null?void 0:e.partList;t&&t.forEach(e=>e.clearElementaryStreamInfo())}};function sn(e){var t,n,r;return e.buffered&&!!(e.body.gap||(t=e.range.video)!=null&&t.partial||(n=e.range.audio)!=null&&n.partial||(r=e.range.audiovideo)!=null&&r.partial)}function cn(e){return`${e.type}_${e.level}_${e.sn}`}function ln(e,t){return e.filter(e=>{let n=t(e);return n||e.clearElementaryStreamInfo(),n})}var un={cbc:0,ctr:1},dn=class{constructor(e,t,n){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=e,this.aesIV=t,this.aesMode=n}decrypt(e,t){switch(this.aesMode){case un.cbc:return this.subtle.decrypt({name:`AES-CBC`,iv:this.aesIV},t,e);case un.ctr:return this.subtle.decrypt({name:`AES-CTR`,counter:this.aesIV,length:64},t,e);default:throw Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}};function fn(e){let t=e.byteLength,n=t&&new DataView(e.buffer).getUint8(t-1);return n?e.slice(0,t-n):e}var pn=class{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array,this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){let t=new DataView(e),n=new Uint32Array(4);for(let e=0;e<4;e++)n[e]=t.getUint32(e*4);return n}initTable(){let e=this.sBox,t=this.invSBox,n=this.subMix,r=n[0],i=n[1],a=n[2],o=n[3],s=this.invSubMix,c=s[0],l=s[1],u=s[2],d=s[3],f=new Uint32Array(256),p=0,m=0,h=0;for(h=0;h<256;h++)h<128?f[h]=h<<1:f[h]=h<<1^283;for(h=0;h<256;h++){let n=m^m<<1^m<<2^m<<3^m<<4;n=n>>>8^n&255^99,e[p]=n,t[n]=p;let s=f[p],h=f[s],g=f[h],_=f[n]*257^n*16843008;r[p]=_<<24|_>>>8,i[p]=_<<16|_>>>16,a[p]=_<<8|_>>>24,o[p]=_,_=g*16843009^h*65537^s*257^p*16843008,c[n]=_<<24|_>>>8,l[n]=_<<16|_>>>16,u[n]=_<<8|_>>>24,d[n]=_,p?(p=s^f[f[f[g^s]]],m^=f[f[m]]):p=m=1}}expandKey(e){let t=this.uint8ArrayToUint32Array_(e),n=!0,r=0;for(;r<t.length&&n;)n=t[r]===this.key[r],r++;if(n)return;this.key=t;let i=this.keySize=t.length;if(i!==4&&i!==6&&i!==8)throw Error(`Invalid aes key size=`+i);let a=this.ksRows=(i+6+1)*4,o,s,c=this.keySchedule=new Uint32Array(a),l=this.invKeySchedule=new Uint32Array(a),u=this.sBox,d=this.rcon,f=this.invSubMix,p=f[0],m=f[1],h=f[2],g=f[3],_,v;for(o=0;o<a;o++){if(o<i){_=c[o]=t[o];continue}v=_,o%i===0?(v=v<<8|v>>>24,v=u[v>>>24]<<24|u[v>>>16&255]<<16|u[v>>>8&255]<<8|u[v&255],v^=d[o/i|0]<<24):i>6&&o%i===4&&(v=u[v>>>24]<<24|u[v>>>16&255]<<16|u[v>>>8&255]<<8|u[v&255]),c[o]=_=(c[o-i]^v)>>>0}for(s=0;s<a;s++)o=a-s,v=s&3?c[o]:c[o-4],s<4||o<=4?l[s]=v:l[s]=p[u[v>>>24]]^m[u[v>>>16&255]]^h[u[v>>>8&255]]^g[u[v&255]],l[s]=l[s]>>>0}networkToHostOrderSwap(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24}decrypt(e,t,n){let r=this.keySize+6,i=this.invKeySchedule,a=this.invSBox,o=this.invSubMix,s=o[0],c=o[1],l=o[2],u=o[3],d=this.uint8ArrayToUint32Array_(n),f=d[0],p=d[1],m=d[2],h=d[3],g=new Int32Array(e),_=new Int32Array(g.length),v,y,b,x,S,C,w,T,E,D,O,k,A,j,M=this.networkToHostOrderSwap;for(;t<g.length;){for(E=M(g[t]),D=M(g[t+1]),O=M(g[t+2]),k=M(g[t+3]),S=E^i[0],C=k^i[1],w=O^i[2],T=D^i[3],A=4,j=1;j<r;j++)v=s[S>>>24]^c[C>>16&255]^l[w>>8&255]^u[T&255]^i[A],y=s[C>>>24]^c[w>>16&255]^l[T>>8&255]^u[S&255]^i[A+1],b=s[w>>>24]^c[T>>16&255]^l[S>>8&255]^u[C&255]^i[A+2],x=s[T>>>24]^c[S>>16&255]^l[C>>8&255]^u[w&255]^i[A+3],S=v,C=y,w=b,T=x,A+=4;v=a[S>>>24]<<24^a[C>>16&255]<<16^a[w>>8&255]<<8^a[T&255]^i[A],y=a[C>>>24]<<24^a[w>>16&255]<<16^a[T>>8&255]<<8^a[S&255]^i[A+1],b=a[w>>>24]<<24^a[T>>16&255]<<16^a[S>>8&255]<<8^a[C&255]^i[A+2],x=a[T>>>24]<<24^a[S>>16&255]<<16^a[C>>8&255]<<8^a[w&255]^i[A+3],_[t]=M(v^f),_[t+1]=M(x^p),_[t+2]=M(b^m),_[t+3]=M(y^h),f=E,p=D,m=O,h=k,t+=4}return _.buffer}},mn=class{constructor(e,t,n){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=e,this.key=t,this.aesMode=n}expandKey(){let e=hn(this.aesMode);return this.subtle.importKey(`raw`,this.key,{name:e},!1,[`encrypt`,`decrypt`])}};function hn(e){switch(e){case un.cbc:return`AES-CBC`;case un.ctr:return`AES-CTR`;default:throw Error(`[FastAESKey] invalid aes mode ${e}`)}}var gn=16,_n=class{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{let e=self.crypto;e&&(this.subtle=e.subtle||e.webkitSubtle)}catch{}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){let{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;let n=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?fn(n):n}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&=null}decrypt(e,t,n,r){return this.useSoftware?new Promise((i,a)=>{let o=ArrayBuffer.isView(e)?e:new Uint8Array(e);this.softwareDecrypt(o,t,n,r);let s=this.flush();s?i(s.buffer):a(Error(`[softwareDecrypt] Failed to decrypt data`))}):this.webCryptoDecrypt(new Uint8Array(e),t,n,r)}softwareDecrypt(e,t,n,r){let{currentIV:i,currentResult:a,remainderData:o}=this;if(r!==un.cbc||t.byteLength!==16)return O.warn(`SoftwareDecrypt: can only handle AES-128-CBC`),null;this.logOnce(`JS AES decrypt`),o&&(e=Te(o,e),this.remainderData=null);let s=this.getValidChunk(e);if(!s.length)return null;i&&(n=i);let c=this.softwareDecrypter;c||=this.softwareDecrypter=new pn,c.expandKey(t);let l=a;return this.currentResult=c.decrypt(s.buffer,0,n),this.currentIV=s.slice(-16).buffer,l||null}webCryptoDecrypt(e,t,n,r){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,n,r));this.key=t,this.fastAesKey=new mn(this.subtle,t,r)}return this.fastAesKey.expandKey().then(t=>this.subtle?(this.logOnce(`WebCrypto AES decrypt`),new dn(this.subtle,new Uint8Array(n),r).decrypt(e.buffer,t)):Promise.reject(Error(`web crypto not initialized`))).catch(i=>(O.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${i.name}: ${i.message}`),this.onWebCryptoError(e,t,n,r)))}onWebCryptoError(e,t,n,r){let i=this.enableSoftwareAES;if(i){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,n,r);let i=this.flush();if(i)return i.buffer}throw Error(`WebCrypto`+(i?` and softwareDecrypt`:``)+`: failed to decrypt data`)}getValidChunk(e){let t=e,n=e.length-e.length%gn;return n!==e.length&&(t=e.slice(0,n),this.remainderData=e.slice(n)),t}logOnce(e){this.logEnabled&&=(O.log(`[decrypter]: ${e}`),!1)}},vn=2**17,yn=class{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&=(this.loader.destroy(),null)}abort(){this.loader&&this.loader.abort()}load(e,t){let n=e.url;if(!n)return Promise.reject(new Cn({type:s.NETWORK_ERROR,details:c.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:Error(`Fragment does not have a ${n?`part list`:`url`}`),networkDetails:null}));this.abort();let r=this.config,i=r.fLoader,a=r.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),e.gap)if(e.tagList.some(e=>e[0]===`GAP`)){l(xn(e));return}else e.gap=!1;let u=this.loader=i?new i(r):new a(r),d=bn(e);e.loader=u;let f=Xt(r.fragLoadPolicy.default),p={loadPolicy:f,timeout:f.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:e.sn===`initSegment`?1/0:vn};e.stats=u.stats;let m={onSuccess:(t,n,r,i)=>{this.resetLoader(e,u);let a=t.data;r.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(a.slice(0,16)),a=a.slice(16)),o({frag:e,part:null,payload:a,networkDetails:i})},onError:(t,r,i,a)=>{this.resetLoader(e,u),l(new Cn({type:s.NETWORK_ERROR,details:c.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:_({url:n,data:void 0},t),error:Error(`HTTP Error ${t.code} ${t.text}`),networkDetails:i,stats:a}))},onAbort:(t,n,r)=>{this.resetLoader(e,u),l(new Cn({type:s.NETWORK_ERROR,details:c.INTERNAL_ABORTED,fatal:!1,frag:e,error:Error(`Aborted`),networkDetails:r,stats:t}))},onTimeout:(t,n,r)=>{this.resetLoader(e,u),l(new Cn({type:s.NETWORK_ERROR,details:c.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:Error(`Timeout after ${p.timeout}ms`),networkDetails:r,stats:t}))}};t&&(m.onProgress=(n,r,i,a)=>t({frag:e,part:null,payload:i,networkDetails:a})),u.load(d,p,m)})}loadPart(e,t,n){this.abort();let r=this.config,i=r.fLoader,a=r.loader;return new Promise((o,l)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap){l(xn(e,t));return}let u=this.loader=i?new i(r):new a(r),d=bn(e,t);e.loader=u;let f=Xt(r.fragLoadPolicy.default),p={loadPolicy:f,timeout:f.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:vn};t.stats=u.stats,u.load(d,p,{onSuccess:(r,i,a,s)=>{this.resetLoader(e,u),this.updateStatsFromPart(e,t);let c={frag:e,part:t,payload:r.data,networkDetails:s};n(c),o(c)},onError:(n,r,i,a)=>{this.resetLoader(e,u),l(new Cn({type:s.NETWORK_ERROR,details:c.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:_({url:d.url,data:void 0},n),error:Error(`HTTP Error ${n.code} ${n.text}`),networkDetails:i,stats:a}))},onAbort:(n,r,i)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,u),l(new Cn({type:s.NETWORK_ERROR,details:c.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:Error(`Aborted`),networkDetails:i,stats:n}))},onTimeout:(n,r,i)=>{this.resetLoader(e,u),l(new Cn({type:s.NETWORK_ERROR,details:c.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:Error(`Timeout after ${p.timeout}ms`),networkDetails:i,stats:n}))}})})}updateStatsFromPart(e,t){let n=e.stats,r=t.stats,i=r.total;if(n.loaded+=r.loaded,i){let r=Math.round(e.duration/t.duration),a=Math.min(Math.round(n.loaded/i),r),o=(r-a)*Math.round(n.loaded/a);n.total=n.loaded+o}else n.total=Math.max(n.loaded,n.total);let a=n.loading,o=r.loading;a.start?a.first+=o.first-o.start:(a.start=o.start,a.first=o.first),a.end=o.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}};function bn(e,t=null){let n=t||e,r={frag:e,part:t,responseType:`arraybuffer`,url:n.url,headers:{},rangeStart:0,rangeEnd:0},a=n.byteRangeStartOffset,o=n.byteRangeEndOffset;if(i(a)&&i(o)){let t=a,n=o;if(e.sn===`initSegment`&&Sn(e.decryptdata?.method)){let e=o-a;e%16&&(n=o+(16-e%16)),a!==0&&(r.resetIV=!0,t=a-16)}r.rangeStart=t,r.rangeEnd=n}return r}function xn(e,t){let n=Error(`GAP ${e.gap?`tag`:`attribute`} found`),r={type:s.MEDIA_ERROR,details:c.FRAG_GAP,fatal:!1,frag:e,error:n,networkDetails:null};return t&&(r.part=t),(t||e).stats.aborted=!0,new Cn(r)}function Sn(e){return e===`AES-128`||e===`AES-256`}var Cn=class extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}},wn=class extends b{constructor(e,t){super(e,t),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}},Tn=class{constructor(e,t,n,r=0,i=-1,a=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=En(),this.buffering={audio:En(),video:En(),audiovideo:En()},this.level=e,this.sn=t,this.id=n,this.size=r,this.part=i,this.partial=a}};function En(){return{start:0,executeStart:0,executeEnd:0,end:0}}var Dn={length:0,start:()=>0,end:()=>0},J=class e{static isBuffered(t,n){if(t){let r=e.getBuffered(t);for(let e=r.length;e--;)if(n>=r.start(e)&&n<=r.end(e))return!0}return!1}static bufferedRanges(t){if(t){let n=e.getBuffered(t);return e.timeRangesToArray(n)}return[]}static timeRangesToArray(e){let t=[];for(let n=0;n<e.length;n++)t.push({start:e.start(n),end:e.end(n)});return t}static bufferInfo(t,n,r){if(t){let i=e.bufferedRanges(t);if(i.length)return e.bufferedInfo(i,n,r)}return{len:0,start:n,end:n,bufferedIndex:-1}}static bufferedInfo(e,t,n){t=Math.max(0,t),e.length>1&&e.sort((e,t)=>e.start-t.start||t.end-e.end);let r=-1,i=[];if(n)for(let a=0;a<e.length;a++){t>=e[a].start&&t<=e[a].end&&(r=a);let o=i.length;if(o){let t=i[o-1].end;e[a].start-t<n?e[a].end>t&&(i[o-1].end=e[a].end):i.push(e[a])}else i.push(e[a])}else i=e;let a=0,o,s=t,c=t;for(let e=0;e<i.length;e++){let l=i[e].start,u=i[e].end;if(r===-1&&t>=l&&t<=u&&(r=e),t+n>=l&&t<u)s=l,c=u,a=c-t;else if(t+n<l){o=l;break}}return{len:a,start:s||0,end:c||0,nextStart:o,buffered:e,bufferedIndex:r}}static getBuffered(e){try{return e.buffered||Dn}catch(e){return O.log(`failed to get media.buffered`,e),Dn}}},On=/\{\$([a-zA-Z0-9-_]+)\}/g;function kn(e){return On.test(e)}function An(e,t){if(e.variableList!==null||e.hasVariableRefs){let n=e.variableList;return t.replace(On,t=>{let r=t.substring(2,t.length-1),i=n?.[r];return i===void 0?(e.playlistParsingError||=Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${r}"`),t):i})}return t}function jn(e,t,n){let r=e.variableList;r||(e.variableList=r={});let i,a;if(`QUERYPARAM`in t){i=t.QUERYPARAM;try{let e=new self.URL(n).searchParams;if(e.has(i))a=e.get(i);else throw Error(`"${i}" does not match any query parameter in URI: "${n}"`)}catch(t){e.playlistParsingError||=Error(`EXT-X-DEFINE QUERYPARAM: ${t.message}`)}}else i=t.NAME,a=t.VALUE;i in r?e.playlistParsingError||=Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${i}"`):r[i]=a||``}function Mn(e,t,n){let r=t.IMPORT;if(n&&r in n){let t=e.variableList;t||(e.variableList=t={}),t[r]=n[r]}else e.playlistParsingError||=Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${r}"`)}var Nn=/^(\d+)x(\d+)$/,Pn=/(.+?)=(".*?"|.*?)(?:,|$)/g,Fn=class e{constructor(t,n){typeof t==`string`&&(t=e.parseAttrList(t,n)),h(this,t)}get clientAttrs(){return Object.keys(this).filter(e=>e.substring(0,2)===`X-`)}decimalInteger(e){let t=parseInt(this[e],10);return t>2**53-1?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||`0x`).slice(2);t=(t.length&1?`0`:``)+t;let n=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++)n[e]=parseInt(t.slice(e*2,e*2+2),16);return n}return null}hexadecimalIntegerAsNumber(e){let t=parseInt(this[e],16);return t>2**53-1?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){let n=this[e];return n?parseFloat(n):t}enumeratedString(e){return this[e]}enumeratedStringList(e,t){let n=this[e];return(n?n.split(/[ ,]+/):[]).reduce((e,t)=>(e[t.toLowerCase()]=!0,e),t)}bool(e){return this[e]===`YES`}decimalResolution(e){let t=Nn.exec(this[e]);if(t!==null)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e,t){let n,r={};for(Pn.lastIndex=0;(n=Pn.exec(e))!==null;){let i=n[1].trim(),a=n[2],o=a.indexOf(`"`)===0&&a.lastIndexOf(`"`)===a.length-1,s=!1;if(o)a=a.slice(1,-1);else switch(i){case`IV`:case`SCTE35-CMD`:case`SCTE35-IN`:case`SCTE35-OUT`:s=!0}if(t&&(o||s))a=An(t,a);else if(!s&&!o)switch(i){case`CLOSED-CAPTIONS`:if(a===`NONE`)break;case`ALLOWED-CPC`:case`CLASS`:case`ASSOC-LANGUAGE`:case`AUDIO`:case`BYTERANGE`:case`CHANNELS`:case`CHARACTERISTICS`:case`CODECS`:case`DATA-ID`:case`END-DATE`:case`GROUP-ID`:case`ID`:case`IMPORT`:case`INSTREAM-ID`:case`KEYFORMAT`:case`KEYFORMATVERSIONS`:case`LANGUAGE`:case`NAME`:case`PATHWAY-ID`:case`QUERYPARAM`:case`RECENTLY-REMOVED-DATERANGES`:case`SERVER-URI`:case`STABLE-RENDITION-ID`:case`STABLE-VARIANT-ID`:case`START-DATE`:case`SUBTITLES`:case`SUPPLEMENTAL-CODECS`:case`URI`:case`VALUE`:case`VIDEO`:case`X-ASSET-LIST`:case`X-ASSET-URI`:O.warn(`${e}: attribute ${i} is missing quotes`)}r[i]=a}return r}},In=`com.apple.hls.interstitial`;function Ln(e){return e!==`ID`&&e!==`CLASS`&&e!==`CUE`&&e!==`START-DATE`&&e!==`DURATION`&&e!==`END-DATE`&&e!==`END-ON-NEXT`}function Rn(e){return e===`SCTE35-OUT`||e===`SCTE35-IN`||e===`SCTE35-CMD`}var zn=class{constructor(e,t,n=0){if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=t?.tagAnchor||null,this.tagOrder=t?.tagOrder??n,t){let n=t.attr;for(let t in n)if(Object.prototype.hasOwnProperty.call(e,t)&&e[t]!==n[t]){O.warn(`DATERANGE tag attribute: "${t}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=t;break}e=h(new Fn({}),n,e)}if(this.attr=e,t?(this._startDate=t._startDate,this._cue=t._cue,this._endDate=t._endDate,this._dateAtEnd=t._dateAtEnd):this._startDate=new Date(e[`START-DATE`]),`END-DATE`in this.attr){let e=t?.endDate||new Date(this.attr[`END-DATE`]);i(e.getTime())&&(this._endDate=e)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){let e=this._cue;return e===void 0?this._cue=this.attr.enumeratedStringList(this.attr.CUE?`CUE`:`X-CUE`,{pre:!1,post:!1,once:!1}):e}get startTime(){let{tagAnchor:e}=this;return e===null||e.programDateTime===null?(O.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${e}`),NaN):e.start+(this.startDate.getTime()-e.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){let e=this._endDate||this._dateAtEnd;if(e)return e;let t=this.duration;return t===null?null:this._dateAtEnd=new Date(this._startDate.getTime()+t*1e3)}get duration(){if(`DURATION`in this.attr){let e=this.attr.decimalFloatingPoint(`DURATION`);if(i(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return`PLANNED-DURATION`in this.attr?this.attr.decimalFloatingPoint(`PLANNED-DURATION`):null}get endOnNext(){return this.attr.bool(`END-ON-NEXT`)}get isInterstitial(){return this.class===In}get isValid(){return!!this.id&&!this._badValueForSameId&&i(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||`X-ASSET-URI`in this.attr||`X-ASSET-LIST`in this.attr)}},Bn=10,Vn=class{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.dateRangeTagCount=0,this.live=!0,this.requestScheduled=-1,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8=``,this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.appliedTimelineOffset=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e){this.advanced=!0,this.updated=!0;return}let t=this.lastPartSn-e.lastPartSn,n=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!n||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||t===0&&n>0,this.updated||this.advanced?this.misses=Math.floor(e.misses*.6):this.misses=e.misses+1}hasKey(e){return this.encryptedFragments.some(t=>{let n=t.decryptdata;return n||=(t.setKeyFormat(e.keyFormat),t.decryptdata),!!n&&e.matches(n)})}get hasProgramDateTime(){return this.fragments.length?i(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||Bn}get drift(){let e=this.driftEndTime-this.driftStartTime;return e>0?(this.driftEnd-this.driftStart)*1e3/e:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){return this.fragments.length?this.fragments[this.fragments.length-1].end:0}get fragmentStart(){return this.fragments.length?this.fragments[0].start:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].index:-1}get maxPartIndex(){let e=this.partList;if(e){let t=this.lastPartIndex;if(t!==-1){for(let n=e.length;n--;)if(e[n].index>t)return e[n].index;return t}}return 0}get lastPartSn(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}get expired(){if(this.live&&this.age&&this.misses<3){let e=this.partEnd-this.fragmentStart;return this.age>Math.max(e,this.totalduration)+this.levelTargetDuration}return!1}};function Hn(e,t){return e.length===t.length?!e.some((e,n)=>e!==t[n]):!1}function Un(e,t){return!e&&!t?!0:!e||!t?!1:Hn(e,t)}function Wn(e){return e===`AES-128`||e===`AES-256`||e===`AES-256-CTR`}function Gn(e){switch(e){case`AES-128`:case`AES-256`:return un.cbc;case`AES-256-CTR`:return un.ctr;default:throw Error(`invalid full segment method ${e}`)}}function Kn(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0))}function qn(e){return Uint8Array.from(unescape(encodeURIComponent(e)),e=>e.charCodeAt(0))}function Jn(e){let t=qn(e).subarray(0,16),n=new Uint8Array(16);return n.set(t,16-t.length),n}function Yn(e){let t=function(e,t,n){let r=e[t];e[t]=e[n],e[n]=r};t(e,0,3),t(e,1,2),t(e,4,5),t(e,6,7)}function Xn(e){let t=e.split(`:`),n=null;if(t[0]===`data`&&t.length===2){let e=t[1].split(`;`),r=e[e.length-1].split(`,`);if(r.length===2){let t=r[0]===`base64`,i=r[1];t?(e.splice(-1,1),n=Kn(i)):n=Jn(i)}}return n}var Zn=typeof self<`u`?self:void 0,Y={CLEARKEY:`org.w3.clearkey`,FAIRPLAY:`com.apple.fps`,PLAYREADY:`com.microsoft.playready`,WIDEVINE:`com.widevine.alpha`},Qn={CLEARKEY:`org.w3.clearkey`,FAIRPLAY:`com.apple.streamingkeydelivery`,PLAYREADY:`com.microsoft.playready`,WIDEVINE:`urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed`};function $n(e){switch(e){case Qn.FAIRPLAY:return Y.FAIRPLAY;case Qn.PLAYREADY:return Y.PLAYREADY;case Qn.WIDEVINE:return Y.WIDEVINE;case Qn.CLEARKEY:return Y.CLEARKEY}}function er(e){switch(e){case Y.FAIRPLAY:return Qn.FAIRPLAY;case Y.PLAYREADY:return Qn.PLAYREADY;case Y.WIDEVINE:return Qn.WIDEVINE;case Y.CLEARKEY:return Qn.CLEARKEY}}function tr(e){let{drmSystems:t,widevineLicenseUrl:n}=e,r=t?[Y.FAIRPLAY,Y.WIDEVINE,Y.PLAYREADY,Y.CLEARKEY].filter(e=>!!t[e]):[];return!r[Y.WIDEVINE]&&n&&r.push(Y.WIDEVINE),r}var nr=function(e){return Zn!=null&&(e=Zn.navigator)!=null&&e.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function rr(e,t,n,r){let i;switch(e){case Y.FAIRPLAY:i=[`cenc`,`sinf`];break;case Y.WIDEVINE:case Y.PLAYREADY:i=[`cenc`];break;case Y.CLEARKEY:i=[`cenc`,`keyids`];break;default:throw Error(`Unknown key-system: ${e}`)}return ir(i,t,n,r)}function ir(e,t,n,r){return[{initDataTypes:e,persistentState:r.persistentState||`optional`,distinctiveIdentifier:r.distinctiveIdentifier||`optional`,sessionTypes:r.sessionTypes||[r.sessionType||`temporary`],audioCapabilities:t.map(e=>({contentType:`audio/mp4; codecs=${e}`,robustness:r.audioRobustness||``,encryptionScheme:r.audioEncryptionScheme||null})),videoCapabilities:n.map(e=>({contentType:`video/mp4; codecs=${e}`,robustness:r.videoRobustness||``,encryptionScheme:r.videoEncryptionScheme||null}))}]}function ar(e){var t;return!!e&&(e.sessionType===`persistent-license`||!!((t=e.sessionTypes)!=null&&t.some(e=>e===`persistent-license`)))}function or(e){let t=new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2),n=String.fromCharCode.apply(null,Array.from(t)),r=n.substring(n.indexOf(`<`),n.length),i=new DOMParser().parseFromString(r,`text/xml`).getElementsByTagName(`KID`)[0];if(i){let e=i.childNodes[0]?i.childNodes[0].nodeValue:i.getAttribute(`VALUE`);if(e){let t=Kn(e).subarray(0,16);return Yn(t),t}}return null}var sr={},cr=class e{static clearKeyUriToKeyIdMap(){sr={}}static setKeyIdForUri(e,t){sr[e]=t}static addKeyIdForUri(e){let t=Object.keys(sr).length%(2**53-1),n=new Uint8Array(16);return new DataView(n.buffer,12,4).setUint32(0,t),sr[e]=n,n}constructor(e,t,n,r=[1],i=null,a){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=n,this.keyFormatVersions=r,this.iv=i,this.encrypted=e?e!==`NONE`:!1,this.isCommonEncryption=this.encrypted&&!Wn(e),a!=null&&a.startsWith(`0x`)&&(this.keyId=new Uint8Array(P(a)))}matches(e){return e.uri===this.uri&&e.method===this.method&&e.encrypted===this.encrypted&&e.keyFormat===this.keyFormat&&Hn(e.keyFormatVersions,this.keyFormatVersions)&&Un(e.iv,this.iv)&&Un(e.keyId,this.keyId)}isSupported(){if(this.method){if(Wn(this.method)||this.method===`NONE`)return!0;if(this.keyFormat===`identity`)return this.method===`SAMPLE-AES`;switch(this.keyFormat){case Qn.FAIRPLAY:case Qn.WIDEVINE:case Qn.PLAYREADY:case Qn.CLEARKEY:return[`SAMPLE-AES`,`SAMPLE-AES-CENC`,`SAMPLE-AES-CTR`].indexOf(this.method)!==-1}}return!1}getDecryptData(t,n){if(!this.encrypted||!this.uri)return null;if(Wn(this.method)){let n=this.iv;return n||=(typeof t!=`number`&&(O.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),t=0),dr(t)),new e(this.method,this.uri,`identity`,this.keyFormatVersions,n)}if(this.keyId){let t=sr[this.uri];if(t&&!Hn(this.keyId,t)&&e.setKeyIdForUri(this.uri,this.keyId),this.pssh)return this}let r=Xn(this.uri);if(r)switch(this.keyFormat){case Qn.WIDEVINE:if(this.pssh=r,!this.keyId){let e=Pe(r.buffer);if(e.length){var i;let t=e[0];this.keyId=(i=t.kids)!=null&&i.length?t.kids[0]:null}}this.keyId||=ur(n);break;case Qn.PLAYREADY:this.pssh=Ne(new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]),null,r),this.keyId=or(r);break;default:{let e=r.subarray(0,16);if(e.length!==16){let t=new Uint8Array(16);t.set(e,16-e.length),e=t}this.keyId=e;break}}if(!this.keyId||this.keyId.byteLength!==16){let t;t=lr(n),t||(t=ur(n),t||=sr[this.uri]),t&&(this.keyId=t,e.setKeyIdForUri(this.uri,t))}return this}};function lr(e){let t=e?.[Qn.WIDEVINE];return t?t.keyId:null}function ur(e){let t=e?.[Qn.PLAYREADY];if(t){let e=Xn(t.uri);if(e)return or(e)}return null}function dr(e){let t=new Uint8Array(16);for(let n=12;n<16;n++)t[n]=e>>8*(15-n)&255;return t}var fr=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,pr=/#EXT-X-MEDIA:(.*)/g,mr=/^#EXT(?:INF|-X-TARGETDURATION):/m,hr=new RegExp([`#EXTINF:\\s*(\\d*(?:\\.\\d+)?)(?:,(.*)\\s+)?`,`(?!#) *(\\S[^\\r\\n]*)`,`#.*`].join(`|`),`g`),gr=new RegExp([`#EXT-X-(PROGRAM-DATE-TIME|BYTERANGE|DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)`,`#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\\d+)`,`#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)`,`(#)([^:]*):(.*)`,`(#)(.*)(?:.*)\\r?\\n?`].join(`|`)),_r=class e{static findGroup(e,t){for(let n=0;n<e.length;n++){let r=e[n];if(r.id===t)return r}}static resolve(e,t){return z.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return mr.test(e)}static parseMasterPlaylist(t,n){let r={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:kn(t)},i=[];if(fr.lastIndex=0,!t.startsWith(`#EXTM3U`))return r.playlistParsingError=Error(`no EXTM3U delimiter`),r;let a;for(;(a=fr.exec(t))!=null;)if(a[1]){var o;let t=new Fn(a[1],r),s=An(r,a[2]),c={attrs:t,bitrate:t.decimalInteger(`BANDWIDTH`)||t.decimalInteger(`AVERAGE-BANDWIDTH`),name:t.NAME,url:e.resolve(s,n)},l=t.decimalResolution(`RESOLUTION`);l&&(c.width=l.width,c.height=l.height),Sr(t.CODECS,c);let u=t[`SUPPLEMENTAL-CODECS`];u&&(c.supplemental={},Sr(u,c.supplemental)),(o=c.unknownCodecs)!=null&&o.length||i.push(c),r.levels.push(c)}else if(a[3]){let t=a[3],i=a[4];switch(t){case`SESSION-DATA`:{let e=new Fn(i,r),t=e[`DATA-ID`];t&&(r.sessionData===null&&(r.sessionData={}),r.sessionData[t]=e);break}case`SESSION-KEY`:{let e=br(i,n,r);e.encrypted&&e.isSupported()?(r.sessionKeys===null&&(r.sessionKeys=[]),r.sessionKeys.push(e)):O.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${i}"`);break}case`DEFINE`:jn(r,new Fn(i,r),n);break;case`CONTENT-STEERING`:{let t=new Fn(i,r);r.contentSteering={uri:e.resolve(t[`SERVER-URI`],n),pathwayId:t[`PATHWAY-ID`]||`.`};break}case`START`:r.startTimeOffset=xr(i);break}}return r.levels=i.length>0&&i.length<r.levels.length?i:r.levels,r.levels.length===0&&(r.playlistParsingError=Error(`no levels found in manifest`)),r}static parseMasterPlaylistMedia(t,n,r){let i,a={},o=r.levels,s={AUDIO:o.map(e=>({id:e.attrs.AUDIO,audioCodec:e.audioCodec})),SUBTITLES:o.map(e=>({id:e.attrs.SUBTITLES,textCodec:e.textCodec})),"CLOSED-CAPTIONS":[]},c=0;for(pr.lastIndex=0;(i=pr.exec(t))!==null;){let t=new Fn(i[1],r),o=t.TYPE;if(o){let r=s[o],i=a[o]||[];a[o]=i;let l=t.LANGUAGE,u=t[`ASSOC-LANGUAGE`],d=t.CHANNELS,f=t.CHARACTERISTICS,p=t[`INSTREAM-ID`],m={attrs:t,bitrate:0,id:c++,groupId:t[`GROUP-ID`]||``,name:t.NAME||l||``,type:o,default:t.bool(`DEFAULT`),autoselect:t.bool(`AUTOSELECT`),forced:t.bool(`FORCED`),lang:l,url:t.URI?e.resolve(t.URI,n):``};if(u&&(m.assocLang=u),d&&(m.channels=d),f&&(m.characteristics=f),p&&(m.instreamId=p),r!=null&&r.length){let t=e.findGroup(r,m.groupId)||r[0];Cr(m,t,`audioCodec`),Cr(m,t,`textCodec`)}i.push(m)}}return a}static parseLevelPlaylist(e,t,n,r,a,o){let s={url:t},c=new Vn(t),l=c.fragments,u=[],d=null,f=0,p=0,m=0,g=0,_=0,v=null,y=new te(r,s),b,x,S,C=-1,w=!1,T=null,E;if(hr.lastIndex=0,c.m3u8=e,c.hasVariableRefs=kn(e),hr.exec(e)?.[0]!==`#EXTM3U`)return c.playlistParsingError=Error(`Missing format identifier #EXTM3U`),c;for(;(b=hr.exec(e))!==null;){w&&(w=!1,y=new te(r,s),y.playlistOffset=m,y.setStart(m),y.sn=f,y.cc=g,_&&(y.bitrate=_),y.level=n,d&&(y.initSegment=d,d.rawProgramDateTime&&=(y.rawProgramDateTime=d.rawProgramDateTime,null),T&&=(y.setByteRange(T),null)));let e=b[1];if(e){y.duration=parseFloat(e);let t=(` `+b[2]).slice(1);y.title=t||null,y.tagList.push(t?[`INF`,e,t]:[`INF`,e])}else if(b[3]){if(i(y.duration)){y.playlistOffset=m,y.setStart(m),S&&Dr(y,S,c),y.sn=f,y.level=n,y.cc=g,l.push(y);let e=(` `+b[3]).slice(1);y.relurl=An(c,e),Tr(y,v,u),v=y,m+=y.duration,f++,p=0,w=!0}}else{if(b=b[0].match(gr),!b){O.warn(`No matches on slow regex match for level playlist!`);continue}for(x=1;x<b.length&&b[x]===void 0;x++);let e=(` `+b[x]).slice(1),a=(` `+b[x+1]).slice(1),u=b[x+2]?(` `+b[x+2]).slice(1):null;switch(e){case`BYTERANGE`:v?y.setByteRange(a,v):y.setByteRange(a);break;case`PROGRAM-DATE-TIME`:y.rawProgramDateTime=a,y.tagList.push([`PROGRAM-DATE-TIME`,a]),C===-1&&(C=l.length);break;case`PLAYLIST-TYPE`:c.type&&Or(c,e,b),c.type=a.toUpperCase();break;case`MEDIA-SEQUENCE`:c.startSN===0?l.length>0&&kr(c,e,b):Or(c,e,b),f=c.startSN=parseInt(a);break;case`SKIP`:{c.skippedSegments&&Or(c,e,b);let t=new Fn(a,c),n=t.decimalInteger(`SKIPPED-SEGMENTS`);if(i(n)){c.skippedSegments+=n;for(let e=n;e--;)l.push(null);f+=n}let r=t.enumeratedString(`RECENTLY-REMOVED-DATERANGES`);r&&(c.recentlyRemovedDateranges=(c.recentlyRemovedDateranges||[]).concat(r.split(`	`)));break}case`TARGETDURATION`:c.targetduration!==0&&Or(c,e,b),c.targetduration=Math.max(parseInt(a),1);break;case`VERSION`:c.version!==null&&Or(c,e,b),c.version=parseInt(a);break;case`INDEPENDENT-SEGMENTS`:break;case`ENDLIST`:c.live||Or(c,e,b),c.live=!1;break;case`#`:(a||u)&&y.tagList.push(u?[a,u]:[a]);break;case`DISCONTINUITY`:g++,y.tagList.push([`DIS`]);break;case`GAP`:y.gap=!0,y.tagList.push([e]);break;case`BITRATE`:y.tagList.push([e,a]),_=parseInt(a)*1e3,i(_)?y.bitrate=_:_=0;break;case`DATERANGE`:{let e=new Fn(a,c),t=new zn(e,c.dateRanges[e.ID],c.dateRangeTagCount);c.dateRangeTagCount++,t.isValid||c.skippedSegments?c.dateRanges[t.id]=t:O.warn(`Ignoring invalid DATERANGE tag: "${a}"`),y.tagList.push([`EXT-X-DATERANGE`,a]);break}case`DEFINE`:{let e=new Fn(a,c);`IMPORT`in e?Mn(c,e,o):jn(c,e,t)}break;case`DISCONTINUITY-SEQUENCE`:c.startCC===0?l.length>0&&kr(c,e,b):Or(c,e,b),c.startCC=g=parseInt(a);break;case`KEY`:{let e=br(a,t,c);if(e.isSupported()){if(e.method===`NONE`){S=void 0;break}S||={};let t=S[e.keyFormat];t!=null&&t.matches(e)||(t&&(S=h({},S)),S[e.keyFormat]=e)}else O.warn(`[Keys] Ignoring unsupported EXT-X-KEY tag: "${a}"`);break}case`START`:c.startTimeOffset=xr(a);break;case`MAP`:{let e=new Fn(a,c);if(y.duration){let t=new te(r,s);Er(t,e,n,S),d=t,y.initSegment=d,d.rawProgramDateTime&&!y.rawProgramDateTime&&(y.rawProgramDateTime=d.rawProgramDateTime)}else{let t=y.byteRangeEndOffset;if(t){let e=y.byteRangeStartOffset;T=`${t-e}@${e}`}else T=null;Er(y,e,n,S),d=y,w=!0}d.cc=g;break}case`SERVER-CONTROL`:E&&Or(c,e,b),E=new Fn(a),c.canBlockReload=E.bool(`CAN-BLOCK-RELOAD`),c.canSkipUntil=E.optionalFloat(`CAN-SKIP-UNTIL`,0),c.canSkipDateRanges=c.canSkipUntil>0&&E.bool(`CAN-SKIP-DATERANGES`),c.partHoldBack=E.optionalFloat(`PART-HOLD-BACK`,0),c.holdBack=E.optionalFloat(`HOLD-BACK`,0);break;case`PART-INF`:c.partTarget&&Or(c,e,b),c.partTarget=new Fn(a).decimalFloatingPoint(`PART-TARGET`);break;case`PART`:{let e=c.partList;e||=c.partList=[];let t=p>0?e[e.length-1]:void 0,n=p++,r=new ne(new Fn(a,c),y,s,n,t);e.push(r),y.duration+=r.duration;break}case`PRELOAD-HINT`:c.preloadHint=new Fn(a,c);break;case`RENDITION-REPORT`:{let e=new Fn(a,c);c.renditionReports=c.renditionReports||[],c.renditionReports.push(e);break}default:O.warn(`line parsed but not handled: ${b}`);break}}}v&&!v.relurl?(l.pop(),m-=v.duration,c.partList&&(c.fragmentHint=v)):c.partList&&(Tr(y,v,u),y.cc=g,c.fragmentHint=y,S&&Dr(y,S,c)),c.targetduration||(c.playlistParsingError=Error(`Missing Target Duration`));let D=l.length,k=l[0],A=l[D-1];if(m+=c.skippedSegments*c.targetduration,m>0&&D&&A){c.averagetargetduration=m/D;let e=A.sn;c.endSN=e===`initSegment`?0:e,c.live||(A.endList=!0),C>0&&(wr(l,C),k&&u.unshift(k))}return c.fragmentHint&&(m+=c.fragmentHint.duration),c.totalduration=m,u.length&&c.dateRangeTagCount&&k&&vr(u,c),c.endCC=g,c}};function vr(e,t){let n=e.length;if(!n)if(t.hasProgramDateTime){let r=t.fragments[t.fragments.length-1];e.push(r),n++}else return;let r=e[n-1],i=t.live?1/0:t.totalduration,a=Object.keys(t.dateRanges);for(let o=a.length;o--;){let s=t.dateRanges[a[o]],c=s.startDate.getTime();s.tagAnchor=r.ref;for(let r=n;r--&&!(e[r]?.sn<t.startSN);){let n=yr(t,c,e,r,i);if(n!==-1){s.tagAnchor=t.fragments[n].ref;break}}}}function yr(e,t,n,r,i){let a=n[r];if(a){let o=a.programDateTime;if((t>=o||r===0)&&t<=o+((n[r+1]?.start||i)-a.start)*1e3){let i=n[r].sn-e.startSN;if(i<0)return-1;let a=e.fragments;if(a.length>n.length){let o=(n[r+1]||a[a.length-1]).sn-e.startSN;for(let e=o;e>i;e--){let n=a[e].programDateTime;if(t>=n&&t<n+a[e].duration*1e3)return e}}return i}}return-1}function br(e,t,n){let r=new Fn(e,n),i=r.METHOD??``,a=r.URI,o=r.hexadecimalInteger(`IV`),s=r.KEYFORMATVERSIONS,c=r.KEYFORMAT??`identity`;return a&&r.IV&&!o&&O.error(`Invalid IV: ${r.IV}`),new cr(i,a?_r.resolve(a,t):``,c,(s||`1`).split(`/`).map(Number).filter(Number.isFinite),o,r.KEYID)}function xr(e){let t=new Fn(e).decimalFloatingPoint(`TIME-OFFSET`);return i(t)?t:null}function Sr(e,t){let n=(e||``).split(/[ ,]+/).filter(e=>e);[`video`,`audio`,`text`].forEach(e=>{let r=n.filter(t=>Re(t,e));r.length&&(t[`${e}Codec`]=r.map(e=>e.split(`/`)[0]).join(`,`),n=n.filter(e=>r.indexOf(e)===-1))}),t.unknownCodecs=n}function Cr(e,t,n){let r=t[n];r&&(e[n]=r)}function wr(e,t){let n=e[t];for(let r=t;r--;){let t=e[r];if(!t)return;t.programDateTime=n.programDateTime-t.duration*1e3,n=t}}function Tr(e,t,n){e.rawProgramDateTime?n.push(e):t!=null&&t.programDateTime&&(e.programDateTime=t.endProgramDateTime)}function Er(e,t,n,r){e.relurl=t.URI,t.BYTERANGE&&e.setByteRange(t.BYTERANGE),e.level=n,e.sn=`initSegment`,r&&(e.levelkeys=r),e.initSegment=null}function Dr(e,t,n){e.levelkeys=t;let{encryptedFragments:r}=n;(!r.length||r[r.length-1].levelkeys!==t)&&Object.keys(t).some(e=>t[e].isCommonEncryption)&&r.push(e)}function Or(e,t,n){e.playlistParsingError=Error(`#EXT-X-${t} must not appear more than once (${n[0]})`)}function kr(e,t,n){e.playlistParsingError=Error(`#EXT-X-${t} must appear before the first Media Segment (${n[0]})`)}function Ar(e,t){let n=t.startPTS;if(i(n)){let r=0,i;t.sn>e.sn?(r=n-e.start,i=e):(r=e.start-n,i=t),i.duration!==r&&i.setDuration(r)}else t.sn>e.sn?e.cc===t.cc&&e.minEndPTS?t.setStart(e.start+(e.minEndPTS-e.start)):t.setStart(e.start+e.duration):t.setStart(Math.max(e.start-t.duration,0))}function jr(e,t,n,r,a,o,s){r-n<=0&&(s.warn(`Fragment should have a positive duration`,t),r=n+t.duration,o=a+t.duration);let c=n,l=r,u=t.startPTS,d=t.endPTS;if(i(u)){let f=Math.abs(u-n);e&&f>e.totalduration?s.warn(`media timestamps and playlist times differ by ${f}s for level ${t.level} ${e.url}`):i(t.deltaPTS)?t.deltaPTS=Math.max(f,t.deltaPTS):t.deltaPTS=f,c=Math.max(n,u),n=Math.min(n,u),a=t.startDTS===void 0?a:Math.min(a,t.startDTS),l=Math.min(r,d),r=Math.max(r,d),o=t.endDTS===void 0?o:Math.max(o,t.endDTS)}let f=n-t.start;t.start!==0&&t.setStart(n),t.setDuration(r-t.start),t.startPTS=n,t.maxStartPTS=c,t.startDTS=a,t.endPTS=r,t.minEndPTS=l,t.endDTS=o;let p=t.sn;if(!e||p<e.startSN||p>e.endSN)return 0;let m,h=p-e.startSN,g=e.fragments;for(g[h]=t,m=h;m>0;m--)Ar(g[m],g[m-1]);for(m=h;m<g.length-1;m++)Ar(g[m],g[m+1]);return e.fragmentHint&&Ar(g[g.length-1],e.fragmentHint),e.PTSKnown=e.alignedSliding=!0,f}function Mr(e,t,n){if(e===t)return;let r=null,a=e.fragments;for(let e=a.length-1;e>=0;e--){let t=a[e].initSegment;if(t){r=t;break}}e.fragmentHint&&delete e.fragmentHint.endPTS;let o;Fr(e,t,(e,n,a,s)=>{if((!t.startCC||t.skippedSegments)&&n.cc!==e.cc){let r=e.cc-n.cc;for(let e=a;e<s.length;e++)s[e].cc+=r;t.endCC=s[s.length-1].cc}i(e.startPTS)&&i(e.endPTS)&&(n.setStart(n.startPTS=e.startPTS),n.startDTS=e.startDTS,n.maxStartPTS=e.maxStartPTS,n.endPTS=e.endPTS,n.endDTS=e.endDTS,n.minEndPTS=e.minEndPTS,n.setDuration(e.endPTS-e.startPTS),n.duration&&(o=n),t.PTSKnown=t.alignedSliding=!0),e.hasStreams&&(n.elementaryStreams=e.elementaryStreams),n.loader=e.loader,e.hasStats&&(n.stats=e.stats),e.initSegment&&(n.initSegment=e.initSegment,r=e.initSegment)});let s=t.fragments,c=t.fragmentHint?s.concat(t.fragmentHint):s;if(r&&c.forEach(e=>{e&&(!e.initSegment||e.initSegment.relurl===r?.relurl)&&(e.initSegment=r)}),t.skippedSegments){if(t.deltaUpdateFailed=s.some(e=>!e),t.deltaUpdateFailed){n.warn(`[level-helper] Previous playlist missing segments skipped in delta playlist`);for(let e=t.skippedSegments;e--;)s.shift();t.startSN=s[0].sn}else{t.canSkipDateRanges&&(t.dateRanges=Nr(e.dateRanges,t,n));let r=e.fragments.filter(e=>e.rawProgramDateTime);if(e.hasProgramDateTime&&!t.hasProgramDateTime)for(let e=1;e<c.length;e++)c[e].programDateTime===null&&Tr(c[e],c[e-1],r);vr(r,t)}t.endCC=s[s.length-1].cc}t.startCC||=Br(e,t.startSN-1)?.cc??s[0].cc,Pr(e.partList,t.partList,(e,t)=>{t.elementaryStreams=e.elementaryStreams,t.stats=e.stats}),o?jr(t,o,o.startPTS,o.endPTS,o.startDTS,o.endDTS,n):Lr(e,t),s.length&&(t.totalduration=t.edge-s[0].start),t.driftStartTime=e.driftStartTime,t.driftStart=e.driftStart;let l=t.advancedDateTime;if(t.advanced&&l){let e=t.edge;t.driftStart||=(t.driftStartTime=l,e),t.driftEndTime=l,t.driftEnd=e}else t.driftEndTime=e.driftEndTime,t.driftEnd=e.driftEnd,t.advancedDateTime=e.advancedDateTime;t.requestScheduled===-1&&(t.requestScheduled=e.requestScheduled)}function Nr(e,t,n){let{dateRanges:r,recentlyRemovedDateranges:i}=t,a=h({},e);i&&i.forEach(e=>{delete a[e]});let o=Object.keys(a).length;return o?(Object.keys(r).forEach(e=>{let t=a[e],i=new zn(r[e].attr,t);i.isValid?(a[e]=i,t||(i.tagOrder+=o)):n.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${q(r[e].attr)}"`)}),a):r}function Pr(e,t,n){if(e&&t){let r=0;for(let i=0,a=e.length;i<=a;i++){let a=e[i],o=t[i+r];a&&o&&a.index===o.index&&a.fragment.sn===o.fragment.sn?n(a,o):r--}}}function Fr(e,t,n){let r=t.skippedSegments,i=Math.max(e.startSN,t.startSN)-t.startSN,a=(e.fragmentHint?1:0)+(r?t.endSN:Math.min(e.endSN,t.endSN))-t.startSN,o=t.startSN-e.startSN,s=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,c=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments;for(let l=i;l<=a;l++){let i=c[o+l],a=s[l];if(r&&!a&&i&&(a=t.fragments[l]=i),i&&a){n(i,a,l,s);let r=i.relurl,o=a.relurl;if(r&&Wr(r,o)){t.playlistParsingError=Ir(`media sequence mismatch ${a.sn}:`,e,t,i,a);return}else if(i.cc!==a.cc){t.playlistParsingError=Ir(`discontinuity sequence mismatch (${i.cc}!=${a.cc})`,e,t,i,a);return}}}}function Ir(e,t,n,r,i){return Error(`${e} ${i.url}
Playlist starting @${t.startSN}
${t.m3u8}

Playlist starting @${n.startSN}
${n.m3u8}`)}function Lr(e,t,n=!0){let r=t.startSN+t.skippedSegments-e.startSN,i=e.fragments,a=r>=0,o=0;if(a&&r<i.length)o=i[r].start;else if(a&&t.startSN===e.endSN+1)o=e.fragmentEnd;else if(a&&n)o=e.fragmentStart+r*t.levelTargetDuration;else if(!t.skippedSegments&&t.fragmentStart===0)o=e.fragmentStart;else return;Rr(t,o)}function Rr(e,t){if(t){let n=e.fragments;for(let r=e.skippedSegments;r<n.length;r++)n[r].addStart(t);e.fragmentHint&&e.fragmentHint.addStart(t)}}function zr(e,t=1/0){let n=1e3*e.targetduration;if(e.updated){let r=e.fragments;if(r.length&&n*4>t){let e=r[r.length-1].duration*1e3;e<n&&(n=e)}}else n/=2;return Math.round(n)}function Br(e,t,n){if(!e)return null;let r=e.fragments[t-e.startSN];return r||(r=e.fragmentHint,r&&r.sn===t)?r:t<e.startSN&&n&&n.sn===t?n:null}function Vr(e,t,n){return e?Hr(e.partList,t,n):null}function Hr(e,t,n){if(e)for(let r=e.length;r--;){let i=e[r];if(i.index===n&&i.fragment.sn===t)return i}return null}function Ur(e){e.forEach((e,t)=>{var n;(n=e.details)==null||n.fragments.forEach(e=>{e.level=t,e.initSegment&&(e.initSegment.level=t)})})}function Wr(e,t){return e!==t&&t?Gr(e)!==Gr(t):!1}function Gr(e){return e.replace(/\?[^?]*$/,``)}function Kr(e,t){for(let n=0,r=e.length;n<r;n++)if(e[n]?.cc===t)return e[n];return null}function qr(e,t){return!!(e&&t.startCC<e.endCC&&t.endCC>e.startCC)}function Jr(e,t){let n=e.start+t;e.startPTS=n,e.setStart(n),e.endPTS=n+e.duration}function Yr(e,t){let n=t.fragments;for(let t=0,r=n.length;t<r;t++)Jr(n[t],e);t.fragmentHint&&Jr(t.fragmentHint,e),t.alignedSliding=!0}function Xr(e,t){e&&(Zr(t,e),t.alignedSliding||Qr(t,e),!t.alignedSliding&&!t.skippedSegments&&Lr(e,t,!1))}function Zr(e,t){if(!qr(t,e))return;let n=Math.min(t.endCC,e.endCC),r=Kr(t.fragments,n),i=Kr(e.fragments,n);!r||!i||(O.log(`Aligning playlist at start of dicontinuity sequence ${n}`),Yr(r.start-i.start,e))}function Qr(e,t){if(!e.hasProgramDateTime||!t.hasProgramDateTime)return;let n=e.fragments,r=t.fragments;if(!n.length||!r.length)return;let i,a,o=Math.min(t.endCC,e.endCC);t.startCC<o&&e.startCC<o&&(i=Kr(r,o),a=Kr(n,o)),(!i||!a)&&(i=r[Math.floor(r.length/2)],a=Kr(n,i.cc)||n[Math.floor(n.length/2)]);let s=i.programDateTime,c=a.programDateTime;!s||!c||Yr((c-s)/1e3-(a.start-i.start),e)}function $r(e,t,n){ei(e,t,n),e.addEventListener(t,n)}function ei(e,t,n){e.removeEventListener(t,n)}var ti={toString:function(e){let t=``,n=e.length;for(let r=0;r<n;r++)t+=`[${e.start(r).toFixed(3)}-${e.end(r).toFixed(3)}]`;return t}},X={STOPPED:`STOPPED`,IDLE:`IDLE`,KEY_LOADING:`KEY_LOADING`,FRAG_LOADING:`FRAG_LOADING`,FRAG_LOADING_WAITING_RETRY:`FRAG_LOADING_WAITING_RETRY`,WAITING_TRACK:`WAITING_TRACK`,PARSING:`PARSING`,PARSED:`PARSED`,ENDED:`ENDED`,ERROR:`ERROR`,WAITING_INIT_PTS:`WAITING_INIT_PTS`,WAITING_LEVEL:`WAITING_LEVEL`},ni=class extends wn{constructor(e,t,n,r,a){super(r,e.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=X.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.loadingParts=!1,this.loopSn=void 0,this.onMediaSeeking=()=>{let{config:e,fragCurrent:t,media:n,mediaBuffer:r,state:a}=this,o=n?n.currentTime:0,s=J.bufferInfo(r||n,o,e.maxBufferHole),c=!s.len;if(this.log(`Media seeking to ${i(o)?o.toFixed(3):o}, state: ${a}, ${c?`out of`:`in`} buffer`),this.state===X.ENDED)this.resetLoadingState();else if(t){let n=e.maxFragLookUpTolerance,r=t.start-n,i=t.start+t.duration+n;if(c||i<s.start||r>s.end){let e=o>i;(o<r||e)&&(e&&t.loader&&(this.log(`Cancelling fragment load for seek (sn: ${t.sn})`),t.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}if(n&&(this.fragmentTracker.removeFragmentsInRange(o,1/0,this.playlistType,!0),o>this.lastCurrentTime&&(this.lastCurrentTime=o),!this.loadingParts)){let e=Math.max(s.end,o),t=this.shouldLoadParts(this.getLevelDetails(),e);t&&(this.log(`LL-Part loading ON after seeking to ${o.toFixed(2)} with buffer @${e.toFixed(2)}`),this.loadingParts=t)}this.hls.hasEnoughToStart||(this.log(`Setting ${c?`startPosition`:`nextLoadPosition`} to ${o} for seek without enough to start`),this.nextLoadPosition=o,c&&(this.startPosition=o)),c&&this.state===X.IDLE&&this.tickImmediate()},this.onMediaEnded=()=>{this.log(`setting startPosition to 0 because media ended`),this.startPosition=this.lastCurrentTime=0},this.playlistType=a,this.hls=e,this.fragmentLoader=new yn(e.config),this.keyLoader=n,this.fragmentTracker=t,this.config=e.config,this.decrypter=new _n(e.config)}registerListeners(){let{hls:e}=this;e.on(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(l.ERROR,this.onError,this)}unregisterListeners(){let{hls:e}=this;e.off(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(l.ERROR,this.onError,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){if(this.state===X.STOPPED)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);let e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=X.STOPPED}get startPositionValue(){let{nextLoadPosition:e,startPosition:t}=this;return t===-1&&e?e:t}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}get inFlightFrag(){return{frag:this.fragCurrent,state:this.state}}_streamEnded(e,t){if(t.live||!this.media)return!1;let n=e.end||0,r=this.config.timelineOffset||0;if(n<=r)return!1;let i=e.buffered;this.config.maxBufferHole&&i&&i.length>1&&(e=J.bufferedInfo(i,e.start,0));let a=e.nextStart;if(a&&a>r&&a<t.edge||this.media.currentTime<e.start)return!1;let o=t.partList;if(o!=null&&o.length){let e=o[o.length-1];return J.isBuffered(this.media,e.start+e.duration/2)}let s=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(s)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null)return this.levelLastLoaded.details}get timelineOffset(){let e=this.config.timelineOffset;return e?this.getLevelDetails()?.appliedTimelineOffset||e:0}onMediaAttached(e,t){let n=this.media=this.mediaBuffer=t.media;$r(n,`seeking`,this.onMediaSeeking),$r(n,`ended`,this.onMediaEnded);let r=this.config;this.levels&&r.autoStartLoad&&this.state===X.STOPPED&&this.startLoad(r.startPosition)}onMediaDetaching(e,t){let n=!!t.transferMedia,r=this.media;if(r!==null){if(r.ended&&(this.log(`MSE detaching and video ended, reset startPosition`),this.startPosition=this.lastCurrentTime=0),ei(r,`seeking`,this.onMediaSeeking),ei(r,`ended`,this.onMediaEnded),this.keyLoader&&!n&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,n){this.resetLoadingState(),this.resetTransmuxer();return}this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1}onError(e,t){}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&=(this.transmuxer.destroy(),null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null}onHandlerDestroyed(){this.state=X.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,n){this.startFragRequested=!0,this._loadFragForPlayback(e,t,n)}_loadFragForPlayback(e,t,n){this._doFragLoad(e,t,n,e=>{let t=e.frag;if(this.fragContextChanged(t)){this.warn(`${t.type} sn: ${t.sn}${e.part?` part: `+e.part.index:``} of ${this.fragInfo(t,!1,e.part)}) was dropped during download.`),this.fragmentTracker.removeFragment(t);return}t.stats.chunkCount++,this._handleFragmentLoadProgress(e)}).then(e=>{if(!e)return;let t=this.state,n=e.frag;if(this.fragContextChanged(n)){(t===X.FRAG_LOADING||!this.fragCurrent&&t===X.PARSING)&&(this.fragmentTracker.removeFragment(n),this.state=X.IDLE);return}`payload`in e&&(this.log(`Loaded ${n.type} sn: ${n.sn} of ${this.playlistLabel()} ${n.level}`),this.hls.trigger(l.FRAG_LOADED,e)),this._handleFragmentLoadComplete(e)}).catch(t=>{this.state===X.STOPPED||this.state===X.ERROR||(this.warn(`Frag error: ${t?.message||t}`),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){let{fragmentTracker:t}=this;if(t.getState(e)===an.APPENDING){let n=e.type,r=this.getFwdBufferInfo(this.mediaBuffer,n),i=Math.max(e.duration,r?r.len:this.config.maxBufferLength),a=this.backtrackFragment;((a?e.sn-a.sn:0)===1||this.reduceMaxBufferLength(i,e.duration))&&t.removeFragment(e)}else this.mediaBuffer?.buffered.length===0?t.removeAllFragments():t.hasParts(e.type)&&(t.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),t.getState(e)===an.PARTIAL&&t.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){let t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}waitForLive(e){let t=e.details;return t?.live&&t.type!==`EVENT`&&(this.levelLastLoaded!==e||t.expired)}flushMainBuffer(e,t,n=null){if(!(e-t))return;let r={startOffset:e,endOffset:t,type:n};this.hls.trigger(l.BUFFER_FLUSHING,r)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(e=>{let t=e?.frag;if(!t||this.fragContextChanged(t)||!this.levels)throw Error(`init load aborted`);return e}).then(e=>{let{hls:t}=this,{frag:n,payload:r}=e,i=n.decryptdata;if(r&&r.byteLength>0&&i!=null&&i.key&&i.iv&&Wn(i.method)){let a=self.performance.now();return this.decrypter.decrypt(new Uint8Array(r),i.key.buffer,i.iv.buffer,Gn(i.method)).catch(e=>{throw t.trigger(l.ERROR,{type:s.MEDIA_ERROR,details:c.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:n}),e}).then(r=>{let i=self.performance.now();return t.trigger(l.FRAG_DECRYPTED,{frag:n,payload:r,stats:{tstart:a,tdecrypt:i}}),e.payload=r,this.completeInitSegmentLoad(e)})}return this.completeInitSegmentLoad(e)}).catch(t=>{this.state===X.STOPPED||this.state===X.ERROR||(this.warn(t),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){let{levels:t}=this;if(!t)throw Error(`init load aborted, missing levels`);let n=e.frag.stats;this.state!==X.STOPPED&&(this.state=X.IDLE),e.frag.data=new Uint8Array(e.payload),n.parsing.start=n.buffering.start=self.performance.now(),n.parsing.end=n.buffering.end=self.performance.now(),this.tick()}unhandledEncryptionError(e,t){var n,r;let i=e.tracks;if(i&&!t.encrypted&&((n=i.audio)!=null&&n.encrypted||(r=i.video)!=null&&r.encrypted)&&(!this.config.emeEnabled||!this.keyLoader.emeController)){let e=this.media,n=Error(`Encrypted track with no key in ${this.fragInfo(t)} (media ${e?`attached mediaKeys: `+e.mediaKeys:`detached`})`);return this.warn(n.message),!e||e.mediaKeys?!1:(this.hls.trigger(l.ERROR,{type:s.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_NO_KEYS,fatal:!1,error:n,frag:t}),this.resetTransmuxer(),!0)}return!1}fragContextChanged(e){let{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){let n=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?` part: `+t.index:``} of ${this.fragInfo(e,!1,t)} > buffer:${n?ti.toString(J.getBuffered(n)):`(detached)`})`),H(e)){if(e.type!==d.SUBTITLE){let t=e.elementaryStreams;if(!Object.keys(t).some(e=>!!t[e])){this.state=X.IDLE;return}}let t=this.levels?.[e.level];t!=null&&t.fragmentError&&(this.log(`Resetting level fragment error count of ${t.fragmentError} on frag buffered`),t.fragmentError=0)}this.state=X.IDLE}_handleFragmentLoadComplete(e){let{transmuxer:t}=this;if(!t)return;let{frag:n,part:r,partsLoaded:i}=e,a=!i||i.length===0||i.some(e=>!e),o=new Tn(n.level,n.sn,n.stats.chunkCount+1,0,r?r.index:-1,!a);t.flush(o)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,n=null,r){var a;this.fragCurrent=e;let o=t.details;if(!this.levels||!o)throw Error(`frag load aborted, missing level${o?``:` detail`}s`);let s=null;if(e.encrypted&&!((a=e.decryptdata)!=null&&a.key)){if(this.log(`Loading key for ${e.sn} of [${o.startSN}-${o.endSN}], ${this.playlistLabel()} ${e.level}`),this.state=X.KEY_LOADING,this.fragCurrent=e,s=this.keyLoader.load(e).then(e=>{if(!this.fragContextChanged(e.frag))return this.hls.trigger(l.KEY_LOADED,e),this.state===X.KEY_LOADING&&(this.state=X.IDLE),e}),this.hls.trigger(l.KEY_LOADING,{frag:e}),this.fragCurrent===null)return this.log(`context changed in KEY_LOADING`),Promise.resolve(null)}else e.encrypted||(s=this.keyLoader.loadClear(e,o.encryptedFragments,this.startFragRequested),s&&this.log(`[eme] blocking frag load until media-keys acquired`));let c=this.fragPrevious;if(H(e)&&(!c||e.sn!==c.sn)){let n=this.shouldLoadParts(t.details,e.end);n!==this.loadingParts&&(this.log(`LL-Part loading ${n?`ON`:`OFF`} loading sn ${c?.sn}->${e.sn}`),this.loadingParts=n)}if(n=Math.max(e.start,n||0),this.loadingParts&&H(e)){let i=o.partList;if(i&&r){n>o.fragmentEnd&&o.fragmentHint&&(e=o.fragmentHint);let a=this.getNextPart(i,e,n);if(a>-1){let c=i[a];e=this.fragCurrent=c.fragment,this.log(`Loading ${e.type} sn: ${e.sn} part: ${c.index} (${a}/${i.length-1}) of ${this.fragInfo(e,!1,c)}) cc: ${e.cc} [${o.startSN}-${o.endSN}], target: ${parseFloat(n.toFixed(3))}`),this.nextLoadPosition=c.start+c.duration,this.state=X.FRAG_LOADING;let u;return u=s?s.then(n=>!n||this.fragContextChanged(n.frag)?null:this.doFragPartsLoad(e,c,t,r)).catch(e=>this.handleFragLoadError(e)):this.doFragPartsLoad(e,c,t,r).catch(e=>this.handleFragLoadError(e)),this.hls.trigger(l.FRAG_LOADING,{frag:e,part:c,targetBufferTime:n}),this.fragCurrent===null?Promise.reject(Error(`frag load aborted, context changed in FRAG_LOADING parts`)):u}else if(!e.url||this.loadedEndOfParts(i,n))return Promise.resolve(null)}}if(H(e)&&this.loadingParts)this.log(`LL-Part loading OFF after next part miss @${n.toFixed(2)} Check buffer at sn: ${e.sn} loaded parts: ${o.partList?.filter(e=>e.loaded).map(e=>`[${e.start}-${e.end}]`)}`),this.loadingParts=!1;else if(!e.url)return Promise.resolve(null);this.log(`Loading ${e.type} sn: ${e.sn} of ${this.fragInfo(e,!1)}) cc: ${e.cc} ${`[`+o.startSN+`-`+o.endSN+`]`}, target: ${parseFloat(n.toFixed(3))}`),i(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=X.FRAG_LOADING;let u=this.config.progressive&&e.type!==d.SUBTITLE,f;return f=u&&s?s.then(t=>!t||this.fragContextChanged(t.frag)?null:this.fragmentLoader.load(e,r)).catch(e=>this.handleFragLoadError(e)):Promise.all([this.fragmentLoader.load(e,u?r:void 0),s]).then(([e])=>(!u&&r&&r(e),e)).catch(e=>this.handleFragLoadError(e)),this.hls.trigger(l.FRAG_LOADING,{frag:e,targetBufferTime:n}),this.fragCurrent===null?Promise.reject(Error(`frag load aborted, context changed in FRAG_LOADING`)):f}doFragPartsLoad(e,t,n,r){return new Promise((i,a)=>{let o=[],s=n.details?.partList,c=t=>{this.fragmentLoader.loadPart(e,t,r).then(r=>{o[t.index]=r;let a=r.part;this.hls.trigger(l.FRAG_LOADED,r);let u=Vr(n.details,e.sn,t.index+1)||Hr(s,e.sn,t.index+1);if(u)c(u);else return i({frag:e,part:a,partsLoaded:o})}).catch(a)};c(t)})}handleFragLoadError(e){if(`data`in e){let t=e.data;t.frag&&t.details===c.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):t.frag&&t.type===s.KEY_SYSTEM_ERROR?(t.frag.abortRequests(),this.resetStartWhenNotLoaded(),this.resetFragmentLoading(t.frag)):this.hls.trigger(l.ERROR,t)}else this.hls.trigger(l.ERROR,{type:s.OTHER_ERROR,details:c.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){let t=this.getCurrentContext(e);if(!t||this.state!==X.PARSING){!this.fragCurrent&&this.state!==X.STOPPED&&this.state!==X.ERROR&&(this.state=X.IDLE);return}let{frag:n,part:r,level:i}=t,a=self.performance.now();n.stats.parsing.end=a,r&&(r.stats.parsing.end=a);let o=this.getLevelDetails(),s=o&&n.sn>o.endSN||this.shouldLoadParts(o,n.end);s!==this.loadingParts&&(this.log(`LL-Part loading ${s?`ON`:`OFF`} after parsing segment ending @${n.end.toFixed(2)}`),this.loadingParts=s),this.updateLevelTiming(n,r,i,e.partial)}shouldLoadParts(e,t){if(this.config.lowLatencyMode){if(!e)return this.loadingParts;if(e.partList){let n=e.partList[0];if(n.fragment.type===d.SUBTITLE)return!1;if(t>=n.end+(e.fragmentHint?.duration||0)&&(this.hls.hasEnoughToStart?this.media?.currentTime||this.lastCurrentTime:this.getLoadPosition())>n.start-n.fragment.duration)return!0}}return!1}getCurrentContext(e){let{levels:t,fragCurrent:n}=this,{level:r,sn:i,part:a}=e;if(!(t!=null&&t[r]))return this.warn(`Levels object was unset while buffering fragment ${i} of ${this.playlistLabel()} ${r}. The current chunk will not be buffered.`),null;let o=t[r],s=o.details,c=a>-1?Vr(s,i,a):null,l=c?c.fragment:Br(s,i,n);return l?(n&&n!==l&&(l.stats=n.stats),{frag:l,part:c,level:o}):null}bufferFragmentData(e,t,n,r,i){if(this.state!==X.PARSING)return;let{data1:a,data2:o}=e,s=a;if(o&&(s=Te(a,o)),!s.length)return;let c=this.initPTS[t.cc],u=c?-c.baseTime/c.timescale:void 0,d={type:e.type,frag:t,part:n,chunkMeta:r,offset:u,parent:t.type,data:s};if(this.hls.trigger(l.BUFFER_APPENDING,d),e.dropped&&e.independent&&!n){if(i)return;this.flushBufferGap(t)}}flushBufferGap(e){let t=this.media;if(!t)return;if(!J.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}let n=t.currentTime,r=J.bufferInfo(t,n,0),i=e.duration,a=Math.min(this.config.maxFragLookUpTolerance*2,i*.25),o=Math.max(Math.min(e.start-a,r.end-a),n+a);e.start-o>a&&this.flushMainBuffer(o,e.start)}getFwdBufferInfo(e,t){var n;let r=this.getLoadPosition();if(!i(r))return null;let a=this.lastCurrentTime>r||(n=this.media)!=null&&n.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(e,r,t,a)}getFwdBufferInfoAtPos(e,t,n,r){let i=J.bufferInfo(e,t,r);if(i.len===0&&i.nextStart!==void 0){let a=this.fragmentTracker.getBufferedFrag(t,n);if(a&&(i.nextStart<=a.end||a.gap)){let n=Math.max(Math.min(i.nextStart,a.end)-t,r);return J.bufferInfo(e,t,n)}}return i}getMaxBufferLength(e){let{config:t}=this,n;return n=e?Math.max(8*t.maxBufferSize/e,t.maxBufferLength):t.maxBufferLength,Math.min(n,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){let n=this.config,r=Math.max(Math.min(e-t,n.maxBufferLength),t),i=Math.max(e-t*3,n.maxMaxBufferLength/2,r);return i>=r?(n.maxMaxBufferLength=i,this.warn(`Reduce max buffer length to ${i}s`),!0):!1}getAppendedFrag(e,t=d.MAIN){let n=this.fragmentTracker?this.fragmentTracker.getAppendedFrag(e,t):null;return n&&`fragment`in n?n.fragment:n}getNextFragment(e,t){let n=t.fragments,r=n.length;if(!r)return null;let{config:i}=this,a=n[0].start,o=i.lowLatencyMode&&!!t.partList,s=null;if(t.live){let n=i.initialLiveManifestSize;if(r<n)return this.warn(`Not enough fragments to start playback (have: ${r}, need: ${n})`),null;if(!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||e<a){o&&!this.loadingParts&&(this.log(`LL-Part loading ON for initial live fragment`),this.loadingParts=!0),s=this.getInitialLiveFragment(t);let n=this.hls.startPosition,r=this.hls.liveSyncPosition,i=s?(n!==-1&&n>=a?n:r)||s.start:e;this.log(`Setting startPosition to ${i} to match start frag at live edge. mainStart: ${n} liveSyncPosition: ${r} frag.start: ${s?.start}`),this.startPosition=this.nextLoadPosition=i}}else e<=a&&(s=n[0]);if(!s){let n=this.loadingParts?t.partEnd:t.fragmentEnd;s=this.getFragmentAtPosition(e,n,t)}let c=this.filterReplacedPrimary(s,t);if(!c&&s){let e=s.sn-t.startSN;c=this.filterReplacedPrimary(n[e+1]||null,t)}return this.mapToInitFragWhenRequired(c)}isLoopLoading(e,t){let n=this.fragmentTracker.getState(e);return(n===an.OK||n===an.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,n,r,i){let a=null;if(e.gap&&(a=this.getNextFragment(this.nextLoadPosition,t),a&&!a.gap&&n.nextStart)){let e=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,n.nextStart,r,0);if(e!==null&&n.len+e.len>=i){let e=a.sn;return this.loopSn!==e&&(this.log(`buffer full after gaps in "${r}" playlist starting at sn: ${e}`),this.loopSn=e),null}}return this.loopSn=void 0,a}get primaryPrefetch(){if(ri(this.config)){var e;if(!((e=this.hls.interstitialsManager)==null||(e=e.playingItem)==null)&&e.event)return!0}return!1}filterReplacedPrimary(e,t){if(!e)return e;if(ri(this.config)&&e.type!==d.SUBTITLE){let n=this.hls.interstitialsManager,r=n?.bufferingItem;if(r){let n=r.event;if(n){if(n.appendInPlace||Math.abs(e.start-r.start)>1||r.start===0)return null}else if(e.end<=r.start&&t?.live===!1||e.start>r.end&&r.nextEvent&&(r.nextEvent.appendInPlace||e.start-r.end>1))return null}let i=n?.playerQueue;if(i)for(let t=i.length;t--;){let n=i[t].interstitial;if(n.appendInPlace&&e.start>=n.startTime&&e.end<=n.resumeTime)return null}}return e}mapToInitFragWhenRequired(e){return e!=null&&e.initSegment&&!e.initSegment.data&&!this.bitrateTest?e.initSegment:e}getNextPart(e,t,n){let r=-1,i=!1,a=!0;for(let o=0,s=e.length;o<s;o++){let s=e[o];if(a&&=!s.independent,r>-1&&n<s.start)break;let c=s.loaded;c?r=-1:(i||(s.independent||a)&&s.fragment===t)&&(s.fragment!==t&&this.warn(`Need buffer at ${n} but next unloaded part starts at ${s.start}`),r=o),i=c}return r}loadedEndOfParts(e,t){let n;for(let r=e.length;r--;){if(n=e[r],!n.loaded)return!1;if(t>n.start)return!0}return!1}getInitialLiveFragment(e){let t=e.fragments,n=this.fragPrevious,r=null;if(n){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${n.programDateTime}`),r=zt(t,n.endProgramDateTime,this.config.maxFragLookUpTolerance)),!r){let i=n.sn+1;if(i>=e.startSN&&i<=e.endSN){let a=t[i-e.startSN];n.cc===a.cc&&(r=a,this.log(`Live playlist, switching playlist, load frag with next SN: ${r.sn}`))}r||(r=Wt(e,n.cc,n.end),r&&this.log(`Live playlist, switching playlist, load frag with same CC: ${r.sn}`))}}else{let t=this.hls.liveSyncPosition;t!==null&&(r=this.getFragmentAtPosition(t,this.bitrateTest?e.fragmentEnd:e.edge,e))}return r}getFragmentAtPosition(e,t,n){let{config:r}=this,{fragPrevious:i}=this,{fragments:a,endSN:o}=n,{fragmentHint:s}=n,{maxFragLookUpTolerance:c}=r,l=n.partList,u=!!(this.loadingParts&&l!=null&&l.length&&s);u&&!this.bitrateTest&&l[l.length-1].fragment.sn===s.sn&&(a=a.concat(s),o=s.sn);let d;if(e<t){var f;let n=e<this.lastCurrentTime||e>t-c||(f=this.media)!=null&&f.paused||!this.startFragRequested?0:c;d=Bt(i,a,e,n)}else d=a[a.length-1];if(d){let e=d.sn-n.startSN,t=this.fragmentTracker.getState(d);if((t===an.OK||t===an.PARTIAL&&d.gap)&&(i=d),i&&d.sn===i.sn&&(!u||l[0].fragment.sn>d.sn||!n.live)&&d.level===i.level){let t=a[e+1];d=d.sn<o&&this.fragmentTracker.getState(t)!==an.OK?t:null}}return d}alignPlaylists(e,t,n){let r=e.fragments.length;if(!r)return this.warn(`No fragments in live playlist`),0;let a=e.fragmentStart,o=!t,s=e.alignedSliding&&i(a);if(o||!s&&!a){Xr(n,e);let i=e.fragmentStart;return this.log(`Live playlist sliding: ${i.toFixed(2)} start-sn: ${t?t.startSN:`na`}->${e.startSN} fragments: ${r}`),i}return a}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)}setStartPosition(e,t){let n=this.startPosition;n<t&&(n=-1);let r=this.timelineOffset;if(n===-1){let a=this.startTimeOffset!==null,o=a?this.startTimeOffset:e.startTimeOffset;o!==null&&i(o)?(n=t+o,o<0&&(n+=e.edge),n=Math.min(Math.max(t,n),t+e.totalduration),this.log(`Setting startPosition to ${n} for start time offset ${o} found in ${a?`multivariant`:`media`} playlist`),this.startPosition=n):e.live?(n=this.hls.liveSyncPosition||t,this.log(`Setting startPosition to -1 to start at live edge ${n}`),this.startPosition=-1):(this.log(`setting startPosition to 0 by default`),this.startPosition=n=0),this.lastCurrentTime=n+r}this.nextLoadPosition=n+r}getLoadPosition(){var e;let{media:t}=this,n=0;return(e=this.hls)!=null&&e.hasEnoughToStart&&t?n=t.currentTime:this.nextLoadPosition>=0&&(n=this.nextLoadPosition),n}handleFragLoadAborted(e,t){this.transmuxer&&e.type===this.playlistType&&H(e)&&e.stats.aborted&&(this.log(`Fragment ${e.sn}${t?` part `+t.index:``} of ${this.playlistLabel()} ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==X.FRAG_LOADING_WAITING_RETRY)&&(this.state=X.IDLE)}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){let e=this.getCurrentContext(t.chunkMeta);e&&(t.frag=e.frag)}let n=t.frag;if(!n||n.type!==e||!this.levels)return;if(this.fragContextChanged(n)){this.warn(`Frag load error must match current frag to retry ${n.url} > ${this.fragCurrent?.url}`);return}let r=t.details===c.FRAG_GAP;r&&this.fragmentTracker.fragBuffered(n,!0);let i=t.errorAction;if(!i){this.state=X.ERROR;return}let{action:a,flags:o,retryCount:s=0,retryConfig:l}=i,u=!!l,d=u&&a===en.RetryRequest,f=u&&!i.resolved&&o===tn.MoveAllAlternatesMatchingHost,p=this.hls.latestLevelDetails?.live;if(!d&&f&&H(n)&&!n.endList&&p&&!qt(t))this.resetFragmentErrors(e),this.treatAsGap(n),i.resolved=!0;else if((d||f)&&s<l.maxNumRetry){let r=$t(t.response?.code),a=Yt(l,s);if(this.resetStartWhenNotLoaded(),this.retryDate=self.performance.now()+a,this.state=X.FRAG_LOADING_WAITING_RETRY,i.resolved=!0,r){this.log(`Waiting for connection (offline)`),this.retryDate=1/0,t.reason=`offline`;return}this.warn(`Fragment ${n.sn} of ${e} ${n.level} errored with ${t.details}, retrying loading ${s+1}/${l.maxNumRetry} in ${a}ms`)}else if(l)if(this.resetFragmentErrors(e),s<l.maxNumRetry)!r&&a!==en.RemoveAlternatePermanently&&(i.resolved=!0);else{this.warn(`${t.details} reached or exceeded max retry (${s})`);return}else a===en.SendAlternateToPenaltyBox?this.state=X.WAITING_LEVEL:this.state=X.ERROR;this.tickImmediate()}checkRetryDate(){let e=self.performance.now(),t=this.retryDate,n=t===1/0;(!t||e>=t||n&&!$t(0))&&(n&&this.log(`Connection restored (online)`),this.resetStartWhenNotLoaded(),this.state=X.IDLE)}reduceLengthAndFlushBuffer(e){if(this.state===X.PARSING||this.state===X.PARSED){let t=e.frag,n=e.parent,r=this.getFwdBufferInfo(this.mediaBuffer,n),i=r&&r.len>.5;i&&this.reduceMaxBufferLength(r.len,t?.duration||10);let a=!i;return a&&this.warn(`Buffer full error while media.currentTime (${this.getLoadPosition()}) is not buffered, flush ${n} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),a}return!1}resetFragmentErrors(e){e===d.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==X.STOPPED&&(this.state=X.IDLE)}afterBufferFlushed(e,t,n){if(!e)return;let r=J.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,r,n),this.state===X.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log(`Reset loading state`),this.fragCurrent=null,this.fragPrevious=null,this.state!==X.STOPPED&&(this.state=X.IDLE)}resetStartWhenNotLoaded(){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;let e=this.levelLastLoaded,t=e?e.details:null;t!=null&&t.live?(this.log(`resetting startPosition for live start`),this.startPosition=-1,this.setStartPosition(t,t.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.log(`Loading context changed while buffering sn ${e.sn} of ${this.playlistLabel()} ${e.level===-1?`<removed>`:e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,n,r){let i=n.details;if(!i){this.warn(`level.details undefined`);return}if(!Object.keys(e.elementaryStreams).reduce((t,a)=>{let o=e.elementaryStreams[a];if(o){let s=o.endPTS-o.startPTS;if(s<=0)return this.warn(`Could not parse fragment ${e.sn} ${a} duration reliably (${s})`),t||!1;let c=r?0:jr(i,e,o.startPTS,o.endPTS,o.startDTS,o.endDTS,this);return this.hls.trigger(l.LEVEL_PTS_UPDATED,{details:i,level:n,drift:c,type:a,frag:e,start:o.startPTS,end:o.endPTS}),!0}return t},!1)){let t=this.transmuxer?.error===null;if((n.fragmentError===0||t&&(n.fragmentError<2||e.endList))&&this.treatAsGap(e,n),t){let t=Error(`Found no media in fragment ${e.sn} of ${this.playlistLabel()} ${e.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(t.message),this.hls.trigger(l.ERROR,{type:s.MEDIA_ERROR,details:c.FRAG_PARSING_ERROR,fatal:!1,error:t,frag:e,reason:`Found no media in msn ${e.sn} of ${this.playlistLabel()} "${n.url}"`}),!this.hls)return;this.resetTransmuxer()}}this.state=X.PARSED,this.log(`Parsed ${e.type} sn: ${e.sn}${t?` part: `+t.index:``} of ${this.fragInfo(e,!1,t)})`),this.hls.trigger(l.FRAG_PARSED,{frag:e,part:t})}playlistLabel(){return this.playlistType===d.MAIN?`level`:`track`}fragInfo(e,t=!0,n){return`${this.playlistLabel()} ${e.level} (${n?`part`:`frag`}:[${((t&&!n?e.startPTS:(n||e).start)??NaN).toFixed(3)}-${((t&&!n?e.endPTS:(n||e).end)??NaN).toFixed(3)}]${n&&e.type===`main`?`INDEPENDENT=`+(n.independent?`YES`:`NO`):``}`}treatAsGap(e,t){t&&t.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)}resetTransmuxer(){var e;(e=this.transmuxer)==null||e.reset()}recoverWorkerError(e){e.event===`demuxerWorker`&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&=(this.transmuxer.destroy(),null),this.resetStartWhenNotLoaded(),this.resetLoadingState())}set state(e){let t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}};function ri(e){return!!e.interstitialsController&&e.enableInterstitialPlayback!==!1}var ii=class{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){let{chunks:e,dataLength:t}=this,n;if(e.length)n=e.length===1?e[0]:ai(e,t);else return new Uint8Array;return this.reset(),n}reset(){this.chunks.length=0,this.dataLength=0}};function ai(e,t){let n=new Uint8Array(t),r=0;for(let t=0;t<e.length;t++){let i=e[t];n.set(i,r),r+=i.length}return n}var oi={exports:{}},si;function ci(){return si?oi.exports:(si=1,(function(e){var t=Object.prototype.hasOwnProperty,n=`~`;function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(n=!1));function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function a(e,t,r,a,o){if(typeof r!=`function`)throw TypeError(`The listener must be a function`);var s=new i(r,a||e,o),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],s]:e._events[c].push(s):(e._events[c]=s,e._eventsCount++),e}function o(e,t){--e._eventsCount===0?e._events=new r:delete e._events[t]}function s(){this._events=new r,this._eventsCount=0}s.prototype.eventNames=function(){var e=[],r,i;if(this._eventsCount===0)return e;for(i in r=this._events)t.call(r,i)&&e.push(n?i.slice(1):i);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(r)):e},s.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,a=r.length,o=Array(a);i<a;i++)o[i]=r[i].fn;return o},s.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},s.prototype.emit=function(e,t,r,i,a,o){var s=n?n+e:e;if(!this._events[s])return!1;var c=this._events[s],l=arguments.length,u,d;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,r),!0;case 4:return c.fn.call(c.context,t,r,i),!0;case 5:return c.fn.call(c.context,t,r,i,a),!0;case 6:return c.fn.call(c.context,t,r,i,a,o),!0}for(d=1,u=Array(l-1);d<l;d++)u[d-1]=arguments[d];c.fn.apply(c.context,u)}else{var f=c.length,p;for(d=0;d<f;d++)switch(c[d].once&&this.removeListener(e,c[d].fn,void 0,!0),l){case 1:c[d].fn.call(c[d].context);break;case 2:c[d].fn.call(c[d].context,t);break;case 3:c[d].fn.call(c[d].context,t,r);break;case 4:c[d].fn.call(c[d].context,t,r,i);break;default:if(!u)for(p=1,u=Array(l-1);p<l;p++)u[p-1]=arguments[p];c[d].fn.apply(c[d].context,u)}}return!0},s.prototype.on=function(e,t,n){return a(this,e,t,n,!1)},s.prototype.once=function(e,t,n){return a(this,e,t,n,!0)},s.prototype.removeListener=function(e,t,r,i){var a=n?n+e:e;if(!this._events[a])return this;if(!t)return o(this,a),this;var s=this._events[a];if(s.fn)s.fn===t&&(!i||s.once)&&(!r||s.context===r)&&o(this,a);else{for(var c=0,l=[],u=s.length;c<u;c++)(s[c].fn!==t||i&&!s[c].once||r&&s[c].context!==r)&&l.push(s[c]);l.length?this._events[a]=l.length===1?l[0]:l:o(this,a)}return this},s.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&o(this,t)):(this._events=new r,this._eventsCount=0),this},s.prototype.off=s.prototype.removeListener,s.prototype.addListener=s.prototype.on,s.prefixed=n,s.EventEmitter=s,e.exports=s})(oi),oi.exports)}var li=F(ci()),ui=`1.6.15`,di={};function fi(){return typeof __HLS_WORKER_BUNDLE__==`function`}function pi(){let e=di[ui];if(e)return e.clientCount++,e;let t=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:`text/javascript`}),n=self.URL.createObjectURL(t),r={worker:new self.Worker(n),objectURL:n,clientCount:1};return di[ui]=r,r}function mi(e){let t=di[e];if(t)return t.clientCount++,t;let n=new self.URL(e,self.location.href).href,r={worker:new self.Worker(n),scriptURL:n,clientCount:1};return di[e]=r,r}function hi(e){let t=di[e||ui];if(t&&t.clientCount--===1){let{worker:n,objectURL:r}=t;delete di[e||ui],r&&self.URL.revokeObjectURL(r),n.terminate()}}function gi(e,t){return t+10<=e.length&&e[t]===51&&e[t+1]===68&&e[t+2]===73&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128}function _i(e,t){return t+10<=e.length&&e[t]===73&&e[t+1]===68&&e[t+2]===51&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128}function vi(e,t){let n=0;return n=(e[t]&127)<<21,n|=(e[t+1]&127)<<14,n|=(e[t+2]&127)<<7,n|=e[t+3]&127,n}function yi(e,t){let n=t,r=0;for(;_i(e,t);){r+=10;let n=vi(e,t+6);r+=n,gi(e,t+10)&&(r+=10),t+=r}if(r>0)return e.subarray(n,n+r)}function bi(e,t,n,r){let i=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],a=t[n+2],o=a>>2&15;if(o>12){let t=Error(`invalid ADTS sampling index:${o}`);e.emit(l.ERROR,l.ERROR,{type:s.MEDIA_ERROR,details:c.FRAG_PARSING_ERROR,fatal:!0,error:t,reason:t.message});return}let u=(a>>6&3)+1,d=t[n+3]>>6&3|(a&1)<<2,f=`mp4a.40.`+u,p=i[o],m=o;(u===5||u===29)&&(m-=3);let h=[u<<3|(m&14)>>1,(m&1)<<7|d<<3];return O.log(`manifest codec:${r}, parsed codec:${f}, channels:${d}, rate:${p} (ADTS object type:${u} sampling index:${o})`),{config:h,samplerate:p,channelCount:d,codec:f,parsedCodec:f,manifestCodec:r}}function xi(e,t){return e[t]===255&&(e[t+1]&246)==240}function Si(e,t){return e[t+1]&1?7:9}function Ci(e,t){return(e[t+3]&3)<<11|e[t+4]<<3|(e[t+5]&224)>>>5}function wi(e,t){return t+5<e.length}function Ti(e,t){return t+1<e.length&&xi(e,t)}function Ei(e,t){return wi(e,t)&&xi(e,t)&&Ci(e,t)<=e.length-t}function Di(e,t){if(Ti(e,t)){let n=Si(e,t);if(t+n>=e.length)return!1;let r=Ci(e,t);if(r<=n)return!1;let i=t+r;return i===e.length||Ti(e,i)}return!1}function Oi(e,t,n,r,i){if(!e.samplerate){let a=bi(t,n,r,i);if(!a)return;h(e,a)}}function ki(e){return 1024*9e4/e}function Ai(e,t){let n=Si(e,t);if(t+n<=e.length){let r=Ci(e,t)-n;if(r>0)return{headerLength:n,frameLength:r}}}function ji(e,t,n,r,i){let a=r+i*ki(e.samplerate),o=Ai(t,n),s;if(o){let{frameLength:r,headerLength:i}=o,c=i+r,l=Math.max(0,n+c-t.length);l?(s=new Uint8Array(c-i),s.set(t.subarray(n+i,t.length),0)):s=t.subarray(n+i,n+c);let u={unit:s,pts:a};return l||e.samples.push(u),{sample:u,length:c,missing:l}}let c=t.length-n;return s=new Uint8Array(c),s.set(t.subarray(n,t.length),0),{sample:{unit:s,pts:a},length:c,missing:-1}}function Mi(e,t){return _i(e,t)&&vi(e,t+6)+10<=e.length-t}function Ni(e){return e instanceof ArrayBuffer?e:e.byteOffset==0&&e.byteLength==e.buffer.byteLength?e.buffer:new Uint8Array(e).buffer}function Pi(e,t=0,n=1/0){return Fi(e,t,n,Uint8Array)}function Fi(e,t,n,r){let i=Ii(e),a=1;`BYTES_PER_ELEMENT`in r&&(a=r.BYTES_PER_ELEMENT);let o=Li(e)?e.byteOffset:0,s=(o+e.byteLength)/a,c=(o+t)/a,l=Math.floor(Math.max(0,Math.min(c,s)));return new r(i,l,Math.floor(Math.min(l+Math.max(n,0),s))-l)}function Ii(e){return e instanceof ArrayBuffer?e:e.buffer}function Li(e){return e&&e.buffer instanceof ArrayBuffer&&e.byteLength!==void 0&&e.byteOffset!==void 0}function Ri(e){let t={key:e.type,description:``,data:``,mimeType:null,pictureType:null};if(e.size<2)return;if(e.data[0]!==3){console.log(`Ignore frame with unrecognized character encoding`);return}let n=e.data.subarray(1).indexOf(0);if(n===-1)return;let r=M(Pi(e.data,1,n)),i=e.data[2+n],a=e.data.subarray(3+n).indexOf(0);if(a===-1)return;let o=M(Pi(e.data,3+n,a)),s;return s=r===`-->`?M(Pi(e.data,4+n+a)):Ni(e.data.subarray(4+n+a)),t.mimeType=r,t.pictureType=i,t.description=o,t.data=s,t}function zi(e){if(e.size<2)return;let t=M(e.data,!0),n=new Uint8Array(e.data.subarray(t.length+1));return{key:e.type,info:t,data:n.buffer}}function Bi(e){if(e.size<2)return;if(e.type===`TXXX`){let t=1,n=M(e.data.subarray(t),!0);t+=n.length+1;let r=M(e.data.subarray(t));return{key:e.type,info:n,data:r}}let t=M(e.data.subarray(1));return{key:e.type,info:``,data:t}}function Vi(e){if(e.type===`WXXX`){if(e.size<2)return;let t=1,n=M(e.data.subarray(t),!0);t+=n.length+1;let r=M(e.data.subarray(t));return{key:e.type,info:n,data:r}}let t=M(e.data);return{key:e.type,info:``,data:t}}function Hi(e){return e.type===`PRIV`?zi(e):e.type[0]===`W`?Vi(e):e.type===`APIC`?Ri(e):Bi(e)}function Ui(e){let t=String.fromCharCode(e[0],e[1],e[2],e[3]),n=vi(e,4);return{type:t,size:n,data:e.subarray(10,10+n)}}var Wi=10,Gi=10;function Ki(e){let t=0,n=[];for(;_i(e,t);){let r=vi(e,t+6);e[t+5]>>6&1&&(t+=Wi),t+=Wi;let i=t+r;for(;t+Gi<i;){let r=Ui(e.subarray(t)),i=Hi(r);i&&n.push(i),t+=r.size+Wi}gi(e,t)&&(t+=Wi)}return n}function qi(e){return e&&e.key===`PRIV`&&e.info===`com.apple.streaming.transportStreamTimestamp`}function Ji(e){if(e.data.byteLength===8){let t=new Uint8Array(e.data),n=t[3]&1,r=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return r/=45,n&&(r+=47721858.84),Math.round(r)}}function Yi(e){let t=Ki(e);for(let e=0;e<t.length;e++){let n=t[e];if(qi(n))return Ji(n)}}var Xi=function(e){return e.audioId3=`org.id3`,e.dateRange=`com.apple.quicktime.HLS`,e.emsg=`https://aomedia.org/emsg/ID3`,e.misbklv=`urn:misb:KLV:bin:1910.1`,e}({});function Zi(e=``,t=9e4){return{type:e,id:-1,pid:-1,inputTimeScale:t,sequenceNumber:-1,samples:[],dropped:0}}var Qi=class{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,n,r){this._id3Track={type:`id3`,id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,n){}demux(e,t){this.cachedData&&=(e=Te(this.cachedData,e),null);let n=yi(e,0),r=n?n.length:0,a,o=this._audioTrack,s=this._id3Track,c=n?Yi(n):void 0,l=e.length;for((this.basePTS===null||this.frameIndex===0&&i(c))&&(this.basePTS=$i(c,t,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),n&&n.length>0&&s.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:n,type:Xi.audioId3,duration:1/0});r<l;){if(this.canParse(e,r)){let t=this.appendFrame(o,e,r);t?(this.frameIndex++,this.lastPTS=t.sample.pts,r+=t.length,a=r):r=l}else Mi(e,r)?(n=yi(e,r),s.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:n,type:Xi.audioId3,duration:1/0}),r+=n.length,a=r):r++;if(r===l&&a!==l){let t=e.slice(a);this.cachedData?this.cachedData=Te(this.cachedData,t):this.cachedData=t}}return{audioTrack:o,videoTrack:Zi(),id3Track:s,textTrack:Zi()}}demuxSampleAes(e,t,n){return Promise.reject(Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){let t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:Zi(),id3Track:this._id3Track,textTrack:Zi()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0}},$i=(e,t,n)=>{if(i(e))return e*90;let r=n?n.baseTime*9e4/n.timescale:0;return t*9e4+r},ea=null,ta=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],na=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],ra=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],ia=[0,1,1,4];function aa(e,t,n,r,i){if(n+24>t.length)return;let a=oa(t,n);if(a&&n+a.frameLength<=t.length){let o=r+i*(a.samplesPerFrame*9e4/a.sampleRate),s={unit:t.subarray(n,n+a.frameLength),pts:o,dts:o};return e.config=[],e.channelCount=a.channelCount,e.samplerate=a.sampleRate,e.samples.push(s),{sample:s,length:a.frameLength,missing:0}}}function oa(e,t){let n=e[t+1]>>3&3,r=e[t+1]>>1&3,i=e[t+2]>>4&15,a=e[t+2]>>2&3;if(n!==1&&i!==0&&i!==15&&a!==3){let o=e[t+2]>>1&1,s=e[t+3]>>6,c=ta[(n===3?3-r:r===3?3:4)*14+i-1]*1e3,l=na[(n===3?0:n===2?1:2)*3+a],u=s===3?1:2,d=ra[n][r],f=ia[r],p=d*8*f,m=Math.floor(d*c/l+o)*f;if(ea===null){let e=(navigator.userAgent||``).match(/Chrome\/(\d+)/i);ea=e?parseInt(e[1]):0}return ea&&ea<=87&&r===2&&c>=224e3&&s===0&&(e[t+3]=e[t+3]|128),{sampleRate:l,channelCount:u,frameLength:m,samplesPerFrame:p}}}function sa(e,t){return e[t]===255&&(e[t+1]&224)==224&&(e[t+1]&6)!=0}function ca(e,t){return t+1<e.length&&sa(e,t)}function la(e,t){return sa(e,t)&&4<=e.length-t}function ua(e,t){if(t+1<e.length&&sa(e,t)){let n=oa(e,t),r=4;n!=null&&n.frameLength&&(r=n.frameLength);let i=t+r;return i===e.length||ca(e,i)}return!1}var da=class extends Qi{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,n,r){super.resetInitSegment(e,t,n,r),this._audioTrack={container:`audio/adts`,type:`audio`,id:2,pid:-1,sequenceNumber:0,segmentCodec:`aac`,samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}}static probe(e,t){if(!e)return!1;let n=yi(e,0)?.length||0;if(ua(e,n))return!1;for(let r=e.length;n<r;n++)if(Di(e,n))return t.log(`ADTS sync word found !`),!0;return!1}canParse(e,t){return Ei(e,t)}appendFrame(e,t,n){Oi(e,this.observer,t,n,e.manifestCodec);let r=ji(e,t,n,this.basePTS,this.frameIndex);if(r&&r.missing===0)return r}},fa=(e,t)=>{let n=0,r=5;t+=r;let i=new Uint32Array(1),a=new Uint32Array(1),o=new Uint8Array(1);for(;r>0;){o[0]=e[t];let s=Math.min(r,8),c=8-s;a[0]=4278190080>>>24+c<<c,i[0]=(o[0]&a[0])>>c,n=n?n<<s|i[0]:i[0],t+=1,r-=s}return n},pa=class extends Qi{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,n,r){super.resetInitSegment(e,t,n,r),this._audioTrack={container:`audio/ac-3`,type:`audio`,id:2,pid:-1,sequenceNumber:0,segmentCodec:`ac3`,samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,n){let r=ma(e,t,n,this.basePTS,this.frameIndex);if(r!==-1)return{sample:e.samples[e.samples.length-1],length:r,missing:0}}static probe(e){if(!e)return!1;let t=yi(e,0);if(!t)return!1;let n=t.length;return e[n]===11&&e[n+1]===119&&Yi(t)!==void 0&&fa(e,n)<16}};function ma(e,t,n,r,i){if(n+8>t.length||t[n]!==11||t[n+1]!==119)return-1;let a=t[n+4]>>6;if(a>=3)return-1;let o=[48e3,44100,32e3][a],s=t[n+4]&63,c=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][s*3+a]*2;if(n+c>t.length)return-1;let l=t[n+6]>>5,u=0;l===2?u+=2:(l&1&&l!==1&&(u+=2),l&4&&(u+=2));let d=(t[n+6]<<8|t[n+7])>>12-u&1,f=[2,1,2,3,3,4,4,5][l]+d,p=t[n+5]>>3,m=t[n+5]&7,h=new Uint8Array([a<<6|p<<1|m>>2,(m&3)<<6|l<<3|d<<2|s>>4,s<<4&224]),g=r+i*(1536/o*9e4),_=t.subarray(n,n+c);return e.config=h,e.channelCount=f,e.samplerate=o,e.samples.push({unit:_,pts:g}),c}var ha=class extends Qi{resetInitSegment(e,t,n,r){super.resetInitSegment(e,t,n,r),this._audioTrack={container:`audio/mpeg`,type:`audio`,id:2,pid:-1,sequenceNumber:0,segmentCodec:`mp3`,samples:[],manifestCodec:t,duration:r,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;let t=yi(e,0),n=t?.length||0;if(t&&e[n]===11&&e[n+1]===119&&Yi(t)!==void 0&&fa(e,n)<=16)return!1;for(let t=e.length;n<t;n++)if(ua(e,n))return O.log(`MPEG Audio sync word found !`),!0;return!1}canParse(e,t){return la(e,t)}appendFrame(e,t,n){if(this.basePTS!==null)return aa(e,t,n,this.basePTS,this.frameIndex)}},ga=/\/emsg[-/]ID3/i,_a=class{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,n,r){let i=this.videoTrack=Zi(`video`,1),a=this.audioTrack=Zi(`audio`,1),o=this.txtTrack=Zi(`text`,1);if(this.id3Track=Zi(`id3`,1),this.timeOffset=0,!(e!=null&&e.byteLength))return;let s=fe(e);if(s.video){let{id:e,timescale:t,codec:n,supplemental:r}=s.video;i.id=e,i.timescale=o.timescale=t,i.codec=n,i.supplemental=r}if(s.audio){let{id:e,timescale:t,codec:n}=s.audio;a.id=e,a.timescale=t,a.codec=n}o.id=se.text,i.sampleDuration=0,i.duration=a.duration=r}resetContiguity(){this.remainderData=null}static probe(e){return ue(e)}demux(e,t){this.timeOffset=t;let n=e,r=this.videoTrack,i=this.txtTrack;if(this.config.progressive){this.remainderData&&(n=Te(this.remainderData,e));let t=we(n);this.remainderData=t.remainder,r.samples=t.valid||new Uint8Array}else r.samples=n;let a=this.extractID3Track(r,t);return i.samples=Ee(t,r),{videoTrack:r,audioTrack:this.audioTrack,id3Track:a,textTrack:this.txtTrack}}flush(){let e=this.timeOffset,t=this.videoTrack,n=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;let r=this.extractID3Track(t,this.timeOffset);return n.samples=Ee(e,t),{videoTrack:t,audioTrack:Zi(),id3Track:r,textTrack:Zi()}}extractID3Track(e,t){let n=this.id3Track;if(e.samples.length){let r=K(e.samples,[`emsg`]);r&&r.forEach(e=>{let r=je(e);if(ga.test(r.schemeIdUri)){let e=va(r,t),i=r.eventDuration===4294967295?1/0:r.eventDuration/r.timeScale;i<=.001&&(i=1/0);let a=r.payload;n.samples.push({data:a,len:a.byteLength,dts:e,pts:e,type:Xi.emsg,duration:i})}else if(this.config.enableEmsgKLVMetadata&&r.schemeIdUri.startsWith(`urn:misb:KLV:bin:1910.1`)){let e=va(r,t);n.samples.push({data:r.payload,len:r.payload.byteLength,dts:e,pts:e,type:Xi.misbklv,duration:1/0})}})}return n}demuxSampleAes(e,t,n){return Promise.reject(Error(`The MP4 demuxer does not support SAMPLE-AES decryption`))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0}};function va(e,t){return i(e.presentationTime)?e.presentationTime/e.timeScale:t+e.presentationTimeDelta/e.timeScale}var ya=class{constructor(e,t,n){this.keyData=void 0,this.decrypter=void 0,this.keyData=n,this.decrypter=new _n(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,un.cbc)}decryptAacSample(e,t,n){let r=e[t].unit;if(r.length<=16)return;let i=r.subarray(16,r.length-r.length%16),a=i.buffer.slice(i.byteOffset,i.byteOffset+i.length);this.decryptBuffer(a).then(i=>{let a=new Uint8Array(i);r.set(a,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,n)}).catch(n)}decryptAacSamples(e,t,n){for(;;t++){if(t>=e.length){n();return}if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,n),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){let t=Math.floor((e.length-48)/160)*16+16,n=new Int8Array(t),r=0;for(let t=32;t<e.length-16;t+=160,r+=16)n.set(e.subarray(t,t+16),r);return n}getAvcDecryptedUnit(e,t){let n=new Uint8Array(t),r=0;for(let t=32;t<e.length-16;t+=160,r+=16)e.set(n.subarray(r,r+16),t);return e}decryptAvcSample(e,t,n,r,i){let a=Ae(i.data),o=this.getAvcEncryptedData(a);this.decryptBuffer(o.buffer).then(o=>{i.data=this.getAvcDecryptedUnit(a,o),this.decrypter.isSync()||this.decryptAvcSamples(e,t,n+1,r)}).catch(r)}decryptAvcSamples(e,t,n,r){if(e instanceof Uint8Array)throw Error(`Cannot decrypt samples of type Uint8Array`);for(;;t++,n=0){if(t>=e.length){r();return}let i=e[t].units;for(;!(n>=i.length);n++){let a=i[n];if(!(a.data.length<=48||a.type!==1&&a.type!==5)&&(this.decryptAvcSample(e,t,n,r,a),!this.decrypter.isSync()))return}}}},ba=class{constructor(){this.VideoSample=null}createVideoSample(e,t,n){return{key:e,frame:!1,pts:t,dts:n,units:[],length:0}}getLastNalUnit(e){var t;let n=this.VideoSample,r;if((!n||n.units.length===0)&&(n=e[e.length-1]),(t=n)!=null&&t.units){let e=n.units;r=e[e.length-1]}return r}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(e.pts===void 0){let n=t.samples,r=n.length;if(r){let t=n[r-1];e.pts=t.pts,e.dts=t.dts}else{t.dropped++;return}}t.samples.push(e)}}parseNALu(e,t,n){let r=t.byteLength,i=e.naluState||0,a=i,o=[],s=0,c,l,u,d=-1,f=0;for(i===-1&&(d=0,f=this.getNALuType(t,0),i=0,s=1);s<r;){if(c=t[s++],!i){i=c?0:1;continue}if(i===1){i=c?0:2;continue}if(!c)i=3;else if(c===1){if(l=s-i-1,d>=0){let e={data:t.subarray(d,l),type:f};o.push(e)}else{let n=this.getLastNalUnit(e.samples);n&&(a&&s<=4-a&&n.state&&(n.data=n.data.subarray(0,n.data.byteLength-a)),l>0&&(n.data=Te(n.data,t.subarray(0,l)),n.state=0))}s<r?(u=this.getNALuType(t,s),d=s,f=u,i=0):i=-1}else i=0}if(d>=0&&i>=0){let e={data:t.subarray(d,r),type:f,state:i};o.push(e)}if(o.length===0){let n=this.getLastNalUnit(e.samples);n&&(n.data=Te(n.data,t))}return e.naluState=i,o}},xa=class{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){let e=this.data,t=this.bytesAvailable,n=e.byteLength-t,r=new Uint8Array(4),i=Math.min(4,t);if(i===0)throw Error(`no bytes available`);r.set(e.subarray(n,n+i)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=i*8,this.bytesAvailable-=i}skipBits(e){let t;e=Math.min(e,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e),n=this.word>>>32-t;if(e>32&&O.error(`Cannot read more than 32 bits at a time`),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else if(this.bytesAvailable>0)this.loadWord();else throw Error(`no bits available`);return t=e-t,t>0&&this.bitsAvailable?n<<t|this.readBits(t):n}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(this.word&2147483648>>>e)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){let e=this.skipLZ();return this.readBits(e+1)-1}readEG(){let e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}},Sa=class extends ba{parsePES(e,t,n,r){let i=this.parseNALu(e,n.data,r),a=this.VideoSample,o,s=!1;n.data=null,a&&i.length&&!e.audFound&&(this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts)),i.forEach(r=>{var i,c;switch(r.type){case 1:{let t=!1;o=!0;let i=r.data;if(s&&i.length>4){let e=this.readSliceType(i);(e===2||e===4||e===7||e===9)&&(t=!0)}if(t){var l;(l=a)!=null&&l.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null)}a||=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts),a.frame=!0,a.key=t;break}case 5:o=!0,(i=a)!=null&&i.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts),a.key=!0,a.frame=!0;break;case 6:o=!0,ke(r.data,1,n.pts,t.samples);break;case 7:{o=!0,s=!0;let t=r.data,n=this.readSPS(t);if(!e.sps||e.width!==n.width||e.height!==n.height||e.pixelRatio?.[0]!==n.pixelRatio[0]||e.pixelRatio?.[1]!==n.pixelRatio[1]){e.width=n.width,e.height=n.height,e.pixelRatio=n.pixelRatio,e.sps=[t];let r=t.subarray(1,4),i=`avc1.`;for(let e=0;e<3;e++){let t=r[e].toString(16);t.length<2&&(t=`0`+t),i+=t}e.codec=i}break}case 8:o=!0,e.pps=[r.data];break;case 9:o=!0,e.audFound=!0,(c=a)!=null&&c.frame&&(this.pushAccessUnit(a,e),a=null),a||=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts);break;case 12:o=!0;break;default:o=!1;break}a&&o&&a.units.push(r)}),r&&a&&(this.pushAccessUnit(a,e),this.VideoSample=null)}getNALuType(e,t){return e[t]&31}readSliceType(e){let t=new xa(e);return t.readUByte(),t.readUEG(),t.readUEG()}skipScalingList(e,t){let n=8,r=8,i;for(let a=0;a<e;a++)r!==0&&(i=t.readEG(),r=(n+i+256)%256),n=r===0?n:r}readSPS(e){let t=new xa(e),n=0,r=0,i=0,a=0,o,s,c,l=t.readUByte.bind(t),u=t.readBits.bind(t),d=t.readUEG.bind(t),f=t.readBoolean.bind(t),p=t.skipBits.bind(t),m=t.skipEG.bind(t),h=t.skipUEG.bind(t),g=this.skipScalingList.bind(this);l();let _=l();if(u(5),p(3),l(),h(),_===100||_===110||_===122||_===244||_===44||_===83||_===86||_===118||_===128){let e=d();if(e===3&&p(1),h(),h(),p(1),f())for(s=e===3?12:8,c=0;c<s;c++)f()&&g(c<6?16:64,t)}h();let v=d();if(v===0)d();else if(v===1)for(p(1),m(),m(),o=d(),c=0;c<o;c++)m();h(),p(1);let y=d(),b=d(),x=u(1);x===0&&p(1),p(1),f()&&(n=d(),r=d(),i=d(),a=d());let S=[1,1];if(f()&&f())switch(l()){case 1:S=[1,1];break;case 2:S=[12,11];break;case 3:S=[10,11];break;case 4:S=[16,11];break;case 5:S=[40,33];break;case 6:S=[24,11];break;case 7:S=[20,11];break;case 8:S=[32,11];break;case 9:S=[80,33];break;case 10:S=[18,11];break;case 11:S=[15,11];break;case 12:S=[64,33];break;case 13:S=[160,99];break;case 14:S=[4,3];break;case 15:S=[3,2];break;case 16:S=[2,1];break;case 255:S=[l()<<8|l(),l()<<8|l()];break}return{width:Math.ceil((y+1)*16-n*2-r*2),height:(2-x)*(b+1)*16-(x?2:4)*(i+a),pixelRatio:S}}},Ca=class extends ba{constructor(...e){super(...e),this.initVPS=null}parsePES(e,t,n,r){let i=this.parseNALu(e,n.data,r),a=this.VideoSample,o,s=!1;n.data=null,a&&i.length&&!e.audFound&&(this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts)),i.forEach(r=>{var i,c;switch(r.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:a||=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts),a.frame=!0,o=!0;break;case 16:case 17:case 18:case 21:if(o=!0,s){var l;(l=a)!=null&&l.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null)}a||=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts),a.key=!0,a.frame=!0;break;case 19:case 20:o=!0,(i=a)!=null&&i.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts),a.key=!0,a.frame=!0;break;case 39:o=!0,ke(r.data,2,n.pts,t.samples);break;case 32:o=!0,e.vps||(typeof e.params!=`object`&&(e.params={}),e.params=h(e.params,this.readVPS(r.data)),this.initVPS=r.data),e.vps=[r.data];break;case 33:if(o=!0,s=!0,e.vps!==void 0&&e.vps[0]!==this.initVPS&&e.sps!==void 0&&!this.matchSPS(e.sps[0],r.data)&&(this.initVPS=e.vps[0],e.sps=e.pps=void 0),!e.sps){let t=this.readSPS(r.data);for(let n in e.width=t.width,e.height=t.height,e.pixelRatio=t.pixelRatio,e.codec=t.codecString,e.sps=[],typeof e.params!=`object`&&(e.params={}),t.params)e.params[n]=t.params[n]}this.pushParameterSet(e.sps,r.data,e.vps),a||=this.VideoSample=this.createVideoSample(!0,n.pts,n.dts),a.key=!0;break;case 34:if(o=!0,typeof e.params==`object`){if(!e.pps){e.pps=[];let t=this.readPPS(r.data);for(let n in t)e.params[n]=t[n]}this.pushParameterSet(e.pps,r.data,e.vps)}break;case 35:o=!0,e.audFound=!0,(c=a)!=null&&c.frame&&(this.pushAccessUnit(a,e),a=null),a||=this.VideoSample=this.createVideoSample(!1,n.pts,n.dts);break;default:o=!1;break}a&&o&&a.units.push(r)}),r&&a&&(this.pushAccessUnit(a,e),this.VideoSample=null)}pushParameterSet(e,t,n){(n&&n[0]===this.initVPS||!n&&!e.length)&&e.push(t)}getNALuType(e,t){return(e[t]&126)>>>1}ebsp2rbsp(e){let t=new Uint8Array(e.byteLength),n=0;for(let r=0;r<e.byteLength;r++)r>=2&&e[r]===3&&e[r-1]===0&&e[r-2]===0||(t[n]=e[r],n++);return new Uint8Array(t.buffer,0,n)}pushAccessUnit(e,t){super.pushAccessUnit(e,t),this.initVPS&&=null}readVPS(e){let t=new xa(e);t.readUByte(),t.readUByte(),t.readBits(4),t.skipBits(2),t.readBits(6);let n=t.readBits(3),r=t.readBoolean();return{numTemporalLayers:n+1,temporalIdNested:r}}readSPS(e){let t=new xa(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.readBits(4);let n=t.readBits(3);t.readBoolean();let r=t.readBits(2),i=t.readBoolean(),a=t.readBits(5),o=t.readUByte(),s=t.readUByte(),c=t.readUByte(),l=t.readUByte(),u=t.readUByte(),d=t.readUByte(),f=t.readUByte(),p=t.readUByte(),m=t.readUByte(),h=t.readUByte(),g=t.readUByte(),_=[],v=[];for(let e=0;e<n;e++)_.push(t.readBoolean()),v.push(t.readBoolean());if(n>0)for(let e=n;e<8;e++)t.readBits(2);for(let e=0;e<n;e++)_[e]&&(t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte()),v[e]&&t.readUByte();t.readUEG();let y=t.readUEG();y==3&&t.skipBits(1);let b=t.readUEG(),x=t.readUEG(),S=t.readBoolean(),C=0,w=0,T=0,E=0;S&&(C+=t.readUEG(),w+=t.readUEG(),T+=t.readUEG(),E+=t.readUEG());let D=t.readUEG(),O=t.readUEG(),k=t.readUEG(),A=t.readBoolean();for(let e=A?0:n;e<=n;e++)t.skipUEG(),t.skipUEG(),t.skipUEG();if(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.readBoolean()&&t.readBoolean())for(let e=0;e<4;e++)for(let n=0;n<(e===3?2:6);n++)if(!t.readBoolean())t.readUEG();else{let n=Math.min(64,1<<4+(e<<1));e>1&&t.readEG();for(let e=0;e<n;e++)t.readEG()}t.readBoolean(),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.skipUEG(),t.skipUEG(),t.readBoolean());let j=t.readUEG(),M=0;for(let e=0;e<j;e++){let n=!1;if(e!==0&&(n=t.readBoolean()),n){e===j&&t.readUEG(),t.readBoolean(),t.readUEG();let n=0;for(let e=0;e<=M;e++){let e=t.readBoolean(),r=!1;e||(r=t.readBoolean()),(e||r)&&n++}M=n}else{let e=t.readUEG(),n=t.readUEG();M=e+n;for(let n=0;n<e;n++)t.readUEG(),t.readBoolean();for(let e=0;e<n;e++)t.readUEG(),t.readBoolean()}}if(t.readBoolean()){let e=t.readUEG();for(let n=0;n<e;n++){for(let e=0;e<k+4;e++)t.readBits(1);t.readBits(1)}}let N=0,P=1,F=1,I=!0,L=1,R=0;t.readBoolean(),t.readBoolean();let z=!1;if(t.readBoolean()){if(t.readBoolean()){let e=t.readUByte();e>0&&e<16?(P=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2][e-1],F=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1][e-1]):e===255&&(P=t.readBits(16),F=t.readBits(16))}if(t.readBoolean()&&t.readBoolean(),t.readBoolean()&&(t.readBits(3),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.readUByte(),t.readUByte())),t.readBoolean()&&(t.readUEG(),t.readUEG()),t.readBoolean(),t.readBoolean(),t.readBoolean(),z=t.readBoolean(),z&&(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG()),t.readBoolean()&&(L=t.readBits(32),R=t.readBits(32),t.readBoolean()&&t.readUEG(),t.readBoolean())){let e=t.readBoolean(),r=t.readBoolean(),i=!1;(e||r)&&(i=t.readBoolean(),i&&(t.readUByte(),t.readBits(5),t.readBoolean(),t.readBits(5)),t.readBits(4),t.readBits(4),i&&t.readBits(4),t.readBits(5),t.readBits(5),t.readBits(5));for(let a=0;a<=n;a++){I=t.readBoolean();let n=I||t.readBoolean(),a=!1;n?t.readEG():a=t.readBoolean();let o=a?1:t.readUEG()+1;if(e)for(let e=0;e<o;e++)t.readUEG(),t.readUEG(),i&&(t.readUEG(),t.readUEG()),t.skipBits(1);if(r)for(let e=0;e<o;e++)t.readUEG(),t.readUEG(),i&&(t.readUEG(),t.readUEG()),t.skipBits(1)}}t.readBoolean()&&(t.readBoolean(),t.readBoolean(),t.readBoolean(),N=t.readUEG())}let B=b,V=x;if(S){let e=1,t=1;y===1?e=t=2:y==2&&(e=2),B=b-e*w-e*C,V=x-t*E-t*T}let ee=r?[`A`,`B`,`C`][r]:``,H=o<<24|s<<16|c<<8|l,te=0;for(let e=0;e<32;e++)te=(te|(H>>e&1)<<31-e)>>>0;let ne=te.toString(16);return a===1&&ne===`2`&&(ne=`6`),{codecString:`hvc1.${ee}${a}.${ne}.${i?`H`:`L`}${g}.B0`,params:{general_tier_flag:i,general_profile_idc:a,general_profile_space:r,general_profile_compatibility_flags:[o,s,c,l],general_constraint_indicator_flags:[u,d,f,p,m,h],general_level_idc:g,bit_depth:D+8,bit_depth_luma_minus8:D,bit_depth_chroma_minus8:O,min_spatial_segmentation_idc:N,chroma_format_idc:y,frame_rate:{fixed:I,fps:R/L}},width:B,height:V,pixelRatio:[P,F]}}readPPS(e){let t=new xa(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.skipUEG(),t.skipUEG(),t.skipBits(2),t.skipBits(3),t.skipBits(2),t.skipUEG(),t.skipUEG(),t.skipEG(),t.skipBits(2),t.readBoolean()&&t.skipUEG(),t.skipEG(),t.skipEG(),t.skipBits(4);let n=t.readBoolean(),r=t.readBoolean(),i=1;return r&&n?i=0:r?i=3:n&&(i=2),{parallelismType:i}}matchSPS(e,t){return String.fromCharCode.apply(null,e).substr(3)===String.fromCharCode.apply(null,t).substr(3)}},wa=188,Ta=class e{constructor(e,t,n,r){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=n,this.logger=r,this.videoParser=null}static probe(t,n){let r=e.syncOffset(t);return r>0&&n.warn(`MPEG2-TS detected but first sync word found @ offset ${r}`),r!==-1}static syncOffset(e){let t=e.length,n=Math.min(wa*5,t-wa)+1,r=0;for(;r<n;){let i=!1,a=-1,o=0;for(let s=r;s<t;s+=wa)if(e[s]===71&&(t-s===wa||e[s+wa]===71)){if(o++,a===-1&&(a=s,a!==0&&(n=Math.min(a+wa*99,e.length-wa)+1)),i||=Ea(e,s)===0,i&&o>1&&(a===0&&o>2||s+wa>n))return a}else if(o)return-1;else break;r++}return-1}static createTrack(e,t){return{container:e===`video`||e===`audio`?`video/mp2t`:void 0,type:e,id:se[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e===`audio`?t:void 0}}resetInitSegment(t,n,r,i){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=e.createTrack(`video`),this._videoTrack.duration=i,this._audioTrack=e.createTrack(`audio`,i),this._id3Track=e.createTrack(`id3`),this._txtTrack=e.createTrack(`text`),this._audioTrack.segmentCodec=`aac`,this.videoParser=null,this.aacOverFlow=null,this.remainderData=null,this.audioCodec=n,this.videoCodec=r}resetTimeStamp(){}resetContiguity(){let{_audioTrack:e,_videoTrack:t,_id3Track:n}=this;e&&(e.pesData=null),t&&(t.pesData=null),n&&(n.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(t,n,r=!1,i=!1){r||(this.sampleAes=null);let a,o=this._videoTrack,s=this._audioTrack,c=this._id3Track,l=this._txtTrack,u=o.pid,d=o.pesData,f=s.pid,p=c.pid,m=s.pesData,h=c.pesData,g=null,_=this.pmtParsed,v=this._pmtId,y=t.length;if(this.remainderData&&=(t=Te(this.remainderData,t),y=t.length,null),y<wa&&!i)return this.remainderData=t,{audioTrack:s,videoTrack:o,id3Track:c,textTrack:l};let b=Math.max(0,e.syncOffset(t));y-=(y-b)%wa,y<t.byteLength&&!i&&(this.remainderData=new Uint8Array(t.buffer,y,t.buffer.byteLength-y));let x=0;for(let e=b;e<y;e+=wa)if(t[e]===71){let n=!!(t[e+1]&64),i=Ea(t,e),y=(t[e+3]&48)>>4,x;if(y>1){if(x=e+5+t[e+4],x===e+wa)continue}else x=e+4;switch(i){case u:n&&(d&&(a=ja(d,this.logger))&&(this.readyVideoParser(o.segmentCodec),this.videoParser!==null&&this.videoParser.parsePES(o,l,a,!1)),d={data:[],size:0}),d&&(d.data.push(t.subarray(x,e+wa)),d.size+=e+wa-x);break;case f:if(n){if(m&&(a=ja(m,this.logger)))switch(s.segmentCodec){case`aac`:this.parseAACPES(s,a);break;case`mp3`:this.parseMPEGPES(s,a);break;case`ac3`:this.parseAC3PES(s,a);break}m={data:[],size:0}}m&&(m.data.push(t.subarray(x,e+wa)),m.size+=e+wa-x);break;case p:n&&(h&&(a=ja(h,this.logger))&&this.parseID3PES(c,a),h={data:[],size:0}),h&&(h.data.push(t.subarray(x,e+wa)),h.size+=e+wa-x);break;case 0:n&&(x+=t[x]+1),v=this._pmtId=Da(t,x);break;case v:{n&&(x+=t[x]+1);let i=Oa(t,x,this.typeSupported,r,this.observer,this.logger);u=i.videoPid,u>0&&(o.pid=u,o.segmentCodec=i.segmentVideoCodec),f=i.audioPid,f>0&&(s.pid=f,s.segmentCodec=i.segmentAudioCodec),p=i.id3Pid,p>0&&(c.pid=p),g!==null&&!_&&(this.logger.warn(`MPEG-TS PMT found at ${e} after unknown PID '${g}'. Backtracking to sync byte @${b} to parse all TS packets.`),g=null,e=b-188),_=this.pmtParsed=!0;break}case 17:case 8191:break;default:g=i;break}}else x++;x>0&&ka(this.observer,Error(`Found ${x} TS packet/s that do not start with 0x47`),void 0,this.logger),o.pesData=d,s.pesData=m,c.pesData=h;let S={audioTrack:s,videoTrack:o,id3Track:c,textTrack:l};return i&&this.extractRemainingSamples(S),S}flush(){let{remainderData:e}=this;this.remainderData=null;let t;return t=e?this.demux(e,-1,!1,!0):{videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){let{audioTrack:t,videoTrack:n,id3Track:r,textTrack:i}=e,a=n.pesData,o=t.pesData,s=r.pesData,c;if(a&&(c=ja(a,this.logger))?(this.readyVideoParser(n.segmentCodec),this.videoParser!==null&&(this.videoParser.parsePES(n,i,c,!0),n.pesData=null)):n.pesData=a,o&&(c=ja(o,this.logger))){switch(t.segmentCodec){case`aac`:this.parseAACPES(t,c);break;case`mp3`:this.parseMPEGPES(t,c);break;case`ac3`:this.parseAC3PES(t,c);break}t.pesData=null}else o!=null&&o.size&&this.logger.log(`last AAC PES packet truncated,might overlap between fragments`),t.pesData=o;s&&(c=ja(s,this.logger))?(this.parseID3PES(r,c),r.pesData=null):r.pesData=s}demuxSampleAes(e,t,n){let r=this.demux(e,n,!0,!this.config.progressive),i=this.sampleAes=new ya(this.observer,this.config,t);return this.decrypt(r,i)}readyVideoParser(e){this.videoParser===null&&(e===`avc`?this.videoParser=new Sa:e===`hevc`&&(this.videoParser=new Ca))}decrypt(e,t){return new Promise(n=>{let{audioTrack:r,videoTrack:i}=e;r.samples&&r.segmentCodec===`aac`?t.decryptAacSamples(r.samples,0,()=>{i.samples?t.decryptAvcSamples(i.samples,0,0,()=>{n(e)}):n(e)}):i.samples&&t.decryptAvcSamples(i.samples,0,0,()=>{n(e)})})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0}parseAACPES(e,t){let n=0,r=this.aacOverFlow,i=t.data;if(r){this.aacOverFlow=null;let t=r.missing,a=r.sample.unit.byteLength;if(t===-1)i=Te(r.sample.unit,i);else{let o=a-t;r.sample.unit.set(i.subarray(0,t),o),e.samples.push(r.sample),n=r.missing}}let a,o;for(a=n,o=i.length;a<o-1&&!Ti(i,a);a++);if(a!==n){let e,t=a<o-1;if(e=t?`AAC PES did not start with ADTS header,offset:${a}`:`No ADTS header found in AAC PES`,ka(this.observer,Error(e),t,this.logger),!t)return}Oi(e,this.observer,i,a,this.audioCodec);let s;if(t.pts!==void 0)s=t.pts;else if(r){let t=ki(e.samplerate);s=r.sample.pts+t}else{this.logger.warn(`[tsdemuxer]: AAC PES unknown PTS`);return}let c=0,l;for(;a<o;)if(l=ji(e,i,a,s,c),a+=l.length,l.missing){this.aacOverFlow=l;break}else for(c++;a<o-1&&!Ti(i,a);a++);}parseMPEGPES(e,t){let n=t.data,r=n.length,i=0,a=0,o=t.pts;if(o===void 0){this.logger.warn(`[tsdemuxer]: MPEG PES unknown PTS`);return}for(;a<r;)if(ca(n,a)){let t=aa(e,n,a,o,i);if(t)a+=t.length,i++;else break}else a++}parseAC3PES(e,t){{let n=t.data,r=t.pts;if(r===void 0){this.logger.warn(`[tsdemuxer]: AC3 PES unknown PTS`);return}let i=n.length,a=0,o=0,s;for(;o<i&&(s=ma(e,n,o,r,a++))>0;)o+=s}}parseID3PES(e,t){if(t.pts===void 0){this.logger.warn(`[tsdemuxer]: ID3 PES unknown PTS`);return}let n=h({},t,{type:this._videoTrack?Xi.emsg:Xi.audioId3,duration:1/0});e.samples.push(n)}};function Ea(e,t){return((e[t+1]&31)<<8)+e[t+2]}function Da(e,t){return(e[t+10]&31)<<8|e[t+11]}function Oa(e,t,n,r,i,a){let o={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:`avc`,segmentAudioCodec:`aac`},s=(e[t+1]&15)<<8|e[t+2],c=t+3+s-4,l=(e[t+10]&15)<<8|e[t+11];for(t+=12+l;t<c;){let s=Ea(e,t),c=(e[t+3]&15)<<8|e[t+4];switch(e[t]){case 207:if(!r){Aa(`ADTS AAC`,a);break}case 15:o.audioPid===-1&&(o.audioPid=s);break;case 21:o.id3Pid===-1&&(o.id3Pid=s);break;case 219:if(!r){Aa(`H.264`,a);break}case 27:o.videoPid===-1&&(o.videoPid=s);break;case 3:case 4:!n.mpeg&&!n.mp3?a.log(`MPEG audio found, not supported in this browser`):o.audioPid===-1&&(o.audioPid=s,o.segmentAudioCodec=`mp3`);break;case 193:if(!r){Aa(`AC-3`,a);break}case 129:n.ac3?o.audioPid===-1&&(o.audioPid=s,o.segmentAudioCodec=`ac3`):a.log(`AC-3 audio found, not supported in this browser`);break;case 6:if(o.audioPid===-1&&c>0){let r=t+5,i=c;for(;i>2;){switch(e[r]){case 106:n.ac3===!0?(o.audioPid=s,o.segmentAudioCodec=`ac3`):a.log(`AC-3 audio found, not supported in this browser for now`);break}let t=e[r+1]+2;r+=t,i-=t}}break;case 194:case 135:return ka(i,Error(`Unsupported EC-3 in M2TS found`),void 0,a),o;case 36:o.videoPid===-1&&(o.videoPid=s,o.segmentVideoCodec=`hevc`,a.log(`HEVC in M2TS found`));break}t+=c+5}return o}function ka(e,t,n,r){r.warn(`parsing error: ${t.message}`),e.emit(l.ERROR,l.ERROR,{type:s.MEDIA_ERROR,details:c.FRAG_PARSING_ERROR,fatal:!1,levelRetry:n,error:t,reason:t.message})}function Aa(e,t){t.log(`${e} with AES-128-CBC encryption found in unencrypted stream`)}function ja(e,t){let n=0,r,i,a,o,s,c=e.data;if(!e||e.size===0)return null;for(;c[0].length<19&&c.length>1;)c[0]=Te(c[0],c[1]),c.splice(1,1);if(r=c[0],(r[0]<<16)+(r[1]<<8)+r[2]===1){if(i=(r[4]<<8)+r[5],i&&i>e.size-6)return null;let l=r[7];l&192&&(o=(r[9]&14)*536870912+(r[10]&255)*4194304+(r[11]&254)*16384+(r[12]&255)*128+(r[13]&254)/2,l&64?(s=(r[14]&14)*536870912+(r[15]&255)*4194304+(r[16]&254)*16384+(r[17]&255)*128+(r[18]&254)/2,o-s>60*9e4&&(t.warn(`${Math.round((o-s)/9e4)}s delta between PTS and DTS, align them`),o=s)):s=o),a=r[8];let u=a+9;if(e.size<=u)return null;e.size-=u;let d=new Uint8Array(e.size);for(let e=0,t=c.length;e<t;e++){r=c[e];let t=r.byteLength;if(u)if(u>t){u-=t;continue}else r=r.subarray(u),t-=u,u=0;d.set(r,n),n+=t}return i&&(i-=a+3),{data:d,pts:o,dts:s,len:i}}return null}var Ma=class{static getSilentFrame(e,t){switch(e){case`mp4a.40.2`:if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2||t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}},Na=2**32-1,Pa=class e{static init(){e.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let t;for(t in e.types)e.types.hasOwnProperty(t)&&(e.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);e.HDLR_TYPES={video:new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),audio:new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0])};let n=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]);e.STTS=e.STSC=e.STCO=new Uint8Array([0,0,0,0,0,0,0,0]),e.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),e.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),e.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),e.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);let r=new Uint8Array([105,115,111,109]),i=new Uint8Array([97,118,99,49]),a=new Uint8Array([0,0,0,1]);e.FTYP=e.box(e.types.ftyp,r,a,r,i),e.DINF=e.box(e.types.dinf,e.box(e.types.dref,n))}static box(e,...t){let n=8,r=t.length,i=r;for(;r--;)n+=t[r].byteLength;let a=new Uint8Array(n);for(a[0]=n>>24&255,a[1]=n>>16&255,a[2]=n>>8&255,a[3]=n&255,a.set(e,4),r=0,n=8;r<i;r++)a.set(t[r],n),n+=t[r].byteLength;return a}static hdlr(t){return e.box(e.types.hdlr,e.HDLR_TYPES[t])}static mdat(t){return e.box(e.types.mdat,t)}static mdhd(t,n){n*=t;let r=Math.floor(n/(Na+1)),i=Math.floor(n%(Na+1));return e.box(e.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24,r>>16&255,r>>8&255,r&255,i>>24,i>>16&255,i>>8&255,i&255,85,196,0,0]))}static mdia(t){return e.box(e.types.mdia,e.mdhd(t.timescale||0,t.duration||0),e.hdlr(t.type),e.minf(t))}static mfhd(t){return e.box(e.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]))}static minf(t){return t.type===`audio`?e.box(e.types.minf,e.box(e.types.smhd,e.SMHD),e.DINF,e.stbl(t)):e.box(e.types.minf,e.box(e.types.vmhd,e.VMHD),e.DINF,e.stbl(t))}static moof(t,n,r){return e.box(e.types.moof,e.mfhd(t),e.traf(r,n))}static moov(t){let n=t.length,r=[];for(;n--;)r[n]=e.trak(t[n]);return e.box.apply(null,[e.types.moov,e.mvhd(t[0].timescale||0,t[0].duration||0)].concat(r,e.mvex(t)))}static mvex(t){let n=t.length,r=[];for(;n--;)r[n]=e.trex(t[n]);return e.box.apply(null,[e.types.mvex,...r])}static mvhd(t,n){n*=t;let r=Math.floor(n/(Na+1)),i=Math.floor(n%(Na+1)),a=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24,r>>16&255,r>>8&255,r&255,i>>24,i>>16&255,i>>8&255,i&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.box(e.types.mvhd,a)}static sdtp(t){let n=t.samples||[],r=new Uint8Array(4+n.length),i,a;for(i=0;i<n.length;i++)a=n[i].flags,r[i+4]=a.dependsOn<<4|a.isDependedOn<<2|a.hasRedundancy;return e.box(e.types.sdtp,r)}static stbl(t){return e.box(e.types.stbl,e.stsd(t),e.box(e.types.stts,e.STTS),e.box(e.types.stsc,e.STSC),e.box(e.types.stsz,e.STSZ),e.box(e.types.stco,e.STCO))}static avc1(t){let n=[],r=[],i,a,o;for(i=0;i<t.sps.length;i++)a=t.sps[i],o=a.byteLength,n.push(o>>>8&255),n.push(o&255),n=n.concat(Array.prototype.slice.call(a));for(i=0;i<t.pps.length;i++)a=t.pps[i],o=a.byteLength,r.push(o>>>8&255),r.push(o&255),r=r.concat(Array.prototype.slice.call(a));let s=e.box(e.types.avcC,new Uint8Array([1,n[3],n[4],n[5],255,224|t.sps.length].concat(n,[t.pps.length],r))),c=t.width,l=t.height,u=t.pixelRatio[0],d=t.pixelRatio[1];return e.box(e.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,c>>8&255,c&255,l>>8&255,l&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),s,e.box(e.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),e.box(e.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,u&255,d>>24,d>>16&255,d>>8&255,d&255])))}static esds(e){let t=e.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...t,6,1,2])}static audioStsd(e){let t=e.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount||0,0,16,0,0,0,0,t>>8&255,t&255,0,0])}static mp4a(t){return e.box(e.types.mp4a,e.audioStsd(t),e.box(e.types.esds,e.esds(t)))}static mp3(t){return e.box(e.types[`.mp3`],e.audioStsd(t))}static ac3(t){return e.box(e.types[`ac-3`],e.audioStsd(t),e.box(e.types.dac3,t.config))}static stsd(t){let{segmentCodec:n}=t;if(t.type===`audio`){if(n===`aac`)return e.box(e.types.stsd,e.STSD,e.mp4a(t));if(n===`ac3`&&t.config)return e.box(e.types.stsd,e.STSD,e.ac3(t));if(n===`mp3`&&t.codec===`mp3`)return e.box(e.types.stsd,e.STSD,e.mp3(t))}else if(t.pps&&t.sps){if(n===`avc`)return e.box(e.types.stsd,e.STSD,e.avc1(t));if(n===`hevc`&&t.vps)return e.box(e.types.stsd,e.STSD,e.hvc1(t))}else throw Error(`video track missing pps or sps`);throw Error(`unsupported ${t.type} segment codec (${n}/${t.codec})`)}static tkhd(t){let n=t.id,r=(t.duration||0)*(t.timescale||0),i=t.width||0,a=t.height||0,o=Math.floor(r/(Na+1)),s=Math.floor(r%(Na+1));return e.box(e.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,n>>24&255,n>>16&255,n>>8&255,n&255,0,0,0,0,o>>24,o>>16&255,o>>8&255,o&255,s>>24,s>>16&255,s>>8&255,s&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,i>>8&255,i&255,0,0,a>>8&255,a&255,0,0]))}static traf(t,n){let r=e.sdtp(t),i=t.id,a=Math.floor(n/(Na+1)),o=Math.floor(n%(Na+1));return e.box(e.types.traf,e.box(e.types.tfhd,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,i&255])),e.box(e.types.tfdt,new Uint8Array([1,0,0,0,a>>24,a>>16&255,a>>8&255,a&255,o>>24,o>>16&255,o>>8&255,o&255])),e.trun(t,r.length+16+20+8+16+8+8),r)}static trak(t){return t.duration=t.duration||4294967295,e.box(e.types.trak,e.tkhd(t),e.mdia(t))}static trex(t){let n=t.id;return e.box(e.types.trex,new Uint8Array([0,0,0,0,n>>24,n>>16&255,n>>8&255,n&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(t,n){let r=t.samples||[],i=r.length,a=12+16*i,o=new Uint8Array(a),s,c,l,u,d,f;for(n+=8+a,o.set([t.type===`video`?1:0,0,15,1,i>>>24&255,i>>>16&255,i>>>8&255,i&255,n>>>24&255,n>>>16&255,n>>>8&255,n&255],0),s=0;s<i;s++)c=r[s],l=c.duration,u=c.size,d=c.flags,f=c.cts,o.set([l>>>24&255,l>>>16&255,l>>>8&255,l&255,u>>>24&255,u>>>16&255,u>>>8&255,u&255,d.isLeading<<2|d.dependsOn,d.isDependedOn<<6|d.hasRedundancy<<4|d.paddingValue<<1|d.isNonSync,d.degradPrio&61440,d.degradPrio&15,f>>>24&255,f>>>16&255,f>>>8&255,f&255],12+16*s);return e.box(e.types.trun,o)}static initSegment(t){e.types||e.init();let n=e.moov(t);return Te(e.FTYP,n)}static hvc1(t){let n=t.params,r=[t.vps,t.sps,t.pps],i=new Uint8Array([1,n.general_profile_space<<6|(n.general_tier_flag?32:0)|n.general_profile_idc,n.general_profile_compatibility_flags[0],n.general_profile_compatibility_flags[1],n.general_profile_compatibility_flags[2],n.general_profile_compatibility_flags[3],n.general_constraint_indicator_flags[0],n.general_constraint_indicator_flags[1],n.general_constraint_indicator_flags[2],n.general_constraint_indicator_flags[3],n.general_constraint_indicator_flags[4],n.general_constraint_indicator_flags[5],n.general_level_idc,240|n.min_spatial_segmentation_idc>>8,255&n.min_spatial_segmentation_idc,252|n.parallelismType,252|n.chroma_format_idc,248|n.bit_depth_luma_minus8,248|n.bit_depth_chroma_minus8,0,parseInt(n.frame_rate.fps),3|n.temporal_id_nested<<2|n.num_temporal_layers<<3|(n.frame_rate.fixed?64:0),r.length]),a=i.length;for(let e=0;e<r.length;e+=1){a+=3;for(let t=0;t<r[e].length;t+=1)a+=2+r[e][t].length}let o=new Uint8Array(a);o.set(i,0),a=i.length;let s=r.length-1;for(let e=0;e<r.length;e+=1){o.set(new Uint8Array([32+e|(e===s?128:0),0,r[e].length]),a),a+=3;for(let t=0;t<r[e].length;t+=1)o.set(new Uint8Array([r[e][t].length>>8,r[e][t].length&255]),a),a+=2,o.set(r[e][t],a),a+=r[e][t].length}let c=e.box(e.types.hvcC,o),l=t.width,u=t.height,d=t.pixelRatio[0],f=t.pixelRatio[1];return e.box(e.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,l&255,u>>8&255,u&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),c,e.box(e.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),e.box(e.types.pasp,new Uint8Array([d>>24,d>>16&255,d>>8&255,d&255,f>>24,f>>16&255,f>>8&255,f&255])))}};Pa.types=void 0,Pa.HDLR_TYPES=void 0,Pa.STTS=void 0,Pa.STSC=void 0,Pa.STCO=void 0,Pa.STSZ=void 0,Pa.VMHD=void 0,Pa.SMHD=void 0,Pa.STSD=void 0,Pa.FTYP=void 0,Pa.DINF=void 0;var Fa=9e4;function Ia(e,t,n=1,r=!1){let i=e*t*n;return r?Math.round(i):i}function La(e,t,n=1,r=!1){return Ia(e,t,1/n,r)}function Ra(e,t=!1){return Ia(e,1e3,1/Fa,t)}function za(e,t=1){return Ia(e,Fa,1/t)}function Ba(e){let{baseTime:t,timescale:n,trackId:r}=e;return`${t/n} (${t}/${n}) trackId: ${r}`}var Va=10*1e3,Ha=1024,Ua=1152,Wa=1536,Ga=null,Ka=null;function qa(e,t,n,r){return{duration:t,size:n,cts:r,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:e?2:1,isNonSync:e?0:1}}}var Ja=class extends b{constructor(e,t,n,r){if(super(`mp4-remuxer`,r),this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextVideoTs=null,this.nextAudioTs=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=n,this.ISGenerated=!1,Ga===null){let e=(navigator.userAgent||``).match(/Chrome\/(\d+)/i);Ga=e?parseInt(e[1]):0}if(Ka===null){let e=navigator.userAgent.match(/Safari\/(\d+)/i);Ka=e?parseInt(e[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){let t=this._initPTS;(!t||!e||e.trackId!==t.trackId||e.baseTime!==t.baseTime||e.timescale!==t.timescale)&&this.log(`Reset initPTS: ${t&&Ba(t)} > ${e&&Ba(e)}`),this._initPTS=this._initDTS=e}resetNextTimestamp(){this.log(`reset next timestamp`),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){this.log(`ISGenerated flag reset`),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1,n=e[0].pts,r=e.reduce((e,r)=>{let i=r.pts,a=i-e;return a<-4294967296&&(t=!0,i=Ya(i,n),a=i-e),a>0?e:i},n);return t&&this.debug(`PTS rollover detected`),r}remux(e,t,n,r,i,a,o,s){let c,l,u,f,p,m,h=i,g=i,_=e.pid>-1,v=t.pid>-1,y=t.samples.length,b=e.samples.length>0,x=o&&y>0||y>1;if((!_||b)&&(!v||x)||this.ISGenerated||o){if(this.ISGenerated){let e=this.videoTrackConfig;(e&&(t.width!==e.width||t.height!==e.height||t.pixelRatio?.[0]!==e.pixelRatio?.[0]||t.pixelRatio?.[1]!==e.pixelRatio?.[1])||!e&&x||this.nextAudioTs===null&&b)&&this.resetInitSegment()}this.ISGenerated||(u=this.generateIS(e,t,i,a));let n=this.isVideoContiguous,r=-1,o;if(x&&(r=Xa(t.samples),!n&&this.config.forceKeyFrameOnDiscontinuity))if(m=!0,r>0){this.warn(`Dropped ${r} out of ${y} video samples due to a missing keyframe`);let e=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(r),t.dropped+=r,g+=(t.samples[0].pts-e)/t.inputTimeScale,o=g}else r===-1&&(this.warn(`No keyframe found out of ${y} video samples`),m=!1);if(this.ISGenerated){if(b&&x){let n=this.getVideoStartPts(t.samples),r=(Ya(e.samples[0].pts,n)-n)/t.inputTimeScale;h+=Math.max(0,r),g+=Math.max(0,-r)}if(b){if(e.samplerate||(this.warn(`regenerate InitSegment as audio detected`),u=this.generateIS(e,t,i,a)),l=this.remuxAudio(e,h,this.isAudioContiguous,a,v||x||s===d.AUDIO?g:void 0),x){let r=l?l.endPTS-l.startPTS:0;t.inputTimeScale||(this.warn(`regenerate InitSegment as video detected`),u=this.generateIS(e,t,i,a)),c=this.remuxVideo(t,g,n,r)}}else x&&(c=this.remuxVideo(t,g,n,0));c&&(c.firstKeyFrame=r,c.independent=r!==-1,c.firstKeyFramePTS=o)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(n.samples.length&&(p=Za(n,i,this._initPTS,this._initDTS)),r.samples.length&&(f=Qa(r,i,this._initPTS))),{audio:l,video:c,initSegment:u,independent:m,text:f,id3:p}}computeInitPts(e,t,n,r){let i=Math.round(n*t),a=Ya(e,i);if(a<i+t)for(this.log(`Adjusting PTS for rollover in timeline near ${(i-a)/t} ${r}`);a<i+t;)a+=8589934592;return a-i}generateIS(e,t,n,r){let i=e.samples,a=t.samples,o=this.typeSupported,s={},c=this._initPTS,l=!c||r,u=`audio/mp4`,d,f,p,m=-1;if(l&&(d=f=1/0),e.config&&i.length){switch(e.timescale=e.samplerate,e.segmentCodec){case`mp3`:o.mpeg?(u=`audio/mpeg`,e.codec=``):o.mp3&&(e.codec=`mp3`);break;case`ac3`:e.codec=`ac-3`;break}s.audio={id:`audio`,container:u,codec:e.codec,initSegment:e.segmentCodec===`mp3`&&o.mpeg?new Uint8Array:Pa.initSegment([e]),metadata:{channelCount:e.channelCount}},l&&(m=e.id,p=e.inputTimeScale,!c||p!==c.timescale?d=f=this.computeInitPts(i[0].pts,p,n,`audio`):l=!1)}if(t.sps&&t.pps&&a.length){if(t.timescale=t.inputTimeScale,s.video={id:`main`,container:`video/mp4`,codec:t.codec,initSegment:Pa.initSegment([t]),metadata:{width:t.width,height:t.height}},l)if(m=t.id,p=t.inputTimeScale,!c||p!==c.timescale){let e=this.getVideoStartPts(a),t=Ya(a[0].dts,e),r=this.computeInitPts(t,p,n,`video`),i=this.computeInitPts(e,p,n,`video`);f=Math.min(f,r),d=Math.min(d,i)}else l=!1;this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(s).length)return this.ISGenerated=!0,l?(c&&this.warn(`Timestamps at playlist time: ${r?``:`~`}${n} ${d/p} != initPTS: ${c.baseTime/c.timescale} (${c.baseTime}/${c.timescale}) trackId: ${c.trackId}`),this.log(`Found initPTS at playlist time: ${n} offset: ${d/p} (${d}/${p}) trackId: ${m}`),this._initPTS={baseTime:d,timescale:p,trackId:m},this._initDTS={baseTime:f,timescale:p,trackId:m}):d=p=void 0,{tracks:s,initPTS:d,timescale:p,trackId:m}}remuxVideo(e,t,n,r){let i=e.inputTimeScale,a=e.samples,o=[],u=a.length,d=this._initPTS,f=d.baseTime*i/d.timescale,p=this.nextVideoTs,m=8,g=this.videoSampleDuration,_,v,y=1/0,b=-1/0,x=!1;if(!n||p===null){let e=f+t*i,r=a[0].pts-Ya(a[0].dts,a[0].pts);Ga&&p!==null&&Math.abs(e-r-(p+f))<15e3?n=!0:p=e-r-f}let S=p+f;for(let e=0;e<u;e++){let t=a[e];t.pts=Ya(t.pts,S),t.dts=Ya(t.dts,S),t.dts<a[e>0?e-1:e].dts&&(x=!0)}x&&a.sort(function(e,t){let n=e.dts-t.dts,r=e.pts-t.pts;return n||r}),_=a[0].dts,v=a[a.length-1].dts;let C=v-_,w=C?Math.round(C/(u-1)):g||e.inputTimeScale/30;if(n){let n=_-S,r=n>w,i=n<-1;if((r||i)&&(r?this.warn(`${(e.segmentCodec||``).toUpperCase()}: ${Ra(n,!0)} ms (${n}dts) hole between fragments detected at ${t.toFixed(3)}`):this.warn(`${(e.segmentCodec||``).toUpperCase()}: ${Ra(-n,!0)} ms (${n}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!i||S>=a[0].pts||Ga)){_=S;let e=a[0].pts-n;if(r)a[0].dts=_,a[0].pts=e;else{let t=!0;for(let r=0;r<a.length&&!(a[r].dts>e&&t);r++){let e=a[r].pts;if(a[r].dts-=n,a[r].pts-=n,r<a.length-1){let n=a[r+1].pts;t=n<=a[r].pts==n<=e}}}this.log(`Video: Initial PTS/DTS adjusted: ${Ra(e,!0)}/${Ra(_,!0)}, delta: ${Ra(n,!0)} ms`)}}_=Math.max(0,_);let T=0,E=0,D=_;for(let e=0;e<u;e++){let t=a[e],n=t.units,r=n.length,i=0;for(let e=0;e<r;e++)i+=n[e].data.length;E+=i,T+=r,t.length=i,t.dts<D?(t.dts=D,D+=w/4|0||1):D=t.dts,y=Math.min(t.pts,y),b=Math.max(t.pts,b)}v=a[u-1].dts;let O=E+4*T+8,k;try{k=new Uint8Array(O)}catch(e){this.observer.emit(l.ERROR,l.ERROR,{type:s.MUX_ERROR,details:c.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:O,reason:`fail allocating video mdat ${O}`});return}let A=new DataView(k.buffer);A.setUint32(0,O),k.set(Pa.types.mdat,4);let j=!1,M=1/0,N=1/0,P=-1/0,F=-1/0;for(let e=0;e<u;e++){let t=a[e],n=t.units,s=0;for(let e=0,t=n.length;e<t;e++){let t=n[e],r=t.data,i=t.data.byteLength;A.setUint32(m,i),m+=4,k.set(r,m),m+=i,s+=4+i}let c;if(e<u-1)g=a[e+1].dts-t.dts,c=a[e+1].pts-t.pts;else{let n=this.config,o=e>0?t.dts-a[e-1].dts:w;if(c=e>0?t.pts-a[e-1].pts:w,n.stretchShortVideoTrack&&this.nextAudioTs!==null){let e=Math.floor(n.maxBufferHole*i),a=(r?y+r*i:this.nextAudioTs+f)-t.pts;a>e?(g=a-o,g<0?g=o:j=!0,this.log(`It is approximately ${a/90} ms to the next segment; using duration ${g/90} ms for the last video frame.`)):g=o}else g=o}let l=Math.round(t.pts-t.dts);M=Math.min(M,g),P=Math.max(P,g),N=Math.min(N,c),F=Math.max(F,c),o.push(qa(t.key,g,s,l))}if(o.length){if(Ga){if(Ga<70){let e=o[0].flags;e.dependsOn=2,e.isNonSync=0}}else if(Ka&&F-N<P-M&&w/P<.025&&o[0].cts===0){this.warn(`Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.`);let e=_;for(let t=0,n=o.length;t<n;t++){let r=e+o[t].duration,i=e+o[t].cts;if(t<n-1){let e=r+o[t+1].cts;o[t].duration=e-i}else o[t].duration=t?o[t-1].duration:w;o[t].cts=0,e=r}}}g=j||!g?w:g,this.nextVideoTs=p=v+g-f,this.videoSampleDuration=g,this.isVideoContiguous=!0;let I={data1:Pa.moof(e.sequenceNumber++,_,h(e,{samples:o})),data2:k,startPTS:(y-f)/i,endPTS:(b+g-f)/i,startDTS:(_-f)/i,endDTS:p/i,type:`video`,hasAudio:!1,hasVideo:!0,nb:o.length,dropped:e.dropped};return e.samples=[],e.dropped=0,I}getSamplesPerFrame(e){switch(e.segmentCodec){case`mp3`:return Ua;case`ac3`:return Wa;default:return Ha}}remuxAudio(e,t,n,r,i){let a=e.inputTimeScale,o=a/(e.samplerate?e.samplerate:a),u=this.getSamplesPerFrame(e),d=u*o,f=this._initPTS,p=e.segmentCodec===`mp3`&&this.typeSupported.mpeg,m=[],g=i!==void 0,_=e.samples,v=p?0:8,y=this.nextAudioTs||-1,b=f.baseTime*a/f.timescale,x=b+t*a;if(this.isAudioContiguous=n||=_.length&&y>0&&(r&&Math.abs(x-(y+b))<9e3||Math.abs(Ya(_[0].pts,x)-(y+b))<20*d),_.forEach(function(e){e.pts=Ya(e.pts,x)}),!n||y<0){let e=_.length;if(_=_.filter(e=>e.pts>=0),e!==_.length&&this.warn(`Removed ${_.length-e} of ${e} samples (initPTS ${b} / ${a})`),!_.length)return;y=i===0?0:r&&!g?Math.max(0,x-b):_[0].pts-b}if(e.segmentCodec===`aac`){let t=this.config.maxAudioFramesDrift;for(let n=0,r=y+b;n<_.length;n++){let i=_[n],o=i.pts,s=o-r,c=Math.abs(1e3*s/a);if(s<=-t*d&&g)n===0&&(this.warn(`Audio frame @ ${(o/a).toFixed(3)}s overlaps marker by ${Math.round(1e3*s/a)} ms.`),this.nextAudioTs=y=o-b,r=o);else if(s>=t*d&&c<Va&&g){let t=Math.round(s/d);for(r=o-t*d;r<0&&t&&d;)t--,r+=d;n===0&&(this.nextAudioTs=y=r-b),this.warn(`Injecting ${t} audio frames @ ${((r-b)/a).toFixed(3)}s due to ${Math.round(1e3*s/a)} ms gap.`);for(let a=0;a<t;a++){let t=Ma.getSilentFrame(e.parsedCodec||e.manifestCodec||e.codec,e.channelCount);t||=(this.log(`Unable to get silent frame for given audio codec; duplicating last frame instead.`),i.unit.subarray()),_.splice(n,0,{unit:t,pts:r}),r+=d,n++}}i.pts=r,r+=d}}let S=null,C=null,w,T=0,E=_.length;for(;E--;)T+=_[E].unit.byteLength;for(let t=0,r=_.length;t<r;t++){let r=_[t],i=r.unit,a=r.pts;if(C!==null){let e=m[t-1];e.duration=Math.round((a-C)/o)}else if(n&&e.segmentCodec===`aac`&&(a=y+b),S=a,T>0){T+=v;try{w=new Uint8Array(T)}catch(e){this.observer.emit(l.ERROR,l.ERROR,{type:s.MUX_ERROR,details:c.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:T,reason:`fail allocating audio mdat ${T}`});return}p||(new DataView(w.buffer).setUint32(0,T),w.set(Pa.types.mdat,4))}else return;w.set(i,v);let d=i.byteLength;v+=d,m.push(qa(!0,u,d,0)),C=a}let D=m.length;if(!D)return;let O=m[m.length-1];y=C-b,this.nextAudioTs=y+o*O.duration;let k=p?new Uint8Array:Pa.moof(e.sequenceNumber++,S/o,h({},e,{samples:m}));e.samples=[];let A=(S-b)/a,j=this.nextAudioTs/a,M={data1:k,data2:w,startPTS:A,endPTS:j,startDTS:A,endDTS:j,type:`audio`,hasAudio:!0,hasVideo:!1,nb:D};return this.isAudioContiguous=!0,M}};function Ya(e,t){let n;if(t===null)return e;for(n=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=n;return e}function Xa(e){for(let t=0;t<e.length;t++)if(e[t].key)return t;return-1}function Za(e,t,n,r){let i=e.samples.length;if(!i)return;let a=e.inputTimeScale;for(let o=0;o<i;o++){let i=e.samples[o];i.pts=Ya(i.pts-n.baseTime*a/n.timescale,t*a)/a,i.dts=Ya(i.dts-r.baseTime*a/r.timescale,t*a)/a}let o=e.samples;return e.samples=[],{samples:o}}function Qa(e,t,n){let r=e.samples.length;if(!r)return;let i=e.inputTimeScale;for(let a=0;a<r;a++){let r=e.samples[a];r.pts=Ya(r.pts-n.baseTime*i/n.timescale,t*i)/i}e.samples.sort((e,t)=>e.pts-t.pts);let a=e.samples;return e.samples=[],{samples:a}}var $a=class extends b{constructor(e,t,n,r){super(`passthrough-remuxer`,r),this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.isVideoContiguous=!1}destroy(){}resetTimeStamp(e){this.lastEndTime=null;let t=this.initPTS;t&&e&&t.baseTime===e.baseTime&&t.timescale===e.timescale||(this.initPTS=e)}resetNextTimestamp(){this.isVideoContiguous=!1,this.lastEndTime=null}resetInitSegment(e,t,n,r){this.audioCodec=t,this.videoCodec=n,this.generateInitSegment(e,r),this.emitInitSegment=!0}generateInitSegment(e,t){let{audioCodec:n,videoCodec:r}=this;if(!(e!=null&&e.byteLength)){this.initTracks=void 0,this.initData=void 0;return}let{audio:i,video:a}=this.initData=fe(e);if(t)ye(e,t);else{let e=i||a;e!=null&&e.encrypted&&this.warn(`Init segment with encrypted track with has no key ("${e.codec}")!`)}i&&(n=no(i,V.AUDIO,this)),a&&(r=no(a,V.VIDEO,this));let o={};i&&a?o.audiovideo={container:`video/mp4`,codec:n+`,`+r,supplemental:a.supplemental,encrypted:a.encrypted,initSegment:e,id:`main`}:i?o.audio={container:`audio/mp4`,codec:n,encrypted:i.encrypted,initSegment:e,id:`audio`}:a?o.video={container:`video/mp4`,codec:r,supplemental:a.supplemental,encrypted:a.encrypted,initSegment:e,id:`main`}:this.warn(`initSegment does not contain moov or trak boxes.`),this.initTracks=o}remux(e,t,n,r,a,o){var s,c;let{initPTS:l,lastEndTime:u}=this,d={audio:void 0,video:void 0,text:r,id3:n,initSegment:void 0};i(u)||(u=this.lastEndTime=a||0);let f=t.samples;if(!f.length)return d;let p={initPTS:void 0,timescale:void 0,trackId:void 0},m=this.initData;if((s=m)!=null&&s.length||(this.generateInitSegment(f),m=this.initData),!((c=m)!=null&&c.length))return this.warn(`Failed to generate initSegment.`),d;this.emitInitSegment&&=(p.tracks=this.initTracks,!1);let h=Ce(f,m,this),g=m.audio?h[m.audio.id]:null,_=m.video?h[m.video.id]:null,v=eo(_,1/0),y=eo(g,1/0),b=eo(_,0,!0),x=eo(g,0,!0),S=a,C=0,w=g&&(!_||!l&&y<v||l&&l.trackId===m.audio.id),T=w?g:_;if(T){let e=T.timescale,t=T.start-a*e,n=w?m.audio.id:m.video.id;S=T.start/e,C=w?x-y:b-v,(o||!l)&&(to(l,S,a,C)||e!==l.timescale)&&(l&&this.warn(`Timestamps at playlist time: ${o?``:`~`}${a} ${t/e} != initPTS: ${l.baseTime/l.timescale} (${l.baseTime}/${l.timescale}) trackId: ${l.trackId}`),this.log(`Found initPTS at playlist time: ${a} offset: ${S-a} (${t}/${e}) trackId: ${n}`),l=null,p.initPTS=t,p.timescale=e,p.trackId=n)}else this.warn(`No audio or video samples found for initPTS at playlist time: ${a}`);l?(p.initPTS=l.baseTime,p.timescale=l.timescale,p.trackId=l.trackId):((!p.timescale||p.trackId===void 0||p.initPTS===void 0)&&(this.warn(`Could not set initPTS`),p.initPTS=S,p.timescale=1,p.trackId=-1),this.initPTS=l={baseTime:p.initPTS,timescale:p.timescale,trackId:p.trackId});let E=S-l.baseTime/l.timescale,D=E+C;C>0?this.lastEndTime=D:(this.warn(`Duration parsed from mp4 should be greater than zero`),this.resetNextTimestamp());let O=!!m.audio,k=!!m.video,A=``;O&&(A+=`audio`),k&&(A+=`video`);let j=(m.audio?m.audio.encrypted:!1)||(m.video?m.video.encrypted:!1),M={data1:f,startPTS:E,startDTS:E,endPTS:D,endDTS:D,type:A,hasAudio:O,hasVideo:k,nb:1,dropped:0,encrypted:j};d.audio=O&&!k?M:void 0,d.video=k?M:void 0;let N=_?.sampleCount;if(N){let e=_.keyFrameIndex,t=e!==-1;M.nb=N,M.dropped=e===0||this.isVideoContiguous?0:t?e:N,M.independent=t,M.firstKeyFrame=e,t&&_.keyFrameStart&&(M.firstKeyFramePTS=(_.keyFrameStart-l.baseTime)/l.timescale),this.isVideoContiguous||(d.independent=t),this.isVideoContiguous||=t,M.dropped&&this.warn(`fmp4 does not start with IDR: firstIDR ${e}/${N} dropped: ${M.dropped} start: ${M.firstKeyFramePTS||`NA`}`)}return d.initSegment=p,d.id3=Za(n,a,l,l),r.samples.length&&(d.text=Qa(r,a,l)),d}};function eo(e,t,n=!1){return e?.start===void 0?t:(e.start+(n?e.duration:0))/e.timescale}function to(e,t,n,r){if(e===null)return!0;let i=Math.max(r,1),a=t-e.baseTime/e.timescale;return Math.abs(a-n)>i}function no(e,t,n){let r=e.codec;return r&&r.length>4?r:t===V.AUDIO?r===`ec-3`||r===`ac-3`||r===`alac`?r:r===`fLaC`||r===`Opus`?qe(r,!1):(n.warn(`Unhandled audio codec "${r}" in mp4 MAP`),r||`mp4a`):(n.warn(`Unhandled video codec "${r}" in mp4 MAP`),r||`avc1`)}var ro;try{ro=self.performance.now.bind(self.performance)}catch{ro=Date.now}var io=[{demux:_a,remux:$a},{demux:Ta,remux:Ja},{demux:da,remux:Ja},{demux:ha,remux:Ja}];io.splice(2,0,{demux:pa,remux:Ja});var ao=class{constructor(e,t,n,r,i,a){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=n,this.id=i,this.logger=a}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,n,r){let i=n.transmuxing;i.executeStart=ro();let a=new Uint8Array(e),{currentTransmuxState:o,transmuxConfig:u}=this;r&&(this.currentTransmuxState=r);let{contiguous:d,discontinuity:f,trackSwitch:p,accurateTimeOffset:m,timeOffset:h,initSegmentChange:g}=r||o,{audioCodec:_,videoCodec:v,defaultInitPts:y,duration:b,initSegmentData:x}=u,S=oo(a,t);if(S&&Wn(S.method)){let e=this.getDecrypter(),t=Gn(S.method);if(e.isSync()){let r=e.softwareDecrypt(a,S.key.buffer,S.iv.buffer,t);if(n.part>-1){let t=e.flush();r=t&&t.buffer}if(!r)return i.executeEnd=ro(),so(n);a=new Uint8Array(r)}else return this.asyncResult=!0,this.decryptionPromise=e.webCryptoDecrypt(a,S.key.buffer,S.iv.buffer,t).then(e=>{let t=this.push(e,null,n);return this.decryptionPromise=null,t}),this.decryptionPromise}let C=this.needsProbing(f,p);if(C){let e=this.configureTransmuxer(a);if(e)return this.logger.warn(`[transmuxer] ${e.message}`),this.observer.emit(l.ERROR,l.ERROR,{type:s.MEDIA_ERROR,details:c.FRAG_PARSING_ERROR,fatal:!1,error:e,reason:e.message}),i.executeEnd=ro(),so(n)}(f||p||g||C)&&this.resetInitSegment(x,_,v,b,t),(f||g||C)&&this.resetInitialTimestamp(y),d||this.resetContiguity();let w=this.transmux(a,S,h,m,n);this.asyncResult=co(w);let T=this.currentTransmuxState;return T.contiguous=!0,T.discontinuity=!1,T.trackSwitch=!1,i.executeEnd=ro(),w}flush(e){let t=e.transmuxing;t.executeStart=ro();let{decrypter:n,currentTransmuxState:r,decryptionPromise:i}=this;if(i)return this.asyncResult=!0,i.then(()=>this.flush(e));let a=[],{timeOffset:o}=r;if(n){let t=n.flush();t&&a.push(this.push(t.buffer,null,e))}let{demuxer:s,remuxer:c}=this;if(!s||!c){t.executeEnd=ro();let n=[so(e)];return this.asyncResult?Promise.resolve(n):n}let l=s.flush(o);return co(l)?(this.asyncResult=!0,l.then(t=>(this.flushRemux(a,t,e),a))):(this.flushRemux(a,l,e),this.asyncResult?Promise.resolve(a):a)}flushRemux(e,t,n){let{audioTrack:r,videoTrack:i,id3Track:a,textTrack:o}=t,{accurateTimeOffset:s,timeOffset:c}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${n.sn}${n.part>-1?` part: `+n.part:``} of ${this.id===d.MAIN?`level`:`track`} ${n.level}`);let l=this.remuxer.remux(r,i,a,o,c,s,!0,this.id);e.push({remuxResult:l,chunkMeta:n}),n.transmuxing.executeEnd=ro()}resetInitialTimestamp(e){let{demuxer:t,remuxer:n}=this;!t||!n||(t.resetTimeStamp(e),n.resetTimeStamp(e))}resetContiguity(){let{demuxer:e,remuxer:t}=this;!e||!t||(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,n,r,i){let{demuxer:a,remuxer:o}=this;!a||!o||(a.resetInitSegment(e,t,n,r),o.resetInitSegment(e,t,n,i))}destroy(){this.demuxer&&=(this.demuxer.destroy(),void 0),this.remuxer&&=(this.remuxer.destroy(),void 0)}transmux(e,t,n,r,i){let a;return a=t&&t.method===`SAMPLE-AES`?this.transmuxSampleAes(e,t,n,r,i):this.transmuxUnencrypted(e,n,r,i),a}transmuxUnencrypted(e,t,n,r){let{audioTrack:i,videoTrack:a,id3Track:o,textTrack:s}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(i,a,o,s,t,n,!1,this.id),chunkMeta:r}}transmuxSampleAes(e,t,n,r,i){return this.demuxer.demuxSampleAes(e,t,n).then(e=>({remuxResult:this.remuxer.remux(e.audioTrack,e.videoTrack,e.id3Track,e.textTrack,n,r,!1,this.id),chunkMeta:i}))}configureTransmuxer(e){let{config:t,observer:n,typeSupported:r}=this,i;for(let t=0,n=io.length;t<n;t++){var a;if((a=io[t].demux)!=null&&a.probe(e,this.logger)){i=io[t];break}}if(!i)return Error(`Failed to find demuxer by probing fragment data`);let o=this.demuxer,s=this.remuxer,c=i.remux,l=i.demux;(!s||!(s instanceof c))&&(this.remuxer=new c(n,t,r,this.logger)),(!o||!(o instanceof l))&&(this.demuxer=new l(n,t,r,this.logger),this.probe=l.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||=this.decrypter=new _n(this.config),e}};function oo(e,t){let n=null;return e.byteLength>0&&t?.key!=null&&t.iv!==null&&t.method!=null&&(n=t),n}var so=e=>({remuxResult:{},chunkMeta:e});function co(e){return`then`in e&&e.then instanceof Function}var lo=class{constructor(e,t,n,r,i){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=n,this.duration=r,this.defaultInitPts=i||null}},uo=class{constructor(e,t,n,r,i,a){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=n,this.trackSwitch=r,this.timeOffset=i,this.initSegmentChange=a}},fo=0,po=class{constructor(e,t,n,r){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=fo++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=e=>{let t=e.data,n=this.hls;if(!(!n||!(t!=null&&t.event)||t.instanceNo!==this.instanceNo))switch(t.event){case`init`:{let e=this.workerContext?.objectURL;e&&self.URL.revokeObjectURL(e);break}case`transmuxComplete`:this.handleTransmuxComplete(t.data);break;case`flush`:this.onFlush(t.data);break;case`workerLog`:n.logger[t.data.logType]&&n.logger[t.data.logType](t.data.message);break;default:t.data=t.data||{},t.data.frag=this.frag,t.data.part=this.part,t.data.id=this.id,n.trigger(t.event,t.data);break}},this.onWorkerError=e=>{if(!this.hls)return;let t=Error(`${e.message}  (${e.filename}:${e.lineno})`);this.hls.config.enableWorker=!1,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(l.ERROR,{type:s.OTHER_ERROR,details:c.INTERNAL_EXCEPTION,fatal:!1,event:`demuxerWorker`,error:t})};let i=e.config;this.hls=e,this.id=t,this.useWorker=!!i.enableWorker,this.onTransmuxComplete=n,this.onFlush=r;let a=(e,t)=>{t||={},t.frag=this.frag||void 0,e===l.ERROR&&(t=t,t.parent=this.id,t.part=this.part,this.error=t.error),this.hls.trigger(e,t)};this.observer=new li,this.observer.on(l.FRAG_DECRYPTED,a),this.observer.on(l.ERROR,a);let o=$e(i.preferManagedMediaSource);if(this.useWorker&&typeof Worker<`u`){let n=this.hls.logger;if(i.workerPath||fi()){try{i.workerPath?(n.log(`loading Web Worker ${i.workerPath} for "${t}"`),this.workerContext=mi(i.workerPath)):(n.log(`injecting Web Worker for "${t}"`),this.workerContext=pi());let{worker:e}=this.workerContext;e.addEventListener(`message`,this.onWorkerMessage),e.addEventListener(`error`,this.onWorkerError),e.postMessage({instanceNo:this.instanceNo,cmd:`init`,typeSupported:o,id:t,config:q(i)})}catch(r){n.warn(`Error setting up "${t}" Web Worker, fallback to inline`,r),this.terminateWorker(),this.error=null,this.transmuxer=new ao(this.observer,o,i,``,t,e.logger)}return}}this.transmuxer=new ao(this.observer,o,i,``,t,e.logger)}reset(){if(this.frag=null,this.part=null,this.workerContext){let e=this.instanceNo;this.instanceNo=fo++;let t=this.hls.config,n=$e(t.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:`reset`,resetNo:e,typeSupported:n,id:this.id,config:q(t)})}}terminateWorker(){if(this.workerContext){let{worker:e}=this.workerContext;this.workerContext=null,e.removeEventListener(`message`,this.onWorkerMessage),e.removeEventListener(`error`,this.onWorkerError),hi(this.hls.config.workerPath)}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{let e=this.transmuxer;e&&(e.destroy(),this.transmuxer=null)}let e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null}push(e,t,n,r,i,a,o,s,c,l){c.transmuxing.start=self.performance.now();let{instanceNo:u,transmuxer:f}=this,p=a?a.start:i.start,m=i.decryptdata,h=this.frag,g=!(h&&i.cc===h.cc),_=!(h&&c.level===h.level),v=h?c.sn-h.sn:-1,y=this.part?c.part-this.part.index:-1,b=v===0&&c.id>1&&c.id===h?.stats.chunkCount,x=!_&&(v===1||v===0&&(y===1||b&&y<=0)),S=self.performance.now();(_||v||i.stats.parsing.start===0)&&(i.stats.parsing.start=S),a&&(y||!x)&&(a.stats.parsing.start=S);let C=!(h&&i.initSegment?.url===h.initSegment?.url),w=new uo(g,x,s,_,p,C);if(!x||g||C){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${i.type} sn: ${c.sn}${c.part>-1?` part: `+c.part:``} ${this.id===d.MAIN?`level`:`track`}: ${c.level} id: ${c.id}
        discontinuity: ${g}
        trackSwitch: ${_}
        contiguous: ${x}
        accurateTimeOffset: ${s}
        timeOffset: ${p}
        initSegmentChange: ${C}`);let e=new lo(n,r,t,o,l);this.configureTransmuxer(e)}if(this.frag=i,this.part=a,this.workerContext)this.workerContext.worker.postMessage({instanceNo:u,cmd:`demux`,data:e,decryptdata:m,chunkMeta:c,state:w},e instanceof ArrayBuffer?[e]:[]);else if(f){let t=f.push(e,m,c,w);co(t)?t.then(e=>{this.handleTransmuxComplete(e)}).catch(e=>{this.transmuxerError(e,c,`transmuxer-interface push error`)}):this.handleTransmuxComplete(t)}}flush(e){e.transmuxing.start=self.performance.now();let{instanceNo:t,transmuxer:n}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:t,cmd:`flush`,chunkMeta:e});else if(n){let t=n.flush(e);co(t)?t.then(t=>{this.handleFlushResult(t,e)}).catch(t=>{this.transmuxerError(t,e,`transmuxer-interface flush error`)}):this.handleFlushResult(t,e)}}transmuxerError(e,t,n){this.hls&&(this.error=e,this.hls.trigger(l.ERROR,{type:s.MEDIA_ERROR,details:c.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:e,err:e,reason:n}))}handleFlushResult(e,t){e.forEach(e=>{this.handleTransmuxComplete(e)}),this.onFlush(t)}configureTransmuxer(e){let{instanceNo:t,transmuxer:n}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:t,cmd:`configure`,config:e}):n&&n.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}},mo=100,ho=class extends ni{constructor(e,t,n){super(e,t,n,`audio-stream-controller`,d.AUDIO),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=!1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem()}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null}registerListeners(){super.registerListeners();let{hls:e}=this;e.on(l.LEVEL_LOADED,this.onLevelLoaded,this),e.on(l.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(l.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(l.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(l.BUFFER_RESET,this.onBufferReset,this),e.on(l.BUFFER_CREATED,this.onBufferCreated,this),e.on(l.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(l.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(l.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(l.FRAG_LOADING,this.onFragLoading,this),e.on(l.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){let{hls:e}=this;e&&(super.unregisterListeners(),e.off(l.LEVEL_LOADED,this.onLevelLoaded,this),e.off(l.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(l.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(l.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(l.BUFFER_RESET,this.onBufferReset,this),e.off(l.BUFFER_CREATED,this.onBufferCreated,this),e.off(l.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(l.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(l.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(l.FRAG_LOADING,this.onFragLoading,this),e.off(l.FRAG_BUFFERED,this.onFragBuffered,this))}onInitPtsFound(e,{frag:t,id:n,initPTS:r,timescale:i,trackId:a}){if(n===d.MAIN){let e=t.cc,n=this.fragCurrent;if(this.initPTS[e]={baseTime:r,timescale:i,trackId:a},this.log(`InitPTS for cc: ${e} found from main: ${r/i} (${r}/${i}) trackId: ${a}`),this.mainAnchor=t,this.state===X.WAITING_INIT_PTS){let n=this.waitingData;(!n&&!this.loadingParts||n&&n.frag.cc!==e)&&this.syncWithAnchor(t,n?.frag)}else !this.hls.hasEnoughToStart&&n&&n.cc!==e?(n.abortRequests(),this.syncWithAnchor(t,n)):this.state===X.IDLE&&this.tick()}}getLoadPosition(){return!this.startFragRequested&&this.nextLoadPosition>=0?this.nextLoadPosition:super.getLoadPosition()}syncWithAnchor(e,t){let n=this.mainFragLoading?.frag||null;if(t&&n?.cc===t.cc)return;let r=(n||e).cc,i=Wt(this.getLevelDetails(),r,this.getLoadPosition());i&&(this.log(`Syncing with main frag at ${i.start} cc ${i.cc}`),this.startFragRequested=!1,this.nextLoadPosition=i.start,this.resetLoadingState(),this.state===X.IDLE&&this.doTickIdle())}startLoad(e,t){if(!this.levels){this.startPosition=e,this.state=X.STOPPED;return}let n=this.lastCurrentTime;this.stopLoad(),this.setInterval(mo),n>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @${n.toFixed(3)}`),e=n,this.state=X.IDLE):this.state=X.WAITING_TRACK,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}doTick(){switch(this.state){case X.IDLE:this.doTickIdle();break;case X.WAITING_TRACK:{let{levels:e,trackId:t}=this,n=e?.[t],r=n?.details;if(r&&!this.waitForLive(n)){if(this.waitForCdnTuneIn(r))break;this.state=X.WAITING_INIT_PTS}break}case X.FRAG_LOADING_WAITING_RETRY:this.checkRetryDate();break;case X.WAITING_INIT_PTS:{let e=this.waitingData;if(e){let{frag:t,part:n,cache:r,complete:i}=e,a=this.mainAnchor;if(this.initPTS[t.cc]!==void 0){this.waitingData=null,this.state=X.FRAG_LOADING;let e={frag:t,part:n,payload:r.flush().buffer,networkDetails:null};this._handleFragmentLoadProgress(e),i&&super._handleFragmentLoadComplete(e)}else a&&a.cc!==e.frag.cc&&this.syncWithAnchor(a,e.frag)}else this.state=X.IDLE}}this.onTickEnd()}resetLoadingState(){let e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null),super.resetLoadingState()}onTickEnd(){let{media:e}=this;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){let{hls:e,levels:t,media:n,trackId:r}=this,i=e.config;if(!this.buffering||!n&&!this.primaryPrefetch&&(this.startFragRequested||!i.startFragPrefetch)||!(t!=null&&t[r]))return;let a=t[r],o=a.details;if(!o||this.waitForLive(a)||this.waitForCdnTuneIn(o)){this.state=X.WAITING_TRACK,this.startFragRequested=!1;return}let s=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&s&&(this.bufferFlushed=!1,this.afterBufferFlushed(s,V.AUDIO,d.AUDIO));let c=this.getFwdBufferInfo(s,d.AUDIO);if(c===null)return;if(!this.switchingTrack&&this._streamEnded(c,o)){e.trigger(l.BUFFER_EOS,{type:`audio`}),this.state=X.ENDED;return}let u=c.len,f=e.maxBufferLength,p=o.fragments,m=p[0].start,h=this.getLoadPosition(),g=this.flushing?h:c.end;if(this.switchingTrack&&n){let e=h;o.PTSKnown&&e<m&&(c.end>m||c.nextStart)&&(this.log(`Alt audio track ahead of main track, seek to start of alt audio track`),n.currentTime=m+.05)}if(u>=f&&!this.switchingTrack&&g<p[p.length-1].start)return;let _=this.getNextFragment(g,o);if(_&&this.isLoopLoading(_,g)&&(_=this.getNextFragmentLoopLoading(_,o,c,d.MAIN,f)),!_){this.bufferFlushed=!0;return}let v=this.mainFragLoading?.frag||null;if(!this.audioOnly&&this.startFragRequested&&v&&H(_)&&!_.endList&&(!o.live||!this.loadingParts&&g<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(v)===an.OK&&(this.mainFragLoading=v=null),v&&H(v))){if(_.start>v.end){let e=this.fragmentTracker.getFragAtPos(g,d.MAIN);e&&e.end>v.end&&(v=e,this.mainFragLoading={frag:e,targetBufferTime:null})}if(_.start>v.end)return}this.loadFragment(_,a,g)}onMediaDetaching(e,t){this.bufferFlushed=this.flushing=!1,super.onMediaDetaching(e,t)}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(e=>new yt(e))}onAudioTrackSwitching(e,t){let n=!!t.url;this.trackId=t.id;let{fragCurrent:r}=this;r&&(r.abortRequests(),this.removeUnbufferedFrags(r.start)),this.resetLoadingState(),n?(this.switchingTrack=t,this.flushAudioIfNeeded(t),this.state!==X.STOPPED&&(this.setInterval(mo),this.state=X.IDLE,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=t,this.clearInterval())}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1}onLevelLoaded(e,t){this.mainDetails=t.details;let n=this.cachedTrackLoadedData;n&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(l.AUDIO_TRACK_LOADED,n))}onAudioTrackLoaded(e,t){var n;let{levels:r}=this,{details:i,id:a,groupId:o,track:s}=t;if(!r){this.warn(`Audio tracks reset while loading track ${a} "${s.name}" of "${o}"`);return}let c=this.mainDetails;if(!c||i.endCC>c.endCC||c.expired){this.cachedTrackLoadedData=t,this.state!==X.STOPPED&&(this.state=X.WAITING_TRACK);return}this.cachedTrackLoadedData=null,this.log(`Audio track ${a} "${s.name}" of "${o}" loaded [${i.startSN},${i.endSN}]${i.lastPartSn?`[part-${i.lastPartSn}-${i.lastPartIndex}]`:``},duration:${i.totalduration}`);let u=r[a],d=0;if(i.live||(n=u.details)!=null&&n.live){if(this.checkLiveUpdate(i),i.deltaUpdateFailed)return;u.details&&(d=this.alignPlaylists(i,u.details,this.levelLastLoaded?.details)),i.alignedSliding||(Zr(i,c),i.alignedSliding||Qr(i,c),d=i.fragmentStart)}u.details=i,this.levelLastLoaded=u,this.startFragRequested||this.setStartPosition(c,d),this.hls.trigger(l.AUDIO_TRACK_UPDATED,{details:i,id:a,groupId:t.groupId}),this.state===X.WAITING_TRACK&&!this.waitForCdnTuneIn(i)&&(this.state=X.IDLE),this.tick()}_handleFragmentLoadProgress(e){let t=e.frag,{part:n,payload:r}=e,{config:i,trackId:a,levels:o}=this;if(!o){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${t.sn} of level ${t.level} will not be buffered`);return}let s=o[a];if(!s){this.warn(`Audio track is undefined on fragment load progress`);return}let c=s.details;if(!c){this.warn(`Audio track details undefined on fragment load progress`),this.removeUnbufferedFrags(t.start);return}let l=i.defaultAudioCodec||s.audioCodec||`mp4a.40.2`,u=this.transmuxer;u||=this.transmuxer=new po(this.hls,d.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this));let f=this.initPTS[t.cc],p=t.initSegment?.data;if(f!==void 0){let e=n?n.index:-1,i=e!==-1,a=new Tn(t.level,t.sn,t.stats.chunkCount,r.byteLength,e,i);u.push(r,p,l,``,t,n,c.totalduration,!1,a,f)}else{this.log(`Unknown video PTS for cc ${t.cc}, waiting for video PTS before demuxing audio frag ${t.sn} of [${c.startSN} ,${c.endSN}],track ${a}`);let{cache:e}=this.waitingData=this.waitingData||{frag:t,part:n,cache:new ii,complete:!1};e.push(new Uint8Array(r)),this.state!==X.STOPPED&&(this.state=X.WAITING_INIT_PTS)}}_handleFragmentLoadComplete(e){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=null}onBufferCreated(e,t){this.bufferFlushed=this.flushing=!1;let n=t.tracks.audio;n&&(this.mediaBuffer=n.buffer||null)}onFragLoading(e,t){!this.audioOnly&&t.frag.type===d.MAIN&&H(t.frag)&&(this.mainFragLoading=t,this.state===X.IDLE&&this.tick())}onFragBuffered(e,t){let{frag:n,part:r}=t;if(n.type!==d.AUDIO){!this.audioOnly&&n.type===d.MAIN&&!n.elementaryStreams.video&&!n.elementaryStreams.audiovideo&&(this.audioOnly=!0,this.mainFragLoading=null);return}if(this.fragContextChanged(n)){this.warn(`Fragment ${n.sn}${r?` p: `+r.index:``} of level ${n.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:`false`}`);return}if(H(n)){this.fragPrevious=n;let e=this.switchingTrack;e&&(this.bufferedTrack=e,this.switchingTrack=null,this.hls.trigger(l.AUDIO_TRACK_SWITCHED,_({},e)))}this.fragBufferedComplete(n,r),this.media&&this.tick()}onError(e,t){if(t.fatal){this.state=X.ERROR;return}switch(t.details){case c.FRAG_GAP:case c.FRAG_PARSING_ERROR:case c.FRAG_DECRYPT_ERROR:case c.FRAG_LOAD_ERROR:case c.FRAG_LOAD_TIMEOUT:case c.KEY_LOAD_ERROR:case c.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(d.AUDIO,t);break;case c.AUDIO_TRACK_LOAD_ERROR:case c.AUDIO_TRACK_LOAD_TIMEOUT:case c.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===X.WAITING_TRACK&&t.context?.type===u.AUDIO_TRACK&&(this.state=X.IDLE);break;case c.BUFFER_ADD_CODEC_ERROR:case c.BUFFER_APPEND_ERROR:if(t.parent!==`audio`)return;this.reduceLengthAndFlushBuffer(t)||this.resetLoadingState();break;case c.BUFFER_FULL_ERROR:if(t.parent!==`audio`)return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,1/0,`audio`));break;case c.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onBufferFlushing(e,{type:t}){t!==V.VIDEO&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==V.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===X.ENDED&&(this.state=X.IDLE);let e=this.mediaBuffer||this.media;e&&(this.afterBufferFlushed(e,t,d.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;let n=`audio`,{hls:r}=this,{remuxResult:i,chunkMeta:a}=e,o=this.getCurrentContext(a);if(!o){this.resetWhenMissingContext(a);return}let{frag:s,part:c,level:u}=o,{details:d}=u,{audio:f,text:p,id3:m,initSegment:g}=i;if(this.fragContextChanged(s)||!d){this.fragmentTracker.removeFragment(s);return}if(this.state=X.PARSING,this.switchingTrack&&f&&this.completeAudioSwitch(this.switchingTrack),g!=null&&g.tracks){let e=s.initSegment||s;if(this.unhandledEncryptionError(g,s))return;this._bufferInitSegment(u,g.tracks,e,a),r.trigger(l.FRAG_PARSING_INIT_SEGMENT,{frag:e,id:n,tracks:g.tracks})}if(f){let{startPTS:e,endPTS:t,startDTS:n,endDTS:r}=f;c&&(c.elementaryStreams[V.AUDIO]={startPTS:e,endPTS:t,startDTS:n,endDTS:r}),s.setElementaryStreamInfo(V.AUDIO,e,t,n,r),this.bufferFragmentData(f,s,c,a)}if(m!=null&&(t=m.samples)!=null&&t.length){let e=h({id:n,frag:s,details:d},m);r.trigger(l.FRAG_PARSING_METADATA,e)}if(p){let e=h({id:n,frag:s,details:d},p);r.trigger(l.FRAG_PARSING_USERDATA,e)}}_bufferInitSegment(e,t,n,r){if(this.state!==X.PARSING||(t.video&&delete t.video,t.audiovideo&&delete t.audiovideo,!t.audio))return;let i=t.audio;i.id=d.AUDIO;let a=e.audioCodec;this.log(`Init audio buffer, container:${i.container}, codecs[level/parsed]=[${a}/${i.codec}]`),a&&a.split(`,`).length===1&&(i.levelCodec=a),this.hls.trigger(l.BUFFER_CODECS,t);let o=i.initSegment;if(o!=null&&o.byteLength){let e={type:`audio`,frag:n,part:null,chunkMeta:r,parent:n.type,data:o};this.hls.trigger(l.BUFFER_APPENDING,e)}this.tickImmediate()}loadFragment(e,t,n){let r=this.fragmentTracker.getState(e);if(this.switchingTrack||r===an.NOT_LOADED||r===an.PARTIAL){var i;if(!H(e))this._loadInitSegment(e,t);else if((i=t.details)!=null&&i.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=X.WAITING_INIT_PTS;let n=this.mainDetails;n&&n.fragmentStart!==t.details.fragmentStart&&Qr(t.details,n)}else super.loadFragment(e,t,n)}else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){let{name:t,lang:n,assocLang:r,characteristics:i,audioCodec:a,channels:o}=this.bufferedTrack;At({name:t,lang:n,assocLang:r,characteristics:i,audioCodec:a,channels:o},e,Nt)||(It(e.url,this.hls)?(this.log(`Switching audio track : flushing all audio`),super.flushMainBuffer(0,1/0,`audio`),this.bufferedTrack=null):this.bufferedTrack=e)}}completeAudioSwitch(e){let{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(l.AUDIO_TRACK_SWITCHED,_({},e))}},go=class extends b{constructor(e,t){super(t,e.logger),this.hls=void 0,this.canLoad=!1,this.timer=-1,this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t,n){let r=t?.renditionReports;if(r){let i=-1;for(let n=0;n<r.length;n++){let a=r[n],o;try{o=new self.URL(a.URI,t.url).href}catch(e){this.warn(`Could not construct new URL for Rendition Report: ${e}`),o=a.URI||``}if(o===e){i=n;break}else o===e.substring(0,o.length)&&(i=n)}if(i!==-1){let e=r[i],a=parseInt(e[`LAST-MSN`])||t.lastPartSn,o=parseInt(e[`LAST-PART`])||t.lastPartIndex;if(this.hls.config.lowLatencyMode){let e=Math.min(t.age-t.partTarget,t.targetduration);o>=0&&e>t.partTarget&&(o+=1)}let s=n&&_t(n);return new vt(a,o>=0?o:void 0,s)}}}loadPlaylist(e){this.clearTimer()}loadingPlaylist(e,t){this.clearTimer()}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}getUrlWithDirectives(e,t){if(t)try{return t.addDirectives(e)}catch(e){this.warn(`Could not construct new URL with HLS Delivery Directives: ${e}`)}return e}playlistLoaded(e,t,n){let{details:r,stats:i}=t,a=self.performance.now(),o=i.loading.first?Math.max(0,a-i.loading.first):0;r.advancedDateTime=Date.now()-o;let u=this.hls.config.timelineOffset;if(u!==r.appliedTimelineOffset){let e=Math.max(u||0,0);r.appliedTimelineOffset=e,r.fragments.forEach(t=>{t.setStart(t.playlistOffset+e)})}if(r.live||n!=null&&n.live){let u=`levelInfo`in t?t.levelInfo:t.track;if(r.reloaded(n),n&&r.fragments.length>0){Mr(n,r,this);let e=r.playlistParsingError;if(e){this.warn(e);let n=this.hls;if(!n.config.ignorePlaylistParsingErrors){let{networkDetails:a}=t;n.trigger(l.ERROR,{type:s.NETWORK_ERROR,details:c.LEVEL_PARSING_ERROR,fatal:!1,url:r.url,error:e,reason:e.message,level:t.level||void 0,parent:r.fragments[0]?.type,networkDetails:a,stats:i});return}r.playlistParsingError=null}}r.requestScheduled===-1&&(r.requestScheduled=i.loading.start);let d=this.hls.mainForwardBufferInfo,f=d?d.end-d.len:0,p=zr(r,(r.edge-f)*1e3);if(r.requestScheduled+p<a?r.requestScheduled=a:r.requestScheduled+=p,this.log(`live playlist ${e} ${r.advanced?`REFRESHED `+r.lastPartSn+`-`+r.lastPartIndex:r.updated?`UPDATED`:`MISSED`}`),!this.canLoad||!r.live)return;let m,h,g;if(r.canBlockReload&&r.endSN&&r.advanced){let e=this.hls.config.lowLatencyMode,i=r.lastPartSn,o=r.endSN,s=r.lastPartIndex,c=s!==-1,l=i===o;c?l?(h=o+1,g=e?0:s):(h=i,g=e?s+1:r.maxPartIndex):h=o+1;let d=r.age,f=d+r.ageHeader,p=Math.min(f-r.partTarget,r.targetduration*1.5);if(p>0){if(f>r.targetduration*3)this.log(`Playlist last advanced ${d.toFixed(2)}s ago. Omitting segment and part directives.`),h=void 0,g=void 0;else if(n!=null&&n.tuneInGoal&&f-r.partTarget>n.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${n.tuneInGoal} to: ${p} with playlist age: ${r.age}`),p=0;else{let e=Math.floor(p/r.targetduration);if(h+=e,g!==void 0){let e=Math.round(p%r.targetduration/r.partTarget);g+=e}this.log(`CDN Tune-in age: ${r.ageHeader}s last advanced ${d.toFixed(2)}s goal: ${p} skip sn ${e} to part ${g}`)}r.tuneInGoal=p}if(m=this.getDeliveryDirectives(r,t.deliveryDirectives,h,g),e||!l){r.requestScheduled=a,this.loadingPlaylist(u,m);return}}else (r.canBlockReload||r.canSkipUntil)&&(m=this.getDeliveryDirectives(r,t.deliveryDirectives,h,g));m&&h!==void 0&&r.canBlockReload&&(r.requestScheduled=i.loading.first+Math.max(p-o*2,p/2)),this.scheduleLoading(u,m,r)}else this.clearTimer()}scheduleLoading(e,t,n){let r=n||e.details;if(!r){this.loadingPlaylist(e,t);return}let i=self.performance.now(),a=r.requestScheduled;if(i>=a){this.loadingPlaylist(e,t);return}let o=a-i;this.log(`reload live playlist ${e.name||e.bitrate+`bps`} in ${Math.round(o)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(e,t),o)}getDeliveryDirectives(e,t,n,r){let i=_t(e);return t!=null&&t.skip&&e.deltaUpdateFailed&&(n=t.msn,r=t.part,i=gt.No),new vt(n,r,i)}checkRetry(e){let t=e.details,n=Gt(e),r=e.errorAction,{action:i,retryCount:a=0,retryConfig:o}=r||{},s=!!r&&!!o&&(i===en.RetryRequest||!r.resolved&&i===en.SendAlternateToPenaltyBox);if(s){var c;if(a>=o.maxNumRetry)return!1;if(n&&(c=e.context)!=null&&c.deliveryDirectives)this.warn(`Retrying playlist loading ${a+1}/${o.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{let e=Yt(o,a);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),e),this.warn(`Retrying playlist loading ${a+1}/${o.maxNumRetry} after "${t}" in ${e}ms`)}e.levelRetry=!0,r.resolved=!0}return s}};function _o(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!vo(e[n].attrs,t[n].attrs))return!1;return!0}function vo(e,t,n){let r=e[`STABLE-RENDITION-ID`];return r&&!n?r===t[`STABLE-RENDITION-ID`]:!(n||[`LANGUAGE`,`NAME`,`CHARACTERISTICS`,`AUTOSELECT`,`DEFAULT`,`FORCED`,`ASSOC-LANGUAGE`]).some(n=>e[n]!==t[n])}function yo(e,t){return t.label.toLowerCase()===e.name.toLowerCase()&&(!t.language||t.language.toLowerCase()===(e.lang||``).toLowerCase())}var bo=class extends go{constructor(e){super(e,`audio-track-controller`),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){let{hls:e}=this;e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.MANIFEST_PARSED,this.onManifestParsed,this),e.on(l.LEVEL_LOADING,this.onLevelLoading,this),e.on(l.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(l.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(l.ERROR,this.onError,this)}unregisterListeners(){let{hls:e}=this;e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.MANIFEST_PARSED,this.onManifestParsed,this),e.off(l.LEVEL_LOADING,this.onLevelLoading,this),e.off(l.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(l.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(l.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){let{id:n,groupId:r,details:i}=t,a=this.tracksInGroup[n];if(!a||a.groupId!==r){this.warn(`Audio track with id:${n} and group:${r} not found in active group ${a?.groupId}`);return}let o=a.details;a.details=t.details,this.log(`Audio track ${n} "${a.name}" lang:${a.lang} group:${r} loaded [${i.startSN}-${i.endSN}]`),n===this.trackId&&this.playlistLoaded(n,t,o)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){let t=this.hls.levels[e];if(!t)return;let n=t.audioGroups||null,r=this.groupIds,i=this.currentTrack;if(!n||r?.length!==n?.length||n!=null&&n.some(e=>r?.indexOf(e)===-1)){this.groupIds=n,this.trackId=-1,this.currentTrack=null;let e=this.tracks.filter(e=>!n||n.indexOf(e.groupId)!==-1);if(e.length)this.selectDefaultTrack&&!e.some(e=>e.default)&&(this.selectDefaultTrack=!1),e.forEach((e,t)=>{e.id=t});else if(!i&&!this.tracksInGroup.length)return;this.tracksInGroup=e;let t=this.hls.config.audioPreference;if(!i&&t){let n=kt(t,e,Nt);if(n>-1)i=e[n];else{let e=kt(t,this.tracks);i=this.tracks[e]}}let r=this.findTrackId(i);r===-1&&i&&(r=this.findTrackId(null));let a={audioTracks:e};this.log(`Updating audio tracks, ${e.length} track(s) found in group(s): ${n?.join(`,`)}`),this.hls.trigger(l.AUDIO_TRACKS_UPDATED,a);let o=this.trackId;if(r!==-1&&o===-1)this.setAudioTrack(r);else if(e.length&&o===-1){let t=Error(`No audio track selected for current audio group-ID(s): ${this.groupIds?.join(`,`)} track count: ${e.length}`);this.warn(t.message),this.hls.trigger(l.ERROR,{type:s.MEDIA_ERROR,details:c.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:t})}}}onError(e,t){t.fatal||!t.context||t.context.type===u.AUDIO_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){let t=this.hls;if(t.config.audioPreference=e,e){let n=this.allAudioTracks;if(this.selectDefaultTrack=!1,n.length){let r=this.currentTrack;if(r&&At(e,r,Nt))return r;let i=kt(e,this.tracksInGroup,Nt);if(i>-1){let e=this.tracksInGroup[i];return this.setAudioTrack(i),e}else if(r){let r=t.loadLevel;r===-1&&(r=t.firstAutoLevel);let i=Pt(e,t.levels,n,r,Nt);if(i===-1)return null;t.nextLoadLevel=i}if(e.channels||e.audioCodec){let t=kt(e,n);if(t>-1)return n[t]}}}return null}setAudioTrack(e){let t=this.tracksInGroup;if(e<0||e>=t.length){this.warn(`Invalid audio track id: ${e}`);return}this.selectDefaultTrack=!1;let n=this.currentTrack,r=t[e],i=r.details&&!r.details.live;if(e===this.trackId&&r===n&&i||(this.log(`Switching to audio-track ${e} "${r.name}" lang:${r.lang} group:${r.groupId} channels:${r.channels}`),this.trackId=e,this.currentTrack=r,this.hls.trigger(l.AUDIO_TRACK_SWITCHING,_({},r)),i))return;let a=this.switchParams(r.url,n?.details,r.details);this.loadPlaylist(a)}findTrackId(e){let t=this.tracksInGroup;for(let n=0;n<t.length;n++){let r=t[n];if(!(this.selectDefaultTrack&&!r.default)&&(!e||At(e,r,Nt)))return n}if(e){let{name:n,lang:r,assocLang:i,characteristics:a,audioCodec:o,channels:s}=e;for(let e=0;e<t.length;e++){let c=t[e];if(At({name:n,lang:r,assocLang:i,characteristics:a,audioCodec:o,channels:s},c,Nt))return e}for(let n=0;n<t.length;n++){let r=t[n];if(vo(e.attrs,r.attrs,[`LANGUAGE`,`ASSOC-LANGUAGE`,`CHARACTERISTICS`]))return n}for(let n=0;n<t.length;n++){let r=t[n];if(vo(e.attrs,r.attrs,[`LANGUAGE`]))return n}}return-1}loadPlaylist(e){super.loadPlaylist();let t=this.currentTrack;this.shouldLoadPlaylist(t)&&It(t.url,this.hls)&&this.scheduleLoading(t,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);let n=e.id,r=e.groupId,i=this.getUrlWithDirectives(e.url,t),a=e.details,o=a?.age;this.log(`Loading audio-track ${n} "${e.name}" lang:${e.lang} group:${r}${t?.msn===void 0?``:` at sn `+t.msn+` part `+t.part}${o&&a.live?` age `+o.toFixed(1)+(a.type&&` `+a.type||``):``} ${i}`),this.hls.trigger(l.AUDIO_TRACK_LOADING,{url:i,id:n,groupId:r,deliveryDirectives:t||null,track:e})}},xo=class{constructor(e){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=e}destroy(){this.tracks=this.queues=null}append(e,t,n){if(this.queues===null||this.tracks===null)return;let r=this.queues[t];r.push(e),r.length===1&&!n&&this.executeNext(t)}appendBlocker(e){return new Promise(t=>{let n={label:`async-blocker`,execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.append(n,e)})}prependBlocker(e){return new Promise(t=>{if(this.queues){let n={label:`async-blocker-prepend`,execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.queues[e].unshift(n)}})}removeBlockers(){this.queues!==null&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(e=>{let t=e[0]?.label;(t===`async-blocker`||t===`async-blocker-prepend`)&&(e[0].execute(),e.splice(0,1))})}unblockAudio(e){this.queues!==null&&this.queues.audio[0]===e&&this.shiftAndExecuteNext(`audio`)}executeNext(e){if(this.queues===null||this.tracks===null)return;let t=this.queues[e];if(t.length){let n=t[0];try{n.execute()}catch(t){if(n.onError(t),this.queues===null||this.tracks===null)return;let r=this.tracks[e]?.buffer;r!=null&&r.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues!==null&&(this.queues[e].shift(),this.executeNext(e))}current(e){return this.queues?.[e][0]||null}toString(){let{queues:e,tracks:t}=this;return e===null||t===null?`<destroyed>`:`
${this.list(`video`)}
${this.list(`audio`)}
${this.list(`audiovideo`)}}`}list(e){var t,n;return(t=this.queues)!=null&&t[e]||(n=this.tracks)!=null&&n[e]?`${e}: (${this.listSbInfo(e)}) ${this.listOps(e)}`:``}listSbInfo(e){let t=this.tracks?.[e],n=t?.buffer;return n?`SourceBuffer${n.updating?` updating`:``}${t.ended?` ended`:``}${t.ending?` ending`:``}`:`none`}listOps(e){return this.queues?.[e].map(e=>e.label).join(`, `)||``}},So=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,Co=`HlsJsTrackRemovedError`,wo=class extends Error{constructor(e){super(e),this.name=Co}},To=class extends b{constructor(e,t){super(`buffer-controller`,e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=e=>{this.hls&&this.mediaSource?.readyState===`open`&&this.hls.pauseBuffering()},this._onStartStreaming=e=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=e=>{let{media:t,mediaSource:n}=this;e&&this.log(`Media source opened`),!(!t||!n)&&(n.removeEventListener(`sourceopen`,this._onMediaSourceOpen),t.removeEventListener(`emptied`,this._onMediaEmptied),this.updateDuration(),this.hls.trigger(l.MEDIA_ATTACHED,{media:t,mediaSource:n}),this.mediaSource!==null&&this.checkPendingTracks())},this._onMediaSourceClose=()=>{this.log(`Media source closed`)},this._onMediaSourceEnded=()=>{this.log(`Media source ended`)},this._onMediaEmptied=()=>{let{mediaSrc:e,_objectUrl:t}=this;e!==t&&this.error(`Media element src was set while attaching MediaSource (${t} > ${e})`)},this.hls=e,this.fragmentTracker=t,this.appendSource=A(k(e.config.preferManagedMediaSource)),this.initTracks(),this.registerListeners()}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&=(this.operationQueue.destroy(),null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null}registerListeners(){let{hls:e}=this;e.on(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.MANIFEST_PARSED,this.onManifestParsed,this),e.on(l.BUFFER_RESET,this.onBufferReset,this),e.on(l.BUFFER_APPENDING,this.onBufferAppending,this),e.on(l.BUFFER_CODECS,this.onBufferCodecs,this),e.on(l.BUFFER_EOS,this.onBufferEos,this),e.on(l.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(l.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(l.FRAG_PARSED,this.onFragParsed,this),e.on(l.FRAG_CHANGED,this.onFragChanged,this),e.on(l.ERROR,this.onError,this)}unregisterListeners(){let{hls:e}=this;e.off(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.MANIFEST_PARSED,this.onManifestParsed,this),e.off(l.BUFFER_RESET,this.onBufferReset,this),e.off(l.BUFFER_APPENDING,this.onBufferAppending,this),e.off(l.BUFFER_CODECS,this.onBufferCodecs,this),e.off(l.BUFFER_EOS,this.onBufferEos,this),e.off(l.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(l.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(l.FRAG_PARSED,this.onFragParsed,this),e.off(l.FRAG_CHANGED,this.onFragChanged,this),e.off(l.ERROR,this.onError,this)}transferMedia(){let{media:e,mediaSource:t}=this;if(!e)return null;let n={};if(this.operationQueue){let e=this.isUpdating();e||this.operationQueue.removeBlockers();let t=this.isQueued();(e||t)&&this.warn(`Transfering MediaSource with${t?` operations in queue`:``}${e?` updating SourceBuffer(s)`:``} ${this.operationQueue}`),this.operationQueue.destroy()}let r=this.transferData;return!this.sourceBufferCount&&r&&r.mediaSource===t?h(n,r.tracks):this.sourceBuffers.forEach(e=>{let[t]=e;t&&(n[t]=h({},this.tracks[t]),this.removeBuffer(t)),e[0]=e[1]=null}),{media:e,mediaSource:t,tracks:n}}initTracks(){this.sourceBuffers=[[null,null],[null,null]],this.tracks={},this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){var n;let r=2;(t.audio&&!t.video||!t.altAudio)&&(r=1),this.bufferCodecEventsTotal=r,this.log(`${r} bufferCodec event(s) expected.`),(n=this.transferData)!=null&&n.mediaSource&&this.sourceBufferCount&&r&&this.bufferCreated()}onMediaAttaching(e,t){let n=this.media=t.media;this.transferData=this.overrides=void 0;let r=k(this.appendSource);if(r){let e=!!t.mediaSource;(e||t.overrides)&&(this.transferData=t,this.overrides=t.overrides);let i=this.mediaSource=t.mediaSource||new r;if(this.assignMediaSource(i),e)this._objectUrl=n.src,this.attachTransferred();else{let e=this._objectUrl=self.URL.createObjectURL(i);if(this.appendSource)try{n.removeAttribute(`src`);let t=self.ManagedMediaSource;n.disableRemotePlayback=n.disableRemotePlayback||t&&i instanceof t,Eo(n),Do(n,e),n.load()}catch{n.src=e}else n.src=e}n.addEventListener(`emptied`,this._onMediaEmptied)}}assignMediaSource(e){this.log(`${this.transferData?.mediaSource===e?`transferred`:`created`} media source: ${e.constructor?.name}`),e.addEventListener(`sourceopen`,this._onMediaSourceOpen),e.addEventListener(`sourceended`,this._onMediaSourceEnded),e.addEventListener(`sourceclose`,this._onMediaSourceClose),this.appendSource&&(e.addEventListener(`startstreaming`,this._onStartStreaming),e.addEventListener(`endstreaming`,this._onEndStreaming))}attachTransferred(){let e=this.media,t=this.transferData;if(!t||!e)return;let n=this.tracks,r=t.tracks,i=r?Object.keys(r):null,a=i?i.length:0,o=()=>{Promise.resolve().then(()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen()})};if(r&&i&&a){if(!this.tracksReady){this.hls.config.startFragPrefetch=!0,this.log(`attachTransferred: waiting for SourceBuffer track info`);return}if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})
required tracks: ${q(n,(e,t)=>e===`initSegment`?void 0:t)};
transfer tracks: ${q(r,(e,t)=>e===`initSegment`?void 0:t)}}`),!j(r,n)){t.mediaSource=null,t.tracks=void 0;let i=e.currentTime,a=this.details,o=Math.max(i,a?.fragments[0].start||0);if(o-i>1){this.log(`attachTransferred: waiting for playback to reach new tracks start time ${i} -> ${o}`);return}this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(r)}"->"${Object.keys(n)}") start time: ${o} currentTime: ${i}`),this.onMediaDetaching(l.MEDIA_DETACHING,{}),this.onMediaAttaching(l.MEDIA_ATTACHING,t),e.currentTime=o;return}this.transferData=void 0,i.forEach(e=>{let t=e,n=r[t];if(n){let e=n.buffer;if(e){let r=this.fragmentTracker,i=n.id;if(r.hasFragments(i)||r.hasParts(i)){let n=J.getBuffered(e);r.detectEvictedFragments(t,n,i,null,!0)}let a=Oo(t),o=[t,e];this.sourceBuffers[a]=o,e.updating&&this.operationQueue&&this.operationQueue.prependBlocker(t),this.trackSourceBuffer(t,n)}}}),o(),this.bufferCreated()}else this.log(`attachTransferred: MediaSource w/o SourceBuffers`),o()}get mediaSourceOpenOrEnded(){let e=this.mediaSource?.readyState;return e===`open`||e===`ended`}onMediaDetaching(e,t){let n=!!t.transferMedia;this.transferData=this.overrides=void 0;let{media:r,mediaSource:i,_objectUrl:a}=this;if(i){if(this.log(`media source ${n?`transferring`:`detaching`}`),n)this.sourceBuffers.forEach(([e])=>{e&&this.removeBuffer(e)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){let e=i.readyState===`open`;try{let t=i.sourceBuffers;for(let n=t.length;n--;)e&&t[n].abort(),i.removeSourceBuffer(t[n]);e&&i.endOfStream()}catch(e){this.warn(`onMediaDetaching: ${e.message} while calling endOfStream`)}}this.sourceBufferCount&&this.onBufferReset()}i.removeEventListener(`sourceopen`,this._onMediaSourceOpen),i.removeEventListener(`sourceended`,this._onMediaSourceEnded),i.removeEventListener(`sourceclose`,this._onMediaSourceClose),this.appendSource&&(i.removeEventListener(`startstreaming`,this._onStartStreaming),i.removeEventListener(`endstreaming`,this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}r&&(r.removeEventListener(`emptied`,this._onMediaEmptied),n||(a&&self.URL.revokeObjectURL(a),this.mediaSrc===a?(r.removeAttribute(`src`),this.appendSource&&Eo(r),r.load()):this.warn(`media|source.src was changed by a third party - skip cleanup`)),this.media=null),this.hls.trigger(l.MEDIA_DETACHED,t)}onBufferReset(){this.sourceBuffers.forEach(([e])=>{e&&this.resetBuffer(e)}),this.initTracks()}resetBuffer(e){let t=this.tracks[e]?.buffer;if(this.removeBuffer(e),t)try{var n;(n=this.mediaSource)!=null&&n.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(t)}catch(t){this.warn(`onBufferReset ${e}`,t)}delete this.tracks[e]}removeBuffer(e){this.removeBufferListeners(e),this.sourceBuffers[Oo(e)]=[null,null];let t=this.tracks[e];t&&(t.buffer=void 0)}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new xo(this.tracks)}onBufferCodecs(e,t){let n=this.tracks,r=Object.keys(t);this.log(`BUFFER_CODECS: "${r}" (current SB count ${this.sourceBufferCount})`);let i=`audiovideo`in t&&(n.audio||n.video)||n.audiovideo&&(`audio`in t||`video`in t),a=!i&&this.sourceBufferCount&&this.media&&r.some(e=>!n[e]);if(i||a){this.warn(`Unsupported transition between "${Object.keys(n)}" and "${r}" SourceBuffers`);return}r.forEach(e=>{var r;let{id:i,codec:a,levelCodec:o,container:s,metadata:c,supplemental:l}=t[e],u=n[e],d=(r=this.transferData)==null||(r=r.tracks)==null?void 0:r[e],f=d!=null&&d.buffer?d:u,p=f?.pendingCodec||f?.codec,m=f?.levelCodec;u||=n[e]={buffer:void 0,listeners:[],codec:a,supplemental:l,container:s,levelCodec:o,metadata:c,id:i};let h=Ye(p,m),g=h?.replace(So,`$1`),_=Ye(a,o),v=_?.replace(So,`$1`);_&&h&&g!==v&&(e.slice(0,5)===`audio`&&(_=qe(_,this.appendSource)),this.log(`switching codec ${p} to ${_}`),_!==(u.pendingCodec||u.codec)&&(u.pendingCodec=_),u.container=s,this.appendChangeType(e,s,_))}),(this.tracksReady||this.sourceBufferCount)&&(t.tracks=this.sourceBufferTracks),!this.sourceBufferCount&&(this.bufferCodecEventsTotal>1&&!this.tracks.video&&!t.video&&t.audio?.id===`main`&&(this.log(`Main audio-only`),this.bufferCodecEventsTotal=1),this.mediaSourceOpenOrEnded&&this.checkPendingTracks())}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((e,t)=>{let n=this.tracks[t];return e[t]={id:n.id,container:n.container,codec:n.codec,levelCodec:n.levelCodec},e},{})}appendChangeType(e,t,n){let r=`${t};codecs=${n}`,i={label:`change-type=${r}`,execute:()=>{let i=this.tracks[e];if(i){let a=i.buffer;a!=null&&a.changeType&&(this.log(`changing ${e} sourceBuffer type to ${r}`),a.changeType(r),i.codec=n,i.container=t)}this.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:t=>{this.warn(`Failed to change ${e} SourceBuffer type`,t)}};this.append(i,e,this.isPending(this.tracks[e]))}blockAudio(e){let t=e.start,n=t+e.duration*.05;if(this.fragmentTracker.getAppendedFrag(t,d.MAIN)?.gap===!0)return;let r={label:`block-audio`,execute:()=>{let e=this.tracks.video;(this.lastVideoAppendEnd>n||e!=null&&e.buffer&&J.isBuffered(e.buffer,n)||this.fragmentTracker.getAppendedFrag(n,d.MAIN)?.gap===!0)&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext(`audio`))},onStart:()=>{},onComplete:()=>{},onError:e=>{this.warn(`Error executing block-audio operation`,e)}};this.blockedAudioAppend={op:r,frag:e},this.append(r,`audio`,!0)}unblockAudio(){let{blockedAudioAppend:e,operationQueue:t}=this;e&&t&&(this.blockedAudioAppend=null,t.unblockAudio(e.op))}onBufferAppending(e,t){let{tracks:n}=this,{data:r,type:a,parent:o,frag:u,part:f,chunkMeta:p,offset:m}=t,h=p.buffering[a],{sn:g,cc:_}=u,v=self.performance.now();h.start=v;let y=u.stats.buffering,b=f?f.stats.buffering:null;y.start===0&&(y.start=v),b&&b.start===0&&(b.start=v);let x=n.audio,S=!1;a===`audio`&&x?.container===`audio/mpeg`&&(S=!this.lastMpegAudioChunk||p.id===1||this.lastMpegAudioChunk.sn!==p.sn,this.lastMpegAudioChunk=p);let C=n.video,w=C?.buffer;if(w&&g!==`initSegment`){let e=f||u,t=this.blockedAudioAppend;if(a===`audio`&&o!==`main`&&!this.blockedAudioAppend&&!(C.ending||C.ended)){let t=e.start+e.duration*.05,n=w.buffered,r=this.currentOp(`video`);(!n.length&&!r||!r&&!J.isBuffered(w,t)&&this.lastVideoAppendEnd<t)&&this.blockAudio(e)}else if(a===`video`){let n=e.end;if(t){let e=t.frag.start;(n>e||n<this.lastVideoAppendEnd||J.isBuffered(w,e))&&this.unblockAudio()}this.lastVideoAppendEnd=n}}let T=(f||u).start,E={label:`append-${a}`,execute:()=>{h.executeStart=self.performance.now();let e=this.tracks[a]?.buffer;e&&(S?this.updateTimestampOffset(e,T,.1,a,g,_):m!==void 0&&i(m)&&this.updateTimestampOffset(e,m,1e-6,a,g,_)),this.appendExecutor(r,a)},onStart:()=>{},onComplete:()=>{let e=self.performance.now();h.executeEnd=h.end=e,y.first===0&&(y.first=e),b&&b.first===0&&(b.first=e);let t={};this.sourceBuffers.forEach(([e,n])=>{e&&(t[e]=J.getBuffered(n))}),this.appendErrors[a]=0,a===`audio`||a===`video`?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(l.BUFFER_APPENDED,{type:a,frag:u,part:f,chunkMeta:p,parent:u.type,timeRanges:t})},onError:e=>{let t={type:s.MEDIA_ERROR,parent:u.type,details:c.BUFFER_APPEND_ERROR,sourceBufferName:a,frag:u,part:f,chunkMeta:p,error:e,err:e,fatal:!1},n=this.media?.error;if(e.code===DOMException.QUOTA_EXCEEDED_ERR||e.name==`QuotaExceededError`||`quota`in e)t.details=c.BUFFER_FULL_ERROR;else if(e.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!n)t.errorAction=rn(!0);else if(e.name===Co&&this.sourceBufferCount===0)t.errorAction=rn(!0);else{let e=++this.appendErrors[a];this.warn(`Failed ${e}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${a}" sourceBuffer (${n||`no media error`})`),(e>=this.hls.config.appendErrorMaxRetry||n)&&(t.fatal=!0)}this.hls.trigger(l.ERROR,t)}};this.log(`queuing "${a}" append sn: ${g}${f?` p: `+f.index:``} of ${u.type===d.MAIN?`level`:`track`} ${u.level} cc: ${_}`),this.append(E,a,this.isPending(this.tracks[a]))}getFlushOp(e,t,n){return this.log(`queuing "${e}" remove ${t}-${n}`),{label:`remove`,execute:()=>{this.removeExecutor(e,t,n)},onStart:()=>{},onComplete:()=>{this.hls.trigger(l.BUFFER_FLUSHED,{type:e})},onError:r=>{this.warn(`Failed to remove ${t}-${n} from "${e}" SourceBuffer`,r)}}}onBufferFlushing(e,t){let{type:n,startOffset:r,endOffset:i}=t;n?this.append(this.getFlushOp(n,r,i),n):this.sourceBuffers.forEach(([e])=>{e&&this.append(this.getFlushOp(e,r,i),e)})}onFragParsed(e,t){let{frag:n,part:r}=t,i=[],a=r?r.elementaryStreams:n.elementaryStreams;a[V.AUDIOVIDEO]?i.push(`audiovideo`):(a[V.AUDIO]&&i.push(`audio`),a[V.VIDEO]&&i.push(`video`)),i.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${n.type} level: ${n.level} sn: ${n.sn}`),this.blockBuffers(()=>{let e=self.performance.now();n.stats.buffering.end=e,r&&(r.stats.buffering.end=e);let t=r?r.stats:n.stats;this.hls.trigger(l.FRAG_BUFFERED,{frag:n,part:r,stats:t,id:n.type})},i).catch(e=>{this.warn(`Fragment buffered callback ${e}`),this.stepOperationQueue(this.sourceBufferTypes)})}onFragChanged(e,t){this.trimBuffers()}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{if(e){let t=this.tracks[e];if(t)return!t.ended||t.ending}return!1})}onBufferEos(e,t){this.sourceBuffers.forEach(([e])=>{if(e){let n=this.tracks[e];(!t.type||t.type===e)&&(n.ending=!0,n.ended||(n.ended=!0,this.log(`${e} buffer reached EOS`)))}});let n=this.overrides?.endOfStream!==!1;this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{var t;return e&&!((t=this.tracks[e])!=null&&t.ended)})?n?(this.log(`Queueing EOS`),this.blockUntilOpen(()=>{this.tracksEnded();let{mediaSource:e}=this;if(!e||e.readyState!==`open`){e&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${e.readyState}`);return}this.log(`Calling mediaSource.endOfStream()`),e.endOfStream(),this.hls.trigger(l.BUFFERED_TO_END,void 0)})):(this.tracksEnded(),this.hls.trigger(l.BUFFERED_TO_END,void 0)):t.type===`video`&&this.unblockAudio()}tracksEnded(){this.sourceBuffers.forEach(([e])=>{if(e!==null){let t=this.tracks[e];t&&(t.ending=!1)}})}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.updateDuration())}updateDuration(){this.blockUntilOpen(()=>{let e=this.getDurationAndRange();e&&this.updateMediaSource(e)})}onError(e,t){if(t.details===c.BUFFER_APPEND_ERROR&&t.frag){let e=t.errorAction?.nextAutoLevel;i(e)&&e!==t.frag.level&&this.resetAppendErrors()}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0}}trimBuffers(){let{hls:e,details:t,media:n}=this;if(!n||t===null||!this.sourceBufferCount)return;let r=e.config,a=n.currentTime,o=t.levelTargetDuration,s=t.live&&r.liveBackBufferLength!==null?r.liveBackBufferLength:r.backBufferLength;if(i(s)&&s>=0){let e=Math.max(s,o),t=Math.floor(a/o)*o-e;this.flushBackBuffer(a,o,t)}let c=r.frontBufferFlushThreshold;if(i(c)&&c>0){let e=Math.max(r.maxBufferLength,c),t=Math.max(e,o),n=Math.floor(a/o)*o+t;this.flushFrontBuffer(a,o,n)}}flushBackBuffer(e,t,n){this.sourceBuffers.forEach(([e,t])=>{if(t){let i=J.getBuffered(t);if(i.length>0&&n>i.start(0)){var r;this.hls.trigger(l.BACK_BUFFER_REACHED,{bufferEnd:n});let t=this.tracks[e];if((r=this.details)!=null&&r.live)this.hls.trigger(l.LIVE_BACK_BUFFER_REACHED,{bufferEnd:n});else if(t!=null&&t.ended){this.log(`Cannot flush ${e} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(l.BUFFER_FLUSHING,{startOffset:0,endOffset:n,type:e})}}})}flushFrontBuffer(e,t,n){this.sourceBuffers.forEach(([t,r])=>{if(r){let i=J.getBuffered(r),a=i.length;if(a<2)return;let o=i.start(a-1),s=i.end(a-1);if(n>o||e>=o&&e<=s)return;this.hls.trigger(l.BUFFER_FLUSHING,{startOffset:o,endOffset:1/0,type:t})}})}getDurationAndRange(){let{details:e,mediaSource:t}=this;if(!e||!this.media||t?.readyState!==`open`)return null;let n=e.edge;if(e.live&&this.hls.config.liveDurationInfinity){if(e.fragments.length&&t.setLiveSeekableRange){let t=Math.max(0,e.fragmentStart);return{duration:1/0,start:t,end:Math.max(t,n)}}return{duration:1/0}}let r=this.overrides?.duration;if(r)return i(r)?{duration:r}:null;let a=this.media.duration;return n>(i(t.duration)?t.duration:0)&&n>a||!i(a)?{duration:n}:null}updateMediaSource({duration:e,start:t,end:n}){let r=this.mediaSource;!this.media||!r||r.readyState!==`open`||(r.duration!==e&&(i(e)&&this.log(`Updating MediaSource duration to ${e.toFixed(3)}`),r.duration=e),t!==void 0&&n!==void 0&&(this.log(`MediaSource duration is set to ${r.duration}. Setting seekable range to ${t}-${n}.`),r.setLiveSeekableRange(t,n)))}get tracksReady(){let e=this.pendingTrackCount;return e>0&&(e>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){let{bufferCodecEventsTotal:e,pendingTrackCount:t,tracks:n}=this;if(this.log(`checkPendingTracks (pending: ${t} codec events expected: ${e}) ${q(n)}`),this.tracksReady){let e=this.transferData?.tracks;e&&Object.keys(e).length?this.attachTransferred():this.createSourceBuffers()}}bufferCreated(){if(this.sourceBufferCount){let e={};this.sourceBuffers.forEach(([t,n])=>{if(t){let r=this.tracks[t];e[t]={buffer:n,container:r.container,codec:r.codec,supplemental:r.supplemental,levelCodec:r.levelCodec,id:r.id,metadata:r.metadata}}}),this.hls.trigger(l.BUFFER_CREATED,{tracks:e}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([e])=>{this.executeNext(e)})}else{let e=Error(`could not create source buffer for media codec(s)`);this.hls.trigger(l.ERROR,{type:s.MEDIA_ERROR,details:c.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}createSourceBuffers(){let{tracks:e,sourceBuffers:t,mediaSource:n}=this;if(!n)throw Error(`createSourceBuffers called when mediaSource was null`);for(let i in e){let a=i,o=e[a];if(this.isPending(o)){let e=this.getTrackCodec(o,a),i=`${o.container};codecs=${e}`;o.codec=e,this.log(`creating sourceBuffer(${i})${this.currentOp(a)?` Queued`:``} ${q(o)}`);try{let e=n.addSourceBuffer(i),r=Oo(a);t[r]=[a,e],o.buffer=e}catch(e){var r;this.error(`error while trying to add sourceBuffer: ${e.message}`),this.shiftAndExecuteNext(a),(r=this.operationQueue)==null||r.removeBlockers(),delete this.tracks[a],this.hls.trigger(l.ERROR,{type:s.MEDIA_ERROR,details:c.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:e,sourceBufferName:a,mimeType:i,parent:o.id});return}this.trackSourceBuffer(a,o)}}this.bufferCreated()}getTrackCodec(e,t){let n=e.supplemental,r=e.codec;n&&(t===`video`||t===`audiovideo`)&&ze(n,`video`)&&(r=Je(r,n));let i=Ye(r,e.levelCodec);return i?t.slice(0,5)===`audio`?qe(i,this.appendSource):i:``}trackSourceBuffer(e,t){let n=t.buffer;if(!n)return;let r=this.getTrackCodec(t,e);this.tracks[e]={buffer:n,codec:r,container:t.container,levelCodec:t.levelCodec,supplemental:t.supplemental,metadata:t.metadata,id:t.id,listeners:[]},this.removeBufferListeners(e),this.addBufferListener(e,`updatestart`,this.onSBUpdateStart),this.addBufferListener(e,`updateend`,this.onSBUpdateEnd),this.addBufferListener(e,`error`,this.onSBUpdateError),this.appendSource&&this.addBufferListener(e,`bufferedchange`,(e,t)=>{let n=t.removedRanges;n!=null&&n.length&&this.hls.trigger(l.BUFFER_FLUSHED,{type:e})})}get mediaSrc(){var e,t;return(((e=this.media)==null||(t=e.querySelector)==null?void 0:t.call(e,`source`))||this.media)?.src}onSBUpdateStart(e){let t=this.currentOp(e);t&&t.onStart()}onSBUpdateEnd(e){if(this.mediaSource?.readyState===`closed`){this.resetBuffer(e);return}let t=this.currentOp(e);t&&(t.onComplete(),this.shiftAndExecuteNext(e))}onSBUpdateError(e,t){let n=Error(`${e} SourceBuffer error. MediaSource readyState: ${this.mediaSource?.readyState}`);this.error(`${n}`,t),this.hls.trigger(l.ERROR,{type:s.MEDIA_ERROR,details:c.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:n,fatal:!1});let r=this.currentOp(e);r&&r.onError(n)}updateTimestampOffset(e,t,n,r,i,a){let o=t-e.timestampOffset;Math.abs(o)>=n&&(this.log(`Updating ${r} SourceBuffer timestampOffset to ${t} (sn: ${i} cc: ${a})`),e.timestampOffset=t)}removeExecutor(e,t,n){let{media:r,mediaSource:a}=this,o=this.tracks[e],s=o?.buffer;if(!r||!a||!s){this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),this.shiftAndExecuteNext(e);return}let c=i(r.duration)?r.duration:1/0,l=i(a.duration)?a.duration:1/0,u=Math.max(0,t),d=Math.min(n,c,l);d>u&&(!o.ending||o.ended)?(o.ended=!1,this.log(`Removing [${u},${d}] from the ${e} SourceBuffer`),s.remove(u,d)):this.shiftAndExecuteNext(e)}appendExecutor(e,t){let n=this.tracks[t],r=n?.buffer;if(!r)throw new wo(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);n.ending=!1,n.ended=!1,r.appendBuffer(e)}blockUntilOpen(e){if(this.isUpdating()||this.isQueued())this.blockBuffers(e).catch(e=>{this.warn(`SourceBuffer blocked callback ${e}`),this.stepOperationQueue(this.sourceBufferTypes)});else try{e()}catch(e){this.warn(`Callback run without blocking ${this.operationQueue} ${e}`)}}isUpdating(){return this.sourceBuffers.some(([e,t])=>e&&t.updating)}isQueued(){return this.sourceBuffers.some(([e])=>e&&!!this.currentOp(e))}isPending(e){return!!e&&!e.buffer}blockBuffers(e,t=this.sourceBufferTypes){if(!t.length)return this.log(`Blocking operation requested, but no SourceBuffers exist`),Promise.resolve().then(e);let{operationQueue:n}=this,r=t.map(e=>this.appendBlocker(e));return t.length>1&&this.blockedAudioAppend&&this.unblockAudio(),Promise.all(r).then(t=>{n===this.operationQueue&&(e(),this.stepOperationQueue(this.sourceBufferTypes))})}stepOperationQueue(e){e.forEach(e=>{let t=this.tracks[e]?.buffer;!t||t.updating||this.shiftAndExecuteNext(e)})}append(e,t,n){this.operationQueue&&this.operationQueue.append(e,t,n)}appendBlocker(e){if(this.operationQueue)return this.operationQueue.appendBlocker(e)}currentOp(e){return this.operationQueue?this.operationQueue.current(e):null}executeNext(e){e&&this.operationQueue&&this.operationQueue.executeNext(e)}shiftAndExecuteNext(e){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(e)}get pendingTrackCount(){return Object.keys(this.tracks).reduce((e,t)=>e+(this.isPending(this.tracks[t])?1:0),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((e,[t])=>e+(t?1:0),0)}get sourceBufferTypes(){return this.sourceBuffers.map(([e])=>e).filter(e=>!!e)}addBufferListener(e,t,n){let r=this.tracks[e];if(!r)return;let i=r.buffer;if(!i)return;let a=n.bind(this,e);r.listeners.push({event:t,listener:a}),i.addEventListener(t,a)}removeBufferListeners(e){let t=this.tracks[e];if(!t)return;let n=t.buffer;n&&(t.listeners.forEach(e=>{n.removeEventListener(e.event,e.listener)}),t.listeners.length=0)}};function Eo(e){let t=e.querySelectorAll(`source`);[].slice.call(t).forEach(t=>{e.removeChild(t)})}function Do(e,t){let n=self.document.createElement(`source`);n.type=`video/mp4`,n.src=t,e.appendChild(n)}function Oo(e){return e===`audio`?1:0}var ko=class e{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=1/0,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){let{hls:e}=this;e.on(l.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(l.MANIFEST_PARSED,this.onManifestParsed,this),e.on(l.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(l.BUFFER_CODECS,this.onBufferCodecs,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){let{hls:e}=this;e.off(l.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(l.MANIFEST_PARSED,this.onManifestParsed,this),e.off(l.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(l.BUFFER_CODECS,this.onBufferCodecs,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){let n=this.hls.levels[t.droppedLevel];this.isLevelAllowed(n)&&this.restrictedLevels.push({bitrate:n.bitrate,height:n.height,width:n.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){let n=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,n.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&i(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping(),this.media=null}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}let e=this.hls.levels;if(e.length){let t=this.hls,n=this.getMaxLevel(e.length-1);n!==this.autoLevelCapping&&t.logger.log(`Setting autoLevelCapping to ${n}: ${e[n].height}p@${e[n].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=n,t.autoLevelEnabled&&t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(t){let n=this.hls.levels;if(!n.length)return-1;let r=n.filter((e,n)=>this.isLevelAllowed(e)&&n<=t);return this.clientRect=null,e.getMaxLevelByMediaSize(r,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=1/0,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=1/0,this.timer&&=(self.clearInterval(this.timer),void 0)}getDimensions(){if(this.clientRect)return this.clientRect;let e=this.media,t={width:0,height:0};if(e){let n=e.getBoundingClientRect();t.width=n.width,t.height=n.height,!t.width&&!t.height&&(t.width=n.right-n.left||e.width||0,t.height=n.bottom-n.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch{}return Math.min(e,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(e){return!this.restrictedLevels.some(t=>e.bitrate===t.bitrate&&e.width===t.width&&e.height===t.height)}static getMaxLevelByMediaSize(e,t,n){if(!(e!=null&&e.length))return-1;let r=(e,t)=>t?e.width!==t.width||e.height!==t.height:!0,i=e.length-1,a=Math.max(t,n);for(let t=0;t<e.length;t+=1){let n=e[t];if((n.width>=a||n.height>=a)&&r(n,e[t+1])){i=t;break}}return i}},Ao={MANIFEST:`m`,AUDIO:`a`,VIDEO:`v`,MUXED:`av`,INIT:`i`,CAPTION:`c`,TIMED_TEXT:`tt`,KEY:`k`,OTHER:`o`},jo={HLS:`h`},Mo=class e{constructor(t,n){Array.isArray(t)&&(t=t.map(t=>t instanceof e?t:new e(t))),this.value=t,this.params=n}},No=`Dict`;function Po(e){return Array.isArray(e)?JSON.stringify(e):e instanceof Map?`Map{}`:e instanceof Set?`Set{}`:typeof e==`object`?JSON.stringify(e):String(e)}function Fo(e,t,n,r){return Error(`failed to ${e} "${Po(t)}" as ${n}`,{cause:r})}function Io(e,t,n){return Fo(`serialize`,e,t,n)}var Lo=class{constructor(e){this.description=e}},Ro=`Bare Item`,zo=`Boolean`;function Bo(e){if(typeof e!=`boolean`)throw Io(e,zo);return e?`?1`:`?0`}function Vo(e){return btoa(String.fromCharCode(...e))}var Ho=`Byte Sequence`;function Uo(e){if(ArrayBuffer.isView(e)===!1)throw Io(e,Ho);return`:${Vo(e)}:`}var Wo=`Integer`;function Go(e){return e<-999999999999999||999999999999999<e}function Ko(e){if(Go(e))throw Io(e,Wo);return e.toString()}function qo(e){return`@${Ko(e.getTime()/1e3)}`}function Jo(e,t){if(e<0)return-Jo(-e,t);let n=10**t;if(Math.abs(e*n%1-.5)<2**-52){let t=Math.floor(e*n);return(t%2==0?t:t+1)/n}else return Math.round(e*n)/n}var Yo=`Decimal`;function Xo(e){let t=Jo(e,3);if(Math.floor(Math.abs(t)).toString().length>12)throw Io(e,Yo);let n=t.toString();return n.includes(`.`)?n:`${n}.0`}var Zo=`String`,Qo=/[\x00-\x1f\x7f]+/;function $o(e){if(Qo.test(e))throw Io(e,Zo);return`"${e.replace(/\\/g,`\\\\`).replace(/"/g,`\\"`)}"`}function es(e){return e.description||e.toString().slice(7,-1)}var ts=`Token`;function ns(e){let t=es(e);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(t)===!1)throw Io(t,ts);return t}function rs(e){switch(typeof e){case`number`:if(!i(e))throw Io(e,Ro);return Number.isInteger(e)?Ko(e):Xo(e);case`string`:return $o(e);case`symbol`:return ns(e);case`boolean`:return Bo(e);case`object`:if(e instanceof Date)return qo(e);if(e instanceof Uint8Array)return Uo(e);if(e instanceof Lo)return ns(e);default:throw Io(e,Ro)}}var is=`Key`;function as(e){if(/^[a-z*][a-z0-9\-_.*]*$/.test(e)===!1)throw Io(e,is);return e}function os(e){return e==null?``:Object.entries(e).map(([e,t])=>t===!0?`;${as(e)}`:`;${as(e)}=${rs(t)}`).join(``)}function ss(e){return e instanceof Mo?`${rs(e.value)}${os(e.params)}`:rs(e)}function cs(e){return`(${e.value.map(ss).join(` `)})${os(e.params)}`}function ls(e,t={whitespace:!0}){if(typeof e!=`object`||!e)throw Io(e,No);let n=e instanceof Map?e.entries():Object.entries(e),r=t?.whitespace?` `:``;return Array.from(n).map(([e,t])=>{t instanceof Mo||(t=new Mo(t));let n=as(e);return t.value===!0?n+=os(t.params):(n+=`=`,Array.isArray(t.value)?n+=cs(t):n+=ss(t)),n}).join(`,${r}`)}function us(e,t){return ls(e,t)}var ds=`CMCD-Object`,Z=`CMCD-Request`,fs=`CMCD-Session`,ps=`CMCD-Status`,ms={br:ds,ab:ds,d:ds,ot:ds,tb:ds,tpb:ds,lb:ds,tab:ds,lab:ds,url:ds,pb:Z,bl:Z,tbl:Z,dl:Z,ltc:Z,mtp:Z,nor:Z,nrr:Z,rc:Z,sn:Z,sta:Z,su:Z,ttfb:Z,ttfbb:Z,ttlb:Z,cmsdd:Z,cmsds:Z,smrt:Z,df:Z,cs:Z,ts:Z,cid:fs,pr:fs,sf:fs,sid:fs,st:fs,v:fs,msd:fs,bs:ps,bsd:ps,cdn:ps,rtp:ps,bg:ps,pt:ps,ec:ps,e:ps},hs={REQUEST:Z};function gs(e){return Object.keys(e).reduce((t,n)=>{var r;return(r=e[n])==null||r.forEach(e=>t[e]=n),t},{})}function _s(e,t){let n={};if(!e)return n;let r=Object.keys(e),i=t?gs(t):{};return r.reduce((t,n)=>{let r=ms[n]||i[n]||hs.REQUEST,a=t[r]??(t[r]={});return a[n]=e[n],t},n)}function vs(e){return[`ot`,`sf`,`st`,`e`,`sta`].includes(e)}function ys(e){return typeof e==`number`?i(e):e!=null&&e!==``&&e!==!1}var bs=`event`;function xs(e,t){let n=new URL(e),r=new URL(t);if(n.origin!==r.origin)return e;let i=n.pathname.split(`/`).slice(1),a=r.pathname.split(`/`).slice(1,-1);for(;i[0]===a[0];)i.shift(),a.shift();for(;a.length;)a.shift(),i.unshift(`..`);return i.join(`/`)+n.search+n.hash}var Ss=e=>Math.round(e),Cs=(e,t)=>Array.isArray(e)?e.map(e=>Cs(e,t)):e instanceof Mo&&typeof e.value==`string`?new Mo(Cs(e.value,t),e.params):(t.baseUrl&&(e=xs(e,t.baseUrl)),t.version===1?encodeURIComponent(e):e),ws=e=>Ss(e/100)*100,Ts={br:Ss,d:Ss,bl:ws,dl:ws,mtp:ws,nor:(e,t)=>{let n=e;return t.version>=2&&(e instanceof Mo&&typeof e.value==`string`?n=new Mo([e]):typeof e==`string`&&(n=[e])),Cs(n,t)},rtp:ws,tb:Ss},Es=`request`,Ds=`response`,Os=`ab.bg.bl.br.bs.bsd.cdn.cid.cs.df.ec.lab.lb.ltc.msd.mtp.pb.pr.pt.sf.sid.sn.st.sta.tab.tb.tbl.tpb.ts.v`.split(`.`),ks=[`e`],As=/^[a-zA-Z0-9-.]+-[a-zA-Z0-9-.]+$/;function js(e){return As.test(e)}function Ms(e){return Os.includes(e)||ks.includes(e)||js(e)}var Ns=[`d`,`dl`,`nor`,`ot`,`rtp`,`su`];function Ps(e){return Os.includes(e)||Ns.includes(e)||js(e)}var Fs=[`cmsdd`,`cmsds`,`rc`,`smrt`,`ttfb`,`ttfbb`,`ttlb`,`url`];function Is(e){return Os.includes(e)||Ns.includes(e)||Fs.includes(e)||js(e)}var Ls=[`bl`,`br`,`bs`,`cid`,`d`,`dl`,`mtp`,`nor`,`nrr`,`ot`,`pr`,`rtp`,`sf`,`sid`,`st`,`su`,`tb`,`v`];function Rs(e){return Ls.includes(e)||js(e)}var zs={[Ds]:Is,[bs]:Ms,[Es]:Ps};function Bs(e,t={}){let n={};if(typeof e!=`object`||!e)return n;let r=t.version||e.v||1,a=t.reportingMode||Es,o=r===1?Rs:zs[a],s=Object.keys(e).filter(o),c=t.filter;typeof c==`function`&&(s=s.filter(c));let l=a===Ds||a===bs;l&&!s.includes(`ts`)&&s.push(`ts`),r>1&&!s.includes(`v`)&&s.push(`v`);let u=h({},Ts,t.formatters),d={version:r,reportingMode:a,baseUrl:t.baseUrl};return s.sort().forEach(t=>{let a=e[t],o=u[t];if(typeof o==`function`&&(a=o(a,d)),t===`v`){if(r===1)return;a=r}t==`pr`&&a===1||(l&&t===`ts`&&!i(a)&&(a=Date.now()),ys(a)&&(vs(t)&&typeof a==`string`&&(a=new Lo(a)),n[t]=a))}),n}function Vs(e,t={}){let n={};if(!e)return n;let r=_s(Bs(e,t),t?.customHeaderMap);return Object.entries(r).reduce((e,[t,n])=>{let r=us(n,{whitespace:!1});return r&&(e[t]=r),e},n)}function Hs(e,t,n){return h(e,Vs(t,n))}var Us=`CMCD`;function Ws(e,t={}){return e?us(Bs(e,t),{whitespace:!1}):``}function Gs(e,t={}){if(!e)return``;let n=Ws(e,t);return encodeURIComponent(n)}function Ks(e,t={}){return e?`${Us}=${Gs(e,t)}`:``}var qs=/CMCD=[^&#]+/;function Js(e,t,n){let r=Ks(t,n);return r?qs.test(e)?e.replace(qs,r):`${e}${e.includes(`?`)?`&`:`?`}${r}`:e}var Ys=class{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||=!0,this.buffering=!1},this.applyPlaylistData=e=>{try{this.apply(e,{ot:Ao.MANIFEST,su:!this.initialized})}catch(e){this.hls.logger.warn(`Could not generate manifest CMCD data.`,e)}},this.applyFragmentData=e=>{try{let{frag:t,part:n}=e,r=this.hls.levels[t.level],i=this.getObjectType(t),a={d:(n||t).duration*1e3,ot:i};(i===Ao.VIDEO||i===Ao.AUDIO||i==Ao.MUXED)&&(a.br=r.bitrate/1e3,a.tb=this.getTopBandwidth(i)/1e3,a.bl=this.getBufferLength(i));let o=n?this.getNextPart(n):this.getNextFrag(t);o!=null&&o.url&&o.url!==t.url&&(a.nor=o.url),this.apply(e,a)}catch(e){this.hls.logger.warn(`Could not generate segment CMCD data.`,e)}},this.hls=e;let t=this.config=e.config,{cmcd:n}=t;n!=null&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=n.sessionId||e.sessionId,this.cid=n.contentId,this.useHeaders=n.useHeaders===!0,this.includeKeys=n.includeKeys,this.registerListeners())}registerListeners(){let e=this.hls;e.on(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(l.MEDIA_DETACHED,this.onMediaDetached,this),e.on(l.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){let e=this.hls;e.off(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(l.MEDIA_DETACHED,this.onMediaDetached,this),e.off(l.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener(`waiting`,this.onWaiting),this.media.addEventListener(`playing`,this.onPlaying)}onMediaDetached(){this.media&&=(this.media.removeEventListener(`waiting`,this.onWaiting),this.media.removeEventListener(`playing`,this.onPlaying),null)}onBufferCreated(e,t){this.audioBuffer=t.tracks.audio?.buffer,this.videoBuffer=t.tracks.video?.buffer}createData(){return{v:1,sf:jo.HLS,sid:this.sid,cid:this.cid,pr:this.media?.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){h(t,this.createData());let n=t.ot===Ao.INIT||t.ot===Ao.VIDEO||t.ot===Ao.MUXED;this.starved&&n&&(t.bs=!0,t.su=!0,this.starved=!1),t.su??=this.buffering;let{includeKeys:r}=this;r&&(t=Object.keys(t).reduce((e,n)=>(r.includes(n)&&(e[n]=t[n]),e),{}));let i={baseUrl:e.url};this.useHeaders?(e.headers||={},Hs(e.headers,t,i)):e.url=Js(e.url,t,i)}getNextFrag(e){let t=this.hls.levels[e.level]?.details;if(t){let n=e.sn-t.startSN;return t.fragments[n+1]}}getNextPart(e){var t;let{index:n,fragment:r}=e,i=(t=this.hls.levels[r.level])==null||(t=t.details)==null?void 0:t.partList;if(i){let{sn:e}=r;for(let t=i.length-1;t>=0;t--){let r=i[t];if(r.index===n&&r.fragment.sn===e)return i[t+1]}}}getObjectType(e){let{type:t}=e;if(t===`subtitle`)return Ao.TIMED_TEXT;if(e.sn===`initSegment`)return Ao.INIT;if(t===`audio`)return Ao.AUDIO;if(t===`main`)return this.hls.audioTracks.length?Ao.VIDEO:Ao.MUXED}getTopBandwidth(e){let t=0,n,r=this.hls;if(e===Ao.AUDIO)n=r.audioTracks;else{let e=r.maxAutoLevel,t=e>-1?e+1:r.levels.length;n=r.levels.slice(0,t)}return n.forEach(e=>{e.bitrate>t&&(t=e.bitrate)}),t>0?t:NaN}getBufferLength(e){let t=this.media,n=e===Ao.AUDIO?this.audioBuffer:this.videoBuffer;return!n||!t?NaN:J.bufferInfo(n,t.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){let{pLoader:e}=this.config,t=this.applyPlaylistData,n=e||this.config.loader;return class{constructor(e){this.loader=void 0,this.loader=new n(e)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,n,r){t(e),this.loader.load(e,n,r)}}}createFragmentLoader(){let{fLoader:e}=this.config,t=this.applyFragmentData,n=e||this.config.loader;return class{constructor(e){this.loader=void 0,this.loader=new n(e)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,n,r){t(e),this.loader.load(e,n,r)}}}},Xs=3e5,Zs=class extends b{constructor(e){super(`content-steering`,e.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=`.`,this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.registerListeners()}registerListeners(){let e=this.hls;e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(l.MANIFEST_PARSED,this.onManifestParsed,this),e.on(l.ERROR,this.onError,this)}unregisterListeners(){let e=this.hls;e&&(e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(l.MANIFEST_PARSED,this.onManifestParsed,this),e.off(l.ERROR,this.onError,this))}pathways(){return(this.levels||[]).reduce((e,t)=>(e.indexOf(t.pathwayId)===-1&&e.push(t.pathwayId),e),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(e){this.updatePathwayPriority(e)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){let e=this.timeToLoad*1e3-(performance.now()-this.updated);if(e>0){this.scheduleRefresh(this.uri,e);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&=(this.loader.destroy(),null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){let t=this.levels;t&&(this.levels=t.filter(t=>t!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=`.`,this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){let{contentSteering:n}=t;n!==null&&(this.pathwayId=n.pathwayId,this.uri=n.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){let{errorAction:n}=t;if(n?.action===en.SendAlternateToPenaltyBox&&n.flags===tn.MoveAllAlternatesMatchingHost){let e=this.levels,r=this._pathwayPriority,i=this.pathwayId;if(t.context){let{groupId:n,pathwayId:r,type:a}=t.context;n&&e?i=this.getPathwayForGroupId(n,a,i):r&&(i=r)}i in this.penalizedPathways||(this.penalizedPathways[i]=performance.now()),!r&&e&&(r=this.pathways()),r&&r.length>1&&(this.updatePathwayPriority(r),n.resolved=this.pathwayId!==i),t.details===c.BUFFER_APPEND_ERROR&&!t.fatal?n.resolved=!0:n.resolved||this.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${i} levels: ${e&&e.length} priorities: ${q(r)} penalized: ${q(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(t.length===0){let n=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${n}"`),t=this.getLevelsForPathway(n),this.pathwayId=n}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return this.levels===null?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){this._pathwayPriority=e;let t,n=this.penalizedPathways,r=performance.now();Object.keys(n).forEach(e=>{r-n[e]>Xs&&delete n[e]});for(let r=0;r<e.length;r++){let i=e[r];if(i in n)continue;if(i===this.pathwayId)return;let a=this.hls.nextLoadLevel,o=this.hls.levels[a];if(t=this.getLevelsForPathway(i),t.length>0){this.log(`Setting Pathway to "${i}"`),this.pathwayId=i,Ur(t),this.hls.trigger(l.LEVELS_UPDATED,{levels:t});let e=this.hls.levels[a];o&&e&&this.levels&&(e.attrs[`STABLE-VARIANT-ID`]!==o.attrs[`STABLE-VARIANT-ID`]&&e.bitrate!==o.bitrate&&this.log(`Unstable Pathways change from bitrate ${o.bitrate} to ${e.bitrate}`),this.hls.nextLoadLevel=a);break}}}getPathwayForGroupId(e,t,n){let r=this.getLevelsForPathway(n).concat(this.levels||[]);for(let n=0;n<r.length;n++)if(t===u.AUDIO_TRACK&&r[n].hasAudioGroup(e)||t===u.SUBTITLE_TRACK&&r[n].hasSubtitleGroup(e))return r[n].pathwayId;return n}clonePathways(e){let t=this.levels;if(!t)return;let n={},r={};e.forEach(e=>{let{ID:i,"BASE-ID":a,"URI-REPLACEMENT":o}=e;if(t.some(e=>e.pathwayId===i))return;let s=this.getLevelsForPathway(a).map(e=>{let t=new Fn(e.attrs);t[`PATHWAY-ID`]=i;let a=t.AUDIO&&`${t.AUDIO}_clone_${i}`,s=t.SUBTITLES&&`${t.SUBTITLES}_clone_${i}`;a&&(n[t.AUDIO]=a,t.AUDIO=a),s&&(r[t.SUBTITLES]=s,t.SUBTITLES=s);let c=$s(e.uri,t[`STABLE-VARIANT-ID`],`PER-VARIANT-URIS`,o),l=new yt({attrs:t,audioCodec:e.audioCodec,bitrate:e.bitrate,height:e.height,name:e.name,url:c,videoCodec:e.videoCodec,width:e.width});if(e.audioGroups)for(let t=1;t<e.audioGroups.length;t++)l.addGroupId(`audio`,`${e.audioGroups[t]}_clone_${i}`);if(e.subtitleGroups)for(let t=1;t<e.subtitleGroups.length;t++)l.addGroupId(`text`,`${e.subtitleGroups[t]}_clone_${i}`);return l});t.push(...s),Qs(this.audioTracks,n,o,i),Qs(this.subtitleTracks,r,o,i)})}loadSteeringManifest(e){let t=this.hls.config,n=t.loader;this.loader&&this.loader.destroy(),this.loader=new n(t);let r;try{r=new self.URL(e)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${e}`);return}if(r.protocol!==`data:`){let e=(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate)|0;r.searchParams.set(`_HLS_pathway`,this.pathwayId),r.searchParams.set(`_HLS_throughput`,``+e)}let i={responseType:`json`,url:r.href},a=t.steeringManifestLoadPolicy.default,o=a.errorRetry||a.timeoutRetry||{},s={loadPolicy:a,timeout:a.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0};this.log(`Requesting steering manifest: ${r}`),this.loader.load(i,s,{onSuccess:(e,t,n,i)=>{this.log(`Loaded steering manifest: "${r}"`);let a=e.data;if(a?.VERSION!==1){this.log(`Steering VERSION ${a.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=a.TTL;let{"RELOAD-URI":o,"PATHWAY-CLONES":s,"PATHWAY-PRIORITY":c}=a;if(o)try{this.uri=new self.URL(o,r).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${o}`);return}this.scheduleRefresh(this.uri||n.url),s&&this.clonePathways(s);let u={steeringManifest:a,url:r.toString()};this.hls.trigger(l.STEERING_MANIFEST_LOADED,u),c&&this.updatePathwayPriority(c)},onError:(e,t,n,r)=>{if(this.log(`Error loading steering manifest: ${e.code} ${e.text} (${t.url})`),this.stopLoad(),e.code===410){this.enabled=!1,this.log(`Steering manifest ${t.url} no longer available`);return}let i=this.timeToLoad*1e3;if(e.code===429){let e=this.loader;if(typeof e?.getResponseHeader==`function`){let t=e.getResponseHeader(`Retry-After`);t&&(i=parseFloat(t)*1e3)}this.log(`Steering manifest ${t.url} rate limited`);return}this.scheduleRefresh(this.uri||t.url,i)},onTimeout:(e,t,n)=>{this.log(`Timeout loading steering manifest (${t.url})`),this.scheduleRefresh(this.uri||t.url)}})}scheduleRefresh(e,t=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{let t=this.hls?.media;if(t&&!t.ended){this.loadSteeringManifest(e);return}this.scheduleRefresh(e,this.timeToLoad*1e3)},t)}};function Qs(e,t,n,r){e&&Object.keys(t).forEach(i=>{let a=e.filter(e=>e.groupId===i).map(e=>{let a=h({},e);return a.details=void 0,a.attrs=new Fn(a.attrs),a.url=a.attrs.URI=$s(e.url,e.attrs[`STABLE-RENDITION-ID`],`PER-RENDITION-URIS`,n),a.groupId=a.attrs[`GROUP-ID`]=t[i],a.attrs[`PATHWAY-ID`]=r,a});e.push(...a)})}function $s(e,t,n,r){let{HOST:i,PARAMS:a,[n]:o}=r,s;t&&(s=o?.[t],s&&(e=s));let c=new self.URL(e);return i&&!s&&(c.host=i),a&&Object.keys(a).sort().forEach(e=>{e&&c.searchParams.set(e,a[e])}),c.href}var ec=class e extends b{constructor(t){super(`eme`,t.logger),this.hls=void 0,this.config=void 0,this.media=null,this.mediaResolved=void 0,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.mediaKeys=null,this.setMediaKeysQueue=e.CDMCleanupPromise?[e.CDMCleanupPromise]:[],this.bannedKeyIds={},this.onMediaEncrypted=e=>{let{initDataType:t,initData:n}=e,r=`"${e.type}" event: init data type: "${t}"`;if(this.debug(r),n!==null){if(!this.keyFormatPromise){let e=Object.keys(this.keySystemAccessPromises);e.length||(e=tr(this.config));let t=e.map(er).filter(e=>!!e);this.keyFormatPromise=this.getKeyFormatPromise(t)}this.keyFormatPromise.then(i=>{let a=$n(i);if(t!==`sinf`||a!==Y.FAIRPLAY){this.log(`Ignoring "${e.type}" event with init data type: "${t}" for selected key-system ${a}`);return}let o;try{let e=U(new Uint8Array(n)),t=Se(Kn(JSON.parse(e).sinf));if(!t)throw Error(`'schm' box missing or not cbcs/cenc with schi > tenc`);o=new Uint8Array(t.subarray(8,24))}catch(e){this.warn(`${r} Failed to parse sinf: ${e}`);return}let s=N(o),{keyIdToKeySessionPromise:c,mediaKeySessions:l}=this,u=c[s];for(let e=0;e<l.length;e++){let r=l[e],i=r.decryptdata;if(!i.keyId)continue;let a=N(i.keyId);if(Hn(o,i.keyId)||i.uri.replace(/-/g,``).indexOf(s)!==-1){if(u=c[a],!u)continue;if(i.pssh)break;delete c[a],i.pssh=new Uint8Array(n),i.keyId=o,u=c[s]=u.then(()=>this.generateRequestWithPreferredKeySession(r,t,n,`encrypted-event-key-match`)),u.catch(e=>this.handleError(e));break}}u||this.handleError(Error(`Key ID ${s} not encountered in playlist. Key-system sessions ${l.length}.`))}).catch(e=>this.handleError(e))}},this.onWaitingForKey=e=>{this.log(`"${e.type}" event`)},this.hls=t,this.config=t.config,this.registerListeners()}destroy(){this.onDestroying(),this.onMediaDetached();let e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null}registerListeners(){this.hls.on(l.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(l.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(l.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(l.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.on(l.DESTROYING,this.onDestroying,this)}unregisterListeners(){this.hls.off(l.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(l.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(l.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(l.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.off(l.DESTROYING,this.onDestroying,this)}getLicenseServerUrl(e){let{drmSystems:t,widevineLicenseUrl:n}=this.config,r=t?.[e];if(r)return r.licenseUrl;if(e===Y.WIDEVINE&&n)return n}getLicenseServerUrlOrThrow(e){let t=this.getLicenseServerUrl(e);if(t===void 0)throw Error(`no license server URL configured for key-system "${e}"`);return t}getServerCertificateUrl(e){let{drmSystems:t}=this.config,n=t?.[e];if(n)return n.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){let t=this.hls.levels,n=(e,t,n)=>!!e&&n.indexOf(e)===t,r=t.map(e=>e.audioCodec).filter(n),i=t.map(e=>e.videoCodec).filter(n);return r.length+i.length===0&&i.push(`avc1.42e01e`),new Promise((t,n)=>{let a=e=>{let o=e.shift();this.getMediaKeysPromise(o,r,i).then(e=>t({keySystem:o,mediaKeys:e})).catch(t=>{e.length?a(e):t instanceof rc?n(t):n(new rc({type:s.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_NO_ACCESS,error:t,fatal:!0},t.message))})};a(e)})}requestMediaKeySystemAccess(e,t){let{requestMediaKeySystemAccessFunc:n}=this.config;if(typeof n!=`function`){let e=`Configured requestMediaKeySystemAccess is not a function ${n}`;return nr===null&&self.location.protocol===`http:`&&(e=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(Error(e))}return n(e,t)}getMediaKeysPromise(e,t,n){let r=rr(e,t,n,this.config.drmSystemOptions||{}),i=this.keySystemAccessPromises[e],a=i?.keySystemAccess;if(!a){this.log(`Requesting encrypted media "${e}" key-system access with config: ${q(r)}`),a=this.requestMediaKeySystemAccess(e,r);let t=i=this.keySystemAccessPromises[e]={keySystemAccess:a};return a.catch(t=>{this.log(`Failed to obtain access to key-system "${e}": ${t}`)}),a.then(n=>{this.log(`Access for key-system "${n.keySystem}" obtained`);let r=this.fetchServerCertificate(e);this.log(`Create media-keys for "${e}"`);let i=t.mediaKeys=n.createMediaKeys().then(n=>(this.log(`Media-keys created for "${e}"`),t.hasMediaKeys=!0,r.then(t=>t?this.setMediaKeysServerCertificate(n,e,t):n)));return i.catch(t=>{this.error(`Failed to create media-keys for "${e}"}: ${t}`)}),i})}return a.then(()=>i.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:n}){this.log(`Creating key-system session "${t}" keyId: ${N(e.keyId||[])} keyUri: ${e.uri}`);let r={decryptdata:e,keySystem:t,mediaKeys:n,mediaKeysSession:n.createSession(),keyStatus:`status-pending`};return this.mediaKeySessions.push(r),r}renewKeySession(e){let t=e.decryptdata;if(t.pssh){let n=this.createMediaKeySessionContext(e),r=tc(t);this.keyIdToKeySessionPromise[r]=this.generateRequestWithPreferredKeySession(n,`cenc`,t.pssh.buffer,`expired`)}else this.warn(`Could not renew expired session. Missing pssh initData.`);this.removeSession(e)}updateKeySession(e,t){let n=e.mediaKeysSession;return this.log(`Updating key-session "${n.sessionId}" for keyId ${N(e.decryptdata.keyId||[])}
      } (data length: ${t.byteLength})`),n.update(t)}getSelectedKeySystemFormats(){return Object.keys(this.keySystemAccessPromises).map(e=>({keySystem:e,hasMediaKeys:this.keySystemAccessPromises[e].hasMediaKeys})).filter(({hasMediaKeys:e})=>!!e).map(({keySystem:e})=>er(e)).filter(e=>!!e)}getKeySystemAccess(e){return this.getKeySystemSelectionPromise(e).then(({keySystem:e,mediaKeys:t})=>this.attemptSetMediaKeys(e,t))}selectKeySystem(e){return new Promise((t,n)=>{this.getKeySystemSelectionPromise(e).then(({keySystem:e})=>{let r=er(e);r?t(r):n(Error(`Unable to find format for key-system "${e}"`))}).catch(n)})}selectKeySystemFormat(e){let t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||=(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(`, `)}`),this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){let t=tr(this.config),n=e.map($n).filter(e=>!!e&&t.indexOf(e)!==-1);return this.selectKeySystem(n)}getKeyStatus(e){let{mediaKeySessions:t}=this;for(let n=0;n<t.length;n++){let r=nc(e,t[n]);if(r)return r}}loadKey(e){let t=e.keyInfo.decryptdata,n=tc(t),r=this.bannedKeyIds[n];if(r||this.getKeyStatus(t)===`internal-error`){let n=ic(r||`internal-error`,t);return this.handleError(n,e.frag),Promise.reject(n)}let i=`(keyId: ${n} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${i}`);let a=this.keyIdToKeySessionPromise[n];if(!a){let r=this.getKeySystemForKeyPromise(t).then(({keySystem:n,mediaKeys:r})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${i}`),this.attemptSetMediaKeys(n,r).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:n,mediaKeys:r,decryptdata:t}))))).then(e=>{let n=t.pssh?t.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(e,`cenc`,n,`playlist-key`)});return r.catch(t=>this.handleError(t,e.frag)),this.keyIdToKeySessionPromise[n]=r,r}return a.catch(n=>{if(n instanceof rc){let r=_({},n.data);this.getKeyStatus(t)===`internal-error`&&(r.decryptdata=t);let i=new rc(r,n.message);this.handleError(i,e.frag)}}),a}throwIfDestroyed(e=`Invalid state`){if(!this.hls)throw Error(`invalid state`)}handleError(e,t){if(this.hls)if(e instanceof rc){t&&(e.data.frag=t);let n=e.data.decryptdata;this.error(`${e.message}${n?` (${N(n.keyId||[])})`:``}`),this.hls.trigger(l.ERROR,e.data)}else this.error(e.message),this.hls.trigger(l.ERROR,{type:s.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0})}getKeySystemForKeyPromise(e){let t=tc(e),n=this.keyIdToKeySessionPromise[t];if(!n){let t=$n(e.keyFormat),n=t?[t]:tr(this.config);return this.attemptKeySystemAccess(n)}return n}getKeySystemSelectionPromise(e){if(e.length||(e=tr(this.config)),e.length===0)throw new rc({type:s.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${q({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}attemptSetMediaKeys(e,t){if(this.mediaResolved=void 0,this.mediaKeys===t)return Promise.resolve();let n=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);let r=Promise.all(n).then(()=>this.media?this.media.setMediaKeys(t):new Promise((e,n)=>{this.mediaResolved=()=>{if(this.mediaResolved=void 0,!this.media)return n(Error(`Attempted to set mediaKeys without media element attached`));this.mediaKeys=t,this.media.setMediaKeys(t).then(e).catch(n)}}));return this.mediaKeys=t,this.setMediaKeysQueue.push(r),r.then(()=>{this.log(`Media-keys set for "${e}"`),n.push(r),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(e=>n.indexOf(e)===-1)})}generateRequestWithPreferredKeySession(e,t,n,r){var i;let a=(i=this.config.drmSystems)==null||(i=i[e.keySystem])==null?void 0:i.generateRequest;if(a)try{let r=a.call(this.hls,t,n,e);if(!r)throw Error(`Invalid response from configured generateRequest filter`);t=r.initDataType,n=r.initData?r.initData:null,e.decryptdata.pssh=n?new Uint8Array(n):null}catch(e){if(this.warn(e.message),this.hls&&this.hls.config.debug)throw e}if(n===null)return this.log(`Skipping key-session request for "${r}" (no initData)`),Promise.resolve(e);let o=tc(e.decryptdata),l=e.decryptdata.uri;this.log(`Generating key-session request for "${r}" keyId: ${o} URI: ${l} (init data type: ${t} length: ${n.byteLength})`);let u=new li,d=e._onmessage=t=>{let n=e.mediaKeysSession;if(!n){u.emit(`error`,Error(`invalid state`));return}let{messageType:r,message:i}=t;this.log(`"${r}" message event for session "${n.sessionId}" message size: ${i.byteLength}`),r===`license-request`||r===`license-renewal`?this.renewLicense(e,i).catch(e=>{u.eventNames().length?u.emit(`error`,e):this.handleError(e)}):r===`license-release`?e.keySystem===Y.FAIRPLAY&&this.updateKeySession(e,qn(`acknowledged`)).then(()=>this.removeSession(e)).catch(e=>this.handleError(e)):this.warn(`unhandled media key message type "${r}"`)},f=(e,t)=>{t.keyStatus=e;let n;e.startsWith(`usable`)?u.emit(`resolved`):e===`internal-error`||e===`output-restricted`||e===`output-downscaled`?n=ic(e,t.decryptdata):e===`expired`?n=Error(`key expired (keyId: ${o})`):e===`released`?n=Error(`key released`):e===`status-pending`||this.warn(`unhandled key status change "${e}" (keyId: ${o})`),n&&(u.eventNames().length?u.emit(`error`,n):this.handleError(n))},p=e._onkeystatuseschange=t=>{if(!e.mediaKeysSession){u.emit(`error`,Error(`invalid state`));return}let n=this.getKeyStatuses(e);if(!Object.keys(n).some(e=>n[e]!==`status-pending`))return;if(n[o]===`expired`){this.log(`Expired key ${q(n)} in key-session "${e.mediaKeysSession.sessionId}"`),this.renewKeySession(e);return}let r=n[o];if(r)f(r,e);else{var i;let t=1e3;e.keyStatusTimeouts||={},(i=e.keyStatusTimeouts)[o]||(i[o]=self.setTimeout(()=>{if(!e.mediaKeysSession||!this.mediaKeys)return;let n=this.getKeyStatus(e.decryptdata);if(n&&n!==`status-pending`)return this.log(`No status for keyId ${o} in key-session "${e.mediaKeysSession.sessionId}". Using session key-status ${n} from other session.`),f(n,e);this.log(`key status for ${o} in key-session "${e.mediaKeysSession.sessionId}" timed out after ${t}ms`),r=`internal-error`,f(r,e)},t)),this.log(`No status for keyId ${o} (${q(n)}).`)}};$r(e.mediaKeysSession,`message`,d),$r(e.mediaKeysSession,`keystatuseschange`,p);let m=new Promise((e,t)=>{u.on(`error`,t),u.on(`resolved`,e)});return e.mediaKeysSession.generateRequest(t,n).then(()=>{this.log(`Request generated for key-session "${e.mediaKeysSession.sessionId}" keyId: ${o} URI: ${l}`)}).catch(t=>{throw new rc({type:s.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_NO_SESSION,error:t,decryptdata:e.decryptdata,fatal:!1},`Error generating key-session request: ${t}`)}).then(()=>m).catch(t=>(u.removeAllListeners(),this.removeSession(e).then(()=>{throw t}))).then(()=>(u.removeAllListeners(),e))}getKeyStatuses(e){let t={};return e.mediaKeysSession.keyStatuses.forEach((n,r)=>{if(typeof r==`string`&&typeof n==`object`){let e=r;r=n,n=e}let i=`buffer`in r?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):new Uint8Array(r);if(e.keySystem===Y.PLAYREADY&&i.length===16){let e=N(i);t[e]=n,Yn(i)}let a=N(i);n===`internal-error`&&(this.bannedKeyIds[a]=n),this.log(`key status change "${n}" for keyStatuses keyId: ${a} key-session "${e.mediaKeysSession.sessionId}"`),t[a]=n}),t}fetchServerCertificate(e){let t=this.config,n=t.loader,r=new n(t),i=this.getServerCertificateUrl(e);return i?(this.log(`Fetching server certificate for "${e}"`),new Promise((n,a)=>{let o={responseType:`arraybuffer`,url:i},l=t.certLoadPolicy.default,u={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0};r.load(o,u,{onSuccess:(e,t,r,i)=>{n(e.data)},onError:(t,n,r,l)=>{a(new rc({type:s.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:r,response:_({url:o.url,data:void 0},t)},`"${e}" certificate request failed (${i}). Status: ${t.code} (${t.text})`))},onTimeout:(t,n,r)=>{a(new rc({type:s.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:r,response:{url:o.url,data:void 0}},`"${e}" certificate request timed out (${i})`))},onAbort:(e,t,n)=>{a(Error(`aborted`))}})})):Promise.resolve()}setMediaKeysServerCertificate(e,t,n){return new Promise((r,i)=>{e.setServerCertificate(n).then(i=>{this.log(`setServerCertificate ${i?`success`:`not supported by CDM`} (${n.byteLength}) on "${t}"`),r(e)}).catch(e=>{i(new rc({type:s.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:e,fatal:!0},e.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(t=>this.updateKeySession(e,new Uint8Array(t)).catch(t=>{throw new rc({type:s.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_SESSION_UPDATE_FAILED,decryptdata:e.decryptdata,error:t,fatal:!1},t.message)}))}unpackPlayReadyKeyMessage(e,t){let n=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!n.includes(`PlayReadyKeyMessage`))return e.setRequestHeader(`Content-Type`,`text/xml; charset=utf-8`),t;let r=new DOMParser().parseFromString(n,`application/xml`),i=r.querySelectorAll(`HttpHeader`);if(i.length>0){let t;for(let n=0,r=i.length;n<r;n++){t=i[n];let r=t.querySelector(`name`)?.textContent,a=t.querySelector(`value`)?.textContent;r&&a&&e.setRequestHeader(r,a)}}let a=r.querySelector(`Challenge`)?.textContent;if(!a)throw Error(`Cannot find <Challenge> in key message`);return qn(atob(a))}setupLicenseXHR(e,t,n,r){let i=this.config.licenseXhrSetup;return i?Promise.resolve().then(()=>{if(!n.decryptdata)throw Error(`Key removed`);return i.call(this.hls,e,t,n,r)}).catch(a=>{if(!n.decryptdata)throw a;return e.open(`POST`,t,!0),i.call(this.hls,e,t,n,r)}).then(n=>(e.readyState||e.open(`POST`,t,!0),{xhr:e,licenseChallenge:n||r})):(e.open(`POST`,t,!0),Promise.resolve({xhr:e,licenseChallenge:r}))}requestLicense(e,t){let n=this.config.keyLoadPolicy.default;return new Promise((r,i)=>{let a=this.getLicenseServerUrlOrThrow(e.keySystem);this.log(`Sending license request to URL: ${a}`);let o=new XMLHttpRequest;o.responseType=`arraybuffer`,o.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return i(Error(`invalid state`));if(o.readyState===4)if(o.status===200){this._requestLicenseFailureCount=0;let t=o.response;this.log(`License received ${t instanceof ArrayBuffer?t.byteLength:t}`);let n=this.config.licenseResponseCallback;if(n)try{t=n.call(this.hls,o,a,e)}catch(e){this.error(e)}r(t)}else{let l=n.errorRetry,u=l?l.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>u||o.status>=400&&o.status<500)i(new rc({type:s.KEY_SYSTEM_ERROR,details:c.KEY_SYSTEM_LICENSE_REQUEST_FAILED,decryptdata:e.decryptdata,fatal:!0,networkDetails:o,response:{url:a,data:void 0,code:o.status,text:o.statusText}},`License Request XHR failed (${a}). Status: ${o.status} (${o.statusText})`));else{let n=u-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${n} attempts left`),this.requestLicense(e,t).then(r,i)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=o,this.setupLicenseXHR(o,a,e,t).then(({xhr:t,licenseChallenge:n})=>{e.keySystem==Y.PLAYREADY&&(n=this.unpackPlayReadyKeyMessage(t,n)),t.send(n)}).catch(i)})}onDestroying(){this.unregisterListeners(),this._clear()}onMediaAttached(e,t){if(!this.config.emeEnabled)return;let n=t.media;this.media=n,$r(n,`encrypted`,this.onMediaEncrypted),$r(n,`waitingforkey`,this.onWaitingForKey);let r=this.mediaResolved;r?r():this.mediaKeys=n.mediaKeys}onMediaDetached(){let e=this.media;e&&(ei(e,`encrypted`,this.onMediaEncrypted),ei(e,`waitingforkey`,this.onWaitingForKey),this.media=null,this.mediaKeys=null)}_clear(){var t;this._requestLicenseFailureCount=0,this.keyIdToKeySessionPromise={},this.bannedKeyIds={};let n=this.mediaResolved;if(n&&n(),!this.mediaKeys&&!this.mediaKeySessions.length)return;let r=this.media,i=this.mediaKeySessions.slice();this.mediaKeySessions=[],this.mediaKeys=null,cr.clearKeyUriToKeyIdMap();let a=i.length;e.CDMCleanupPromise=Promise.all(i.map(e=>this.removeSession(e)).concat((r==null||(t=r.setMediaKeys(null))==null?void 0:t.catch(e=>{this.log(`Could not clear media keys: ${e}`),this.hls&&this.hls.trigger(l.ERROR,{type:s.OTHER_ERROR,details:c.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:Error(`Could not clear media keys: ${e}`)})}))||Promise.resolve())).catch(e=>{this.log(`Could not close sessions and clear media keys: ${e}`),this.hls&&this.hls.trigger(l.ERROR,{type:s.OTHER_ERROR,details:c.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:Error(`Could not close sessions and clear media keys: ${e}`)})}).then(()=>{a&&this.log(`finished closing key sessions and clearing media keys`)})}onManifestLoading(){this._clear()}onManifestLoaded(e,{sessionKeys:t}){if(!(!t||!this.config.emeEnabled)&&!this.keyFormatPromise){let e=t.reduce((e,t)=>(e.indexOf(t.keyFormat)===-1&&e.push(t.keyFormat),e),[]);this.log(`Selecting key-system from session-keys ${e.join(`, `)}`),this.keyFormatPromise=this.getKeyFormatPromise(e)}}removeSession(e){let{mediaKeysSession:t,licenseXhr:n,decryptdata:r}=e;if(t){this.log(`Remove licenses and keys and close session "${t.sessionId}" keyId: ${N(r?.keyId||[])}`),e._onmessage&&=(t.removeEventListener(`message`,e._onmessage),void 0),e._onkeystatuseschange&&=(t.removeEventListener(`keystatuseschange`,e._onkeystatuseschange),void 0),n&&n.readyState!==XMLHttpRequest.DONE&&n.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;let i=this.mediaKeySessions.indexOf(e);i>-1&&this.mediaKeySessions.splice(i,1);let{keyStatusTimeouts:a}=e;a&&Object.keys(a).forEach(e=>self.clearTimeout(a[e]));let{drmSystemOptions:o}=this.config;return(ar(o)?new Promise((e,n)=>{self.setTimeout(()=>n(Error(`MediaKeySession.remove() timeout`)),8e3),t.remove().then(e).catch(n)}):Promise.resolve()).catch(e=>{this.log(`Could not remove session: ${e}`),this.hls&&this.hls.trigger(l.ERROR,{type:s.OTHER_ERROR,details:c.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:Error(`Could not remove session: ${e}`)})}).then(()=>t.close()).catch(e=>{this.log(`Could not close session: ${e}`),this.hls&&this.hls.trigger(l.ERROR,{type:s.OTHER_ERROR,details:c.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:Error(`Could not close session: ${e}`)})})}return Promise.resolve()}};ec.CDMCleanupPromise=void 0;function tc(e){if(!e)throw Error(`Could not read keyId of undefined decryptdata`);if(e.keyId===null)throw Error(`keyId is null`);return N(e.keyId)}function nc(e,t){if(e.keyId&&t.mediaKeysSession.keyStatuses.has(e.keyId))return t.mediaKeysSession.keyStatuses.get(e.keyId);if(e.matches(t.decryptdata))return t.keyStatus}var rc=class extends Error{constructor(e,t){super(t),this.data=void 0,e.error||=Error(t),this.data=e,e.err=e.error}};function ic(e,t){let n=e===`output-restricted`,r=n?c.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:c.KEY_SYSTEM_STATUS_INTERNAL_ERROR;return new rc({type:s.KEY_SYSTEM_ERROR,details:r,fatal:!1,decryptdata:t},n?`HDCP level output restricted`:`key status changed to "${e}"`)}var ac=class{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(l.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(l.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListeners(){this.hls.off(l.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(l.MEDIA_DETACHING,this.onMediaDetaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){let n=this.hls.config;if(n.capLevelOnFPSDrop){let e=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=e,e&&typeof e.getVideoPlaybackQuality==`function`&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),n.fpsDroppedMonitoringPeriod)}}onMediaDetaching(){this.media=null}checkFPS(e,t,n){let r=performance.now();if(t){if(this.lastTime){let e=r-this.lastTime,i=n-this.lastDroppedFrames,a=t-this.lastDecodedFrames,o=1e3*i/e,s=this.hls;if(s.trigger(l.FPS_DROP,{currentDropped:i,currentDecoded:a,totalDroppedFrames:n}),o>0&&i>s.config.fpsDroppedMonitoringThreshold*a){let e=s.currentLevel;s.logger.warn(`drop FPS ratio greater than max allowed value for currentLevel: `+e),e>0&&(s.autoLevelCapping===-1||s.autoLevelCapping>=e)&&(--e,s.trigger(l.FPS_DROP_LEVEL_CAPPING,{level:e,droppedLevel:s.currentLevel}),s.autoLevelCapping=e,this.streamController.nextLevelSwitch())}}this.lastTime=r,this.lastDroppedFrames=n,this.lastDecodedFrames=t}}checkFPSInterval(){let e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){let t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}};function oc(e,t){let n;try{n=new Event(`addtrack`)}catch{n=document.createEvent(`Event`),n.initEvent(`addtrack`,!1,!1)}n.track=e,t.dispatchEvent(n)}function sc(e,t){let n=e.mode;if(n===`disabled`&&(e.mode=`hidden`),e.cues&&!e.cues.getCueById(t.id))try{if(e.addCue(t),!e.cues.getCueById(t.id))throw Error(`addCue is failed for: ${t}`)}catch(n){O.debug(`[texttrack-utils]: ${n}`);try{let n=new self.TextTrackCue(t.startTime,t.endTime,t.text);n.id=t.id,e.addCue(n)}catch(e){O.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${e}`)}}n===`disabled`&&(e.mode=n)}function cc(e,t){let n=e.mode;if(n===`disabled`&&(e.mode=`hidden`),e.cues)for(let n=e.cues.length;n--;)t&&e.cues[n].removeEventListener(`enter`,t),e.removeCue(e.cues[n]);n===`disabled`&&(e.mode=n)}function lc(e,t,n,r){let i=e.mode;if(i===`disabled`&&(e.mode=`hidden`),e.cues&&e.cues.length>0){let i=dc(e.cues,t,n);for(let t=0;t<i.length;t++)(!r||r(i[t]))&&e.removeCue(i[t])}i===`disabled`&&(e.mode=i)}function uc(e,t){if(t<=e[0].startTime)return 0;let n=e.length-1;if(t>e[n].endTime)return-1;let r=0,i=n,a;for(;r<=i;)if(a=Math.floor((i+r)/2),t<e[a].startTime)i=a-1;else if(t>e[a].startTime&&r<n)r=a+1;else return a;return e[r].startTime-t<t-e[i].startTime?r:i}function dc(e,t,n){let r=[],i=uc(e,t);if(i>-1)for(let a=i,o=e.length;a<o;a++){let i=e[a];if(i.startTime>=t&&i.endTime<=n)r.push(i);else if(i.startTime>n)return r}return r}function fc(e){let t=[];for(let n=0;n<e.length;n++){let r=e[n];(r.kind===`subtitles`||r.kind===`captions`)&&r.label&&t.push(e[n])}return t}var pc=class extends go{constructor(e){super(e,`subtitle-track-controller`),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let e=null,t=fc(this.media.textTracks);for(let n=0;n<t.length;n++)if(t[n].mode===`hidden`)e=t[n];else if(t[n].mode===`showing`){e=t[n];break}let n=this.findTrackForTextTrack(e);this.subtitleTrack!==n&&this.setSubtitleTrack(n)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){let{hls:e}=this;e.on(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.MANIFEST_PARSED,this.onManifestParsed,this),e.on(l.LEVEL_LOADING,this.onLevelLoading,this),e.on(l.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(l.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(l.ERROR,this.onError,this)}unregisterListeners(){let{hls:e}=this;e.off(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.MANIFEST_PARSED,this.onManifestParsed,this),e.off(l.LEVEL_LOADING,this.onLevelLoading,this),e.off(l.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(l.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(l.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&`onchange`in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener(`change`,this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(e,t){let n=this.media;if(!n)return;let r=!!t.transferMedia;self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||n.textTracks.removeEventListener(`change`,this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,!r&&fc(n.textTracks).forEach(e=>{cc(e)})}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){let{id:n,groupId:r,details:i}=t,a=this.tracksInGroup[n];if(!a||a.groupId!==r){this.warn(`Subtitle track with id:${n} and group:${r} not found in active group ${a?.groupId}`);return}let o=a.details;a.details=t.details,this.log(`Subtitle track ${n} "${a.name}" lang:${a.lang} group:${r} loaded [${i.startSN}-${i.endSN}]`),n===this.trackId&&this.playlistLoaded(n,t,o)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){let t=this.hls.levels[e];if(!t)return;let n=t.subtitleGroups||null,r=this.groupIds,i=this.currentTrack;if(!n||r?.length!==n?.length||n!=null&&n.some(e=>r?.indexOf(e)===-1)){this.groupIds=n,this.trackId=-1,this.currentTrack=null;let e=this.tracks.filter(e=>!n||n.indexOf(e.groupId)!==-1);if(e.length)this.selectDefaultTrack&&!e.some(e=>e.default)&&(this.selectDefaultTrack=!1),e.forEach((e,t)=>{e.id=t});else if(!i&&!this.tracksInGroup.length)return;this.tracksInGroup=e;let t=this.hls.config.subtitlePreference;if(!i&&t){this.selectDefaultTrack=!1;let n=kt(t,e);if(n>-1)i=e[n];else{let e=kt(t,this.tracks);i=this.tracks[e]}}let r=this.findTrackId(i);r===-1&&i&&(r=this.findTrackId(null));let a={subtitleTracks:e};this.log(`Updating subtitle tracks, ${e.length} track(s) found in "${n?.join(`,`)}" group-id`),this.hls.trigger(l.SUBTITLE_TRACKS_UPDATED,a),r!==-1&&this.trackId===-1&&this.setSubtitleTrack(r)}}findTrackId(e){let t=this.tracksInGroup,n=this.selectDefaultTrack;for(let r=0;r<t.length;r++){let i=t[r];if(!(n&&!i.default||!n&&!e)&&(!e||At(i,e)))return r}if(e){for(let n=0;n<t.length;n++){let r=t[n];if(vo(e.attrs,r.attrs,[`LANGUAGE`,`ASSOC-LANGUAGE`,`CHARACTERISTICS`]))return n}for(let n=0;n<t.length;n++){let r=t[n];if(vo(e.attrs,r.attrs,[`LANGUAGE`]))return n}}return-1}findTrackForTextTrack(e){if(e){let t=this.tracksInGroup;for(let n=0;n<t.length;n++){let r=t[n];if(yo(r,e))return n}}return-1}onError(e,t){t.fatal||!t.context||t.context.type===u.SUBTITLE_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){if(e.id===-1)return this.setSubtitleTrack(-1),null;let t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){let n=this.currentTrack;if(n&&At(e,n))return n;let r=kt(e,this.tracksInGroup);if(r>-1){let e=this.tracksInGroup[r];return this.setSubtitleTrack(r),e}else if(n)return null;else{let n=kt(e,t);if(n>-1)return t[n]}}}return null}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);let n=e.id,r=e.groupId,i=this.getUrlWithDirectives(e.url,t),a=e.details,o=a?.age;this.log(`Loading subtitle ${n} "${e.name}" lang:${e.lang} group:${r}${t?.msn===void 0?``:` at sn `+t.msn+` part `+t.part}${o&&a.live?` age `+o.toFixed(1)+(a.type&&` `+a.type||``):``} ${i}`),this.hls.trigger(l.SUBTITLE_TRACK_LOADING,{url:i,id:n,groupId:r,deliveryDirectives:t||null,track:e})}toggleTrackModes(){let{media:e}=this;if(!e)return;let t=fc(e.textTracks),n=this.currentTrack,r;if(n&&(r=t.filter(e=>yo(n,e))[0],r||this.warn(`Unable to find subtitle TextTrack with name "${n.name}" and language "${n.lang}"`)),[].slice.call(t).forEach(e=>{e.mode!==`disabled`&&e!==r&&(e.mode=`disabled`)}),r){let e=this.subtitleDisplay?`showing`:`hidden`;r.mode!==e&&(r.mode=e)}}setSubtitleTrack(e){let t=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(e<-1||e>=t.length||!i(e)){this.warn(`Invalid subtitle track id: ${e}`);return}this.selectDefaultTrack=!1;let n=this.currentTrack,r=t[e]||null;if(this.trackId=e,this.currentTrack=r,this.toggleTrackModes(),!r){this.hls.trigger(l.SUBTITLE_TRACK_SWITCH,{id:e});return}let a=!!r.details&&!r.details.live;if(e===this.trackId&&r===n&&a)return;this.log(`Switching to subtitle-track ${e}`+(r?` "${r.name}" lang:${r.lang} group:${r.groupId}`:``));let{id:o,groupId:s=``,name:c,type:u,url:d}=r;this.hls.trigger(l.SUBTITLE_TRACK_SWITCH,{id:o,groupId:s,name:c,type:u,url:d});let f=this.switchParams(r.url,n?.details,r.details);this.loadPlaylist(f)}};function mc(){try{return crypto.randomUUID()}catch{try{let e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf(`/`)+1)}catch{let e=new Date().getTime();return`xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx`.replace(/[xy]/g,t=>{let n=(e+Math.random()*16)%16|0;return e=Math.floor(e/16),(t==`x`?n:n&3|8).toString(16)})}}}function hc(e){let t=5381,n=e.length;for(;n;)t=t*33^e.charCodeAt(--n);return(t>>>0).toString()}var gc=.025,_c=function(e){return e[e.Point=0]=`Point`,e[e.Range=1]=`Range`,e}({});function vc(e,t,n){return`${e.identifier}-${n+1}-${hc(t)}`}var yc=class{constructor(e,t){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=t,this.dateRange=e,this.setDateRange(e)}setDateRange(e){this.dateRange=e,this.resumeOffset=e.attr.optionalFloat(`X-RESUME-OFFSET`,this.resumeOffset),this.playoutLimit=e.attr.optionalFloat(`X-PLAYOUT-LIMIT`,this.playoutLimit),this.restrictions=e.attr.enumeratedStringList(`X-RESTRICT`,this.restrictions),this.snapOptions=e.attr.enumeratedStringList(`X-SNAP`,this.snapOptions)}reset(){var e;this.appendInPlaceStarted=!1,(e=this.assetListLoader)==null||e.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)}isAssetPastPlayoutLimit(e){if(e>0&&e>=this.assetList.length)return!0;let t=this.playoutLimit;return e<=0||isNaN(t)?!1:t===0?!0:(this.assetList[e]?.startOffset||0)>t}findAssetIndex(e){return this.assetList.indexOf(e)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){let e=this.dateRange.startTime;if(this.snapOptions.out){let t=this.dateRange.tagAnchor;if(t)return bc(e,t)}return e}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(this.startTime===0||this.snapOptions.out)return!0;let e=this.dateRange.tagAnchor;if(e){let t=this.dateRange.startTime;return t-bc(t,e)<.1}return!1}get resumptionOffset(){let e=this.resumeOffset,t=i(e)?e:this.duration;return this.cumulativeDuration+t}get resumeTime(){let e=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){let t=this.resumeAnchor;if(t)return bc(e,t)}return e}get appendInPlace(){return this.appendInPlaceStarted?!0:this.appendInPlaceDisabled?!1:!!(!this.cue.once&&!this.cue.pre&&this.startIsAligned&&(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<gc))}set appendInPlace(e){if(this.appendInPlaceStarted){this.resetOnResume=!e;return}this.appendInPlaceDisabled=!e}get timelineStart(){return this._timelineStart===null?this.startTime:this._timelineStart}set timelineStart(e){this._timelineStart=e}get duration(){let e=this.playoutLimit,t;return t=this._duration===null?this.dateRange.duration?this.dateRange.duration:this.dateRange.plannedDuration||0:this._duration,!isNaN(e)&&e<t&&(t=e),t}set duration(e){this._duration=e}get cue(){return this.dateRange.cue}get timelineOccupancy(){return this.dateRange.attr[`X-TIMELINE-OCCUPIES`]===`RANGE`?_c.Range:_c.Point}get supplementsPrimary(){return this.dateRange.attr[`X-TIMELINE-STYLE`]===`PRIMARY`}get contentMayVary(){return this.dateRange.attr[`X-CONTENT-MAY-VARY`]!==`NO`}get assetUrl(){return this.dateRange.attr[`X-ASSET-URI`]}get assetListUrl(){return this.dateRange.attr[`X-ASSET-LIST`]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||this.assetListResponse!==null}toString(){return Cc(this)}};function bc(e,t){return e-t.start<t.duration/2&&!(Math.abs(e-(t.start+t.duration))<gc)?t.start:t.start+t.duration}function xc(e,t,n){let r=new self.URL(e,n);return r.protocol!==`data:`&&r.searchParams.set(`_HLS_primary_id`,t),r}function Sc(e,t){for(;(n=e.assetList[++t])!=null&&n.error;)var n;return t}function Cc(e){return`["${e.identifier}" ${e.cue.pre?`<pre>`:e.cue.post?`<post>`:``}${e.timelineStart.toFixed(2)}-${e.resumeTime.toFixed(2)}]`}function wc(e){let t=e.timelineStart,n=e.duration||0;return`["${e.identifier}" ${t.toFixed(2)}-${(t+n).toFixed(2)}]`}var Tc=class{constructor(e,t,n,r){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{this.reachedPlayout(this.currentTime)&&this.hls&&this.hls.trigger(l.PLAYOUT_LIMIT_REACHED,{})};let i=this.hls=new e(t);this.interstitial=n,this.assetItem=r;let a=()=>{this.hasDetails=!0};i.once(l.LEVEL_LOADED,a),i.once(l.AUDIO_TRACK_LOADED,a),i.once(l.SUBTITLE_TRACK_LOADED,a),i.on(l.MEDIA_ATTACHING,(e,{media:t})=>{this.removeMediaListeners(),this.mediaAttached=t,this.interstitial.playoutLimit&&(t.addEventListener(`timeupdate`,this.checkPlayout),this.appendInPlace&&i.on(l.BUFFER_APPENDED,()=>{let e=this.bufferedEnd;this.reachedPlayout(e)&&(this._bufferedEosTime=e,i.trigger(l.BUFFERED_TO_END,void 0))}))})}get appendInPlace(){return this.interstitial.appendInPlace}loadSource(){let e=this.hls;if(e)if(e.url)e.levels.length&&!e.started&&e.startLoad(-1,!0);else{let t=this.assetItem.uri;try{t=xc(t,e.config.primarySessionId||``).href}catch{}e.loadSource(t)}}bufferedInPlaceToEnd(e){var t;if(!this.appendInPlace)return!1;if((t=this.hls)!=null&&t.bufferedToEnd)return!0;if(!e)return!1;let n=Math.min(this._bufferedEosTime||1/0,this.duration),r=this.timelineOffset,i=J.bufferInfo(e,r,0);return this.getAssetTime(i.end)>=n-.02}reachedPlayout(e){let t=this.interstitial.playoutLimit;return this.startOffset+e>=t}get destroyed(){var e;return!((e=this.hls)!=null&&e.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){return this.hls?.media||null}get bufferedEnd(){let e=this.media||this.mediaAttached;if(!e)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;let t=J.bufferInfo(e,e.currentTime,.001);return this.getAssetTime(t.end)}get currentTime(){let e=this.media||this.mediaAttached;return e?this.getAssetTime(e.currentTime):this._currentTime||0}get duration(){let e=this.assetItem.duration;if(!e)return 0;let t=this.interstitial.playoutLimit;if(t){let n=t-this.startOffset;if(n>0&&n<e)return n}return e}get remaining(){let e=this.duration;return e?Math.max(0,e-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){return this.hls?.config.timelineOffset||0}set timelineOffset(e){let t=this.timelineOffset;if(e!==t){let n=e-t;if(Math.abs(n)>1/9e4&&this.hls){if(this.hasDetails)throw Error(`Cannot set timelineOffset after playlists are loaded`);this.hls.config.timelineOffset=e}}}getAssetTime(e){let t=this.timelineOffset,n=this.duration;return Math.min(Math.max(0,e-t),n)}removeMediaListeners(){let e=this.mediaAttached;e&&(this._currentTime=e.currentTime,this.bufferSnapShot(),e.removeEventListener(`timeupdate`,this.checkPlayout))}bufferSnapShot(){if(this.mediaAttached){var e;(e=this.hls)!=null&&e.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd)}}destroy(){this.removeMediaListeners(),this.hls&&this.hls.destroy(),this.hls=null,this.tracks=this.mediaAttached=this.checkPlayout=null}attachMedia(e){var t;this.loadSource(),(t=this.hls)==null||t.attachMedia(e)}detachMedia(){var e;this.removeMediaListeners(),this.mediaAttached=null,(e=this.hls)==null||e.detachMedia()}resumeBuffering(){var e;(e=this.hls)==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.hls)==null||e.pauseBuffering()}transferMedia(){return this.bufferSnapShot(),this.hls?.transferMedia()||null}resetDetails(){let e=this.hls;if(e&&this.hasDetails){e.stopLoad();let t=e=>delete e.details;e.levels.forEach(t),e.allAudioTracks.forEach(t),e.allSubtitleTracks.forEach(t),this.hasDetails=!1}}on(e,t,n){var r;(r=this.hls)==null||r.on(e,t)}once(e,t,n){var r;(r=this.hls)==null||r.once(e,t)}off(e,t,n){var r;(r=this.hls)==null||r.off(e,t)}toString(){return`HlsAssetPlayer: ${wc(this.assetItem)} ${this.hls?.sessionId} ${this.appendInPlace?`append-in-place`:``}`}},Ec=.033,Dc=class extends b{constructor(e,t){super(`interstitials-sched`,t),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=e}destroy(){this.reset(),this.onScheduleUpdate=null}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(e=>e.reset()),this.events=this.items=null}resetErrorsInRange(e,t){return this.events?this.events.reduce((n,r)=>e<=r.startOffset&&t>r.startOffset?(delete r.error,n+1):n,0):0}get duration(){let e=this.items;return e?e[e.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(e){return e&&this.eventMap[e]||null}hasEvent(e){return e in this.eventMap}findItemIndex(e,t){if(e.event)return this.findEventIndex(e.event.identifier);let n=-1;e.nextEvent?n=this.findEventIndex(e.nextEvent.identifier)-1:e.previousEvent&&(n=this.findEventIndex(e.previousEvent.identifier)+1);let r=this.items;if(r)for(r[n]||(t===void 0&&(t=e.start),n=this.findItemIndexAtTime(t));n>=0&&(i=r[n])!=null&&i.event;){var i;n--}return n}findItemIndexAtTime(e,t){let n=this.items;if(n)for(let r=0;r<n.length;r++){let i=n[r];if(t&&t!==`primary`&&(i=i[t]),e===i.start||e>i.start&&e<i.end)return r}return-1}findJumpRestrictedIndex(e,t){let n=this.items;if(n)for(let r=e;r<=t&&n[r];r++){let e=n[r].event;if(e!=null&&e.restrictions.jump&&!e.appendInPlace)return r}return-1}findEventIndex(e){let t=this.items;if(t){for(let n=t.length;n--;)if(t[n].event?.identifier===e)return n}return-1}findAssetIndex(e,t){let n=e.assetList,r=n.length;if(r>1)for(let e=0;e<r;e++){let i=n[e];if(!i.error){let n=i.timelineStart;if(t===n||t>n&&(t<n+(i.duration||0)||e===r-1))return e}}return 0}get assetIdAtEnd(){var e;let t=(e=this.items)==null||(e=e[this.length-1])==null?void 0:e.event;if(t){let e=t.assetList,n=e[e.length-1];if(n)return n.identifier}return null}parseInterstitialDateRanges(e,t){let n=e.main.details,{dateRanges:r}=n,i=this.events,a=this.parseDateRanges(r,{url:n.url},t),o=Object.keys(r),s=i?i.filter(e=>!o.includes(e.identifier)):[];a.length&&a.sort((e,t)=>{let n=e.cue.pre,r=e.cue.post,i=t.cue.pre,a=t.cue.post;if(n&&!i)return-1;if(i&&!n||r&&!a)return 1;if(a&&!r)return-1;if(!n&&!i&&!r&&!a){let n=e.startTime,r=t.startTime;if(n!==r)return n-r}return e.dateRange.tagOrder-t.dateRange.tagOrder}),this.events=a,s.forEach(e=>{this.removeEvent(e)}),this.updateSchedule(e,s)}updateSchedule(e,t=[],n=!1){let r=this.events||[];if(r.length||t.length||this.length<2){let i=this.items,a=this.parseSchedule(r,e);(n||t.length||i?.length!==a.length||a.some((e,t)=>Math.abs(e.playout.start-i[t].playout.start)>.005||Math.abs(e.playout.end-i[t].playout.end)>.005))&&(this.items=a,this.onScheduleUpdate(t,i))}}parseDateRanges(e,t,n){let r=[],i=Object.keys(e);for(let a=0;a<i.length;a++){let o=i[a],s=e[o];if(s.isInterstitial){let e=this.eventMap[o];e?e.setDateRange(s):(e=new yc(s,t),this.eventMap[o]=e,n===!1&&(e.appendInPlace=n)),r.push(e)}}return r}parseSchedule(e,t){let n=[],r=t.main.details,i=r.live?1/0:r.edge,a=0;if(e=e.filter(e=>!e.error&&!(e.cue.once&&e.hasPlayed)),e.length){this.resolveOffsets(e,t);let r=0,o=0;if(e.forEach((t,s)=>{let c=t.cue.pre,l=t.cue.post,u=e[s-1]||null,d=t.appendInPlace,f=l?i:t.startOffset,p=t.duration,m=t.timelineOccupancy===_c.Range?p:0,h=t.resumptionOffset,g=u?.startTime===f,_=f+t.cumulativeDuration,v=d?_+p:f+h;if(c||!l&&f<=0){let e=o;o+=m,t.timelineStart=_;let r=a;a+=p,n.push({event:t,start:_,end:v,playout:{start:r,end:a},integrated:{start:e,end:o}})}else if(f<=i){if(!g){let i=f-r;if(i>Ec){let c=r,l=o;o+=i;let u=a;a+=i;let d={previousEvent:e[s-1]||null,nextEvent:t,start:c,end:c+i,playout:{start:u,end:a},integrated:{start:l,end:o}};n.push(d)}else i>0&&u&&(u.cumulativeDuration+=i,n[n.length-1].end=f)}l&&(v=_),t.timelineStart=_;let i=o;o+=m;let c=a;a+=p,n.push({event:t,start:_,end:v,playout:{start:c,end:a},integrated:{start:i,end:o}})}else return;let y=t.resumeTime;r=l||y>i?i:y}),r<i){let e=r,t=o,s=i-r;o+=s;let c=a;a+=s,n.push({previousEvent:n[n.length-1]?.event||null,nextEvent:null,start:r,end:e+s,playout:{start:c,end:a},integrated:{start:t,end:o}})}this.setDurations(i,a,o)}else n.push({previousEvent:null,nextEvent:null,start:0,end:i,playout:{start:0,end:i},integrated:{start:0,end:i}}),this.setDurations(i,i,i);return n}setDurations(e,t,n){this.durations={primary:e,playout:t,integrated:n}}resolveOffsets(e,t){let n=t.main.details,r=n.live?1/0:n.edge,a=0,o=-1;e.forEach((s,c)=>{let l=s.cue.pre,u=s.cue.post,d=l?0:u?r:s.startTime;this.updateAssetDurations(s),o===d?s.cumulativeDuration=a:(a=0,o=d),!u&&s.snapOptions.in&&(s.resumeAnchor=Bt(null,n.fragments,s.startOffset+s.resumptionOffset,0,0)||void 0),s.appendInPlace&&!s.appendInPlaceStarted&&(this.primaryCanResumeInPlaceAt(s,t)||(s.appendInPlace=!1)),!s.appendInPlace&&c+1<e.length&&e[c+1].startTime-e[c].resumeTime<Ec&&(e[c+1].appendInPlace=!1,e[c+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${s}`));let f=i(s.resumeOffset)?s.resumeOffset:s.duration;a+=f})}primaryCanResumeInPlaceAt(e,t){let n=e.resumeTime,r=e.startTime+e.resumptionOffset;return Math.abs(n-r)>gc?(this.log(`"${e.identifier}" resumption ${n} not aligned with estimated timeline end ${r}`),!1):!Object.keys(t).some(r=>{let i=t[r].details,a=i.edge;if(n>=a)return this.log(`"${e.identifier}" resumption ${n} past ${r} playlist end ${a}`),!1;let o=Bt(null,i.fragments,n);if(!o)return this.log(`"${e.identifier}" resumption ${n} does not align with any fragments in ${r} playlist (${i.fragStart}-${i.fragmentEnd})`),!0;let s=r===`audio`?.175:0;return Math.abs(o.start-n)<gc+s||Math.abs(o.end-n)<gc+s?!1:(this.log(`"${e.identifier}" resumption ${n} not aligned with ${r} fragment bounds (${o.start}-${o.end} sn: ${o.sn} cc: ${o.cc})`),!0)})}updateAssetDurations(e){if(!e.assetListLoaded)return;let t=e.timelineStart,n=0,r=!1,i=!1;for(let a=0;a<e.assetList.length;a++){let o=e.assetList[a],s=t+n;o.startOffset=n,o.timelineStart=s,r||=o.duration===null,i||=!!o.error;let c=o.error?0:o.duration||0;n+=c}r&&!i?e.duration=Math.max(n,e.duration):e.duration=n}removeEvent(e){e.reset(),delete this.eventMap[e.identifier]}};function Oc(e){return`[${e.event?`"`+e.event.identifier+`"`:`primary`}: ${e.start.toFixed(2)}-${e.end.toFixed(2)}]`}var kc=class{constructor(e){this.hls=void 0,this.hls=e}destroy(){this.hls=null}loadAssetList(e,t){let n=e.assetListUrl,r;try{r=xc(n,this.hls.sessionId,e.baseUrl)}catch(t){let r=this.assignAssetListError(e,c.ASSET_LIST_LOAD_ERROR,t,n);this.hls.trigger(l.ERROR,r);return}t&&r.protocol!==`data:`&&r.searchParams.set(`_HLS_start_offset`,``+t);let i=this.hls.config,a=i.loader,o=new a(i),s={responseType:`json`,url:r.href},u=i.interstitialAssetListLoadPolicy.default,d={loadPolicy:u,timeout:u.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0};return o.load(s,d,{onSuccess:(t,n,r,i)=>{let a=t.data,o=a?.ASSETS;if(!Array.isArray(o)){let t=this.assignAssetListError(e,c.ASSET_LIST_PARSING_ERROR,Error(`Invalid interstitial asset list`),r.url,n,i);this.hls.trigger(l.ERROR,t);return}e.assetListResponse=a,this.hls.trigger(l.ASSET_LIST_LOADED,{event:e,assetListResponse:a,networkDetails:i})},onError:(t,n,r,i)=>{let a=this.assignAssetListError(e,c.ASSET_LIST_LOAD_ERROR,Error(`Error loading X-ASSET-LIST: HTTP status ${t.code} ${t.text} (${n.url})`),n.url,i,r);this.hls.trigger(l.ERROR,a)},onTimeout:(t,n,r)=>{let i=this.assignAssetListError(e,c.ASSET_LIST_LOAD_TIMEOUT,Error(`Timeout loading X-ASSET-LIST (${n.url})`),n.url,t,r);this.hls.trigger(l.ERROR,i)}}),this.hls.trigger(l.ASSET_LIST_LOADING,{event:e}),o}assignAssetListError(e,t,n,r,i,a){return e.error=n,{type:s.NETWORK_ERROR,details:t,fatal:!1,interstitial:e,url:r,error:n,networkDetails:a,stats:i}}};function Ac(e){var t;e==null||(t=e.play())==null||t.catch(()=>{})}function jc(e,t){return`[${e}] Advancing timeline position to ${t}`}var Mc=class extends b{constructor(e,t){super(`interstitials`,e.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=!1,this.onPlay=()=>{this.shouldPlay=!0},this.onPause=()=>{this.shouldPlay=!1},this.onSeeking=()=>{let e=this.currentTime;if(e===void 0||this.playbackDisabled||!this.schedule)return;let t=e-this.timelinePos;if(Math.abs(t)<1/7056e5)return;let n=t<=-.01;this.timelinePos=e,this.bufferedPos=e;let r=this.playingItem;if(!r){this.checkBuffer();return}if(n&&this.schedule.resetErrorsInRange(e,e-t)&&this.updateSchedule(!0),this.checkBuffer(),n&&e<r.start||e>=r.end){var i;let t=this.findItemIndex(r),a=this.schedule.findItemIndexAtTime(e);if(a===-1&&(a=t+(n?-1:1),this.log(`seeked ${n?`back `:``}to position not covered by schedule ${e} (resolving from ${t} to ${a})`)),!this.isInterstitial(r)&&(i=this.media)!=null&&i.paused&&(this.shouldPlay=!1),!n&&a>t){let e=this.schedule.findJumpRestrictedIndex(t+1,a);if(e>t){this.setSchedulePosition(e);return}}this.setSchedulePosition(a);return}let a=this.playingAsset;if(!a){if(this.playingLastItem&&this.isInterstitial(r)){let t=r.event.assetList[0];t&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(e,t))}return}let o=a.timelineStart,s=a.duration||0;if(n&&e<o||e>=o+s){var c;(c=r.event)!=null&&c.appendInPlace&&(this.clearAssetPlayers(r.event,r),this.flushFrontBuffer(e)),this.setScheduleToAssetAtTime(e,a)}},this.onTimeupdate=()=>{let e=this.currentTime;if(e===void 0||this.playbackDisabled)return;if(e>this.timelinePos)this.timelinePos=e,e>this.bufferedPos&&this.checkBuffer();else return;let t=this.playingItem;if(!t||this.playingLastItem)return;if(e>=t.end){this.timelinePos=t.end;let e=this.findItemIndex(t);this.setSchedulePosition(e+1)}let n=this.playingAsset;n&&e>=n.timelineStart+(n.duration||0)&&this.setScheduleToAssetAtTime(e,n)},this.onScheduleUpdate=(e,t)=>{let n=this.schedule;if(!n)return;let r=this.playingItem,i=n.events||[],a=n.items||[],o=n.durations,s=e.map(e=>e.identifier),c=!!(i.length||s.length);(c||t)&&this.log(`INTERSTITIALS_UPDATED (${i.length}): ${i}
Schedule: ${a.map(e=>Oc(e))} pos: ${this.timelinePos}`),s.length&&this.log(`Removed events ${s}`);let u=null,d=null;r&&(u=this.updateItem(r,this.timelinePos),this.itemsMatch(r,u)?this.playingItem=u:this.waitingItem=this.endedItem=null),this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);let f=this.bufferingItem;if(f&&(d=this.updateItem(f,this.bufferedPos),this.itemsMatch(f,d)?this.bufferingItem=d:f.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(f.event,null))),e.forEach(e=>{e.assetList.forEach(e=>{this.clearAssetPlayer(e.identifier,null)})}),this.playerQueue.forEach(e=>{if(e.interstitial.appendInPlace){let t=e.assetItem.timelineStart,n=e.timelineOffset-t;if(n)try{e.timelineOffset=t}catch(r){Math.abs(n)>gc&&this.warn(`${r} ("${e.assetId}" ${e.timelineOffset}->${t})`)}}}),c||t){if(this.hls.trigger(l.INTERSTITIALS_UPDATED,{events:i.slice(0),schedule:a.slice(0),durations:o,removedIds:s}),this.isInterstitial(r)&&s.includes(r.event.identifier)){this.warn(`Interstitial "${r.event.identifier}" removed while playing`),this.primaryFallback(r.event);return}r&&this.trimInPlace(u,r),f&&d!==u&&this.trimInPlace(d,f),this.checkBuffer()}},this.hls=e,this.HlsPlayerClass=t,this.assetListLoader=new kc(e),this.schedule=new Dc(this.onScheduleUpdate,e.logger),this.registerListeners()}registerListeners(){let e=this.hls;e&&(e.on(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(l.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(l.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.on(l.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(l.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.on(l.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.on(l.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.on(l.BUFFER_APPENDED,this.onBufferAppended,this),e.on(l.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(l.BUFFERED_TO_END,this.onBufferedToEnd,this),e.on(l.MEDIA_ENDED,this.onMediaEnded,this),e.on(l.ERROR,this.onError,this),e.on(l.DESTROYING,this.onDestroying,this))}unregisterListeners(){let e=this.hls;e&&(e.off(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(l.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(l.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.off(l.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(l.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.off(l.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.off(l.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.off(l.BUFFER_CODECS,this.onBufferCodecs,this),e.off(l.BUFFER_APPENDED,this.onBufferAppended,this),e.off(l.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(l.BUFFERED_TO_END,this.onBufferedToEnd,this),e.off(l.MEDIA_ENDED,this.onMediaEnded,this),e.off(l.ERROR,this.onError,this),e.off(l.DESTROYING,this.onDestroying,this))}startLoad(){this.resumeBuffering()}stopLoad(){this.pauseBuffering()}resumeBuffering(){var e;(e=this.getBufferingPlayer())==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.getBufferingPlayer())==null||e.pauseBuffering()}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.schedule=this.manager=null,this.hls=this.HlsPlayerClass=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null}onDestroying(){let e=this.primaryMedia||this.media;e&&this.removeMediaListeners(e)}removeMediaListeners(e){ei(e,`play`,this.onPlay),ei(e,`pause`,this.onPause),ei(e,`seeking`,this.onSeeking),ei(e,`timeupdate`,this.onTimeupdate)}onMediaAttaching(e,t){let n=this.media=t.media;$r(n,`seeking`,this.onSeeking),$r(n,`timeupdate`,this.onTimeupdate),$r(n,`play`,this.onPlay),$r(n,`pause`,this.onPause)}onMediaAttached(e,t){let n=this.effectivePlayingItem,r=this.detachedData;if(this.detachedData=null,n===null)this.checkStart();else if(!r){this.clearScheduleState();let e=this.findItemIndex(n);this.setSchedulePosition(e)}}clearScheduleState(){this.log(`clear schedule state`),this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null}onMediaDetaching(e,t){let n=!!t.transferMedia,r=this.media;if(this.media=null,!n&&(r&&this.removeMediaListeners(r),this.detachedData)){let e=this.getBufferingPlayer();e&&(this.log(`Removing schedule state for detachedData and ${e}`),this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,e.detachMedia()),this.shouldPlay=!1}}get interstitialsManager(){if(!this.hls)return null;if(this.manager)return this.manager;let e=this,t=()=>e.bufferingItem||e.waitingItem,n=t=>t&&e.getAssetPlayer(t.identifier),r=(t,r,i,o,s)=>{if(t){let c=t[r].start,l=t.event;if(l){if(r===`playout`||l.timelineOccupancy!==_c.Point){let e=n(i);e?.interstitial===l&&(c+=e.assetItem.startOffset+e[s])}}else{let n=o===`bufferedPos`?a():e[o];c+=n-t.start}return c}return 0},i=(t,n)=>{var r;if(t!==0&&n!==`primary`&&(r=e.schedule)!=null&&r.length){let r=e.schedule.findItemIndexAtTime(t),i=e.schedule.items?.[r];if(i)return t+(i[n].start-i.start)}return t},a=()=>{let t=e.bufferedPos;return t===Number.MAX_VALUE?o(`primary`):Math.max(t,0)},o=t=>{var n;return(n=e.primaryDetails)!=null&&n.live?e.primaryDetails.edge:e.schedule?.durations[t]||0},s=(t,i)=>{var a;let o=e.effectivePlayingItem;if(o!=null&&(a=o.event)!=null&&a.restrictions.skip||!e.schedule)return;e.log(`seek to ${t} "${i}"`);let s=e.effectivePlayingItem,c=e.schedule.findItemIndexAtTime(t,i),l=e.schedule.items?.[c],u=e.getBufferingPlayer(),d=u?.interstitial?.appendInPlace,f=s&&e.itemsMatch(s,l);if(s&&(d||f)){let a=n(e.playingAsset),o=a?.media||e.primaryMedia;if(o){let n=i===`primary`?o.currentTime:r(s,i,e.playingAsset,`timelinePos`,`currentTime`),c=t-n,l=(d?n:o.currentTime)+c;if(l>=0&&(!a||d||l<=a.duration)){o.currentTime=l;return}}}if(l){let n=t;if(i!==`primary`){let e=t-l[i].start;n=l.start+e}let r=!e.isInterstitial(l);if((!e.isInterstitial(s)||s.event.appendInPlace)&&(r||l.event.appendInPlace)){let t=e.media||(d?u?.media:null);t&&(t.currentTime=n)}else if(s){let a=e.findItemIndex(s);if(c>a){let t=e.schedule.findJumpRestrictedIndex(a+1,c);if(t>a){e.setSchedulePosition(t);return}}let o=0;if(r)e.timelinePos=n,e.checkBuffer();else{let e=l.event.assetList,n=t-(l[i]||l).start;for(let t=e.length;t--;){let r=e[t];if(r.duration&&n>=r.startOffset&&n<r.startOffset+r.duration){o=t;break}}}e.setSchedulePosition(c,o)}}},c=()=>{let n=e.effectivePlayingItem;if(e.isInterstitial(n))return n;let r=t();return e.isInterstitial(r)?r:null},l={get bufferedEnd(){let n=t(),i=e.bufferingItem;return i&&i===n&&(r(i,`playout`,e.bufferingAsset,`bufferedPos`,`bufferedEnd`)-i.playout.start||e.bufferingAsset?.startOffset)||0},get currentTime(){let t=c(),n=e.effectivePlayingItem;return n&&n===t?r(n,`playout`,e.effectivePlayingAsset,`timelinePos`,`currentTime`)-n.playout.start:0},set currentTime(t){let n=c(),r=e.effectivePlayingItem;r&&r===n&&s(t+r.playout.start,`playout`)},get duration(){let e=c();return e?e.playout.end-e.playout.start:0},get assetPlayers(){let t=c()?.event.assetList;return t?t.map(t=>e.getAssetPlayer(t.identifier)):[]},get playingIndex(){let t=c()?.event;return t&&e.effectivePlayingAsset?t.findAssetIndex(e.effectivePlayingAsset):-1},get scheduleItem(){return c()}};return this.manager={get events(){var t;return((t=e.schedule)==null||(t=t.events)==null?void 0:t.slice(0))||[]},get schedule(){var t;return((t=e.schedule)==null||(t=t.items)==null?void 0:t.slice(0))||[]},get interstitialPlayer(){return c()?l:null},get playerQueue(){return e.playerQueue.slice(0)},get bufferingAsset(){return e.bufferingAsset},get bufferingItem(){return t()},get bufferingIndex(){let n=t();return e.findItemIndex(n)},get playingAsset(){return e.effectivePlayingAsset},get playingItem(){return e.effectivePlayingItem},get playingIndex(){let t=e.effectivePlayingItem;return e.findItemIndex(t)},primary:{get bufferedEnd(){return a()},get currentTime(){let t=e.timelinePos;return t>0?t:0},set currentTime(e){s(e,`primary`)},get duration(){return o(`primary`)},get seekableStart(){return e.primaryDetails?.fragmentStart||0}},integrated:{get bufferedEnd(){return r(t(),`integrated`,e.bufferingAsset,`bufferedPos`,`bufferedEnd`)},get currentTime(){return r(e.effectivePlayingItem,`integrated`,e.effectivePlayingAsset,`timelinePos`,`currentTime`)},set currentTime(e){s(e,`integrated`)},get duration(){return o(`integrated`)},get seekableStart(){return i(e.primaryDetails?.fragmentStart||0,`integrated`)}},skip:()=>{let t=e.effectivePlayingItem,n=t?.event;if(n&&!n.restrictions.skip){let r=e.findItemIndex(t);n.appendInPlace?s(t.playout.start+t.event.duration+.001,`playout`):e.advanceAfterAssetEnded(n,r,1/0)}}}}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){let e=this.playingItem,t=this.schedule?.items;return!this.playbackStarted||!e||!t?!1:this.findItemIndex(e)===t.length-1}get playbackStarted(){return this.effectivePlayingItem!==null}get currentTime(){var e;if(this.mediaSelection===null)return;let t=this.waitingItem||this.playingItem;if(this.isInterstitial(t)&&!t.event.appendInPlace)return;let n=this.media;!n&&(e=this.bufferingItem)!=null&&(e=e.event)!=null&&e.appendInPlace&&(n=this.primaryMedia);let r=n?.currentTime;if(!(r===void 0||!i(r)))return r}get primaryMedia(){return this.media||this.detachedData?.media||null}isInterstitial(e){return!!(e!=null&&e.event)}retreiveMediaSource(e,t){let n=this.getAssetPlayer(e);n&&this.transferMediaFromPlayer(n,t)}transferMediaFromPlayer(e,t){let n=e.interstitial.appendInPlace,r=e.media;if(n&&r===this.primaryMedia){if(this.bufferingAsset=null,(!t||this.isInterstitial(t)&&!t.event.appendInPlace)&&t&&r){this.detachedData={media:r};return}let n=e.transferMedia();this.log(`transfer MediaSource from ${e} ${q(n)}`),this.detachedData=n}else t&&r&&(this.shouldPlay||=!r.paused)}transferMediaTo(e,t){if(e.media===t)return;let n=null,r=this.hls,i=e!==r,a=i&&e.interstitial.appendInPlace,o=this.detachedData?.mediaSource,s;if(r.media)a&&(n=r.transferMedia(),this.detachedData=n),s=`Primary`;else if(o){let e=this.getBufferingPlayer();e?(n=e.transferMedia(),s=`${e}`):s=`detached MediaSource`}else s=`detached media`;if(!n){if(o)n=this.detachedData,this.log(`using detachedData: MediaSource ${q(n)}`);else if(!this.detachedData||r.media===t){let e=this.playerQueue;e.length>1&&e.forEach(e=>{if(i&&e.interstitial.appendInPlace!==a){let t=e.interstitial;this.clearInterstitial(e.interstitial,null),t.appendInPlace=!1,t.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${t}`)}}),this.hls.detachMedia(),this.detachedData={media:t}}}let c=n&&`mediaSource`in n&&n.mediaSource?.readyState!==`closed`,l=c&&n?n:t;this.log(`${c?`transfering MediaSource`:`attaching media`} to ${i?e:`Primary`} from ${s} (media.currentTime: ${t.currentTime})`);let u=this.schedule;if(l===n&&u){let t=i&&e.assetId===u.assetIdAtEnd;l.overrides={duration:u.duration,endOfStream:!i||t,cueRemoval:!i}}e.attachMedia(l)}onInterstitialCueEnter(){this.onTimeupdate()}checkStart(){let e=this.schedule,t=e?.events;if(!t||this.playbackDisabled||!this.media)return;this.bufferedPos===-1&&(this.bufferedPos=0);let n=this.timelinePos,r=this.effectivePlayingItem;if(n===-1){let n=this.hls.startPosition;if(this.log(jc(`checkStart`,n)),this.timelinePos=n,t.length&&t[0].cue.pre){let n=e.findEventIndex(t[0].identifier);this.setSchedulePosition(n)}else if(n>=0||!this.primaryLive){let t=this.timelinePos=n>0?n:0,r=e.findItemIndexAtTime(t);this.setSchedulePosition(r)}}else if(r&&!this.playingItem){let t=e.findItemIndex(r);this.setSchedulePosition(t)}}advanceAssetBuffering(e,t){let n=e.event,r=Sc(n,n.findAssetIndex(t));if(!n.isAssetPastPlayoutLimit(r))this.bufferedToEvent(e,r);else if(this.schedule){let t=this.schedule.items?.[this.findItemIndex(e)+1];t&&this.bufferedToItem(t)}}advanceAfterAssetEnded(e,t,n){let r=Sc(e,n);if(e.isAssetPastPlayoutLimit(r)){if(this.schedule){let n=this.schedule.items;if(n){let r=t+1;if(r>=n.length){this.setSchedulePosition(-1);return}let i=e.resumeTime;this.timelinePos<i&&(this.log(jc(`advanceAfterAssetEnded`,i)),this.timelinePos=i,e.appendInPlace&&this.advanceInPlace(i),this.checkBuffer(this.bufferedPos<i)),this.setSchedulePosition(r)}}}else{if(e.appendInPlace){let t=e.assetList[r];t&&this.advanceInPlace(t.timelineStart)}this.setSchedulePosition(t,r)}}setScheduleToAssetAtTime(e,t){let n=this.schedule;if(!n)return;let r=t.parentIdentifier,i=n.getEvent(r);if(i){let t=n.findEventIndex(r),a=n.findAssetIndex(i,e);this.advanceAfterAssetEnded(i,t,a-1)}}setSchedulePosition(e,t){let n=this.schedule?.items;if(!n||this.playbackDisabled)return;let r=e>=0?n[e]:null;this.log(`setSchedulePosition ${e}, ${t} (${r&&Oc(r)}) pos: ${this.timelinePos}`);let i=this.waitingItem||this.playingItem,a=this.playingLastItem;if(this.isInterstitial(i)){let s=i.event,c=this.playingAsset,u=c?.identifier,d=u?this.getAssetPlayer(u):null;if(d&&u&&(!this.eventItemsMatch(i,r)||t!==void 0&&u!==s.assetList[t].identifier)){var o;let t=s.findAssetIndex(c);if(this.log(`INTERSTITIAL_ASSET_ENDED ${t+1}/${s.assetList.length} ${wc(c)}`),this.endedAsset=c,this.playingAsset=null,this.hls.trigger(l.INTERSTITIAL_ASSET_ENDED,{asset:c,assetListIndex:t,event:s,schedule:n.slice(0),scheduleIndex:e,player:d}),i!==this.playingItem){this.itemsMatch(i,this.playingItem)&&!this.playingAsset&&this.advanceAfterAssetEnded(s,this.findItemIndex(this.playingItem),t);return}this.retreiveMediaSource(u,r),d.media&&!((o=this.detachedData)!=null&&o.mediaSource)&&d.detachMedia()}if(!this.eventItemsMatch(i,r)&&(this.endedItem=i,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${s} ${Oc(i)}`),s.hasPlayed=!0,this.hls.trigger(l.INTERSTITIAL_ENDED,{event:s,schedule:n.slice(0),scheduleIndex:e}),s.cue.once)){this.updateSchedule();let e=this.schedule?.items;if(r&&e){let n=this.findItemIndex(r);this.advanceSchedule(n,e,t,i,a)}return}}this.advanceSchedule(e,n,t,i,a)}advanceSchedule(e,t,n,r,i){let a=this.schedule;if(!a)return;let o=t[e]||null,s=this.primaryMedia,c=this.playerQueue;if(c.length&&c.forEach(t=>{let n=t.interstitial,r=a.findEventIndex(n.identifier);(r<e||r>e+1)&&this.clearInterstitial(n,o)}),this.isInterstitial(o)){this.timelinePos=Math.min(Math.max(this.timelinePos,o.start),o.end);let i=o.event;if(n===void 0){n=a.findAssetIndex(i,this.timelinePos);let t=Sc(i,n-1);if(i.isAssetPastPlayoutLimit(t)||i.appendInPlace&&this.timelinePos===o.end){this.advanceAfterAssetEnded(i,e,n);return}n=t}let c=this.waitingItem;this.assetsBuffered(o,s)||this.setBufferingItem(o);let u=this.preloadAssets(i,n);if(this.eventItemsMatch(o,c||r)||(this.waitingItem=o,this.log(`INTERSTITIAL_STARTED ${Oc(o)} ${i.appendInPlace?`append in place`:``}`),this.hls.trigger(l.INTERSTITIAL_STARTED,{event:i,schedule:t.slice(0),scheduleIndex:e})),!i.assetListLoaded){this.log(`Waiting for ASSET-LIST to complete loading ${i}`);return}if(i.assetListLoader&&=(i.assetListLoader.destroy(),void 0),!s){this.log(`Waiting for attachMedia to start Interstitial ${i}`);return}this.waitingItem=this.endedItem=null,this.playingItem=o;let d=i.assetList[n];if(!d){this.advanceAfterAssetEnded(i,e,n||0);return}if(u||=this.getAssetPlayer(d.identifier),u===null||u.destroyed){let e=i.assetList.length;this.warn(`asset ${n+1}/${e} player destroyed ${i}`),u=this.createAssetPlayer(i,d,n),u.loadSource()}if(!this.eventItemsMatch(o,this.bufferingItem)&&i.appendInPlace&&this.isAssetBuffered(d))return;this.startAssetPlayer(u,n,t,e,s),this.shouldPlay&&Ac(u.media)}else o?(this.resumePrimary(o,e,r),this.shouldPlay&&Ac(this.hls.media)):i&&this.isInterstitial(r)&&(this.endedItem=null,this.playingItem=r,r.event.appendInPlace||this.attachPrimary(a.durations.primary,null))}get playbackDisabled(){return this.hls.config.enableInterstitialPlayback===!1}get primaryDetails(){return this.mediaSelection?.main.details}get primaryLive(){var e;return!!((e=this.primaryDetails)!=null&&e.live)}resumePrimary(e,t,n){var r;if(this.playingItem=e,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(e),this.log(`resuming ${Oc(e)}`),!((r=this.detachedData)!=null&&r.mediaSource)){let n=this.timelinePos;(n<e.start||n>=e.end)&&(n=this.getPrimaryResumption(e,t),this.log(jc(`resumePrimary`,n)),this.timelinePos=n),this.attachPrimary(n,e)}if(!n)return;let i=this.schedule?.items;i&&(this.log(`INTERSTITIALS_PRIMARY_RESUMED ${Oc(e)}`),this.hls.trigger(l.INTERSTITIALS_PRIMARY_RESUMED,{schedule:i.slice(0),scheduleIndex:t}),this.checkBuffer())}getPrimaryResumption(e,t){let n=e.start;if(this.primaryLive){let e=this.primaryDetails;if(t===0)return this.hls.startPosition;if(e&&(n<e.fragmentStart||n>e.edge))return this.hls.liveSyncPosition||-1}return n}isAssetBuffered(e){let t=this.getAssetPlayer(e.identifier);return t!=null&&t.hls?t.hls.bufferedToEnd:J.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=e.timelineStart+(e.duration||0)}attachPrimary(e,t,n){t?this.setBufferingItem(t):this.bufferingItem=this.playingItem,this.bufferingAsset=null;let r=this.primaryMedia;if(!r)return;let i=this.hls;i.media?this.checkBuffer():(this.transferMediaTo(i,r),n&&this.startLoadingPrimaryAt(e,n)),n||(this.log(jc(`attachPrimary`,e)),this.timelinePos=e,this.startLoadingPrimaryAt(e,n))}startLoadingPrimaryAt(e,t){let n=this.hls;!n.loadingEnabled||!n.media||Math.abs((n.mainForwardBufferInfo?.start||n.media.currentTime)-e)>.5?n.startLoad(e,t):n.bufferingEnabled||n.resumeBuffering()}onManifestLoading(){var e;this.stopLoad(),(e=this.schedule)==null||e.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(l.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(l.BUFFER_CODECS,this.onBufferCodecs,this)}onLevelUpdated(e,t){if(t.level===-1||!this.schedule)return;let n=this.hls.levels[t.level];if(!n.details)return;let r=_(_({},this.mediaSelection||this.altSelection),{},{main:n});this.mediaSelection=r,this.schedule.parseInterstitialDateRanges(r,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}onAudioTrackUpdated(e,t){let n=this.hls.audioTracks[t.id],r=this.mediaSelection;if(!r){this.altSelection=_(_({},this.altSelection),{},{audio:n});return}this.mediaSelection=_(_({},r),{},{audio:n})}onSubtitleTrackUpdated(e,t){let n=this.hls.subtitleTracks[t.id],r=this.mediaSelection;if(!r){this.altSelection=_(_({},this.altSelection),{},{subtitles:n});return}this.mediaSelection=_(_({},r),{},{subtitles:n})}onAudioTrackSwitching(e,t){let n=Ot(t);this.playerQueue.forEach(({hls:e})=>e&&(e.setAudioOption(t)||e.setAudioOption(n)))}onSubtitleTrackSwitch(e,t){let n=Ot(t);this.playerQueue.forEach(({hls:e})=>e&&(e.setSubtitleOption(t)||t.id!==-1&&e.setSubtitleOption(n)))}onBufferCodecs(e,t){let n=t.tracks;n&&(this.requiredTracks=n)}onBufferAppended(e,t){this.checkBuffer()}onBufferFlushed(e,t){let n=this.playingItem;n&&!this.itemsMatch(n,this.bufferingItem)&&!this.isInterstitial(n)&&(this.bufferedPos=this.timelinePos,this.checkBuffer())}onBufferedToEnd(e){if(!this.schedule)return;let t=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&t){for(let e=0;e<t.length;e++){let n=t[e];if(n.cue.post){let e=this.schedule.findEventIndex(n.identifier),t=this.schedule.items?.[e];this.isInterstitial(t)&&this.eventItemsMatch(t,this.bufferingItem)&&this.bufferedToItem(t,0);break}}this.bufferedPos=Number.MAX_VALUE}}onMediaEnded(e){let t=this.playingItem;if(!this.playingLastItem&&t){let e=this.findItemIndex(t);this.setSchedulePosition(e+1)}else this.shouldPlay=!1}updateItem(e,t){let n=this.schedule?.items;return e&&n&&n[this.findItemIndex(e,t)]||null}trimInPlace(e,t){if(this.isInterstitial(e)&&e.event.appendInPlace&&t.end-e.end>.25){e.event.assetList.forEach((t,n)=>{e.event.isAssetPastPlayoutLimit(n)&&this.clearAssetPlayer(t.identifier,null)});let n=e.end+.25,r=J.bufferInfo(this.primaryMedia,n,0);(r.end>n||(r.nextStart||0)>n)&&(this.log(`trim buffered interstitial ${Oc(e)} (was ${Oc(t)})`),this.attachPrimary(n,null,!0),this.flushFrontBuffer(n))}}itemsMatch(e,t){return!!t&&(e===t||e.event&&t.event&&this.eventItemsMatch(e,t)||!e.event&&!t.event&&this.findItemIndex(e)===this.findItemIndex(t))}eventItemsMatch(e,t){return!!t&&(e===t||e.event.identifier===t.event?.identifier)}findItemIndex(e,t){return e&&this.schedule?this.schedule.findItemIndex(e,t):-1}updateSchedule(e=!1){var t;let n=this.mediaSelection;n&&((t=this.schedule)==null||t.updateSchedule(n,[],e))}checkBuffer(e){let t=this.schedule?.items;if(!t)return;let n=J.bufferInfo(this.primaryMedia,this.timelinePos,0);e&&(this.bufferedPos=this.timelinePos),e||=n.len<1,this.updateBufferedPos(n.end,t,e)}updateBufferedPos(e,t,n){let r=this.schedule,i=this.bufferingItem;if(this.bufferedPos>e||!r)return;if(t.length===1&&this.itemsMatch(t[0],i)){this.bufferedPos=e;return}let a=this.playingItem,o=this.findItemIndex(a),s=r.findItemIndexAtTime(e);if(this.bufferedPos<e){var c;let n=this.findItemIndex(i),r=Math.min(n+1,t.length-1),a=t[r];if((s===-1&&i&&e>=i.end||(c=a.event)!=null&&c.appendInPlace&&e+.01>=a.start)&&(s=r),this.isInterstitial(i)){let e=i.event;if(r-o>1&&e.appendInPlace===!1||e.assetList.length===0&&e.assetListLoader)return}if(this.bufferedPos=e,s>n&&s>o)this.bufferedToItem(a);else{let t=this.primaryDetails;this.primaryLive&&t&&e>t.edge-t.targetduration&&a.start<t.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(a)&&this.preloadAssets(a.event,0)}}else n&&a&&!this.itemsMatch(a,i)&&(s===o?this.bufferedToItem(a):s===o+1&&this.bufferedToItem(t[s]))}assetsBuffered(e,t){return e.event.assetList.length===0?!1:!e.event.assetList.some(e=>{let n=this.getAssetPlayer(e.identifier);return!(n!=null&&n.bufferedInPlaceToEnd(t))})}setBufferingItem(e){let t=this.bufferingItem,n=this.schedule;if(!this.itemsMatch(e,t)&&n){let{items:r,events:i}=n;if(!r||!i)return t;let a=this.isInterstitial(e),o=this.getBufferingPlayer();this.bufferingItem=e,this.bufferedPos=Math.max(e.start,Math.min(e.end,this.timelinePos));let s=o?o.remaining:t?t.end-this.timelinePos:0;if(this.log(`INTERSTITIALS_BUFFERED_TO_BOUNDARY ${Oc(e)}`+(t?` (${s.toFixed(2)} remaining)`:``)),!this.playbackDisabled)if(a){let t=n.findAssetIndex(e.event,this.bufferedPos);e.event.assetList.forEach((e,n)=>{let r=this.getAssetPlayer(e.identifier);r&&(n===t&&r.loadSource(),r.resumeBuffering())})}else this.hls.resumeBuffering(),this.playerQueue.forEach(e=>e.pauseBuffering());this.hls.trigger(l.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:i.slice(0),schedule:r.slice(0),bufferingIndex:this.findItemIndex(e),playingIndex:this.findItemIndex(this.playingItem)})}else this.bufferingItem!==e&&(this.bufferingItem=e);return t}bufferedToItem(e,t=0){let n=this.setBufferingItem(e);if(!this.playbackDisabled){if(this.isInterstitial(e))this.bufferedToEvent(e,t);else if(n!==null){this.bufferingAsset=null;let t=this.detachedData;t&&t.mediaSource?this.attachPrimary(e.start,e,!0):this.preloadPrimary(e)}}}preloadPrimary(e){let t=this.findItemIndex(e),n=this.getPrimaryResumption(e,t);this.startLoadingPrimaryAt(n)}bufferedToEvent(e,t){let n=e.event,r=n.assetList.length===0&&!n.assetListLoader,i=n.cue.once;if(r||!i){let e=this.preloadAssets(n,t);if(e!=null&&e.interstitial.appendInPlace){let t=this.primaryMedia;t&&this.bufferAssetPlayer(e,t)}}}preloadAssets(e,t){let n=e.assetUrl,r=e.assetList.length,i=r===0&&!e.assetListLoader,a=e.cue.once;if(i){let i=e.timelineStart;if(e.appendInPlace){var o;let t=this.playingItem;!this.isInterstitial(t)&&(t==null||(o=t.nextEvent)==null?void 0:o.identifier)===e.identifier&&this.flushFrontBuffer(i+.25)}let a,s=0;if(!this.playingItem&&this.primaryLive&&(s=this.hls.startPosition,s===-1&&(s=this.hls.liveSyncPosition||0)),s&&!(e.cue.pre||e.cue.post)){let e=s-i;e>0&&(a=Math.round(e*1e3)/1e3)}if(this.log(`Load interstitial asset ${t+1}/${n?1:r} ${e}${a?` live-start: ${s} start-offset: ${a}`:``}`),n)return this.createAsset(e,0,0,i,e.duration,n);let c=this.assetListLoader.loadAssetList(e,a);c&&(e.assetListLoader=c)}else if(!a&&r){for(let n=t;n<r;n++){let t=e.assetList[n],r=this.getAssetPlayerQueueIndex(t.identifier);(r===-1||this.playerQueue[r].destroyed)&&!t.error&&this.createAssetPlayer(e,t,n)}let n=e.assetList[t];if(n){let e=this.getAssetPlayer(n.identifier);return e&&e.loadSource(),e}}return null}flushFrontBuffer(e){let t=this.requiredTracks;t&&(this.log(`Removing front buffer starting at ${e}`),Object.keys(t).forEach(t=>{this.hls.trigger(l.BUFFER_FLUSHING,{startOffset:e,endOffset:1/0,type:t})}))}getAssetPlayerQueueIndex(e){let t=this.playerQueue;for(let n=0;n<t.length;n++)if(e===t[n].assetId)return n;return-1}getAssetPlayer(e){let t=this.getAssetPlayerQueueIndex(e);return this.playerQueue[t]||null}getBufferingPlayer(){let{playerQueue:e,primaryMedia:t}=this;if(t){for(let n=0;n<e.length;n++)if(e[n].media===t)return e[n]}return null}createAsset(e,t,n,r,i,a){let o={parentIdentifier:e.identifier,identifier:vc(e,a,t),duration:i,startOffset:n,timelineStart:r,uri:a};return this.createAssetPlayer(e,o,t)}createAssetPlayer(e,t,n){let r=this.hls,i=r.userConfig,a=i.videoPreference,o=r.loadLevelObj||r.levels[r.currentLevel];(a||o)&&(a=h({},a),o.videoCodec&&(a.videoCodec=o.videoCodec),o.videoRange&&(a.allowedVideoRanges=[o.videoRange]));let u=r.audioTracks[r.audioTrack],d=r.subtitleTracks[r.subtitleTrack],f=0;if(this.primaryLive||e.appendInPlace){let e=this.timelinePos-t.timelineStart;if(e>1){let n=t.duration;n&&e<n&&(f=e)}}let p=t.identifier,m=_(_({},i),{},{maxMaxBufferLength:Math.min(180,r.config.maxMaxBufferLength),autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:r.sessionId,assetPlayerId:p,abrEwmaDefaultEstimate:r.bandwidthEstimate,interstitialsController:void 0,startPosition:f,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:a,audioPreference:u||i.audioPreference,subtitlePreference:d||i.subtitlePreference});e.appendInPlace&&(e.appendInPlaceStarted=!0,t.timelineStart&&(m.timelineOffset=t.timelineStart));let g=m.cmcd;g!=null&&g.sessionId&&g.contentId&&(m.cmcd=h({},g,{contentId:hc(t.uri)})),this.getAssetPlayer(p)&&this.warn(`Duplicate date range identifier ${e} and asset ${p}`);let v=new Tc(this.HlsPlayerClass,m,e,t);this.playerQueue.push(v),e.assetList[n]=t;let y=!0,b=r=>{if(r.live){let t=Error(`Interstitials MUST be VOD assets ${e}`),r={fatal:!0,type:s.OTHER_ERROR,details:c.INTERSTITIAL_ASSET_ITEM_ERROR,error:t},i=this.schedule?.findEventIndex(e.identifier)||-1;this.handleAssetItemError(r,e,i,n,t.message);return}let i=r.edge-r.fragmentStart,a=t.duration;(y||a===null||i>a)&&(y=!1,this.log(`Interstitial asset "${p}" duration change ${a} > ${i}`),t.duration=i,this.updateSchedule())};v.on(l.LEVEL_UPDATED,(e,{details:t})=>b(t)),v.on(l.LEVEL_PTS_UPDATED,(e,{details:t})=>b(t)),v.on(l.EVENT_CUE_ENTER,()=>this.onInterstitialCueEnter());let x=(e,t)=>{let n=this.getAssetPlayer(p);if(n&&t.tracks){n.off(l.BUFFER_CODECS,x),n.tracks=t.tracks;let e=this.primaryMedia;this.bufferingAsset===n.assetItem&&e&&!n.media&&this.bufferAssetPlayer(n,e)}};v.on(l.BUFFER_CODECS,x),v.on(l.BUFFERED_TO_END,()=>{let n=this.getAssetPlayer(p);if(this.log(`buffered to end of asset ${n}`),!n||!this.schedule)return;let r=this.schedule.findEventIndex(e.identifier),i=this.schedule.items?.[r];this.isInterstitial(i)&&this.advanceAssetBuffering(i,t)});let S=t=>()=>{if(!this.getAssetPlayer(p)||!this.schedule)return;this.shouldPlay=!0;let n=this.schedule.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,n,t)};return v.once(l.MEDIA_ENDED,S(n)),v.once(l.PLAYOUT_LIMIT_REACHED,S(1/0)),v.on(l.ERROR,(t,r)=>{if(!this.schedule)return;let i=this.getAssetPlayer(p);if(r.details===c.BUFFER_STALLED_ERROR){if(i!=null&&i.appendInPlace){this.handleInPlaceStall(e);return}this.onTimeupdate(),this.checkBuffer(!0);return}this.handleAssetItemError(r,e,this.schedule.findEventIndex(e.identifier),n,`Asset player error ${r.error} ${e}`)}),v.on(l.DESTROYING,()=>{if(!this.getAssetPlayer(p)||!this.schedule)return;let t=Error(`Asset player destroyed unexpectedly ${p}`),r={fatal:!0,type:s.OTHER_ERROR,details:c.INTERSTITIAL_ASSET_ITEM_ERROR,error:t};this.handleAssetItemError(r,e,this.schedule.findEventIndex(e.identifier),n,t.message)}),this.log(`INTERSTITIAL_ASSET_PLAYER_CREATED ${wc(t)}`),this.hls.trigger(l.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:t,assetListIndex:n,event:e,player:v}),v}clearInterstitial(e,t){this.clearAssetPlayers(e,t),e.reset()}clearAssetPlayers(e,t){e.assetList.forEach(e=>{this.clearAssetPlayer(e.identifier,t)})}resetAssetPlayer(e){let t=this.getAssetPlayerQueueIndex(e);if(t!==-1){this.log(`reset asset player "${e}" after error`);let n=this.playerQueue[t];this.transferMediaFromPlayer(n,null),n.resetDetails()}}clearAssetPlayer(e,t){let n=this.getAssetPlayerQueueIndex(e);if(n!==-1){let e=this.playerQueue[n];this.log(`clear ${e} toSegment: ${t&&Oc(t)}`),this.transferMediaFromPlayer(e,t),this.playerQueue.splice(n,1),e.destroy()}}emptyPlayerQueue(){let e;for(;e=this.playerQueue.pop();)e.destroy();this.playerQueue=[]}startAssetPlayer(e,t,n,r,i){let{interstitial:a,assetItem:o,assetId:s}=e,c=a.assetList.length,u=this.playingAsset;this.endedAsset=null,this.playingAsset=o,(!u||u.identifier!==s)&&(u&&(this.clearAssetPlayer(u.identifier,n[r]),delete u.error),this.log(`INTERSTITIAL_ASSET_STARTED ${t+1}/${c} ${wc(o)}`),this.hls.trigger(l.INTERSTITIAL_ASSET_STARTED,{asset:o,assetListIndex:t,event:a,schedule:n.slice(0),scheduleIndex:r,player:e})),this.bufferAssetPlayer(e,i)}bufferAssetPlayer(e,t){if(!this.schedule)return;let{interstitial:n,assetItem:r}=e,i=this.schedule.findEventIndex(n.identifier),a=this.schedule.items?.[i];if(!a)return;e.loadSource(),this.setBufferingItem(a),this.bufferingAsset=r;let o=this.getBufferingPlayer();if(o===e)return;let l=n.appendInPlace;if(l&&o?.interstitial.appendInPlace===!1)return;let u=o?.tracks||this.detachedData?.tracks||this.requiredTracks;if(l&&r!==this.playingAsset){if(!e.tracks){this.log(`Waiting for track info before buffering ${e}`);return}if(u&&!j(u,e.tracks)){let t=Error(`Asset ${wc(r)} SourceBuffer tracks ('${Object.keys(e.tracks)}') are not compatible with primary content tracks ('${Object.keys(u)}')`),a={fatal:!0,type:s.OTHER_ERROR,details:c.INTERSTITIAL_ASSET_ITEM_ERROR,error:t},o=n.findAssetIndex(r);this.handleAssetItemError(a,n,i,o,t.message);return}}this.transferMediaTo(e,t)}handleInPlaceStall(e){let t=this.schedule,n=this.primaryMedia;if(!t||!n)return;let r=n.currentTime,i=t.findAssetIndex(e,r),a=e.assetList[i];if(a){let o=this.getAssetPlayer(a.identifier);if(o){let s=o.currentTime||r-a.timelineStart,c=o.duration-s;if(this.warn(`Stalled at ${s} of ${s+c} in ${o} ${e} (media.currentTime: ${r})`),s&&(c/n.playbackRate<.5||o.bufferedInPlaceToEnd(n))&&o.hls){let n=t.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,n,i)}}}}advanceInPlace(e){let t=this.primaryMedia;t&&t.currentTime<e&&(t.currentTime=e)}handleAssetItemError(e,t,n,r,i){if(e.details===c.BUFFER_STALLED_ERROR)return;let a=t.assetList[r]||null;if(this.warn(`INTERSTITIAL_ASSET_ERROR ${a&&wc(a)} ${e.error}`),!this.schedule)return;let o=a?.identifier||``,s=this.getAssetPlayerQueueIndex(o),u=this.playerQueue[s]||null,d=this.schedule.items,f=h({},e,{fatal:!1,errorAction:rn(!0),asset:a,assetListIndex:r,event:t,schedule:d,scheduleIndex:n,player:u});if(this.hls.trigger(l.INTERSTITIAL_ASSET_ERROR,f),!e.fatal)return;let p=this.playingAsset,m=this.bufferingAsset,g=Error(i);if(a&&(this.clearAssetPlayer(o,null),a.error=g),!t.assetList.some(e=>!e.error))t.error=g;else for(let e=r;e<t.assetList.length;e++)this.resetAssetPlayer(t.assetList[e].identifier);this.updateSchedule(!0),t.error?this.primaryFallback(t):p&&p.identifier===o?this.advanceAfterAssetEnded(t,n,r):m&&m.identifier===o&&this.isInterstitial(this.bufferingItem)&&this.advanceAssetBuffering(this.bufferingItem,m)}primaryFallback(e){let t=e.timelineStart,n=this.effectivePlayingItem,r=this.timelinePos;if(n){this.log(`Fallback to primary from event "${e.identifier}" start: ${t} pos: ${r} playing: ${Oc(n)} error: ${e.error}`),r===-1&&(r=this.hls.startPosition);let i=this.updateItem(n,r);this.itemsMatch(n,i)&&this.clearInterstitial(e,null),e.appendInPlace&&(this.attachPrimary(t,null),this.flushFrontBuffer(t))}else if(r===-1){this.checkStart();return}if(!this.schedule)return;let i=this.schedule.findItemIndexAtTime(r);this.setSchedulePosition(i)}onAssetListLoaded(e,t){var n;let r=t.event,i=r.identifier,a=t.assetListResponse.ASSETS;if(!((n=this.schedule)!=null&&n.hasEvent(i)))return;let o=r.timelineStart,s=r.duration,c=0;a.forEach((e,t)=>{let n=parseFloat(e.DURATION);this.createAsset(r,t,c,o+c,n,e.URI),c+=n}),r.duration=c,this.log(`Loaded asset-list with duration: ${c} (was: ${s}) ${r}`);let l=this.waitingItem?.event.identifier===i;this.updateSchedule();let u=this.bufferingItem?.event;if(l){let e=this.schedule.findEventIndex(i),t=this.schedule.items?.[e];if(t){if(!this.playingItem&&this.timelinePos>t.end&&this.schedule.findItemIndexAtTime(this.timelinePos)!==e){r.error=Error(`Interstitial ${a.length?`no longer within playback range`:`asset-list is empty`} ${this.timelinePos} ${r}`),this.log(r.error.message),this.updateSchedule(!0),this.primaryFallback(r);return}this.setBufferingItem(t)}this.setSchedulePosition(e)}else if(u?.identifier===i){let e=r.assetList[0];if(e){let t=this.getAssetPlayer(e.identifier);if(u.appendInPlace){let e=this.primaryMedia;t&&e&&this.bufferAssetPlayer(t,e)}else t&&t.loadSource()}}}onError(e,t){if(this.schedule)switch(t.details){case c.ASSET_LIST_PARSING_ERROR:case c.ASSET_LIST_LOAD_ERROR:case c.ASSET_LIST_LOAD_TIMEOUT:{let e=t.interstitial;e&&(this.updateSchedule(!0),this.primaryFallback(e));break}case c.BUFFER_STALLED_ERROR:{let e=this.endedItem||this.waitingItem||this.playingItem;if(this.isInterstitial(e)&&e.event.appendInPlace){this.handleInPlaceStall(e.event);return}this.log(`Primary player stall @${this.timelinePos} bufferedPos: ${this.bufferedPos}`),this.onTimeupdate(),this.checkBuffer(!0);break}}}},Nc=500,Pc=class extends ni{constructor(e,t,n){super(e,t,n,`subtitle-stream-controller`,d.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}registerListeners(){super.registerListeners();let{hls:e}=this;e.on(l.LEVEL_LOADED,this.onLevelLoaded,this),e.on(l.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(l.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(l.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(l.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(l.BUFFER_FLUSHING,this.onBufferFlushing,this)}unregisterListeners(){super.unregisterListeners();let{hls:e}=this;e.off(l.LEVEL_LOADED,this.onLevelLoaded,this),e.off(l.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(l.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(l.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(l.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(l.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(e,t){this.stopLoad(),this.state=X.IDLE,this.setInterval(Nc),this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null}onMediaDetaching(e,t){this.tracksBuffered=[],super.onMediaDetaching(e,t)}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){let{frag:n,success:r}=t;if(this.fragContextChanged(n)||(H(n)&&(this.fragPrevious=n),this.state=X.IDLE),!r)return;let i=this.tracksBuffered[this.currentTrackId];if(!i)return;let a,o=n.start;for(let e=0;e<i.length;e++)if(o>=i[e].start&&o<=i[e].end){a=i[e];break}let s=n.start+n.duration;a?a.end=s:(a={start:o,end:s},i.push(a)),this.fragmentTracker.fragBuffered(n),this.fragBufferedComplete(n,null),this.media&&this.tick()}onBufferFlushing(e,t){let{startOffset:n,endOffset:r}=t;if(n===0&&r!==1/0){let e=r-1;if(e<=0)return;t.endOffsetSubtitles=Math.max(0,e),this.tracksBuffered.forEach(t=>{for(let n=0;n<t.length;){if(t[n].end<=e){t.shift();continue}else if(t[n].start<e)t[n].start=e;else break;n++}}),this.fragmentTracker.removeFragmentsInRange(n,e,d.SUBTITLE)}}onError(e,t){let n=t.frag;n?.type===d.SUBTITLE&&(t.details===c.FRAG_GAP&&this.fragmentTracker.fragBuffered(n,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==X.STOPPED&&(this.state=X.IDLE))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){if(this.levels&&_o(this.levels,t)){this.levels=t.map(e=>new yt(e));return}this.tracksBuffered=[],this.levels=t.map(e=>{let t=new yt(e);return this.tracksBuffered[t.id]=[],t}),this.fragmentTracker.removeFragmentsInRange(0,1/0,d.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(e,t){var n;if(this.currentTrackId=t.id,!((n=this.levels)!=null&&n.length)||this.currentTrackId===-1){this.clearInterval();return}let r=this.levels[this.currentTrackId];r!=null&&r.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,r&&this.state!==X.STOPPED&&this.setInterval(Nc)}onSubtitleTrackLoaded(e,t){var n;let{currentTrackId:r,levels:i}=this,{details:a,id:o}=t;if(!i){this.warn(`Subtitle tracks were reset while loading level ${o}`);return}let s=i[o];if(o>=i.length||!s)return;this.log(`Subtitle track ${o} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:``},duration:${a.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let c=0;if(a.live||(n=s.details)!=null&&n.live){if(a.deltaUpdateFailed)return;let e=this.mainDetails;if(!e){this.startFragRequested=!1;return}let t=e.fragments[0];s.details?(c=this.alignPlaylists(a,s.details,this.levelLastLoaded?.details),c===0&&t&&(c=t.start,Rr(a,c))):a.hasProgramDateTime&&e.hasProgramDateTime?(Qr(a,e),c=a.fragmentStart):t&&(c=t.start,Rr(a,c)),e&&!this.startFragRequested&&this.setStartPosition(e,c)}s.details=a,this.levelLastLoaded=s,o===r&&(this.hls.trigger(l.SUBTITLE_TRACK_UPDATED,{details:a,id:o,groupId:t.groupId}),this.tick(),a.live&&!this.fragCurrent&&this.media&&this.state===X.IDLE&&(Bt(null,a.fragments,this.media.currentTime,0)||(this.warn(`Subtitle playlist not aligned with playback`),s.details=void 0)))}_handleFragmentLoadComplete(e){let{frag:t,payload:n}=e,r=t.decryptdata,i=this.hls;if(!this.fragContextChanged(t)&&n&&n.byteLength>0&&r!=null&&r.key&&r.iv&&Wn(r.method)){let e=performance.now();this.decrypter.decrypt(new Uint8Array(n),r.key.buffer,r.iv.buffer,Gn(r.method)).catch(e=>{throw i.trigger(l.ERROR,{type:s.MEDIA_ERROR,details:c.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:t}),e}).then(n=>{let r=performance.now();i.trigger(l.FRAG_DECRYPTED,{frag:t,payload:n,stats:{tstart:e,tdecrypt:r}})}).catch(e=>{this.warn(`${e.name}: ${e.message}`),this.state=X.IDLE})}}doTick(){if(!this.media){this.state=X.IDLE;return}if(this.state===X.IDLE){let{currentTrackId:e,levels:t}=this,n=t?.[e];if(!n||!t.length||!n.details||this.waitForLive(n))return;let{config:r}=this,i=this.getLoadPosition(),{end:a,len:o}=J.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],i,r.maxBufferHole),s=n.details;if(o>this.hls.maxBufferLength+s.levelTargetDuration)return;let c=s.fragments,l=c.length,u=s.edge,d=null,f=this.fragPrevious;if(a<u){let e=r.maxFragLookUpTolerance,t=a>u-e?0:e;d=Bt(f,c,Math.max(c[0].start,a),t),!d&&f&&f.start<c[0].start&&(d=c[0])}else d=c[l-1];if(d=this.filterReplacedPrimary(d,n.details),!d)return;let p=c[d.sn-s.startSN-1];if(p&&p.cc===d.cc&&this.fragmentTracker.getState(p)===an.NOT_LOADED&&(d=p),this.fragmentTracker.getState(d)===an.NOT_LOADED){let e=this.mapToInitFragWhenRequired(d);e&&this.loadFragment(e,n,a)}}}loadFragment(e,t,n){H(e)?super.loadFragment(e,t,n):this._loadInitSegment(e,t)}get mediaBufferTimeRanges(){return new Fc(this.tracksBuffered[this.currentTrackId]||[])}},Fc=class{constructor(e){this.buffered=void 0;let t=(t,n,r)=>{if(n>>>=0,n>r-1)throw new DOMException(`Failed to execute '${t}' on 'TimeRanges': The index provided (${n}) is greater than the maximum bound (${r})`);return e[n][t]};this.buffered={get length(){return e.length},end(n){return t(`end`,n,e.length)},start(n){return t(`start`,n,e.length)}}}},Ic={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Lc=e=>String.fromCharCode(Ic[e]||e),Rc=15,zc=100,Bc={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},Vc={17:2,18:4,21:6,22:8,23:10,19:13,20:15},Hc={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},Uc={25:2,26:4,29:6,30:8,31:10,27:13,28:15},Wc=[`white`,`green`,`blue`,`cyan`,`red`,`yellow`,`magenta`,`black`,`transparent`],Gc=class{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){let n=typeof t==`function`?t():t;O.log(`${this.time} [${e}] ${n}`)}}},Kc=function(e){let t=[];for(let n=0;n<e.length;n++)t.push(e[n].toString(16));return t},qc=class{constructor(){this.foreground=`white`,this.underline=!1,this.italics=!1,this.background=`black`,this.flash=!1}reset(){this.foreground=`white`,this.underline=!1,this.italics=!1,this.background=`black`,this.flash=!1}setStyles(e){let t=[`foreground`,`underline`,`italics`,`background`,`flash`];for(let n=0;n<t.length;n++){let r=t[n];e.hasOwnProperty(r)&&(this[r]=e[r])}}isDefault(){return this.foreground===`white`&&!this.underline&&!this.italics&&this.background===`black`&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return`color=`+this.foreground+`, underline=`+this.underline+`, italics=`+this.italics+`, background=`+this.background+`, flash=`+this.flash}},Jc=class{constructor(){this.uchar=` `,this.penState=new qc}reset(){this.uchar=` `,this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return this.uchar===` `&&this.penState.isDefault()}},Yc=class{constructor(e){this.chars=[],this.pos=0,this.currPenState=new qc,this.cueStartTime=null,this.logger=void 0;for(let e=0;e<zc;e++)this.chars.push(new Jc);this.logger=e}equals(e){for(let t=0;t<zc;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<zc;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<zc;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,`Negative cursor position `+this.pos),this.pos=0):this.pos>zc&&(this.logger.log(3,`Too large cursor position `+this.pos),this.pos=zc)}moveCursor(e){let t=this.pos+e;if(e>1)for(let e=this.pos+1;e<t+1;e++)this.chars[e].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(` `,this.currPenState)}insertChar(e){e>=144&&this.backSpace();let t=Lc(e);if(this.pos>=zc){this.logger.log(0,()=>`Cannot insert `+e.toString(16)+` (`+t+`) at position `+this.pos+`. Skipping it!`);return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1)}clearFromPos(e){let t;for(t=e;t<zc;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){let e=[],t=!0;for(let n=0;n<zc;n++){let r=this.chars[n].uchar;r!==` `&&(t=!1),e.push(r)}return t?``:e.join(``)}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}},Xc=class{constructor(e){this.rows=[],this.currRow=Rc-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<Rc;t++)this.rows.push(new Yc(e));this.logger=e}reset(){for(let e=0;e<Rc;e++)this.rows[e].clear();this.currRow=Rc-1}equals(e){let t=!0;for(let n=0;n<Rc;n++)if(!this.rows[n].equals(e.rows[n])){t=!1;break}return t}copy(e){for(let t=0;t<Rc;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<Rc;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,`setCursor: `+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>`pacData = `+q(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let e=0;e<Rc;e++)this.rows[e].clear();let e=this.currRow+1-this.nrRollUpRows,n=this.lastOutputScreen;if(n){let r=n.rows[e].cueStartTime,i=this.logger.time;if(r!==null&&i!==null&&r<i)for(let r=0;r<this.nrRollUpRows;r++)this.rows[t-this.nrRollUpRows+r+1].copy(n.rows[e+r])}}this.currRow=t;let n=this.rows[this.currRow];if(e.indent!==null){let t=e.indent,r=Math.max(t-1,0);n.setCursor(e.indent),e.color=n.chars[r].penState.foreground}let r={foreground:e.color,underline:e.underline,italics:e.italics,background:`black`,flash:!1};this.setPen(r)}setBkgData(e){this.logger.log(2,()=>`bkgData = `+q(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,`roll_up but nrRollUpRows not set yet`);return}this.logger.log(1,()=>this.getDisplayText());let e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,`Rolling up`)}getDisplayText(e){e||=!1;let t=[],n=``,r=-1;for(let n=0;n<Rc;n++){let i=this.rows[n].getTextString();i&&(r=n+1,e?t.push(`Row `+r+`: '`+i+`'`):t.push(i.trim()))}return t.length>0&&(n=e?`[`+t.join(` | `)+`]`:t.join(`
`)),n}getTextAndFormat(){return this.rows}},Zc=class{constructor(e,t,n){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new Xc(n),this.nonDisplayedMemory=new Xc(n),this.lastOutputScreen=new Xc(n),this.currRollUpRow=this.displayedMemory.rows[Rc-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=n}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[Rc-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>`MODE=`+e),this.mode===`MODE_POP-ON`?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!==`MODE_ROLL-UP`&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let t=0;t<e.length;t++)this.writeScreen.insertChar(e[t]);let t=this.writeScreen===this.displayedMemory?`DISP`:`NON_DISP`;this.logger.log(2,()=>t+`: `+this.writeScreen.getDisplayText(!0)),(this.mode===`MODE_PAINT-ON`||this.mode===`MODE_ROLL-UP`)&&(this.logger.log(1,()=>`DISPLAYED: `+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,`RCL - Resume Caption Loading`),this.setMode(`MODE_POP-ON`)}ccBS(){this.logger.log(2,`BS - BackSpace`),this.mode!==`MODE_TEXT`&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,`DER- Delete to End of Row`),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,`RU(`+e+`) - Roll Up`),this.writeScreen=this.displayedMemory,this.setMode(`MODE_ROLL-UP`),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,`FON - Flash On`),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,`RDC - Resume Direct Captioning`),this.setMode(`MODE_PAINT-ON`)}ccTR(){this.logger.log(2,`TR`),this.setMode(`MODE_TEXT`)}ccRTD(){this.logger.log(2,`RTD`),this.setMode(`MODE_TEXT`)}ccEDM(){this.logger.log(2,`EDM - Erase Displayed Memory`),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,`CR - Carriage Return`),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,`ENM - Erase Non-displayed Memory`),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,`EOC - End Of Caption`),this.mode===`MODE_POP-ON`){let e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>`DISP: `+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,`TO(`+e+`) - Tab Offset`),this.writeScreen.moveCursor(e)}ccMIDROW(e){let t={flash:!1};t.underline=e%2==1,t.italics=e>=46,t.italics?t.foreground=`white`:t.foreground=[`white`,`green`,`blue`,`cyan`,`red`,`yellow`,`magenta`][Math.floor(e/2)-16],this.logger.log(2,`MIDROW: `+q(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){let t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}},Qc=class{constructor(e,t,n){this.channels=void 0,this.currentChannel=0,this.cmdHistory=tl(),this.logger=void 0;let r=this.logger=new Gc;this.channels=[null,new Zc(e,t,r),new Zc(e+1,n,r)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){this.logger.time=e;for(let e=0;e<t.length;e+=2){let n=t[e]&127,r=t[e+1]&127,i=!1,a=null;if(n===0&&r===0)continue;this.logger.log(3,()=>`[`+Kc([t[e],t[e+1]])+`] -> (`+Kc([n,r])+`)`);let o=this.cmdHistory;if(n>=16&&n<=31){if(el(n,r,o)){$c(null,null,o),this.logger.log(3,()=>`Repeated command (`+Kc([n,r])+`) is dropped`);continue}$c(n,r,this.cmdHistory),i=this.parseCmd(n,r),i||=this.parseMidrow(n,r),i||=this.parsePAC(n,r),i||=this.parseBackgroundAttributes(n,r)}else $c(null,null,o);if(!i&&(a=this.parseChars(n,r),a)){let e=this.currentChannel;e&&e>0?this.channels[e].insertChars(a):this.logger.log(2,`No channel found yet. TEXT-MODE?`)}!i&&!a&&this.logger.log(2,()=>`Couldn't parse cleaned data `+Kc([n,r])+` orig: `+Kc([t[e],t[e+1]]))}}parseCmd(e,t){if(!((e===20||e===28||e===21||e===29)&&t>=32&&t<=47||(e===23||e===31)&&t>=33&&t<=35))return!1;let n=e===20||e===21||e===23?1:2,r=this.channels[n];return e===20||e===21||e===28||e===29?t===32?r.ccRCL():t===33?r.ccBS():t===34?r.ccAOF():t===35?r.ccAON():t===36?r.ccDER():t===37?r.ccRU(2):t===38?r.ccRU(3):t===39?r.ccRU(4):t===40?r.ccFON():t===41?r.ccRDC():t===42?r.ccTR():t===43?r.ccRTD():t===44?r.ccEDM():t===45?r.ccCR():t===46?r.ccENM():t===47&&r.ccEOC():r.ccTO(t-32),this.currentChannel=n,!0}parseMidrow(e,t){let n=0;if((e===17||e===25)&&t>=32&&t<=47){if(n=e===17?1:2,n!==this.currentChannel)return this.logger.log(0,`Mismatch channel in midrow parsing`),!1;let r=this.channels[n];return r?(r.ccMIDROW(t),this.logger.log(3,()=>`MIDROW (`+Kc([e,t])+`)`),!0):!1}return!1}parsePAC(e,t){let n;if(!((e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127||(e===16||e===24)&&t>=64&&t<=95))return!1;let r=e<=23?1:2;n=t>=64&&t<=95?r===1?Bc[e]:Hc[e]:r===1?Vc[e]:Uc[e];let i=this.channels[r];return i?(i.setPAC(this.interpretPAC(n,t)),this.currentChannel=r,!0):!1}interpretPAC(e,t){let n,r={color:null,italics:!1,indent:null,underline:!1,row:e};return n=t>95?t-96:t-64,r.underline=(n&1)==1,n<=13?r.color=[`white`,`green`,`blue`,`cyan`,`red`,`yellow`,`magenta`,`white`][Math.floor(n/2)]:n<=15?(r.italics=!0,r.color=`white`):r.indent=Math.floor((n-16)/2)*4,r}parseChars(e,t){let n,r=null,i=null;if(e>=25?(n=2,i=e-8):(n=1,i=e),i>=17&&i<=19){let e;e=i===17?t+80:i===18?t+112:t+144,this.logger.log(2,()=>`Special char '`+Lc(e)+`' in channel `+n),r=[e]}else e>=32&&e<=127&&(r=t===0?[e]:[e,t]);return r&&this.logger.log(3,()=>`Char codes =  `+Kc(r).join(`,`)),r}parseBackgroundAttributes(e,t){if(!((e===16||e===24)&&t>=32&&t<=47||(e===23||e===31)&&t>=45&&t<=47))return!1;let n,r={};e===16||e===24?(n=Math.floor((t-32)/2),r.background=Wc[n],t%2==1&&(r.background+=`_semi`)):t===45?r.background=`transparent`:(r.foreground=`black`,t===47&&(r.underline=!0));let i=e<=23?1:2;return this.channels[i].setBkgData(r),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){let t=this.channels[e];t&&t.reset()}$c(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){let n=this.channels[t];n&&n.cueSplitAtTime(e)}}};function $c(e,t,n){n.a=e,n.b=t}function el(e,t,n){return n.a===e&&n.b===t}function tl(){return{a:null,b:null}}var nl=(function(){if(Zn!=null&&Zn.VTTCue)return self.VTTCue;let e=[``,`lr`,`rl`],t=[`start`,`middle`,`end`,`left`,`right`];function n(e,t){if(typeof t!=`string`||!Array.isArray(e))return!1;let n=t.toLowerCase();return~e.indexOf(n)?n:!1}function r(t){return n(e,t)}function i(e){return n(t,e)}function a(e,...t){let n=1;for(;n<arguments.length;n++){let t=arguments[n];for(let n in t)e[n]=t[n]}return e}function o(e,t,n){let o=this,s={enumerable:!0};o.hasBeenReset=!1;let c=``,l=!1,u=e,d=t,f=n,p=null,m=``,h=!0,g=`auto`,_=`start`,v=50,y=`middle`,b=50,x=`middle`;Object.defineProperty(o,`id`,a({},s,{get:function(){return c},set:function(e){c=``+e}})),Object.defineProperty(o,`pauseOnExit`,a({},s,{get:function(){return l},set:function(e){l=!!e}})),Object.defineProperty(o,`startTime`,a({},s,{get:function(){return u},set:function(e){if(typeof e!=`number`)throw TypeError(`Start time must be set to a number.`);u=e,this.hasBeenReset=!0}})),Object.defineProperty(o,`endTime`,a({},s,{get:function(){return d},set:function(e){if(typeof e!=`number`)throw TypeError(`End time must be set to a number.`);d=e,this.hasBeenReset=!0}})),Object.defineProperty(o,`text`,a({},s,{get:function(){return f},set:function(e){f=``+e,this.hasBeenReset=!0}})),Object.defineProperty(o,`region`,a({},s,{get:function(){return p},set:function(e){p=e,this.hasBeenReset=!0}})),Object.defineProperty(o,`vertical`,a({},s,{get:function(){return m},set:function(e){let t=r(e);if(t===!1)throw SyntaxError(`An invalid or illegal string was specified.`);m=t,this.hasBeenReset=!0}})),Object.defineProperty(o,`snapToLines`,a({},s,{get:function(){return h},set:function(e){h=!!e,this.hasBeenReset=!0}})),Object.defineProperty(o,`line`,a({},s,{get:function(){return g},set:function(e){if(typeof e!=`number`&&e!==`auto`)throw SyntaxError(`An invalid number or illegal string was specified.`);g=e,this.hasBeenReset=!0}})),Object.defineProperty(o,`lineAlign`,a({},s,{get:function(){return _},set:function(e){let t=i(e);if(!t)throw SyntaxError(`An invalid or illegal string was specified.`);_=t,this.hasBeenReset=!0}})),Object.defineProperty(o,`position`,a({},s,{get:function(){return v},set:function(e){if(e<0||e>100)throw Error(`Position must be between 0 and 100.`);v=e,this.hasBeenReset=!0}})),Object.defineProperty(o,`positionAlign`,a({},s,{get:function(){return y},set:function(e){let t=i(e);if(!t)throw SyntaxError(`An invalid or illegal string was specified.`);y=t,this.hasBeenReset=!0}})),Object.defineProperty(o,`size`,a({},s,{get:function(){return b},set:function(e){if(e<0||e>100)throw Error(`Size must be between 0 and 100.`);b=e,this.hasBeenReset=!0}})),Object.defineProperty(o,`align`,a({},s,{get:function(){return x},set:function(e){let t=i(e);if(!t)throw SyntaxError(`An invalid or illegal string was specified.`);x=t,this.hasBeenReset=!0}})),o.displayState=void 0}return o.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},o})(),rl=class{decode(e,t){if(!e)return``;if(typeof e!=`string`)throw Error(`Error - expected string data.`);return decodeURIComponent(encodeURIComponent(e))}};function il(e){function t(e,t,n,r){return(e|0)*3600+(t|0)*60+(n|0)+parseFloat(r||0)}let n=e.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return n?parseFloat(n[2])>59?t(n[2],n[3],0,n[4]):t(n[1],n[2],n[3],n[4]):null}var al=class{constructor(){this.values=Object.create(null)}set(e,t){!this.get(e)&&t!==``&&(this.values[e]=t)}get(e,t,n){return n?this.has(e)?this.values[e]:t[n]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,n){for(let r=0;r<n.length;++r)if(t===n[r]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){let n=parseFloat(t);if(n>=0&&n<=100)return this.set(e,n),!0}return!1}};function ol(e,t,n,r){let i=r?e.split(r):[e];for(let e in i){if(typeof i[e]!=`string`)continue;let r=i[e].split(n);if(r.length!==2)continue;let a=r[0],o=r[1];t(a,o)}}var sl=new nl(0,0,``),cl=sl.align===`middle`?`middle`:`center`;function ll(e,t,n){let r=e;function i(){let t=il(e);if(t===null)throw Error(`Malformed timestamp: `+r);return e=e.replace(/^[^\sa-zA-Z-]+/,``),t}function a(e,t){let r=new al;ol(e,function(e,t){let i;switch(e){case`region`:for(let i=n.length-1;i>=0;i--)if(n[i].id===t){r.set(e,n[i].region);break}break;case`vertical`:r.alt(e,t,[`rl`,`lr`]);break;case`line`:i=t.split(`,`),r.integer(e,i[0]),r.percent(e,i[0])&&r.set(`snapToLines`,!1),r.alt(e,i[0],[`auto`]),i.length===2&&r.alt(`lineAlign`,i[1],[`start`,cl,`end`]);break;case`position`:i=t.split(`,`),r.percent(e,i[0]),i.length===2&&r.alt(`positionAlign`,i[1],[`start`,cl,`end`,`line-left`,`line-right`,`auto`]);break;case`size`:r.percent(e,t);break;case`align`:r.alt(e,t,[`start`,cl,`end`,`left`,`right`]);break}},/:/,/\s/),t.region=r.get(`region`,null),t.vertical=r.get(`vertical`,``);let i=r.get(`line`,`auto`);i===`auto`&&sl.line===-1&&(i=-1),t.line=i,t.lineAlign=r.get(`lineAlign`,`start`),t.snapToLines=r.get(`snapToLines`,!0),t.size=r.get(`size`,100),t.align=r.get(`align`,cl);let a=r.get(`position`,`auto`);a===`auto`&&sl.position===50&&(a=t.align===`start`||t.align===`left`?0:t.align===`end`||t.align===`right`?100:50),t.position=a}function o(){e=e.replace(/^\s+/,``)}if(o(),t.startTime=i(),o(),e.slice(0,3)!==`-->`)throw Error(`Malformed time stamp (time stamps must be separated by '-->'): `+r);e=e.slice(3),o(),t.endTime=i(),o(),a(e,t)}function ul(e){return e.replace(/<br(?: \/)?>/gi,`
`)}var dl=class{constructor(){this.state=`INITIAL`,this.buffer=``,this.decoder=new rl,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){let t=this;e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));function n(){let e=t.buffer,n=0;for(e=ul(e);n<e.length&&e[n]!==`\r`&&e[n]!==`
`;)++n;let r=e.slice(0,n);return e[n]===`\r`&&++n,e[n]===`
`&&++n,t.buffer=e.slice(n),r}function r(e){ol(e,function(e,t){},/:/)}try{let e=``;if(t.state===`INITIAL`){if(!/\r\n|\n/.test(t.buffer))return this;e=n();let r=e.match(/^()?WEBVTT([ \t].*)?$/);if(!(r!=null&&r[0]))throw Error(`Malformed WebVTT signature.`);t.state=`HEADER`}let i=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(i?i=!1:e=n(),t.state){case`HEADER`:/:/.test(e)?r(e):e||(t.state=`ID`);continue;case`NOTE`:e||(t.state=`ID`);continue;case`ID`:if(/^NOTE($|[ \t])/.test(e)){t.state=`NOTE`;break}if(!e)continue;if(t.cue=new nl(0,0,``),t.state=`CUE`,e.indexOf(`-->`)===-1){t.cue.id=e;continue}case`CUE`:if(!t.cue){t.state=`BADCUE`;continue}try{ll(e,t.cue,t.regionList)}catch{t.cue=null,t.state=`BADCUE`;continue}t.state=`CUETEXT`;continue;case`CUETEXT`:{let n=e.indexOf(`-->`)!==-1;if(!e||n&&(i=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state=`ID`;continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=e}continue;case`BADCUE`:e||(t.state=`ID`)}}}catch{t.state===`CUETEXT`&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state===`INITIAL`?`BADWEBVTT`:`BADCUE`}return this}flush(){let e=this;try{if((e.cue||e.state===`HEADER`)&&(e.buffer+=`

`,e.parse()),e.state===`INITIAL`||e.state===`BADWEBVTT`)throw Error(`Malformed WebVTT signature.`)}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}},fl=/\r\n|\n\r|\n|\r/g,pl=function(e,t,n=0){return e.slice(n,n+t.length)===t},ml=function(e){let t=parseInt(e.slice(-3)),n=parseInt(e.slice(-6,-4)),r=parseInt(e.slice(-9,-7)),a=e.length>9?parseInt(e.substring(0,e.indexOf(`:`))):0;if(!i(t)||!i(n)||!i(r)||!i(a))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*n,t+=60*1e3*r,t+=3600*1e3*a,t};function hl(e,t,n){return hc(e.toString())+hc(t.toString())+hc(n)}var gl=function(e,t,n){let r=e[t],i=e[r.prevCC];if(!i||!i.new&&r.new){e.ccOffset=e.presentationOffset=r.start,r.new=!1;return}for(;(a=i)!=null&&a.new;){var a;e.ccOffset+=r.start-i.start,r.new=!1,r=i,i=e[r.prevCC]}e.presentationOffset=n};function _l(e,t,n,r,i,a,o){let s=new dl,c=M(new Uint8Array(e)).trim().replace(fl,`
`).split(`
`),l=[],u=t?za(t.baseTime,t.timescale):0,d=`00:00.000`,f=0,p=0,m,h=!0;s.oncue=function(e){let a=n[r],o=n.ccOffset,s=(f-u)/9e4;if(a!=null&&a.new&&(p===void 0?gl(n,r,s):o=n.ccOffset=a.start),s){if(!t){m=Error(`Missing initPTS for VTT MPEGTS`);return}o=s-n.presentationOffset}let c=e.endTime-e.startTime,d=Ya((e.startTime+o-p)*9e4,i*9e4)/9e4;e.startTime=Math.max(d,0),e.endTime=Math.max(d+c,0);let h=e.text.trim();e.text=decodeURIComponent(encodeURIComponent(h)),e.id||=hl(e.startTime,e.endTime,h),e.endTime>0&&l.push(e)},s.onparsingerror=function(e){m=e},s.onflush=function(){if(m){o(m);return}a(l)},c.forEach(e=>{if(h)if(pl(e,`X-TIMESTAMP-MAP=`)){h=!1,e.slice(16).split(`,`).forEach(e=>{pl(e,`LOCAL:`)?d=e.slice(6):pl(e,`MPEGTS:`)&&(f=parseInt(e.slice(7)))});try{p=ml(d)/1e3}catch(e){m=e}return}else e===``&&(h=!1);s.parse(e+`
`)}),s.flush()}var vl=`stpp.ttml.im1t`,yl=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,bl=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,xl={left:`start`,center:`center`,right:`end`,start:`start`,end:`end`};function Sl(e,t,n,r){let i=K(new Uint8Array(e),[`mdat`]);if(i.length===0){r(Error(`Could not parse IMSC1 mdat`));return}let a=i.map(e=>M(e)),o=La(t.baseTime,1,t.timescale);try{a.forEach(e=>n(Cl(e,o)))}catch(e){r(e)}}function Cl(e,t){let n=new DOMParser().parseFromString(e,`text/xml`).getElementsByTagName(`tt`)[0];if(!n)throw Error(`Invalid ttml`);let r={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},i=Object.keys(r).reduce((e,t)=>(e[t]=n.getAttribute(`ttp:${t}`)||r[t],e),{}),a=n.getAttribute(`xml:space`)!==`preserve`,o=Tl(wl(n,`styling`,`style`)),s=Tl(wl(n,`layout`,`region`)),c=wl(n,`body`,`[begin]`);return[].map.call(c,e=>{let n=El(e,a);if(!n||!e.hasAttribute(`begin`))return null;let r=Al(e.getAttribute(`begin`),i),c=Al(e.getAttribute(`dur`),i),l=Al(e.getAttribute(`end`),i);if(r===null)throw kl(e);if(l===null){if(c===null)throw kl(e);l=r+c}let u=new nl(r-t,l-t,n);u.id=hl(u.startTime,u.endTime,u.text);let d=s[e.getAttribute(`region`)],f=o[e.getAttribute(`style`)],p=Dl(d,f,o),{textAlign:m}=p;if(m){let e=xl[m];e&&(u.lineAlign=e),u.align=m}return h(u,p),u}).filter(e=>e!==null)}function wl(e,t,n){let r=e.getElementsByTagName(t)[0];return r?[].slice.call(r.querySelectorAll(n)):[]}function Tl(e){return e.reduce((e,t)=>{let n=t.getAttribute(`xml:id`);return n&&(e[n]=t),e},{})}function El(e,t){return[].slice.call(e.childNodes).reduce((e,n,r)=>{var i;return n.nodeName===`br`&&r?e+`
`:(i=n.childNodes)!=null&&i.length?El(n,t):t?e+n.textContent.trim().replace(/\s+/g,` `):e+n.textContent},``)}function Dl(e,t,n){let r=`http://www.w3.org/ns/ttml#styling`,i=null,a=[`displayAlign`,`textAlign`,`color`,`backgroundColor`,`fontSize`,`fontFamily`],o=e!=null&&e.hasAttribute(`style`)?e.getAttribute(`style`):null;return o&&n.hasOwnProperty(o)&&(i=n[o]),a.reduce((n,a)=>{let o=Ol(t,r,a)||Ol(e,r,a)||Ol(i,r,a);return o&&(n[a]=o),n},{})}function Ol(e,t,n){return e&&e.hasAttributeNS(t,n)?e.getAttributeNS(t,n):null}function kl(e){return Error(`Could not parse ttml timestamp ${e}`)}function Al(e,t){if(!e)return null;let n=il(e);return n===null&&(yl.test(e)?n=jl(e,t):bl.test(e)&&(n=Ml(e,t))),n}function jl(e,t){let n=yl.exec(e),r=(n[4]|0)+(n[5]|0)/t.subFrameRate;return(n[1]|0)*3600+(n[2]|0)*60+(n[3]|0)+r/t.frameRate}function Ml(e,t){let n=bl.exec(e),r=Number(n[1]);switch(n[2]){case`h`:return r*3600;case`m`:return r*60;case`ms`:return r*1e3;case`f`:return r/t.frameRate;case`t`:return r/t.tickRate}return r}var Nl=class{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,n){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=n,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}},Pl=class{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Rl(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(l.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(l.FRAG_LOADING,this.onFragLoading,this),e.on(l.FRAG_LOADED,this.onFragLoaded,this),e.on(l.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(l.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(l.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(l.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(l.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){let{hls:e}=this;e.off(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(l.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(l.FRAG_LOADING,this.onFragLoading,this),e.off(l.FRAG_LOADED,this.onFragLoaded,this),e.off(l.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(l.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(l.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(l.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(l.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){let e=new Nl(this,`textTrack1`),t=new Nl(this,`textTrack2`),n=new Nl(this,`textTrack3`),r=new Nl(this,`textTrack4`);this.cea608Parser1=new Qc(1,e,t),this.cea608Parser2=new Qc(3,n,r)}addCues(e,t,n,r,i){let a=!1;for(let e=i.length;e--;){let r=i[e],o=Ll(r[0],r[1],t,n);if(o>=0&&(r[0]=Math.min(r[0],t),r[1]=Math.max(r[1],n),a=!0,o/(n-t)>.5))return}if(a||i.push([t,n]),this.config.renderTextTracksNatively){let i=this.captionsTracks[e];this.Cues.newCue(i,t,n,r)}else{let i=this.Cues.newCue(null,t,n,r);this.hls.trigger(l.CUES_PARSED,{type:`captions`,cues:i,track:e})}}onInitPtsFound(e,{frag:t,id:n,initPTS:r,timescale:i,trackId:a}){let{unparsedVttFrags:o}=this;n===d.MAIN&&(this.initPTS[t.cc]={baseTime:r,timescale:i,trackId:a}),o.length&&(this.unparsedVttFrags=[],o.forEach(e=>{this.initPTS[e.frag.cc]?this.onFragLoaded(l.FRAG_LOADED,e):this.hls.trigger(l.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e.frag,error:Error(`Subtitle discontinuity domain does not match main`)})}))}getExistingTrack(e,t){let{media:n}=this;if(n)for(let r=0;r<n.textTracks.length;r++){let i=n.textTracks[r];if(Il(i,{name:e,lang:t,characteristics:`transcribes-spoken-dialog,describes-music-and-sound`}))return i}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;let{captionsProperties:t,captionsTracks:n,media:r}=this,{label:i,languageCode:a}=t[e],o=this.getExistingTrack(i,a);if(o)n[e]=o,cc(n[e]),oc(n[e],r);else{let t=this.createTextTrack(`captions`,i,a);t&&(t[e]=!0,n[e]=t)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;let t=this.captionsProperties[e];if(!t)return;let n={_id:e,label:t.label,kind:`captions`,default:t.media?!!t.media.default:!1,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=n,this.hls.trigger(l.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[n]})}createTextTrack(e,t,n){let r=this.media;if(r)return r.addTextTrack(e,t,n)}onMediaAttaching(e,t){this.media=t.media,t.mediaSource||this._cleanTracks()}onMediaDetaching(e,t){let n=!!t.transferMedia;if(this.media=null,n)return;let{captionsTracks:r}=this;Object.keys(r).forEach(e=>{cc(r[e]),delete r[e]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Rl(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){let{media:e}=this;if(!e)return;let t=e.textTracks;if(t)for(let e=0;e<t.length;e++)cc(t[e])}onSubtitleTracksUpdated(e,t){let n=t.subtitleTracks||[],r=n.some(e=>e.textCodec===vl);if(this.config.enableWebVTT||r&&this.config.enableIMSC1){if(_o(this.tracks,n)){this.tracks=n;return}if(this.textTracks=[],this.tracks=n,this.config.renderTextTracksNatively){let e=this.media,t=e?fc(e.textTracks):null;if(this.tracks.forEach((e,n)=>{let r;if(t){let n=null;for(let r=0;r<t.length;r++)if(t[r]&&Il(t[r],e)){n=t[r],t[r]=null;break}n&&(r=n)}if(r)cc(r);else{let t=Fl(e);r=this.createTextTrack(t,e.name,e.lang),r&&(r.mode=`disabled`)}r&&this.textTracks.push(r)}),t!=null&&t.length){let e=t.filter(e=>e!==null).map(e=>e.label);e.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${e.join(`, `)}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){let e=this.tracks.map(e=>({label:e.name,kind:e.type.toLowerCase(),default:e.default,subtitleTrack:e}));this.hls.trigger(l.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:e})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(e=>{let t=/(?:CC|SERVICE)([1-4])/.exec(e.instreamId);if(!t)return;let n=`textTrack${t[1]}`,r=this.captionsProperties[n];r&&(r.label=e.name,e.lang&&(r.languageCode=e.lang),r.media=e)})}closedCaptionsForLevel(e){return this.hls.levels[e.level]?.attrs[`CLOSED-CAPTIONS`]}onFragLoading(e,t){if(this.enabled&&t.frag.type===d.MAIN){let{cea608Parser1:e,cea608Parser2:n,lastSn:r}=this,{cc:i,sn:a}=t.frag,o=t.part?.index??-1;e&&n&&(a!==r+1||a===r&&o!==this.lastPartIndex+1||i!==this.lastCc)&&(e.reset(),n.reset()),this.lastCc=i,this.lastSn=a,this.lastPartIndex=o}}onFragLoaded(e,t){let{frag:n,payload:r}=t;if(n.type===d.SUBTITLE)if(r.byteLength){let e=n.decryptdata,i=`stats`in t;if(e==null||!e.encrypted||i){let e=this.tracks[n.level],i=this.vttCCs;i[n.cc]||(i[n.cc]={start:n.start,prevCC:this.prevCC,new:!0},this.prevCC=n.cc),e&&e.textCodec===vl?this._parseIMSC1(n,r):this._parseVTTs(t)}}else this.hls.trigger(l.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:n,error:Error(`Empty subtitle payload`)})}_parseIMSC1(e,t){let n=this.hls;Sl(t,this.initPTS[e.cc],t=>{this._appendCues(t,e.level),n.trigger(l.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},t=>{n.logger.log(`Failed to parse IMSC1: ${t}`),n.trigger(l.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:t})})}_parseVTTs(e){var t;let{frag:n,payload:r}=e,{initPTS:i,unparsedVttFrags:a}=this,o=i.length-1;if(!i[n.cc]&&o===-1){a.push(e);return}let s=this.hls;_l((t=n.initSegment)!=null&&t.data?Te(n.initSegment.data,new Uint8Array(r)).buffer:r,this.initPTS[n.cc],this.vttCCs,n.cc,n.start,e=>{this._appendCues(e,n.level),s.trigger(l.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:n})},t=>{let i=t.message===`Missing initPTS for VTT MPEGTS`;i?a.push(e):this._fallbackToIMSC1(n,r),s.logger.log(`Failed to parse VTT cue: ${t}`),!(i&&o>n.cc)&&s.trigger(l.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:n,error:t})})}_fallbackToIMSC1(e,t){let n=this.tracks[e.level];n.textCodec||Sl(t,this.initPTS[e.cc],()=>{n.textCodec=vl,this._parseIMSC1(e,t)},()=>{n.textCodec=`wvtt`})}_appendCues(e,t){let n=this.hls;if(this.config.renderTextTracksNatively){let n=this.textTracks[t];if(!n||n.mode===`disabled`)return;e.forEach(e=>sc(n,e))}else{let r=this.tracks[t];if(!r)return;let i=r.default?`default`:`subtitles`+t;n.trigger(l.CUES_PARSED,{type:`subtitles`,cues:e,track:i})}}onFragDecrypted(e,t){let{frag:n}=t;n.type===d.SUBTITLE&&this.onFragLoaded(l.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){if(!this.enabled||!this.config.enableCEA708Captions)return;let{frag:n,samples:r}=t;if(!(n.type===d.MAIN&&this.closedCaptionsForLevel(n)===`NONE`))for(let e=0;e<r.length;e++){let t=r[e].bytes;if(t){this.cea608Parser1||this.initCea608Parsers();let n=this.extractCea608Data(t);this.cea608Parser1.addData(r[e].pts,n[0]),this.cea608Parser2.addData(r[e].pts,n[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:n,endOffsetSubtitles:r,type:i}){let{media:a}=this;if(!(!a||a.currentTime<n)){if(!i||i===`video`){let{captionsTracks:e}=this;Object.keys(e).forEach(r=>lc(e[r],t,n))}if(this.config.renderTextTracksNatively&&t===0&&r!==void 0){let{textTracks:e}=this;Object.keys(e).forEach(n=>lc(e[n],t,r))}}}extractCea608Data(e){let t=[[],[]],n=e[0]&31,r=2;for(let i=0;i<n;i++){let n=e[r++],i=127&e[r++],a=127&e[r++];if(!(i===0&&a===0)&&4&n){let e=3&n;(e===0||e===1)&&(t[e].push(i),t[e].push(a))}}return t}};function Fl(e){return e.characteristics&&/transcribes-spoken-dialog/gi.test(e.characteristics)&&/describes-music-and-sound/gi.test(e.characteristics)?`captions`:`subtitles`}function Il(e,t){return!!e&&e.kind===Fl(t)&&yo(t,e)}function Ll(e,t,n,r){return Math.min(t,r)-Math.max(e,n)}function Rl(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}var zl=/\s/,Bl={newCue(e,t,n,r){let i=[],a,o,s,c,l,u=self.VTTCue||self.TextTrackCue;for(let f=0;f<r.rows.length;f++)if(a=r.rows[f],s=!0,c=0,l=``,!a.isEmpty()){var d;for(let e=0;e<a.chars.length;e++)zl.test(a.chars[e].uchar)&&s?c++:(l+=a.chars[e].uchar,s=!1);a.cueStartTime=t,t===n&&(n+=1e-4),c>=16?c--:c++;let r=ul(l.trim()),p=hl(t,n,r);e!=null&&(d=e.cues)!=null&&d.getCueById(p)||(o=new u(t,n,r),o.id=p,o.line=f+1,o.align=`left`,o.position=10+Math.min(80,Math.floor(c*8/32)*10),i.push(o))}return e&&i.length&&(i.sort((e,t)=>e.line===`auto`||t.line===`auto`?0:e.line>8&&t.line>8?t.line-e.line:e.line-t.line),i.forEach(t=>sc(e,t))),i}};function Vl(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}var Hl=/(\d+)-(\d+)\/(\d+)/,Ul=class{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||ql,this.controller=new self.AbortController,this.stats=new B}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,n){let r=this.stats;if(r.loading.start)throw Error(`Loader can only be used once.`);r.loading.start=self.performance.now();let a=Wl(e,this.controller.signal),o=e.responseType===`arraybuffer`,s=o?`byteLength`:`length`,{maxTimeToFirstByteMs:c,maxLoadTimeMs:l}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=n,this.request=this.fetchSetup(e,a),self.clearTimeout(this.requestTimeout),t.timeout=c&&i(c)?c:l,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(r,e,this.response))},t.timeout),(co(this.request)?this.request.then(self.fetch):self.fetch(this.request)).then(n=>{this.response=this.loader=n;let a=Math.max(self.performance.now(),r.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=l,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(r,e,this.response))},l-(a-r.loading.start)),!n.ok){let{status:e,statusText:t}=n;throw new Jl(t||`fetch, bad network response`,e,n)}r.loading.first=a,r.total=Kl(n.headers)||r.total;let s=this.callbacks?.onProgress;return s&&i(t.highWaterMark)?this.loadProgressively(n,r,e,t.highWaterMark,s):o?n.arrayBuffer():e.responseType===`json`?n.json():n.text()}).then(n=>{var a;let o=this.response;if(!o)throw Error(`loader destroyed`);self.clearTimeout(this.requestTimeout),r.loading.end=Math.max(self.performance.now(),r.loading.first);let c=n[s];c&&(r.loaded=r.total=c);let l={url:o.url,data:n,code:o.status},u=this.callbacks?.onProgress;u&&!i(t.highWaterMark)&&u(r,e,n,o),(a=this.callbacks)==null||a.onSuccess(l,r,e,o)}).catch(t=>{var n;if(self.clearTimeout(this.requestTimeout),r.aborted)return;let i=t&&t.code||0,a=t?t.message:null;(n=this.callbacks)==null||n.onError({code:i,text:a},e,t?t.details:null,r)})}getCacheAge(){let e=null;if(this.response){let t=this.response.headers.get(`age`);e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,n,r=0,i){let a=new ii,o=e.body.getReader(),s=()=>o.read().then(o=>{if(o.done)return a.dataLength&&i(t,n,a.flush().buffer,e),Promise.resolve(new ArrayBuffer(0));let c=o.value,l=c.length;return t.loaded+=l,l<r||a.dataLength?(a.push(c),a.dataLength>=r&&i(t,n,a.flush().buffer,e)):i(t,n,c.buffer,e),s()}).catch(()=>Promise.reject());return s()}};function Wl(e,t){let n={method:`GET`,mode:`cors`,credentials:`same-origin`,signal:t,headers:new self.Headers(h({},e.headers))};return e.rangeEnd&&n.headers.set(`Range`,`bytes=`+e.rangeStart+`-`+String(e.rangeEnd-1)),n}function Gl(e){let t=Hl.exec(e);if(t)return parseInt(t[2])-parseInt(t[1])+1}function Kl(e){let t=e.get(`Content-Range`);if(t){let e=Gl(t);if(i(e))return e}let n=e.get(`Content-Length`);if(n)return parseInt(n)}function ql(e,t){return new self.Request(e.url,t)}var Jl=class extends Error{constructor(e,t,n){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=n}},Yl=/^age:\s*[\d.]+\s*$/im,Xl=class{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new B,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){let e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,n){if(this.stats.loading.start)throw Error(`Loader can only be used once.`);this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=n,this.loadInternal()}loadInternal(){let{config:e,context:t}=this;if(!e||!t)return;let n=this.loader=new self.XMLHttpRequest,r=this.stats;r.loading.first=0,r.loaded=0,r.aborted=!1;let i=this.xhrSetup;i?Promise.resolve().then(()=>{if(!(this.loader!==n||this.stats.aborted))return i(n,t.url)}).catch(e=>{if(!(this.loader!==n||this.stats.aborted))return n.open(`GET`,t.url,!0),i(n,t.url)}).then(()=>{this.loader!==n||this.stats.aborted||this.openAndSendXhr(n,t,e)}).catch(e=>{var i;(i=this.callbacks)==null||i.onError({code:n.status,text:e.message},t,n,r)}):this.openAndSendXhr(n,t,e)}openAndSendXhr(e,t,n){e.readyState||e.open(`GET`,t.url,!0);let r=t.headers,{maxTimeToFirstByteMs:a,maxLoadTimeMs:o}=n.loadPolicy;if(r)for(let t in r)e.setRequestHeader(t,r[t]);t.rangeEnd&&e.setRequestHeader(`Range`,`bytes=`+t.rangeStart+`-`+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),n.timeout=a&&i(a)?a:o,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),n.timeout),e.send()}readystatechange(){let{context:e,loader:t,stats:n}=this;if(!e||!t)return;let r=t.readyState,i=this.config;if(!n.aborted&&r>=2&&(n.loading.first===0&&(n.loading.first=Math.max(self.performance.now(),n.loading.start),i.timeout!==i.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),i.timeout=i.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.loadPolicy.maxLoadTimeMs-(n.loading.first-n.loading.start)))),r===4)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;let r=t.status,s=t.responseType===`text`?t.responseText:null;if(r>=200&&r<300){let i=s??t.response;if(i!=null){var a;n.loading.end=Math.max(self.performance.now(),n.loading.first),n.loaded=n.total=t.responseType===`arraybuffer`?i.byteLength:i.length,n.bwEstimate=n.total*8e3/(n.loading.end-n.loading.first);let o=this.callbacks?.onProgress;o&&o(n,e,i,t);let s={url:t.responseURL,data:i,code:r};(a=this.callbacks)==null||a.onSuccess(s,n,e,t);return}}let c=i.loadPolicy.errorRetry,l=n.retry;if(Zt(c,l,!1,{url:e.url,data:void 0,code:r}))this.retry(c);else{var o;O.error(`${r} while loading ${e.url}`),(o=this.callbacks)==null||o.onError({code:r,text:t.statusText},e,t,n)}}}loadtimeout(){if(!this.config)return;let e=this.config.loadPolicy.timeoutRetry,t=this.stats.retry;if(Zt(e,t,!0))this.retry(e);else{O.warn(`timeout while loading ${this.context?.url}`);let e=this.callbacks;e&&(this.abortInternal(),e.onTimeout(this.stats,this.context,this.loader))}}retry(e){let{context:t,stats:n}=this;this.retryDelay=Yt(e,n.retry),n.retry++,O.warn(`${status?`HTTP Status `+status:`Timeout`} while loading ${t?.url}, retrying ${n.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){let t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&Yl.test(this.loader.getAllResponseHeaders())){let t=this.loader.getResponseHeader(`age`);e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&RegExp(`^${e}:\\s*[\\d.]+\\s*$`,`im`).test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}},Zl=_(_({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:1/0,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,startOnSegmentBoundary:!1,maxBufferSize:60*1e3*1e3,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncMode:`edge`,liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:Xl,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:Lt,bufferController:To,capLevelController:ko,errorController:nn,fpsController:ac,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:nr,requireKeySystemAccessOnStart:!1,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,preserveManualLevelOnError:!1,certLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:`linear`},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:`linear`}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},Ql()),{},{subtitleStreamController:Pc,subtitleTrackController:pc,timelineController:Pl,audioStreamController:ho,audioTrackController:bo,emeController:ec,cmcdController:Ys,contentSteeringController:Zs,interstitialsController:Mc});function Ql(){return{cueHandler:Bl,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:`English`,captionsTextTrack1LanguageCode:`en`,captionsTextTrack2Label:`Spanish`,captionsTextTrack2LanguageCode:`es`,captionsTextTrack3Label:`Unknown CC`,captionsTextTrack3LanguageCode:``,captionsTextTrack4Label:`Unknown CC`,captionsTextTrack4LanguageCode:``,renderTextTracksNatively:!0}}function $l(e,t,n){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw Error(`Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration`);if(t.liveMaxLatencyDurationCount!==void 0&&(t.liveSyncDurationCount===void 0||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw Error(`Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"`);if(t.liveMaxLatencyDuration!==void 0&&(t.liveSyncDuration===void 0||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw Error(`Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"`);let r=eu(e),i=[`manifest`,`level`,`frag`],a=[`TimeOut`,`MaxRetry`,`RetryDelay`,`MaxRetryTimeout`];return i.forEach(e=>{let i=`${e===`level`?`playlist`:e}LoadPolicy`,o=t[i]===void 0,s=[];a.forEach(n=>{let a=`${e}Loading${n}`,c=t[a];if(c!==void 0&&o){s.push(a);let e=r[i].default;switch(t[i]={default:e},n){case`TimeOut`:e.maxLoadTimeMs=c,e.maxTimeToFirstByteMs=c;break;case`MaxRetry`:e.errorRetry.maxNumRetry=c,e.timeoutRetry.maxNumRetry=c;break;case`RetryDelay`:e.errorRetry.retryDelayMs=c,e.timeoutRetry.retryDelayMs=c;break;case`MaxRetryTimeout`:e.errorRetry.maxRetryDelayMs=c,e.timeoutRetry.maxRetryDelayMs=c;break}}}),s.length&&n.warn(`hls.js config: "${s.join(`", "`)}" setting(s) are deprecated, use "${i}": ${q(t[i])}`)}),_(_({},r),t)}function eu(e){return e&&typeof e==`object`?Array.isArray(e)?e.map(eu):Object.keys(e).reduce((t,n)=>(t[n]=eu(e[n]),t),{}):e}function tu(e,t){let n=e.loader;n!==Ul&&n!==Xl?(t.log(`[config]: Custom loader detected, cannot enable progressive streaming`),e.progressive=!1):Vl()&&(e.loader=Ul,e.progressive=!0,e.enableSoftwareAES=!0,t.log(`[config]: Progressive streaming enabled, using FetchLoader`))}var nu=2,ru=.1,iu=.05,au=100,ou=class extends wn{constructor(e,t){super(`gap-controller`,e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.media=null,this.mediaSource=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.buffered={},this.lastCurrentTime=0,this.ended=0,this.waiting=0,this.onMediaPlaying=()=>{this.ended=0,this.waiting=0},this.onMediaWaiting=()=>{var e;(e=this.media)!=null&&e.seeking||(this.waiting=self.performance.now(),this.tick())},this.onMediaEnded=()=>{this.hls&&(this.ended=this.media?.currentTime||1,this.hls.trigger(l.MEDIA_ENDED,{stalled:!1}))},this.hls=e,this.fragmentTracker=t,this.registerListeners()}registerListeners(){let{hls:e}=this;e&&(e.on(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(l.BUFFER_APPENDED,this.onBufferAppended,this))}unregisterListeners(){let{hls:e}=this;e&&(e.off(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(l.BUFFER_APPENDED,this.onBufferAppended,this))}destroy(){super.destroy(),this.unregisterListeners(),this.media=this.hls=this.fragmentTracker=null,this.mediaSource=void 0}onMediaAttached(e,t){this.setInterval(au),this.mediaSource=t.mediaSource;let n=this.media=t.media;$r(n,`playing`,this.onMediaPlaying),$r(n,`waiting`,this.onMediaWaiting),$r(n,`ended`,this.onMediaEnded)}onMediaDetaching(e,t){this.clearInterval();let{media:n}=this;n&&(ei(n,`playing`,this.onMediaPlaying),ei(n,`waiting`,this.onMediaWaiting),ei(n,`ended`,this.onMediaEnded),this.media=null),this.mediaSource=void 0}onBufferAppended(e,t){this.buffered=t.timeRanges}get hasBuffered(){return Object.keys(this.buffered).length>0}tick(){var e;if(!((e=this.media)!=null&&e.readyState)||!this.hasBuffered)return;let t=this.media.currentTime;this.poll(t,this.lastCurrentTime),this.lastCurrentTime=t}poll(e,t){let n=this.hls?.config;if(!n)return;let r=this.media;if(!r)return;let{seeking:i}=r,a=this.seeking&&!i,o=!this.seeking&&i,s=r.paused&&!i||r.ended||r.playbackRate===0;if(this.seeking=i,e!==t){t&&(this.ended=0),this.moved=!0,i||(this.nudgeRetry=0,n.nudgeOnVideoHole&&!s&&e>t&&this.nudgeOnVideoHole(e,t)),this.waiting===0&&this.stallResolved(e);return}if(o||a){a&&this.stallResolved(e);return}if(s){this.nudgeRetry=0,this.stallResolved(e),!this.ended&&r.ended&&this.hls&&(this.ended=e||1,this.hls.trigger(l.MEDIA_ENDED,{stalled:!1}));return}if(!J.getBuffered(r).length){this.nudgeRetry=0;return}let c=J.bufferInfo(r,e,0),u=c.nextStart||0,d=this.fragmentTracker;if(i&&d&&this.hls){let t=su(this.hls.inFlightFragments,e),n=c.len>nu,r=!u||t||u-e>nu&&!d.getPartialFragment(e);if(n||r)return;this.moved=!1}let f=this.hls?.latestLevelDetails;if(!this.moved&&this.stalled!==null&&d){if(!(c.len>0)&&!u)return;let t=Math.max(u,c.start||0)-e,n=f!=null&&f.live?f.targetduration*2:nu,i=lu(e,d);if(t>0&&(t<=n||i)){r.paused||this._trySkipBufferHole(i);return}}let p=n.detectStallWithCurrentTimeMs,m=self.performance.now(),h=this.waiting,g=this.stalled;if(g===null)if(h>0&&m-h<p)g=this.stalled=h;else{this.stalled=m;return}let _=m-g;if(!i&&(_>=p||h)&&this.hls){if(this.mediaSource?.readyState===`ended`&&!(f!=null&&f.live)&&Math.abs(e-(f?.edge||0))<1){if(this.ended)return;this.ended=e||1,this.hls.trigger(l.MEDIA_ENDED,{stalled:!0});return}if(this._reportStall(c),!this.media||!this.hls)return}let v=J.bufferInfo(r,e,n.maxBufferHole);this._tryFixBufferStall(v,_,e)}stallResolved(e){let t=this.stalled;if(t&&this.hls&&(this.stalled=null,this.stallReported)){let n=self.performance.now()-t;this.log(`playback not stuck anymore @${e}, after ${Math.round(n)}ms`),this.stallReported=!1,this.waiting=0,this.hls.trigger(l.STALL_RESOLVED,{})}}nudgeOnVideoHole(e,t){var n;let r=this.buffered.video;if(this.hls&&this.media&&this.fragmentTracker&&(n=this.buffered.audio)!=null&&n.length&&r&&r.length>1&&e>r.end(0)){let n=J.bufferedInfo(J.timeRangesToArray(this.buffered.audio),e,0);if(n.len>1&&t>=n.start){let n=J.timeRangesToArray(r),i=J.bufferedInfo(n,t,0).bufferedIndex;if(i>-1&&i<n.length-1){let t=J.bufferedInfo(n,e,0).bufferedIndex,r=n[i].end,a=n[i+1].start;if((t===-1||t>i)&&a-r<1&&e-r<2){let n=Error(`nudging playhead to flush pipeline after video hole. currentTime: ${e} hole: ${r} -> ${a} buffered index: ${t}`);this.warn(n.message),this.media.currentTime+=1e-6;let i=lu(e,this.fragmentTracker);i&&`fragment`in i?i=i.fragment:i||=void 0;let o=J.bufferInfo(this.media,e,0);this.hls.trigger(l.ERROR,{type:s.MEDIA_ERROR,details:c.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:n,reason:n.message,frag:i,buffer:o.len,bufferInfo:o})}}}}}_tryFixBufferStall(e,t,n){let{fragmentTracker:r,media:i}=this,a=this.hls?.config;if(!i||!r||!a)return;let o=this.hls?.latestLevelDetails,s=lu(n,r);if((s||o!=null&&o.live&&n<o.fragmentStart)&&(this._trySkipBufferHole(s)||!this.media))return;let c=e.buffered,l=this.adjacentTraversal(e,n);(c&&c.length>1&&e.len>a.maxBufferHole||e.nextStart&&(e.nextStart-n<a.maxBufferHole||l))&&(t>a.highBufferWatchdogPeriod*1e3||this.waiting)&&(this.warn(`Trying to nudge playhead over buffer-hole`),this._tryNudgeBuffer(e))}adjacentTraversal(e,t){let n=this.fragmentTracker,r=e.nextStart;if(n&&r){let e=n.getFragAtPos(t,d.MAIN),i=n.getFragAtPos(r,d.MAIN);if(e&&i)return i.sn-e.sn<2}return!1}_reportStall(e){let{hls:t,media:n,stallReported:r,stalled:i}=this;if(!r&&i!==null&&n&&t){this.stallReported=!0;let r=Error(`Playback stalling at @${n.currentTime} due to low buffer (${q(e)})`);this.warn(r.message),t.trigger(l.ERROR,{type:s.MEDIA_ERROR,details:c.BUFFER_STALLED_ERROR,fatal:!1,error:r,buffer:e.len,bufferInfo:e,stalled:{start:i}})}}_trySkipBufferHole(e){let{fragmentTracker:t,media:n}=this,r=this.hls?.config;if(!n||!t||!r)return 0;let i=n.currentTime,a=J.bufferInfo(n,i,0),o=i<a.start?a.start:a.nextStart;if(o&&this.hls){let f=a.len<=r.maxBufferHole,p=a.len>0&&a.len<1&&n.readyState<3,m=o-i;if(m>0&&(f||p)){if(m>r.maxBufferHole){let n=!1;if(i===0){let e=t.getAppendedFrag(0,d.MAIN);e&&o<e.end&&(n=!0)}if(!n&&e){var u;if(!((u=this.hls.loadLevelObj)!=null&&u.details)||su(this.hls.inFlightFragments,o))return 0;let n=!1,r=e.end;for(;r<o;){let e=lu(r,t);if(e)r+=e.duration;else{n=!0;break}}if(n)return 0}}let f=Math.max(o+iu,i+ru);if(this.warn(`skipping hole, adjusting currentTime from ${i} to ${f}`),this.moved=!0,n.currentTime=f,!(e!=null&&e.gap)){let t=Error(`fragment loaded with buffer holes, seeking from ${i} to ${f}`),n={type:s.MEDIA_ERROR,details:c.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:t,reason:t.message,buffer:a.len,bufferInfo:a};e&&(`fragment`in e?n.part=e:n.frag=e),this.hls.trigger(l.ERROR,n)}return f}}return 0}_tryNudgeBuffer(e){let{hls:t,media:n,nudgeRetry:r}=this,i=t?.config;if(!n||!i)return 0;let a=n.currentTime;if(this.nudgeRetry++,r<i.nudgeMaxRetry){let o=a+(r+1)*i.nudgeOffset,u=Error(`Nudging 'currentTime' from ${a} to ${o}`);this.warn(u.message),n.currentTime=o,t.trigger(l.ERROR,{type:s.MEDIA_ERROR,details:c.BUFFER_NUDGE_ON_STALL,error:u,fatal:!1,buffer:e.len,bufferInfo:e})}else{let n=Error(`Playhead still not moving while enough data buffered @${a} after ${i.nudgeMaxRetry} nudges`);this.error(n.message),t.trigger(l.ERROR,{type:s.MEDIA_ERROR,details:c.BUFFER_STALLED_ERROR,error:n,fatal:!0,buffer:e.len,bufferInfo:e})}}};function su(e,t){let n=cu(e.main);if(n&&n.start<=t)return n;let r=cu(e.audio);return r&&r.start<=t?r:null}function cu(e){if(!e)return null;switch(e.state){case X.IDLE:case X.STOPPED:case X.ENDED:case X.ERROR:return null}return e.frag}function lu(e,t){return t.getAppendedFrag(e,d.MAIN)||t.getPartialFragment(e)}var uu=.25;function du(){if(!(typeof self>`u`))return self.VTTCue||self.TextTrackCue}function fu(e,t,n,r,i){let a=new e(t,n,``);try{a.value=r,i&&(a.type=i)}catch{a=new e(t,n,q(i?_({type:i},r):r))}return a}var pu=(()=>{let e=du();try{e&&new e(0,1/0,``)}catch{return Number.MAX_VALUE}return 1/0})(),mu=class{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.removeCues=!0,this.assetCue=void 0,this.onEventCueEnter=()=>{this.hls&&this.hls.trigger(l.EVENT_CUE_ENTER,{})},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=this.onEventCueEnter=null}_registerListeners(){let{hls:e}=this;e&&(e.on(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(l.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(l.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(l.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this))}_unregisterListeners(){let{hls:e}=this;e&&(e.off(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(l.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(l.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(l.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this))}onMediaAttaching(e,t){this.media=t.media,t.overrides?.cueRemoval===!1&&(this.removeCues=!1)}onMediaAttached(){let e=this.hls?.latestLevelDetails;e&&this.updateDateRangeCues(e)}onMediaDetaching(e,t){this.media=null,!t.transferMedia&&(this.id3Track&&=(this.removeCues&&cc(this.id3Track,this.onEventCueEnter),null),this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){let t=this.getID3Track(e.textTracks);return t.mode=`hidden`,t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){let n=e[t];if(n.kind===`metadata`&&n.label===`id3`)return oc(n,this.media),n}return this.media.addTextTrack(`metadata`,`id3`)}}onFragParsingMetadata(e,t){if(!this.media||!this.hls)return;let{enableEmsgMetadataCues:n,enableID3MetadataCues:r}=this.hls.config;if(!n&&!r)return;let{samples:i}=t;this.id3Track||=this.createTrack(this.media);let a=du();if(a)for(let e=0;e<i.length;e++){let t=i[e].type;if(t===Xi.emsg&&!n||!r)continue;let o=Ki(i[e].data),s=i[e].pts,c=s+i[e].duration;c>pu&&(c=pu),c-s<=0&&(c=s+uu);for(let e=0;e<o.length;e++){let n=o[e];if(!qi(n)){this.updateId3CueEnds(s,t);let e=fu(a,s,c,n,t);e&&this.id3Track.addCue(e)}}}}updateId3CueEnds(e,t){let n=this.id3Track?.cues;if(n)for(let r=n.length;r--;){let i=n[r];i.type===t&&i.startTime<e&&i.endTime===pu&&(i.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:n,type:r}){let{id3Track:i,hls:a}=this;if(!a)return;let{config:{enableEmsgMetadataCues:o,enableID3MetadataCues:s}}=a;if(i&&(o||s)){let e;e=r===`audio`?e=>e.type===Xi.audioId3&&s:r===`video`?e=>e.type===Xi.emsg&&o:e=>e.type===Xi.audioId3&&s||e.type===Xi.emsg&&o,lc(i,t,n,e)}}onLevelUpdated(e,{details:t}){this.updateDateRangeCues(t,!0)}onLevelPtsUpdated(e,t){Math.abs(t.drift)>.01&&this.updateDateRangeCues(t.details)}updateDateRangeCues(e,t){if(!this.hls||!this.media)return;let{assetPlayerId:n,timelineOffset:r,enableDateRangeMetadataCues:a,interstitialsController:o}=this.hls.config;if(!a)return;let s=du();if(n&&r&&!o){let{fragmentStart:t,fragmentEnd:r}=e,i=this.assetCue;i?(i.startTime=t,i.endTime=r):s&&(i=this.assetCue=fu(s,t,r,{assetPlayerId:this.hls.config.assetPlayerId},`hlsjs.interstitial.asset`),i&&(i.id=n,this.id3Track||=this.createTrack(this.media),this.id3Track.addCue(i),i.addEventListener(`enter`,this.onEventCueEnter)))}if(!e.hasProgramDateTime)return;let{id3Track:c}=this,{dateRanges:l}=e,u=Object.keys(l),d=this.dateRangeCuesAppended;if(c&&t){var f;if((f=c.cues)!=null&&f.length){let e=Object.keys(d).filter(e=>!u.includes(e));for(let t=e.length;t--;){let n=e[t],r=d[n]?.cues;delete d[n],r&&Object.keys(r).forEach(e=>{let t=r[e];if(t){t.removeEventListener(`enter`,this.onEventCueEnter);try{c.removeCue(t)}catch{}}})}}else d=this.dateRangeCuesAppended={}}let p=e.fragments[e.fragments.length-1];if(!(u.length===0||!i(p?.programDateTime))){this.id3Track||=this.createTrack(this.media);for(let e=0;e<u.length;e++){let t=u[e],n=l[t],r=n.startTime,i=d[t],a=i?.cues||{},c=i?.durationKnown||!1,f=pu,{duration:p,endDate:m}=n;if(m&&p!==null)f=r+p,c=!0;else if(n.endOnNext&&!c){let e=u.reduce((e,t)=>{if(t!==n.id){let r=l[t];if(r.class===n.class&&r.startDate>n.startDate&&(!e||n.startDate<e.startDate))return r}return e},null);e&&(f=e.startTime,c=!0)}let h=Object.keys(n.attr);for(let e=0;e<h.length;e++){let l=h[e];if(!Ln(l))continue;let u=a[l];if(u)c&&!(i!=null&&i.durationKnown)?u.endTime=f:Math.abs(u.startTime-r)>.01&&(u.startTime=r,u.endTime=f);else if(s){let e=n.attr[l];Rn(l)&&(e=P(e));let i=fu(s,r,f,{key:l,data:e},Xi.dateRange);i&&(i.id=t,this.id3Track.addCue(i),a[l]=i,o&&(l===`X-ASSET-LIST`||l===`X-ASSET-URL`)&&i.addEventListener(`enter`,this.onEventCueEnter))}}d[t]={cues:a,dateRange:n,durationKnown:c}}}}},hu=class{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.currentTime=0,this.stallCount=0,this._latency=null,this._targetLatencyUpdated=!1,this.onTimeupdate=()=>{let{media:e}=this,t=this.levelDetails;if(!e||!t)return;this.currentTime=e.currentTime;let n=this.computeLatency();if(n===null)return;this._latency=n;let{lowLatencyMode:r,maxLiveSyncPlaybackRate:i}=this.config;if(!r||i===1||!t.live)return;let a=this.targetLatency;if(a===null)return;let o=n-a;if(o<Math.min(this.maxLatency,a+t.targetduration)&&o>.05&&this.forwardBufferLength>1){let t=Math.min(2,Math.max(1,i)),n=Math.round(2/(1+Math.exp(-.75*o-this.edgeStalled))*20)/20,r=Math.min(t,Math.max(1,n));this.changeMediaPlaybackRate(e,r)}else e.playbackRate!==1&&e.playbackRate!==0&&this.changeMediaPlaybackRate(e,1)},this.hls=e,this.config=e.config,this.registerListeners()}get levelDetails(){return this.hls?.latestLevelDetails||null}get latency(){return this._latency||0}get maxLatency(){let{config:e}=this;if(e.liveMaxLatencyDuration!==void 0)return e.liveMaxLatencyDuration;let t=this.levelDetails;return t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){let e=this.levelDetails;if(e===null||this.hls===null)return null;let{holdBack:t,partHoldBack:n,targetduration:r}=e,{liveSyncDuration:i,liveSyncDurationCount:a,lowLatencyMode:o}=this.config,s=this.hls.userConfig,c=o&&n||t;(this._targetLatencyUpdated||s.liveSyncDuration||s.liveSyncDurationCount||c===0)&&(c=i===void 0?a*r:i);let l=r;return c+Math.min(this.stallCount*this.config.liveSyncOnStallIncrease,l)}set targetLatency(e){this.stallCount=0,this.config.liveSyncDuration=e,this._targetLatencyUpdated=!0}get liveSyncPosition(){let e=this.estimateLiveEdge(),t=this.targetLatency;if(e===null||t===null)return null;let n=this.levelDetails;if(n===null)return null;let r=n.edge,i=e-t-this.edgeStalled,a=r-n.totalduration,o=r-(this.config.lowLatencyMode&&n.partTarget||n.targetduration);return Math.min(Math.max(a,i),o)}get drift(){let e=this.levelDetails;return e===null?1:e.drift}get edgeStalled(){let e=this.levelDetails;if(e===null)return 0;let t=(this.config.lowLatencyMode&&e.partTarget||e.targetduration)*3;return Math.max(e.age-t,0)}get forwardBufferLength(){let{media:e}=this,t=this.levelDetails;if(!e||!t)return 0;let n=e.buffered.length;return(n?e.buffered.end(n-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.hls=null}registerListeners(){let{hls:e}=this;e&&(e.on(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(l.ERROR,this.onError,this))}unregisterListeners(){let{hls:e}=this;e&&(e.off(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(l.ERROR,this.onError,this))}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener(`timeupdate`,this.onTimeupdate)}onMediaDetaching(){this.media&&=(this.media.removeEventListener(`timeupdate`,this.onTimeupdate),null)}onManifestLoading(){this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){t.advanced&&this.onTimeupdate(),!t.live&&this.media&&this.media.removeEventListener(`timeupdate`,this.onTimeupdate)}onError(e,t){var n;t.details===c.BUFFER_STALLED_ERROR&&(this.stallCount++,this.hls&&(n=this.levelDetails)!=null&&n.live&&this.hls.logger.warn(`[latency-controller]: Stall detected, adjusting target latency`))}changeMediaPlaybackRate(e,t){var n;e.playbackRate!==t&&((n=this.hls)==null||n.logger.debug(`[latency-controller]: latency=${this.latency.toFixed(3)}, targetLatency=${this.targetLatency?.toFixed(3)}, forwardBufferLength=${this.forwardBufferLength.toFixed(3)}: adjusting playback rate from ${e.playbackRate} to ${t}`),e.playbackRate=t)}estimateLiveEdge(){let e=this.levelDetails;return e===null?null:e.edge+e.age}computeLatency(){let e=this.estimateLiveEdge();return e===null?null:e-this.currentTime}},gu=class extends go{constructor(e,t){super(e,`level-controller`),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){let{hls:e}=this;e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(l.LEVEL_LOADED,this.onLevelLoaded,this),e.on(l.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(l.FRAG_BUFFERED,this.onFragBuffered,this),e.on(l.ERROR,this.onError,this)}_unregisterListeners(){let{hls:e}=this;e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(l.LEVEL_LOADED,this.onLevelLoaded,this),e.off(l.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(l.FRAG_BUFFERED,this.onFragBuffered,this),e.off(l.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(e=>{e.loadError=0,e.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){let n=this.hls.config.preferManagedMediaSource,r=[],i={},a={},o=!1,s=!1,c=!1;t.levels.forEach(e=>{let t=e.attrs,{audioCodec:l,videoCodec:u}=e;l&&(e.audioCodec=l=qe(l,n)||void 0),u&&=e.videoCodec=Ze(u);let{width:d,height:f,unknownCodecs:p}=e,m=p?.length||0;if(o||=!!(d&&f),s||=!!u,c||=!!l,m||l&&!this.isAudioSupported(l)||u&&!this.isVideoSupported(u)){this.log(`Some or all CODECS not supported "${t.CODECS}"`);return}let{CODECS:h,"FRAME-RATE":g,"HDCP-LEVEL":_,"PATHWAY-ID":v,RESOLUTION:y,"VIDEO-RANGE":b}=t,x=`${`${v||`.`}-`}${e.bitrate}-${y}-${g}-${h}-${b}-${_}`;if(i[x])if(i[x].uri!==e.url&&!e.attrs[`PATHWAY-ID`]){let t=a[x]+=1;e.attrs[`PATHWAY-ID`]=Array(t+1).join(`.`);let n=this.createLevel(e);i[x]=n,r.push(n)}else i[x].addGroupId(`audio`,t.AUDIO),i[x].addGroupId(`text`,t.SUBTITLES);else{let t=this.createLevel(e);i[x]=t,a[x]=1,r.push(t)}}),this.filterAndSortMediaOptions(r,t,o,s,c)}createLevel(e){let t=new yt(e),n=e.supplemental;if(n!=null&&n.videoCodec&&!this.isVideoSupported(n.videoCodec)){let e=Error(`SUPPLEMENTAL-CODECS not supported "${n.videoCodec}"`);this.log(e.message),t.supportedResult=it(e,[])}return t}isAudioSupported(e){return ze(e,`audio`,this.hls.config.preferManagedMediaSource)}isVideoSupported(e){return ze(e,`video`,this.hls.config.preferManagedMediaSource)}filterAndSortMediaOptions(e,t,n,r,i){let a=[],o=[],u=e,d=t.stats?.parsing||{};if((n||r)&&i&&(u=u.filter(({videoCodec:e,videoRange:t,width:n,height:r})=>(!!e||!!(n&&r))&&ht(t))),u.length===0){Promise.resolve().then(()=>{if(this.hls){let e=`no level with compatible codecs found in manifest`,n=e;t.levels.length&&(n=`one or more CODECS in variant not supported: ${q(t.levels.map(e=>e.attrs.CODECS).filter((e,t,n)=>n.indexOf(e)===t))}`,this.warn(n),e+=` (${n})`);let r=Error(e);this.hls.trigger(l.ERROR,{type:s.MEDIA_ERROR,details:c.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:r,reason:n})}}),d.end=performance.now();return}t.audioTracks&&(a=t.audioTracks.filter(e=>!e.audioCodec||this.isAudioSupported(e.audioCodec)),_u(a)),t.subtitles&&(o=t.subtitles,_u(o));let f=u.slice(0);u.sort((e,t)=>{if(e.attrs[`HDCP-LEVEL`]!==t.attrs[`HDCP-LEVEL`])return(e.attrs[`HDCP-LEVEL`]||``)>(t.attrs[`HDCP-LEVEL`]||``)?1:-1;if(n&&e.height!==t.height)return e.height-t.height;if(e.frameRate!==t.frameRate)return e.frameRate-t.frameRate;if(e.videoRange!==t.videoRange)return mt.indexOf(e.videoRange)-mt.indexOf(t.videoRange);if(e.videoCodec!==t.videoCodec){let n=He(e.videoCodec),r=He(t.videoCodec);if(n!==r)return r-n}if(e.uri===t.uri&&e.codecSet!==t.codecSet){let n=Ue(e.codecSet),r=Ue(t.codecSet);if(n!==r)return r-n}return e.averageBitrate===t.averageBitrate?0:e.averageBitrate-t.averageBitrate});let p=f[0];if(this.steering&&(u=this.steering.filterParsedLevels(u),u.length!==f.length)){for(let e=0;e<f.length;e++)if(f[e].pathwayId===u[0].pathwayId){p=f[e];break}}this._levels=u;for(let e=0;e<u.length;e++)if(u[e]===p){this._firstLevel=e;let t=p.bitrate,n=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${u.length} level(s) found, first bitrate: ${t}`),this.hls.userConfig?.abrEwmaDefaultEstimate===void 0){let e=Math.min(t,this.hls.config.abrEwmaDefaultEstimateMax);e>n&&n===this.hls.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=e)}break}let m=i&&!r,h=this.hls.config,g=!!(h.audioStreamController&&h.audioTrackController),_={levels:u,audioTracks:a,subtitleTracks:o,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:i,video:r,altAudio:g&&!m&&a.some(e=>!!e.url)};d.end=performance.now(),this.hls.trigger(l.MANIFEST_PARSED,_)}get levels(){return this._levels.length===0?null:this._levels}get loadLevelObj(){return this.currentLevel}get level(){return this.currentLevelIndex}set level(e){let t=this._levels;if(t.length===0)return;if(e<0||e>=t.length){let n=Error(`invalid level idx`),r=e<0;if(this.hls.trigger(l.ERROR,{type:s.OTHER_ERROR,details:c.LEVEL_SWITCH_ERROR,level:e,fatal:r,error:n,reason:n.message}),r)return;e=Math.min(e,t.length-1)}let n=this.currentLevelIndex,r=this.currentLevel,i=r?r.attrs[`PATHWAY-ID`]:void 0,a=t[e],o=a.attrs[`PATHWAY-ID`];if(this.currentLevelIndex=e,this.currentLevel=a,n===e&&r&&i===o)return;this.log(`Switching to level ${e} (${a.height?a.height+`p `:``}${a.videoRange?a.videoRange+` `:``}${a.codecSet?a.codecSet+` `:``}@${a.bitrate})${o?` with Pathway `+o:``} from level ${n}${i?` with Pathway `+i:``}`);let u={level:e,attrs:a.attrs,details:a.details,bitrate:a.bitrate,averageBitrate:a.averageBitrate,maxBitrate:a.maxBitrate,realBitrate:a.realBitrate,width:a.width,height:a.height,codecSet:a.codecSet,audioCodec:a.audioCodec,videoCodec:a.videoCodec,audioGroups:a.audioGroups,subtitleGroups:a.subtitleGroups,loaded:a.loaded,loadError:a.loadError,fragmentError:a.fragmentError,name:a.name,id:a.id,uri:a.uri,url:a.url,urlId:0,audioGroupIds:a.audioGroupIds,textGroupIds:a.textGroupIds};this.hls.trigger(l.LEVEL_SWITCHING,u);let d=a.details;if(!d||d.live){let e=this.switchParams(a.uri,r?.details,d);this.loadPlaylist(e)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,this._startLevel===void 0&&(this._startLevel=e),e!==-1&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(this._startLevel===void 0){let e=this.hls.config.startLevel;return e===void 0?this.hls.firstAutoLevel:e}return this._startLevel}set startLevel(e){this._startLevel=e}get pathways(){return this.steering?this.steering.pathways():[]}get pathwayPriority(){return this.steering?this.steering.pathwayPriority:null}set pathwayPriority(e){if(this.steering){let t=this.steering.pathways(),n=e.filter(e=>t.indexOf(e)!==-1);if(e.length<1){this.warn(`pathwayPriority ${e} should contain at least one pathway from list: ${t}`);return}this.steering.pathwayPriority=n}}onError(e,t){t.fatal||!t.context||t.context.type===u.LEVEL&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(t!==void 0&&t.type===d.MAIN){let e=t.elementaryStreams;if(!Object.keys(e).some(t=>!!e[t]))return;let n=this._levels[t.level];n!=null&&n.loadError&&(this.log(`Resetting level error count of ${n.loadError} on frag buffered`),n.loadError=0)}}onLevelLoaded(e,t){var n;let{level:r,details:i}=t,a=t.levelInfo;if(!a){var o;this.warn(`Invalid level index ${r}`),(o=t.deliveryDirectives)!=null&&o.skip&&(i.deltaUpdateFailed=!0);return}if(a===this.currentLevel||t.withoutMultiVariant){a.fragmentError===0&&(a.loadError=0);let e=a.details;e===t.details&&e.advanced&&(e=void 0),this.playlistLoaded(r,t,e)}else (n=t.deliveryDirectives)!=null&&n.skip&&(i.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentLevel)&&this.scheduleLoading(this.currentLevel,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);let n=this.getUrlWithDirectives(e.uri,t),r=this.currentLevelIndex,i=e.attrs[`PATHWAY-ID`],a=e.details,o=a?.age;this.log(`Loading level index ${r}${t?.msn===void 0?``:` at sn `+t.msn+` part `+t.part}${i?` Pathway `+i:``}${o&&a.live?` age `+o.toFixed(1)+(a.type&&` `+a.type||``):``} ${n}`),this.hls.trigger(l.LEVEL_LOADING,{url:n,level:r,levelInfo:e,pathwayId:e.attrs[`PATHWAY-ID`],id:0,deliveryDirectives:t||null})}get nextLoadLevel(){return this.manualLevelIndex===-1?this.hls.nextAutoLevel:this.manualLevelIndex}set nextLoadLevel(e){this.level=e,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;if(this._levels.length===1)return;let n=this._levels.filter((t,n)=>n===e?(this.steering&&this.steering.removeLevel(t),t===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,t.details&&t.details.fragments.forEach(e=>e.level=-1)),!1):!0);Ur(n),this._levels=n,this.currentLevelIndex>-1&&(t=this.currentLevel)!=null&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.manualLevelIndex>-1&&(this.manualLevelIndex=this.currentLevelIndex);let r=n.length-1;this._firstLevel=Math.min(this._firstLevel,r),this._startLevel&&=Math.min(this._startLevel,r),this.hls.trigger(l.LEVELS_UPDATED,{levels:n})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){let{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:n}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(l.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:n}))}};function _u(e){let t={};e.forEach(e=>{let n=e.groupId||``;e.id=t[n]=t[n]||0,t[n]++})}function vu(){return self.SourceBuffer||self.WebKitSourceBuffer}function yu(){if(!k())return!1;let e=vu();return!e||e.prototype&&typeof e.prototype.appendBuffer==`function`&&typeof e.prototype.remove==`function`}function bu(){if(!yu())return!1;let e=k();return typeof e?.isTypeSupported==`function`&&([`avc1.42E01E,mp4a.40.2`,`av01.0.01M.08`,`vp09.00.50.08`].some(t=>e.isTypeSupported(Ve(t,`video`)))||[`mp4a.40.2`,`fLaC`].some(t=>e.isTypeSupported(Ve(t,`audio`))))}function xu(){var e;let t=vu();return typeof(t==null||(e=t.prototype)==null?void 0:e.changeType)==`function`}var Su=100,Cu=class extends ni{constructor(e,t,n){super(e,t,n,`stream-controller`,d.MAIN),this.audioCodecSwap=!1,this.level=-1,this._forceStartLoad=!1,this._hasEnoughToStart=!1,this.altAudio=0,this.audioOnly=!1,this.fragPlaying=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this.onMediaPlaying=()=>{this.tick()},this.onMediaSeeked=()=>{let e=this.media,t=e?e.currentTime:null;if(t===null||!i(t)||(this.log(`Media seeked to ${t.toFixed(3)}`),!this.getBufferedFrag(t)))return;let n=this.getFwdBufferInfoAtPos(e,t,d.MAIN,0);if(n===null||n.len===0){this.warn(`Main forward buffer length at ${t} on "seeked" event ${n?n.len:`empty`})`);return}this.tick()},this.registerListeners()}registerListeners(){super.registerListeners();let{hls:e}=this;e.on(l.MANIFEST_PARSED,this.onManifestParsed,this),e.on(l.LEVEL_LOADING,this.onLevelLoading,this),e.on(l.LEVEL_LOADED,this.onLevelLoaded,this),e.on(l.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(l.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(l.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(l.BUFFER_CREATED,this.onBufferCreated,this),e.on(l.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(l.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(l.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){super.unregisterListeners();let{hls:e}=this;e.off(l.MANIFEST_PARSED,this.onManifestParsed,this),e.off(l.LEVEL_LOADED,this.onLevelLoaded,this),e.off(l.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(l.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(l.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(l.BUFFER_CREATED,this.onBufferCreated,this),e.off(l.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(l.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(l.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this.onMediaPlaying=this.onMediaSeeked=null,this.unregisterListeners(),super.onHandlerDestroying()}startLoad(e,t){if(this.levels){let{lastCurrentTime:n,hls:r}=this;if(this.stopLoad(),this.setInterval(Su),this.level=-1,!this.startFragRequested){let e=r.startLevel;e===-1&&(r.config.testBandwidth&&this.levels.length>1?(e=0,this.bitrateTest=!0):e=r.firstAutoLevel),r.nextLoadLevel=e,this.level=r.loadLevel,this._hasEnoughToStart=!!t}n>0&&e===-1&&!t&&(this.log(`Override startPosition with lastCurrentTime @${n.toFixed(3)}`),e=n),this.state=X.IDLE,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}else this._forceStartLoad=!0,this.state=X.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case X.WAITING_LEVEL:{let{levels:e,level:t}=this,n=e?.[t],r=n?.details;if(r&&(!r.live||this.levelLastLoaded===n&&!this.waitForLive(n))){if(this.waitForCdnTuneIn(r))break;this.state=X.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=X.IDLE;break}break}case X.FRAG_LOADING_WAITING_RETRY:this.checkRetryDate();break}this.state===X.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){var e;super.onTickEnd(),(e=this.media)!=null&&e.readyState&&this.media.seeking===!1&&(this.lastCurrentTime=this.media.currentTime),this.checkFragmentChanged()}doTickIdle(){let{hls:e,levelLastLoaded:t,levels:n,media:r}=this;if(t===null||!r&&!this.primaryPrefetch&&(this.startFragRequested||!e.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;let i=this.buffering?e.nextLoadLevel:e.loadLevel;if(!(n!=null&&n[i]))return;let a=n[i],o=this.getMainFwdBufferInfo();if(o===null)return;let s=this.getLevelDetails();if(s&&this._streamEnded(o,s)){let e={};this.altAudio===2&&(e.type=`video`),this.hls.trigger(l.BUFFER_EOS,e),this.state=X.ENDED;return}if(!this.buffering)return;e.loadLevel!==i&&e.manualLevel===-1&&this.log(`Adapting to level ${i} from level ${this.level}`),this.level=e.nextLoadLevel=i;let c=a.details;if(!c||this.state===X.WAITING_LEVEL||this.waitForLive(a)){this.level=i,this.state=X.WAITING_LEVEL,this.startFragRequested=!1;return}let u=o.len,f=this.getMaxBufferLength(a.maxBitrate);if(u>=f)return;this.backtrackFragment&&this.backtrackFragment.start>o.end&&(this.backtrackFragment=null);let p=this.backtrackFragment?this.backtrackFragment.start:o.end,m=this.getNextFragment(p,c);if(this.couldBacktrack&&!this.fragPrevious&&m&&H(m)&&this.fragmentTracker.getState(m)!==an.OK){let e=(this.backtrackFragment??m).sn-c.startSN,t=c.fragments[e-1];t&&m.cc===t.cc&&(m=t,this.fragmentTracker.removeFragment(t))}else this.backtrackFragment&&o.len&&(this.backtrackFragment=null);if(m&&this.isLoopLoading(m,p)){if(!m.gap){let e=this.audioOnly&&!this.altAudio?V.AUDIO:V.VIDEO,t=(e===V.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;t&&this.afterBufferFlushed(t,e,d.MAIN)}m=this.getNextFragmentLoopLoading(m,c,o,d.MAIN,f)}m&&(m.initSegment&&!m.initSegment.data&&!this.bitrateTest&&(m=m.initSegment),this.loadFragment(m,a,p))}loadFragment(e,t,n){let r=this.fragmentTracker.getState(e);r===an.NOT_LOADED||r===an.PARTIAL?H(e)?this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):super.loadFragment(e,t,n):this._loadInitSegment(e,t):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,d.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,1/0)}nextLevelSwitch(){let{levels:e,media:t}=this;if(t!=null&&t.readyState){let n,r=this.getAppendedFrag(t.currentTime);r&&r.start>1&&this.flushMainBuffer(0,r.start-1);let i=this.getLevelDetails();if(i!=null&&i.live){let e=this.getMainFwdBufferInfo();if(!e||e.len<i.targetduration*2)return}if(!t.paused&&e){let t=e[this.hls.nextLoadLevel],r=this.fragLastKbps;n=r&&this.fragCurrent?this.fragCurrent.duration*t.maxBitrate/(1e3*r)+1:0}else n=0;let a=this.getBufferedFrag(t.currentTime+n);if(a){let e=this.followingBufferedFrag(a);if(e){this.abortCurrentFrag();let t=e.maxStartPTS?e.maxStartPTS:e.start,n=e.duration,r=Math.max(a.end,t+Math.min(Math.max(n-this.config.maxFragLookUpTolerance,n*(this.couldBacktrack?.5:.125)),n*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(r,1/0)}}}}abortCurrentFrag(){let e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case X.KEY_LOADING:case X.FRAG_LOADING:case X.FRAG_LOADING_WAITING_RETRY:case X.PARSING:case X.PARSED:this.state=X.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio===2?`video`:null)}onMediaAttached(e,t){super.onMediaAttached(e,t);let n=t.media;$r(n,`playing`,this.onMediaPlaying),$r(n,`seeked`,this.onMediaSeeked)}onMediaDetaching(e,t){let{media:n}=this;n&&(ei(n,`playing`,this.onMediaPlaying),ei(n,`seeked`,this.onMediaSeeked)),this.videoBuffer=null,this.fragPlaying=null,super.onMediaDetaching(e,t),!t.transferMedia&&(this._hasEnoughToStart=!1)}onManifestLoading(){super.onManifestLoading(),this.log(`Trigger BUFFER_RESET`),this.hls.trigger(l.BUFFER_RESET,void 0),this.couldBacktrack=!1,this.fragLastKbps=0,this.fragPlaying=this.backtrackFragment=null,this.altAudio=0,this.audioOnly=!1}onManifestParsed(e,t){let n=!1,r=!1;for(let e=0;e<t.levels.length;e++){let i=t.levels[e].audioCodec;i&&(n||=i.indexOf(`mp4a.40.2`)!==-1,r||=i.indexOf(`mp4a.40.5`)!==-1)}this.audioCodecSwitch=n&&r&&!xu(),this.audioCodecSwitch&&this.log(`Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC`),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){let{levels:n}=this;if(!n||this.state!==X.IDLE)return;let r=t.levelInfo;(!r.details||r.details.live&&(this.levelLastLoaded!==r||r.details.expired)||this.waitForCdnTuneIn(r.details))&&(this.state=X.WAITING_LEVEL)}onLevelLoaded(e,t){var n;let{levels:r,startFragRequested:i}=this,a=t.level,o=t.details,s=o.totalduration;if(!r){this.warn(`Levels were reset while loading level ${a}`);return}this.log(`Level ${a} loaded [${o.startSN},${o.endSN}]${o.lastPartSn?`[part-${o.lastPartSn}-${o.lastPartIndex}]`:``}, cc [${o.startCC}, ${o.endCC}] duration:${s}`);let c=t.levelInfo,u=this.fragCurrent;u&&(this.state===X.FRAG_LOADING||this.state===X.FRAG_LOADING_WAITING_RETRY)&&u.level!==t.level&&u.loader&&this.abortCurrentFrag();let d=0;if(o.live||(n=c.details)!=null&&n.live){if(this.checkLiveUpdate(o),o.deltaUpdateFailed)return;d=this.alignPlaylists(o,c.details,this.levelLastLoaded?.details)}if(c.details=o,this.levelLastLoaded=c,i||this.setStartPosition(o,d),this.hls.trigger(l.LEVEL_UPDATED,{details:o,level:a}),this.state===X.WAITING_LEVEL){if(this.waitForCdnTuneIn(o))return;this.state=X.IDLE}i&&o.live&&this.synchronizeToLiveEdge(o),this.tick()}synchronizeToLiveEdge(e){let{config:t,media:n}=this;if(!n)return;let r=this.hls.liveSyncPosition,i=this.getLoadPosition(),a=e.fragmentStart,o=e.edge,s=i>=a-t.maxFragLookUpTolerance&&i<=o;if(r!==null&&n.duration>r&&(i<r||!s)){let a=t.liveMaxLatencyDuration===void 0?t.liveMaxLatencyDurationCount*e.targetduration:t.liveMaxLatencyDuration;if((!s&&n.readyState<4||i<o-a)&&(this._hasEnoughToStart||(this.nextLoadPosition=r),n.readyState))if(this.warn(`Playback: ${i.toFixed(3)} is located too far from the end of live sliding playlist: ${o}, reset currentTime to : ${r.toFixed(3)}`),this.config.liveSyncMode===`buffered`){var c;let e=J.bufferInfo(n,r,0);if(!((c=e.buffered)!=null&&c.length)){n.currentTime=r;return}if(e.start<=i){n.currentTime=r;return}let{nextStart:t}=J.bufferedInfo(e.buffered,i,0);t&&(n.currentTime=t)}else n.currentTime=r}}_handleFragmentLoadProgress(e){let t=e.frag,{part:n,payload:r}=e,{levels:i}=this;if(!i){this.warn(`Levels were reset while fragment load was in progress. Fragment ${t.sn} of level ${t.level} will not be buffered`);return}let a=i[t.level];if(!a){this.warn(`Level ${t.level} not found on progress`);return}let o=a.details;if(!o){this.warn(`Dropping fragment ${t.sn} of level ${t.level} after level details were reset`),this.fragmentTracker.removeFragment(t);return}let s=a.videoCodec,c=o.PTSKnown||!o.live,l=t.initSegment?.data,u=this._getAudioCodec(a),f=this.transmuxer=this.transmuxer||new po(this.hls,d.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),p=n?n.index:-1,m=p!==-1,h=new Tn(t.level,t.sn,t.stats.chunkCount,r.byteLength,p,m),g=this.initPTS[t.cc];f.push(r,l,u,s,t,n,o.totalduration,c,h,g)}onAudioTrackSwitching(e,t){let n=this.hls,r=this.altAudio!==0;if(It(t.url,n))this.altAudio=1;else{if(this.mediaBuffer!==this.media){this.log(`Switching on main audio, use media.buffered to schedule main fragment loading`),this.mediaBuffer=this.media;let e=this.fragCurrent;e&&(this.log(`Switching to main audio track, cancel main fragment load`),e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();if(r){this.altAudio=0,this.fragmentTracker.removeAllFragments(),n.once(l.BUFFER_FLUSHED,()=>{this.hls&&this.hls.trigger(l.AUDIO_TRACK_SWITCHED,t)}),n.trigger(l.BUFFER_FLUSHING,{startOffset:0,endOffset:1/0,type:null});return}n.trigger(l.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){let n=It(t.url,this.hls);if(n){let e=this.videoBuffer;e&&this.mediaBuffer!==e&&(this.log(`Switching on alternate audio, use video.buffered to schedule main fragment loading`),this.mediaBuffer=e)}this.altAudio=n?2:0,this.tick()}onBufferCreated(e,t){let n=t.tracks,r,i,a=!1;for(let e in n){let t=n[e];if(t.id===`main`){if(i=e,r=t,e===`video`){let t=n[e];t&&(this.videoBuffer=t.buffer)}}else a=!0}a&&r?(this.log(`Alternate track found, use ${i}.buffered to schedule main fragment loading`),this.mediaBuffer=r.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){let{frag:n,part:r}=t,i=n.type===d.MAIN;if(i){if(this.fragContextChanged(n)){this.warn(`Fragment ${n.sn}${r?` p: `+r.index:``} of level ${n.level} finished buffering, but was aborted. state: ${this.state}`),this.state===X.PARSED&&(this.state=X.IDLE);return}let e=r?r.stats:n.stats;this.fragLastKbps=Math.round(8*e.total/(e.buffering.end-e.loading.first)),H(n)&&(this.fragPrevious=n),this.fragBufferedComplete(n,r)}let a=this.media;a&&(!this._hasEnoughToStart&&J.getBuffered(a).length&&(this._hasEnoughToStart=!0,this.seekToStartPos()),i&&this.tick())}get hasEnoughToStart(){return this._hasEnoughToStart}onError(e,t){if(t.fatal){this.state=X.ERROR;return}switch(t.details){case c.FRAG_GAP:case c.FRAG_PARSING_ERROR:case c.FRAG_DECRYPT_ERROR:case c.FRAG_LOAD_ERROR:case c.FRAG_LOAD_TIMEOUT:case c.KEY_LOAD_ERROR:case c.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(d.MAIN,t);break;case c.LEVEL_LOAD_ERROR:case c.LEVEL_LOAD_TIMEOUT:case c.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===X.WAITING_LEVEL&&t.context?.type===u.LEVEL&&(this.state=X.IDLE);break;case c.BUFFER_ADD_CODEC_ERROR:case c.BUFFER_APPEND_ERROR:if(t.parent!==`main`)return;this.reduceLengthAndFlushBuffer(t)&&this.resetLoadingState();break;case c.BUFFER_FULL_ERROR:if(t.parent!==`main`)return;this.reduceLengthAndFlushBuffer(t)&&(!this.config.interstitialsController&&this.config.assetPlayerId?this._hasEnoughToStart=!0:this.flushMainBuffer(0,1/0));break;case c.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onFragLoadEmergencyAborted(){this.state=X.IDLE,this._hasEnoughToStart||(this.startFragRequested=!1,this.nextLoadPosition=this.lastCurrentTime),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==V.AUDIO||!this.altAudio){let e=(t===V.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;e&&(this.afterBufferFlushed(e,t,d.MAIN),this.tick())}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level,this.level===-1&&this.resetWhenMissingContext(this.fragCurrent)),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){let{media:e}=this;if(!e)return;let t=e.currentTime,n=this.startPosition;if(n>=0&&t<n){if(e.seeking){this.log(`could not seek to ${n}, already seeking at ${t}`);return}let r=this.timelineOffset;r&&n&&(n+=r);let i=this.getLevelDetails(),a=J.getBuffered(e),o=a.length?a.start(0):0,s=o-n,c=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);(this.config.startOnSegmentBoundary||s>0&&(s<c||this.loadingParts&&s<2*(i?.partTarget||0)))&&(this.log(`adjusting start position by ${s} to match buffer start`),n+=s,this.startPosition=n),t<n&&(this.log(`seek to target start position ${n} from current time ${t} buffer start ${o}`),e.currentTime=n)}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log(`Swapping audio codec`),t=t.indexOf(`mp4a.40.5`)===-1?`mp4a.40.5`:`mp4a.40.2`),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then(e=>{let{hls:n}=this,r=e?.frag;if(!r||this.fragContextChanged(r))return;t.fragmentError=0,this.state=X.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;let i=r.stats;i.parsing.start=i.parsing.end=i.buffering.start=i.buffering.end=self.performance.now(),n.trigger(l.FRAG_LOADED,e),r.bitrateTest=!1}).catch(t=>{this.state===X.STOPPED||this.state===X.ERROR||(this.warn(t),this.resetFragmentLoading(e))})}_handleTransmuxComplete(e){let t=this.playlistType,{hls:n}=this,{remuxResult:r,chunkMeta:a}=e,o=this.getCurrentContext(a);if(!o){this.resetWhenMissingContext(a);return}let{frag:s,part:c,level:u}=o,{video:d,text:f,id3:p,initSegment:m}=r,{details:h}=u,g=this.altAudio?void 0:r.audio;if(this.fragContextChanged(s)){this.fragmentTracker.removeFragment(s);return}if(this.state=X.PARSING,m){let e=m.tracks;if(e){let r=s.initSegment||s;if(this.unhandledEncryptionError(m,s))return;this._bufferInitSegment(u,e,r,a),n.trigger(l.FRAG_PARSING_INIT_SEGMENT,{frag:r,id:t,tracks:e})}let r=m.initPTS,o=m.timescale,c=this.initPTS[s.cc];if(i(r)&&(!c||c.baseTime!==r||c.timescale!==o)){let e=m.trackId;this.initPTS[s.cc]={baseTime:r,timescale:o,trackId:e},n.trigger(l.INIT_PTS_FOUND,{frag:s,id:t,initPTS:r,timescale:o,trackId:e})}}if(d&&h){g&&d.type===`audiovideo`&&this.logMuxedErr(s);let e=h.fragments[s.sn-1-h.startSN],t=s.sn===h.startSN,n=!e||s.cc>e.cc;if(r.independent!==!1){let{startPTS:e,endPTS:r,startDTS:i,endDTS:o}=d;if(c)c.elementaryStreams[d.type]={startPTS:e,endPTS:r,startDTS:i,endDTS:o};else if(d.firstKeyFrame&&d.independent&&a.id===1&&!n&&(this.couldBacktrack=!0),d.dropped&&d.independent){let i=this.getMainFwdBufferInfo(),a=(i?i.end:this.getLoadPosition())+this.config.maxBufferHole,c=d.firstKeyFramePTS?d.firstKeyFramePTS:e;if(!t&&a<c-this.config.maxBufferHole&&!n){this.backtrack(s);return}else n&&(s.gap=!0);s.setElementaryStreamInfo(d.type,s.start,r,s.start,o,!0)}else t&&e-(h.appliedTimelineOffset||0)>nu&&(s.gap=!0);s.setElementaryStreamInfo(d.type,e,r,i,o),this.backtrackFragment&&=s,this.bufferFragmentData(d,s,c,a,t||n)}else if(t||n)s.gap=!0;else{this.backtrack(s);return}}if(g){let{startPTS:e,endPTS:t,startDTS:n,endDTS:r}=g;c&&(c.elementaryStreams[V.AUDIO]={startPTS:e,endPTS:t,startDTS:n,endDTS:r}),s.setElementaryStreamInfo(V.AUDIO,e,t,n,r),this.bufferFragmentData(g,s,c,a)}if(h&&p!=null&&p.samples.length){let e={id:t,frag:s,details:h,samples:p.samples};n.trigger(l.FRAG_PARSING_METADATA,e)}if(h&&f){let e={id:t,frag:s,details:h,samples:f.samples};n.trigger(l.FRAG_PARSING_USERDATA,e)}}logMuxedErr(e){this.warn(`${H(e)?`Media`:`Init`} segment with muxed audiovideo where only video expected: ${e.url}`)}_bufferInitSegment(e,t,n,r){if(this.state!==X.PARSING)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&(delete t.audio,t.audiovideo&&this.logMuxedErr(n));let{audio:i,video:a,audiovideo:o}=t;if(i){let n=e.audioCodec,r=Ye(i.codec,n);r===`mp4a`&&(r=`mp4a.40.5`);let a=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){r&&=r.indexOf(`mp4a.40.5`)===-1?`mp4a.40.5`:`mp4a.40.2`;let e=i.metadata;e&&`channelCount`in e&&(e.channelCount||1)!==1&&a.indexOf(`firefox`)===-1&&(r=`mp4a.40.5`)}r&&r.indexOf(`mp4a.40.5`)!==-1&&a.indexOf(`android`)!==-1&&i.container!==`audio/mpeg`&&(r=`mp4a.40.2`,this.log(`Android: force audio codec to ${r}`)),n&&n!==r&&this.log(`Swapping manifest audio codec "${n}" for "${r}"`),i.levelCodec=r,i.id=d.MAIN,this.log(`Init audio buffer, container:${i.container}, codecs[selected/level/parsed]=[${r||``}/${n||``}/${i.codec}]`),delete t.audiovideo}if(a){a.levelCodec=e.videoCodec,a.id=d.MAIN;let n=a.codec;if(n?.length===4)switch(n){case`hvc1`:case`hev1`:a.codec=`hvc1.1.6.L120.90`;break;case`av01`:a.codec=`av01.0.04M.08`;break;case`avc1`:a.codec=`avc1.42e01e`;break}this.log(`Init video buffer, container:${a.container}, codecs[level/parsed]=[${e.videoCodec||``}/${n}]${a.codec===n?``:` parsed-corrected=`+a.codec}${a.supplemental?` supplemental=`+a.supplemental:``}`),delete t.audiovideo}o&&(this.log(`Init audiovideo buffer, container:${o.container}, codecs[level/parsed]=[${e.codecs}/${o.codec}]`),delete t.video,delete t.audio);let s=Object.keys(t);if(s.length){if(this.hls.trigger(l.BUFFER_CODECS,t),!this.hls)return;s.forEach(e=>{let i=t[e].initSegment;i!=null&&i.byteLength&&this.hls.trigger(l.BUFFER_APPENDING,{type:e,data:i,frag:n,part:null,chunkMeta:r,parent:n.type})})}this.tickImmediate()}getMainFwdBufferInfo(){let e=this.mediaBuffer&&this.altAudio===2?this.mediaBuffer:this.media;return this.getFwdBufferInfo(e,d.MAIN)}get maxBufferLength(){let{levels:e,level:t}=this,n=e?.[t];return n?this.getMaxBufferLength(n.maxBitrate):this.config.maxBufferLength}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=X.IDLE}checkFragmentChanged(){let e=this.media,t=null;if(e&&e.readyState>1&&e.seeking===!1){let n=e.currentTime;if(J.isBuffered(e,n)?t=this.getAppendedFrag(n):J.isBuffered(e,n+.1)&&(t=this.getAppendedFrag(n+.1)),t){this.backtrackFragment=null;let e=this.fragPlaying,n=t.level;(!e||t.sn!==e.sn||e.level!==n)&&(this.fragPlaying=t,this.hls.trigger(l.FRAG_CHANGED,{frag:t}),(!e||e.level!==n)&&this.hls.trigger(l.LEVEL_SWITCHED,{level:n}))}}}get nextLevel(){let e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){if(this.fragPlaying)return this.fragPlaying;let e=this.media?.currentTime||this.lastCurrentTime;return i(e)?this.getAppendedFrag(e):null}get currentProgramDateTime(){let e=this.media?.currentTime||this.lastCurrentTime;if(i(e)){let t=this.getLevelDetails(),n=this.currentFrag||(t?Bt(null,t.fragments,e):null);if(n){let t=n.programDateTime;if(t!==null){let r=t+(e-n.start)*1e3;return new Date(r)}}}return null}get currentLevel(){let e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){let e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}},wu=class extends b{constructor(e,t){super(`key-loader`,t),this.config=void 0,this.keyIdToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(let t in this.keyIdToKeyInfo){let n=this.keyIdToKeyInfo[t].loader;if(n){if(e&&e!==n.context?.frag.type)return;n.abort()}}}detach(){for(let e in this.keyIdToKeyInfo){let t=this.keyIdToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyIdToKeyInfo[e]}}destroy(){for(let e in this.detach(),this.keyIdToKeyInfo){let t=this.keyIdToKeyInfo[e].loader;t&&t.destroy()}this.keyIdToKeyInfo={}}createKeyLoadError(e,t=c.KEY_LOAD_ERROR,n,r,i){return new Cn({type:s.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:i,error:n,networkDetails:r})}loadClear(e,t,n){if(this.emeController&&this.config.emeEnabled&&!this.emeController.getSelectedKeySystemFormats().length){if(t.length)for(let r=0,i=t.length;r<i;r++){let a=t[r];if(e.cc<=a.cc&&(!H(e)||!H(a)||e.sn<a.sn)||!n&&r==i-1)return this.emeController.selectKeySystemFormat(a).then(e=>{if(!this.emeController)return;a.setKeyFormat(e);let t=$n(e);if(t)return this.emeController.getKeySystemAccess([t])})}if(this.config.requireKeySystemAccessOnStart){let e=tr(this.config);if(e.length)return this.emeController.getKeySystemAccess(e)}}return null}load(e){return!e.decryptdata&&e.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(e).then(t=>this.loadInternal(e,t)):this.loadInternal(e)}loadInternal(e,t){var n,r;t&&e.setKeyFormat(t);let i=e.decryptdata;if(!i){let n=Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:`Missing decryption data on fragment in onKeyLoading (emeEnabled with controller: ${this.emeController&&this.config.emeEnabled})`);return Promise.reject(this.createKeyLoadError(e,c.KEY_LOAD_ERROR,n))}let a=i.uri;if(!a)return Promise.reject(this.createKeyLoadError(e,c.KEY_LOAD_ERROR,Error(`Invalid key URI: "${a}"`)));let o=Tu(i),s=this.keyIdToKeyInfo[o];if((n=s)!=null&&n.decryptdata.key)return i.key=s.decryptdata.key,Promise.resolve({frag:e,keyInfo:s});if(this.emeController&&(r=s)!=null&&r.keyLoadPromise)switch(this.emeController.getKeyStatus(s.decryptdata)){case`usable`:case`usable-in-future`:return s.keyLoadPromise.then(t=>{let{keyInfo:n}=t;return i.key=n.decryptdata.key,{frag:e,keyInfo:n}})}switch(this.log(`${this.keyIdToKeyInfo[o]?`Rel`:`L`}oading${i.keyId?` keyId: `+N(i.keyId):``} URI: ${i.uri} from ${e.type} ${e.level}`),s=this.keyIdToKeyInfo[o]={decryptdata:i,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},i.method){case`SAMPLE-AES`:case`SAMPLE-AES-CENC`:case`SAMPLE-AES-CTR`:return i.keyFormat===`identity`?this.loadKeyHTTP(s,e):this.loadKeyEME(s,e);case`AES-128`:case`AES-256`:case`AES-256-CTR`:return this.loadKeyHTTP(s,e);default:return Promise.reject(this.createKeyLoadError(e,c.KEY_LOAD_ERROR,Error(`Key supplied with unsupported METHOD: "${i.method}"`)))}}loadKeyEME(e,t){let n={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){var r;if(!e.decryptdata.keyId&&(r=t.initSegment)!=null&&r.data){let n=be(t.initSegment.data);if(n.length){let t=n[0];t.some(e=>e!==0)?(this.log(`Using keyId found in init segment ${N(t)}`),cr.setKeyIdForUri(e.decryptdata.uri,t)):(t=cr.addKeyIdForUri(e.decryptdata.uri),this.log(`Generating keyId to patch media ${N(t)}`)),e.decryptdata.keyId=t}}return!e.decryptdata.keyId&&!H(t)?Promise.resolve(n):(e.keyLoadPromise=this.emeController.loadKey(n).then(t=>(e.mediaKeySessionContext=t,n))).catch(n=>{throw e.keyLoadPromise=null,`data`in n&&(n.data.frag=t),n})}return Promise.resolve(n)}loadKeyHTTP(e,t){let n=this.config,r=n.loader,i=new r(n);return t.keyLoader=e.loader=i,e.keyLoadPromise=new Promise((r,a)=>{let o={keyInfo:e,frag:t,responseType:`arraybuffer`,url:e.decryptdata.uri},s=n.keyLoadPolicy.default,l={loadPolicy:s,timeout:s.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0};i.load(o,l,{onSuccess:(e,t,n,i)=>{let{frag:o,keyInfo:s}=n,l=Tu(s.decryptdata);if(!o.decryptdata||s!==this.keyIdToKeyInfo[l])return a(this.createKeyLoadError(o,c.KEY_LOAD_ERROR,Error(`after key load, decryptdata unset or changed`),i));s.decryptdata.key=o.decryptdata.key=new Uint8Array(e.data),o.keyLoader=null,s.loader=null,r({frag:o,keyInfo:s})},onError:(e,n,r,i)=>{this.resetLoader(n),a(this.createKeyLoadError(t,c.KEY_LOAD_ERROR,Error(`HTTP Error ${e.code} loading key ${e.text}`),r,_({url:o.url,data:void 0},e)))},onTimeout:(e,n,r)=>{this.resetLoader(n),a(this.createKeyLoadError(t,c.KEY_LOAD_TIMEOUT,Error(`key loading timed out`),r))},onAbort:(e,n,r)=>{this.resetLoader(n),a(this.createKeyLoadError(t,c.INTERNAL_ABORTED,Error(`key loading aborted`),r))}})})}resetLoader(e){let{frag:t,keyInfo:n,url:r}=e,i=n.loader;t.keyLoader===i&&(t.keyLoader=null,n.loader=null);let a=Tu(n.decryptdata)||r;delete this.keyIdToKeyInfo[a],i&&i.destroy()}};function Tu(e){if(e.keyFormat!==Qn.FAIRPLAY){let t=e.keyId;if(t)return N(t)}return e.uri}function Eu(e){let{type:t}=e;switch(t){case u.AUDIO_TRACK:return d.AUDIO;case u.SUBTITLE_TRACK:return d.SUBTITLE;default:return d.MAIN}}function Du(e,t){let n=e.url;return(n===void 0||n.indexOf(`data:`)===0)&&(n=t.url),n}var Ou=class{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.onManifestLoaded=this.checkAutostartLoad,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){let{hls:e}=this;e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.LEVEL_LOADING,this.onLevelLoading,this),e.on(l.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(l.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.on(l.LEVELS_UPDATED,this.onLevelsUpdated,this)}unregisterListeners(){let{hls:e}=this;e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.LEVEL_LOADING,this.onLevelLoading,this),e.off(l.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(l.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.off(l.LEVELS_UPDATED,this.onLevelsUpdated,this)}createInternalLoader(e){let t=this.hls.config,n=t.pLoader,r=t.loader,i=new(n||r)(t);return this.loaders[e.type]=i,i}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(let e in this.loaders){let t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){let{url:n}=t;this.variableList=null,this.load({id:null,level:0,responseType:`text`,type:u.MANIFEST,url:n,deliveryDirectives:null,levelOrTrack:null})}onLevelLoading(e,t){let{id:n,level:r,pathwayId:i,url:a,deliveryDirectives:o,levelInfo:s}=t;this.load({id:n,level:r,pathwayId:i,responseType:`text`,type:u.LEVEL,url:a,deliveryDirectives:o,levelOrTrack:s})}onAudioTrackLoading(e,t){let{id:n,groupId:r,url:i,deliveryDirectives:a,track:o}=t;this.load({id:n,groupId:r,level:null,responseType:`text`,type:u.AUDIO_TRACK,url:i,deliveryDirectives:a,levelOrTrack:o})}onSubtitleTrackLoading(e,t){let{id:n,groupId:r,url:i,deliveryDirectives:a,track:o}=t;this.load({id:n,groupId:r,level:null,responseType:`text`,type:u.SUBTITLE_TRACK,url:i,deliveryDirectives:a,levelOrTrack:o})}onLevelsUpdated(e,t){let n=this.loaders[u.LEVEL];if(n){let e=n.context;e&&!t.levels.some(t=>t===e.levelOrTrack)&&(n.abort(),delete this.loaders[u.LEVEL])}}load(e){let t=this.hls.config,n=this.getInternalLoader(e);if(n){let t=this.hls.logger,r=n.context;if(r&&r.levelOrTrack===e.levelOrTrack&&(r.url===e.url||r.deliveryDirectives&&!e.deliveryDirectives)){r.url===e.url?t.log(`[playlist-loader]: ignore ${e.url} ongoing request`):t.log(`[playlist-loader]: ignore ${e.url} in favor of ${r.url}`);return}t.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),n.abort()}let r;if(r=e.type===u.MANIFEST?t.manifestLoadPolicy.default:h({},t.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),n=this.createInternalLoader(e),i(e.deliveryDirectives?.part)){let t;if(e.type===u.LEVEL&&e.level!==null?t=this.hls.levels[e.level].details:e.type===u.AUDIO_TRACK&&e.id!==null?t=this.hls.audioTracks[e.id].details:e.type===u.SUBTITLE_TRACK&&e.id!==null&&(t=this.hls.subtitleTracks[e.id].details),t){let e=t.partTarget,n=t.targetduration;if(e&&n){let t=Math.max(e*3,n*.8)*1e3;r=h({},r,{maxTimeToFirstByteMs:Math.min(t,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(t,r.maxTimeToFirstByteMs)})}}}let a=r.errorRetry||r.timeoutRetry||{},o={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0};n.load(e,o,{onSuccess:(e,t,n,r)=>{let i=this.getInternalLoader(n);this.resetInternalLoader(n.type);let a=e.data;t.parsing.start=performance.now(),_r.isMediaPlaylist(a)||n.type!==u.MANIFEST?this.handleTrackOrLevelPlaylist(e,t,n,r||null,i):this.handleMasterPlaylist(e,t,n,r)},onError:(e,t,n,r)=>{this.handleNetworkError(t,n,!1,e,r)},onTimeout:(e,t,n)=>{this.handleNetworkError(t,n,!0,void 0,e)}})}checkAutostartLoad(){if(!this.hls)return;let{config:{autoStartLoad:e,startPosition:t},forceStartLoad:n}=this.hls;(e||n)&&(this.hls.logger.log(`${e?`auto`:`force`} startLoad with configured startPosition ${t}`),this.hls.startLoad(t))}handleMasterPlaylist(e,t,n,r){let i=this.hls,a=e.data,o=Du(e,n),s=_r.parseMasterPlaylist(a,o);if(s.playlistParsingError){t.parsing.end=performance.now(),this.handleManifestParsingError(e,n,s.playlistParsingError,r,t);return}let{contentSteering:c,levels:u,sessionData:d,sessionKeys:f,startTimeOffset:p,variableList:m}=s;this.variableList=m,u.forEach(e=>{let{unknownCodecs:t}=e;if(t){let{preferManagedMediaSource:n}=this.hls.config,{audioCodec:r,videoCodec:i}=e;for(let a=t.length;a--;){let o=t[a];ze(o,`audio`,n)?(e.audioCodec=r=r?`${r},${o}`:o,Le.audio[r.substring(0,4)]=2,t.splice(a,1)):ze(o,`video`,n)&&(e.videoCodec=i=i?`${i},${o}`:o,Le.video[i.substring(0,4)]=2,t.splice(a,1))}}});let{AUDIO:h=[],SUBTITLES:g,"CLOSED-CAPTIONS":_}=_r.parseMasterPlaylistMedia(a,o,s);h.length&&!h.some(e=>!e.url)&&u[0].audioCodec&&!u[0].attrs.AUDIO&&(this.hls.logger.log(`[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one`),h.unshift({type:`main`,name:`main`,groupId:`main`,default:!1,autoselect:!1,forced:!1,id:-1,attrs:new Fn({}),bitrate:0,url:``})),i.trigger(l.MANIFEST_LOADED,{levels:u,audioTracks:h,subtitles:g,captions:_,contentSteering:c,url:o,stats:t,networkDetails:r,sessionData:d,sessionKeys:f,startTimeOffset:p,variableList:m})}handleTrackOrLevelPlaylist(e,t,n,r,a){let o=this.hls,{id:s,level:c,type:d}=n,f=Du(e,n),p=i(c)?c:i(s)?s:0,m=Eu(n),h=_r.parseLevelPlaylist(e.data,f,p,m,0,this.variableList);if(d===u.MANIFEST){let e={attrs:new Fn({}),bitrate:0,details:h,name:``,url:f};h.requestScheduled=t.loading.start+zr(h,0),o.trigger(l.MANIFEST_LOADED,{levels:[e],audioTracks:[],url:f,stats:t,networkDetails:r,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),n.levelDetails=h,this.handlePlaylistLoaded(h,e,t,n,r,a)}handleManifestParsingError(e,t,n,r,i){this.hls.trigger(l.ERROR,{type:s.NETWORK_ERROR,details:c.MANIFEST_PARSING_ERROR,fatal:t.type===u.MANIFEST,url:e.url,err:n,error:n,reason:n.message,response:e,context:t,networkDetails:r,stats:i})}handleNetworkError(e,t,n=!1,r,i){let a=`A network ${n?`timeout`:`error`+(r?` (status `+r.code+`)`:``)} occurred while loading ${e.type}`;e.type===u.LEVEL?a+=`: ${e.level} id: ${e.id}`:(e.type===u.AUDIO_TRACK||e.type===u.SUBTITLE_TRACK)&&(a+=` id: ${e.id} group-id: "${e.groupId}"`);let o=Error(a);this.hls.logger.warn(`[playlist-loader]: ${a}`);let d=c.UNKNOWN,f=!1,p=this.getInternalLoader(e);switch(e.type){case u.MANIFEST:d=n?c.MANIFEST_LOAD_TIMEOUT:c.MANIFEST_LOAD_ERROR,f=!0;break;case u.LEVEL:d=n?c.LEVEL_LOAD_TIMEOUT:c.LEVEL_LOAD_ERROR,f=!1;break;case u.AUDIO_TRACK:d=n?c.AUDIO_TRACK_LOAD_TIMEOUT:c.AUDIO_TRACK_LOAD_ERROR,f=!1;break;case u.SUBTITLE_TRACK:d=n?c.SUBTITLE_TRACK_LOAD_TIMEOUT:c.SUBTITLE_LOAD_ERROR,f=!1;break}p&&this.resetInternalLoader(e.type);let m={type:s.NETWORK_ERROR,details:d,fatal:f,url:e.url,loader:p,context:e,error:o,networkDetails:t,stats:i};r&&(m.response=_({url:t?.url||e.url,data:void 0},r)),this.hls.trigger(l.ERROR,m)}handlePlaylistLoaded(e,t,n,r,i,a){let o=this.hls,{type:f,level:p,levelOrTrack:m,id:h,groupId:g,deliveryDirectives:_}=r,v=Du(t,r),y=Eu(r),b=typeof r.level==`number`&&y===d.MAIN?p:void 0,x=e.playlistParsingError;if(x){if(this.hls.logger.warn(`${x} ${e.url}`),!o.config.ignorePlaylistParsingErrors){o.trigger(l.ERROR,{type:s.NETWORK_ERROR,details:c.LEVEL_PARSING_ERROR,fatal:!1,url:v,error:x,reason:x.message,response:t,context:r,level:b,parent:y,networkDetails:i,stats:n});return}e.playlistParsingError=null}if(!e.fragments.length){let a=e.playlistParsingError=Error(`No Segments found in Playlist`);o.trigger(l.ERROR,{type:s.NETWORK_ERROR,details:c.LEVEL_EMPTY_ERROR,fatal:!1,url:v,error:a,reason:a.message,response:t,context:r,level:b,parent:y,networkDetails:i,stats:n});return}switch(e.live&&a&&(a.getCacheAge&&(e.ageHeader=a.getCacheAge()||0),(!a.getCacheAge||isNaN(e.ageHeader))&&(e.ageHeader=0)),f){case u.MANIFEST:case u.LEVEL:if(b){if(!m)b=0;else if(m!==o.levels[b]){let e=o.levels.indexOf(m);e>-1&&(b=e)}}o.trigger(l.LEVEL_LOADED,{details:e,levelInfo:m||o.levels[0],level:b||0,id:h||0,stats:n,networkDetails:i,deliveryDirectives:_,withoutMultiVariant:f===u.MANIFEST});break;case u.AUDIO_TRACK:o.trigger(l.AUDIO_TRACK_LOADED,{details:e,track:m,id:h||0,groupId:g||``,stats:n,networkDetails:i,deliveryDirectives:_});break;case u.SUBTITLE_TRACK:o.trigger(l.SUBTITLE_TRACK_LOADED,{details:e,track:m,id:h||0,groupId:g||``,stats:n,networkDetails:i,deliveryDirectives:_});break}}},ku=class e{static get version(){return ui}static isMSESupported(){return yu()}static isSupported(){return bu()}static getMediaSource(){return k()}static get Events(){return l}static get MetadataSchema(){return Xi}static get ErrorTypes(){return s}static get ErrorDetails(){return c}static get DefaultConfig(){return e.defaultConfig?e.defaultConfig:Zl}static set DefaultConfig(t){e.defaultConfig=t}constructor(t={}){this.config=void 0,this.userConfig=void 0,this.logger=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new li,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioStreamController=void 0,this.subtititleStreamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.interstitialsController=void 0,this.gapController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this._url=null,this._sessionId=void 0,this.triggeringException=void 0,this.started=!1;let n=this.logger=D(t.debug||!1,`Hls instance`,t.assetPlayerId),r=this.config=$l(e.DefaultConfig,t,n);this.userConfig=t,r.progressive&&tu(r,n);let{abrController:i,bufferController:a,capLevelController:o,errorController:s,fpsController:c}=r,u=new s(this),d=this.abrController=new i(this),f=new on(this),p=r.interstitialsController,m=p?this.interstitialsController=new p(this,e):null,h=this.bufferController=new a(this,f),g=this.capLevelController=new o(this),_=new c(this),v=new Ou(this),y=r.contentSteeringController,b=y?new y(this):null,x=this.levelController=new gu(this,b),S=new mu(this),C=new wu(this.config,this.logger),w=this.streamController=new Cu(this,f,C),T=this.gapController=new ou(this,f);g.setStreamController(w),_.setStreamController(w);let E=[v,x,w];m&&E.splice(1,0,m),b&&E.splice(1,0,b),this.networkControllers=E;let O=[d,h,T,g,_,S,f];this.audioTrackController=this.createController(r.audioTrackController,E);let k=r.audioStreamController;k&&E.push(this.audioStreamController=new k(this,f,C)),this.subtitleTrackController=this.createController(r.subtitleTrackController,E);let A=r.subtitleStreamController;A&&E.push(this.subtititleStreamController=new A(this,f,C)),this.createController(r.timelineController,O),C.emeController=this.emeController=this.createController(r.emeController,O),this.cmcdController=this.createController(r.cmcdController,O),this.latencyController=this.createController(hu,O),this.coreComponents=O,E.push(u);let j=u.onErrorOut;typeof j==`function`&&this.on(l.ERROR,j,u),this.on(l.MANIFEST_LOADED,v.onManifestLoaded,v)}createController(e,t){if(e){let n=new e(this);return t&&t.push(n),n}return null}on(e,t,n=this){this._emitter.on(e,t,n)}once(e,t,n=this){this._emitter.once(e,t,n)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,n=this,r){this._emitter.off(e,t,n,r)}listeners(e){return this._emitter.listeners(e)}emit(e,t,n){return this._emitter.emit(e,t,n)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(t){if(this.logger.error(`An internal error happened while handling event `+e+`. Error message: "`+t.message+`". Here is a stacktrace:`,t),!this.triggeringException){this.triggeringException=!0;let n=e===l.ERROR;this.trigger(l.ERROR,{type:s.OTHER_ERROR,details:c.INTERNAL_EXCEPTION,fatal:n,event:e,error:t}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){this.logger.log(`destroy`),this.trigger(l.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this._url=null,this.networkControllers.forEach(e=>e.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(e=>e.destroy()),this.coreComponents.length=0;let e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){if(!e||`media`in e&&!e.media){let t=Error(`attachMedia failed: invalid argument (${e})`);this.trigger(l.ERROR,{type:s.OTHER_ERROR,details:c.ATTACH_MEDIA_ERROR,fatal:!0,error:t});return}this.logger.log(`attachMedia`),this._media&&(this.logger.warn(`media must be detached before attaching`),this.detachMedia());let t=`media`in e,n=t?e.media:e,r=t?e:{media:n};this._media=n,this.trigger(l.MEDIA_ATTACHING,r)}detachMedia(){this.logger.log(`detachMedia`),this.trigger(l.MEDIA_DETACHING,{}),this._media=null}transferMedia(){this._media=null;let e=this.bufferController.transferMedia();return this.trigger(l.MEDIA_DETACHING,{transferMedia:e}),e}loadSource(e){this.stopLoad();let t=this.media,n=this._url,r=this._url=z.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.logger.log(`loadSource:${r}`),t&&n&&(n!==r||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(l.MANIFEST_LOADING,{url:e})}get url(){return this._url}get hasEnoughToStart(){return this.streamController.hasEnoughToStart}get startPosition(){return this.streamController.startPositionValue}startLoad(e=-1,t){this.logger.log(`startLoad(${e+(t?`, <skip seek to start>`:``)})`),this.started=!0,this.resumeBuffering();for(let n=0;n<this.networkControllers.length&&(this.networkControllers[n].startLoad(e,t),!(!this.started||!this.networkControllers));n++);}stopLoad(){this.logger.log(`stopLoad`),this.started=!1;for(let e=0;e<this.networkControllers.length&&(this.networkControllers[e].stopLoad(),!(this.started||!this.networkControllers));e++);}get loadingEnabled(){return this.started}get bufferingEnabled(){return this.streamController.bufferingEnabled}resumeBuffering(){this.bufferingEnabled||(this.logger.log(`resume buffering`),this.networkControllers.forEach(e=>{e.resumeBuffering&&e.resumeBuffering()}))}pauseBuffering(){this.bufferingEnabled&&(this.logger.log(`pause buffering`),this.networkControllers.forEach(e=>{e.pauseBuffering&&e.pauseBuffering()}))}get inFlightFragments(){let e={[d.MAIN]:this.streamController.inFlightFrag};return this.audioStreamController&&(e[d.AUDIO]=this.audioStreamController.inFlightFrag),this.subtititleStreamController&&(e[d.SUBTITLE]=this.subtititleStreamController.inFlightFrag),e}swapAudioCodec(){this.logger.log(`swapAudioCodec`),this.streamController.swapAudioCodec()}recoverMediaError(){this.logger.log(`recoverMediaError`);let e=this._media,t=e?.currentTime;this.detachMedia(),e&&(this.attachMedia(e),t&&this.startLoad(t))}removeLevel(e){this.levelController.removeLevel(e)}get sessionId(){let e=this._sessionId;return e||=this._sessionId=mc(),e}get levels(){return this.levelController.levels||[]}get latestLevelDetails(){return this.streamController.getLevelDetails()||null}get loadLevelObj(){return this.levelController.loadLevelObj}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){this.logger.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){this.logger.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){this.logger.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){this.logger.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){let e=this.levelController.startLevel;return e===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){this.logger.log(`set startLevel:${e}`),e!==-1&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){let t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){let{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get abrEwmaDefaultEstimate(){let{bwEstimator:e}=this.abrController;return e?e.defaultEstimate:NaN}get ttfbEstimate(){let{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(this.logger.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){pt(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){let{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;let n=e.length;for(let r=0;r<n;r++)if(e[r].maxBitrate>=t)return r;return 0}get maxAutoLevel(){let{levels:e,autoLevelCapping:t,maxHdcpLevel:n}=this,r;if(r=t===-1&&e!=null&&e.length?e.length-1:t,n)for(let t=r;t--;){let r=e[t].attrs[`HDCP-LEVEL`];if(r&&r<=n)return t}return r}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get maxBufferLength(){return this.streamController.maxBufferLength}setAudioOption(e){return this.audioTrackController?.setAudioOption(e)||null}setSubtitleOption(e){return this.subtitleTrackController?.setSubtitleOption(e)||null}get allAudioTracks(){let e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){let e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){let e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){let t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){let e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){let e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){let e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){let t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){let e=this.subtitleTrackController;return e?e.subtitleDisplay:!1}set subtitleDisplay(e){let t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}set targetLatency(e){this.latencyController.targetLatency=e}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}get pathways(){return this.levelController.pathways}get pathwayPriority(){return this.levelController.pathwayPriority}set pathwayPriority(e){this.levelController.pathwayPriority=e}get bufferedToEnd(){var e;return!!((e=this.bufferController)!=null&&e.bufferedToEnd)}get interstitialsManager(){return this.interstitialsController?.interstitialsManager||null}getMediaDecodingInfo(e,t=this.allAudioTracks){return ot(e,Et(t),navigator.mediaCapabilities)}};ku.defaultConfig=void 0;function Au(e){if(e.startsWith(`https://`))return e;if(e.startsWith(`http://`)){let t=encodeURIComponent(e),n=`${window.location.origin}/api/proxy?url=${t}`;return console.log(`[PROD] Usando proxy:`,{original:e,proxied:n}),n}return e}function ju(e){return e.startsWith(`http://`)}var Mu=new class{castContext=null;remotePlayer=null;remotePlayerController=null;stateChangeCallbacks=[];currentState={isConnected:!1,deviceName:null,method:null};chromecastInitialized=!1;constructor(){this.initGoogleCast()}initGoogleCast(){typeof window>`u`||(window.__onGCastApiAvailable=e=>{e&&window.cast&&window.chrome?.cast&&this.setupGoogleCast()},window.cast?.framework&&this.setupGoogleCast())}setupGoogleCast(){if(!(this.chromecastInitialized||!window.cast?.framework||!window.chrome?.cast))try{this.castContext=window.cast.framework.CastContext.getInstance(),this.castContext.setOptions({receiverApplicationId:`CC1AD845`,autoJoinPolicy:window.chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED}),this.remotePlayer=new window.cast.framework.RemotePlayer,this.remotePlayerController=new window.cast.framework.RemotePlayerController(this.remotePlayer),this.castContext.addEventListener(`caststatechanged`,this.handleCastStateChange.bind(this)),this.remotePlayerController&&this.remotePlayerController.addEventListener(window.cast.framework.RemotePlayerEventType.IS_CONNECTED_CHANGED,this.handleConnectionChange.bind(this)),this.chromecastInitialized=!0,console.log(`Google Cast inicializado com sucesso`)}catch(e){console.warn(`Erro ao inicializar Google Cast:`,e)}}handleCastStateChange(e){let t=e.castState,n=window.cast?.framework;if(n)if(t===n.CastState.CONNECTED){let e=this.castContext?.getCurrentSession();this.updateState({isConnected:!0,deviceName:e?.getCastDevice().friendlyName||`Chromecast`,method:`chromecast`})}else (t===n.CastState.NOT_CONNECTED||t===n.CastState.NO_DEVICES_AVAILABLE)&&this.currentState.method===`chromecast`&&this.updateState({isConnected:!1,deviceName:null,method:null})}handleConnectionChange(){if(this.remotePlayer?.isConnected){let e=this.castContext?.getCurrentSession();this.updateState({isConnected:!0,deviceName:e?.getCastDevice().friendlyName||`Chromecast`,method:`chromecast`})}else this.currentState.method===`chromecast`&&this.updateState({isConnected:!1,deviceName:null,method:null})}updateState(e){this.currentState=e,this.stateChangeCallbacks.forEach(t=>t(e))}getCapabilities(){let e=document.createElement(`video`);return{chromecast:this.chromecastInitialized&&!!window.cast?.framework,airplay:`webkitShowPlaybackTargetPicker`in e,remotePlayback:`remote`in e,presentation:`presentation`in navigator&&!!navigator.presentation?.defaultRequest,share:`share`in navigator,copyLink:!0,openExternal:!0}}getAvailableMethods(){let e=this.getCapabilities();return[{method:`chromecast`,name:`Chromecast`,description:`Transmitir para Chromecast ou TV com Google Cast`,icon:`chromecast`,available:e.chromecast},{method:`airplay`,name:`AirPlay`,description:`Transmitir para Apple TV, Mac ou dispositivos AirPlay`,icon:`airplay`,available:e.airplay},{method:`remotePlayback`,name:`Dispositivo remoto`,description:`Transmitir via conexo do navegador`,icon:`tv`,available:e.remotePlayback&&!e.chromecast&&!e.airplay},{method:`share`,name:`Compartilhar`,description:`Enviar para outro app ou dispositivo`,icon:`share`,available:e.share},{method:`copyLink`,name:`Copiar link`,description:`Copiar URL para colar em Smart TV ou player`,icon:`copy`,available:!0},{method:`openExternal`,name:`Abrir em player externo`,description:`Abrir em VLC, IINA ou outro player`,icon:`external`,available:!0}].filter(e=>e.available||e.method===`copyLink`||e.method===`openExternal`)}async castToChromecast(e,t,n){if(!this.castContext||!window.chrome?.cast)return console.warn(`Google Cast no disponvel`),!1;try{await this.castContext.requestSession();let r=this.castContext.getCurrentSession();if(!r)throw Error(`Nenhuma sesso de cast criada`);let i=new window.chrome.cast.media.MediaInfo(e,`application/x-mpegURL`);i.streamType=window.chrome.cast.media.StreamType.LIVE;let a=new window.chrome.cast.media.GenericMediaMetadata;a.metadataType=window.chrome.cast.media.MetadataType.GENERIC,a.title=t,n&&(a.images=[{url:n}]),i.metadata=a;let o=new window.chrome.cast.media.LoadRequest(i);return o.autoplay=!0,await r.loadMedia(o),this.updateState({isConnected:!0,deviceName:r.getCastDevice().friendlyName,method:`chromecast`}),!0}catch(e){return e?.code!==`cancel`&&console.error(`Erro ao transmitir para Chromecast:`,e),!1}}async castToAirPlay(e){if(!(`webkitShowPlaybackTargetPicker`in e))return console.warn(`AirPlay no disponvel`),!1;try{return e.webkitShowPlaybackTargetPicker(),e.addEventListener(`webkitcurrentplaybacktargetiswirelesschanged`,()=>{let t=e.webkitCurrentPlaybackTargetIsWireless;this.updateState({isConnected:t,deviceName:t?`AirPlay`:null,method:t?`airplay`:null})}),setTimeout(()=>{e.webkitCurrentPlaybackTargetIsWireless&&this.updateState({isConnected:!0,deviceName:`AirPlay`,method:`airplay`})},1e3),!0}catch(e){return console.error(`Erro ao transmitir via AirPlay:`,e),!1}}async castViaRemotePlayback(e){if(!(`remote`in e))return console.warn(`Remote Playback API no disponvel`),!1;try{let t=e.remote;return t.addEventListener(`connecting`,()=>{console.log(`Conectando a dispositivo remoto...`)}),t.addEventListener(`connect`,()=>{this.updateState({isConnected:!0,deviceName:`Dispositivo remoto`,method:`remotePlayback`})}),t.addEventListener(`disconnect`,()=>{this.updateState({isConnected:!1,deviceName:null,method:null})}),await t.prompt(),!0}catch(e){return e?.name!==`NotFoundError`&&console.error(`Erro na Remote Playback:`,e),!1}}async shareMedia(e,t){if(!navigator.share)return console.warn(`Web Share API no disponvel`),!1;try{return await navigator.share({title:`Assistir ${e}`,text:`Assista ${e} ao vivo`,url:t}),!0}catch(e){return e?.name!==`AbortError`&&console.error(`Erro ao compartilhar:`,e),!1}}async copyLink(e){try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(e);else{let t=document.createElement(`textarea`);t.value=e,t.style.position=`fixed`,t.style.left=`-999999px`,document.body.appendChild(t),t.select(),document.execCommand(`copy`),document.body.removeChild(t)}return!0}catch(e){return console.error(`Erro ao copiar link:`,e),!1}}getExternalPlayerLinks(e){let t=encodeURIComponent(e);return[{name:`VLC`,url:`vlc://${e}`,icon:`vlc`,platforms:[`ios`,`android`,`windows`,`macos`,`linux`]},{name:`IINA`,url:`iina://weblink?url=${t}`,icon:`iina`,platforms:[`macos`]},{name:`Infuse`,url:`infuse://x-callback-url/play?url=${t}`,icon:`infuse`,platforms:[`ios`,`macos`,`tvos`]},{name:`MX Player`,url:`intent:${e}#Intent;package=com.mxtech.videoplayer.ad;end`,icon:`mx`,platforms:[`android`]},{name:`nPlayer`,url:`nplayer-${e}`,icon:`nplayer`,platforms:[`ios`]},{name:`Potplayer`,url:`potplayer://${e}`,icon:`potplayer`,platforms:[`windows`]}]}openInExternalPlayer(e){let t=document.createElement(`iframe`);t.style.display=`none`,t.src=e,document.body.appendChild(t),setTimeout(()=>{document.body.removeChild(t)},3e3)}async cast(e,t,n,r,i){try{switch(e){case`chromecast`:let e=await this.castToChromecast(t,n,i);return{success:e,message:e?`Transmitindo para Chromecast`:`No foi possvel conectar ao Chromecast`};case`airplay`:if(!r)return{success:!1,message:`Elemento de vdeo necessrio para AirPlay`};let a=await this.castToAirPlay(r);return{success:a,message:a?`Selecione um dispositivo AirPlay`:`AirPlay no disponvel`};case`remotePlayback`:if(!r)return{success:!1,message:`Elemento de vdeo necessrio`};let o=await this.castViaRemotePlayback(r);return{success:o,message:o?`Conectado a dispositivo remoto`:`No foi possvel conectar`};case`share`:let s=await this.shareMedia(n,t);return{success:s,message:s?`Link compartilhado`:`Compartilhamento cancelado`};case`copyLink`:let c=await this.copyLink(t);return{success:c,message:c?`Link copiado! Cole na sua Smart TV ou player`:`Erro ao copiar link`};case`openExternal`:return{success:!0,message:`Escolha um player externo`};default:return{success:!1,message:`Mtodo de cast no suportado`}}}catch(e){return console.error(`Erro no cast:`,e),{success:!1,message:`Erro ao iniciar transmisso`}}}stopCasting(){this.currentState.method===`chromecast`&&(this.castContext?.getCurrentSession())?.endSession(!0),this.updateState({isConnected:!1,deviceName:null,method:null})}getState(){return this.currentState}onStateChange(e){return this.stateChangeCallbacks.push(e),()=>{let t=this.stateChangeCallbacks.indexOf(e);t>-1&&this.stateChangeCallbacks.splice(t,1)}}isChromecastAvailable(){return!this.castContext||!window.cast?.framework?!1:this.castContext.getCastState()!==window.cast.framework.CastState.NO_DEVICES_AVAILABLE}detectPlatform(){let e=navigator.userAgent.toLowerCase(),t=`unknown`;/iphone|ipad|ipod/.test(e)?t=`ios`:/android/.test(e)?t=`android`:/mac/.test(e)?t=`macos`:/win/.test(e)?t=`windows`:/linux/.test(e)&&(t=`linux`);let n=`unknown`;/edg/.test(e)?n=`edge`:/samsungbrowser/.test(e)?n=`samsung`:/chrome/.test(e)?n=`chrome`:/safari/.test(e)?n=`safari`:/firefox/.test(e)&&(n=`firefox`);let r=/iphone|ipad|ipod|android|mobile/.test(e),i=/tv|smarttv|googletv|appletv|hbbtv|pov_tv|netcast|tizen|webos/.test(e);return{os:t,browser:n,isMobile:r,isTV:i}}getRecommendedMethods(){let e=this.detectPlatform(),t=this.getCapabilities(),n=[];return e.os===`ios`?(t.airplay&&n.push(`airplay`),t.share&&n.push(`share`),n.push(`copyLink`,`openExternal`)):e.os===`android`?(t.chromecast&&n.push(`chromecast`),t.remotePlayback&&n.push(`remotePlayback`),t.share&&n.push(`share`),n.push(`copyLink`,`openExternal`)):e.os===`macos`?(e.browser===`safari`&&t.airplay&&n.push(`airplay`),t.chromecast&&n.push(`chromecast`),n.push(`copyLink`,`openExternal`)):(t.chromecast&&n.push(`chromecast`),t.remotePlayback&&n.push(`remotePlayback`),n.push(`copyLink`,`openExternal`)),n}},Q=e(n(),1),$=e(r(),1);const Nu=(0,Q.memo)(function({movie:e,onBack:t,seriesInfo:n,onNextEpisode:r}){let i=(0,Q.useRef)(null),a=(0,Q.useRef)(null),o=(0,Q.useRef)(null),s=(0,Q.useRef)(null),[c,l]=(0,Q.useState)(!1),[u,d]=(0,Q.useState)(!1),[f,p]=(0,Q.useState)(!1),[m,h]=(0,Q.useState)(()=>{let e=localStorage.getItem(`movie-volume`);return e?parseFloat(e):1}),[g,_]=(0,Q.useState)(0),[v,y]=(0,Q.useState)(0),[b,x]=(0,Q.useState)(0),[S,C]=(0,Q.useState)(!1),[w,T]=(0,Q.useState)(!0),[E,D]=(0,Q.useState)(null),[O,k]=(0,Q.useState)(!0),[A,j]=(0,Q.useState)(1),[M,N]=(0,Q.useState)(!1),[P,F]=(0,Q.useState)(!1),[I,L]=(0,Q.useState)(!1),[R,z]=(0,Q.useState)(()=>{let e=localStorage.getItem(`movie-skip-time`);return e?parseInt(e):10}),[B,V]=(0,Q.useState)(100),[ee,H]=(0,Q.useState)(!1),[te,ne]=(0,Q.useState)(`auto`),[re,ie]=(0,Q.useState)(null),[ae,oe]=(0,Q.useState)({isConnected:!1,deviceName:null,method:null}),[se,U]=(0,Q.useState)(!1),[ce,W]=(0,Q.useState)(null),[le,G]=(0,Q.useState)(!1),ue=(0,Q.useRef)(null),K=(0,Q.useCallback)(e=>{if(isNaN(e)||e<0)return`00:00`;let t=Math.floor(e/3600),n=Math.floor(e%3600/60),r=Math.floor(e%60);return t>0?`${t}:${n.toString().padStart(2,`0`)}:${r.toString().padStart(2,`0`)}`:`${n}:${r.toString().padStart(2,`0`)}`},[]);(0,Q.useEffect)(()=>{if(!e||!i.current)return;let t=i.current,n=Au(e.url);T(!0),D(null),_(0),y(0),l(!1),d(!1);let r=()=>{let e=localStorage.getItem(`current-movie-id`),n=t.currentTime,r=t.duration;e&&n>30&&r&&(n/r*100<95?localStorage.setItem(`movie-progress-${e}`,n.toString()):localStorage.removeItem(`movie-progress-${e}`))};r(),localStorage.setItem(`current-movie-id`,e.id);let o=()=>{let n=localStorage.getItem(`movie-progress-${e.id}`);if(n){let e=parseFloat(n);!isNaN(e)&&e>0&&(t.currentTime=e)}};a.current&&=(a.current.destroy(),null);let s=()=>{t.play().catch(()=>{t.muted=!0,p(!0),t.play().catch(()=>{console.log(`Autoplay bloqueado, aguardando interao do usurio`)})})},c=t=>{T(!1);let n=t.currentTarget?.error?.code,r=`Erro ao carregar o vdeo.`;switch(n){case 1:r=`Carregamento do vdeo foi cancelado.`;break;case 2:r=`Erro de rede. Verifique sua conexo.`;break;case 3:r=`Erro ao decodificar o vdeo.`;break;case 4:r=ju(e.url)?`O provedor de vdeo bloqueou o acesso seguro. Tente "Abrir em nova aba".`:`Formato de vdeo no suportado ou URL invlida.`;break}console.log(`[MoviePlayer Error]`,{code:n,message:r,url:e.url}),D(r)};if(n.includes(`.m3u8`)&&ku.isSupported()){let e=new ku({enableWorker:!0,lowLatencyMode:!0});a.current=e,e.loadSource(n),e.attachMedia(t),e.on(ku.Events.MANIFEST_PARSED,()=>{y(t.duration),T(!1),o(),s()}),e.on(ku.Events.ERROR,(t,n)=>{if(n.fatal)switch(n.type){case ku.ErrorTypes.NETWORK_ERROR:console.error(`HLS Network error`,n),D(`Erro de rede ao carregar o stream.`),e.startLoad();break;case ku.ErrorTypes.MEDIA_ERROR:console.error(`HLS Media error`,n),D(`Erro de mdia no stream, tentando recuperar...`),e.recoverMediaError();break;default:D(`Ocorreu um erro fatal ao carregar o vdeo.`),T(!1),e.destroy();break}})}else t.src=n,t.load(),t.addEventListener(`loadedmetadata`,()=>{y(t.duration),T(!1),o(),s()}),t.addEventListener(`error`,c);let u=()=>T(!0),f=()=>{T(!1),l(!0)},m=()=>T(!1);t.addEventListener(`waiting`,u),t.addEventListener(`playing`,f),t.addEventListener(`canplay`,m);let h=()=>r();return window.addEventListener(`beforeunload`,h),()=>{r(),localStorage.removeItem(`current-movie-id`),a.current&&a.current.destroy(),window.removeEventListener(`beforeunload`,h),t.removeEventListener(`error`,c),t.removeEventListener(`waiting`,u),t.removeEventListener(`playing`,f),t.removeEventListener(`canplay`,m)}},[e]);let de=(0,Q.useMemo)(()=>{if(!n||!e)return null;let t=n.episodes.findIndex(t=>t.id===e.id);return t===-1||t>=n.episodes.length-1?null:n.episodes[t+1]},[n,e]);(0,Q.useEffect)(()=>{let t=i.current;if(!t)return;let n=()=>{_(t.currentTime)},r=()=>{t.buffered.length>0&&x(t.buffered.end(t.buffered.length-1)/t.duration*100)},a=()=>l(!0),o=()=>l(!1),s=()=>{l(!1),e&&localStorage.removeItem(`movie-progress-${e.id}`),de&&d(!0)};return t.addEventListener(`timeupdate`,n),t.addEventListener(`progress`,r),t.addEventListener(`play`,a),t.addEventListener(`pause`,o),t.addEventListener(`ended`,s),()=>{t.removeEventListener(`timeupdate`,n),t.removeEventListener(`progress`,r),t.removeEventListener(`play`,a),t.removeEventListener(`pause`,o),t.removeEventListener(`ended`,s)}},[e,de]);let fe=(0,Q.useCallback)(()=>{e&&(console.log(`[openInNewTab] Abrindo:`,e.url),window.open(e.url,`_blank`))},[e]);(0,Q.useEffect)(()=>{if(!de||!v)return;let e=v-g;e<=30&&e>0?d(!0):g<v-35&&d(!1)},[g,v,de]);let pe=(0,Q.useCallback)(()=>{de&&r&&r(de)},[de,r]);(0,Q.useEffect)(()=>{i.current&&(i.current.volume=m,i.current.muted=f),localStorage.setItem(`movie-volume`,m.toString())},[m,f]),(0,Q.useEffect)(()=>{i.current&&(i.current.playbackRate=A)},[A]),(0,Q.useEffect)(()=>{let e=()=>{ue.current&&clearTimeout(ue.current),k(!0),c&&(ue.current=window.setTimeout(()=>{k(!1)},3e3))},t=o.current;return t&&(t.addEventListener(`mousemove`,e),t.addEventListener(`touchstart`,e)),()=>{t&&(t.removeEventListener(`mousemove`,e),t.removeEventListener(`touchstart`,e)),ue.current&&clearTimeout(ue.current)}},[c]),(0,Q.useEffect)(()=>{let e=()=>{C(!!document.fullscreenElement)};return document.addEventListener(`fullscreenchange`,e),()=>document.removeEventListener(`fullscreenchange`,e)},[]),(0,Q.useEffect)(()=>{let e=()=>{F(document.pictureInPictureElement===i.current)},t=i.current;return t&&(t.addEventListener(`enterpictureinpicture`,e),t.addEventListener(`leavepictureinpicture`,e)),()=>{t&&(t.removeEventListener(`enterpictureinpicture`,e),t.removeEventListener(`leavepictureinpicture`,e))}},[]),(0,Q.useEffect)(()=>{H(!!(g>30&&g<300&&n))},[g,n]),(0,Q.useEffect)(()=>{localStorage.setItem(`movie-skip-time`,R.toString())},[R]),(0,Q.useEffect)(()=>{let e=i.current;if(!e)return;let t=()=>{if(e.videoWidth&&e.videoHeight){let t=e.videoHeight,n=``;n=t>=2160?`4K`:t>=1440?`2K`:t>=1080?`1080p`:t>=720?`720p`:t>=480?`480p`:t>=360?`360p`:`${t}p`,ie(n)}else ie(null)};e.addEventListener(`loadedmetadata`,t),e.addEventListener(`resize`,t);let n=setInterval(t,2e3);return t(),()=>{e.removeEventListener(`loadedmetadata`,t),e.removeEventListener(`resize`,t),clearInterval(n)}},[e]),(0,Q.useEffect)(()=>{let e=Mu.onStateChange(e=>{oe(e)});return oe(Mu.getState()),e},[]);let me=(0,Q.useCallback)(()=>{let e=i.current;e&&(e.paused?e.play().catch(()=>{}):e.pause())},[]),he=(0,Q.useCallback)(e=>{let t=i.current;t&&(t.currentTime=Math.max(0,Math.min(t.duration,t.currentTime+e)))},[]),ge=(0,Q.useCallback)(()=>{let e=o.current;e&&(document.fullscreenElement?document.exitFullscreen():e.requestFullscreen())},[]),_e=(0,Q.useCallback)(async()=>{let e=i.current;if(e)try{document.pictureInPictureElement?await document.exitPictureInPicture():document.pictureInPictureEnabled&&await e.requestPictureInPicture()}catch(e){console.error(`PiP error:`,e)}},[]),ve=(0,Q.useCallback)(async()=>{if(ae.isConnected){Mu.stopCasting(),W(`Transmisso encerrada`),setTimeout(()=>W(null),3e3);return}U(!0)},[ae.isConnected]),ye=(0,Q.useCallback)(async t=>{if(!e)return;if(t===`openExternal`){G(!0);return}let n=await Mu.cast(t,e.url,e.name,i.current||void 0,void 0);W(n.message),setTimeout(()=>W(null),4e3),(n.success||t===`copyLink`||t===`share`)&&U(!1)},[e]),be=(0,Q.useCallback)(e=>{Mu.openInExternalPlayer(e),W(`Abrindo player externo...`),setTimeout(()=>W(null),3e3),G(!1),U(!1)},[]),xe=(0,Q.useCallback)(()=>{let e=i.current;e&&(e.currentTime=Math.min(e.duration,e.currentTime+30),H(!1))},[]);(0,Q.useEffect)(()=>{let e=e=>{if(i.current)switch(e.key){case` `:case`k`:e.preventDefault(),me();break;case`ArrowLeft`:e.preventDefault(),he(-R);break;case`ArrowRight`:e.preventDefault(),he(R);break;case`ArrowUp`:e.preventDefault(),h(e=>Math.min(1,e+.1));break;case`ArrowDown`:e.preventDefault(),h(e=>Math.max(0,e-.1));break;case`m`:e.preventDefault(),p(e=>!e);break;case`f`:e.preventDefault(),ge();break;case`p`:e.preventDefault(),_e();break;case`c`:e.preventDefault(),ve();break;case`j`:e.preventDefault(),he(-10);break;case`l`:e.preventDefault(),he(10);break;case`0`:case`1`:case`2`:case`3`:case`4`:case`5`:case`6`:case`7`:case`8`:case`9`:if(e.preventDefault(),i.current){let t=parseInt(e.key)*10;i.current.currentTime=t/100*i.current.duration}break;case`Home`:e.preventDefault(),i.current&&(i.current.currentTime=0);break;case`End`:e.preventDefault(),i.current&&(i.current.currentTime=i.current.duration-1);break;case`s`:e.preventDefault(),xe();break;case`,`:e.preventDefault(),i.current&&(i.current.currentTime=Math.max(0,i.current.currentTime-1/30));break;case`.`:e.preventDefault(),i.current&&(i.current.currentTime=Math.min(i.current.duration,i.current.currentTime+1/30));break;case`<`:e.preventDefault(),j(e=>Math.max(.25,e-.25));break;case`>`:e.preventDefault(),j(e=>Math.min(3,e+.25));break;case`Escape`:S?document.exitFullscreen():t();break}};return document.addEventListener(`keydown`,e),()=>document.removeEventListener(`keydown`,e)},[S,t,R,_e,ve,xe,me,he,ge]);let Se=(0,Q.useCallback)(e=>{let t=i.current,n=s.current;if(!t||!n)return;let r=n.getBoundingClientRect();t.currentTime=(e.clientX-r.left)/r.width*t.duration},[]),Ce=(0,Q.useCallback)(()=>{if(i.current&&e){D(null),T(!0);let t=i.current;a.current?a.current.loadSource(Au(e.url)):t.load()}},[e]),we=(0,Q.useCallback)(t=>{if(!e)return;let n=``;switch(t){case`vlc`:n=`vlc://${e.url}`;break;case`mx`:n=`intent:${e.url}#Intent;package=com.mxtech.videoplayer.ad;end`;break;case`iina`:n=`iina://open?url=${encodeURIComponent(e.url)}`;break;case`potplayer`:n=`potplayer://${e.url}`;break;case`copy`:navigator.clipboard.writeText(e.url).then(()=>{});return;case`newtab`:window.open(e.url,`_blank`);return}n&&(window.location.href=n)},[e]);return e?(0,$.jsxs)(`div`,{ref:o,className:`movie-player ${S?`fullscreen`:``} ${O?``:`hide-cursor`}`,onClick:me,children:[(0,$.jsx)(`div`,{className:`video-container`,style:{filter:`brightness(${B}%)`},children:(0,$.jsx)(`video`,{ref:i,className:`movie-video aspect-${te}`,playsInline:!0,onClick:e=>e.stopPropagation()})}),ee&&(0,$.jsxs)(`button`,{className:`skip-intro-btn`,onClick:e=>{e.stopPropagation(),xe()},"data-focusable":`true`,"data-nav-group":`player-actions`,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),e.stopPropagation(),xe())},children:[(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`currentColor`,width:`20`,height:`20`,children:(0,$.jsx)(`path`,{d:`M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z`})}),`Pular Intro`]}),w&&(0,$.jsxs)(`div`,{className:`player-overlay loading`,children:[(0,$.jsx)(`div`,{className:`spinner`}),(0,$.jsx)(`span`,{children:`Carregando...`})]}),E&&(0,$.jsxs)(`div`,{className:`player-overlay error`,onClick:e=>e.stopPropagation(),children:[(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`circle`,{cx:`12`,cy:`12`,r:`10`}),(0,$.jsx)(`path`,{d:`M12 8v4M12 16h.01`})]}),(0,$.jsx)(`h3`,{children:E}),(0,$.jsxs)(`div`,{className:`error-actions`,children:[(0,$.jsx)(`button`,{onClick:Ce,"data-focusable":`true`,"data-nav-group":`error-actions`,autoFocus:!0,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),Ce())},children:`Tentar novamente`}),(0,$.jsx)(`button`,{onClick:fe,"data-focusable":`true`,"data-nav-group":`error-actions`,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),fe())},children:`Abrir em nova aba`})]}),(0,$.jsxs)(`div`,{className:`external-players`,children:[(0,$.jsx)(`p`,{children:`Abrir em player externo:`}),(0,$.jsxs)(`div`,{className:`player-buttons`,children:[(0,$.jsx)(`button`,{onClick:()=>we(`vlc`),title:`VLC Media Player`,"data-focusable":`true`,"data-nav-group":`external-players`,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),we(`vlc`))},children:`VLC`}),(0,$.jsx)(`button`,{onClick:()=>we(`iina`),title:`IINA (macOS)`,"data-focusable":`true`,"data-nav-group":`external-players`,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),we(`iina`))},children:`IINA`}),(0,$.jsx)(`button`,{onClick:()=>we(`potplayer`),title:`PotPlayer`,"data-focusable":`true`,"data-nav-group":`external-players`,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),we(`potplayer`))},children:`PotPlayer`}),(0,$.jsx)(`button`,{onClick:()=>we(`copy`),title:`Copiar URL`,"data-focusable":`true`,"data-nav-group":`external-players`,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),we(`copy`))},children:` Copiar URL`})]})]}),(0,$.jsx)(`p`,{className:`error-hint`,children:` Dica: Se o vdeo no carregar, abra em um player externo como VLC`})]}),u&&de&&(0,$.jsx)(`div`,{className:`next-episode-overlay`,onClick:e=>e.stopPropagation(),children:(0,$.jsxs)(`div`,{className:`next-episode-card`,children:[(0,$.jsxs)(`div`,{className:`next-episode-info`,children:[(0,$.jsx)(`span`,{className:`next-label`,children:`Prximo episdio`}),(0,$.jsx)(`h4`,{children:de.name}),n&&(0,$.jsxs)(`span`,{className:`next-episode-number`,children:[`T`,n.currentSeason,` E`,n.currentEpisode+1]})]}),(0,$.jsxs)(`button`,{className:`next-episode-btn`,onClick:pe,"data-focusable":`true`,"data-nav-group":`next-episode`,autoFocus:!0,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),pe())},children:[(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`currentColor`,children:(0,$.jsx)(`path`,{d:`M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z`})}),(0,$.jsx)(`span`,{children:`Reproduzir`})]}),(0,$.jsx)(`button`,{className:`next-dismiss-btn`,onClick:()=>d(!1),"data-focusable":`true`,"data-nav-group":`next-episode`,onKeyDown:e=>{(e.key===`Enter`||e.key===` `||e.key===`Escape`)&&(e.preventDefault(),d(!1))},children:(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:(0,$.jsx)(`path`,{d:`M18 6L6 18M6 6l12 12`})})})]})}),(0,$.jsxs)(`div`,{className:`player-controls ${O?`visible`:``}`,onClick:e=>e.stopPropagation(),children:[(0,$.jsxs)(`div`,{className:`controls-top`,children:[(0,$.jsx)(`button`,{className:`control-btn back-btn`,onClick:t,title:`Voltar (Esc)`,"data-focusable":`true`,"data-nav-group":`player-top`,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),t())},children:(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:(0,$.jsx)(`path`,{d:`M19 12H5M12 19l-7-7 7-7`})})}),(0,$.jsxs)(`div`,{className:`movie-title-bar`,children:[(0,$.jsx)(`h2`,{children:e.name}),(0,$.jsx)(`span`,{className:`movie-category`,children:e.category})]}),(0,$.jsx)(`div`,{className:`top-actions`,children:(0,$.jsxs)(`div`,{className:`external-menu-wrapper`,children:[(0,$.jsx)(`button`,{className:`control-btn`,onClick:()=>N(!M),title:`Abrir em player externo`,"data-focusable":`true`,"data-nav-group":`player-top`,onKeyDown:e=>{e.key===`Enter`||e.key===` `?(e.preventDefault(),N(!M)):e.key===`Escape`&&M&&(e.preventDefault(),N(!1))},children:(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`path`,{d:`M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6`}),(0,$.jsx)(`path`,{d:`M15 3h6v6M10 14L21 3`})]})}),M&&(0,$.jsxs)(`div`,{className:`external-dropdown`,children:[(0,$.jsx)(`button`,{onClick:()=>{we(`vlc`),N(!1)},"data-focusable":`true`,"data-nav-group":`external-menu`,onKeyDown:e=>{e.key===`Enter`||e.key===` `?(e.preventDefault(),we(`vlc`),N(!1)):e.key===`Escape`&&(e.preventDefault(),N(!1))},children:` VLC Player`}),(0,$.jsx)(`button`,{onClick:()=>{we(`iina`),N(!1)},"data-focusable":`true`,"data-nav-group":`external-menu`,onKeyDown:e=>{e.key===`Enter`||e.key===` `?(e.preventDefault(),we(`iina`),N(!1)):e.key===`Escape`&&(e.preventDefault(),N(!1))},children:` IINA (macOS)`}),(0,$.jsx)(`button`,{onClick:()=>{we(`potplayer`),N(!1)},"data-focusable":`true`,"data-nav-group":`external-menu`,onKeyDown:e=>{e.key===`Enter`||e.key===` `?(e.preventDefault(),we(`potplayer`),N(!1)):e.key===`Escape`&&(e.preventDefault(),N(!1))},children:` PotPlayer`}),(0,$.jsx)(`button`,{onClick:()=>{we(`newtab`),N(!1)},"data-focusable":`true`,"data-nav-group":`external-menu`,onKeyDown:e=>{e.key===`Enter`||e.key===` `?(e.preventDefault(),we(`newtab`),N(!1)):e.key===`Escape`&&(e.preventDefault(),N(!1))},children:` Nova aba`}),(0,$.jsx)(`hr`,{}),(0,$.jsx)(`button`,{onClick:()=>{we(`copy`),N(!1)},"data-focusable":`true`,"data-nav-group":`external-menu`,onKeyDown:e=>{e.key===`Enter`||e.key===` `?(e.preventDefault(),we(`copy`),N(!1)):e.key===`Escape`&&(e.preventDefault(),N(!1))},children:` Copiar URL`})]})]})})]}),!c&&!w&&!E&&(0,$.jsx)(`button`,{className:`center-play`,onClick:me,"data-focusable":`true`,"data-nav-group":`player-center`,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),me())},children:(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`currentColor`,children:(0,$.jsx)(`path`,{d:`M8 5v14l11-7z`})})}),(0,$.jsxs)(`div`,{className:`controls-bottom`,children:[(0,$.jsxs)(`div`,{className:`progress-container`,ref:s,onClick:Se,children:[(0,$.jsx)(`div`,{className:`progress-buffered`,style:{width:`${b}%`}}),(0,$.jsx)(`div`,{className:`progress-played`,style:{width:`${v?g/v*100:0}%`}}),(0,$.jsx)(`div`,{className:`progress-thumb`,style:{left:`${v?g/v*100:0}%`}})]}),(0,$.jsxs)(`div`,{className:`controls-row`,children:[(0,$.jsxs)(`div`,{className:`controls-left`,children:[(0,$.jsx)(`button`,{className:`control-btn`,onClick:me,title:c?`Pausar (K)`:`Reproduzir (K)`,"data-focusable":`true`,"data-nav-group":`player-controls`,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),me())},children:c?(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`currentColor`,children:(0,$.jsx)(`path`,{d:`M6 4h4v16H6zM14 4h4v16h-4z`})}):(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`currentColor`,children:(0,$.jsx)(`path`,{d:`M8 5v14l11-7z`})})}),(0,$.jsx)(`button`,{className:`control-btn`,onClick:()=>he(-R),title:`Voltar ${R}s ()`,"data-focusable":`true`,"data-nav-group":`player-controls`,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),he(-R))},children:(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`currentColor`,children:[(0,$.jsx)(`path`,{d:`M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z`}),(0,$.jsx)(`text`,{x:`12`,y:`15`,fontSize:`7`,fill:`currentColor`,textAnchor:`middle`,fontWeight:`bold`,children:R})]})}),(0,$.jsx)(`button`,{className:`control-btn`,onClick:()=>he(R),title:`Avanar ${R}s ()`,"data-focusable":`true`,"data-nav-group":`player-controls`,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),he(R))},children:(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`currentColor`,children:[(0,$.jsx)(`path`,{d:`M12 5V1l5 5-5 5V7c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6h2c0 4.42-3.58 8-8 8s-8-3.58-8-8 3.58-8 8-8z`}),(0,$.jsx)(`text`,{x:`12`,y:`15`,fontSize:`7`,fill:`currentColor`,textAnchor:`middle`,fontWeight:`bold`,children:R})]})}),(0,$.jsxs)(`div`,{className:`volume-control`,children:[(0,$.jsx)(`button`,{className:`control-btn`,onClick:()=>p(e=>!e),title:`Mudo (M)`,"data-focusable":`true`,"data-nav-group":`player-controls`,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),p(e=>!e))},children:f||m===0?(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`path`,{d:`M11 5L6 9H2v6h4l5 4V5z`}),(0,$.jsx)(`path`,{d:`M23 9l-6 6M17 9l6 6`})]}):(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`path`,{d:`M11 5L6 9H2v6h4l5 4V5z`}),(0,$.jsx)(`path`,{d:`M19.07 4.93a10 10 0 010 14.14M15.54 8.46a5 5 0 010 7.07`})]})}),(0,$.jsx)(`input`,{type:`range`,min:`0`,max:`1`,step:`0.05`,value:f?0:m,onChange:e=>{h(parseFloat(e.target.value)),p(!1)},className:`volume-slider`,"data-focusable":`true`,"data-nav-group":`player-controls`})]}),(0,$.jsxs)(`div`,{className:`time-resolution-display`,children:[(0,$.jsxs)(`span`,{className:`time-display`,children:[K(g),` / `,K(v)]}),re&&(0,$.jsx)(`span`,{className:`video-resolution`,children:re})]})]}),(0,$.jsxs)(`div`,{className:`controls-right`,children:[(0,$.jsx)(`button`,{className:`control-btn cast-btn ${ae.isConnected?`active casting`:``}`,onClick:ve,title:ae.isConnected?`Transmitindo para ${ae.deviceName}`:`Transmitir (C)`,"data-focusable":`true`,"data-nav-group":`player-controls`,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),ve())},children:(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`path`,{d:`M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6`}),(0,$.jsx)(`circle`,{cx:`2`,cy:`20`,r:`2`,fill:`currentColor`})]})}),de&&(0,$.jsx)(`button`,{className:`control-btn next-ep-btn`,onClick:pe,title:`Prximo episdio (N)`,"data-focusable":`true`,"data-nav-group":`player-controls`,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),pe())},children:(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`currentColor`,children:(0,$.jsx)(`path`,{d:`M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z`})})}),(0,$.jsxs)(`div`,{className:`settings-menu-wrapper`,children:[(0,$.jsx)(`button`,{className:`control-btn`,onClick:()=>L(!I),title:`Configuraes`,"data-focusable":`true`,"data-nav-group":`player-controls`,onKeyDown:e=>{e.key===`Enter`||e.key===` `?(e.preventDefault(),L(!I)):e.key===`Escape`&&I&&(e.preventDefault(),L(!1))},children:(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`circle`,{cx:`12`,cy:`12`,r:`3`}),(0,$.jsx)(`path`,{d:`M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z`})]})}),I&&(0,$.jsxs)(`div`,{className:`settings-dropdown`,onClick:e=>e.stopPropagation(),children:[(0,$.jsxs)(`div`,{className:`settings-section`,children:[(0,$.jsx)(`label`,{children:`Velocidade`}),(0,$.jsxs)(`select`,{value:A,onChange:e=>j(parseFloat(e.target.value)),"data-focusable":`true`,"data-nav-group":`settings-menu`,children:[(0,$.jsx)(`option`,{value:`0.25`,children:`0.25x`}),(0,$.jsx)(`option`,{value:`0.5`,children:`0.5x`}),(0,$.jsx)(`option`,{value:`0.75`,children:`0.75x`}),(0,$.jsx)(`option`,{value:`1`,children:`Normal`}),(0,$.jsx)(`option`,{value:`1.25`,children:`1.25x`}),(0,$.jsx)(`option`,{value:`1.5`,children:`1.5x`}),(0,$.jsx)(`option`,{value:`1.75`,children:`1.75x`}),(0,$.jsx)(`option`,{value:`2`,children:`2x`}),(0,$.jsx)(`option`,{value:`2.5`,children:`2.5x`}),(0,$.jsx)(`option`,{value:`3`,children:`3x`})]})]}),(0,$.jsxs)(`div`,{className:`settings-section`,children:[(0,$.jsx)(`label`,{children:`Pular (segundos)`}),(0,$.jsxs)(`select`,{value:R,onChange:e=>z(parseInt(e.target.value)),"data-focusable":`true`,"data-nav-group":`settings-menu`,children:[(0,$.jsx)(`option`,{value:`5`,children:`5s`}),(0,$.jsx)(`option`,{value:`10`,children:`10s`}),(0,$.jsx)(`option`,{value:`15`,children:`15s`}),(0,$.jsx)(`option`,{value:`30`,children:`30s`}),(0,$.jsx)(`option`,{value:`60`,children:`1 min`})]})]}),(0,$.jsxs)(`div`,{className:`settings-section`,children:[(0,$.jsx)(`label`,{children:`Proporo`}),(0,$.jsxs)(`select`,{value:te,onChange:e=>ne(e.target.value),"data-focusable":`true`,"data-nav-group":`settings-menu`,children:[(0,$.jsx)(`option`,{value:`auto`,children:`Auto`}),(0,$.jsx)(`option`,{value:`16:9`,children:`16:9`}),(0,$.jsx)(`option`,{value:`4:3`,children:`4:3`}),(0,$.jsx)(`option`,{value:`21:9`,children:`21:9 (Cinema)`})]})]}),(0,$.jsxs)(`div`,{className:`settings-section`,children:[(0,$.jsxs)(`label`,{children:[`Brilho: `,B,`%`]}),(0,$.jsx)(`input`,{type:`range`,min:`50`,max:`150`,value:B,onChange:e=>V(parseInt(e.target.value)),className:`settings-slider`,"data-focusable":`true`,"data-nav-group":`settings-menu`})]}),(0,$.jsx)(`hr`,{}),(0,$.jsxs)(`div`,{className:`settings-shortcuts`,children:[(0,$.jsx)(`h4`,{children:`Atalhos de Teclado`}),(0,$.jsxs)(`ul`,{children:[(0,$.jsxs)(`li`,{children:[(0,$.jsx)(`kbd`,{children:`Espao`}),` / `,(0,$.jsx)(`kbd`,{children:`K`}),` - Play/Pause`]}),(0,$.jsxs)(`li`,{children:[(0,$.jsx)(`kbd`,{children:``}),` / `,(0,$.jsx)(`kbd`,{children:``}),` - Pular `,R,`s`]}),(0,$.jsxs)(`li`,{children:[(0,$.jsx)(`kbd`,{children:`J`}),` / `,(0,$.jsx)(`kbd`,{children:`L`}),` - Pular 10s`]}),(0,$.jsxs)(`li`,{children:[(0,$.jsx)(`kbd`,{children:``}),` / `,(0,$.jsx)(`kbd`,{children:``}),` - Volume`]}),(0,$.jsxs)(`li`,{children:[(0,$.jsx)(`kbd`,{children:`M`}),` - Mudo`]}),(0,$.jsxs)(`li`,{children:[(0,$.jsx)(`kbd`,{children:`F`}),` - Tela cheia`]}),(0,$.jsxs)(`li`,{children:[(0,$.jsx)(`kbd`,{children:`P`}),` - Picture-in-Picture`]}),(0,$.jsxs)(`li`,{children:[(0,$.jsx)(`kbd`,{children:`S`}),` - Pular intro`]}),(0,$.jsxs)(`li`,{children:[(0,$.jsx)(`kbd`,{children:`0-9`}),` - Pular para %`]}),(0,$.jsxs)(`li`,{children:[(0,$.jsx)(`kbd`,{children:`<`}),` / `,(0,$.jsx)(`kbd`,{children:`>`}),` - Velocidade`]}),(0,$.jsxs)(`li`,{children:[(0,$.jsx)(`kbd`,{children:`,`}),` / `,(0,$.jsx)(`kbd`,{children:`.`}),` - Frame a frame`]})]})]})]})]}),document.pictureInPictureEnabled&&(0,$.jsx)(`button`,{className:`control-btn`,onClick:_e,title:`Picture-in-Picture (P)`,"data-focusable":`true`,"data-nav-group":`player-controls`,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),_e())},children:P?(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`rect`,{x:`2`,y:`4`,width:`20`,height:`14`,rx:`2`}),(0,$.jsx)(`rect`,{x:`10`,y:`9`,width:`10`,height:`7`,rx:`1`,fill:`currentColor`})]}):(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`rect`,{x:`2`,y:`4`,width:`20`,height:`14`,rx:`2`}),(0,$.jsx)(`rect`,{x:`11`,y:`10`,width:`8`,height:`6`,rx:`1`})]})}),A!==1&&(0,$.jsxs)(`span`,{className:`speed-indicator`,children:[A,`x`]}),(0,$.jsx)(`button`,{className:`control-btn`,onClick:ge,title:`Tela cheia (F)`,"data-focusable":`true`,"data-nav-group":`player-controls`,onKeyDown:e=>{(e.key===`Enter`||e.key===` `)&&(e.preventDefault(),ge())},children:S?(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:(0,$.jsx)(`path`,{d:`M8 3v3a2 2 0 01-2 2H3M21 8h-3a2 2 0 01-2-2V3M3 16h3a2 2 0 012 2v3M16 21v-3a2 2 0 012-2h3`})}):(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:(0,$.jsx)(`path`,{d:`M8 3H5a2 2 0 00-2 2v3M21 8V5a2 2 0 00-2-2h-3M3 16v3a2 2 0 002 2h3M16 21h3a2 2 0 002-2v-3`})})})]})]})]})]}),ce&&(0,$.jsxs)(`div`,{className:`cast-message`,children:[(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`path`,{d:`M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6`}),(0,$.jsx)(`circle`,{cx:`2`,cy:`20`,r:`2`,fill:`currentColor`})]}),(0,$.jsx)(`span`,{children:ce})]}),ae.isConnected&&(0,$.jsxs)(`div`,{className:`cast-active-indicator`,children:[(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`path`,{d:`M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6`}),(0,$.jsx)(`circle`,{cx:`2`,cy:`20`,r:`2`,fill:`currentColor`})]}),(0,$.jsxs)(`span`,{children:[`Transmitindo para `,ae.deviceName]}),(0,$.jsx)(`button`,{onClick:()=>Mu.stopCasting(),children:`Parar`})]}),se&&(0,$.jsx)(`div`,{className:`cast-modal-overlay`,onClick:()=>{U(!1),G(!1)},children:(0,$.jsxs)(`div`,{className:`cast-modal`,onClick:e=>e.stopPropagation(),children:[le?(0,$.jsxs)($.Fragment,{children:[(0,$.jsx)(`h3`,{children:`Abrir em player externo`}),(0,$.jsx)(`p`,{children:`Escolha um player para abrir o vdeo`}),(0,$.jsxs)(`div`,{className:`cast-options external-players`,children:[e&&Mu.getExternalPlayerLinks(e.url).map(e=>(0,$.jsxs)(`button`,{className:`cast-option`,onClick:()=>be(e.url),children:[(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:(0,$.jsx)(`polygon`,{points:`5 3 19 12 5 21 5 3`})}),(0,$.jsx)(`span`,{children:e.name}),(0,$.jsx)(`small`,{children:e.platforms.join(`, `)})]},e.name)),(0,$.jsxs)(`button`,{className:`cast-option copy-url`,onClick:()=>ye(`copyLink`),children:[(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`rect`,{x:`9`,y:`9`,width:`13`,height:`13`,rx:`2`,ry:`2`}),(0,$.jsx)(`path`,{d:`M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1`})]}),(0,$.jsx)(`span`,{children:`Copiar URL do stream`}),(0,$.jsx)(`small`,{children:`Para colar manualmente no player`})]})]}),(0,$.jsx)(`button`,{className:`cast-modal-back`,onClick:()=>G(!1),children:` Voltar`})]}):(0,$.jsxs)($.Fragment,{children:[(0,$.jsx)(`h3`,{children:`Transmitir para dispositivo`}),(0,$.jsxs)(`p`,{children:[`Escolha como deseja transmitir "`,e?.name,`"`]}),(0,$.jsx)(`div`,{className:`cast-options`,children:Mu.getAvailableMethods().map(e=>(0,$.jsxs)(`button`,{className:`cast-option`,onClick:()=>ye(e.method),children:[e.icon===`chromecast`&&(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`path`,{d:`M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6`}),(0,$.jsx)(`circle`,{cx:`2`,cy:`20`,r:`2`,fill:`currentColor`})]}),e.icon===`airplay`&&(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`path`,{d:`M5 17H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-1`}),(0,$.jsx)(`polygon`,{points:`12 15 17 21 7 21 12 15`})]}),e.icon===`tv`&&(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`rect`,{x:`2`,y:`3`,width:`20`,height:`14`,rx:`2`}),(0,$.jsx)(`path`,{d:`M8 21h8M12 17v4`})]}),e.icon===`share`&&(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`circle`,{cx:`18`,cy:`5`,r:`3`}),(0,$.jsx)(`circle`,{cx:`6`,cy:`12`,r:`3`}),(0,$.jsx)(`circle`,{cx:`18`,cy:`19`,r:`3`}),(0,$.jsx)(`line`,{x1:`8.59`,y1:`13.51`,x2:`15.42`,y2:`17.49`}),(0,$.jsx)(`line`,{x1:`15.41`,y1:`6.51`,x2:`8.59`,y2:`10.49`})]}),e.icon===`copy`&&(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`rect`,{x:`9`,y:`9`,width:`13`,height:`13`,rx:`2`,ry:`2`}),(0,$.jsx)(`path`,{d:`M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1`})]}),e.icon===`external`&&(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`path`,{d:`M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6`}),(0,$.jsx)(`polyline`,{points:`15 3 21 3 21 9`}),(0,$.jsx)(`line`,{x1:`10`,y1:`14`,x2:`21`,y2:`3`})]}),(0,$.jsx)(`span`,{children:e.name}),(0,$.jsx)(`small`,{children:e.description})]},e.method))})]}),(0,$.jsx)(`button`,{className:`cast-modal-close`,onClick:()=>{U(!1),G(!1)},children:`Cancelar`})]})})]}):(0,$.jsx)(`div`,{className:`movie-player empty`,children:(0,$.jsxs)(`div`,{className:`empty-state`,children:[(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`1.5`,children:(0,$.jsx)(`path`,{d:`M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z`})}),(0,$.jsx)(`h3`,{children:`Selecione um filme ou srie`}),(0,$.jsx)(`p`,{children:`Escolha algo para assistir no catlogo`})]})})});var Pu=`epg_cache_v2`,Fu=`epg_cache_meta_v2`,Iu=720*60*60*1e3,Lu=5,Ru=new Map,zu=new Map,Bu=new Map,Vu=new Set,Hu=[e=>`https://api.allorigins.win/raw?url=${encodeURIComponent(e)}`,e=>`https://corsproxy.io/?${encodeURIComponent(e)}`,e=>`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(e)}`,e=>`https://proxy.cors.sh/${e}`,e=>`https://thingproxy.freeboard.io/fetch/${e}`],Uu=0,Wu=3,Gu=1e3,Ku={"hbo-pop":`hbo-pop`,"hbo-xtreme":`hbo-xtreme`,"hbo-mundi":`hbo-mundi`,history2:`history-2`,"food-network":`food-network`,hgtv:`hgtv`,"cnn-brasil":`cnn-brasil`,cartoonito:`cartoonito`,gloobinho:`gloobinho`,curta:`curta`,premiere2:`premiere-2`,premiere3:`premiere-3`,premiere4:`premiere-4`},qu={"telecine-action":`TC2`,"telecine-premium":`TC1`,"telecine-pipoca":`TC4`,"telecine-cult":`TC5`,"telecine-fun":`TC6`,"telecine-touch":`TC3`,hbo:`HBO`,hbo2:`HB2`,"hbo-family":`HFA`,"hbo-plus":`HPL`,"hbo-pop":`HPO`,"hbo-xtreme":`HXT`,"hbo-mundi":`HMU`,"globo-sp":`GRD`,"globo-rj":`GRD`,"globo-mg":`GRD`,"globo-rs":`GRD`,"globo-news":`GLN`,sportv:`SPO`,sportv2:`SP2`,sportv3:`SP3`,espn:`ESP`,espn2:`ES2`,espn3:`ES3`,espn4:`ES4`,espn5:`ES5`,sbt:`SBT`,band:`BAN`,record:`REC`,"rede-tv":`RTV`,"tv-brasil":`TED`,aparecida:`TAP`,cultura:`CUL`,"tv-gazeta":`GAZ`,"band-news":`NEW`,"record-news":`RCN`,"cnn-brasil":`CNB`,"cartoon-network":`CAR`,"discovery-kids":`DIK`,gloob:`GOB`,cartoonito:`CTO`,gloobinho:`GBI`,discovery:`DIS`,"discovery-turbo":`DTU`,"discovery-world":`DIW`,"discovery-science":`DSC`,"discovery-hh":`HEA`,"animal-planet":`APL`,history:`HIS`,history2:`H2H`,tlc:`TRV`,"food-network":`FNT`,hgtv:`HGT`,warner:`WBT`,tnt:`TNT`,"tnt-series":`TNS`,axn:`AXN`,sony:`SET`,"universal-tv":`USA`,ae:`MDO`,amc:`MGM`,tcm:`TCM`,space:`SPA`,cinemax:`MNX`,megapix:`MPX`,"studio-universal":`HAL`,curta:`CUR`,multishow:`MSW`,bis:`MSH`,viva:`VIV`,off:`OFF`,gnt:`GNT`,arte1:`BQ5`,premiere:`121`,combate:`135`,"band-sports":`BSP`,premiere2:`PR2`,premiere3:`PR3`,premiere4:`PR4`};function Ju(){try{let e=localStorage.getItem(Pu),t=localStorage.getItem(Fu);if(e&&t){let n=JSON.parse(e),r=JSON.parse(t);Object.entries(n).forEach(([e,t])=>{let n=t.map(e=>({...e,startTime:new Date(e.startTime),endTime:new Date(e.endTime)}));Ru.set(e,n),zu.set(e,r.channelLastUpdate[e]||0)}),console.log(`[EPG Cache] Carregado ${Ru.size} canais do localStorage`)}}catch(e){console.error(`[EPG Cache] Erro ao carregar cache:`,e)}}function Yu(){try{let e={},t={lastFullLoad:Date.now(),channelLastUpdate:{}};Ru.forEach((n,r)=>{e[r]=n,t.channelLastUpdate[r]=zu.get(r)||Date.now()}),localStorage.setItem(Pu,JSON.stringify(e)),localStorage.setItem(Fu,JSON.stringify(t)),console.log(`[EPG Cache] Salvo ${Ru.size} canais no localStorage`)}catch(e){console.error(`[EPG Cache] Erro ao salvar cache:`,e)}}function Xu(e){let t=Ru.get(e),n=zu.get(e)||0,r=Date.now();if(!t||t.length===0)return console.log(`[EPG Cache] ${e}: Sem cache, precisa carregar`),!0;if(r-n>Iu)return console.log(`[EPG Cache] ${e}: Cache expirado (${Math.floor((r-n)/(1440*60*1e3))} dias)`),!0;let i=new Date,a=t.filter(e=>e.endTime>i);return a.length<Lu?(console.log(`[EPG Cache] ${e}: Poucos programas futuros (${a.length}), precisa atualizar`),!0):!1}function Zu(e){return Vu.add(e),()=>Vu.delete(e)}function Qu(e,t){Vu.forEach(n=>{try{n(e,t)}catch(e){console.error(`Erro em listener EPG:`,e)}})}function $u(e,t){let n=[];try{let r=new Date,i=r.getFullYear(),a=e.replace(/<li class="subheader[^"]*"><%=[^>]+%><\/li>/gi,``),o=/<div class=['"]lileft time['"]>\s*(\d{1,2}:\d{2})\s*<\/div>[\s\S]*?<h2>([^<]+)<\/h2>[\s\S]*?<h3>([^<]*)<\/h3>/gi,s=[],c=/<li class="subheader[^"]*">[^<]*?(\d{1,2})\/(\d{1,2})[^<]*<\/li>/gi,l;for(;(l=c.exec(a))!==null;){let e=parseInt(l[1]),t=parseInt(l[2])-1,n=new Date(i,t,e,0,0,0,0);t<r.getMonth()-6&&(n=new Date(i+1,t,e,0,0,0,0)),s.push({index:l.index,date:n})}s.length===0&&s.push({index:0,date:new Date(r.getFullYear(),r.getMonth(),r.getDate())});let u,d=-1,f=0;for(;(u=o.exec(a))!==null;){let e=u[1],r=u[2].trim(),i=u[3].trim();for(;f<s.length-1&&u.index>s[f+1].index;)f++,d=-1;let a=new Date(s[f].date),o=e.split(`:`),c=parseInt(o[0]),l=parseInt(o[1]);d!==-1&&c<d-6&&(a=new Date(a.getTime()+1440*60*1e3)),d=c;let p=new Date(a);p.setHours(c,l,0,0);let m=new Date(p.getTime()+3600*1e3);n.push({id:`${t}-${p.getTime()}`,title:ed(r),description:``,category:ed(i),startTime:p,endTime:m})}n.sort((e,t)=>e.startTime.getTime()-t.startTime.getTime());for(let e=0;e<n.length-1;e++)n[e].endTime=n[e+1].startTime;console.log(`[EPG] ${t}: ${n.length} programas parseados`)}catch(e){console.error(`[EPG] Erro parsing:`,e)}return n}function ed(e){let t={"&amp;":`&`,"&lt;":`<`,"&gt;":`>`,"&quot;":`"`,"&#39;":`'`,"&apos;":`'`,"&nbsp;":` `,"&eacute;":``,"&aacute;":``,"&iacute;":``,"&oacute;":``,"&uacute;":``,"&atilde;":``,"&otilde;":``,"&ccedil;":``,"&ndash;":``,"&mdash;":``};return e.replace(/&[^;]+;/g,e=>t[e]||e)}function td(e,t){let n=[];try{let r=/data-dt="(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})[^"]*"[\s\S]*?<a[^>]*href="[^"]*programa\/[^"]+\"[^>]*>[\s\S]*?([A-Za-z-0-9][^<]{2,150})/g,i;for(;(i=r.exec(e))!==null;){let e=i[1],r=i[2].trim().replace(/\s+/g,` `);if(r=r.replace(/^[\s\n\r]+|[\s\n\r]+$/g,``),!r||r.length<2||r.length>150||r.includes(`{`)||r.includes(`function`))continue;let[a,o]=e.split(` `),[s,c,l]=a.split(`-`).map(Number),[u,d]=o.split(`:`).map(Number),f=new Date(s,c-1,l,u,d,0,0),p=new Date(f.getTime()+3600*1e3);n.push({id:`${t}-${f.getTime()}`,title:ed(r),description:``,category:``,startTime:f,endTime:p})}let a=new Map;n.forEach(e=>{let t=`${e.startTime.getTime()}-${e.title}`;a.has(t)||a.set(t,e)});let o=Array.from(a.values());o.sort((e,t)=>e.startTime.getTime()-t.startTime.getTime());for(let e=0;e<o.length-1;e++)o[e].endTime=o[e+1].startTime;return console.log(`[EPG GuiaDeTV] ${t}: ${o.length} programas parseados`),o}catch(e){console.error(`[EPG GuiaDeTV] Erro parsing:`,e)}return n}async function nd(e,t=15e3){let n=new AbortController,r=setTimeout(()=>n.abort(),t);try{return await fetch(e,{signal:n.signal})}finally{clearTimeout(r)}}async function rd(e,t,n=`meuguia`){let r=Uu;for(let i=0;i<Wu;i++){let a=Gu*2**i;for(let a=0;a<Hu.length;a++){let o=(r+a)%Hu.length,s=Hu[o](e);try{let e=n===`guiadetv`?`GuiaDeTV`:`MeuGuia`;console.log(`[EPG ${e}] ${t}: Tentativa ${i+1}/${Wu}, proxy ${o+1}/${Hu.length}`);let r=await nd(s,15e3);if(r.ok){let i=await r.text(),a=!1;if(a=n===`guiadetv`?i.length>1e3&&(i.includes(`data-dt=`)||i.includes(`/programa/`)):i.length>1e3&&(i.includes(`lileft time`)||i.includes(`<h2>`)),a)return Uu=o,console.log(`[EPG ${e}] ${t}: Sucesso com proxy ${o+1}`),i;console.log(`[EPG ${e}] ${t}: Proxy ${o+1} retornou HTML invlido`)}else if(r.status===429){console.log(`[EPG] ${t}: Proxy ${o+1} com rate limit (429)`);continue}else console.log(`[EPG] ${t}: Proxy ${o+1} HTTP ${r.status}`)}catch(e){let n=e instanceof Error?e.message:`Erro desconhecido`;console.log(`[EPG] ${t}: Proxy ${o+1} falhou: ${n}`)}}i<Wu-1&&(console.log(`[EPG] ${t}: Aguardando ${a}ms antes de retry...`),await new Promise(e=>setTimeout(e,a)))}return console.log(`[EPG] ${t}: Falhou aps ${Wu} tentativas`),null}async function id(e,t=!1){let n=qu[e],r=Ku[e];if(!n&&!r)return console.log(`[EPG] ${e}: sem cdigo de EPG em nenhuma fonte`),[];if(!t&&!Xu(e))return console.log(`[EPG Cache] ${e}: Usando cache vlido`),Ru.get(e)||[];if(Bu.has(e))return Bu.get(e);let i=(async()=>{try{let t=null,i=[],a=``;if(r){let n=`https://www.guiadetv.com/canal/${r}`;console.log(`[EPG GuiaDeTV] Buscando ${e} de ${n}`),t=await rd(n,e,`guiadetv`),t&&(i=td(t,e),a=`guiadetv.com`)}if(i.length===0&&n){let r=`https://meuguia.tv/programacao/canal/${n}`;console.log(`[EPG MeuGuia] Buscando ${e} de ${r}`),t=await rd(r,e,`meuguia`),t&&(i=$u(t,e),a=`meuguia.tv`)}return i.length===0?(console.log(`[EPG] ${e}: No foi possvel obter dados de nenhuma fonte`),Ru.get(e)||[]):(Ru.set(e,i),zu.set(e,Date.now()),Qu(e,i),Yu(),console.log(`[EPG] ${e}: ${i.length} programas salvos (fonte: ${a})`),i)}catch(t){return console.error(`[EPG] ${e}: erro`,t),Ru.get(e)||[]}finally{Bu.delete(e)}})();return Bu.set(e,i),i}var ad=!1;async function od(){if(ad)return console.log(`[EPG] J inicializado`),!0;ad=!0,console.log(`[EPG] Inicializando servio com cache inteligente...`),Ju();let e=Object.keys(qu).filter(Xu);return console.log(`[EPG] ${Ru.size} canais em cache, ${e.length} precisam atualizar`),e.length>0&&sd(e),!0}async function sd(e){console.log(`[EPG] Carregando ${e.length} canais em background...`);for(let t=0;t<e.length;t+=2){let n=e.slice(t,t+2);await Promise.all(n.map(e=>id(e))),console.log(`[EPG] Carregados ${Math.min(t+2,e.length)}/${e.length} canais`),t+2<e.length&&await new Promise(e=>setTimeout(e,1500))}Yu(),console.log(`[EPG] Carregamento em background concludo!`)}function cd(e){return Xu(e)&&id(e),{channelId:e,programs:Ru.get(e)||[]}}function ld(e){if(!Ru.has(e))return id(e),null;let t=Ru.get(e)||[];if(t.length===0)return null;let n=new Date,r=t.find(e=>e.startTime<=n&&e.endTime>n);if(!r)return null;let i=t.find(e=>e.startTime>n),a=r.endTime.getTime()-r.startTime.getTime(),o=n.getTime()-r.startTime.getTime(),s=Math.min(100,Math.max(0,o/a*100));return{current:r,next:i||null,progress:s}}async function ud(e){return await id(e),ld(e)}var dd=t(((e,t)=>{(function(n,r){typeof e==`object`&&typeof t==`object`?t.exports=r():typeof define==`function`&&define.amd?define([],r):typeof e==`object`?e.mpegts=r():n.mpegts=r()})(window,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){typeof Symbol<`u`&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:`Module`}),Object.defineProperty(e,`__esModule`,{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t||4&t&&typeof e==`object`&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,`default`,{enumerable:!0,value:e}),2&t&&typeof e!=`string`)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,`a`,t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p=``,n(n.s=20)}([function(e,t,n){var r=n(9),i=n.n(r),a=function(){function e(){}return e.e=function(t,n){t&&!e.FORCE_GLOBAL_TAG||(t=e.GLOBAL_TAG);var r=`[${t}] > ${n}`;e.ENABLE_CALLBACK&&e.emitter.emit(`log`,`error`,r),e.ENABLE_ERROR&&(console.error?console.error(r):console.warn?console.warn(r):console.log(r))},e.i=function(t,n){t&&!e.FORCE_GLOBAL_TAG||(t=e.GLOBAL_TAG);var r=`[${t}] > ${n}`;e.ENABLE_CALLBACK&&e.emitter.emit(`log`,`info`,r),e.ENABLE_INFO&&(console.info?console.info(r):console.log(r))},e.w=function(t,n){t&&!e.FORCE_GLOBAL_TAG||(t=e.GLOBAL_TAG);var r=`[${t}] > ${n}`;e.ENABLE_CALLBACK&&e.emitter.emit(`log`,`warn`,r),e.ENABLE_WARN&&(console.warn?console.warn(r):console.log(r))},e.d=function(t,n){t&&!e.FORCE_GLOBAL_TAG||(t=e.GLOBAL_TAG);var r=`[${t}] > ${n}`;e.ENABLE_CALLBACK&&e.emitter.emit(`log`,`debug`,r),e.ENABLE_DEBUG&&(console.debug?console.debug(r):console.log(r))},e.v=function(t,n){t&&!e.FORCE_GLOBAL_TAG||(t=e.GLOBAL_TAG);var r=`[${t}] > ${n}`;e.ENABLE_CALLBACK&&e.emitter.emit(`log`,`verbose`,r),e.ENABLE_VERBOSE&&console.log(r)},e}();a.GLOBAL_TAG=`mpegts.js`,a.FORCE_GLOBAL_TAG=!1,a.ENABLE_ERROR=!0,a.ENABLE_INFO=!0,a.ENABLE_WARN=!0,a.ENABLE_DEBUG=!0,a.ENABLE_VERBOSE=!0,a.ENABLE_CALLBACK=!1,a.emitter=new i.a,t.a=a},function(e,t,n){var r;(function(e){e.IO_ERROR=`io_error`,e.DEMUX_ERROR=`demux_error`,e.INIT_SEGMENT=`init_segment`,e.MEDIA_SEGMENT=`media_segment`,e.LOADING_COMPLETE=`loading_complete`,e.RECOVERED_EARLY_EOF=`recovered_early_eof`,e.MEDIA_INFO=`media_info`,e.METADATA_ARRIVED=`metadata_arrived`,e.SCRIPTDATA_ARRIVED=`scriptdata_arrived`,e.TIMED_ID3_METADATA_ARRIVED=`timed_id3_metadata_arrived`,e.SYNCHRONOUS_KLV_METADATA_ARRIVED=`synchronous_klv_metadata_arrived`,e.ASYNCHRONOUS_KLV_METADATA_ARRIVED=`asynchronous_klv_metadata_arrived`,e.SMPTE2038_METADATA_ARRIVED=`smpte2038_metadata_arrived`,e.SCTE35_METADATA_ARRIVED=`scte35_metadata_arrived`,e.PES_PRIVATE_DATA_DESCRIPTOR=`pes_private_data_descriptor`,e.PES_PRIVATE_DATA_ARRIVED=`pes_private_data_arrived`,e.STATISTICS_INFO=`statistics_info`,e.RECOMMEND_SEEKPOINT=`recommend_seekpoint`})(r||={}),t.a=r},function(e,t,n){n.d(t,`c`,(function(){return i})),n.d(t,`b`,(function(){return a})),n.d(t,`a`,(function(){return o}));var r=n(3),i={kIdle:0,kConnecting:1,kBuffering:2,kError:3,kComplete:4},a={OK:`OK`,EXCEPTION:`Exception`,HTTP_STATUS_CODE_INVALID:`HttpStatusCodeInvalid`,CONNECTING_TIMEOUT:`ConnectingTimeout`,EARLY_EOF:`EarlyEof`,UNRECOVERABLE_EARLY_EOF:`UnrecoverableEarlyEof`},o=function(){function e(e){this._type=e||`undefined`,this._status=i.kIdle,this._needStash=!1,this._onContentLengthKnown=null,this._onURLRedirect=null,this._onDataArrival=null,this._onError=null,this._onComplete=null}return e.prototype.destroy=function(){this._status=i.kIdle,this._onContentLengthKnown=null,this._onURLRedirect=null,this._onDataArrival=null,this._onError=null,this._onComplete=null},e.prototype.isWorking=function(){return this._status===i.kConnecting||this._status===i.kBuffering},Object.defineProperty(e.prototype,`type`,{get:function(){return this._type},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`status`,{get:function(){return this._status},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`needStashBuffer`,{get:function(){return this._needStash},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`onContentLengthKnown`,{get:function(){return this._onContentLengthKnown},set:function(e){this._onContentLengthKnown=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`onURLRedirect`,{get:function(){return this._onURLRedirect},set:function(e){this._onURLRedirect=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`onDataArrival`,{get:function(){return this._onDataArrival},set:function(e){this._onDataArrival=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`onError`,{get:function(){return this._onError},set:function(e){this._onError=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`onComplete`,{get:function(){return this._onComplete},set:function(e){this._onComplete=e},enumerable:!1,configurable:!0}),e.prototype.open=function(e,t){throw new r.c(`Unimplemented abstract function!`)},e.prototype.abort=function(){throw new r.c(`Unimplemented abstract function!`)},e}()},function(e,t,n){n.d(t,`d`,(function(){return a})),n.d(t,`a`,(function(){return o})),n.d(t,`b`,(function(){return s})),n.d(t,`c`,(function(){return c}));var r,i=(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if(typeof t!=`function`&&t!==null)throw TypeError(`Class extends value `+String(t)+` is not a constructor or null`);function n(){this.constructor=e}r(e,t),e.prototype=t===null?Object.create(t):(n.prototype=t.prototype,new n)}),a=function(){function e(e){this._message=e}return Object.defineProperty(e.prototype,`name`,{get:function(){return`RuntimeException`},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`message`,{get:function(){return this._message},enumerable:!1,configurable:!0}),e.prototype.toString=function(){return this.name+`: `+this.message},e}(),o=function(e){function t(t){return e.call(this,t)||this}return i(t,e),Object.defineProperty(t.prototype,`name`,{get:function(){return`IllegalStateException`},enumerable:!1,configurable:!0}),t}(a),s=function(e){function t(t){return e.call(this,t)||this}return i(t,e),Object.defineProperty(t.prototype,`name`,{get:function(){return`InvalidArgumentException`},enumerable:!1,configurable:!0}),t}(a),c=function(e){function t(t){return e.call(this,t)||this}return i(t,e),Object.defineProperty(t.prototype,`name`,{get:function(){return`NotImplementedException`},enumerable:!1,configurable:!0}),t}(a)},function(e,t,n){var r;(function(e){e.ERROR=`error`,e.LOADING_COMPLETE=`loading_complete`,e.RECOVERED_EARLY_EOF=`recovered_early_eof`,e.MEDIA_INFO=`media_info`,e.METADATA_ARRIVED=`metadata_arrived`,e.SCRIPTDATA_ARRIVED=`scriptdata_arrived`,e.TIMED_ID3_METADATA_ARRIVED=`timed_id3_metadata_arrived`,e.SYNCHRONOUS_KLV_METADATA_ARRIVED=`synchronous_klv_metadata_arrived`,e.ASYNCHRONOUS_KLV_METADATA_ARRIVED=`asynchronous_klv_metadata_arrived`,e.SMPTE2038_METADATA_ARRIVED=`smpte2038_metadata_arrived`,e.SCTE35_METADATA_ARRIVED=`scte35_metadata_arrived`,e.PES_PRIVATE_DATA_DESCRIPTOR=`pes_private_data_descriptor`,e.PES_PRIVATE_DATA_ARRIVED=`pes_private_data_arrived`,e.STATISTICS_INFO=`statistics_info`,e.DESTROYING=`destroying`})(r||={}),t.a=r},function(e,t,n){var r={};(function(){var e=self.navigator.userAgent.toLowerCase(),t=/(edge)\/([\w.]+)/.exec(e)||/(opr)[\/]([\w.]+)/.exec(e)||/(chrome)[ \/]([\w.]+)/.exec(e)||/(iemobile)[\/]([\w.]+)/.exec(e)||/(version)(applewebkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+).*(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf(`trident`)>=0&&/(rv)(?::| )([\w.]+)/.exec(e)||e.indexOf(`compatible`)<0&&/(firefox)[ \/]([\w.]+)/.exec(e)||[],n=/(ipad)/.exec(e)||/(ipod)/.exec(e)||/(windows phone)/.exec(e)||/(iphone)/.exec(e)||/(kindle)/.exec(e)||/(android)/.exec(e)||/(windows)/.exec(e)||/(mac)/.exec(e)||/(linux)/.exec(e)||/(cros)/.exec(e)||[],i={browser:t[5]||t[3]||t[1]||``,version:t[2]||t[4]||`0`,majorVersion:t[4]||t[2]||`0`,platform:n[0]||``},a={};if(i.browser){a[i.browser]=!0;var o=i.majorVersion.split(`.`);a.version={major:parseInt(i.majorVersion,10),string:i.version},o.length>1&&(a.version.minor=parseInt(o[1],10)),o.length>2&&(a.version.build=parseInt(o[2],10))}for(var s in i.platform&&(a[i.platform]=!0),(a.chrome||a.opr||a.safari)&&(a.webkit=!0),(a.rv||a.iemobile)&&(a.rv&&delete a.rv,i.browser=`msie`,a.msie=!0),a.edge&&(delete a.edge,i.browser=`msedge`,a.msedge=!0),a.opr&&(i.browser=`opera`,a.opera=!0),a.safari&&a.android&&(i.browser=`android`,a.android=!0),a.name=i.browser,a.platform=i.platform,r)r.hasOwnProperty(s)&&delete r[s];Object.assign(r,a)})(),t.a=r},function(e,t,n){t.a={OK:`OK`,FORMAT_ERROR:`FormatError`,FORMAT_UNSUPPORTED:`FormatUnsupported`,CODEC_UNSUPPORTED:`CodecUnsupported`}},function(e,t,n){var r;(function(e){e.ERROR=`error`,e.SOURCE_OPEN=`source_open`,e.UPDATE_END=`update_end`,e.BUFFER_FULL=`buffer_full`,e.START_STREAMING=`start_streaming`,e.END_STREAMING=`end_streaming`})(r||={}),t.a=r},function(e,t,n){var r=n(9),i=n.n(r),a=n(0),o=function(){function e(){}return Object.defineProperty(e,`forceGlobalTag`,{get:function(){return a.a.FORCE_GLOBAL_TAG},set:function(t){a.a.FORCE_GLOBAL_TAG=t,e._notifyChange()},enumerable:!1,configurable:!0}),Object.defineProperty(e,`globalTag`,{get:function(){return a.a.GLOBAL_TAG},set:function(t){a.a.GLOBAL_TAG=t,e._notifyChange()},enumerable:!1,configurable:!0}),Object.defineProperty(e,`enableAll`,{get:function(){return a.a.ENABLE_VERBOSE&&a.a.ENABLE_DEBUG&&a.a.ENABLE_INFO&&a.a.ENABLE_WARN&&a.a.ENABLE_ERROR},set:function(t){a.a.ENABLE_VERBOSE=t,a.a.ENABLE_DEBUG=t,a.a.ENABLE_INFO=t,a.a.ENABLE_WARN=t,a.a.ENABLE_ERROR=t,e._notifyChange()},enumerable:!1,configurable:!0}),Object.defineProperty(e,`enableDebug`,{get:function(){return a.a.ENABLE_DEBUG},set:function(t){a.a.ENABLE_DEBUG=t,e._notifyChange()},enumerable:!1,configurable:!0}),Object.defineProperty(e,`enableVerbose`,{get:function(){return a.a.ENABLE_VERBOSE},set:function(t){a.a.ENABLE_VERBOSE=t,e._notifyChange()},enumerable:!1,configurable:!0}),Object.defineProperty(e,`enableInfo`,{get:function(){return a.a.ENABLE_INFO},set:function(t){a.a.ENABLE_INFO=t,e._notifyChange()},enumerable:!1,configurable:!0}),Object.defineProperty(e,`enableWarn`,{get:function(){return a.a.ENABLE_WARN},set:function(t){a.a.ENABLE_WARN=t,e._notifyChange()},enumerable:!1,configurable:!0}),Object.defineProperty(e,`enableError`,{get:function(){return a.a.ENABLE_ERROR},set:function(t){a.a.ENABLE_ERROR=t,e._notifyChange()},enumerable:!1,configurable:!0}),e.getConfig=function(){return{globalTag:a.a.GLOBAL_TAG,forceGlobalTag:a.a.FORCE_GLOBAL_TAG,enableVerbose:a.a.ENABLE_VERBOSE,enableDebug:a.a.ENABLE_DEBUG,enableInfo:a.a.ENABLE_INFO,enableWarn:a.a.ENABLE_WARN,enableError:a.a.ENABLE_ERROR,enableCallback:a.a.ENABLE_CALLBACK}},e.applyConfig=function(e){a.a.GLOBAL_TAG=e.globalTag,a.a.FORCE_GLOBAL_TAG=e.forceGlobalTag,a.a.ENABLE_VERBOSE=e.enableVerbose,a.a.ENABLE_DEBUG=e.enableDebug,a.a.ENABLE_INFO=e.enableInfo,a.a.ENABLE_WARN=e.enableWarn,a.a.ENABLE_ERROR=e.enableError,a.a.ENABLE_CALLBACK=e.enableCallback},e._notifyChange=function(){var t=e.emitter;if(t.listenerCount(`change`)>0){var n=e.getConfig();t.emit(`change`,n)}},e.registerListener=function(t){e.emitter.addListener(`change`,t)},e.removeListener=function(t){e.emitter.removeListener(`change`,t)},e.addLogListener=function(t){a.a.emitter.addListener(`log`,t),a.a.emitter.listenerCount(`log`)>0&&(a.a.ENABLE_CALLBACK=!0,e._notifyChange())},e.removeLogListener=function(t){a.a.emitter.removeListener(`log`,t),a.a.emitter.listenerCount(`log`)===0&&(a.a.ENABLE_CALLBACK=!1,e._notifyChange())},e}();o.emitter=new i.a,t.a=o},function(e,t,n){var r,i=typeof Reflect==`object`?Reflect:null,a=i&&typeof i.apply==`function`?i.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};r=i&&typeof i.ownKeys==`function`?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!=e};function s(){s.init.call(this)}e.exports=s,e.exports.once=function(e,t){return new Promise((function(n,r){function i(n){e.removeListener(t,a),r(n)}function a(){typeof e.removeListener==`function`&&e.removeListener(`error`,i),n([].slice.call(arguments))}_(e,t,a,{once:!0}),t!==`error`&&function(e,t,n){typeof e.on==`function`&&_(e,`error`,t,n)}(e,i,{once:!0})}))},s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var c=10;function l(e){if(typeof e!=`function`)throw TypeError(`The "listener" argument must be of type Function. Received type `+typeof e)}function u(e){return e._maxListeners===void 0?s.defaultMaxListeners:e._maxListeners}function d(e,t,n,r){var i,a,o,s;if(l(n),(a=e._events)===void 0?(a=e._events=Object.create(null),e._eventsCount=0):(a.newListener!==void 0&&(e.emit(`newListener`,t,n.listener?n.listener:n),a=e._events),o=a[t]),o===void 0)o=a[t]=n,++e._eventsCount;else if(typeof o==`function`?o=a[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),(i=u(e))>0&&o.length>i&&!o.warned){o.warned=!0;var c=Error(`Possible EventEmitter memory leak detected. `+o.length+` `+String(t)+` listeners added. Use emitter.setMaxListeners() to increase limit`);c.name=`MaxListenersExceededWarning`,c.emitter=e,c.type=t,c.count=o.length,s=c,console&&console.warn&&console.warn(s)}return e}function f(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=f.bind(r);return i.listener=n,r.wrapFn=i,i}function m(e,t,n){var r=e._events;if(r===void 0)return[];var i=r[t];return i===void 0?[]:typeof i==`function`?n?[i.listener||i]:[i]:n?function(e){for(var t=Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):g(i,i.length)}function h(e){var t=this._events;if(t!==void 0){var n=t[e];if(typeof n==`function`)return 1;if(n!==void 0)return n.length}return 0}function g(e,t){for(var n=Array(t),r=0;r<t;++r)n[r]=e[r];return n}function _(e,t,n,r){if(typeof e.on==`function`)r.once?e.once(t,n):e.on(t,n);else{if(typeof e.addEventListener!=`function`)throw TypeError(`The "emitter" argument must be of type EventEmitter. Received type `+typeof e);e.addEventListener(t,(function i(a){r.once&&e.removeEventListener(t,i),n(a)}))}}Object.defineProperty(s,`defaultMaxListeners`,{enumerable:!0,get:function(){return c},set:function(e){if(typeof e!=`number`||e<0||o(e))throw RangeError(`The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received `+e+`.`);c=e}}),s.init=function(){this._events!==void 0&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(e){if(typeof e!=`number`||e<0||o(e))throw RangeError(`The value of "n" is out of range. It must be a non-negative number. Received `+e+`.`);return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return u(this)},s.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r=e===`error`,i=this._events;if(i!==void 0)r&&=i.error===void 0;else if(!r)return!1;if(r){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var s=Error(`Unhandled error.`+(o?` (`+o.message+`)`:``));throw s.context=o,s}var c=i[e];if(c===void 0)return!1;if(typeof c==`function`)a(c,this,t);else{var l=c.length,u=g(c,l);for(n=0;n<l;++n)a(u[n],this,t)}return!0},s.prototype.addListener=function(e,t){return d(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return d(this,e,t,!0)},s.prototype.once=function(e,t){return l(t),this.on(e,p(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){return l(t),this.prependListener(e,p(this,e,t)),this},s.prototype.removeListener=function(e,t){var n,r,i,a,o;if(l(t),(r=this._events)===void 0||(n=r[e])===void 0)return this;if(n===t||n.listener===t)--this._eventsCount==0?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit(`removeListener`,e,n.listener||t));else if(typeof n!=`function`){for(i=-1,a=n.length-1;a>=0;a--)if(n[a]===t||n[a].listener===t){o=n[a].listener,i=a;break}if(i<0)return this;i===0?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),n.length===1&&(r[e]=n[0]),r.removeListener!==void 0&&this.emit(`removeListener`,e,o||t)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(e){var t,n,r;if((n=this._events)===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount==0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var i,a=Object.keys(n);for(r=0;r<a.length;++r)(i=a[r])!==`removeListener`&&this.removeAllListeners(i);return this.removeAllListeners(`removeListener`),this._events=Object.create(null),this._eventsCount=0,this}if(typeof(t=n[e])==`function`)this.removeListener(e,t);else if(t!==void 0)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},s.prototype.listeners=function(e){return m(this,e,!0)},s.prototype.rawListeners=function(e){return m(this,e,!1)},s.listenerCount=function(e,t){return typeof e.listenerCount==`function`?e.listenerCount(t):h.call(e,t)},s.prototype.listenerCount=h,s.prototype.eventNames=function(){return this._eventsCount>0?r(this._events):[]}},function(e,t,n){n.d(t,`b`,(function(){return a})),n.d(t,`a`,(function(){return o}));var r=n(2),i=n(6),a={NETWORK_ERROR:`NetworkError`,MEDIA_ERROR:`MediaError`,OTHER_ERROR:`OtherError`},o={NETWORK_EXCEPTION:r.b.EXCEPTION,NETWORK_STATUS_CODE_INVALID:r.b.HTTP_STATUS_CODE_INVALID,NETWORK_TIMEOUT:r.b.CONNECTING_TIMEOUT,NETWORK_UNRECOVERABLE_EARLY_EOF:r.b.UNRECOVERABLE_EARLY_EOF,MEDIA_MSE_ERROR:`MediaMSEError`,MEDIA_FORMAT_ERROR:i.a.FORMAT_ERROR,MEDIA_FORMAT_UNSUPPORTED:i.a.FORMAT_UNSUPPORTED,MEDIA_CODEC_UNSUPPORTED:i.a.CODEC_UNSUPPORTED}},function(e,t,n){n.d(t,`d`,(function(){return r})),n.d(t,`b`,(function(){return i})),n.d(t,`a`,(function(){return a})),n.d(t,`c`,(function(){return o}));var r=function(e,t,n,r,i){this.dts=e,this.pts=t,this.duration=n,this.originalDts=r,this.isSyncPoint=i,this.fileposition=null},i=function(){function e(){this.beginDts=0,this.endDts=0,this.beginPts=0,this.endPts=0,this.originalBeginDts=0,this.originalEndDts=0,this.syncPoints=[],this.firstSample=null,this.lastSample=null}return e.prototype.appendSyncPoint=function(e){e.isSyncPoint=!0,this.syncPoints.push(e)},e}(),a=function(){function e(){this._list=[]}return e.prototype.clear=function(){this._list=[]},e.prototype.appendArray=function(e){var t=this._list;e.length!==0&&(t.length>0&&e[0].originalDts<t[t.length-1].originalDts&&this.clear(),Array.prototype.push.apply(t,e))},e.prototype.getLastSyncPointBeforeDts=function(e){if(this._list.length==0)return null;var t=this._list,n=0,r=t.length-1,i=0,a=0,o=r;for(e<t[0].dts&&(n=0,a=o+1);a<=o;){if((i=a+Math.floor((o-a)/2))===r||e>=t[i].dts&&e<t[i+1].dts){n=i;break}t[i].dts<e?a=i+1:o=i-1}return this._list[n]},e}(),o=function(){function e(e){this._type=e,this._list=[],this._lastAppendLocation=-1}return Object.defineProperty(e.prototype,`type`,{get:function(){return this._type},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`length`,{get:function(){return this._list.length},enumerable:!1,configurable:!0}),e.prototype.isEmpty=function(){return this._list.length===0},e.prototype.clear=function(){this._list=[],this._lastAppendLocation=-1},e.prototype._searchNearestSegmentBefore=function(e){var t=this._list;if(t.length===0)return-2;var n=t.length-1,r=0,i=0,a=n,o=0;if(e<t[0].originalBeginDts)return o=-1;for(;i<=a;){if((r=i+Math.floor((a-i)/2))===n||e>t[r].lastSample.originalDts&&e<t[r+1].originalBeginDts){o=r;break}t[r].originalBeginDts<e?i=r+1:a=r-1}return o},e.prototype._searchNearestSegmentAfter=function(e){return this._searchNearestSegmentBefore(e)+1},e.prototype.append=function(e){var t=this._list,n=e,r=this._lastAppendLocation,i=0;r!==-1&&r<t.length&&n.originalBeginDts>=t[r].lastSample.originalDts&&(r===t.length-1||r<t.length-1&&n.originalBeginDts<t[r+1].originalBeginDts)?i=r+1:t.length>0&&(i=this._searchNearestSegmentBefore(n.originalBeginDts)+1),this._lastAppendLocation=i,this._list.splice(i,0,n)},e.prototype.getLastSegmentBefore=function(e){var t=this._searchNearestSegmentBefore(e);return t>=0?this._list[t]:null},e.prototype.getLastSampleBefore=function(e){var t=this.getLastSegmentBefore(e);return t==null?null:t.lastSample},e.prototype.getLastSyncPointBefore=function(e){for(var t=this._searchNearestSegmentBefore(e),n=this._list[t].syncPoints;n.length===0&&t>0;)t--,n=this._list[t].syncPoints;return n.length>0?n[n.length-1]:null},e}()},function(e,t,n){t.a=function(){function e(){this.mimeType=null,this.duration=null,this.hasAudio=null,this.hasVideo=null,this.audioCodec=null,this.videoCodec=null,this.audioDataRate=null,this.videoDataRate=null,this.audioSampleRate=null,this.audioChannelCount=null,this.width=null,this.height=null,this.fps=null,this.profile=null,this.level=null,this.refFrames=null,this.chromaFormat=null,this.sarNum=null,this.sarDen=null,this.metadata=null,this.segments=null,this.segmentCount=null,this.hasKeyframesIndex=null,this.keyframesIndex=null}return e.prototype.isComplete=function(){var e=!1===this.hasAudio||!0===this.hasAudio&&this.audioCodec!=null&&this.audioSampleRate!=null&&this.audioChannelCount!=null,t=!1===this.hasVideo||!0===this.hasVideo&&this.videoCodec!=null&&this.width!=null&&this.height!=null&&this.fps!=null&&this.profile!=null&&this.level!=null&&this.refFrames!=null&&this.chromaFormat!=null&&this.sarNum!=null&&this.sarDen!=null;return this.mimeType!=null&&e&&t},e.prototype.isSeekable=function(){return!0===this.hasKeyframesIndex},e.prototype.getNearestKeyframe=function(e){if(this.keyframesIndex==null)return null;var t=this.keyframesIndex,n=this._search(t.times,e);return{index:n,milliseconds:t.times[n],fileposition:t.filepositions[n]}},e.prototype._search=function(e,t){var n=0,r=e.length-1,i=0,a=0,o=r;for(t<e[0]&&(n=0,a=o+1);a<=o;){if((i=a+Math.floor((o-a)/2))===r||t>=e[i]&&t<e[i+1]){n=i;break}e[i]<t?a=i+1:o=i-1}return n},e}()},function(e,t,n){var r=n(9),i=n.n(r),a=n(0),o=n(5),s=n(12);function c(e,t,n){var r=e;if(t+n<r.length){for(;n--;)if((192&r[++t])!=128)return!1;return!0}return!1}var l,u=function(e){for(var t=[],n=e,r=0,i=e.length;r<i;)if(n[r]<128)t.push(String.fromCharCode(n[r])),++r;else{if(!(n[r]<192)){if(n[r]<224){if(c(n,r,1)&&(a=(31&n[r])<<6|63&n[r+1])>=128){t.push(String.fromCharCode(65535&a)),r+=2;continue}}else if(n[r]<240){if(c(n,r,2)&&(a=(15&n[r])<<12|(63&n[r+1])<<6|63&n[r+2])>=2048&&(63488&a)!=55296){t.push(String.fromCharCode(65535&a)),r+=3;continue}}else if(n[r]<248){var a;if(c(n,r,3)&&(a=(7&n[r])<<18|(63&n[r+1])<<12|(63&n[r+2])<<6|63&n[r+3])>65536&&a<1114112){a-=65536,t.push(String.fromCharCode(a>>>10|55296)),t.push(String.fromCharCode(1023&a|56320)),r+=4;continue}}}t.push(``),++r}return t.join(``)},d=n(3),f=(l=new ArrayBuffer(2),new DataView(l).setInt16(0,256,!0),new Int16Array(l)[0]===256),p=function(){function e(){}return e.parseScriptData=function(t,n,r){var i={};try{var o=e.parseValue(t,n,r),s=e.parseValue(t,n+o.size,r-o.size);i[o.data]=s.data}catch(e){a.a.e(`AMF`,e.toString())}return i},e.parseObject=function(t,n,r){if(r<3)throw new d.a(`Data not enough when parse ScriptDataObject`);var i=e.parseString(t,n,r),a=e.parseValue(t,n+i.size,r-i.size),o=a.objectEnd;return{data:{name:i.data,value:a.data},size:i.size+a.size,objectEnd:o}},e.parseVariable=function(t,n,r){return e.parseObject(t,n,r)},e.parseString=function(e,t,n){if(n<2)throw new d.a(`Data not enough when parse String`);var r=new DataView(e,t,n).getUint16(0,!f);return{data:r>0?u(new Uint8Array(e,t+2,r)):``,size:2+r}},e.parseLongString=function(e,t,n){if(n<4)throw new d.a(`Data not enough when parse LongString`);var r=new DataView(e,t,n).getUint32(0,!f);return{data:r>0?u(new Uint8Array(e,t+4,r)):``,size:4+r}},e.parseDate=function(e,t,n){if(n<10)throw new d.a(`Data size invalid when parse Date`);var r=new DataView(e,t,n),i=r.getFloat64(0,!f),a=r.getInt16(8,!f);return{data:new Date(i+=60*a*1e3),size:10}},e.parseValue=function(t,n,r){if(r<1)throw new d.a(`Data not enough when parse Value`);var i,o=new DataView(t,n,r),s=1,c=o.getUint8(0),l=!1;try{switch(c){case 0:i=o.getFloat64(1,!f),s+=8;break;case 1:i=!!o.getUint8(1),s+=1;break;case 2:var u=e.parseString(t,n+1,r-1);i=u.data,s+=u.size;break;case 3:i={};var p=0;for((16777215&o.getUint32(r-4,!f))==9&&(p=3);s<r-4;){var m=e.parseObject(t,n+s,r-s-p);if(m.objectEnd)break;i[m.data.name]=m.data.value,s+=m.size}s<=r-3&&(16777215&o.getUint32(s-1,!f))==9&&(s+=3);break;case 8:for(i={},s+=4,p=0,(16777215&o.getUint32(r-4,!f))==9&&(p=3);s<r-8;){var h=e.parseVariable(t,n+s,r-s-p);if(h.objectEnd)break;i[h.data.name]=h.data.value,s+=h.size}s<=r-3&&(16777215&o.getUint32(s-1,!f))==9&&(s+=3);break;case 9:i=void 0,s=1,l=!0;break;case 10:i=[];var g=o.getUint32(1,!f);s+=4;for(var _=0;_<g;_++){var v=e.parseValue(t,n+s,r-s);i.push(v.data),s+=v.size}break;case 11:var y=e.parseDate(t,n+1,r-1);i=y.data,s+=y.size;break;case 12:var b=e.parseString(t,n+1,r-1);i=b.data,s+=b.size;break;default:s=r,a.a.w(`AMF`,`Unsupported AMF value type `+c)}}catch(e){a.a.e(`AMF`,e.toString())}return{data:i,size:s,objectEnd:l}},e}(),m=function(){function e(e){this.TAG=`ExpGolomb`,this._buffer=e,this._buffer_index=0,this._total_bytes=e.byteLength,this._total_bits=8*e.byteLength,this._current_word=0,this._current_word_bits_left=0}return e.prototype.destroy=function(){this._buffer=null},e.prototype._fillCurrentWord=function(){var e=this._total_bytes-this._buffer_index;if(e<=0)throw new d.a(`ExpGolomb: _fillCurrentWord() but no bytes available`);var t=Math.min(4,e),n=new Uint8Array(4);n.set(this._buffer.subarray(this._buffer_index,this._buffer_index+t)),this._current_word=new DataView(n.buffer).getUint32(0,!1),this._buffer_index+=t,this._current_word_bits_left=8*t},e.prototype.readBits=function(e){if(e>32)throw new d.b(`ExpGolomb: readBits() bits exceeded max 32bits!`);if(e<=this._current_word_bits_left){var t=this._current_word>>>32-e;return this._current_word<<=e,this._current_word_bits_left-=e,t}var n=this._current_word_bits_left?this._current_word:0;n>>>=32-this._current_word_bits_left;var r=e-this._current_word_bits_left;this._fillCurrentWord();var i=Math.min(r,this._current_word_bits_left),a=this._current_word>>>32-i;return this._current_word<<=i,this._current_word_bits_left-=i,n=n<<i|a},e.prototype.readBool=function(){return this.readBits(1)===1},e.prototype.readByte=function(){return this.readBits(8)},e.prototype._skipLeadingZero=function(){var e;for(e=0;e<this._current_word_bits_left;e++)if(this._current_word&2147483648>>>e)return this._current_word<<=e,this._current_word_bits_left-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()},e.prototype.readUEG=function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1},e.prototype.readSEG=function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)},e}(),h=function(){function e(){}return e._ebsp2rbsp=function(e){for(var t=e,n=t.byteLength,r=new Uint8Array(n),i=0,a=0;a<n;a++)a>=2&&t[a]===3&&t[a-1]===0&&t[a-2]===0||(r[i]=t[a],i++);return new Uint8Array(r.buffer,0,i)},e.parseSPS=function(t){for(var n=t.subarray(1,4),r=`avc1.`,i=0;i<3;i++){var a=n[i].toString(16);a.length<2&&(a=`0`+a),r+=a}var o=new m(e._ebsp2rbsp(t));o.readByte();var s=o.readByte();o.readByte();var c=o.readByte();o.readUEG();var l=e.getProfileString(s),u=e.getLevelString(c),d=1,f=420,p=8,h=8;if((s===100||s===110||s===122||s===244||s===44||s===83||s===86||s===118||s===128||s===138||s===144)&&((d=o.readUEG())===3&&o.readBits(1),d<=3&&(f=[0,420,422,444][d]),p=o.readUEG()+8,h=o.readUEG()+8,o.readBits(1),o.readBool()))for(var g=d===3?12:8,_=0;_<g;_++)o.readBool()&&(_<6?e._skipScalingList(o,16):e._skipScalingList(o,64));o.readUEG();var v=o.readUEG();if(v===0)o.readUEG();else if(v===1){o.readBits(1),o.readSEG(),o.readSEG();var y=o.readUEG();for(_=0;_<y;_++)o.readSEG()}var b=o.readUEG();o.readBits(1);var x=o.readUEG(),S=o.readUEG(),C=o.readBits(1);C===0&&o.readBits(1),o.readBits(1);var w=0,T=0,E=0,D=0;o.readBool()&&(w=o.readUEG(),T=o.readUEG(),E=o.readUEG(),D=o.readUEG());var O=1,k=1,A=0,j=!0,M=0,N=0;if(o.readBool()){if(o.readBool()){var P=o.readByte();P>0&&P<16?(O=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2][P-1],k=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1][P-1]):P===255&&(O=o.readByte()<<8|o.readByte(),k=o.readByte()<<8|o.readByte())}if(o.readBool()&&o.readBool(),o.readBool()&&(o.readBits(4),o.readBool()&&o.readBits(24)),o.readBool()&&(o.readUEG(),o.readUEG()),o.readBool()){var F=o.readBits(32),I=o.readBits(32);j=o.readBool(),A=(M=I)/(N=2*F)}}var L=1;O===1&&k===1||(L=O/k);var R=0,z=0;d===0?(R=1,z=2-C):(R=d===3?1:2,z=(d===1?2:1)*(2-C));var B=16*(x+1),V=16*(S+1)*(2-C);B-=(w+T)*R,V-=(E+D)*z;var ee=Math.ceil(B*L);return o.destroy(),o=null,{codec_mimetype:r,profile_idc:s,level_idc:c,profile_string:l,level_string:u,chroma_format_idc:d,bit_depth:p,bit_depth_luma:p,bit_depth_chroma:h,ref_frames:b,chroma_format:f,chroma_format_string:e.getChromaFormatString(f),frame_rate:{fixed:j,fps:A,fps_den:N,fps_num:M},sar_ratio:{width:O,height:k},codec_size:{width:B,height:V},present_size:{width:ee,height:V}}},e._skipScalingList=function(e,t){for(var n=8,r=8,i=0;i<t;i++)r!==0&&(r=(n+e.readSEG()+256)%256),n=r===0?n:r},e.getProfileString=function(e){switch(e){case 66:return`Baseline`;case 77:return`Main`;case 88:return`Extended`;case 100:return`High`;case 110:return`High10`;case 122:return`High422`;case 244:return`High444`;default:return`Unknown`}},e.getLevelString=function(e){return(e/10).toFixed(1)},e.getChromaFormatString=function(e){switch(e){case 420:return`4:2:0`;case 422:return`4:2:2`;case 444:return`4:4:4`;default:return`Unknown`}},e}(),g=n(6),_=function(){function e(){}return e._ebsp2rbsp=function(e){for(var t=e,n=t.byteLength,r=new Uint8Array(n),i=0,a=0;a<n;a++)a>=2&&t[a]===3&&t[a-1]===0&&t[a-2]===0||(r[i]=t[a],i++);return new Uint8Array(r.buffer,0,i)},e.parseVPS=function(t){var n=new m(e._ebsp2rbsp(t));return n.readByte(),n.readByte(),n.readBits(4),n.readBits(2),n.readBits(6),{num_temporal_layers:n.readBits(3)+1,temporal_id_nested:n.readBool()}},e.parseSPS=function(t){var n=new m(e._ebsp2rbsp(t));n.readByte(),n.readByte();for(var r=0,i=0,a=0,o=0,s=(n.readBits(4),n.readBits(3)),c=(n.readBool(),n.readBits(2)),l=n.readBool(),u=n.readBits(5),d=n.readByte(),f=n.readByte(),p=n.readByte(),h=n.readByte(),g=n.readByte(),_=n.readByte(),v=n.readByte(),y=n.readByte(),b=n.readByte(),x=n.readByte(),S=n.readByte(),C=[],w=[],T=0;T<s;T++)C.push(n.readBool()),w.push(n.readBool());if(s>0)for(T=s;T<8;T++)n.readBits(2);for(T=0;T<s;T++)C[T]&&(n.readByte(),n.readByte(),n.readByte(),n.readByte(),n.readByte(),n.readByte(),n.readByte(),n.readByte(),n.readByte(),n.readByte(),n.readByte()),w[T]&&n.readByte();n.readUEG();var E=n.readUEG();E==3&&n.readBits(1);var D=n.readUEG(),O=n.readUEG();n.readBool()&&(r+=n.readUEG(),i+=n.readUEG(),a+=n.readUEG(),o+=n.readUEG());var k=n.readUEG(),A=n.readUEG(),j=n.readUEG();for(T=n.readBool()?0:s;T<=s;T++)n.readUEG(),n.readUEG(),n.readUEG();if(n.readUEG(),n.readUEG(),n.readUEG(),n.readUEG(),n.readUEG(),n.readUEG(),n.readBool()&&n.readBool())for(var M=0;M<4;M++)for(var N=0;N<(M===3?2:6);N++)if(n.readBool()){var P=Math.min(64,1<<4+(M<<1));for(M>1&&n.readSEG(),T=0;T<P;T++)n.readSEG()}else n.readUEG();n.readBool(),n.readBool(),n.readBool()&&(n.readByte(),n.readUEG(),n.readUEG(),n.readBool());var F=n.readUEG(),I=0;for(T=0;T<F;T++){var L=!1;if(T!==0&&(L=n.readBool()),L){T===F&&n.readUEG(),n.readBool(),n.readUEG();for(var R=0,z=0;z<=I;z++){var B=n.readBool(),V=!1;B||(V=n.readBool()),(B||V)&&R++}I=R}else{var ee=n.readUEG(),H=n.readUEG();for(I=ee+H,z=0;z<ee;z++)n.readUEG(),n.readBool();for(z=0;z<H;z++)n.readUEG(),n.readBool()}}if(n.readBool()){var te=n.readUEG();for(T=0;T<te;T++){for(z=0;z<j+4;z++)n.readBits(1);n.readBits(1)}}var ne=0,re=1,ie=1,ae=!1,oe=1,se=1;if(n.readBool(),n.readBool(),n.readBool()){if(n.readBool()){var U=n.readByte();U>0&&U<=16?(re=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2][U-1],ie=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1][U-1]):U===255&&(re=n.readBits(16),ie=n.readBits(16))}if(n.readBool()&&n.readBool(),n.readBool()&&(n.readBits(3),n.readBool(),n.readBool()&&(n.readByte(),n.readByte(),n.readByte())),n.readBool()&&(n.readUEG(),n.readUEG()),n.readBool(),n.readBool(),n.readBool(),n.readBool()&&(n.readUEG(),n.readUEG(),n.readUEG(),n.readUEG()),n.readBool()&&(oe=n.readBits(32),se=n.readBits(32),n.readBool()&&n.readUEG(),n.readBool())){var ce=!1,W=!1,le=!1;for(ce=n.readBool(),W=n.readBool(),(ce||W)&&((le=n.readBool())&&(n.readByte(),n.readBits(5),n.readBool(),n.readBits(5)),n.readBits(4),n.readBits(4),le&&n.readBits(4),n.readBits(5),n.readBits(5),n.readBits(5)),T=0;T<=s;T++){var G=n.readBool();ae=G;var ue=!0,K=1;G||(ue=n.readBool());var de=!1;if(ue?n.readUEG():de=n.readBool(),de||(K=n.readUEG()+1),ce){for(z=0;z<K;z++)n.readUEG(),n.readUEG(),le&&(n.readUEG(),n.readUEG());n.readBool()}if(W){for(z=0;z<K;z++)n.readUEG(),n.readUEG(),le&&(n.readUEG(),n.readUEG());n.readBool()}}}n.readBool()&&(n.readBool(),n.readBool(),n.readBool(),ne=n.readUEG(),n.readUEG(),n.readUEG(),n.readUEG(),n.readUEG())}n.readBool();var fe=`hvc1.${u}.1.L${S}.B0`,pe=D-(r+i)*(E===1||E===2?2:1),me=O-(a+o)*(E===1?2:1),he=1;return re!==1&&ie!==1&&(he=re/ie),n.destroy(),n=null,{codec_mimetype:fe,profile_string:e.getProfileString(u),level_string:e.getLevelString(S),profile_idc:u,bit_depth:k+8,ref_frames:1,chroma_format:E,chroma_format_string:e.getChromaFormatString(E),general_level_idc:S,general_profile_space:c,general_tier_flag:l,general_profile_idc:u,general_profile_compatibility_flags_1:d,general_profile_compatibility_flags_2:f,general_profile_compatibility_flags_3:p,general_profile_compatibility_flags_4:h,general_constraint_indicator_flags_1:g,general_constraint_indicator_flags_2:_,general_constraint_indicator_flags_3:v,general_constraint_indicator_flags_4:y,general_constraint_indicator_flags_5:b,general_constraint_indicator_flags_6:x,min_spatial_segmentation_idc:ne,constant_frame_rate:0,chroma_format_idc:E,bit_depth_luma_minus8:k,bit_depth_chroma_minus8:A,frame_rate:{fixed:ae,fps:se/oe,fps_den:oe,fps_num:se},sar_ratio:{width:re,height:ie},codec_size:{width:pe,height:me},present_size:{width:pe*he,height:me}}},e.parsePPS=function(t){var n=new m(e._ebsp2rbsp(t));n.readByte(),n.readByte(),n.readUEG(),n.readUEG(),n.readBool(),n.readBool(),n.readBits(3),n.readBool(),n.readBool(),n.readUEG(),n.readUEG(),n.readSEG(),n.readBool(),n.readBool(),n.readBool()&&n.readUEG(),n.readSEG(),n.readSEG(),n.readBool(),n.readBool(),n.readBool(),n.readBool();var r=n.readBool(),i=n.readBool(),a=1;return i&&r?a=0:i?a=3:r&&(a=2),{parallelismType:a}},e.getChromaFormatString=function(e){switch(e){case 0:return`4:0:0`;case 1:return`4:2:0`;case 2:return`4:2:2`;case 3:return`4:4:4`;default:return`Unknown`}},e.getProfileString=function(e){switch(e){case 1:return`Main`;case 2:return`Main10`;case 3:return`MainSP`;case 4:return`Rext`;case 9:return`SCC`;default:return`Unknown`}},e.getLevelString=function(e){return(e/30).toFixed(1)},e}();function v(e){return e.byteOffset%2==0&&e.byteLength%2==0}function y(e){return e.byteOffset%4==0&&e.byteLength%4==0}function b(e,t){for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}var x=function(e,t){return e.byteLength===t.byteLength&&(y(e)&&y(t)?function(e,t){return b(new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4),new Uint32Array(t.buffer,t.byteOffset,t.byteLength/4))}(e,t):v(e)&&v(t)?function(e,t){return b(new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2),new Uint16Array(t.buffer,t.byteOffset,t.byteLength/2))}(e,t):function(e,t){return b(e,t)}(e,t))},S=function(){return(S=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},C=function(){function e(){}return e.parseOBUs=function(t,n){for(var r=0;r<t.byteLength;){var i=r,a=(t[r],(120&t[r])>>3),o=(4&t[r])!=0,s=(2&t[r])!=0;t[r],r+=1,o&&(r+=1);var c=1/0;if(s){c=0;for(var l=0;;l++){var u=t[r++];if(c|=(127&u)<<7*l,!(128&u))break}}console.log(a),a===1?n=S(S({},e.parseSeuqneceHeader(t.subarray(r,r+c))),{sequence_header_data:t.subarray(i,r+c)}):(a==3&&n||a==6&&n)&&(n=e.parseOBUFrameHeader(t.subarray(r,r+c),0,0,n)),r+=c}return n},e.parseSeuqneceHeader=function(t){var n=new m(t),r=n.readBits(3),i=(n.readBool(),n.readBool()),a=!0,o=0,s=1,c=void 0,l=[];if(i)l.push({operating_point_idc:0,level:n.readBits(5),tier:0});else{if(n.readBool()){var u=n.readBits(32),d=n.readBits(32),f=n.readBool();if(f){for(var p=0;n.readBits(1)===0;)p+=1;p>=32||(1<<p)-1+n.readBits(p)}(o=d)/(s=u),a=f,n.readBool()&&(n.readBits(5),n.readBits(32),c=n.readBits(5),n.readBits(5))}for(var h=n.readBool(),g=n.readBits(5),_=0;_<=g;_++){var v=n.readBits(12),y=n.readBits(5),b=y>7?n.readBits(1):0;l.push({operating_point_idc:v,level:y,tier:b}),h&&n.readBool()&&n.readBits(4)}}var x=l[0],S=x.level,C=x.tier,w=n.readBits(4),T=n.readBits(4),E=n.readBits(w+1)+1,D=n.readBits(T+1)+1,O=!1;i||(O=n.readBool()),O&&(n.readBits(4),n.readBits(4)),n.readBool(),n.readBool(),n.readBool();var k=!1,A=2,j=2,M=0;i||(n.readBool(),n.readBool(),n.readBool(),n.readBool(),(k=n.readBool())&&(n.readBool(),n.readBool()),j=(A=n.readBool()?2:n.readBits(1))?n.readBool()?2:n.readBits(1):2,M=k?n.readBits(3)+1:0);var N=n.readBool(),P=(n.readBool(),n.readBool(),n.readBool()),F=8;F=r===2&&P?n.readBool()?12:10:P?10:8;var I=!1;r!==1&&(I=n.readBool()),n.readBool()&&(n.readBits(8),n.readBits(8),n.readBits(8));var L=1,R=1;return I?(n.readBits(1),L=1,R=1):(n.readBits(1),r==0?(L=1,R=1):r==1?(L=0,R=0):F==12?n.readBits(1)&&n.readBits(1):(L=1,R=0),L&&R&&n.readBits(2),n.readBits(1)),n.readBool(),n.destroy(),n=null,{codec_mimetype:`av01.${r}.${e.getLevelString(S,C)}.${F.toString(10).padStart(2,`0`)}`,level:S,tier:C,level_string:e.getLevelString(S,C),profile_idc:r,profile_string:`${r}`,bit_depth:F,ref_frames:1,chroma_format:e.getChromaFormat(I,L,R),chroma_format_string:e.getChromaFormatString(I,L,R),sequence_header:{frame_id_numbers_present_flag:O,additional_frame_id_length_minus_1:void 0,delta_frame_id_length_minus_2:void 0,reduced_still_picture_header:i,decoder_model_info_present_flag:!1,operating_points:l,buffer_removal_time_length_minus_1:c,equal_picture_interval:a,seq_force_screen_content_tools:A,seq_force_integer_mv:j,enable_order_hint:k,order_hint_bits:M,enable_superres:N,frame_width_bit:w+1,frame_height_bit:T+1,max_frame_width:E,max_frame_height:D},keyframe:void 0,frame_rate:{fixed:a,fps:o/s,fps_den:s,fps_num:o}}},e.parseOBUFrameHeader=function(t,n,r,i){var a=i.sequence_header,o=new m(t),s=(a.max_frame_width,a.max_frame_height,0);a.frame_id_numbers_present_flag&&(s=a.additional_frame_id_length_minus_1+a.delta_frame_id_length_minus_2+3);var c=0,l=!0,u=!0,d=!1;if(!a.reduced_still_picture_header){if(o.readBool())return i;l=(c=o.readBits(2))===2||c===0,(u=o.readBool())&&a.decoder_model_info_present_flag&&a.equal_picture_interval,u&&o.readBool(),d=!!(c===3||c===0&&u)||o.readBool()}i.keyframe=l,o.readBool();var f=a.seq_force_screen_content_tools;a.seq_force_screen_content_tools===2&&(f=o.readBits(1)),f&&(a.seq_force_integer_mv,a.seq_force_integer_mv==2&&o.readBits(1)),a.frame_id_numbers_present_flag&&o.readBits(s);var p=!1;if(p=c==3||!a.reduced_still_picture_header&&o.readBool(),o.readBits(a.order_hint_bits),(l||d||o.readBits(3),a.decoder_model_info_present_flag)&&o.readBool()){for(var h=0;h<=a.operating_points_cnt_minus_1;h++)if(a.operating_points[h].decoder_model_present_for_this_op[h]){var g=a.operating_points[h].operating_point_idc;(g===0||g>>n&1&&g>>r+8&1)&&o.readBits(a.buffer_removal_time_length_minus_1+1)}}var _=255;if(c===3||c==0&&u||(_=o.readBits(8)),(l||_!==255)&&d&&a.enable_order_hint)for(var v=0;v<8;v++)o.readBits(a.order_hint_bits);if(l){var y=e.frameSizeAndRenderSize(o,p,a);i.codec_size={width:y.FrameWidth,height:y.FrameHeight},i.present_size={width:y.RenderWidth,height:y.RenderHeight},i.sar_ratio={width:y.RenderWidth/y.FrameWidth,height:y.RenderHeight/y.FrameHeight}}return o.destroy(),o=null,i},e.frameSizeAndRenderSize=function(e,t,n){var r=n.max_frame_width,i=n.max_frame_height;t&&(r=e.readBits(n.frame_width_bit)+1,i=e.readBits(n.frame_height_bit)+1);var a=!1;n.enable_superres&&(a=e.readBool());var o=8;a&&(o=e.readBits(3)+9);var s=r;r=Math.floor((8*s+o/2)/o);var c=s,l=i;if(e.readBool()){var u=e.readBits(16)+1,d=e.readBits(16)+1;c=e.readBits(u)+1,l=e.readBits(d)+1}return{UpscaledWidth:s,FrameWidth:r,FrameHeight:i,RenderWidth:c,RenderHeight:l}},e.getLevelString=function(e,t){return`${e.toString(10).padStart(2,`0`)}${t===0?`M`:`H`}`},e.getChromaFormat=function(e,t,n){return e?0:t===0&&n===0?3:t===1&&n===0?2:t===1&&n===1?1:NaN},e.getChromaFormatString=function(e,t,n){return e?`4:0:0`:t===0&&n===0?`4:4:4`:t===1&&n===0?`4:2:2`:t===1&&n===1?`4:2:0`:`Unknown`},e}(),w,T=function(){function e(e,t){this.TAG=`FLVDemuxer`,this._config=t,this._onError=null,this._onMediaInfo=null,this._onMetaDataArrived=null,this._onScriptDataArrived=null,this._onTrackMetadata=null,this._onDataAvailable=null,this._dataOffset=e.dataOffset,this._firstParse=!0,this._dispatch=!1,this._hasAudio=e.hasAudioTrack,this._hasVideo=e.hasVideoTrack,this._hasAudioFlagOverrided=!1,this._hasVideoFlagOverrided=!1,this._audioInitialMetadataDispatched=!1,this._videoInitialMetadataDispatched=!1,this._mediaInfo=new s.a,this._mediaInfo.hasAudio=this._hasAudio,this._mediaInfo.hasVideo=this._hasVideo,this._metadata=null,this._audioMetadata=null,this._videoMetadata=null,this._naluLengthSize=4,this._timestampBase=0,this._timescale=1e3,this._duration=0,this._durationOverrided=!1,this._referenceFrameRate={fixed:!0,fps:23.976,fps_num:23976,fps_den:1e3},this._flvSoundRateTable=[5500,11025,22050,44100,48e3],this._mpegSamplingRates=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],this._mpegAudioV10SampleRateTable=[44100,48e3,32e3,0],this._mpegAudioV20SampleRateTable=[22050,24e3,16e3,0],this._mpegAudioV25SampleRateTable=[11025,12e3,8e3,0],this._mpegAudioL1BitRateTable=[0,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1],this._mpegAudioL2BitRateTable=[0,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1],this._mpegAudioL3BitRateTable=[0,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1],this._videoTrack={type:`video`,id:1,sequenceNumber:0,samples:[],length:0},this._audioTrack={type:`audio`,id:2,sequenceNumber:0,samples:[],length:0},this._littleEndian=function(){var e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),new Int16Array(e)[0]===256}()}return e.prototype.destroy=function(){this._mediaInfo=null,this._metadata=null,this._audioMetadata=null,this._videoMetadata=null,this._videoTrack=null,this._audioTrack=null,this._onError=null,this._onMediaInfo=null,this._onMetaDataArrived=null,this._onScriptDataArrived=null,this._onTrackMetadata=null,this._onDataAvailable=null},e.probe=function(e){var t=new Uint8Array(e);if(t.byteLength<9)return{needMoreData:!0};var n={match:!1};if(t[0]!==70||t[1]!==76||t[2]!==86||t[3]!==1)return n;var r,i,a=(4&t[4])>>>2!=0,o=(1&t[4])!=0,s=(r=t)[i=5]<<24|r[i+1]<<16|r[i+2]<<8|r[i+3];return s<9?n:{match:!0,consumed:s,dataOffset:s,hasAudioTrack:a,hasVideoTrack:o}},e.prototype.bindDataSource=function(e){return e.onDataArrival=this.parseChunks.bind(this),this},Object.defineProperty(e.prototype,`onTrackMetadata`,{get:function(){return this._onTrackMetadata},set:function(e){this._onTrackMetadata=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`onMediaInfo`,{get:function(){return this._onMediaInfo},set:function(e){this._onMediaInfo=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`onMetaDataArrived`,{get:function(){return this._onMetaDataArrived},set:function(e){this._onMetaDataArrived=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`onScriptDataArrived`,{get:function(){return this._onScriptDataArrived},set:function(e){this._onScriptDataArrived=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`onError`,{get:function(){return this._onError},set:function(e){this._onError=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`onDataAvailable`,{get:function(){return this._onDataAvailable},set:function(e){this._onDataAvailable=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`timestampBase`,{get:function(){return this._timestampBase},set:function(e){this._timestampBase=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`overridedDuration`,{get:function(){return this._duration},set:function(e){this._durationOverrided=!0,this._duration=e,this._mediaInfo.duration=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`overridedHasAudio`,{set:function(e){this._hasAudioFlagOverrided=!0,this._hasAudio=e,this._mediaInfo.hasAudio=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`overridedHasVideo`,{set:function(e){this._hasVideoFlagOverrided=!0,this._hasVideo=e,this._mediaInfo.hasVideo=e},enumerable:!1,configurable:!0}),e.prototype.resetMediaInfo=function(){this._mediaInfo=new s.a},e.prototype._isInitialMetadataDispatched=function(){return this._hasAudio&&this._hasVideo?this._audioInitialMetadataDispatched&&this._videoInitialMetadataDispatched:this._hasAudio&&!this._hasVideo?this._audioInitialMetadataDispatched:!(this._hasAudio||!this._hasVideo)&&this._videoInitialMetadataDispatched},e.prototype.parseChunks=function(t,n){if(!(this._onError&&this._onMediaInfo&&this._onTrackMetadata&&this._onDataAvailable))throw new d.a(`Flv: onError & onMediaInfo & onTrackMetadata & onDataAvailable callback must be specified`);var r=0,i=this._littleEndian;if(n===0){if(!(t.byteLength>13))return 0;r=e.probe(t).dataOffset}for(this._firstParse&&(this._firstParse=!1,n+r!==this._dataOffset&&a.a.w(this.TAG,`First time parsing but chunk byteStart invalid!`),(o=new DataView(t,r)).getUint32(0,!i)!==0&&a.a.w(this.TAG,`PrevTagSize0 !== 0 !!!`),r+=4);r<t.byteLength;){this._dispatch=!0;var o=new DataView(t,r);if(r+11+4>t.byteLength)break;var s=o.getUint8(0),c=16777215&o.getUint32(0,!i);if(r+11+c+4>t.byteLength)break;if(s===8||s===9||s===18){var l=o.getUint8(4),u=o.getUint8(5),f=o.getUint8(6)|u<<8|l<<16|o.getUint8(7)<<24;16777215&o.getUint32(7,!i)&&a.a.w(this.TAG,`Meet tag which has StreamID != 0!`);var p=r+11;switch(s){case 8:this._parseAudioData(t,p,c,f);break;case 9:this._parseVideoData(t,p,c,f,n+r);break;case 18:this._parseScriptData(t,p,c)}var m=o.getUint32(11+c,!i);m!==11+c&&a.a.w(this.TAG,`Invalid PrevTagSize ${m}`),r+=11+c+4}else a.a.w(this.TAG,`Unsupported tag type ${s}, skipped`),r+=11+c+4}return this._isInitialMetadataDispatched()&&this._dispatch&&(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack),r},e.prototype._parseScriptData=function(e,t,n){var r=p.parseScriptData(e,t,n);if(r.hasOwnProperty(`onMetaData`)){if(r.onMetaData==null||typeof r.onMetaData!=`object`)return void a.a.w(this.TAG,`Invalid onMetaData structure!`);this._metadata&&a.a.w(this.TAG,`Found another onMetaData tag!`),this._metadata=r;var i=this._metadata.onMetaData;if(this._onMetaDataArrived&&this._onMetaDataArrived(Object.assign({},i)),typeof i.hasAudio==`boolean`&&!1===this._hasAudioFlagOverrided&&(this._hasAudio=i.hasAudio,this._mediaInfo.hasAudio=this._hasAudio),typeof i.hasVideo==`boolean`&&!1===this._hasVideoFlagOverrided&&(this._hasVideo=i.hasVideo,this._mediaInfo.hasVideo=this._hasVideo),typeof i.audiodatarate==`number`&&(this._mediaInfo.audioDataRate=i.audiodatarate),typeof i.videodatarate==`number`&&(this._mediaInfo.videoDataRate=i.videodatarate),typeof i.width==`number`&&(this._mediaInfo.width=i.width),typeof i.height==`number`&&(this._mediaInfo.height=i.height),typeof i.duration==`number`){if(!this._durationOverrided){var o=Math.floor(i.duration*this._timescale);this._duration=o,this._mediaInfo.duration=o}}else this._mediaInfo.duration=0;if(typeof i.framerate==`number`){var s=Math.floor(1e3*i.framerate);if(s>0){var c=s/1e3;this._referenceFrameRate.fixed=!0,this._referenceFrameRate.fps=c,this._referenceFrameRate.fps_num=s,this._referenceFrameRate.fps_den=1e3,this._mediaInfo.fps=c}}if(typeof i.keyframes==`object`){this._mediaInfo.hasKeyframesIndex=!0;var l=i.keyframes;this._mediaInfo.keyframesIndex=this._parseKeyframesIndex(l),i.keyframes=null}else this._mediaInfo.hasKeyframesIndex=!1;this._dispatch=!1,this._mediaInfo.metadata=i,a.a.v(this.TAG,`Parsed onMetaData`),this._mediaInfo.isComplete()&&this._onMediaInfo(this._mediaInfo)}Object.keys(r).length>0&&this._onScriptDataArrived&&this._onScriptDataArrived(Object.assign({},r))},e.prototype._parseKeyframesIndex=function(e){for(var t=[],n=[],r=1;r<e.times.length;r++){var i=this._timestampBase+Math.floor(1e3*e.times[r]);t.push(i),n.push(e.filepositions[r])}return{times:t,filepositions:n}},e.prototype._parseAudioData=function(e,t,n,r){if(n<=1)a.a.w(this.TAG,`Flv: Invalid audio packet, missing SoundData payload!`);else if(!0!==this._hasAudioFlagOverrided||!1!==this._hasAudio){this._littleEndian;var i=new DataView(e,t,n).getUint8(0),o=i>>>4;if(o!==9)if(o===2||o===10){var s=0,c=(12&i)>>>2;if(c>=0&&c<=4){s=this._flvSoundRateTable[c];var l=1&i,u=this._audioMetadata,d=this._audioTrack;if(u||(!1===this._hasAudio&&!1===this._hasAudioFlagOverrided&&(this._hasAudio=!0,this._mediaInfo.hasAudio=!0),(u=this._audioMetadata={}).type=`audio`,u.id=d.id,u.timescale=this._timescale,u.duration=this._duration,u.audioSampleRate=s,u.channelCount=l===0?1:2),o===10){var f=this._parseAACAudioData(e,t+1,n-1);if(f==null)return;if(f.packetType===0){if(u.config){if(x(f.data.config,u.config))return;a.a.w(this.TAG,`AudioSpecificConfig has been changed, re-generate initialization segment`)}var p=f.data;u.audioSampleRate=p.samplingRate,u.channelCount=p.channelCount,u.codec=p.codec,u.originalCodec=p.originalCodec,u.config=p.config,u.refSampleDuration=1024/u.audioSampleRate*u.timescale,a.a.v(this.TAG,`Parsed AudioSpecificConfig`),this._isInitialMetadataDispatched()?this._dispatch&&(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack):this._audioInitialMetadataDispatched=!0,this._dispatch=!1,this._onTrackMetadata(`audio`,u),(_=this._mediaInfo).audioCodec=u.originalCodec,_.audioSampleRate=u.audioSampleRate,_.audioChannelCount=u.channelCount,_.hasVideo?_.videoCodec!=null&&(_.mimeType=`video/x-flv; codecs="`+_.videoCodec+`,`+_.audioCodec+`"`):_.mimeType=`video/x-flv; codecs="`+_.audioCodec+`"`,_.isComplete()&&this._onMediaInfo(_)}else if(f.packetType===1){var m=this._timestampBase+r,h={unit:f.data,length:f.data.byteLength,dts:m,pts:m};d.samples.push(h),d.length+=f.data.length}else a.a.e(this.TAG,`Flv: Unsupported AAC data type ${f.packetType}`)}else if(o===2){if(!u.codec){var _;if((p=this._parseMP3AudioData(e,t+1,n-1,!0))==null)return;u.audioSampleRate=p.samplingRate,u.channelCount=p.channelCount,u.codec=p.codec,u.originalCodec=p.originalCodec,u.refSampleDuration=1152/u.audioSampleRate*u.timescale,a.a.v(this.TAG,`Parsed MPEG Audio Frame Header`),this._audioInitialMetadataDispatched=!0,this._onTrackMetadata(`audio`,u),(_=this._mediaInfo).audioCodec=u.codec,_.audioSampleRate=u.audioSampleRate,_.audioChannelCount=u.channelCount,_.audioDataRate=p.bitRate,_.hasVideo?_.videoCodec!=null&&(_.mimeType=`video/x-flv; codecs="`+_.videoCodec+`,`+_.audioCodec+`"`):_.mimeType=`video/x-flv; codecs="`+_.audioCodec+`"`,_.isComplete()&&this._onMediaInfo(_)}var v=this._parseMP3AudioData(e,t+1,n-1,!1);if(v==null)return;m=this._timestampBase+r;var y={unit:v,length:v.byteLength,dts:m,pts:m};d.samples.push(y),d.length+=v.length}}else this._onError(g.a.FORMAT_ERROR,`Flv: Invalid audio sample rate idx: `+c)}else this._onError(g.a.CODEC_UNSUPPORTED,`Flv: Unsupported audio codec idx: `+o);else{if(n<=5)return void a.a.w(this.TAG,`Flv: Invalid audio packet, missing AudioFourCC in Ehnanced FLV payload!`);var b=15&i,S=String.fromCharCode.apply(String,new Uint8Array(e,t,n).slice(1,5));switch(S){case`Opus`:this._parseOpusAudioPacket(e,t+5,n-5,r,b);break;case`fLaC`:this._parseFlacAudioPacket(e,t+5,n-5,r,b);break;default:this._onError(g.a.CODEC_UNSUPPORTED,`Flv: Unsupported audio codec: `+S)}}}},e.prototype._parseAACAudioData=function(e,t,n){if(!(n<=1)){var r={},i=new Uint8Array(e,t,n);return r.packetType=i[0],i[0]===0?r.data=this._parseAACAudioSpecificConfig(e,t+1,n-1):r.data=i.subarray(1),r}a.a.w(this.TAG,`Flv: Invalid AAC packet, missing AACPacketType or/and Data!`)},e.prototype._parseAACAudioSpecificConfig=function(e,t,n){var r,i,a=new Uint8Array(e,t,n),o=null,s=0,c=null;if(s=r=a[0]>>>3,(i=(7&a[0])<<1|a[1]>>>7)<0||i>=this._mpegSamplingRates.length)this._onError(g.a.FORMAT_ERROR,`Flv: AAC invalid sampling frequency index!`);else{var l=this._mpegSamplingRates[i],u=(120&a[1])>>>3;if(!(u<0||u>=8)){s===5&&(c=(7&a[1])<<1|a[2]>>>7,(124&a[2])>>>2);var d=self.navigator.userAgent.toLowerCase();return d.indexOf(`firefox`)===-1?d.indexOf(`android`)===-1?(s=5,c=i,o=[,,,,],i>=6?c=i-3:u===1&&(s=2,o=[,,],c=i)):(s=2,o=[,,],c=i):i>=6?(s=5,o=[,,,,],c=i-3):(s=2,o=[,,],c=i),o[0]=s<<3,o[0]|=(15&i)>>>1,o[1]=(15&i)<<7,o[1]|=(15&u)<<3,s===5&&(o[1]|=(15&c)>>>1,o[2]=(1&c)<<7,o[2]|=8,o[3]=0),{config:o,samplingRate:l,channelCount:u,codec:`mp4a.40.`+s,originalCodec:`mp4a.40.`+r}}this._onError(g.a.FORMAT_ERROR,`Flv: AAC invalid channel configuration`)}},e.prototype._parseMP3AudioData=function(e,t,n,r){if(!(n<4)){this._littleEndian;var i=new Uint8Array(e,t,n),o=null;if(r){if(i[0]!==255)return;var s=i[1]>>>3&3,c=(6&i[1])>>1,l=(240&i[2])>>>4,u=(12&i[2])>>>2,d=(i[3]>>>6&3)==3?1:2,f=0,p=0;switch(s){case 0:f=this._mpegAudioV25SampleRateTable[u];break;case 2:f=this._mpegAudioV20SampleRateTable[u];break;case 3:f=this._mpegAudioV10SampleRateTable[u]}switch(c){case 1:l<this._mpegAudioL3BitRateTable.length&&(p=this._mpegAudioL3BitRateTable[l]);break;case 2:l<this._mpegAudioL2BitRateTable.length&&(p=this._mpegAudioL2BitRateTable[l]);break;case 3:l<this._mpegAudioL1BitRateTable.length&&(p=this._mpegAudioL1BitRateTable[l])}o={bitRate:p,samplingRate:f,channelCount:d,codec:`mp3`,originalCodec:`mp3`}}else o=i;return o}a.a.w(this.TAG,`Flv: Invalid MP3 packet, header missing!`)},e.prototype._parseOpusAudioPacket=function(e,t,n,r,i){if(i===0)this._parseOpusSequenceHeader(e,t,n);else if(i===1)this._parseOpusAudioData(e,t,n,r);else if(i!==2)return void this._onError(g.a.FORMAT_ERROR,`Flv: Invalid video packet type ${i}`)},e.prototype._parseOpusSequenceHeader=function(e,t,n){if(n<=16)a.a.w(this.TAG,`Flv: Invalid OpusSequenceHeader, lack of data!`);else{var r=this._audioMetadata,i=this._audioTrack;r||(!1===this._hasAudio&&!1===this._hasAudioFlagOverrided&&(this._hasAudio=!0,this._mediaInfo.hasAudio=!0),(r=this._audioMetadata={}).type=`audio`,r.id=i.id,r.timescale=this._timescale,r.duration=this._duration);var o=new DataView(e,t,n);o.setUint8(8,0);var s=o.getUint8(9);o.setUint16(10,o.getUint16(10,!0),!1);var c=o.getUint32(12,!0);o.setUint32(12,o.getUint32(12,!0),!1);var l={config:new Uint8Array(e,t+8,n-8),channelCount:s,samplingFrequence:c,codec:`opus`,originalCodec:`opus`};if(r.config){if(x(l.config,r.config))return;a.a.w(this.TAG,`OpusSequenceHeader has been changed, re-generate initialization segment`)}r.audioSampleRate=l.samplingFrequence,r.channelCount=l.channelCount,r.codec=l.codec,r.originalCodec=l.originalCodec,r.config=l.config,r.refSampleDuration=20,a.a.v(this.TAG,`Parsed OpusSequenceHeader`),this._isInitialMetadataDispatched()?this._dispatch&&(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack):this._audioInitialMetadataDispatched=!0,this._dispatch=!1,this._onTrackMetadata(`audio`,r);var u=this._mediaInfo;u.audioCodec=r.originalCodec,u.audioSampleRate=r.audioSampleRate,u.audioChannelCount=r.channelCount,u.hasVideo?u.videoCodec!=null&&(u.mimeType=`video/x-flv; codecs="`+u.videoCodec+`,`+u.audioCodec+`"`):u.mimeType=`video/x-flv; codecs="`+u.audioCodec+`"`,u.isComplete()&&this._onMediaInfo(u)}},e.prototype._parseOpusAudioData=function(e,t,n,r){var i=this._audioTrack,a=new Uint8Array(e,t,n),o=this._timestampBase+r,s={unit:a,length:a.byteLength,dts:o,pts:o};i.samples.push(s),i.length+=a.length},e.prototype._parseFlacAudioPacket=function(e,t,n,r,i){if(i===0)this._parseFlacSequenceHeader(e,t,n);else if(i===1)this._parseFlacAudioData(e,t,n,r);else if(i!==2)return void this._onError(g.a.FORMAT_ERROR,`Flv: Invalid Flac audio packet type ${i}`)},e.prototype._parseFlacSequenceHeader=function(e,t,n){var r=this._audioMetadata,i=this._audioTrack;r||(!1===this._hasAudio&&!1===this._hasAudioFlagOverrided&&(this._hasAudio=!0,this._mediaInfo.hasAudio=!0),(r=this._audioMetadata={}).type=`audio`,r.id=i.id,r.timescale=this._timescale,r.duration=this._duration);var o=new Uint8Array(e,t+4,n-4),s=new m(o),c=s.readBits(16),l=s.readBits(16),u=l===c?l:null;s.readBits(24),s.readBits(24);var d=s.readBits(20),f=s.readBits(3)+1,p=s.readBits(5)+1;s.destroy();var h=new Uint8Array(o.byteLength+4);h.set(o,4),h[0]=128,h[1]=o.byteLength>>>16&255,h[2]=o.byteLength>>>8&255,h[3]=o.byteLength>>>0&255;var g={config:h,channelCount:f,samplingFrequence:d,sampleSize:p,codec:`flac`,originalCodec:`flac`};if(r.config){if(x(g.config,r.config))return;a.a.w(this.TAG,`FlacSequenceHeader has been changed, re-generate initialization segment`)}r.audioSampleRate=g.samplingFrequence,r.channelCount=g.channelCount,r.sampleSize=g.sampleSize,r.codec=g.codec,r.originalCodec=g.originalCodec,r.config=g.config,r.refSampleDuration=u==null?null:1e3*u/g.samplingFrequence,a.a.v(this.TAG,`Parsed FlacSequenceHeader`),this._isInitialMetadataDispatched()?this._dispatch&&(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack):this._audioInitialMetadataDispatched=!0,this._dispatch=!1,this._onTrackMetadata(`audio`,r);var _=this._mediaInfo;_.audioCodec=r.originalCodec,_.audioSampleRate=r.audioSampleRate,_.audioChannelCount=r.channelCount,_.hasVideo?_.videoCodec!=null&&(_.mimeType=`video/x-flv; codecs="`+_.videoCodec+`,`+_.audioCodec+`"`):_.mimeType=`video/x-flv; codecs="`+_.audioCodec+`"`,_.isComplete()&&this._onMediaInfo(_)},e.prototype._parseFlacAudioData=function(e,t,n,r){var i=this._audioTrack,a=new Uint8Array(e,t,n),o=this._timestampBase+r,s={unit:a,length:a.byteLength,dts:o,pts:o};i.samples.push(s),i.length+=a.length},e.prototype._parseVideoData=function(e,t,n,r,i){if(n<=1)a.a.w(this.TAG,`Flv: Invalid video packet, missing VideoData payload!`);else if(!0!==this._hasVideoFlagOverrided||!1!==this._hasVideo){var o=new Uint8Array(e,t,n)[0],s=(112&o)>>>4;if(128&o){var c=15&o,l=String.fromCharCode.apply(String,new Uint8Array(e,t,n).slice(1,5));if(l===`hvc1`)this._parseEnhancedHEVCVideoPacket(e,t+5,n-5,r,i,s,c);else{if(l!==`av01`)return void this._onError(g.a.CODEC_UNSUPPORTED,`Flv: Unsupported codec in video frame: ${l}`);this._parseEnhancedAV1VideoPacket(e,t+5,n-5,r,i,s,c)}}else{var u=15&o;if(u===7)this._parseAVCVideoPacket(e,t+1,n-1,r,i,s);else{if(u!==12)return void this._onError(g.a.CODEC_UNSUPPORTED,`Flv: Unsupported codec in video frame: ${u}`);this._parseHEVCVideoPacket(e,t+1,n-1,r,i,s)}}}},e.prototype._parseAVCVideoPacket=function(e,t,n,r,i,o){if(n<4)a.a.w(this.TAG,`Flv: Invalid AVC packet, missing AVCPacketType or/and CompositionTime`);else{var s=this._littleEndian,c=new DataView(e,t,n),l=c.getUint8(0),u=(16777215&c.getUint32(0,!s))<<8>>8;if(l===0)this._parseAVCDecoderConfigurationRecord(e,t+4,n-4);else if(l===1)this._parseAVCVideoData(e,t+4,n-4,r,i,o,u);else if(l!==2)return void this._onError(g.a.FORMAT_ERROR,`Flv: Invalid video packet type ${l}`)}},e.prototype._parseHEVCVideoPacket=function(e,t,n,r,i,o){if(n<4)a.a.w(this.TAG,`Flv: Invalid HEVC packet, missing HEVCPacketType or/and CompositionTime`);else{var s=this._littleEndian,c=new DataView(e,t,n),l=c.getUint8(0),u=(16777215&c.getUint32(0,!s))<<8>>8;if(l===0)this._parseHEVCDecoderConfigurationRecord(e,t+4,n-4);else if(l===1)this._parseHEVCVideoData(e,t+4,n-4,r,i,o,u);else if(l!==2)return void this._onError(g.a.FORMAT_ERROR,`Flv: Invalid video packet type ${l}`)}},e.prototype._parseEnhancedHEVCVideoPacket=function(e,t,n,r,i,a,o){var s=this._littleEndian,c=new DataView(e,t,n);if(o===0)this._parseHEVCDecoderConfigurationRecord(e,t,n);else if(o===1){var l=(4294967040&c.getUint32(0,!s))>>8;this._parseHEVCVideoData(e,t+3,n-3,r,i,a,l)}else if(o===3)this._parseHEVCVideoData(e,t,n,r,i,a,0);else if(o!==2)return void this._onError(g.a.FORMAT_ERROR,`Flv: Invalid video packet type ${o}`)},e.prototype._parseEnhancedAV1VideoPacket=function(e,t,n,r,i,a,o){if(this._littleEndian,new DataView(e,t,n),o===0)this._parseAV1CodecConfigurationRecord(e,t,n);else if(o===1)this._parseAV1VideoData(e,t,n,r,i,a,0);else{if(o===5)return void this._onError(g.a.FORMAT_ERROR,`Flv: Not Supported MP2T AV1 video packet type ${o}`);if(o!==2)return void this._onError(g.a.FORMAT_ERROR,`Flv: Invalid video packet type ${o}`)}},e.prototype._parseAVCDecoderConfigurationRecord=function(e,t,n){if(n<7)a.a.w(this.TAG,`Flv: Invalid AVCDecoderConfigurationRecord, lack of data!`);else{var r=this._videoMetadata,i=this._videoTrack,o=this._littleEndian,s=new DataView(e,t,n);if(r){if(r.avcc!==void 0){if(x(new Uint8Array(e,t,n),r.avcc))return;a.a.w(this.TAG,`AVCDecoderConfigurationRecord has been changed, re-generate initialization segment`)}}else !1===this._hasVideo&&!1===this._hasVideoFlagOverrided&&(this._hasVideo=!0,this._mediaInfo.hasVideo=!0),(r=this._videoMetadata={}).type=`video`,r.id=i.id,r.timescale=this._timescale,r.duration=this._duration;var c=s.getUint8(0),l=s.getUint8(1);if(s.getUint8(2),s.getUint8(3),c===1&&l!==0)if(this._naluLengthSize=1+(3&s.getUint8(4)),this._naluLengthSize===3||this._naluLengthSize===4){var u=31&s.getUint8(5);if(u!==0){u>1&&a.a.w(this.TAG,`Flv: Strange AVCDecoderConfigurationRecord: SPS Count = ${u}`);for(var d=6,f=0;f<u;f++){var p=s.getUint16(d,!o);if(d+=2,p!==0){var m=new Uint8Array(e,t+d,p);d+=p;var _=h.parseSPS(m);if(f===0){r.codecWidth=_.codec_size.width,r.codecHeight=_.codec_size.height,r.presentWidth=_.present_size.width,r.presentHeight=_.present_size.height,r.profile=_.profile_string,r.level=_.level_string,r.bitDepth=_.bit_depth,r.chromaFormat=_.chroma_format,r.sarRatio=_.sar_ratio,r.frameRate=_.frame_rate,!1!==_.frame_rate.fixed&&_.frame_rate.fps_num!==0&&_.frame_rate.fps_den!==0||(r.frameRate=this._referenceFrameRate);var v=r.frameRate.fps_den,y=r.frameRate.fps_num;r.refSampleDuration=r.timescale*(v/y);for(var b=m.subarray(1,4),S=`avc1.`,C=0;C<3;C++){var w=b[C].toString(16);w.length<2&&(w=`0`+w),S+=w}r.codec=S;var T=this._mediaInfo;T.width=r.codecWidth,T.height=r.codecHeight,T.fps=r.frameRate.fps,T.profile=r.profile,T.level=r.level,T.refFrames=_.ref_frames,T.chromaFormat=_.chroma_format_string,T.sarNum=r.sarRatio.width,T.sarDen=r.sarRatio.height,T.videoCodec=S,T.hasAudio?T.audioCodec!=null&&(T.mimeType=`video/x-flv; codecs="`+T.videoCodec+`,`+T.audioCodec+`"`):T.mimeType=`video/x-flv; codecs="`+T.videoCodec+`"`,T.isComplete()&&this._onMediaInfo(T)}}}var E=s.getUint8(d);if(E!==0){for(E>1&&a.a.w(this.TAG,`Flv: Strange AVCDecoderConfigurationRecord: PPS Count = ${E}`),d++,f=0;f<E;f++)p=s.getUint16(d,!o),d+=2,p!==0&&(d+=p);r.avcc=new Uint8Array(n),r.avcc.set(new Uint8Array(e,t,n),0),a.a.v(this.TAG,`Parsed AVCDecoderConfigurationRecord`),this._isInitialMetadataDispatched()?this._dispatch&&(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack):this._videoInitialMetadataDispatched=!0,this._dispatch=!1,this._onTrackMetadata(`video`,r)}else this._onError(g.a.FORMAT_ERROR,`Flv: Invalid AVCDecoderConfigurationRecord: No PPS`)}else this._onError(g.a.FORMAT_ERROR,`Flv: Invalid AVCDecoderConfigurationRecord: No SPS`)}else this._onError(g.a.FORMAT_ERROR,`Flv: Strange NaluLengthSizeMinusOne: ${this._naluLengthSize-1}`);else this._onError(g.a.FORMAT_ERROR,`Flv: Invalid AVCDecoderConfigurationRecord`)}},e.prototype._parseHEVCDecoderConfigurationRecord=function(e,t,n){if(n<22)a.a.w(this.TAG,`Flv: Invalid HEVCDecoderConfigurationRecord, lack of data!`);else{var r=this._videoMetadata,i=this._videoTrack,o=this._littleEndian,s=new DataView(e,t,n);if(r){if(r.hvcc!==void 0){if(x(new Uint8Array(e,t,n),r.hvcc))return;a.a.w(this.TAG,`HEVCDecoderConfigurationRecord has been changed, re-generate initialization segment`)}}else !1===this._hasVideo&&!1===this._hasVideoFlagOverrided&&(this._hasVideo=!0,this._mediaInfo.hasVideo=!0),(r=this._videoMetadata={}).type=`video`,r.id=i.id,r.timescale=this._timescale,r.duration=this._duration;var c=s.getUint8(0),l=31&s.getUint8(1);if(c!==0&&c!==1||l===0)this._onError(g.a.FORMAT_ERROR,`Flv: Invalid HEVCDecoderConfigurationRecord`);else if(this._naluLengthSize=1+(3&s.getUint8(21)),this._naluLengthSize===3||this._naluLengthSize===4){for(var u=s.getUint8(22),d=0,f=23;d<u;d++){var p=63&s.getUint8(f+0),m=s.getUint16(f+1,!o);f+=3;for(var h=0;h<m;h++){var v=s.getUint16(f+0,!o);if(h===0)if(p===33){f+=2;var y=new Uint8Array(e,t+f,v),b=_.parseSPS(y);r.codecWidth=b.codec_size.width,r.codecHeight=b.codec_size.height,r.presentWidth=b.present_size.width,r.presentHeight=b.present_size.height,r.profile=b.profile_string,r.level=b.level_string,r.bitDepth=b.bit_depth,r.chromaFormat=b.chroma_format,r.sarRatio=b.sar_ratio,r.frameRate=b.frame_rate,!1!==b.frame_rate.fixed&&b.frame_rate.fps_num!==0&&b.frame_rate.fps_den!==0||(r.frameRate=this._referenceFrameRate);var S=r.frameRate.fps_den,C=r.frameRate.fps_num;r.refSampleDuration=r.timescale*(S/C),r.codec=b.codec_mimetype;var w=this._mediaInfo;w.width=r.codecWidth,w.height=r.codecHeight,w.fps=r.frameRate.fps,w.profile=r.profile,w.level=r.level,w.refFrames=b.ref_frames,w.chromaFormat=b.chroma_format_string,w.sarNum=r.sarRatio.width,w.sarDen=r.sarRatio.height,w.videoCodec=b.codec_mimetype,w.hasAudio?w.audioCodec!=null&&(w.mimeType=`video/x-flv; codecs="`+w.videoCodec+`,`+w.audioCodec+`"`):w.mimeType=`video/x-flv; codecs="`+w.videoCodec+`"`,w.isComplete()&&this._onMediaInfo(w),f+=v}else f+=2+v;else f+=2+v}}r.hvcc=new Uint8Array(n),r.hvcc.set(new Uint8Array(e,t,n),0),a.a.v(this.TAG,`Parsed HEVCDecoderConfigurationRecord`),this._isInitialMetadataDispatched()?this._dispatch&&(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack):this._videoInitialMetadataDispatched=!0,this._dispatch=!1,this._onTrackMetadata(`video`,r)}else this._onError(g.a.FORMAT_ERROR,`Flv: Strange NaluLengthSizeMinusOne: ${this._naluLengthSize-1}`)}},e.prototype._parseAV1CodecConfigurationRecord=function(e,t,n){if(n<4)a.a.w(this.TAG,`Flv: Invalid AV1CodecConfigurationRecord, lack of data!`);else{var r=this._videoMetadata,i=this._videoTrack,o=(this._littleEndian,new DataView(e,t,n));r?r.av1c!==void 0&&a.a.w(this.TAG,`Found another AV1CodecConfigurationRecord!`):(!1===this._hasVideo&&!1===this._hasVideoFlagOverrided&&(this._hasVideo=!0,this._mediaInfo.hasVideo=!0),(r=this._videoMetadata={}).type=`video`,r.id=i.id,r.timescale=this._timescale,r.duration=this._duration);var s=127&o.getUint8(0);if(o.getUint8(1),o.getUint8(1),o.getUint8(2),s===1){var c=C.parseOBUs(new Uint8Array(e,t+4,n-4));if(c!=null){r.profile=c.profile_string,r.level=c.level_string,r.bitDepth=c.bit_depth,r.chromaFormat=c.chroma_format,r.frameRate=c.frame_rate,!1!==c.frame_rate.fixed&&c.frame_rate.fps_num!==0&&c.frame_rate.fps_den!==0||(r.frameRate=this._referenceFrameRate);var l=r.frameRate.fps_den,u=r.frameRate.fps_num;r.refSampleDuration=r.timescale*(l/u),r.codec=c.codec_mimetype,r.extra=c;var d=this._mediaInfo;d.fps=r.frameRate.fps,d.profile=r.profile,d.level=r.level,d.refFrames=c.ref_frames,d.chromaFormat=c.chroma_format_string,d.videoCodec=c.codec_mimetype,d.hasAudio?d.audioCodec!=null&&(d.mimeType=`video/x-flv; codecs="`+d.videoCodec+`,`+d.audioCodec+`"`):d.mimeType=`video/x-flv; codecs="`+d.videoCodec+`"`,d.isComplete()&&this._onMediaInfo(d),r.av1c=new Uint8Array(n),r.av1c.set(new Uint8Array(e,t,n),0),a.a.v(this.TAG,`Preparing AV1CodecConfigurationRecord`)}else this._onError(g.a.FORMAT_ERROR,`Flv: Invalid AV1CodecConfigurationRecord`)}else this._onError(g.a.FORMAT_ERROR,`Flv: Invalid AV1CodecConfigurationRecord`)}},e.prototype._parseAVCVideoData=function(e,t,n,r,i,o,s){for(var c=this._littleEndian,l=new DataView(e,t,n),u=[],d=0,f=0,p=this._naluLengthSize,m=this._timestampBase+r,h=o===1;f<n;){if(f+4>=n){a.a.w(this.TAG,`Malformed Nalu near timestamp ${m}, offset = ${f}, dataSize = ${n}`);break}var g=l.getUint32(f,!c);if(p===3&&(g>>>=8),g>n-p)return void a.a.w(this.TAG,`Malformed Nalus near timestamp ${m}, NaluSize > DataSize!`);var _=31&l.getUint8(f+p);_===5&&(h=!0);var v=new Uint8Array(e,t+f,p+g),y={type:_,data:v};u.push(y),d+=v.byteLength,f+=p+g}if(u.length){var b=this._videoTrack,x={units:u,length:d,isKeyframe:h,dts:m,cts:s,pts:m+s};h&&(x.fileposition=i),b.samples.push(x),b.length+=d}},e.prototype._parseHEVCVideoData=function(e,t,n,r,i,o,s){for(var c=this._littleEndian,l=new DataView(e,t,n),u=[],d=0,f=0,p=this._naluLengthSize,m=this._timestampBase+r,h=o===1;f<n;){if(f+4>=n){a.a.w(this.TAG,`Malformed Nalu near timestamp ${m}, offset = ${f}, dataSize = ${n}`);break}var g=l.getUint32(f,!c);if(p===3&&(g>>>=8),g>n-p)return void a.a.w(this.TAG,`Malformed Nalus near timestamp ${m}, NaluSize > DataSize!`);var _=l.getUint8(f+p)>>1&63;_!==19&&_!==20&&_!==21||(h=!0);var v=new Uint8Array(e,t+f,p+g),y={type:_,data:v};u.push(y),d+=v.byteLength,f+=p+g}if(u.length){var b=this._videoTrack,x={units:u,length:d,isKeyframe:h,dts:m,cts:s,pts:m+s};h&&(x.fileposition=i),b.samples.push(x),b.length+=d}},e.prototype._parseAV1VideoData=function(e,t,n,r,i,o,s){this._littleEndian,new DataView(e,t,n);var c,l=[],u=this._timestampBase+r,d=o===1;if(d){var f=this._videoMetadata,p=C.parseOBUs(new Uint8Array(e,t,n),f.extra);if(p==null)return void this._onError(g.a.FORMAT_ERROR,`Flv: Invalid AV1 VideoData`);console.log(p),f.codecWidth=p.codec_size.width,f.codecHeight=p.codec_size.height,f.presentWidth=p.present_size.width,f.presentHeight=p.present_size.height,f.sarRatio=p.sar_ratio;var m=this._mediaInfo;m.width=f.codecWidth,m.height=f.codecHeight,m.sarNum=f.sarRatio.width,m.sarDen=f.sarRatio.height,a.a.v(this.TAG,`Parsed AV1DecoderConfigurationRecord`),this._isInitialMetadataDispatched()?this._dispatch&&(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack):this._videoInitialMetadataDispatched=!0,this._dispatch=!1,this._onTrackMetadata(`video`,f)}if(c=n,l.push({unitType:0,data:new Uint8Array(e,t+0,n)}),l.length){var h=this._videoTrack,_={units:l,length:c,isKeyframe:d,dts:u,cts:s,pts:u+s};d&&(_.fileposition=i),h.samples.push(_),h.length+=c}},e}(),E=function(){function e(){}return e.prototype.destroy=function(){this.onError=null,this.onMediaInfo=null,this.onMetaDataArrived=null,this.onTrackMetadata=null,this.onDataAvailable=null,this.onTimedID3Metadata=null,this.onSynchronousKLVMetadata=null,this.onAsynchronousKLVMetadata=null,this.onSMPTE2038Metadata=null,this.onSCTE35Metadata=null,this.onPESPrivateData=null,this.onPESPrivateDataDescriptor=null},e}(),D=function(){this.program_pmt_pid={}};(function(e){e[e.kMPEG1Audio=3]=`kMPEG1Audio`,e[e.kMPEG2Audio=4]=`kMPEG2Audio`,e[e.kPESPrivateData=6]=`kPESPrivateData`,e[e.kADTSAAC=15]=`kADTSAAC`,e[e.kLOASAAC=17]=`kLOASAAC`,e[e.kAC3=129]=`kAC3`,e[e.kEAC3=135]=`kEAC3`,e[e.kMetadata=21]=`kMetadata`,e[e.kSCTE35=134]=`kSCTE35`,e[e.kH264=27]=`kH264`,e[e.kH265=36]=`kH265`})(w||={});var O,k=function(){this.pid_stream_type={},this.common_pids={h264:void 0,h265:void 0,av1:void 0,adts_aac:void 0,loas_aac:void 0,opus:void 0,ac3:void 0,eac3:void 0,mp3:void 0},this.pes_private_data_pids={},this.timed_id3_pids={},this.synchronous_klv_pids={},this.asynchronous_klv_pids={},this.scte_35_pids={},this.smpte2038_pids={}},A=function(){},j=function(){},M=function(){this.slices=[],this.total_length=0,this.expected_length=0,this.file_position=0};(function(e){e[e.kUnspecified=0]=`kUnspecified`,e[e.kSliceNonIDR=1]=`kSliceNonIDR`,e[e.kSliceDPA=2]=`kSliceDPA`,e[e.kSliceDPB=3]=`kSliceDPB`,e[e.kSliceDPC=4]=`kSliceDPC`,e[e.kSliceIDR=5]=`kSliceIDR`,e[e.kSliceSEI=6]=`kSliceSEI`,e[e.kSliceSPS=7]=`kSliceSPS`,e[e.kSlicePPS=8]=`kSlicePPS`,e[e.kSliceAUD=9]=`kSliceAUD`,e[e.kEndOfSequence=10]=`kEndOfSequence`,e[e.kEndOfStream=11]=`kEndOfStream`,e[e.kFiller=12]=`kFiller`,e[e.kSPSExt=13]=`kSPSExt`,e[e.kReserved0=14]=`kReserved0`})(O||={});var N,P,F=function(){},I=function(e){var t=e.data.byteLength;this.type=e.type,this.data=new Uint8Array(4+t),new DataView(this.data.buffer).setUint32(0,t),this.data.set(e.data,4)},L=function(){function e(e){this.TAG=`H264AnnexBParser`,this.current_startcode_offset_=0,this.eof_flag_=!1,this.data_=e,this.current_startcode_offset_=this.findNextStartCodeOffset(0),this.eof_flag_&&a.a.e(this.TAG,`Could not find H264 startcode until payload end!`)}return e.prototype.findNextStartCodeOffset=function(e){for(var t=e,n=this.data_;;){if(t+3>=n.byteLength)return this.eof_flag_=!0,n.byteLength;var r=n[t+0]<<24|n[t+1]<<16|n[t+2]<<8|n[t+3],i=n[t+0]<<16|n[t+1]<<8|n[t+2];if(r===1||i===1)return t;t++}},e.prototype.readNextNaluPayload=function(){for(var e=this.data_,t=null;t==null&&!this.eof_flag_;){var n=this.current_startcode_offset_,r=31&e[n+=(e[n]<<24|e[n+1]<<16|e[n+2]<<8|e[n+3])==1?4:3],i=(128&e[n])>>>7,a=this.findNextStartCodeOffset(n);if(this.current_startcode_offset_=a,!(r>=O.kReserved0)&&i===0){var o=e.subarray(n,a);(t=new F).type=r,t.data=o}}return t},e}(),R=function(){function e(e,t,n){var r=8+e.byteLength+1+2+t.byteLength,i=!1;e[3]!==66&&e[3]!==77&&e[3]!==88&&(i=!0,r+=4);var a=this.data=new Uint8Array(r);a[0]=1,a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=255,a[5]=225;var o=e.byteLength;a[6]=o>>>8,a[7]=255&o;var s=8;a.set(e,8),a[s+=o]=1;var c=t.byteLength;a[s+1]=c>>>8,a[s+2]=255&c,a.set(t,s+3),s+=3+c,i&&(a[s]=252|n.chroma_format_idc,a[s+1]=248|n.bit_depth_luma-8,a[s+2]=248|n.bit_depth_chroma-8,a[s+3]=0,s+=4)}return e.prototype.getData=function(){return this.data},e}();(function(e){e[e.kNull=0]=`kNull`,e[e.kAACMain=1]=`kAACMain`,e[e.kAAC_LC=2]=`kAAC_LC`,e[e.kAAC_SSR=3]=`kAAC_SSR`,e[e.kAAC_LTP=4]=`kAAC_LTP`,e[e.kAAC_SBR=5]=`kAAC_SBR`,e[e.kAAC_Scalable=6]=`kAAC_Scalable`,e[e.kLayer1=32]=`kLayer1`,e[e.kLayer2=33]=`kLayer2`,e[e.kLayer3=34]=`kLayer3`})(N||={}),function(e){e[e.k96000Hz=0]=`k96000Hz`,e[e.k88200Hz=1]=`k88200Hz`,e[e.k64000Hz=2]=`k64000Hz`,e[e.k48000Hz=3]=`k48000Hz`,e[e.k44100Hz=4]=`k44100Hz`,e[e.k32000Hz=5]=`k32000Hz`,e[e.k24000Hz=6]=`k24000Hz`,e[e.k22050Hz=7]=`k22050Hz`,e[e.k16000Hz=8]=`k16000Hz`,e[e.k12000Hz=9]=`k12000Hz`,e[e.k11025Hz=10]=`k11025Hz`,e[e.k8000Hz=11]=`k8000Hz`,e[e.k7350Hz=12]=`k7350Hz`}(P||={});var z,B,V=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],ee=(z=function(e,t){return(z=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if(typeof t!=`function`&&t!==null)throw TypeError(`Class extends value `+String(t)+` is not a constructor or null`);function n(){this.constructor=e}z(e,t),e.prototype=t===null?Object.create(t):(n.prototype=t.prototype,new n)}),H=function(){},te=function(e){function t(){return e!==null&&e.apply(this,arguments)||this}return ee(t,e),t}(H),ne=function(){function e(e){this.TAG=`AACADTSParser`,this.data_=e,this.current_syncword_offset_=this.findNextSyncwordOffset(0),this.eof_flag_&&a.a.e(this.TAG,`Could not found ADTS syncword until payload end`)}return e.prototype.findNextSyncwordOffset=function(e){for(var t=e,n=this.data_;;){if(t+7>=n.byteLength)return this.eof_flag_=!0,n.byteLength;if((n[t+0]<<8|n[t+1])>>>4==4095)return t;t++}},e.prototype.readNextAACFrame=function(){for(var e=this.data_,t=null;t==null&&!this.eof_flag_;){var n=this.current_syncword_offset_,r=(8&e[n+1])>>>3,i=(6&e[n+1])>>>1,a=1&e[n+1],o=(192&e[n+2])>>>6,s=(60&e[n+2])>>>2,c=(1&e[n+2])<<2|(192&e[n+3])>>>6,l=(3&e[n+3])<<11|e[n+4]<<3|(224&e[n+5])>>>5;if(e[n+6],n+l>this.data_.byteLength){this.eof_flag_=!0,this.has_last_incomplete_data=!0;break}var u=a===1?7:9,d=l-u;if(n+=u,this.current_syncword_offset_=this.findNextSyncwordOffset(n+d),(r===0||r===1)&&i===0){var f=e.subarray(n,n+d);(t=new H).audio_object_type=o+1,t.sampling_freq_index=s,t.sampling_frequency=V[s],t.channel_config=c,t.data=f}}return t},e.prototype.hasIncompleteData=function(){return this.has_last_incomplete_data},e.prototype.getIncompleteData=function(){return this.has_last_incomplete_data?this.data_.subarray(this.current_syncword_offset_):null},e}(),re=function(){function e(e){this.TAG=`AACLOASParser`,this.data_=e,this.current_syncword_offset_=this.findNextSyncwordOffset(0),this.eof_flag_&&a.a.e(this.TAG,`Could not found LOAS syncword until payload end`)}return e.prototype.findNextSyncwordOffset=function(e){for(var t=e,n=this.data_;;){if(t+1>=n.byteLength)return this.eof_flag_=!0,n.byteLength;if((n[t+0]<<3|n[t+1]>>>5)==695)return t;t++}},e.prototype.getLATMValue=function(e){for(var t=e.readBits(2),n=0,r=0;r<=t;r++)n<<=8,n|=e.readByte();return n},e.prototype.readNextAACFrame=function(e){for(var t=this.data_,n=null;n==null&&!this.eof_flag_;){var r=this.current_syncword_offset_,i=(31&t[r+1])<<8|t[r+2];if(r+3+i>=this.data_.byteLength){this.eof_flag_=!0,this.has_last_incomplete_data=!0;break}var o=new m(t.subarray(r+3,r+3+i)),s=null;if(o.readBool()){if(e==null){a.a.w(this.TAG,`StreamMuxConfig Missing`),this.current_syncword_offset_=this.findNextSyncwordOffset(r+3+i),o.destroy();continue}s=e}else{var c=o.readBool();if(c&&o.readBool()){a.a.e(this.TAG,`audioMuxVersionA is Not Supported`),o.destroy();break}if(c&&this.getLATMValue(o),!o.readBool()){a.a.e(this.TAG,`allStreamsSameTimeFraming zero is Not Supported`),o.destroy();break}if(o.readBits(6)!==0){a.a.e(this.TAG,`more than 2 numSubFrames Not Supported`),o.destroy();break}if(o.readBits(4)!==0){a.a.e(this.TAG,`more than 2 numProgram Not Supported`),o.destroy();break}if(o.readBits(3)!==0){a.a.e(this.TAG,`more than 2 numLayer Not Supported`),o.destroy();break}var l=c?this.getLATMValue(o):0,u=o.readBits(5);l-=5;var d=o.readBits(4);l-=4;var f=o.readBits(4);l-=4,o.readBits(3),(l-=3)>0&&o.readBits(l);var p=o.readBits(3);if(p!==0){a.a.e(this.TAG,`frameLengthType = ${p}. Only frameLengthType = 0 Supported`),o.destroy();break}o.readByte();var h=o.readBool();if(h)if(c)this.getLATMValue(o);else{for(var g=0;;){g<<=8;var _=o.readBool();if(g+=o.readByte(),!_)break}console.log(g)}o.readBool()&&o.readByte(),(s=new te).audio_object_type=u,s.sampling_freq_index=d,s.sampling_frequency=V[s.sampling_freq_index],s.channel_config=f,s.other_data_present=h}for(var v=0;;){var y=o.readByte();if(v+=y,y!==255)break}for(var b=new Uint8Array(v),x=0;x<v;x++)b[x]=o.readByte();(n=new te).audio_object_type=s.audio_object_type,n.sampling_freq_index=s.sampling_freq_index,n.sampling_frequency=V[s.sampling_freq_index],n.channel_config=s.channel_config,n.other_data_present=s.other_data_present,n.data=b,this.current_syncword_offset_=this.findNextSyncwordOffset(r+3+i)}return n},e.prototype.hasIncompleteData=function(){return this.has_last_incomplete_data},e.prototype.getIncompleteData=function(){return this.has_last_incomplete_data?this.data_.subarray(this.current_syncword_offset_):null},e}(),ie=function(e){var t=null,n=e.audio_object_type,r=e.audio_object_type,i=e.sampling_freq_index,a=e.channel_config,o=0,s=navigator.userAgent.toLowerCase();s.indexOf(`firefox`)===-1?s.indexOf(`android`)===-1?(r=5,o=i,t=[,,,,],i>=6?o=i-3:a===1&&(r=2,t=[,,],o=i)):(r=2,t=[,,],o=i):i>=6?(r=5,t=[,,,,],o=i-3):(r=2,t=[,,],o=i),t[0]=r<<3,t[0]|=(15&i)>>>1,t[1]=(15&i)<<7,t[1]|=(15&a)<<3,r===5&&(t[1]|=(15&o)>>>1,t[2]=(1&o)<<7,t[2]|=8,t[3]=0),this.config=t,this.sampling_rate=V[i],this.channel_count=a,this.codec_mimetype=`mp4a.40.`+r,this.original_codec_mimetype=`mp4a.40.`+n},ae=function(){},oe=function(){};(function(e){e[e.kSpliceNull=0]=`kSpliceNull`,e[e.kSpliceSchedule=4]=`kSpliceSchedule`,e[e.kSpliceInsert=5]=`kSpliceInsert`,e[e.kTimeSignal=6]=`kTimeSignal`,e[e.kBandwidthReservation=7]=`kBandwidthReservation`,e[e.kPrivateCommand=255]=`kPrivateCommand`})(B||={});var se,U=function(e){var t=e.readBool();return t?(e.readBits(6),{time_specified_flag:t,pts_time:4*e.readBits(31)+e.readBits(2)}):(e.readBits(7),{time_specified_flag:t})},ce=function(e){var t=e.readBool();return e.readBits(6),{auto_return:t,duration:4*e.readBits(31)+e.readBits(2)}},W=function(e,t){var n=t.readBits(8);return e?{component_tag:n}:{component_tag:n,splice_time:U(t)}},le=function(e){return{component_tag:e.readBits(8),utc_splice_time:e.readBits(32)}},G=function(e){var t=e.readBits(32),n=e.readBool();e.readBits(7);var r={splice_event_id:t,splice_event_cancel_indicator:n};if(n)return r;if(r.out_of_network_indicator=e.readBool(),r.program_splice_flag=e.readBool(),r.duration_flag=e.readBool(),e.readBits(5),r.program_splice_flag)r.utc_splice_time=e.readBits(32);else{r.component_count=e.readBits(8),r.components=[];for(var i=0;i<r.component_count;i++)r.components.push(le(e))}return r.duration_flag&&(r.break_duration=ce(e)),r.unique_program_id=e.readBits(16),r.avail_num=e.readBits(8),r.avails_expected=e.readBits(8),r},ue=function(e,t,n,r){return{descriptor_tag:e,descriptor_length:t,identifier:n,provider_avail_id:r.readBits(32)}},K=function(e,t,n,r){var i=r.readBits(8),a=r.readBits(3);r.readBits(5);for(var o=``,s=0;s<a;s++)o+=String.fromCharCode(r.readBits(8));return{descriptor_tag:e,descriptor_length:t,identifier:n,preroll:i,dtmf_count:a,DTMF_char:o}},de=function(e){var t=e.readBits(8);return e.readBits(7),{component_tag:t,pts_offset:4*e.readBits(31)+e.readBits(2)}},fe=function(e,t,n,r){var i=r.readBits(32),a=r.readBool();r.readBits(7);var o={descriptor_tag:e,descriptor_length:t,identifier:n,segmentation_event_id:i,segmentation_event_cancel_indicator:a};if(a)return o;if(o.program_segmentation_flag=r.readBool(),o.segmentation_duration_flag=r.readBool(),o.delivery_not_restricted_flag=r.readBool(),o.delivery_not_restricted_flag?r.readBits(5):(o.web_delivery_allowed_flag=r.readBool(),o.no_regional_blackout_flag=r.readBool(),o.archive_allowed_flag=r.readBool(),o.device_restrictions=r.readBits(2)),!o.program_segmentation_flag){o.component_count=r.readBits(8),o.components=[];for(var s=0;s<o.component_count;s++)o.components.push(de(r))}o.segmentation_duration_flag&&(o.segmentation_duration=r.readBits(40)),o.segmentation_upid_type=r.readBits(8),o.segmentation_upid_length=r.readBits(8);var c=new Uint8Array(o.segmentation_upid_length);for(s=0;s<o.segmentation_upid_length;s++)c[s]=r.readBits(8);return o.segmentation_upid=c.buffer,o.segmentation_type_id=r.readBits(8),o.segment_num=r.readBits(8),o.segments_expected=r.readBits(8),o.segmentation_type_id!==52&&o.segmentation_type_id!==54&&o.segmentation_type_id!==56&&o.segmentation_type_id!==58||(o.sub_segment_num=r.readBits(8),o.sub_segments_expected=r.readBits(8)),o},pe=function(e,t,n,r){return{descriptor_tag:e,descriptor_length:t,identifier:n,TAI_seconds:r.readBits(48),TAI_ns:r.readBits(32),UTC_offset:r.readBits(16)}},me=function(e){return{component_tag:e.readBits(8),ISO_code:String.fromCharCode(e.readBits(8),e.readBits(8),e.readBits(8)),Bit_Stream_Mode:e.readBits(3),Num_Channels:e.readBits(4),Full_Srvc_Audio:e.readBool()}},he=function(e,t,n,r){for(var i=r.readBits(4),a=[],o=0;o<i;o++)a.push(me(r));return{descriptor_tag:e,descriptor_length:t,identifier:n,audio_count:i,components:a}},ge=function(e){var t=new m(e),n=t.readBits(8),r=t.readBool(),i=t.readBool();t.readBits(2);var a=t.readBits(12),o=t.readBits(8),s=t.readBool(),c=t.readBits(6),l=4*t.readBits(31)+t.readBits(2),u=t.readBits(8),d=t.readBits(12),f=t.readBits(12),p=t.readBits(8),h=null;p===B.kSpliceNull?h={}:p===B.kSpliceSchedule?h=function(e){for(var t=e.readBits(8),n=[],r=0;r<t;r++)n.push(G(e));return{splice_count:t,events:n}}(t):p===B.kSpliceInsert?h=function(e){var t=e.readBits(32),n=e.readBool();e.readBits(7);var r={splice_event_id:t,splice_event_cancel_indicator:n};if(n)return r;if(r.out_of_network_indicator=e.readBool(),r.program_splice_flag=e.readBool(),r.duration_flag=e.readBool(),r.splice_immediate_flag=e.readBool(),e.readBits(4),r.program_splice_flag&&!r.splice_immediate_flag&&(r.splice_time=U(e)),!r.program_splice_flag){r.component_count=e.readBits(8),r.components=[];for(var i=0;i<r.component_count;i++)r.components.push(W(r.splice_immediate_flag,e))}return r.duration_flag&&(r.break_duration=ce(e)),r.unique_program_id=e.readBits(16),r.avail_num=e.readBits(8),r.avails_expected=e.readBits(8),r}(t):p===B.kTimeSignal?h=function(e){return{splice_time:U(e)}}(t):p===B.kBandwidthReservation?h={}:p===B.kPrivateCommand?h=function(e,t){for(var n=String.fromCharCode(t.readBits(8),t.readBits(8),t.readBits(8),t.readBits(8)),r=new Uint8Array(e-4),i=0;i<e-4;i++)r[i]=t.readBits(8);return{identifier:n,private_data:r.buffer}}(f,t):t.readBits(8*f);for(var g=[],_=t.readBits(16),v=0;v<_;){var y=t.readBits(8),b=t.readBits(8),x=String.fromCharCode(t.readBits(8),t.readBits(8),t.readBits(8),t.readBits(8));y===0?g.push(ue(y,b,x,t)):y===1?g.push(K(y,b,x,t)):y===2?g.push(fe(y,b,x,t)):y===3?g.push(pe(y,b,x,t)):y===4?g.push(he(y,b,x,t)):t.readBits(8*(b-4)),v+=2+b}var S={table_id:n,section_syntax_indicator:r,private_indicator:i,section_length:a,protocol_version:o,encrypted_packet:s,encryption_algorithm:c,pts_adjustment:l,cw_index:u,tier:d,splice_command_length:f,splice_command_type:p,splice_command:h,descriptor_loop_length:_,splice_descriptors:g,E_CRC32:s?t.readBits(32):void 0,CRC32:t.readBits(32)};if(p===B.kSpliceInsert){var C=h;if(C.splice_event_cancel_indicator)return{splice_command_type:p,detail:S,data:e};if(C.program_splice_flag&&!C.splice_immediate_flag){var w=C.duration_flag?C.break_duration.auto_return:void 0,T=C.duration_flag?C.break_duration.duration/90:void 0;return C.splice_time.time_specified_flag?{splice_command_type:p,pts:(l+C.splice_time.pts_time)%2**33,auto_return:w,duraiton:T,detail:S,data:e}:{splice_command_type:p,auto_return:w,duraiton:T,detail:S,data:e}}return{splice_command_type:p,auto_return:w=C.duration_flag?C.break_duration.auto_return:void 0,duraiton:T=C.duration_flag?C.break_duration.duration/90:void 0,detail:S,data:e}}if(p===B.kTimeSignal){var E=h;return E.splice_time.time_specified_flag?{splice_command_type:p,pts:(l+E.splice_time.pts_time)%2**33,detail:S,data:e}:{splice_command_type:p,detail:S,data:e}}return{splice_command_type:p,detail:S,data:e}};(function(e){e[e.kSliceIDR_W_RADL=19]=`kSliceIDR_W_RADL`,e[e.kSliceIDR_N_LP=20]=`kSliceIDR_N_LP`,e[e.kSliceCRA_NUT=21]=`kSliceCRA_NUT`,e[e.kSliceVPS=32]=`kSliceVPS`,e[e.kSliceSPS=33]=`kSliceSPS`,e[e.kSlicePPS=34]=`kSlicePPS`,e[e.kSliceAUD=35]=`kSliceAUD`})(se||={});var _e=function(){},ve=function(e){var t=e.data.byteLength;this.type=e.type,this.data=new Uint8Array(4+t),new DataView(this.data.buffer).setUint32(0,t),this.data.set(e.data,4)},ye=function(){function e(e){this.TAG=`H265AnnexBParser`,this.current_startcode_offset_=0,this.eof_flag_=!1,this.data_=e,this.current_startcode_offset_=this.findNextStartCodeOffset(0),this.eof_flag_&&a.a.e(this.TAG,`Could not find H265 startcode until payload end!`)}return e.prototype.findNextStartCodeOffset=function(e){for(var t=e,n=this.data_;;){if(t+3>=n.byteLength)return this.eof_flag_=!0,n.byteLength;var r=n[t+0]<<24|n[t+1]<<16|n[t+2]<<8|n[t+3],i=n[t+0]<<16|n[t+1]<<8|n[t+2];if(r===1||i===1)return t;t++}},e.prototype.readNextNaluPayload=function(){for(var e=this.data_,t=null;t==null&&!this.eof_flag_;){var n=this.current_startcode_offset_,r=e[n+=(e[n]<<24|e[n+1]<<16|e[n+2]<<8|e[n+3])==1?4:3]>>1&63,i=(128&e[n])>>>7,a=this.findNextStartCodeOffset(n);if(this.current_startcode_offset_=a,i===0){var o=e.subarray(n,a);(t=new _e).type=r,t.data=o}}return t},e}(),be=function(){function e(e,t,n,r){var i=23+(5+e.byteLength)+(5+t.byteLength)+(5+n.byteLength),a=this.data=new Uint8Array(i);a[0]=1,a[1]=(3&r.general_profile_space)<<6|(r.general_tier_flag?1:0)<<5|31&r.general_profile_idc,a[2]=r.general_profile_compatibility_flags_1,a[3]=r.general_profile_compatibility_flags_2,a[4]=r.general_profile_compatibility_flags_3,a[5]=r.general_profile_compatibility_flags_4,a[6]=r.general_constraint_indicator_flags_1,a[7]=r.general_constraint_indicator_flags_2,a[8]=r.general_constraint_indicator_flags_3,a[9]=r.general_constraint_indicator_flags_4,a[10]=r.general_constraint_indicator_flags_5,a[11]=r.general_constraint_indicator_flags_6,a[12]=r.general_level_idc,a[13]=240|(3840&r.min_spatial_segmentation_idc)>>8,a[14]=255&r.min_spatial_segmentation_idc,a[15]=252|3&r.parallelismType,a[16]=252|3&r.chroma_format_idc,a[17]=248|7&r.bit_depth_luma_minus8,a[18]=248|7&r.bit_depth_chroma_minus8,a[19]=0,a[20]=0,a[21]=(3&r.constant_frame_rate)<<6|(7&r.num_temporal_layers)<<3|(r.temporal_id_nested?1:0)<<2|3,a[22]=3,a[23]=128|se.kSliceVPS,a[24]=0,a[25]=1,a[26]=(65280&e.byteLength)>>8,a[27]=(255&e.byteLength)>>0,a.set(e,28),a[23+(5+e.byteLength)+0]=128|se.kSliceSPS,a[23+(5+e.byteLength)+1]=0,a[23+(5+e.byteLength)+2]=1,a[23+(5+e.byteLength)+3]=(65280&t.byteLength)>>8,a[23+(5+e.byteLength)+4]=(255&t.byteLength)>>0,a.set(t,23+(5+e.byteLength)+5),a[23+(5+e.byteLength+5+t.byteLength)+0]=128|se.kSlicePPS,a[23+(5+e.byteLength+5+t.byteLength)+1]=0,a[23+(5+e.byteLength+5+t.byteLength)+2]=1,a[23+(5+e.byteLength+5+t.byteLength)+3]=(65280&n.byteLength)>>8,a[23+(5+e.byteLength+5+t.byteLength)+4]=(255&n.byteLength)>>0,a.set(n,23+(5+e.byteLength+5+t.byteLength)+5)}return e.prototype.getData=function(){return this.data},e}(),xe=function(){},Se=function(){},Ce=function(){},we=[[64,64,80,80,96,96,112,112,128,128,160,160,192,192,224,224,256,256,320,320,384,384,448,448,512,512,640,640,768,768,896,896,1024,1024,1152,1152,1280,1280],[69,70,87,88,104,105,121,122,139,140,174,175,208,209,243,244,278,279,348,349,417,418,487,488,557,558,696,697,835,836,975,976,1114,1115,1253,1254,1393,1394],[96,96,120,120,144,144,168,168,192,192,240,240,288,288,336,336,384,384,480,480,576,576,672,672,768,768,960,960,1152,1152,1344,1344,1536,1536,1728,1728,1920,1920]],Te=function(){function e(e){this.TAG=`AC3Parser`,this.data_=e,this.current_syncword_offset_=this.findNextSyncwordOffset(0),this.eof_flag_&&a.a.e(this.TAG,`Could not found AC3 syncword until payload end`)}return e.prototype.findNextSyncwordOffset=function(e){for(var t=e,n=this.data_;;){if(t+7>=n.byteLength)return this.eof_flag_=!0,n.byteLength;if((n[t+0]<<8|n[t+1]<<0)==2935)return t;t++}},e.prototype.readNextAC3Frame=function(){for(var e=this.data_,t=null;t==null&&!this.eof_flag_;){var n=this.current_syncword_offset_,r=e[n+4]>>6,i=[48e3,44200,33e3][r],a=63&e[n+4],o=2*we[r][a];if(isNaN(o)||n+o>this.data_.byteLength){this.eof_flag_=!0,this.has_last_incomplete_data=!0;break}this.current_syncword_offset_=this.findNextSyncwordOffset(n+o);var s=e[n+5]>>3,c=7&e[n+5],l=e[n+6]>>5,u=0;1&l&&l!==1&&(u+=2),4&l&&(u+=2),l===2&&(u+=2);var d=(e[n+6]<<8|e[n+7]<<0)>>12-u&1,f=[2,1,2,3,3,4,4,5][l]+d;(t=new Ce).sampling_frequency=i,t.channel_count=f,t.channel_mode=l,t.bit_stream_identification=s,t.low_frequency_effects_channel_on=d,t.bit_stream_mode=c,t.frame_size_code=a,t.data=e.subarray(n,n+o)}return t},e.prototype.hasIncompleteData=function(){return this.has_last_incomplete_data},e.prototype.getIncompleteData=function(){return this.has_last_incomplete_data?this.data_.subarray(this.current_syncword_offset_):null},e}(),Ee=function(e){this.config=[e.sampling_rate_code<<6|e.bit_stream_identification<<1|e.bit_stream_mode>>2,(3&e.bit_stream_mode)<<6|e.channel_mode<<3|e.low_frequency_effects_channel_on<<2|e.frame_size_code>>4,e.frame_size_code<<4&224],this.sampling_rate=e.sampling_frequency,this.bit_stream_identification=e.bit_stream_identification,this.bit_stream_mode=e.bit_stream_mode,this.low_frequency_effects_channel_on=e.low_frequency_effects_channel_on,this.channel_count=e.channel_count,this.channel_mode=e.channel_mode,this.codec_mimetype=`ac-3`,this.original_codec_mimetype=`ac-3`},De=function(){},Oe=function(){function e(e){this.TAG=`EAC3Parser`,this.data_=e,this.current_syncword_offset_=this.findNextSyncwordOffset(0),this.eof_flag_&&a.a.e(this.TAG,`Could not found AC3 syncword until payload end`)}return e.prototype.findNextSyncwordOffset=function(e){for(var t=e,n=this.data_;;){if(t+7>=n.byteLength)return this.eof_flag_=!0,n.byteLength;if((n[t+0]<<8|n[t+1]<<0)==2935)return t;t++}},e.prototype.readNextEAC3Frame=function(){for(var e=this.data_,t=null;t==null&&!this.eof_flag_;){var n=this.current_syncword_offset_,r=new m(e.subarray(n+2)),i=(r.readBits(2),r.readBits(3),r.readBits(11)+1<<1),a=r.readBits(2),o=null,s=null;a===3?(o=[24e3,22060,16e3][a=r.readBits(2)],s=3):(o=[48e3,44100,32e3][a],s=r.readBits(2));var c=r.readBits(3),l=r.readBits(1),u=r.readBits(5);if(n+i>this.data_.byteLength){this.eof_flag_=!0,this.has_last_incomplete_data=!0;break}this.current_syncword_offset_=this.findNextSyncwordOffset(n+i);var d=[2,1,2,3,3,4,4,5][c]+l;r.destroy(),(t=new De).sampling_frequency=o,t.channel_count=d,t.channel_mode=c,t.bit_stream_identification=u,t.low_frequency_effects_channel_on=l,t.frame_size=i,t.num_blks=[1,2,3,6][s],t.data=e.subarray(n,n+i)}return t},e.prototype.hasIncompleteData=function(){return this.has_last_incomplete_data},e.prototype.getIncompleteData=function(){return this.has_last_incomplete_data?this.data_.subarray(this.current_syncword_offset_):null},e}(),ke=function(e){var t,n=Math.floor(e.frame_size*e.sampling_frequency/(16*e.num_blks));t=[255&n,248&n,e.sampling_rate_code<<6|e.bit_stream_identification<<1|0,0|e.channel_mode<<1|e.low_frequency_effects_channel_on<<0,0],this.config=t,this.sampling_rate=e.sampling_frequency,this.bit_stream_identification=e.bit_stream_identification,this.num_blks=e.num_blks,this.low_frequency_effects_channel_on=e.low_frequency_effects_channel_on,this.channel_count=e.channel_count,this.channel_mode=e.channel_mode,this.codec_mimetype=`ec-3`,this.original_codec_mimetype=`ec-3`},Ae=function(){},je=function(){function e(e){this.TAG=`AV1OBUInMpegTsParser`,this.current_startcode_offset_=0,this.eof_flag_=!1,this.data_=e,this.current_startcode_offset_=this.findNextStartCodeOffset(0),this.eof_flag_&&a.a.e(this.TAG,`Could not find AV1 startcode until payload end!`)}return e._ebsp2rbsp=function(e){for(var t=e,n=t.byteLength,r=new Uint8Array(n),i=0,a=0;a<n;a++)a>=2&&t[a]===3&&t[a-1]===0&&t[a-2]===0||(r[i]=t[a],i++);return new Uint8Array(r.buffer,0,i)},e.prototype.findNextStartCodeOffset=function(e){for(var t=e,n=this.data_;;){if(t+2>=n.byteLength)return this.eof_flag_=!0,n.byteLength;if((n[t+0]<<16|n[t+1]<<8|n[t+2])==1)return t;t++}},e.prototype.readNextOBUPayload=function(){for(var t=this.data_,n=null;n==null&&!this.eof_flag_;){var r=this.current_startcode_offset_+3,i=this.findNextStartCodeOffset(r);this.current_startcode_offset_=i,n=e._ebsp2rbsp(t.subarray(r,i))}return n},e}(),Me=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if(typeof n!=`function`&&n!==null)throw TypeError(`Class extends value `+String(n)+` is not a constructor or null`);function r(){this.constructor=t}e(t,n),t.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}}(),Ne=function(){return(Ne=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},Pe=function(e){function t(t,n){var r=e.call(this)||this;return r.TAG=`TSDemuxer`,r.first_parse_=!0,r.media_info_=new s.a,r.timescale_=90,r.duration_=0,r.current_pmt_pid_=-1,r.program_pmt_map_={},r.pes_slice_queues_={},r.section_slice_queues_={},r.video_metadata_={vps:void 0,sps:void 0,pps:void 0,av1c:void 0,details:void 0},r.audio_metadata_={codec:void 0,audio_object_type:void 0,sampling_freq_index:void 0,sampling_frequency:void 0,channel_config:void 0},r.last_pcr_base_=NaN,r.timestamp_offset_=0,r.audio_last_sample_pts_=void 0,r.aac_last_incomplete_data_=null,r.has_video_=!1,r.has_audio_=!1,r.video_init_segment_dispatched_=!1,r.audio_init_segment_dispatched_=!1,r.video_metadata_changed_=!1,r.audio_metadata_changed_=!1,r.loas_previous_frame=null,r.video_track_={type:`video`,id:1,sequenceNumber:0,samples:[],length:0},r.audio_track_={type:`audio`,id:2,sequenceNumber:0,samples:[],length:0},r.ts_packet_size_=t.ts_packet_size,r.sync_offset_=t.sync_offset,r.config_=n,r}return Me(t,e),t.prototype.destroy=function(){this.media_info_=null,this.pes_slice_queues_=null,this.section_slice_queues_=null,this.video_metadata_=null,this.audio_metadata_=null,this.aac_last_incomplete_data_=null,this.video_track_=null,this.audio_track_=null,e.prototype.destroy.call(this)},t.probe=function(e){var t=new Uint8Array(e),n=-1,r=188;if(t.byteLength<=3*r)return{needMoreData:!0};for(;n===-1;){for(var i=Math.min(1e3,t.byteLength-3*r),o=0;o<i;){if(t[o]===71&&t[o+r]===71&&t[o+2*r]===71){n=o;break}o++}if(n===-1)if(r===188)r=192;else{if(r!==192)break;r=204}}return n===-1?{match:!1}:(r===192&&n>=4?(a.a.v(`TSDemuxer`,`ts_packet_size = 192, m2ts mode`),n-=4):r===204&&a.a.v(`TSDemuxer`,`ts_packet_size = 204, RS encoded MPEG2-TS stream`),{match:!0,consumed:0,ts_packet_size:r,sync_offset:n})},t.prototype.bindDataSource=function(e){return e.onDataArrival=this.parseChunks.bind(this),this},t.prototype.resetMediaInfo=function(){this.media_info_=new s.a},t.prototype.parseChunks=function(e,t){if(!(this.onError&&this.onMediaInfo&&this.onTrackMetadata&&this.onDataAvailable))throw new d.a(`onError & onMediaInfo & onTrackMetadata & onDataAvailable callback must be specified`);var n=0;for(this.first_parse_&&(this.first_parse_=!1,n=this.sync_offset_);n+this.ts_packet_size_<=e.byteLength;){var r=t+n;this.ts_packet_size_===192&&(n+=4);var i=new Uint8Array(e,n,188),o=i[0];if(o!==71){a.a.e(this.TAG,`sync_byte = ${o}, not 0x47`);break}var s=(64&i[1])>>>6,c=(i[1],(31&i[1])<<8|i[2]),l=(48&i[3])>>>4,u=15&i[3],f=!(!this.pmt_||this.pmt_.pcr_pid!==c),p={},m=4;if(l==2||l==3){var h=i[4];if(h>0&&(f||l==3)&&(p.discontinuity_indicator=(128&i[5])>>>7,p.random_access_indicator=(64&i[5])>>>6,p.elementary_stream_priority_indicator=(32&i[5])>>>5,(16&i[5])>>>4&&(this.last_pcr_=300*this.getPcrBase(i)+((1&i[10])<<8|i[11]))),l==2||5+h===188){n+=188,this.ts_packet_size_===204&&(n+=16);continue}m=5+h}if(l==1||l==3){if(c===0||c===this.current_pmt_pid_||this.pmt_!=null&&this.pmt_.pid_stream_type[c]===w.kSCTE35){var g=188-m;this.handleSectionSlice(e,n+m,g,{pid:c,file_position:r,payload_unit_start_indicator:s,continuity_conunter:u,random_access_indicator:p.random_access_indicator})}else if(this.pmt_!=null&&this.pmt_.pid_stream_type[c]!=null){g=188-m;var _=this.pmt_.pid_stream_type[c];c!==this.pmt_.common_pids.h264&&c!==this.pmt_.common_pids.h265&&c!==this.pmt_.common_pids.av1&&c!==this.pmt_.common_pids.adts_aac&&c!==this.pmt_.common_pids.loas_aac&&c!==this.pmt_.common_pids.ac3&&c!==this.pmt_.common_pids.eac3&&c!==this.pmt_.common_pids.opus&&c!==this.pmt_.common_pids.mp3&&!0!==this.pmt_.pes_private_data_pids[c]&&!0!==this.pmt_.timed_id3_pids[c]&&!0!==this.pmt_.synchronous_klv_pids[c]&&!0!==this.pmt_.asynchronous_klv_pids[c]||this.handlePESSlice(e,n+m,g,{pid:c,stream_type:_,file_position:r,payload_unit_start_indicator:s,continuity_conunter:u,random_access_indicator:p.random_access_indicator})}}n+=188,this.ts_packet_size_===204&&(n+=16)}return this.dispatchAudioVideoMediaSegment(),n},t.prototype.handleSectionSlice=function(e,t,n,r){var i=new Uint8Array(e,t,n),a=this.section_slice_queues_[r.pid];if(r.payload_unit_start_indicator){var o=i[0];if(a!=null&&a.total_length!==0){var s=new Uint8Array(e,t+1,Math.min(n,o));a.slices.push(s),a.total_length+=s.byteLength,a.total_length===a.expected_length?this.emitSectionSlices(a,r):this.clearSlices(a,r)}for(var c=1+o;c<i.byteLength&&i[c+0]!==255;){var l=(15&i[c+1])<<8|i[c+2];this.section_slice_queues_[r.pid]=new M,(a=this.section_slice_queues_[r.pid]).expected_length=l+3,a.file_position=r.file_position,a.random_access_indicator=r.random_access_indicator,s=new Uint8Array(e,t+c,Math.min(n-c,a.expected_length-a.total_length)),a.slices.push(s),a.total_length+=s.byteLength,a.total_length===a.expected_length?this.emitSectionSlices(a,r):a.total_length>=a.expected_length&&this.clearSlices(a,r),c+=s.byteLength}}else a!=null&&a.total_length!==0&&(s=new Uint8Array(e,t,Math.min(n,a.expected_length-a.total_length)),a.slices.push(s),a.total_length+=s.byteLength,a.total_length===a.expected_length?this.emitSectionSlices(a,r):a.total_length>=a.expected_length&&this.clearSlices(a,r))},t.prototype.handlePESSlice=function(e,t,n,r){var i=new Uint8Array(e,t,n),o=i[0]<<16|i[1]<<8|i[2],s=(i[3],i[4]<<8|i[5]);if(r.payload_unit_start_indicator){if(o!==1)return void a.a.e(this.TAG,`handlePESSlice: packet_start_code_prefix should be 1 but with value ${o}`);var c=this.pes_slice_queues_[r.pid];c&&(c.expected_length===0||c.expected_length===c.total_length?this.emitPESSlices(c,r):this.clearSlices(c,r)),this.pes_slice_queues_[r.pid]=new M,this.pes_slice_queues_[r.pid].file_position=r.file_position,this.pes_slice_queues_[r.pid].random_access_indicator=r.random_access_indicator}if(this.pes_slice_queues_[r.pid]!=null){var l=this.pes_slice_queues_[r.pid];l.slices.push(i),r.payload_unit_start_indicator&&(l.expected_length=s===0?0:s+6),l.total_length+=i.byteLength,l.expected_length>0&&l.expected_length===l.total_length?this.emitPESSlices(l,r):l.expected_length>0&&l.expected_length<l.total_length&&this.clearSlices(l,r)}},t.prototype.emitSectionSlices=function(e,t){for(var n=new Uint8Array(e.total_length),r=0,i=0;r<e.slices.length;r++){var a=e.slices[r];n.set(a,i),i+=a.byteLength}e.slices=[],e.expected_length=-1,e.total_length=0;var o=new j;o.pid=t.pid,o.data=n,o.file_position=e.file_position,o.random_access_indicator=e.random_access_indicator,this.parseSection(o)},t.prototype.emitPESSlices=function(e,t){for(var n=new Uint8Array(e.total_length),r=0,i=0;r<e.slices.length;r++){var a=e.slices[r];n.set(a,i),i+=a.byteLength}e.slices=[],e.expected_length=-1,e.total_length=0;var o=new A;o.pid=t.pid,o.data=n,o.stream_type=t.stream_type,o.file_position=e.file_position,o.random_access_indicator=e.random_access_indicator,this.parsePES(o)},t.prototype.clearSlices=function(e,t){e.slices=[],e.expected_length=-1,e.total_length=0},t.prototype.parseSection=function(e){var t=e.data,n=e.pid;n===0?this.parsePAT(t):n===this.current_pmt_pid_?this.parsePMT(t):this.pmt_!=null&&this.pmt_.scte_35_pids[n]&&this.parseSCTE35(t)},t.prototype.parsePES=function(e){var t=e.data,n=t[0]<<16|t[1]<<8|t[2],r=t[3],i=t[4]<<8|t[5];if(n===1)if(r!==188&&r!==190&&r!==191&&r!==240&&r!==241&&r!==255&&r!==242&&r!==248){t[6];var o=(192&t[7])>>>6,s=t[8],c=void 0,l=void 0;o!==2&&o!==3||(c=this.getTimestamp(t,9),l=o===3?this.getTimestamp(t,14):c);var u=9+s,d=void 0;if(i!==0){if(i<3+s)return void a.a.v(this.TAG,`Malformed PES: PES_packet_length < 3 + PES_header_data_length`);d=i-3-s}else d=t.byteLength-u;var f=t.subarray(u,u+d);switch(e.stream_type){case w.kMPEG1Audio:case w.kMPEG2Audio:this.parseMP3Payload(f,c);break;case w.kPESPrivateData:this.pmt_.common_pids.av1===e.pid?this.parseAV1Payload(f,c,l,e.file_position,e.random_access_indicator):this.pmt_.common_pids.opus===e.pid?this.parseOpusPayload(f,c):this.pmt_.common_pids.ac3===e.pid?this.parseAC3Payload(f,c):this.pmt_.common_pids.eac3===e.pid?this.parseEAC3Payload(f,c):this.pmt_.asynchronous_klv_pids[e.pid]?this.parseAsynchronousKLVMetadataPayload(f,e.pid,r):this.pmt_.smpte2038_pids[e.pid]?this.parseSMPTE2038MetadataPayload(f,c,l,e.pid,r):this.parsePESPrivateDataPayload(f,c,l,e.pid,r);break;case w.kADTSAAC:this.parseADTSAACPayload(f,c);break;case w.kLOASAAC:this.parseLOASAACPayload(f,c);break;case w.kAC3:this.parseAC3Payload(f,c);break;case w.kEAC3:this.parseEAC3Payload(f,c);break;case w.kMetadata:this.pmt_.timed_id3_pids[e.pid]?this.parseTimedID3MetadataPayload(f,c,l,e.pid,r):this.pmt_.synchronous_klv_pids[e.pid]&&this.parseSynchronousKLVMetadataPayload(f,c,l,e.pid,r);break;case w.kH264:this.parseH264Payload(f,c,l,e.file_position,e.random_access_indicator);break;case w.kH265:this.parseH265Payload(f,c,l,e.file_position,e.random_access_indicator)}}else (r===188||r===191||r===240||r===241||r===255||r===242||r===248)&&e.stream_type===w.kPESPrivateData&&(u=6,d=void 0,d=i===0?t.byteLength-u:i,f=t.subarray(u,u+d),this.parsePESPrivateDataPayload(f,void 0,void 0,e.pid,r));else a.a.e(this.TAG,`parsePES: packet_start_code_prefix should be 1 but with value ${n}`)},t.prototype.parsePAT=function(e){var t=e[0];if(t===0){var n=(15&e[1])<<8|e[2],r=(e[3],e[4],(62&e[5])>>>1),i=1&e[5],o=e[6],s=(e[7],null);if(i===1&&o===0)(s=new D).version_number=r;else if((s=this.pat_)==null)return;for(var c=n-5-4,l=-1,u=-1,d=8;d<8+c;d+=4){var f=e[d]<<8|e[d+1],p=(31&e[d+2])<<8|e[d+3];f===0?s.network_pid=p:(s.program_pmt_pid[f]=p,l===-1&&(l=f),u===-1&&(u=p))}i===1&&o===0&&(this.pat_??a.a.v(this.TAG,`Parsed first PAT: ${JSON.stringify(s)}`),this.pat_=s,this.current_program_=l,this.current_pmt_pid_=u)}else a.a.e(this.TAG,`parsePAT: table_id ${t} is not corresponded to PAT!`)},t.prototype.parsePMT=function(e){var t=e[0];if(t===2){var n=(15&e[1])<<8|e[2],r=e[3]<<8|e[4],i=(62&e[5])>>>1,o=1&e[5],s=e[6],c=(e[7],null);if(o===1&&s===0)(c=new k).program_number=r,c.version_number=i,this.program_pmt_map_[r]=c;else if((c=this.program_pmt_map_[r])==null)return;c.pcr_pid=(31&e[8])<<8|e[9];for(var l=(15&e[10])<<8|e[11],u=12+l,d=n-9-l-4,f=u;f<u+d;){var p=e[f],m=(31&e[f+1])<<8|e[f+2],h=(15&e[f+3])<<8|e[f+4];c.pid_stream_type[m]=p;var g=c.common_pids.h264||c.common_pids.h265,_=c.common_pids.adts_aac||c.common_pids.loas_aac||c.common_pids.ac3||c.common_pids.eac3||c.common_pids.opus||c.common_pids.mp3;if(p!==w.kH264||g)if(p!==w.kH265||g)if(p!==w.kADTSAAC||_)if(p!==w.kLOASAAC||_)if(p!==w.kAC3||_)if(p!==w.kEAC3||_)if(p!==w.kMPEG1Audio&&p!==w.kMPEG2Audio||_)if(p===w.kPESPrivateData){if(c.pes_private_data_pids[m]=!0,h>0){for(var v=f+5;v<f+5+h;){var y=e[v+0],b=e[v+1];if(y===5){var x=String.fromCharCode.apply(String,Array.from(e.subarray(v+2,v+2+b)));x===`VANC`?c.smpte2038_pids[m]=!0:x===`AV01`?c.common_pids.av1=m:x===`Opus`?c.common_pids.opus=m:x===`KLVA`&&(c.asynchronous_klv_pids[m]=!0)}else if(y===127){if(m===c.common_pids.opus){var S=null;if(e[v+2]===128&&(S=e[v+3]),S==null){a.a.e(this.TAG,`Not Supported Opus channel count.`);continue}var C={codec:`opus`,channel_count:15&S?15&S:2,channel_config_code:S,sample_rate:48e3},T={codec:`opus`,meta:C};this.audio_init_segment_dispatched_==0?(this.audio_metadata_=C,this.dispatchAudioInitSegment(T)):this.detectAudioMetadataChange(T)&&(this.dispatchAudioMediaSegment(),this.dispatchAudioInitSegment(T))}}else y===128&&m===c.common_pids.av1&&(this.video_metadata_.av1c=e.subarray(v+2,v+2+b));v+=2+b}var E=e.subarray(f+5,f+5+h);this.dispatchPESPrivateDataDescriptor(m,p,E)}}else if(p===w.kMetadata){if(h>0)for(v=f+5;v<f+5+h;){y=e[v+0];var D=e[v+1];if(y===38){var O=e[v+2]<<8|e[v+3]<<0,A=null;O===65535&&(A=String.fromCharCode.apply(String,Array.from(e.subarray(v+4,v+4+4))));var j=null;if(e[v+4+(O===65535?4:0)]===255){var M=4+(O===65535?4:0)+1;j=String.fromCharCode.apply(String,Array.from(e.subarray(v+M,v+M+4)))}A===`ID3 `&&j===`ID3 `?c.timed_id3_pids[m]=!0:j===`KLVA`&&(c.synchronous_klv_pids[m]=!0)}v+=2+D}}else p===w.kSCTE35&&(c.scte_35_pids[m]=!0);else c.common_pids.mp3=m;else c.common_pids.eac3=m;else c.common_pids.ac3=m;else c.common_pids.loas_aac=m;else c.common_pids.adts_aac=m;else c.common_pids.h265=m;else c.common_pids.h264=m;f+=5+h}r===this.current_program_&&(this.pmt_??a.a.v(this.TAG,`Parsed first PMT: ${JSON.stringify(c)}`),this.pmt_=c,(c.common_pids.h264||c.common_pids.h265||c.common_pids.av1)&&(this.has_video_=!0),(c.common_pids.adts_aac||c.common_pids.loas_aac||c.common_pids.ac3||c.common_pids.opus||c.common_pids.mp3)&&(this.has_audio_=!0))}else a.a.e(this.TAG,`parsePMT: table_id ${t} is not corresponded to PMT!`)},t.prototype.parseSCTE35=function(e){var t=ge(e);t.pts==null?t.nearest_pts=this.getNearestTimestampMilliseconds():t.pts=Math.floor(t.pts/this.timescale_),this.onSCTE35Metadata&&this.onSCTE35Metadata(t)},t.prototype.parseAV1Payload=function(e,t,n,r,i){for(var a=new je(e),o=null,s=[],c=0,l=!1,u=null;(o=a.readNextOBUPayload())!=null;){if((u=C.parseOBUs(o,this.video_metadata_.details))&&!0===u.keyframe)if(this.video_init_segment_dispatched_){if(!0===this.detectVideoMetadataChange(null,u)){var d;this.video_metadata_changed_=!0,this.dispatchVideoMediaSegment(),(d=new Uint8Array(new ArrayBuffer(this.video_metadata_.av1c.byteLength+u.sequence_header_data.byteLength))).set(this.video_metadata_.av1c,0),d.set(u.sequence_header_data,this.video_metadata_.av1c.byteLength),u.av1c=d,this.dispatchVideoInitSegment()}}else (d=new Uint8Array(new ArrayBuffer(this.video_metadata_.av1c.byteLength+u.sequence_header_data.byteLength))).set(this.video_metadata_.av1c,0),d.set(u.sequence_header_data,this.video_metadata_.av1c.byteLength),u.av1c=d,this.video_metadata_.details=u,this.dispatchVideoInitSegment();this.video_metadata_.details=u,l||=u.keyframe,s.push({data:o}),c+=o.byteLength}var f=Math.floor(t/this.timescale_),p=Math.floor(n/this.timescale_);if(s.length){var m=this.video_track_,h={units:s,length:c,isKeyframe:l,dts:p,pts:f,cts:f-p,file_position:r};m.samples.push(h),m.length+=c}},t.prototype.parseH264Payload=function(e,t,n,r,i){for(var o=new L(e),s=null,c=[],l=0,u=!1;(s=o.readNextNaluPayload())!=null;){var d=new I(s);if(d.type===O.kSliceSPS){var f=h.parseSPS(s.data);this.video_init_segment_dispatched_?!0===this.detectVideoMetadataChange(d,f)&&(a.a.v(this.TAG,`H264: Critical h264 metadata has been changed, attempt to re-generate InitSegment`),this.video_metadata_changed_=!0,this.video_metadata_={vps:void 0,sps:d,pps:void 0,av1c:void 0,details:f}):(this.video_metadata_.sps=d,this.video_metadata_.details=f)}else d.type===O.kSlicePPS?this.video_init_segment_dispatched_&&!this.video_metadata_changed_||(this.video_metadata_.pps=d,this.video_metadata_.sps&&this.video_metadata_.pps&&(this.video_metadata_changed_&&this.dispatchVideoMediaSegment(),this.dispatchVideoInitSegment())):(d.type===O.kSliceIDR||d.type===O.kSliceNonIDR&&i===1)&&(u=!0);this.video_init_segment_dispatched_&&(c.push(d),l+=d.data.byteLength)}var p=Math.floor(t/this.timescale_),m=Math.floor(n/this.timescale_);if(c.length){var g=this.video_track_,_={units:c,length:l,isKeyframe:u,dts:m,pts:p,cts:p-m,file_position:r};g.samples.push(_),g.length+=l}},t.prototype.parseH265Payload=function(e,t,n,r,i){for(var o=new ye(e),s=null,c=[],l=0,u=!1;(s=o.readNextNaluPayload())!=null;){var d=new ve(s);if(d.type===se.kSliceVPS){if(!this.video_init_segment_dispatched_){var f=_.parseVPS(s.data);this.video_metadata_.vps=d,this.video_metadata_.details=Ne(Ne({},this.video_metadata_.details),f)}}else d.type===se.kSliceSPS?(f=_.parseSPS(s.data),this.video_init_segment_dispatched_?!0===this.detectVideoMetadataChange(d,f)&&(a.a.v(this.TAG,`H265: Critical h265 metadata has been changed, attempt to re-generate InitSegment`),this.video_metadata_changed_=!0,this.video_metadata_={vps:void 0,sps:d,pps:void 0,av1c:void 0,details:f}):(this.video_metadata_.sps=d,this.video_metadata_.details=Ne(Ne({},this.video_metadata_.details),f))):d.type===se.kSlicePPS?(!this.video_init_segment_dispatched_||this.video_metadata_changed_)&&(f=_.parsePPS(s.data),this.video_metadata_.pps=d,this.video_metadata_.details=Ne(Ne({},this.video_metadata_.details),f),this.video_metadata_.vps&&this.video_metadata_.sps&&this.video_metadata_.pps&&(this.video_metadata_changed_&&this.dispatchVideoMediaSegment(),this.dispatchVideoInitSegment())):d.type!==se.kSliceIDR_W_RADL&&d.type!==se.kSliceIDR_N_LP&&d.type!==se.kSliceCRA_NUT||(u=!0);this.video_init_segment_dispatched_&&(c.push(d),l+=d.data.byteLength)}var p=Math.floor(t/this.timescale_),m=Math.floor(n/this.timescale_);if(c.length){var h=this.video_track_,g={units:c,length:l,isKeyframe:u,dts:m,pts:p,cts:p-m,file_position:r};h.samples.push(g),h.length+=l}},t.prototype.detectVideoMetadataChange=function(e,t){if(t.codec_mimetype!==this.video_metadata_.details.codec_mimetype)return a.a.v(this.TAG,`Video: Codec mimeType changed from ${this.video_metadata_.details.codec_mimetype} to ${t.codec_mimetype}`),!0;if(t.codec_size.width!==this.video_metadata_.details.codec_size.width||t.codec_size.height!==this.video_metadata_.details.codec_size.height){var n=this.video_metadata_.details.codec_size,r=t.codec_size;return a.a.v(this.TAG,`Video: Coded Resolution changed from ${n.width}x${n.height} to ${r.width}x${r.height}`),!0}return t.present_size.width!==this.video_metadata_.details.present_size.width&&(a.a.v(this.TAG,`Video: Present resolution width changed from ${this.video_metadata_.details.present_size.width} to ${t.present_size.width}`),!0)},t.prototype.isInitSegmentDispatched=function(){return this.has_video_&&this.has_audio_?this.video_init_segment_dispatched_&&this.audio_init_segment_dispatched_:this.has_video_&&!this.has_audio_?this.video_init_segment_dispatched_:!(this.has_video_||!this.has_audio_)&&this.audio_init_segment_dispatched_},t.prototype.dispatchVideoInitSegment=function(){var e=this.video_metadata_.details,t={type:`video`};if(t.id=this.video_track_.id,t.timescale=1e3,t.duration=this.duration_,t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height,t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t.sarRatio=e.sar_ratio,t.frameRate=e.frame_rate,t.refSampleDuration=t.frameRate.fps_den/t.frameRate.fps_num*1e3,t.codec=e.codec_mimetype,this.video_metadata_.av1c)t.av1c=this.video_metadata_.av1c,this.video_init_segment_dispatched_==0&&a.a.v(this.TAG,`Generated first AV1 for mimeType: ${t.codec}`);else if(this.video_metadata_.vps){var n=this.video_metadata_.vps.data.subarray(4),r=this.video_metadata_.sps.data.subarray(4),i=this.video_metadata_.pps.data.subarray(4);t.hvcc=new be(n,r,i,e).getData(),this.video_init_segment_dispatched_==0&&a.a.v(this.TAG,`Generated first HEVCDecoderConfigurationRecord for mimeType: ${t.codec}`)}else r=this.video_metadata_.sps.data.subarray(4),i=this.video_metadata_.pps.data.subarray(4),t.avcc=new R(r,i,e).getData(),this.video_init_segment_dispatched_==0&&a.a.v(this.TAG,`Generated first AVCDecoderConfigurationRecord for mimeType: ${t.codec}`);this.onTrackMetadata(`video`,t),this.video_init_segment_dispatched_=!0,this.video_metadata_changed_=!1;var o=this.media_info_;o.hasVideo=!0,o.width=t.codecWidth,o.height=t.codecHeight,o.fps=t.frameRate.fps,o.profile=t.profile,o.level=t.level,o.refFrames=e.ref_frames,o.chromaFormat=e.chroma_format_string,o.sarNum=t.sarRatio.width,o.sarDen=t.sarRatio.height,o.videoCodec=t.codec,o.hasAudio&&o.audioCodec?o.mimeType=`video/mp2t; codecs="${o.videoCodec},${o.audioCodec}"`:o.mimeType=`video/mp2t; codecs="${o.videoCodec}"`,o.isComplete()&&this.onMediaInfo(o)},t.prototype.dispatchVideoMediaSegment=function(){this.isInitSegmentDispatched()&&this.video_track_.length&&this.onDataAvailable(null,this.video_track_)},t.prototype.dispatchAudioMediaSegment=function(){this.isInitSegmentDispatched()&&this.audio_track_.length&&this.onDataAvailable(this.audio_track_,null)},t.prototype.dispatchAudioVideoMediaSegment=function(){this.isInitSegmentDispatched()&&(this.audio_track_.length||this.video_track_.length)&&this.onDataAvailable(this.audio_track_,this.video_track_)},t.prototype.parseADTSAACPayload=function(e,t){if(!this.has_video_||this.video_init_segment_dispatched_){if(this.aac_last_incomplete_data_){var n=new Uint8Array(e.byteLength+this.aac_last_incomplete_data_.byteLength);n.set(this.aac_last_incomplete_data_,0),n.set(e,this.aac_last_incomplete_data_.byteLength),e=n}var r,i;if(t!=null&&(i=t/this.timescale_),this.audio_metadata_.codec===`aac`){if(t==null&&this.audio_last_sample_pts_!=null)r=1024/this.audio_metadata_.sampling_frequency*1e3,i=this.audio_last_sample_pts_+r;else if(t==null)return void a.a.w(this.TAG,`AAC: Unknown pts`);if(this.aac_last_incomplete_data_&&this.audio_last_sample_pts_){r=1024/this.audio_metadata_.sampling_frequency*1e3;var o=this.audio_last_sample_pts_+r;Math.abs(o-i)>1&&(a.a.w(this.TAG,`AAC: Detected pts overlapped, expected: ${o}ms, PES pts: ${i}ms`),i=o)}}for(var s,c=new ne(e),l=null,u=i;(l=c.readNextAACFrame())!=null;){r=1024/l.sampling_frequency*1e3;var d={codec:`aac`,data:l};this.audio_init_segment_dispatched_==0?(this.audio_metadata_={codec:`aac`,audio_object_type:l.audio_object_type,sampling_freq_index:l.sampling_freq_index,sampling_frequency:l.sampling_frequency,channel_config:l.channel_config},this.dispatchAudioInitSegment(d)):this.detectAudioMetadataChange(d)&&(this.dispatchAudioMediaSegment(),this.dispatchAudioInitSegment(d)),s=u;var f=Math.floor(u),p={unit:l.data,length:l.data.byteLength,pts:f,dts:f};this.audio_track_.samples.push(p),this.audio_track_.length+=l.data.byteLength,u+=r}c.hasIncompleteData()&&(this.aac_last_incomplete_data_=c.getIncompleteData()),s&&(this.audio_last_sample_pts_=s)}},t.prototype.parseLOASAACPayload=function(e,t){if(!this.has_video_||this.video_init_segment_dispatched_){if(this.aac_last_incomplete_data_){var n=new Uint8Array(e.byteLength+this.aac_last_incomplete_data_.byteLength);n.set(this.aac_last_incomplete_data_,0),n.set(e,this.aac_last_incomplete_data_.byteLength),e=n}var r,i;if(t!=null&&(i=t/this.timescale_),this.audio_metadata_.codec===`aac`){if(t==null&&this.audio_last_sample_pts_!=null)r=1024/this.audio_metadata_.sampling_frequency*1e3,i=this.audio_last_sample_pts_+r;else if(t==null)return void a.a.w(this.TAG,`AAC: Unknown pts`);if(this.aac_last_incomplete_data_&&this.audio_last_sample_pts_){r=1024/this.audio_metadata_.sampling_frequency*1e3;var o=this.audio_last_sample_pts_+r;Math.abs(o-i)>1&&(a.a.w(this.TAG,`AAC: Detected pts overlapped, expected: ${o}ms, PES pts: ${i}ms`),i=o)}}for(var s,c=new re(e),l=null,u=i;(l=c.readNextAACFrame(this.loas_previous_frame??void 0))!=null;){this.loas_previous_frame=l,r=1024/l.sampling_frequency*1e3;var d={codec:`aac`,data:l};this.audio_init_segment_dispatched_==0?(this.audio_metadata_={codec:`aac`,audio_object_type:l.audio_object_type,sampling_freq_index:l.sampling_freq_index,sampling_frequency:l.sampling_frequency,channel_config:l.channel_config},this.dispatchAudioInitSegment(d)):this.detectAudioMetadataChange(d)&&(this.dispatchAudioMediaSegment(),this.dispatchAudioInitSegment(d)),s=u;var f=Math.floor(u),p={unit:l.data,length:l.data.byteLength,pts:f,dts:f};this.audio_track_.samples.push(p),this.audio_track_.length+=l.data.byteLength,u+=r}c.hasIncompleteData()&&(this.aac_last_incomplete_data_=c.getIncompleteData()),s&&(this.audio_last_sample_pts_=s)}},t.prototype.parseAC3Payload=function(e,t){if(!this.has_video_||this.video_init_segment_dispatched_){var n,r;if(t!=null&&(r=t/this.timescale_),this.audio_metadata_.codec===`ac-3`){if(t==null&&this.audio_last_sample_pts_!=null)n=1536/this.audio_metadata_.sampling_frequency*1e3,r=this.audio_last_sample_pts_+n;else if(t==null)return void a.a.w(this.TAG,`AC3: Unknown pts`)}for(var i,o=new Te(e),s=null,c=r;(s=o.readNextAC3Frame())!=null;){n=1536/s.sampling_frequency*1e3;var l={codec:`ac-3`,data:s};this.audio_init_segment_dispatched_==0?(this.audio_metadata_={codec:`ac-3`,sampling_frequency:s.sampling_frequency,bit_stream_identification:s.bit_stream_identification,bit_stream_mode:s.bit_stream_mode,low_frequency_effects_channel_on:s.low_frequency_effects_channel_on,channel_mode:s.channel_mode},this.dispatchAudioInitSegment(l)):this.detectAudioMetadataChange(l)&&(this.dispatchAudioMediaSegment(),this.dispatchAudioInitSegment(l)),i=c;var u=Math.floor(c),d={unit:s.data,length:s.data.byteLength,pts:u,dts:u};this.audio_track_.samples.push(d),this.audio_track_.length+=s.data.byteLength,c+=n}i&&(this.audio_last_sample_pts_=i)}},t.prototype.parseEAC3Payload=function(e,t){if(!this.has_video_||this.video_init_segment_dispatched_){var n,r;if(t!=null&&(r=t/this.timescale_),this.audio_metadata_.codec===`ec-3`){if(t==null&&this.audio_last_sample_pts_!=null)n=256*this.audio_metadata_.num_blks/this.audio_metadata_.sampling_frequency*1e3,r=this.audio_last_sample_pts_+n;else if(t==null)return void a.a.w(this.TAG,`EAC3: Unknown pts`)}for(var i,o=new Oe(e),s=null,c=r;(s=o.readNextEAC3Frame())!=null;){n=1536/s.sampling_frequency*1e3;var l={codec:`ec-3`,data:s};this.audio_init_segment_dispatched_==0?(this.audio_metadata_={codec:`ec-3`,sampling_frequency:s.sampling_frequency,bit_stream_identification:s.bit_stream_identification,low_frequency_effects_channel_on:s.low_frequency_effects_channel_on,num_blks:s.num_blks,channel_mode:s.channel_mode},this.dispatchAudioInitSegment(l)):this.detectAudioMetadataChange(l)&&(this.dispatchAudioMediaSegment(),this.dispatchAudioInitSegment(l)),i=c;var u=Math.floor(c),d={unit:s.data,length:s.data.byteLength,pts:u,dts:u};this.audio_track_.samples.push(d),this.audio_track_.length+=s.data.byteLength,c+=n}i&&(this.audio_last_sample_pts_=i)}},t.prototype.parseOpusPayload=function(e,t){if(!this.has_video_||this.video_init_segment_dispatched_){var n,r;if(t!=null&&(r=t/this.timescale_),this.audio_metadata_.codec===`opus`){if(t==null&&this.audio_last_sample_pts_!=null)n=20,r=this.audio_last_sample_pts_+n;else if(t==null)return void a.a.w(this.TAG,`Opus: Unknown pts`)}for(var i,o=r,s=0;s<e.length;){n=20;for(var c=(16&e[s+1])!=0,l=(8&e[s+1])!=0,u=s+2,d=0;e[u]===255;)d+=255,u+=1;d+=e[u],u+=1,u+=c?2:0,u+=l?2:0,i=o;var f=Math.floor(o),p=e.slice(u,u+d),m={unit:p,length:p.byteLength,pts:f,dts:f};this.audio_track_.samples.push(m),this.audio_track_.length+=p.byteLength,o+=n,s=u+d}i&&(this.audio_last_sample_pts_=i)}},t.prototype.parseMP3Payload=function(e,t){if(!this.has_video_||this.video_init_segment_dispatched_){var n=[0,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1],r=[0,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1],i=[0,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1],a=e[1]>>>3&3,o=(6&e[1])>>1,s=(240&e[2])>>>4,c=(12&e[2])>>>2,l=(e[3]>>>6&3)==3?1:2,u=0,d=34;switch(a){case 0:u=[11025,12e3,8e3,0][c];break;case 2:u=[22050,24e3,16e3,0][c];break;case 3:u=[44100,48e3,32e3,0][c]}switch(o){case 1:d=34,s<i.length&&i[s];break;case 2:d=33,s<r.length&&r[s];break;case 3:d=32,s<n.length&&n[s]}var f=new Se;f.object_type=d,f.sample_rate=u,f.channel_count=l,f.data=e;var p={codec:`mp3`,data:f};this.audio_init_segment_dispatched_==0?(this.audio_metadata_={codec:`mp3`,object_type:d,sample_rate:u,channel_count:l},this.dispatchAudioInitSegment(p)):this.detectAudioMetadataChange(p)&&(this.dispatchAudioMediaSegment(),this.dispatchAudioInitSegment(p));var m={unit:e,length:e.byteLength,pts:t/this.timescale_,dts:t/this.timescale_};this.audio_track_.samples.push(m),this.audio_track_.length+=e.byteLength}},t.prototype.detectAudioMetadataChange=function(e){if(e.codec!==this.audio_metadata_.codec)return a.a.v(this.TAG,`Audio: Audio Codecs changed from ${this.audio_metadata_.codec} to ${e.codec}`),!0;if(e.codec===`aac`&&this.audio_metadata_.codec===`aac`){if((t=e.data).audio_object_type!==this.audio_metadata_.audio_object_type)return a.a.v(this.TAG,`AAC: AudioObjectType changed from ${this.audio_metadata_.audio_object_type} to ${t.audio_object_type}`),!0;if(t.sampling_freq_index!==this.audio_metadata_.sampling_freq_index)return a.a.v(this.TAG,`AAC: SamplingFrequencyIndex changed from ${this.audio_metadata_.sampling_freq_index} to ${t.sampling_freq_index}`),!0;if(t.channel_config!==this.audio_metadata_.channel_config)return a.a.v(this.TAG,`AAC: Channel configuration changed from ${this.audio_metadata_.channel_config} to ${t.channel_config}`),!0}else if(e.codec===`ac-3`&&this.audio_metadata_.codec===`ac-3`){var t;if((t=e.data).sampling_frequency!==this.audio_metadata_.sampling_frequency)return a.a.v(this.TAG,`AC3: Sampling Frequency changed from ${this.audio_metadata_.sampling_frequency} to ${t.sampling_frequency}`),!0;if(t.bit_stream_identification!==this.audio_metadata_.bit_stream_identification)return a.a.v(this.TAG,`AC3: Bit Stream Identification changed from ${this.audio_metadata_.bit_stream_identification} to ${t.bit_stream_identification}`),!0;if(t.bit_stream_mode!==this.audio_metadata_.bit_stream_mode)return a.a.v(this.TAG,`AC3: BitStream Mode changed from ${this.audio_metadata_.bit_stream_mode} to ${t.bit_stream_mode}`),!0;if(t.channel_mode!==this.audio_metadata_.channel_mode)return a.a.v(this.TAG,`AC3: Channel Mode changed from ${this.audio_metadata_.channel_mode} to ${t.channel_mode}`),!0;if(t.low_frequency_effects_channel_on!==this.audio_metadata_.low_frequency_effects_channel_on)return a.a.v(this.TAG,`AC3: Low Frequency Effects Channel On changed from ${this.audio_metadata_.low_frequency_effects_channel_on} to ${t.low_frequency_effects_channel_on}`),!0}else if(e.codec===`opus`&&this.audio_metadata_.codec===`opus`){if((n=e.meta).sample_rate!==this.audio_metadata_.sample_rate)return a.a.v(this.TAG,`Opus: SamplingFrequencyIndex changed from ${this.audio_metadata_.sample_rate} to ${n.sample_rate}`),!0;if(n.channel_count!==this.audio_metadata_.channel_count)return a.a.v(this.TAG,`Opus: Channel count changed from ${this.audio_metadata_.channel_count} to ${n.channel_count}`),!0}else if(e.codec===`mp3`&&this.audio_metadata_.codec===`mp3`){var n;if((n=e.data).object_type!==this.audio_metadata_.object_type)return a.a.v(this.TAG,`MP3: AudioObjectType changed from ${this.audio_metadata_.object_type} to ${n.object_type}`),!0;if(n.sample_rate!==this.audio_metadata_.sample_rate)return a.a.v(this.TAG,`MP3: SamplingFrequencyIndex changed from ${this.audio_metadata_.sample_rate} to ${n.sample_rate}`),!0;if(n.channel_count!==this.audio_metadata_.channel_count)return a.a.v(this.TAG,`MP3: Channel count changed from ${this.audio_metadata_.channel_count} to ${n.channel_count}`),!0}return!1},t.prototype.dispatchAudioInitSegment=function(e){var t={type:`audio`};if(t.id=this.audio_track_.id,t.timescale=1e3,t.duration=this.duration_,this.audio_metadata_.codec===`aac`){var n=new ie(e.codec===`aac`?e.data:null);t.audioSampleRate=n.sampling_rate,t.channelCount=n.channel_count,t.codec=n.codec_mimetype,t.originalCodec=n.original_codec_mimetype,t.config=n.config,t.refSampleDuration=1024/t.audioSampleRate*t.timescale}else if(this.audio_metadata_.codec===`ac-3`){var r=new Ee(e.codec===`ac-3`?e.data:null);t.audioSampleRate=r.sampling_rate,t.channelCount=r.channel_count,t.codec=r.codec_mimetype,t.originalCodec=r.original_codec_mimetype,t.config=r.config,t.refSampleDuration=1536/t.audioSampleRate*t.timescale}else if(this.audio_metadata_.codec===`ec-3`){var i=new ke(e.codec===`ec-3`?e.data:null);t.audioSampleRate=i.sampling_rate,t.channelCount=i.channel_count,t.codec=i.codec_mimetype,t.originalCodec=i.original_codec_mimetype,t.config=i.config,t.refSampleDuration=256*i.num_blks/t.audioSampleRate*t.timescale}else this.audio_metadata_.codec===`opus`?(t.audioSampleRate=this.audio_metadata_.sample_rate,t.channelCount=this.audio_metadata_.channel_count,t.channelConfigCode=this.audio_metadata_.channel_config_code,t.codec=`opus`,t.originalCodec=`opus`,t.config=void 0,t.refSampleDuration=20):this.audio_metadata_.codec===`mp3`&&(t.audioSampleRate=this.audio_metadata_.sample_rate,t.channelCount=this.audio_metadata_.channel_count,t.codec=`mp3`,t.originalCodec=`mp3`,t.config=void 0);this.audio_init_segment_dispatched_==0&&a.a.v(this.TAG,`Generated first AudioSpecificConfig for mimeType: ${t.codec}`),this.onTrackMetadata(`audio`,t),this.audio_init_segment_dispatched_=!0,this.video_metadata_changed_=!1;var o=this.media_info_;o.hasAudio=!0,o.audioCodec=t.originalCodec,o.audioSampleRate=t.audioSampleRate,o.audioChannelCount=t.channelCount,o.hasVideo&&o.videoCodec?o.mimeType=`video/mp2t; codecs="${o.videoCodec},${o.audioCodec}"`:o.mimeType=`video/mp2t; codecs="${o.audioCodec}"`,o.isComplete()&&this.onMediaInfo(o)},t.prototype.dispatchPESPrivateDataDescriptor=function(e,t,n){var r=new oe;r.pid=e,r.stream_type=t,r.descriptor=n,this.onPESPrivateDataDescriptor&&this.onPESPrivateDataDescriptor(r)},t.prototype.parsePESPrivateDataPayload=function(e,t,n,r,i){var a=new ae;a.pid=r,a.stream_id=i,a.len=e.byteLength,a.data=e,t==null?a.nearest_pts=this.getNearestTimestampMilliseconds():a.pts=Math.floor(t/this.timescale_),n!=null&&(a.dts=Math.floor(n/this.timescale_)),this.onPESPrivateData&&this.onPESPrivateData(a)},t.prototype.parseTimedID3MetadataPayload=function(e,t,n,r,i){var a=new ae;a.pid=r,a.stream_id=i,a.len=e.byteLength,a.data=e,t!=null&&(a.pts=Math.floor(t/this.timescale_)),n!=null&&(a.dts=Math.floor(n/this.timescale_)),this.onTimedID3Metadata&&this.onTimedID3Metadata(a)},t.prototype.parseSynchronousKLVMetadataPayload=function(e,t,n,r,i){var a=new Ae;a.pid=r,a.stream_id=i,a.len=e.byteLength,a.data=e,t!=null&&(a.pts=Math.floor(t/this.timescale_)),n!=null&&(a.dts=Math.floor(n/this.timescale_)),a.access_units=function(e){for(var t=[],n=0;n+5<e.byteLength;){var r=e[n+0],i=e[n+1],a=e[n+2],o=e[n+3]<<8|e[n+4]<<0,s=e.slice(n+5,n+5+o);t.push({service_id:r,sequence_number:i,flags:a,data:s}),n+=5+o}return t}(e),this.onSynchronousKLVMetadata&&this.onSynchronousKLVMetadata(a)},t.prototype.parseAsynchronousKLVMetadataPayload=function(e,t,n){var r=new ae;r.pid=t,r.stream_id=n,r.len=e.byteLength,r.data=e,this.onAsynchronousKLVMetadata&&this.onAsynchronousKLVMetadata(r)},t.prototype.parseSMPTE2038MetadataPayload=function(e,t,n,r,i){var a=new xe;a.pid=r,a.stream_id=i,a.len=e.byteLength,a.data=e,t!=null&&(a.pts=Math.floor(t/this.timescale_)),a.nearest_pts=this.getNearestTimestampMilliseconds(),n!=null&&(a.dts=Math.floor(n/this.timescale_)),a.ancillaries=function(e){for(var t=new m(e),n=0,r=[];n+=6,t.readBits(6)===0;){var i=t.readBool();n+=1;var a=t.readBits(11);n+=11;var o=t.readBits(12);n+=12;var s=255&t.readBits(10);n+=10;var c=255&t.readBits(10);n+=10;var l=255&t.readBits(10);n+=10;for(var u=new Uint8Array(l),d=0;d<l;d++){var f=255&t.readBits(10);n+=10,u[d]=f}t.readBits(10),n+=10;var p=`User Defined`;s===65?c===7&&(p=`SCTE-104`):s===95?c===220?p=`ARIB STD-B37 (1SEG)`:c===221?p=`ARIB STD-B37 (ANALOG)`:c===222?p=`ARIB STD-B37 (SD)`:c===223&&(p=`ARIB STD-B37 (HD)`):s===97&&(c===1?p=`EIA-708`:c===2&&(p=`EIA-608`)),r.push({yc_indicator:i,line_number:a,horizontal_offset:o,did:s,sdid:c,user_data:u,description:p,information:{}}),t.readBits(8-(n-Math.floor(n/8))%8),n+=(8-(n-Math.floor(n/8)))%8}return t.destroy(),t=null,r}(e),this.onSMPTE2038Metadata&&this.onSMPTE2038Metadata(a)},t.prototype.getNearestTimestampMilliseconds=function(){return this.audio_last_sample_pts_==null?this.last_pcr_==null?void 0:Math.floor(this.last_pcr_/300/this.timescale_):Math.floor(this.audio_last_sample_pts_)},t.prototype.getPcrBase=function(e){var t=33554432*e[6]+131072*e[7]+512*e[8]+2*e[9]+(128&e[10])/128+this.timestamp_offset_;return t+4294967296<this.last_pcr_base_&&(t+=8589934592,this.timestamp_offset_+=8589934592),this.last_pcr_base_=t,t},t.prototype.getTimestamp=function(e,t){var n=536870912*(14&e[t])+4194304*(255&e[t+1])+16384*(254&e[t+2])+128*(255&e[t+3])+(254&e[t+4])/2+this.timestamp_offset_;return n+4294967296<this.last_pcr_base_&&(n+=8589934592),n},t}(E),Fe=function(e,t,n){if(n||arguments.length===2)for(var r,i=0,a=t.length;i<a;i++)!r&&i in t||(r||=Array.prototype.slice.call(t,0,i),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))},Ie=function(){function e(){}return e.init=function(){for(var t in e.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],hvc1:[],hvcC:[],av01:[],av1C:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[],".mp3":[],Opus:[],dOps:[],"ac-3":[],dac3:[],"ec-3":[],dec3:[],fLaC:[],dfLa:[]},e.types)e.types.hasOwnProperty(t)&&(e.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);var n=e.constants={};n.FTYP=new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]),n.STSD_PREFIX=new Uint8Array([0,0,0,0,0,0,0,1]),n.STTS=new Uint8Array([0,0,0,0,0,0,0,0]),n.STSC=n.STCO=n.STTS,n.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),n.HDLR_VIDEO=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),n.HDLR_AUDIO=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]),n.DREF=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),n.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),n.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])},e.box=function(e){for(var t=8,n=null,r=Array.prototype.slice.call(arguments,1),i=r.length,a=0;a<i;a++)t+=r[a].byteLength;(n=new Uint8Array(t))[0]=t>>>24&255,n[1]=t>>>16&255,n[2]=t>>>8&255,n[3]=255&t,n.set(e,4);var o=8;for(a=0;a<i;a++)n.set(r[a],o),o+=r[a].byteLength;return n},e.generateInitSegment=function(t){var n=e.box(e.types.ftyp,e.constants.FTYP),r=e.moov(t),i=new Uint8Array(n.byteLength+r.byteLength);return i.set(n,0),i.set(r,n.byteLength),i},e.moov=function(t){var n=e.mvhd(t.timescale,t.duration),r=e.trak(t),i=e.mvex(t);return e.box(e.types.moov,n,r,i)},e.mvhd=function(t,n){return e.box(e.types.mvhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,n>>>24&255,n>>>16&255,n>>>8&255,255&n,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]))},e.trak=function(t){return e.box(e.types.trak,e.tkhd(t),e.mdia(t))},e.tkhd=function(t){var n=t.id,r=t.duration,i=t.presentWidth,a=t.presentHeight;return e.box(e.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,n>>>24&255,n>>>16&255,n>>>8&255,255&n,0,0,0,0,r>>>24&255,r>>>16&255,r>>>8&255,255&r,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,i>>>8&255,255&i,0,0,a>>>8&255,255&a,0,0]))},e.mdia=function(t){return e.box(e.types.mdia,e.mdhd(t),e.hdlr(t),e.minf(t))},e.mdhd=function(t){var n=t.timescale,r=t.duration;return e.box(e.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,n>>>24&255,n>>>16&255,n>>>8&255,255&n,r>>>24&255,r>>>16&255,r>>>8&255,255&r,85,196,0,0]))},e.hdlr=function(t){var n=null;return n=t.type===`audio`?e.constants.HDLR_AUDIO:e.constants.HDLR_VIDEO,e.box(e.types.hdlr,n)},e.minf=function(t){var n=null;return n=t.type===`audio`?e.box(e.types.smhd,e.constants.SMHD):e.box(e.types.vmhd,e.constants.VMHD),e.box(e.types.minf,n,e.dinf(),e.stbl(t))},e.dinf=function(){return e.box(e.types.dinf,e.box(e.types.dref,e.constants.DREF))},e.stbl=function(t){return e.box(e.types.stbl,e.stsd(t),e.box(e.types.stts,e.constants.STTS),e.box(e.types.stsc,e.constants.STSC),e.box(e.types.stsz,e.constants.STSZ),e.box(e.types.stco,e.constants.STCO))},e.stsd=function(t){return t.type===`audio`?t.codec===`mp3`?e.box(e.types.stsd,e.constants.STSD_PREFIX,e.mp3(t)):t.codec===`ac-3`?e.box(e.types.stsd,e.constants.STSD_PREFIX,e.ac3(t)):t.codec===`ec-3`?e.box(e.types.stsd,e.constants.STSD_PREFIX,e.ec3(t)):t.codec===`opus`?e.box(e.types.stsd,e.constants.STSD_PREFIX,e.Opus(t)):t.codec==`flac`?e.box(e.types.stsd,e.constants.STSD_PREFIX,e.fLaC(t)):e.box(e.types.stsd,e.constants.STSD_PREFIX,e.mp4a(t)):t.type===`video`&&t.codec.startsWith(`hvc1`)?e.box(e.types.stsd,e.constants.STSD_PREFIX,e.hvc1(t)):t.type===`video`&&t.codec.startsWith(`av01`)?e.box(e.types.stsd,e.constants.STSD_PREFIX,e.av01(t)):e.box(e.types.stsd,e.constants.STSD_PREFIX,e.avc1(t))},e.mp3=function(t){var n=t.channelCount,r=t.audioSampleRate,i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,n,0,16,0,0,0,0,r>>>8&255,255&r,0,0]);return e.box(e.types[`.mp3`],i)},e.mp4a=function(t){var n=t.channelCount,r=t.audioSampleRate,i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,n,0,16,0,0,0,0,r>>>8&255,255&r,0,0]);return e.box(e.types.mp4a,i,e.esds(t))},e.ac3=function(t){var n=t.channelCount,r=t.audioSampleRate,i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,n,0,16,0,0,0,0,r>>>8&255,255&r,0,0]);return e.box(e.types[`ac-3`],i,e.box(e.types.dac3,new Uint8Array(t.config)))},e.ec3=function(t){var n=t.channelCount,r=t.audioSampleRate,i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,n,0,16,0,0,0,0,r>>>8&255,255&r,0,0]);return e.box(e.types[`ec-3`],i,e.box(e.types.dec3,new Uint8Array(t.config)))},e.esds=function(t){var n=t.config||[],r=n.length,i=new Uint8Array([0,0,0,0,3,23+r,0,1,0,4,15+r,64,21,0,0,0,0,0,0,0,0,0,0,0,5,r].concat(n,[6,1,2]));return e.box(e.types.esds,i)},e.Opus=function(t){var n=t.channelCount,r=t.audioSampleRate,i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,n,0,16,0,0,0,0,r>>>8&255,255&r,0,0]);return e.box(e.types.Opus,i,e.dOps(t))},e.dOps=function(t){var n=t.channelCount,r=t.channelConfigCode,i=t.audioSampleRate;if(t.config)return e.box(e.types.dOps,t.config);var a=[];switch(r){case 1:case 2:a=[0];break;case 0:a=[255,1,1,0,1];break;case 128:a=[255,2,0,0,1];break;case 3:a=[1,2,1,0,2,1];break;case 4:a=[1,2,2,0,1,2,3];break;case 5:a=[1,3,2,0,4,1,2,3];break;case 6:a=[1,4,2,0,4,1,2,3,5];break;case 7:a=[1,4,2,0,4,1,2,3,5,6];break;case 8:a=[1,5,3,0,6,1,2,3,4,5,7];break;case 130:a=[1,1,2,0,1];break;case 131:a=[1,1,3,0,1,2];break;case 132:a=[1,1,4,0,1,2,3];break;case 133:a=[1,1,5,0,1,2,3,4];break;case 134:a=[1,1,6,0,1,2,3,4,5];break;case 135:a=[1,1,7,0,1,2,3,4,5,6];break;case 136:a=[1,1,8,0,1,2,3,4,5,6,7]}var o=new Uint8Array(Fe([0,n,0,0,i>>>24&255,i>>>17&255,i>>>8&255,i>>>0&255,0,0],a,!0));return e.box(e.types.dOps,o)},e.fLaC=function(t){var n=t.channelCount,r=Math.min(t.audioSampleRate,65535),i=t.sampleSize,a=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,n,0,i,0,0,0,0,r>>>8&255,255&r,0,0]);return e.box(e.types.fLaC,a,e.dfLa(t))},e.dfLa=function(t){var n=new Uint8Array(Fe([0,0,0,0],t.config,!0));return e.box(e.types.dfLa,n)},e.avc1=function(t){var n=t.avcc,r=t.codecWidth,i=t.codecHeight,a=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,r>>>8&255,255&r,i>>>8&255,255&i,0,72,0,0,0,72,0,0,0,0,0,0,0,1,10,120,113,113,47,102,108,118,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255]);return e.box(e.types.avc1,a,e.box(e.types.avcC,n))},e.hvc1=function(t){var n=t.hvcc,r=t.codecWidth,i=t.codecHeight,a=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,r>>>8&255,255&r,i>>>8&255,255&i,0,72,0,0,0,72,0,0,0,0,0,0,0,1,10,120,113,113,47,102,108,118,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255]);return e.box(e.types.hvc1,a,e.box(e.types.hvcC,n))},e.av01=function(t){var n=t.av1c,r=t.codecWidth||192,i=t.codecHeight||108,a=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,r>>>8&255,255&r,i>>>8&255,255&i,0,72,0,0,0,72,0,0,0,0,0,0,0,1,10,120,113,113,47,102,108,118,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255]);return e.box(e.types.av01,a,e.box(e.types.av1C,n))},e.mvex=function(t){return e.box(e.types.mvex,e.trex(t))},e.trex=function(t){var n=t.id,r=new Uint8Array([0,0,0,0,n>>>24&255,n>>>16&255,n>>>8&255,255&n,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return e.box(e.types.trex,r)},e.moof=function(t,n){return e.box(e.types.moof,e.mfhd(t.sequenceNumber),e.traf(t,n))},e.mfhd=function(t){var n=new Uint8Array([0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t]);return e.box(e.types.mfhd,n)},e.traf=function(t,n){var r=t.id,i=e.box(e.types.tfhd,new Uint8Array([0,0,0,0,r>>>24&255,r>>>16&255,r>>>8&255,255&r])),a=e.box(e.types.tfdt,new Uint8Array([0,0,0,0,n>>>24&255,n>>>16&255,n>>>8&255,255&n])),o=e.sdtp(t),s=e.trun(t,o.byteLength+16+16+8+16+8+8);return e.box(e.types.traf,i,a,s,o)},e.sdtp=function(t){for(var n=t.samples||[],r=n.length,i=new Uint8Array(4+r),a=0;a<r;a++){var o=n[a].flags;i[a+4]=o.isLeading<<6|o.dependsOn<<4|o.isDependedOn<<2|o.hasRedundancy}return e.box(e.types.sdtp,i)},e.trun=function(t,n){var r=t.samples||[],i=r.length,a=12+16*i,o=new Uint8Array(a);n+=8+a,o.set([0,0,15,1,i>>>24&255,i>>>16&255,i>>>8&255,255&i,n>>>24&255,n>>>16&255,n>>>8&255,255&n],0);for(var s=0;s<i;s++){var c=r[s].duration,l=r[s].size,u=r[s].flags,d=r[s].cts;o.set([c>>>24&255,c>>>16&255,c>>>8&255,255&c,l>>>24&255,l>>>16&255,l>>>8&255,255&l,u.isLeading<<2|u.dependsOn,u.isDependedOn<<6|u.hasRedundancy<<4|u.isNonSync,0,0,d>>>24&255,d>>>16&255,d>>>8&255,255&d],12+16*s)}return e.box(e.types.trun,o)},e.mdat=function(t){return e.box(e.types.mdat,t)},e}();Ie.init();var Le=Ie,Re=function(){function e(){}return e.getSilentFrame=function(e,t){if(e===`mp4a.40.2`){if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2||t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null},e}(),ze=n(11),Be=function(){function e(e){this.TAG=`MP4Remuxer`,this._config=e,this._isLive=!0===e.isLive,this._dtsBase=-1,this._dtsBaseInited=!1,this._audioDtsBase=1/0,this._videoDtsBase=1/0,this._audioNextDts=void 0,this._videoNextDts=void 0,this._audioStashedLastSample=null,this._videoStashedLastSample=null,this._audioMeta=null,this._videoMeta=null,this._audioSegmentInfoList=new ze.c(`audio`),this._videoSegmentInfoList=new ze.c(`video`),this._onInitSegment=null,this._onMediaSegment=null,this._forceFirstIDR=!(!o.a.chrome||!(o.a.version.major<50||o.a.version.major===50&&o.a.version.build<2661)),this._fillSilentAfterSeek=o.a.msedge||o.a.msie,this._mp3UseMpegAudio=!o.a.firefox,this._fillAudioTimestampGap=this._config.fixAudioTimestampGap}return e.prototype.destroy=function(){this._dtsBase=-1,this._dtsBaseInited=!1,this._audioMeta=null,this._videoMeta=null,this._audioSegmentInfoList.clear(),this._audioSegmentInfoList=null,this._videoSegmentInfoList.clear(),this._videoSegmentInfoList=null,this._onInitSegment=null,this._onMediaSegment=null},e.prototype.bindDataSource=function(e){return e.onDataAvailable=this.remux.bind(this),e.onTrackMetadata=this._onTrackMetadataReceived.bind(this),this},Object.defineProperty(e.prototype,`onInitSegment`,{get:function(){return this._onInitSegment},set:function(e){this._onInitSegment=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`onMediaSegment`,{get:function(){return this._onMediaSegment},set:function(e){this._onMediaSegment=e},enumerable:!1,configurable:!0}),e.prototype.insertDiscontinuity=function(){this._audioNextDts=this._videoNextDts=void 0},e.prototype.seek=function(e){this._audioStashedLastSample=null,this._videoStashedLastSample=null,this._videoSegmentInfoList.clear(),this._audioSegmentInfoList.clear()},e.prototype.remux=function(e,t){if(!this._onMediaSegment)throw new d.a(`MP4Remuxer: onMediaSegment callback must be specificed!`);this._dtsBaseInited||this._calculateDtsBase(e,t),t&&this._remuxVideo(t),e&&this._remuxAudio(e)},e.prototype._onTrackMetadataReceived=function(e,t){var n=null,r=`mp4`,i=t.codec;if(e===`audio`)this._audioMeta=t,t.codec===`mp3`&&this._mp3UseMpegAudio?(r=`mpeg`,i=``,n=new Uint8Array):n=Le.generateInitSegment(t);else{if(e!==`video`)return;this._videoMeta=t,n=Le.generateInitSegment(t)}if(!this._onInitSegment)throw new d.a(`MP4Remuxer: onInitSegment callback must be specified!`);this._onInitSegment(e,{type:e,data:n.buffer,codec:i,container:`${e}/${r}`,mediaDuration:t.duration})},e.prototype._calculateDtsBase=function(e,t){this._dtsBaseInited||=(e&&e.samples&&e.samples.length&&(this._audioDtsBase=e.samples[0].dts),t&&t.samples&&t.samples.length&&(this._videoDtsBase=t.samples[0].dts),this._dtsBase=Math.min(this._audioDtsBase,this._videoDtsBase),!0)},e.prototype.getTimestampBase=function(){if(this._dtsBaseInited)return this._dtsBase},e.prototype.flushStashedSamples=function(){var e=this._videoStashedLastSample,t=this._audioStashedLastSample,n={type:`video`,id:1,sequenceNumber:0,samples:[],length:0};e!=null&&(n.samples.push(e),n.length=e.length);var r={type:`audio`,id:2,sequenceNumber:0,samples:[],length:0};t!=null&&(r.samples.push(t),r.length=t.length),this._videoStashedLastSample=null,this._audioStashedLastSample=null,this._remuxVideo(n,!0),this._remuxAudio(r,!0)},e.prototype._remuxAudio=function(e,t){if(this._audioMeta!=null){var n,r=e,i=r.samples,s=void 0,c=-1,l=this._audioMeta.refSampleDuration,u=this._audioMeta.codec===`mp3`&&this._mp3UseMpegAudio,d=this._dtsBaseInited&&this._audioNextDts===void 0,f=!1;if(i&&i.length!==0&&(i.length!==1||t)){var p=0,m=null,h=0;u?(p=0,h=r.length):(p=8,h=8+r.length);var g=null;if(i.length>1&&(h-=(g=i.pop()).length),this._audioStashedLastSample!=null){var _=this._audioStashedLastSample;this._audioStashedLastSample=null,i.unshift(_),h+=_.length}g!=null&&(this._audioStashedLastSample=g);var v=i[0].dts-this._dtsBase;if(this._audioNextDts)s=v-this._audioNextDts;else if(this._audioSegmentInfoList.isEmpty())s=0,this._fillSilentAfterSeek&&!this._videoSegmentInfoList.isEmpty()&&this._audioMeta.originalCodec!==`mp3`&&(f=!0);else{var y=this._audioSegmentInfoList.getLastSampleBefore(v);if(y!=null){var b=v-(y.originalDts+y.duration);b<=3&&(b=0),s=v-(y.dts+y.duration+b)}else s=0}if(f){var x=v-s,S=this._videoSegmentInfoList.getLastSegmentBefore(v);if(S!=null&&S.beginDts<x){if(N=Re.getSilentFrame(this._audioMeta.originalCodec,this._audioMeta.channelCount)){var C=S.beginDts,w=x-S.beginDts;a.a.v(this.TAG,`InsertPrefixSilentAudio: dts: ${C}, duration: ${w}`),i.unshift({unit:N,dts:C,pts:C}),h+=N.byteLength}}else f=!1}for(var T=[],E=0;E<i.length;E++){var D=(_=i[E]).unit,O=_.dts-this._dtsBase,k=(C=O,!1),A=null,j=0;if(!(O<-.001)){if(this._audioMeta.codec!==`mp3`&&l!=null){var M=O;if(this._audioNextDts&&(M=this._audioNextDts),(s=O-M)<=-3*l){a.a.w(this.TAG,`Dropping 1 audio frame (originalDts: ${O} ms ,curRefDts: ${M} ms)  due to dtsCorrection: ${s} ms overlap.`);continue}if(s>=3*l&&this._fillAudioTimestampGap&&!o.a.safari){k=!0;var N,P=Math.floor(s/l);a.a.w(this.TAG,`Large audio timestamp gap detected, may cause AV sync to drift. Silent frames will be generated to avoid unsync.
originalDts: ${O} ms, curRefDts: ${M} ms, dtsCorrection: ${Math.round(s)} ms, generate: ${P} frames`),C=Math.floor(M),j=Math.floor(M+l)-C,(N=Re.getSilentFrame(this._audioMeta.originalCodec,this._audioMeta.channelCount))??(a.a.w(this.TAG,`Unable to generate silent frame for ${this._audioMeta.originalCodec} with ${this._audioMeta.channelCount} channels, repeat last frame`),N=D),A=[];for(var F=0;F<P;F++){M+=l;var I=Math.floor(M),L=Math.floor(M+l)-I,R={dts:I,pts:I,cts:0,unit:N,size:N.byteLength,duration:L,originalDts:O,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0}};A.push(R),h+=R.size}this._audioNextDts=M+l}else C=Math.floor(M),j=Math.floor(M+l)-C,this._audioNextDts=M+l}else C=O-s,j=E===i.length-1?g==null?T.length>=1?T[T.length-1].duration:Math.floor(l):g.dts-this._dtsBase-s-C:i[E+1].dts-this._dtsBase-s-C,this._audioNextDts=C+j;c===-1&&(c=C),T.push({dts:C,pts:C,cts:0,unit:_.unit,size:_.unit.byteLength,duration:j,originalDts:O,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0}}),k&&T.push.apply(T,A)}}if(T.length===0)return r.samples=[],void(r.length=0);for(u?m=new Uint8Array(h):((m=new Uint8Array(h))[0]=h>>>24&255,m[1]=h>>>16&255,m[2]=h>>>8&255,m[3]=255&h,m.set(Le.types.mdat,4)),E=0;E<T.length;E++)D=T[E].unit,m.set(D,p),p+=D.byteLength;var z=T[T.length-1];n=z.dts+z.duration;var B=new ze.b;B.beginDts=c,B.endDts=n,B.beginPts=c,B.endPts=n,B.originalBeginDts=T[0].originalDts,B.originalEndDts=z.originalDts+z.duration,B.firstSample=new ze.d(T[0].dts,T[0].pts,T[0].duration,T[0].originalDts,!1),B.lastSample=new ze.d(z.dts,z.pts,z.duration,z.originalDts,!1),this._isLive||this._audioSegmentInfoList.append(B),r.samples=T,r.sequenceNumber++;var V=null;V=u?new Uint8Array:Le.moof(r,c),r.samples=[],r.length=0;var ee={type:`audio`,data:this._mergeBoxes(V,m).buffer,sampleCount:T.length,info:B};u&&d&&(ee.timestampOffset=c),this._onMediaSegment(`audio`,ee)}}},e.prototype._remuxVideo=function(e,t){if(this._videoMeta!=null){var n,r,i=e,a=i.samples,o=void 0,s=-1,c=-1;if(a&&a.length!==0&&(a.length!==1||t)){var l=8,u=null,d=8+e.length,f=null;if(a.length>1&&(d-=(f=a.pop()).length),this._videoStashedLastSample!=null){var p=this._videoStashedLastSample;this._videoStashedLastSample=null,a.unshift(p),d+=p.length}f!=null&&(this._videoStashedLastSample=f);var m=a[0].dts-this._dtsBase;if(this._videoNextDts)o=m-this._videoNextDts;else if(this._videoSegmentInfoList.isEmpty())o=0;else{var h=this._videoSegmentInfoList.getLastSampleBefore(m);if(h!=null){var g=m-(h.originalDts+h.duration);g<=3&&(g=0),o=m-(h.dts+h.duration+g)}else o=0}for(var _=new ze.b,v=[],y=0;y<a.length;y++){var b=(p=a[y]).dts-this._dtsBase,x=p.isKeyframe,S=b-o,C=p.cts,w=S+C;s===-1&&(s=S,c=w);var T=0;if(T=y===a.length-1?f==null?v.length>=1?v[v.length-1].duration:Math.floor(this._videoMeta.refSampleDuration):f.dts-this._dtsBase-o-S:a[y+1].dts-this._dtsBase-o-S,x){var E=new ze.d(S,w,T,p.dts,!0);E.fileposition=p.fileposition,_.appendSyncPoint(E)}v.push({dts:S,pts:w,cts:C,units:p.units,size:p.length,isKeyframe:x,duration:T,originalDts:b,flags:{isLeading:0,dependsOn:x?2:1,isDependedOn:x?1:0,hasRedundancy:0,isNonSync:x?0:1}})}for((u=new Uint8Array(d))[0]=d>>>24&255,u[1]=d>>>16&255,u[2]=d>>>8&255,u[3]=255&d,u.set(Le.types.mdat,4),y=0;y<v.length;y++)for(var D=v[y].units;D.length;){var O=D.shift().data;u.set(O,l),l+=O.byteLength}var k=v[v.length-1];if(n=k.dts+k.duration,r=k.pts+k.duration,this._videoNextDts=n,_.beginDts=s,_.endDts=n,_.beginPts=c,_.endPts=r,_.originalBeginDts=v[0].originalDts,_.originalEndDts=k.originalDts+k.duration,_.firstSample=new ze.d(v[0].dts,v[0].pts,v[0].duration,v[0].originalDts,v[0].isKeyframe),_.lastSample=new ze.d(k.dts,k.pts,k.duration,k.originalDts,k.isKeyframe),this._isLive||this._videoSegmentInfoList.append(_),i.samples=v,i.sequenceNumber++,this._forceFirstIDR){var A=v[0].flags;A.dependsOn=2,A.isNonSync=0}var j=Le.moof(i,s);i.samples=[],i.length=0,this._onMediaSegment(`video`,{type:`video`,data:this._mergeBoxes(j,u).buffer,sampleCount:v.length,info:_})}}},e.prototype._mergeBoxes=function(e,t){var n=new Uint8Array(e.byteLength+t.byteLength);return n.set(e,0),n.set(t,e.byteLength),n},e}(),Ve=n(14),He=n(1);t.a=(n(2),function(){function e(e,t){this.TAG=`TransmuxingController`,this._emitter=new i.a,this._config=t,e.segments||=[{duration:e.duration,filesize:e.filesize,url:e.url}],typeof e.cors!=`boolean`&&(e.cors=!0),typeof e.withCredentials!=`boolean`&&(e.withCredentials=!1),this._mediaDataSource=e,this._currentSegmentIndex=0;var n=0;this._mediaDataSource.segments.forEach((function(r){r.timestampBase=n,n+=r.duration,r.cors=e.cors,r.withCredentials=e.withCredentials,t.referrerPolicy&&(r.referrerPolicy=t.referrerPolicy)})),isNaN(n)||this._mediaDataSource.duration===n||(this._mediaDataSource.duration=n),this._mediaInfo=null,this._demuxer=null,this._remuxer=null,this._ioctl=null,this._pendingSeekTime=null,this._pendingResolveSeekPoint=null,this._statisticsReporter=null}return e.prototype.destroy=function(){this._mediaInfo=null,this._mediaDataSource=null,this._statisticsReporter&&this._disableStatisticsReporter(),this._ioctl&&=(this._ioctl.destroy(),null),this._demuxer&&=(this._demuxer.destroy(),null),this._remuxer&&=(this._remuxer.destroy(),null),this._emitter.removeAllListeners(),this._emitter=null},e.prototype.on=function(e,t){this._emitter.addListener(e,t)},e.prototype.off=function(e,t){this._emitter.removeListener(e,t)},e.prototype.start=function(){this._loadSegment(0),this._enableStatisticsReporter()},e.prototype._loadSegment=function(e,t){this._currentSegmentIndex=e;var n=this._mediaDataSource.segments[e],r=this._ioctl=new Ve.a(n,this._config,e);r.onError=this._onIOException.bind(this),r.onSeeked=this._onIOSeeked.bind(this),r.onComplete=this._onIOComplete.bind(this),r.onRedirect=this._onIORedirect.bind(this),r.onRecoveredEarlyEof=this._onIORecoveredEarlyEof.bind(this),t?this._demuxer.bindDataSource(this._ioctl):r.onDataArrival=this._onInitChunkArrival.bind(this),r.open(t)},e.prototype.stop=function(){this._internalAbort(),this._disableStatisticsReporter()},e.prototype._internalAbort=function(){this._ioctl&&=(this._ioctl.destroy(),null)},e.prototype.pause=function(){this._ioctl&&this._ioctl.isWorking()&&(this._ioctl.pause(),this._disableStatisticsReporter())},e.prototype.resume=function(){this._ioctl&&this._ioctl.isPaused()&&(this._ioctl.resume(),this._enableStatisticsReporter())},e.prototype.seek=function(e){if(this._mediaInfo!=null&&this._mediaInfo.isSeekable()){var t=this._searchSegmentIndexContains(e);if(t===this._currentSegmentIndex){var n=this._mediaInfo.segments[t];if(n==null)this._pendingSeekTime=e;else{var r=n.getNearestKeyframe(e);this._remuxer.seek(r.milliseconds),this._ioctl.seek(r.fileposition),this._pendingResolveSeekPoint=r.milliseconds}}else{var i=this._mediaInfo.segments[t];i==null?(this._pendingSeekTime=e,this._internalAbort(),this._remuxer.seek(),this._remuxer.insertDiscontinuity(),this._loadSegment(t)):(r=i.getNearestKeyframe(e),this._internalAbort(),this._remuxer.seek(e),this._remuxer.insertDiscontinuity(),this._demuxer.resetMediaInfo(),this._demuxer.timestampBase=this._mediaDataSource.segments[t].timestampBase,this._loadSegment(t,r.fileposition),this._pendingResolveSeekPoint=r.milliseconds,this._reportSegmentMediaInfo(t))}this._enableStatisticsReporter()}},e.prototype._searchSegmentIndexContains=function(e){for(var t=this._mediaDataSource.segments,n=t.length-1,r=0;r<t.length;r++)if(e<t[r].timestampBase){n=r-1;break}return n},e.prototype._onInitChunkArrival=function(e,t){var n=this,r=0;if(t>0)this._demuxer.bindDataSource(this._ioctl),this._demuxer.timestampBase=this._mediaDataSource.segments[this._currentSegmentIndex].timestampBase,r=this._demuxer.parseChunks(e,t);else{var i=null;(i=T.probe(e)).match&&(this._setupFLVDemuxerRemuxer(i),r=this._demuxer.parseChunks(e,t)),i.match||i.needMoreData||(i=Pe.probe(e)).match&&(this._setupTSDemuxerRemuxer(i),r=this._demuxer.parseChunks(e,t)),i.match||i.needMoreData||(i=null,a.a.e(this.TAG,`Non MPEG-TS/FLV, Unsupported media type!`),Promise.resolve().then((function(){n._internalAbort()})),this._emitter.emit(He.a.DEMUX_ERROR,g.a.FORMAT_UNSUPPORTED,`Non MPEG-TS/FLV, Unsupported media type!`))}return r},e.prototype._setupFLVDemuxerRemuxer=function(e){this._demuxer=new T(e,this._config),this._remuxer||=new Be(this._config);var t=this._mediaDataSource;t.duration==null||isNaN(t.duration)||(this._demuxer.overridedDuration=t.duration),typeof t.hasAudio==`boolean`&&(this._demuxer.overridedHasAudio=t.hasAudio),typeof t.hasVideo==`boolean`&&(this._demuxer.overridedHasVideo=t.hasVideo),this._demuxer.timestampBase=t.segments[this._currentSegmentIndex].timestampBase,this._demuxer.onError=this._onDemuxException.bind(this),this._demuxer.onMediaInfo=this._onMediaInfo.bind(this),this._demuxer.onMetaDataArrived=this._onMetaDataArrived.bind(this),this._demuxer.onScriptDataArrived=this._onScriptDataArrived.bind(this),this._remuxer.bindDataSource(this._demuxer.bindDataSource(this._ioctl)),this._remuxer.onInitSegment=this._onRemuxerInitSegmentArrival.bind(this),this._remuxer.onMediaSegment=this._onRemuxerMediaSegmentArrival.bind(this)},e.prototype._setupTSDemuxerRemuxer=function(e){var t=this._demuxer=new Pe(e,this._config);this._remuxer||=new Be(this._config),t.onError=this._onDemuxException.bind(this),t.onMediaInfo=this._onMediaInfo.bind(this),t.onMetaDataArrived=this._onMetaDataArrived.bind(this),t.onTimedID3Metadata=this._onTimedID3Metadata.bind(this),t.onSynchronousKLVMetadata=this._onSynchronousKLVMetadata.bind(this),t.onAsynchronousKLVMetadata=this._onAsynchronousKLVMetadata.bind(this),t.onSMPTE2038Metadata=this._onSMPTE2038Metadata.bind(this),t.onSCTE35Metadata=this._onSCTE35Metadata.bind(this),t.onPESPrivateDataDescriptor=this._onPESPrivateDataDescriptor.bind(this),t.onPESPrivateData=this._onPESPrivateData.bind(this),this._remuxer.bindDataSource(this._demuxer),this._demuxer.bindDataSource(this._ioctl),this._remuxer.onInitSegment=this._onRemuxerInitSegmentArrival.bind(this),this._remuxer.onMediaSegment=this._onRemuxerMediaSegmentArrival.bind(this)},e.prototype._onMediaInfo=function(e){var t=this;this._mediaInfo??(this._mediaInfo=Object.assign({},e),this._mediaInfo.keyframesIndex=null,this._mediaInfo.segments=[],this._mediaInfo.segmentCount=this._mediaDataSource.segments.length,Object.setPrototypeOf(this._mediaInfo,s.a.prototype));var n=Object.assign({},e);Object.setPrototypeOf(n,s.a.prototype),this._mediaInfo.segments[this._currentSegmentIndex]=n,this._reportSegmentMediaInfo(this._currentSegmentIndex),this._pendingSeekTime!=null&&Promise.resolve().then((function(){var e=t._pendingSeekTime;t._pendingSeekTime=null,t.seek(e)}))},e.prototype._onMetaDataArrived=function(e){this._emitter.emit(He.a.METADATA_ARRIVED,e)},e.prototype._onScriptDataArrived=function(e){this._emitter.emit(He.a.SCRIPTDATA_ARRIVED,e)},e.prototype._onTimedID3Metadata=function(e){var t=this._remuxer.getTimestampBase();t!=null&&(e.pts!=null&&(e.pts-=t),e.dts!=null&&(e.dts-=t),this._emitter.emit(He.a.TIMED_ID3_METADATA_ARRIVED,e))},e.prototype._onSynchronousKLVMetadata=function(e){var t=this._remuxer.getTimestampBase();t!=null&&(e.pts!=null&&(e.pts-=t),e.dts!=null&&(e.dts-=t),this._emitter.emit(He.a.SYNCHRONOUS_KLV_METADATA_ARRIVED,e))},e.prototype._onAsynchronousKLVMetadata=function(e){this._emitter.emit(He.a.ASYNCHRONOUS_KLV_METADATA_ARRIVED,e)},e.prototype._onSMPTE2038Metadata=function(e){var t=this._remuxer.getTimestampBase();t!=null&&(e.pts!=null&&(e.pts-=t),e.dts!=null&&(e.dts-=t),e.nearest_pts!=null&&(e.nearest_pts-=t),this._emitter.emit(He.a.SMPTE2038_METADATA_ARRIVED,e))},e.prototype._onSCTE35Metadata=function(e){var t=this._remuxer.getTimestampBase();t!=null&&(e.pts!=null&&(e.pts-=t),e.nearest_pts!=null&&(e.nearest_pts-=t),this._emitter.emit(He.a.SCTE35_METADATA_ARRIVED,e))},e.prototype._onPESPrivateDataDescriptor=function(e){this._emitter.emit(He.a.PES_PRIVATE_DATA_DESCRIPTOR,e)},e.prototype._onPESPrivateData=function(e){var t=this._remuxer.getTimestampBase();t!=null&&(e.pts!=null&&(e.pts-=t),e.nearest_pts!=null&&(e.nearest_pts-=t),e.dts!=null&&(e.dts-=t),this._emitter.emit(He.a.PES_PRIVATE_DATA_ARRIVED,e))},e.prototype._onIOSeeked=function(){this._remuxer.insertDiscontinuity()},e.prototype._onIOComplete=function(e){var t=e+1;t<this._mediaDataSource.segments.length?(this._internalAbort(),this._remuxer&&this._remuxer.flushStashedSamples(),this._loadSegment(t)):(this._remuxer&&this._remuxer.flushStashedSamples(),this._emitter.emit(He.a.LOADING_COMPLETE),this._disableStatisticsReporter())},e.prototype._onIORedirect=function(e){var t=this._ioctl.extraData;this._mediaDataSource.segments[t].redirectedURL=e},e.prototype._onIORecoveredEarlyEof=function(){this._emitter.emit(He.a.RECOVERED_EARLY_EOF)},e.prototype._onIOException=function(e,t){a.a.e(this.TAG,`IOException: type = ${e}, code = ${t.code}, msg = ${t.msg}`),this._emitter.emit(He.a.IO_ERROR,e,t),this._disableStatisticsReporter()},e.prototype._onDemuxException=function(e,t){a.a.e(this.TAG,`DemuxException: type = ${e}, info = ${t}`),this._emitter.emit(He.a.DEMUX_ERROR,e,t)},e.prototype._onRemuxerInitSegmentArrival=function(e,t){this._emitter.emit(He.a.INIT_SEGMENT,e,t)},e.prototype._onRemuxerMediaSegmentArrival=function(e,t){if(this._pendingSeekTime==null&&(this._emitter.emit(He.a.MEDIA_SEGMENT,e,t),this._pendingResolveSeekPoint!=null&&e===`video`)){var n=t.info.syncPoints,r=this._pendingResolveSeekPoint;this._pendingResolveSeekPoint=null,o.a.safari&&n.length>0&&n[0].originalDts===r&&(r=n[0].pts),this._emitter.emit(He.a.RECOMMEND_SEEKPOINT,r)}},e.prototype._enableStatisticsReporter=function(){this._statisticsReporter??=self.setInterval(this._reportStatisticsInfo.bind(this),this._config.statisticsInfoReportInterval)},e.prototype._disableStatisticsReporter=function(){this._statisticsReporter&&=(self.clearInterval(this._statisticsReporter),null)},e.prototype._reportSegmentMediaInfo=function(e){var t=this._mediaInfo.segments[e],n=Object.assign({},t);n.duration=this._mediaInfo.duration,n.segmentCount=this._mediaInfo.segmentCount,delete n.segments,delete n.keyframesIndex,this._emitter.emit(He.a.MEDIA_INFO,n)},e.prototype._reportStatisticsInfo=function(){var e={};e.url=this._ioctl.currentURL,e.hasRedirect=this._ioctl.hasRedirect,e.hasRedirect&&(e.redirectedURL=this._ioctl.currentRedirectedURL),e.speed=this._ioctl.currentSpeed,e.loaderType=this._ioctl.loaderType,e.currentSegmentIndex=this._currentSegmentIndex,e.totalSegmentCount=this._mediaDataSource.segments.length,this._emitter.emit(He.a.STATISTICS_INFO,e)},e}())},function(e,t,n){var r,i=n(0),a=function(){function e(){this._firstCheckpoint=0,this._lastCheckpoint=0,this._intervalBytes=0,this._totalBytes=0,this._lastSecondBytes=0,self.performance&&self.performance.now?this._now=self.performance.now.bind(self.performance):this._now=Date.now}return e.prototype.reset=function(){this._firstCheckpoint=this._lastCheckpoint=0,this._totalBytes=this._intervalBytes=0,this._lastSecondBytes=0},e.prototype.addBytes=function(e){this._firstCheckpoint===0?(this._firstCheckpoint=this._now(),this._lastCheckpoint=this._firstCheckpoint,this._intervalBytes+=e,this._totalBytes+=e):this._now()-this._lastCheckpoint<1e3?(this._intervalBytes+=e,this._totalBytes+=e):(this._lastSecondBytes=this._intervalBytes,this._intervalBytes=e,this._totalBytes+=e,this._lastCheckpoint=this._now())},Object.defineProperty(e.prototype,`currentKBps`,{get:function(){this.addBytes(0);var e=(this._now()-this._lastCheckpoint)/1e3;return e==0&&(e=1),this._intervalBytes/e/1024},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`lastSecondKBps`,{get:function(){return this.addBytes(0),this._lastSecondBytes===0?this._now()-this._lastCheckpoint>=500?this.currentKBps:0:this._lastSecondBytes/1024},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`averageKBps`,{get:function(){var e=(this._now()-this._firstCheckpoint)/1e3;return this._totalBytes/e/1024},enumerable:!1,configurable:!0}),e}(),o=n(2),s=n(5),c=n(3),l=(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,t)},function(e,t){if(typeof t!=`function`&&t!==null)throw TypeError(`Class extends value `+String(t)+` is not a constructor or null`);function n(){this.constructor=e}r(e,t),e.prototype=t===null?Object.create(t):(n.prototype=t.prototype,new n)}),u=function(e){function t(t,n){var r=e.call(this,`fetch-stream-loader`)||this;return r.TAG=`FetchStreamLoader`,r._seekHandler=t,r._config=n,r._needStash=!0,r._requestAbort=!1,r._abortController=null,r._contentLength=null,r._receivedLength=0,r}return l(t,e),t.isSupported=function(){try{var e=s.a.msedge&&s.a.version.minor>=15048,t=!s.a.msedge||e;return self.fetch&&self.ReadableStream&&t}catch{return!1}},t.prototype.destroy=function(){this.isWorking()&&this.abort(),e.prototype.destroy.call(this)},t.prototype.open=function(e,t){var n=this;this._dataSource=e,this._range=t;var r=e.url;this._config.reuseRedirectedURL&&e.redirectedURL!=null&&(r=e.redirectedURL);var i=this._seekHandler.getConfig(r,t),a=new self.Headers;if(typeof i.headers==`object`){var s=i.headers;for(var l in s)s.hasOwnProperty(l)&&a.append(l,s[l])}var u={method:`GET`,headers:a,mode:`cors`,cache:`default`,referrerPolicy:`no-referrer-when-downgrade`};if(typeof this._config.headers==`object`)for(var l in this._config.headers)a.append(l,this._config.headers[l]);!1===e.cors&&(u.mode=`same-origin`),e.withCredentials&&(u.credentials=`include`),e.referrerPolicy&&(u.referrerPolicy=e.referrerPolicy),self.AbortController&&(this._abortController=new self.AbortController,u.signal=this._abortController.signal),this._status=o.c.kConnecting,self.fetch(i.url,u).then((function(e){if(n._requestAbort)return n._status=o.c.kIdle,void e.body.cancel();if(e.ok&&e.status>=200&&e.status<=299){if(e.url!==i.url&&n._onURLRedirect){var t=n._seekHandler.removeURLParameters(e.url);n._onURLRedirect(t)}var r=e.headers.get(`Content-Length`);return r!=null&&(n._contentLength=parseInt(r),n._contentLength!==0&&n._onContentLengthKnown&&n._onContentLengthKnown(n._contentLength)),n._pump.call(n,e.body.getReader())}if(n._status=o.c.kError,!n._onError)throw new c.d(`FetchStreamLoader: Http code invalid, `+e.status+` `+e.statusText);n._onError(o.b.HTTP_STATUS_CODE_INVALID,{code:e.status,msg:e.statusText})})).catch((function(e){if(!n._abortController||!n._abortController.signal.aborted){if(n._status=o.c.kError,!n._onError)throw e;n._onError(o.b.EXCEPTION,{code:-1,msg:e.message})}}))},t.prototype.abort=function(){if(this._requestAbort=!0,(this._status!==o.c.kBuffering||!s.a.chrome)&&this._abortController)try{this._abortController.abort()}catch{}},t.prototype._pump=function(e){var t=this;return e.read().then((function(n){if(n.done)if(t._contentLength!==null&&t._receivedLength<t._contentLength){t._status=o.c.kError;var r=o.b.EARLY_EOF,i={code:-1,msg:`Fetch stream meet Early-EOF`};if(!t._onError)throw new c.d(i.msg);t._onError(r,i)}else t._status=o.c.kComplete,t._onComplete&&t._onComplete(t._range.from,t._range.from+t._receivedLength-1);else{if(t._abortController&&t._abortController.signal.aborted)return void(t._status=o.c.kComplete);if(!0===t._requestAbort)return t._status=o.c.kComplete,e.cancel();t._status=o.c.kBuffering;var a=n.value.buffer,s=t._range.from+t._receivedLength;t._receivedLength+=a.byteLength,t._onDataArrival&&t._onDataArrival(a,s,t._receivedLength),t._pump(e)}})).catch((function(e){if(t._abortController&&t._abortController.signal.aborted)t._status=o.c.kComplete;else if(e.code!==11||!s.a.msedge){t._status=o.c.kError;var n=0,r=null;if(e.code!==19&&e.message!==`network error`||!(t._contentLength===null||t._contentLength!==null&&t._receivedLength<t._contentLength)?(n=o.b.EXCEPTION,r={code:e.code,msg:e.message}):(n=o.b.EARLY_EOF,r={code:e.code,msg:`Fetch stream meet Early-EOF`}),!t._onError)throw new c.d(r.msg);t._onError(n,r)}}))},t}(o.a),d=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if(typeof n!=`function`&&n!==null)throw TypeError(`Class extends value `+String(n)+` is not a constructor or null`);function r(){this.constructor=t}e(t,n),t.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}}(),f=function(e){function t(t,n){var r=e.call(this,`xhr-moz-chunked-loader`)||this;return r.TAG=`MozChunkedLoader`,r._seekHandler=t,r._config=n,r._needStash=!0,r._xhr=null,r._requestAbort=!1,r._contentLength=null,r._receivedLength=0,r}return d(t,e),t.isSupported=function(){try{var e=new XMLHttpRequest;return e.open(`GET`,`https://example.com`,!0),e.responseType=`moz-chunked-arraybuffer`,e.responseType===`moz-chunked-arraybuffer`}catch(e){return i.a.w(`MozChunkedLoader`,e.message),!1}},t.prototype.destroy=function(){this.isWorking()&&this.abort(),this._xhr&&=(this._xhr.onreadystatechange=null,this._xhr.onprogress=null,this._xhr.onloadend=null,this._xhr.onerror=null,null),e.prototype.destroy.call(this)},t.prototype.open=function(e,t){this._dataSource=e,this._range=t;var n=e.url;this._config.reuseRedirectedURL&&e.redirectedURL!=null&&(n=e.redirectedURL);var r=this._seekHandler.getConfig(n,t);this._requestURL=r.url;var i=this._xhr=new XMLHttpRequest;if(i.open(`GET`,r.url,!0),i.responseType=`moz-chunked-arraybuffer`,i.onreadystatechange=this._onReadyStateChange.bind(this),i.onprogress=this._onProgress.bind(this),i.onloadend=this._onLoadEnd.bind(this),i.onerror=this._onXhrError.bind(this),e.withCredentials&&(i.withCredentials=!0),typeof r.headers==`object`){var a=r.headers;for(var s in a)a.hasOwnProperty(s)&&i.setRequestHeader(s,a[s])}if(typeof this._config.headers==`object`)for(var s in a=this._config.headers,a)a.hasOwnProperty(s)&&i.setRequestHeader(s,a[s]);this._status=o.c.kConnecting,i.send()},t.prototype.abort=function(){this._requestAbort=!0,this._xhr&&this._xhr.abort(),this._status=o.c.kComplete},t.prototype._onReadyStateChange=function(e){var t=e.target;if(t.readyState===2){if(t.responseURL!=null&&t.responseURL!==this._requestURL&&this._onURLRedirect){var n=this._seekHandler.removeURLParameters(t.responseURL);this._onURLRedirect(n)}if(t.status!==0&&(t.status<200||t.status>299)){if(this._status=o.c.kError,!this._onError)throw new c.d(`MozChunkedLoader: Http code invalid, `+t.status+` `+t.statusText);this._onError(o.b.HTTP_STATUS_CODE_INVALID,{code:t.status,msg:t.statusText})}else this._status=o.c.kBuffering}},t.prototype._onProgress=function(e){if(this._status!==o.c.kError){this._contentLength===null&&e.total!==null&&e.total!==0&&(this._contentLength=e.total,this._onContentLengthKnown&&this._onContentLengthKnown(this._contentLength));var t=e.target.response,n=this._range.from+this._receivedLength;this._receivedLength+=t.byteLength,this._onDataArrival&&this._onDataArrival(t,n,this._receivedLength)}},t.prototype._onLoadEnd=function(e){!0===this._requestAbort?this._requestAbort=!1:this._status!==o.c.kError&&(this._status=o.c.kComplete,this._onComplete&&this._onComplete(this._range.from,this._range.from+this._receivedLength-1))},t.prototype._onXhrError=function(e){this._status=o.c.kError;var t=0,n=null;if(this._contentLength&&e.loaded<this._contentLength?(t=o.b.EARLY_EOF,n={code:-1,msg:`Moz-Chunked stream meet Early-Eof`}):(t=o.b.EXCEPTION,n={code:-1,msg:e.constructor.name+` `+e.type}),!this._onError)throw new c.d(n.msg);this._onError(t,n)},t}(o.a),p=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if(typeof n!=`function`&&n!==null)throw TypeError(`Class extends value `+String(n)+` is not a constructor or null`);function r(){this.constructor=t}e(t,n),t.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}}(),m=(function(e){function t(t,n){var r=e.call(this,`xhr-msstream-loader`)||this;return r.TAG=`MSStreamLoader`,r._seekHandler=t,r._config=n,r._needStash=!0,r._xhr=null,r._reader=null,r._totalRange=null,r._currentRange=null,r._currentRequestURL=null,r._currentRedirectedURL=null,r._contentLength=null,r._receivedLength=0,r._bufferLimit=16777216,r._lastTimeBufferSize=0,r._isReconnecting=!1,r}p(t,e),t.isSupported=function(){try{if(self.MSStream===void 0||self.MSStreamReader===void 0)return!1;var e=new XMLHttpRequest;return e.open(`GET`,`https://example.com`,!0),e.responseType=`ms-stream`,e.responseType===`ms-stream`}catch(e){return i.a.w(`MSStreamLoader`,e.message),!1}},t.prototype.destroy=function(){this.isWorking()&&this.abort(),this._reader&&=(this._reader.onprogress=null,this._reader.onload=null,this._reader.onerror=null,null),this._xhr&&=(this._xhr.onreadystatechange=null,null),e.prototype.destroy.call(this)},t.prototype.open=function(e,t){this._internalOpen(e,t,!1)},t.prototype._internalOpen=function(e,t,n){this._dataSource=e,n?this._currentRange=t:this._totalRange=t;var r=e.url;this._config.reuseRedirectedURL&&(this._currentRedirectedURL==null?e.redirectedURL!=null&&(r=e.redirectedURL):r=this._currentRedirectedURL);var i=this._seekHandler.getConfig(r,t);this._currentRequestURL=i.url;var a=this._reader=new self.MSStreamReader;a.onprogress=this._msrOnProgress.bind(this),a.onload=this._msrOnLoad.bind(this),a.onerror=this._msrOnError.bind(this);var s=this._xhr=new XMLHttpRequest;if(s.open(`GET`,i.url,!0),s.responseType=`ms-stream`,s.onreadystatechange=this._xhrOnReadyStateChange.bind(this),s.onerror=this._xhrOnError.bind(this),e.withCredentials&&(s.withCredentials=!0),typeof i.headers==`object`){var c=i.headers;for(var l in c)c.hasOwnProperty(l)&&s.setRequestHeader(l,c[l])}if(typeof this._config.headers==`object`)for(var l in c=this._config.headers,c)c.hasOwnProperty(l)&&s.setRequestHeader(l,c[l]);this._isReconnecting?this._isReconnecting=!1:this._status=o.c.kConnecting,s.send()},t.prototype.abort=function(){this._internalAbort(),this._status=o.c.kComplete},t.prototype._internalAbort=function(){this._reader&&=(this._reader.readyState===1&&this._reader.abort(),this._reader.onprogress=null,this._reader.onload=null,this._reader.onerror=null,null),this._xhr&&=(this._xhr.abort(),this._xhr.onreadystatechange=null,null)},t.prototype._xhrOnReadyStateChange=function(e){var t=e.target;if(t.readyState===2)if(t.status>=200&&t.status<=299){if(this._status=o.c.kBuffering,t.responseURL!=null){var n=this._seekHandler.removeURLParameters(t.responseURL);t.responseURL!==this._currentRequestURL&&n!==this._currentRedirectedURL&&(this._currentRedirectedURL=n,this._onURLRedirect&&this._onURLRedirect(n))}var r=t.getResponseHeader(`Content-Length`);if(r!=null&&this._contentLength==null){var i=parseInt(r);i>0&&(this._contentLength=i,this._onContentLengthKnown&&this._onContentLengthKnown(this._contentLength))}}else{if(this._status=o.c.kError,!this._onError)throw new c.d(`MSStreamLoader: Http code invalid, `+t.status+` `+t.statusText);this._onError(o.b.HTTP_STATUS_CODE_INVALID,{code:t.status,msg:t.statusText})}else if(t.readyState===3&&t.status>=200&&t.status<=299){this._status=o.c.kBuffering;var a=t.response;this._reader.readAsArrayBuffer(a)}},t.prototype._xhrOnError=function(e){this._status=o.c.kError;var t=o.b.EXCEPTION,n={code:-1,msg:e.constructor.name+` `+e.type};if(!this._onError)throw new c.d(n.msg);this._onError(t,n)},t.prototype._msrOnProgress=function(e){var t=e.target.result;if(t!=null){var n=t.slice(this._lastTimeBufferSize);this._lastTimeBufferSize=t.byteLength;var r=this._totalRange.from+this._receivedLength;this._receivedLength+=n.byteLength,this._onDataArrival&&this._onDataArrival(n,r,this._receivedLength),t.byteLength>=this._bufferLimit&&(i.a.v(this.TAG,`MSStream buffer exceeded max size near ${r+n.byteLength}, reconnecting...`),this._doReconnectIfNeeded())}else this._doReconnectIfNeeded()},t.prototype._doReconnectIfNeeded=function(){if(this._contentLength==null||this._receivedLength<this._contentLength){this._isReconnecting=!0,this._lastTimeBufferSize=0,this._internalAbort();var e={from:this._totalRange.from+this._receivedLength,to:-1};this._internalOpen(this._dataSource,e,!0)}},t.prototype._msrOnLoad=function(e){this._status=o.c.kComplete,this._onComplete&&this._onComplete(this._totalRange.from,this._totalRange.from+this._receivedLength-1)},t.prototype._msrOnError=function(e){this._status=o.c.kError;var t=0,n=null;if(this._contentLength&&this._receivedLength<this._contentLength?(t=o.b.EARLY_EOF,n={code:-1,msg:`MSStream meet Early-Eof`}):(t=o.b.EARLY_EOF,n={code:-1,msg:e.constructor.name+` `+e.type}),!this._onError)throw new c.d(n.msg);this._onError(t,n)}}(o.a),function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if(typeof n!=`function`&&n!==null)throw TypeError(`Class extends value `+String(n)+` is not a constructor or null`);function r(){this.constructor=t}e(t,n),t.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}}()),h=function(e){function t(t,n){var r=e.call(this,`xhr-range-loader`)||this;return r.TAG=`RangeLoader`,r._seekHandler=t,r._config=n,r._needStash=!1,r._chunkSizeKBList=[128,256,384,512,768,1024,1536,2048,3072,4096,5120,6144,7168,8192],r._currentChunkSizeKB=384,r._currentSpeedNormalized=0,r._zeroSpeedChunkCount=0,r._xhr=null,r._speedSampler=new a,r._requestAbort=!1,r._waitForTotalLength=!1,r._totalLengthReceived=!1,r._currentRequestURL=null,r._currentRedirectedURL=null,r._currentRequestRange=null,r._totalLength=null,r._contentLength=null,r._receivedLength=0,r._lastTimeLoaded=0,r}return m(t,e),t.isSupported=function(){try{var e=new XMLHttpRequest;return e.open(`GET`,`https://example.com`,!0),e.responseType=`arraybuffer`,e.responseType===`arraybuffer`}catch(e){return i.a.w(`RangeLoader`,e.message),!1}},t.prototype.destroy=function(){this.isWorking()&&this.abort(),this._xhr&&=(this._xhr.onreadystatechange=null,this._xhr.onprogress=null,this._xhr.onload=null,this._xhr.onerror=null,null),e.prototype.destroy.call(this)},Object.defineProperty(t.prototype,`currentSpeed`,{get:function(){return this._speedSampler.lastSecondKBps},enumerable:!1,configurable:!0}),t.prototype.open=function(e,t){this._dataSource=e,this._range=t,this._status=o.c.kConnecting;var n=!1;this._dataSource.filesize!=null&&this._dataSource.filesize!==0&&(n=!0,this._totalLength=this._dataSource.filesize),this._totalLengthReceived||n?this._openSubRange():(this._waitForTotalLength=!0,this._internalOpen(this._dataSource,{from:0,to:-1}))},t.prototype._openSubRange=function(){var e=1024*this._currentChunkSizeKB,t=this._range.from+this._receivedLength,n=t+e;this._contentLength!=null&&n-this._range.from>=this._contentLength&&(n=this._range.from+this._contentLength-1),this._currentRequestRange={from:t,to:n},this._internalOpen(this._dataSource,this._currentRequestRange)},t.prototype._internalOpen=function(e,t){this._lastTimeLoaded=0;var n=e.url;this._config.reuseRedirectedURL&&(this._currentRedirectedURL==null?e.redirectedURL!=null&&(n=e.redirectedURL):n=this._currentRedirectedURL);var r=this._seekHandler.getConfig(n,t);this._currentRequestURL=r.url;var i=this._xhr=new XMLHttpRequest;if(i.open(`GET`,r.url,!0),i.responseType=`arraybuffer`,i.onreadystatechange=this._onReadyStateChange.bind(this),i.onprogress=this._onProgress.bind(this),i.onload=this._onLoad.bind(this),i.onerror=this._onXhrError.bind(this),e.withCredentials&&(i.withCredentials=!0),typeof r.headers==`object`){var a=r.headers;for(var o in a)a.hasOwnProperty(o)&&i.setRequestHeader(o,a[o])}if(typeof this._config.headers==`object`)for(var o in a=this._config.headers,a)a.hasOwnProperty(o)&&i.setRequestHeader(o,a[o]);i.send()},t.prototype.abort=function(){this._requestAbort=!0,this._internalAbort(),this._status=o.c.kComplete},t.prototype._internalAbort=function(){this._xhr&&=(this._xhr.onreadystatechange=null,this._xhr.onprogress=null,this._xhr.onload=null,this._xhr.onerror=null,this._xhr.abort(),null)},t.prototype._onReadyStateChange=function(e){var t=e.target;if(t.readyState===2){if(t.responseURL!=null){var n=this._seekHandler.removeURLParameters(t.responseURL);t.responseURL!==this._currentRequestURL&&n!==this._currentRedirectedURL&&(this._currentRedirectedURL=n,this._onURLRedirect&&this._onURLRedirect(n))}if(t.status>=200&&t.status<=299){if(this._waitForTotalLength)return;this._status=o.c.kBuffering}else{if(this._status=o.c.kError,!this._onError)throw new c.d(`RangeLoader: Http code invalid, `+t.status+` `+t.statusText);this._onError(o.b.HTTP_STATUS_CODE_INVALID,{code:t.status,msg:t.statusText})}}},t.prototype._onProgress=function(e){if(this._status!==o.c.kError){if(this._contentLength===null){var t=!1;if(this._waitForTotalLength){this._waitForTotalLength=!1,this._totalLengthReceived=!0,t=!0;var n=e.total;this._internalAbort(),n!=null&n!==0&&(this._totalLength=n)}if(this._range.to===-1?this._contentLength=this._totalLength-this._range.from:this._contentLength=this._range.to-this._range.from+1,t)return void this._openSubRange();this._onContentLengthKnown&&this._onContentLengthKnown(this._contentLength)}var r=e.loaded-this._lastTimeLoaded;this._lastTimeLoaded=e.loaded,this._speedSampler.addBytes(r)}},t.prototype._normalizeSpeed=function(e){var t=this._chunkSizeKBList,n=t.length-1,r=0,i=0,a=n;if(e<t[0])return t[0];for(;i<=a;){if((r=i+Math.floor((a-i)/2))===n||e>=t[r]&&e<t[r+1])return t[r];t[r]<e?i=r+1:a=r-1}},t.prototype._onLoad=function(e){if(this._status!==o.c.kError)if(this._waitForTotalLength)this._waitForTotalLength=!1;else{this._lastTimeLoaded=0;var t=this._speedSampler.lastSecondKBps;if(t===0&&(this._zeroSpeedChunkCount++,this._zeroSpeedChunkCount>=3&&(t=this._speedSampler.currentKBps)),t!==0){var n=this._normalizeSpeed(t);this._currentSpeedNormalized!==n&&(this._currentSpeedNormalized=n,this._currentChunkSizeKB=n)}var r=e.target.response,i=this._range.from+this._receivedLength;this._receivedLength+=r.byteLength;var a=!1;this._contentLength!=null&&this._receivedLength<this._contentLength?this._openSubRange():a=!0,this._onDataArrival&&this._onDataArrival(r,i,this._receivedLength),a&&(this._status=o.c.kComplete,this._onComplete&&this._onComplete(this._range.from,this._range.from+this._receivedLength-1))}},t.prototype._onXhrError=function(e){this._status=o.c.kError;var t=0,n=null;if(this._contentLength&&this._receivedLength>0&&this._receivedLength<this._contentLength?(t=o.b.EARLY_EOF,n={code:-1,msg:`RangeLoader meet Early-Eof`}):(t=o.b.EXCEPTION,n={code:-1,msg:e.constructor.name+` `+e.type}),!this._onError)throw new c.d(n.msg);this._onError(t,n)},t}(o.a),g=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(t,n)};return function(t,n){if(typeof n!=`function`&&n!==null)throw TypeError(`Class extends value `+String(n)+` is not a constructor or null`);function r(){this.constructor=t}e(t,n),t.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}}(),_=function(e){function t(){var t=e.call(this,`websocket-loader`)||this;return t.TAG=`WebSocketLoader`,t._needStash=!0,t._ws=null,t._requestAbort=!1,t._receivedLength=0,t}return g(t,e),t.isSupported=function(){try{return self.WebSocket!==void 0}catch{return!1}},t.prototype.destroy=function(){this._ws&&this.abort(),e.prototype.destroy.call(this)},t.prototype.open=function(e){try{var t=this._ws=new self.WebSocket(e.url);t.binaryType=`arraybuffer`,t.onopen=this._onWebSocketOpen.bind(this),t.onclose=this._onWebSocketClose.bind(this),t.onmessage=this._onWebSocketMessage.bind(this),t.onerror=this._onWebSocketError.bind(this),this._status=o.c.kConnecting}catch(e){this._status=o.c.kError;var n={code:e.code,msg:e.message};if(!this._onError)throw new c.d(n.msg);this._onError(o.b.EXCEPTION,n)}},t.prototype.abort=function(){var e=this._ws;!e||e.readyState!==0&&e.readyState!==1||(this._requestAbort=!0,e.close()),this._ws=null,this._status=o.c.kComplete},t.prototype._onWebSocketOpen=function(e){this._status=o.c.kBuffering},t.prototype._onWebSocketClose=function(e){!0===this._requestAbort?this._requestAbort=!1:(this._status=o.c.kComplete,this._onComplete&&this._onComplete(0,this._receivedLength-1))},t.prototype._onWebSocketMessage=function(e){var t=this;if(e.data instanceof ArrayBuffer)this._dispatchArrayBuffer(e.data);else if(e.data instanceof Blob){var n=new FileReader;n.onload=function(){t._dispatchArrayBuffer(n.result)},n.readAsArrayBuffer(e.data)}else{this._status=o.c.kError;var r={code:-1,msg:`Unsupported WebSocket message type: `+e.data.constructor.name};if(!this._onError)throw new c.d(r.msg);this._onError(o.b.EXCEPTION,r)}},t.prototype._dispatchArrayBuffer=function(e){var t=e,n=this._receivedLength;this._receivedLength+=t.byteLength,this._onDataArrival&&this._onDataArrival(t,n,this._receivedLength)},t.prototype._onWebSocketError=function(e){this._status=o.c.kError;var t={code:e.code,msg:e.message};if(!this._onError)throw new c.d(t.msg);this._onError(o.b.EXCEPTION,t)},t}(o.a),v=function(){function e(e){this._zeroStart=e||!1}return e.prototype.getConfig=function(e,t){var n={};if(t.from!==0||t.to!==-1){var r=void 0;r=t.to===-1?`bytes=${t.from.toString()}-`:`bytes=${t.from.toString()}-${t.to.toString()}`,n.Range=r}else this._zeroStart&&(n.Range=`bytes=0-`);return{url:e,headers:n}},e.prototype.removeURLParameters=function(e){return e},e}(),y=function(){function e(e,t){this._startName=e,this._endName=t}return e.prototype.getConfig=function(e,t){var n=e;if(t.from!==0||t.to!==-1){var r=!0;n.indexOf(`?`)===-1&&(n+=`?`,r=!1),r&&(n+=`&`),n+=`${this._startName}=${t.from.toString()}`,t.to!==-1&&(n+=`&${this._endName}=${t.to.toString()}`)}return{url:n,headers:{}}},e.prototype.removeURLParameters=function(e){var t=e.split(`?`)[0],n=void 0,r=e.indexOf(`?`);r!==-1&&(n=e.substring(r+1));var i=``;if(n!=null&&n.length>0)for(var a=n.split(`&`),o=0;o<a.length;o++){var s=a[o].split(`=`),c=o>0;s[0]!==this._startName&&s[0]!==this._endName&&(c&&(i+=`&`),i+=a[o])}return i.length===0?t:t+`?`+i},e}();t.a=function(){function e(e,t,n){this.TAG=`IOController`,this._config=t,this._extraData=n,this._stashInitialSize=65536,t.stashInitialSize!=null&&t.stashInitialSize>0&&(this._stashInitialSize=t.stashInitialSize),this._stashUsed=0,this._stashSize=this._stashInitialSize,this._bufferSize=Math.max(this._stashSize,3145728),this._stashBuffer=new ArrayBuffer(this._bufferSize),this._stashByteStart=0,this._enableStash=!0,!1===t.enableStashBuffer&&(this._enableStash=!1),this._loader=null,this._loaderClass=null,this._seekHandler=null,this._dataSource=e,this._isWebSocketURL=/wss?:\/\/(.+?)/.test(e.url),this._refTotalLength=e.filesize?e.filesize:null,this._totalLength=this._refTotalLength,this._fullRequestFlag=!1,this._currentRange=null,this._redirectedURL=null,this._speedNormalized=0,this._speedSampler=new a,this._speedNormalizeList=[32,64,96,128,192,256,384,512,768,1024,1536,2048,3072,4096],this._isEarlyEofReconnecting=!1,this._paused=!1,this._resumeFrom=0,this._onDataArrival=null,this._onSeeked=null,this._onError=null,this._onComplete=null,this._onRedirect=null,this._onRecoveredEarlyEof=null,this._selectSeekHandler(),this._selectLoader(),this._createLoader()}return e.prototype.destroy=function(){this._loader.isWorking()&&this._loader.abort(),this._loader.destroy(),this._loader=null,this._loaderClass=null,this._dataSource=null,this._stashBuffer=null,this._stashUsed=this._stashSize=this._bufferSize=this._stashByteStart=0,this._currentRange=null,this._speedSampler=null,this._isEarlyEofReconnecting=!1,this._onDataArrival=null,this._onSeeked=null,this._onError=null,this._onComplete=null,this._onRedirect=null,this._onRecoveredEarlyEof=null,this._extraData=null},e.prototype.isWorking=function(){return this._loader&&this._loader.isWorking()&&!this._paused},e.prototype.isPaused=function(){return this._paused},Object.defineProperty(e.prototype,`status`,{get:function(){return this._loader.status},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`extraData`,{get:function(){return this._extraData},set:function(e){this._extraData=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`onDataArrival`,{get:function(){return this._onDataArrival},set:function(e){this._onDataArrival=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`onSeeked`,{get:function(){return this._onSeeked},set:function(e){this._onSeeked=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`onError`,{get:function(){return this._onError},set:function(e){this._onError=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`onComplete`,{get:function(){return this._onComplete},set:function(e){this._onComplete=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`onRedirect`,{get:function(){return this._onRedirect},set:function(e){this._onRedirect=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`onRecoveredEarlyEof`,{get:function(){return this._onRecoveredEarlyEof},set:function(e){this._onRecoveredEarlyEof=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`currentURL`,{get:function(){return this._dataSource.url},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`hasRedirect`,{get:function(){return this._redirectedURL!=null||this._dataSource.redirectedURL!=null},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`currentRedirectedURL`,{get:function(){return this._redirectedURL||this._dataSource.redirectedURL},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`currentSpeed`,{get:function(){return this._loaderClass===h?this._loader.currentSpeed:this._speedSampler.lastSecondKBps},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`loaderType`,{get:function(){return this._loader.type},enumerable:!1,configurable:!0}),e.prototype._selectSeekHandler=function(){var e=this._config;if(e.seekType===`range`)this._seekHandler=new v(this._config.rangeLoadZeroStart);else if(e.seekType===`param`)this._seekHandler=new y(e.seekParamStart||`bstart`,e.seekParamEnd||`bend`);else{if(e.seekType!==`custom`)throw new c.b(`Invalid seekType in config: ${e.seekType}`);if(typeof e.customSeekHandler!=`function`)throw new c.b(`Custom seekType specified in config but invalid customSeekHandler!`);this._seekHandler=new e.customSeekHandler}},e.prototype._selectLoader=function(){if(this._config.customLoader!=null)this._loaderClass=this._config.customLoader;else if(this._isWebSocketURL)this._loaderClass=_;else if(u.isSupported())this._loaderClass=u;else if(f.isSupported())this._loaderClass=f;else{if(!h.isSupported())throw new c.d(`Your browser doesn't support xhr with arraybuffer responseType!`);this._loaderClass=h}},e.prototype._createLoader=function(){this._loader=new this._loaderClass(this._seekHandler,this._config),!1===this._loader.needStashBuffer&&(this._enableStash=!1),this._loader.onContentLengthKnown=this._onContentLengthKnown.bind(this),this._loader.onURLRedirect=this._onURLRedirect.bind(this),this._loader.onDataArrival=this._onLoaderChunkArrival.bind(this),this._loader.onComplete=this._onLoaderComplete.bind(this),this._loader.onError=this._onLoaderError.bind(this)},e.prototype.open=function(e){this._currentRange={from:0,to:-1},e&&(this._currentRange.from=e),this._speedSampler.reset(),e||(this._fullRequestFlag=!0),this._loader.open(this._dataSource,Object.assign({},this._currentRange))},e.prototype.abort=function(){this._loader.abort(),this._paused&&(this._paused=!1,this._resumeFrom=0)},e.prototype.pause=function(){this.isWorking()&&(this._loader.abort(),this._stashUsed===0?this._resumeFrom=this._currentRange.to+1:(this._resumeFrom=this._stashByteStart,this._currentRange.to=this._stashByteStart-1),this._stashUsed=0,this._stashByteStart=0,this._paused=!0)},e.prototype.resume=function(){if(this._paused){this._paused=!1;var e=this._resumeFrom;this._resumeFrom=0,this._internalSeek(e,!0)}},e.prototype.seek=function(e){this._paused=!1,this._stashUsed=0,this._stashByteStart=0,this._internalSeek(e,!0)},e.prototype._internalSeek=function(e,t){this._loader.isWorking()&&this._loader.abort(),this._flushStashBuffer(t),this._loader.destroy(),this._loader=null;var n={from:e,to:-1};this._currentRange={from:n.from,to:-1},this._speedSampler.reset(),this._stashSize=this._stashInitialSize,this._createLoader(),this._loader.open(this._dataSource,n),this._onSeeked&&this._onSeeked()},e.prototype.updateUrl=function(e){if(!e||typeof e!=`string`||e.length===0)throw new c.b(`Url must be a non-empty string!`);this._dataSource.url=e},e.prototype._expandBuffer=function(e){for(var t=this._stashSize;t+1048576<e;)t*=2;if((t+=1048576)!==this._bufferSize){var n=new ArrayBuffer(t);if(this._stashUsed>0){var r=new Uint8Array(this._stashBuffer,0,this._stashUsed);new Uint8Array(n,0,t).set(r,0)}this._stashBuffer=n,this._bufferSize=t}},e.prototype._normalizeSpeed=function(e){var t=this._speedNormalizeList,n=t.length-1,r=0,i=0,a=n;if(e<t[0])return t[0];for(;i<=a;){if((r=i+Math.floor((a-i)/2))===n||e>=t[r]&&e<t[r+1])return t[r];t[r]<e?i=r+1:a=r-1}},e.prototype._adjustStashSize=function(e){var t=0;(t=this._config.isLive?e/8:e<512?e:e>=512&&e<=1024?Math.floor(1.5*e):2*e)>8192&&(t=8192);var n=1024*t+1048576;this._bufferSize<n&&this._expandBuffer(n),this._stashSize=1024*t},e.prototype._dispatchChunks=function(e,t){return this._currentRange.to=t+e.byteLength-1,this._onDataArrival(e,t)},e.prototype._onURLRedirect=function(e){this._redirectedURL=e,this._onRedirect&&this._onRedirect(e)},e.prototype._onContentLengthKnown=function(e){e&&this._fullRequestFlag&&(this._totalLength=e,this._fullRequestFlag=!1)},e.prototype._onLoaderChunkArrival=function(e,t,n){if(!this._onDataArrival)throw new c.a(`IOController: No existing consumer (onDataArrival) callback!`);if(!this._paused){this._isEarlyEofReconnecting&&(this._isEarlyEofReconnecting=!1,this._onRecoveredEarlyEof&&this._onRecoveredEarlyEof()),this._speedSampler.addBytes(e.byteLength);var r=this._speedSampler.lastSecondKBps;if(r!==0){var i=this._normalizeSpeed(r);this._speedNormalized!==i&&(this._speedNormalized=i,this._adjustStashSize(i))}if(this._enableStash)if(this._stashUsed===0&&this._stashByteStart===0&&(this._stashByteStart=t),this._stashUsed+e.byteLength<=this._stashSize)(s=new Uint8Array(this._stashBuffer,0,this._stashSize)).set(new Uint8Array(e),this._stashUsed),this._stashUsed+=e.byteLength;else if(s=new Uint8Array(this._stashBuffer,0,this._bufferSize),this._stashUsed>0){var a=this._stashBuffer.slice(0,this._stashUsed);(l=this._dispatchChunks(a,this._stashByteStart))<a.byteLength?l>0&&(u=new Uint8Array(a,l),s.set(u,0),this._stashUsed=u.byteLength,this._stashByteStart+=l):(this._stashUsed=0,this._stashByteStart+=l),this._stashUsed+e.byteLength>this._bufferSize&&(this._expandBuffer(this._stashUsed+e.byteLength),s=new Uint8Array(this._stashBuffer,0,this._bufferSize)),s.set(new Uint8Array(e),this._stashUsed),this._stashUsed+=e.byteLength}else (l=this._dispatchChunks(e,t))<e.byteLength&&((o=e.byteLength-l)>this._bufferSize&&(this._expandBuffer(o),s=new Uint8Array(this._stashBuffer,0,this._bufferSize)),s.set(new Uint8Array(e,l),0),this._stashUsed+=o,this._stashByteStart=t+l);else if(this._stashUsed===0){var o;(l=this._dispatchChunks(e,t))<e.byteLength&&((o=e.byteLength-l)>this._bufferSize&&this._expandBuffer(o),(s=new Uint8Array(this._stashBuffer,0,this._bufferSize)).set(new Uint8Array(e,l),0),this._stashUsed+=o,this._stashByteStart=t+l)}else{var s,l;if(this._stashUsed+e.byteLength>this._bufferSize&&this._expandBuffer(this._stashUsed+e.byteLength),(s=new Uint8Array(this._stashBuffer,0,this._bufferSize)).set(new Uint8Array(e),this._stashUsed),this._stashUsed+=e.byteLength,(l=this._dispatchChunks(this._stashBuffer.slice(0,this._stashUsed),this._stashByteStart))<this._stashUsed&&l>0){var u=new Uint8Array(this._stashBuffer,l);s.set(u,0)}this._stashUsed-=l,this._stashByteStart+=l}}},e.prototype._flushStashBuffer=function(e){if(this._stashUsed>0){var t=this._stashBuffer.slice(0,this._stashUsed),n=this._dispatchChunks(t,this._stashByteStart),r=t.byteLength-n;if(n<t.byteLength){if(!e){if(n>0){var a=new Uint8Array(this._stashBuffer,0,this._bufferSize),o=new Uint8Array(t,n);a.set(o,0),this._stashUsed=o.byteLength,this._stashByteStart+=n}return 0}i.a.w(this.TAG,`${r} bytes unconsumed data remain when flush buffer, dropped`)}return this._stashUsed=0,this._stashByteStart=0,r}return 0},e.prototype._onLoaderComplete=function(e,t){this._flushStashBuffer(!0),this._onComplete&&this._onComplete(this._extraData)},e.prototype._onLoaderError=function(e,t){switch(i.a.e(this.TAG,`Loader error, code = ${t.code}, msg = ${t.msg}`),this._flushStashBuffer(!1),this._isEarlyEofReconnecting&&(this._isEarlyEofReconnecting=!1,e=o.b.UNRECOVERABLE_EARLY_EOF),e){case o.b.EARLY_EOF:if(!this._config.isLive&&this._totalLength){var n=this._currentRange.to+1;n<this._totalLength&&(i.a.w(this.TAG,`Connection lost, trying reconnect...`),this._isEarlyEofReconnecting=!0,this._internalSeek(n,!1));return}e=o.b.UNRECOVERABLE_EARLY_EOF;break;case o.b.UNRECOVERABLE_EARLY_EOF:case o.b.CONNECTING_TIMEOUT:case o.b.HTTP_STATUS_CODE_INVALID:case o.b.EXCEPTION:}if(!this._onError)throw new c.d(`IOException: `+t.msg);this._onError(e,t)},e}()},function(e,t,n){var r=function(){function e(){}return e.install=function(){Object.setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Object.assign=Object.assign||function(e){if(e==null)throw TypeError(`Cannot convert undefined or null to object`);for(var t=Object(e),n=1;n<arguments.length;n++){var r=arguments[n];if(r!=null)for(var i in r)r.hasOwnProperty(i)&&(t[i]=r[i])}return t},String.prototype.startsWith||Object.defineProperty(String.prototype,`startsWith`,{value:function(e,t){var n=t>0?0|t:0;return this.substring(n,n+e.length)===e}}),typeof self.Promise!=`function`&&n(21).polyfill()},e}();r.install(),t.a=r},function(e,t,n){var r=n(9),i=n.n(r),a=n(0),o=n(5),s=n(7),c=n(3);t.a=function(){function e(e){this.TAG=`MSEController`,this._config=e,this._emitter=new i.a,this._config.isLive&&this._config.autoCleanupSourceBuffer==null&&(this._config.autoCleanupSourceBuffer=!0),this.e={onSourceOpen:this._onSourceOpen.bind(this),onSourceEnded:this._onSourceEnded.bind(this),onSourceClose:this._onSourceClose.bind(this),onStartStreaming:this._onStartStreaming.bind(this),onEndStreaming:this._onEndStreaming.bind(this),onQualityChange:this._onQualityChange.bind(this),onSourceBufferError:this._onSourceBufferError.bind(this),onSourceBufferUpdateEnd:this._onSourceBufferUpdateEnd.bind(this)},this._useManagedMediaSource=`ManagedMediaSource`in self&&!(`MediaSource`in self),this._mediaSource=null,this._mediaSourceObjectURL=null,this._mediaElementProxy=null,this._isBufferFull=!1,this._hasPendingEos=!1,this._requireSetMediaDuration=!1,this._pendingMediaDuration=0,this._pendingSourceBufferInit=[],this._mimeTypes={video:null,audio:null},this._sourceBuffers={video:null,audio:null},this._lastInitSegments={video:null,audio:null},this._pendingSegments={video:[],audio:[]},this._pendingRemoveRanges={video:[],audio:[]}}return e.prototype.destroy=function(){this._mediaSource&&this.shutdown(),this._mediaSourceObjectURL&&this.revokeObjectURL(),this.e=null,this._emitter.removeAllListeners(),this._emitter=null},e.prototype.on=function(e,t){this._emitter.addListener(e,t)},e.prototype.off=function(e,t){this._emitter.removeListener(e,t)},e.prototype.initialize=function(e){if(this._mediaSource)throw new c.a(`MediaSource has been attached to an HTMLMediaElement!`);this._useManagedMediaSource&&a.a.v(this.TAG,`Using ManagedMediaSource`);var t=this._mediaSource=this._useManagedMediaSource?new self.ManagedMediaSource:new self.MediaSource;t.addEventListener(`sourceopen`,this.e.onSourceOpen),t.addEventListener(`sourceended`,this.e.onSourceEnded),t.addEventListener(`sourceclose`,this.e.onSourceClose),this._useManagedMediaSource&&(t.addEventListener(`startstreaming`,this.e.onStartStreaming),t.addEventListener(`endstreaming`,this.e.onEndStreaming),t.addEventListener(`qualitychange`,this.e.onQualityChange)),this._mediaElementProxy=e},e.prototype.shutdown=function(){if(this._mediaSource){var e=this._mediaSource;for(var t in this._sourceBuffers){var n=this._pendingSegments[t];n.splice(0,n.length),this._pendingSegments[t]=null,this._pendingRemoveRanges[t]=null,this._lastInitSegments[t]=null;var r=this._sourceBuffers[t];if(r){if(e.readyState!==`closed`){try{e.removeSourceBuffer(r)}catch(e){a.a.e(this.TAG,e.message)}r.removeEventListener(`error`,this.e.onSourceBufferError),r.removeEventListener(`updateend`,this.e.onSourceBufferUpdateEnd)}this._mimeTypes[t]=null,this._sourceBuffers[t]=null}}if(e.readyState===`open`)try{e.endOfStream()}catch(e){a.a.e(this.TAG,e.message)}this._mediaElementProxy=null,e.removeEventListener(`sourceopen`,this.e.onSourceOpen),e.removeEventListener(`sourceended`,this.e.onSourceEnded),e.removeEventListener(`sourceclose`,this.e.onSourceClose),this._useManagedMediaSource&&(e.removeEventListener(`startstreaming`,this.e.onStartStreaming),e.removeEventListener(`endstreaming`,this.e.onEndStreaming),e.removeEventListener(`qualitychange`,this.e.onQualityChange)),this._pendingSourceBufferInit=[],this._isBufferFull=!1,this._mediaSource=null}},e.prototype.isManagedMediaSource=function(){return this._useManagedMediaSource},e.prototype.getObject=function(){if(!this._mediaSource)throw new c.a(`MediaSource has not been initialized yet!`);return this._mediaSource},e.prototype.getHandle=function(){if(!this._mediaSource)throw new c.a(`MediaSource has not been initialized yet!`);return this._mediaSource.handle},e.prototype.getObjectURL=function(){if(!this._mediaSource)throw new c.a(`MediaSource has not been initialized yet!`);return this._mediaSourceObjectURL??=URL.createObjectURL(this._mediaSource),this._mediaSourceObjectURL},e.prototype.revokeObjectURL=function(){this._mediaSourceObjectURL&&=(URL.revokeObjectURL(this._mediaSourceObjectURL),null)},e.prototype.appendInitSegment=function(e,t){if(t===void 0&&(t=void 0),!this._mediaSource||this._mediaSource.readyState!==`open`||!1===this._mediaSource.streaming)return this._pendingSourceBufferInit.push(e),void this._pendingSegments[e.type].push(e);var n=e,r=`${n.container}`;n.codec&&n.codec.length>0&&(n.codec===`opus`&&o.a.safari&&(n.codec=`Opus`),r+=`;codecs=${n.codec}`);var i=!1;if(a.a.v(this.TAG,`Received Initialization Segment, mimeType: `+r),this._lastInitSegments[n.type]=n,r!==this._mimeTypes[n.type]){if(this._mimeTypes[n.type])a.a.v(this.TAG,`Notice: ${n.type} mimeType changed, origin: ${this._mimeTypes[n.type]}, target: ${r}`);else{i=!0;try{var c=this._sourceBuffers[n.type]=this._mediaSource.addSourceBuffer(r);c.addEventListener(`error`,this.e.onSourceBufferError),c.addEventListener(`updateend`,this.e.onSourceBufferUpdateEnd)}catch(e){a.a.e(this.TAG,e.message),this._emitter.emit(s.a.ERROR,{code:e.code,msg:e.message});return}}this._mimeTypes[n.type]=r}t||this._pendingSegments[n.type].push(n),i||this._sourceBuffers[n.type]&&!this._sourceBuffers[n.type].updating&&this._doAppendSegments(),o.a.safari&&n.container===`audio/mpeg`&&n.mediaDuration>0&&(this._requireSetMediaDuration=!0,this._pendingMediaDuration=n.mediaDuration/1e3,this._updateMediaSourceDuration())},e.prototype.appendMediaSegment=function(e){var t=e;this._pendingSegments[t.type].push(t),this._config.autoCleanupSourceBuffer&&this._needCleanupSourceBuffer()&&this._doCleanupSourceBuffer();var n=this._sourceBuffers[t.type];!n||n.updating||this._hasPendingRemoveRanges()||this._doAppendSegments()},e.prototype.flush=function(){for(var e in this._sourceBuffers)if(this._sourceBuffers[e]){var t=this._sourceBuffers[e];if(this._mediaSource.readyState===`open`)try{t.abort()}catch(e){a.a.e(this.TAG,e.message)}var n=this._pendingSegments[e];if(n.splice(0,n.length),this._mediaSource.readyState!==`closed`){for(var r=0;r<t.buffered.length;r++){var i=t.buffered.start(r),s=t.buffered.end(r);this._pendingRemoveRanges[e].push({start:i,end:s})}if(t.updating||this._doRemoveRanges(),o.a.safari){var c=this._lastInitSegments[e];c&&(this._pendingSegments[e].push(c),t.updating||this._doAppendSegments())}}}},e.prototype.endOfStream=function(){var e=this._mediaSource,t=this._sourceBuffers;e&&e.readyState===`open`?t.video&&t.video.updating||t.audio&&t.audio.updating?this._hasPendingEos=!0:(this._hasPendingEos=!1,e.endOfStream()):e&&e.readyState===`closed`&&this._hasPendingSegments()&&(this._hasPendingEos=!0)},e.prototype._needCleanupSourceBuffer=function(){if(!this._config.autoCleanupSourceBuffer)return!1;var e=this._mediaElementProxy.getCurrentTime();for(var t in this._sourceBuffers){var n=this._sourceBuffers[t];if(n){var r=n.buffered;if(r.length>=1&&e-r.start(0)>=this._config.autoCleanupMaxBackwardDuration)return!0}}return!1},e.prototype._doCleanupSourceBuffer=function(){var e=this._mediaElementProxy.getCurrentTime();for(var t in this._sourceBuffers){var n=this._sourceBuffers[t];if(n){for(var r=n.buffered,i=!1,a=0;a<r.length;a++){var o=r.start(a),s=r.end(a);if(o<=e&&e<s+3){if(e-o>=this._config.autoCleanupMaxBackwardDuration){i=!0;var c=e-this._config.autoCleanupMinBackwardDuration;this._pendingRemoveRanges[t].push({start:o,end:c})}}else s<e&&(i=!0,this._pendingRemoveRanges[t].push({start:o,end:s}))}i&&!n.updating&&this._doRemoveRanges()}}},e.prototype._updateMediaSourceDuration=function(){var e=this._sourceBuffers;if(this._mediaElementProxy.getReadyState()!==0&&this._mediaSource.readyState===`open`&&!(e.video&&e.video.updating||e.audio&&e.audio.updating)){var t=this._mediaSource.duration,n=this._pendingMediaDuration;n>0&&(isNaN(t)||n>t)&&(a.a.v(this.TAG,`Update MediaSource duration from ${t} to ${n}`),this._mediaSource.duration=n),this._requireSetMediaDuration=!1,this._pendingMediaDuration=0}},e.prototype._doRemoveRanges=function(){for(var e in this._pendingRemoveRanges)if(this._sourceBuffers[e]&&!this._sourceBuffers[e].updating)for(var t=this._sourceBuffers[e],n=this._pendingRemoveRanges[e];n.length&&!t.updating;){var r=n.shift();t.remove(r.start,r.end)}},e.prototype._doAppendSegments=function(){var e=this._pendingSegments;for(var t in e)if(this._sourceBuffers[t]&&!this._sourceBuffers[t].updating&&!1!==this._mediaSource.streaming&&e[t].length>0){var n=e[t].shift();if(typeof n.timestampOffset==`number`&&isFinite(n.timestampOffset)){var r=this._sourceBuffers[t].timestampOffset,i=n.timestampOffset/1e3;Math.abs(r-i)>.1&&(a.a.v(this.TAG,`Update MPEG audio timestampOffset from ${r} to ${i}`),this._sourceBuffers[t].timestampOffset=i),delete n.timestampOffset}if(!n.data||n.data.byteLength===0)continue;try{this._sourceBuffers[t].appendBuffer(n.data),this._isBufferFull=!1}catch(e){this._pendingSegments[t].unshift(n),e.code===22?(this._isBufferFull||this._emitter.emit(s.a.BUFFER_FULL),this._isBufferFull=!0):(a.a.e(this.TAG,e.message),this._emitter.emit(s.a.ERROR,{code:e.code,msg:e.message}))}}},e.prototype._onSourceOpen=function(){if(a.a.v(this.TAG,`MediaSource onSourceOpen`),this._mediaSource.removeEventListener(`sourceopen`,this.e.onSourceOpen),this._pendingSourceBufferInit.length>0)for(var e=this._pendingSourceBufferInit;e.length;){var t=e.shift();this.appendInitSegment(t,!0)}this._hasPendingSegments()&&this._doAppendSegments(),this._emitter.emit(s.a.SOURCE_OPEN)},e.prototype._onStartStreaming=function(){a.a.v(this.TAG,`ManagedMediaSource onStartStreaming`),this._emitter.emit(s.a.START_STREAMING)},e.prototype._onEndStreaming=function(){a.a.v(this.TAG,`ManagedMediaSource onEndStreaming`),this._emitter.emit(s.a.END_STREAMING)},e.prototype._onQualityChange=function(){a.a.v(this.TAG,`ManagedMediaSource onQualityChange`)},e.prototype._onSourceEnded=function(){a.a.v(this.TAG,`MediaSource onSourceEnded`)},e.prototype._onSourceClose=function(){a.a.v(this.TAG,`MediaSource onSourceClose`),this._mediaSource&&this.e!=null&&(this._mediaSource.removeEventListener(`sourceopen`,this.e.onSourceOpen),this._mediaSource.removeEventListener(`sourceended`,this.e.onSourceEnded),this._mediaSource.removeEventListener(`sourceclose`,this.e.onSourceClose),this._useManagedMediaSource&&(this._mediaSource.removeEventListener(`startstreaming`,this.e.onStartStreaming),this._mediaSource.removeEventListener(`endstreaming`,this.e.onEndStreaming),this._mediaSource.removeEventListener(`qualitychange`,this.e.onQualityChange)))},e.prototype._hasPendingSegments=function(){var e=this._pendingSegments;return e.video.length>0||e.audio.length>0},e.prototype._hasPendingRemoveRanges=function(){var e=this._pendingRemoveRanges;return e.video.length>0||e.audio.length>0},e.prototype._onSourceBufferUpdateEnd=function(){this._requireSetMediaDuration?this._updateMediaSourceDuration():this._hasPendingRemoveRanges()?this._doRemoveRanges():this._hasPendingSegments()?this._doAppendSegments():this._hasPendingEos&&this.endOfStream(),this._emitter.emit(s.a.UPDATE_END)},e.prototype._onSourceBufferError=function(e){a.a.e(this.TAG,`SourceBuffer Error: ${e}`)},e}()},function(e,t,n){var r=n(9),i=n.n(r),a=n(18),o=n.n(a),s=n(0),c=n(8),l=n(13),u=n(1),d=(n(19),n(12));t.a=function(){function e(e,t){if(this.TAG=`Transmuxer`,this._emitter=new i.a,t.enableWorker&&typeof Worker<`u`)try{this._worker=o()(19),this._workerDestroying=!1,this._worker.addEventListener(`message`,this._onWorkerMessage.bind(this)),this._worker.postMessage({cmd:`init`,param:[e,t]}),this.e={onLoggingConfigChanged:this._onLoggingConfigChanged.bind(this)},c.a.registerListener(this.e.onLoggingConfigChanged),this._worker.postMessage({cmd:`logging_config`,param:c.a.getConfig()})}catch{s.a.e(this.TAG,`Error while initialize transmuxing worker, fallback to inline transmuxing`),this._worker=null,this._controller=new l.a(e,t)}else this._controller=new l.a(e,t);if(this._controller){var n=this._controller;n.on(u.a.IO_ERROR,this._onIOError.bind(this)),n.on(u.a.DEMUX_ERROR,this._onDemuxError.bind(this)),n.on(u.a.INIT_SEGMENT,this._onInitSegment.bind(this)),n.on(u.a.MEDIA_SEGMENT,this._onMediaSegment.bind(this)),n.on(u.a.LOADING_COMPLETE,this._onLoadingComplete.bind(this)),n.on(u.a.RECOVERED_EARLY_EOF,this._onRecoveredEarlyEof.bind(this)),n.on(u.a.MEDIA_INFO,this._onMediaInfo.bind(this)),n.on(u.a.METADATA_ARRIVED,this._onMetaDataArrived.bind(this)),n.on(u.a.SCRIPTDATA_ARRIVED,this._onScriptDataArrived.bind(this)),n.on(u.a.TIMED_ID3_METADATA_ARRIVED,this._onTimedID3MetadataArrived.bind(this)),n.on(u.a.SYNCHRONOUS_KLV_METADATA_ARRIVED,this._onSynchronousKLVMetadataArrived.bind(this)),n.on(u.a.ASYNCHRONOUS_KLV_METADATA_ARRIVED,this._onAsynchronousKLVMetadataArrived.bind(this)),n.on(u.a.SMPTE2038_METADATA_ARRIVED,this._onSMPTE2038MetadataArrived.bind(this)),n.on(u.a.SCTE35_METADATA_ARRIVED,this._onSCTE35MetadataArrived.bind(this)),n.on(u.a.PES_PRIVATE_DATA_DESCRIPTOR,this._onPESPrivateDataDescriptor.bind(this)),n.on(u.a.PES_PRIVATE_DATA_ARRIVED,this._onPESPrivateDataArrived.bind(this)),n.on(u.a.STATISTICS_INFO,this._onStatisticsInfo.bind(this)),n.on(u.a.RECOMMEND_SEEKPOINT,this._onRecommendSeekpoint.bind(this))}}return e.prototype.destroy=function(){this._worker?this._workerDestroying||(this._workerDestroying=!0,this._worker.postMessage({cmd:`destroy`}),c.a.removeListener(this.e.onLoggingConfigChanged),this.e=null):(this._controller.destroy(),this._controller=null),this._emitter.removeAllListeners(),this._emitter=null},e.prototype.on=function(e,t){this._emitter.addListener(e,t)},e.prototype.off=function(e,t){this._emitter.removeListener(e,t)},e.prototype.hasWorker=function(){return this._worker!=null},e.prototype.open=function(){this._worker?this._worker.postMessage({cmd:`start`}):this._controller.start()},e.prototype.close=function(){this._worker?this._worker.postMessage({cmd:`stop`}):this._controller.stop()},e.prototype.seek=function(e){this._worker?this._worker.postMessage({cmd:`seek`,param:e}):this._controller.seek(e)},e.prototype.pause=function(){this._worker?this._worker.postMessage({cmd:`pause`}):this._controller.pause()},e.prototype.resume=function(){this._worker?this._worker.postMessage({cmd:`resume`}):this._controller.resume()},e.prototype._onInitSegment=function(e,t){var n=this;Promise.resolve().then((function(){n._emitter.emit(u.a.INIT_SEGMENT,e,t)}))},e.prototype._onMediaSegment=function(e,t){var n=this;Promise.resolve().then((function(){n._emitter.emit(u.a.MEDIA_SEGMENT,e,t)}))},e.prototype._onLoadingComplete=function(){var e=this;Promise.resolve().then((function(){e._emitter.emit(u.a.LOADING_COMPLETE)}))},e.prototype._onRecoveredEarlyEof=function(){var e=this;Promise.resolve().then((function(){e._emitter.emit(u.a.RECOVERED_EARLY_EOF)}))},e.prototype._onMediaInfo=function(e){var t=this;Promise.resolve().then((function(){t._emitter.emit(u.a.MEDIA_INFO,e)}))},e.prototype._onMetaDataArrived=function(e){var t=this;Promise.resolve().then((function(){t._emitter.emit(u.a.METADATA_ARRIVED,e)}))},e.prototype._onScriptDataArrived=function(e){var t=this;Promise.resolve().then((function(){t._emitter.emit(u.a.SCRIPTDATA_ARRIVED,e)}))},e.prototype._onTimedID3MetadataArrived=function(e){var t=this;Promise.resolve().then((function(){t._emitter.emit(u.a.TIMED_ID3_METADATA_ARRIVED,e)}))},e.prototype._onSynchronousKLVMetadataArrived=function(e){var t=this;Promise.resolve().then((function(){t._emitter.emit(u.a.SYNCHRONOUS_KLV_METADATA_ARRIVED,e)}))},e.prototype._onAsynchronousKLVMetadataArrived=function(e){var t=this;Promise.resolve().then((function(){t._emitter.emit(u.a.ASYNCHRONOUS_KLV_METADATA_ARRIVED,e)}))},e.prototype._onSMPTE2038MetadataArrived=function(e){var t=this;Promise.resolve().then((function(){t._emitter.emit(u.a.SMPTE2038_METADATA_ARRIVED,e)}))},e.prototype._onSCTE35MetadataArrived=function(e){var t=this;Promise.resolve().then((function(){t._emitter.emit(u.a.SCTE35_METADATA_ARRIVED,e)}))},e.prototype._onPESPrivateDataDescriptor=function(e){var t=this;Promise.resolve().then((function(){t._emitter.emit(u.a.PES_PRIVATE_DATA_DESCRIPTOR,e)}))},e.prototype._onPESPrivateDataArrived=function(e){var t=this;Promise.resolve().then((function(){t._emitter.emit(u.a.PES_PRIVATE_DATA_ARRIVED,e)}))},e.prototype._onStatisticsInfo=function(e){var t=this;Promise.resolve().then((function(){t._emitter.emit(u.a.STATISTICS_INFO,e)}))},e.prototype._onIOError=function(e,t){var n=this;Promise.resolve().then((function(){n._emitter.emit(u.a.IO_ERROR,e,t)}))},e.prototype._onDemuxError=function(e,t){var n=this;Promise.resolve().then((function(){n._emitter.emit(u.a.DEMUX_ERROR,e,t)}))},e.prototype._onRecommendSeekpoint=function(e){var t=this;Promise.resolve().then((function(){t._emitter.emit(u.a.RECOMMEND_SEEKPOINT,e)}))},e.prototype._onLoggingConfigChanged=function(e){this._worker&&this._worker.postMessage({cmd:`logging_config`,param:e})},e.prototype._onWorkerMessage=function(e){var t=e.data,n=t.data;if(t.msg===`destroyed`||this._workerDestroying)return this._workerDestroying=!1,this._worker.terminate(),void(this._worker=null);switch(t.msg){case u.a.INIT_SEGMENT:case u.a.MEDIA_SEGMENT:this._emitter.emit(t.msg,n.type,n.data);break;case u.a.LOADING_COMPLETE:case u.a.RECOVERED_EARLY_EOF:this._emitter.emit(t.msg);break;case u.a.MEDIA_INFO:Object.setPrototypeOf(n,d.a.prototype),this._emitter.emit(t.msg,n);break;case u.a.METADATA_ARRIVED:case u.a.SCRIPTDATA_ARRIVED:case u.a.TIMED_ID3_METADATA_ARRIVED:case u.a.SYNCHRONOUS_KLV_METADATA_ARRIVED:case u.a.ASYNCHRONOUS_KLV_METADATA_ARRIVED:case u.a.SMPTE2038_METADATA_ARRIVED:case u.a.SCTE35_METADATA_ARRIVED:case u.a.PES_PRIVATE_DATA_DESCRIPTOR:case u.a.PES_PRIVATE_DATA_ARRIVED:case u.a.STATISTICS_INFO:this._emitter.emit(t.msg,n);break;case u.a.IO_ERROR:case u.a.DEMUX_ERROR:this._emitter.emit(t.msg,n.type,n.info);break;case u.a.RECOMMEND_SEEKPOINT:this._emitter.emit(t.msg,n);break;case`logcat_callback`:s.a.emitter.emit(`log`,n.type,n.logcat)}},e}()},function(e,t,n){function r(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.i=function(e){return e},n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.r=function(e){Object.defineProperty(e,`__esModule`,{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,`a`,t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p=`/`,n.oe=function(e){throw console.error(e),e};var r=n(n.s=ENTRY_MODULE);return r.default||r}function i(e){return(e+``).replace(/[.?*+^$[\]\\(){}|-]/g,`\\$&`)}function a(e,t,r){var a={};a[r]=[];var o=t.toString(),s=o.match(/^function\s?\w*\(\w+,\s*\w+,\s*(\w+)\)/);if(!s)return a;for(var c,l=s[1],u=RegExp(`(\\\\n|\\W)`+i(l)+`\\(\\s*(/\\*.*?\\*/)?\\s*.*?([\\.|\\-|\\+|\\w|/|@]+).*?\\)`,`g`);c=u.exec(o);)c[3]!==`dll-reference`&&a[r].push(c[3]);for(u=RegExp(`\\(`+i(l)+`\\("(dll-reference\\s([\\.|\\-|\\+|\\w|/|@]+))"\\)\\)\\(\\s*(/\\*.*?\\*/)?\\s*.*?([\\.|\\-|\\+|\\w|/|@]+).*?\\)`,`g`);c=u.exec(o);)e[c[2]]||(a[r].push(c[1]),e[c[2]]=n(c[1]).m),a[c[2]]=a[c[2]]||[],a[c[2]].push(c[4]);for(var d,f=Object.keys(a),p=0;p<f.length;p++)for(var m=0;m<a[f[p]].length;m++)d=a[f[p]][m],isNaN(1*d)||(a[f[p]][m]=1*a[f[p]][m]);return a}function o(e){return Object.keys(e).reduce((function(t,n){return t||e[n].length>0}),!1)}e.exports=function(e,t){t||={};var i={main:n.m},s=t.all?{main:Object.keys(i.main)}:function(e,t){for(var n={main:[t]},r={main:[]},i={main:{}};o(n);)for(var s=Object.keys(n),c=0;c<s.length;c++){var l=s[c],u=n[l].pop();if(i[l]=i[l]||{},!i[l][u]&&e[l][u]){i[l][u]=!0,r[l]=r[l]||[],r[l].push(u);for(var d=a(e,e[l][u],l),f=Object.keys(d),p=0;p<f.length;p++)n[f[p]]=n[f[p]]||[],n[f[p]]=n[f[p]].concat(d[f[p]])}}return r}(i,e),c=``;Object.keys(s).filter((function(e){return e!==`main`})).forEach((function(e){for(var t=0;s[e][t];)t++;s[e].push(t),i[e][t]=`(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })`,c=c+`var `+e+` = (`+r.toString().replace(`ENTRY_MODULE`,JSON.stringify(t))+`)({`+s[e].map((function(t){return JSON.stringify(t)+`: `+i[e][t].toString()})).join(`,`)+`});
`})),c=c+`new ((`+r.toString().replace(`ENTRY_MODULE`,JSON.stringify(e))+`)({`+s.main.map((function(e){return JSON.stringify(e)+`: `+i.main[e].toString()})).join(`,`)+`}))(self);`;var l=new self.Blob([c],{type:`text/javascript`});if(t.bare)return l;var u=(self.URL||self.webkitURL||self.mozURL||self.msURL).createObjectURL(l),d=new self.Worker(u);return d.objectURL=u,d}},function(e,t,n){n.r(t),n(0);var r=n(8),i=n(15),a=n(13),o=n(1);t.default=function(e){var t=null,n=function(t,n){e.postMessage({msg:`logcat_callback`,data:{type:t,logcat:n}})}.bind(this);function s(t,n){var r={msg:o.a.INIT_SEGMENT,data:{type:t,data:n}};e.postMessage(r,[n.data])}function c(t,n){var r={msg:o.a.MEDIA_SEGMENT,data:{type:t,data:n}};e.postMessage(r,[n.data])}function l(){var t={msg:o.a.LOADING_COMPLETE};e.postMessage(t)}function u(){var t={msg:o.a.RECOVERED_EARLY_EOF};e.postMessage(t)}function d(t){var n={msg:o.a.MEDIA_INFO,data:t};e.postMessage(n)}function f(t){var n={msg:o.a.METADATA_ARRIVED,data:t};e.postMessage(n)}function p(t){var n={msg:o.a.SCRIPTDATA_ARRIVED,data:t};e.postMessage(n)}function m(t){var n={msg:o.a.TIMED_ID3_METADATA_ARRIVED,data:t};e.postMessage(n)}function h(t){var n={msg:o.a.SYNCHRONOUS_KLV_METADATA_ARRIVED,data:t};e.postMessage(n)}function g(t){var n={msg:o.a.ASYNCHRONOUS_KLV_METADATA_ARRIVED,data:t};e.postMessage(n)}function _(t){var n={msg:o.a.SMPTE2038_METADATA_ARRIVED,data:t};e.postMessage(n)}function v(t){var n={msg:o.a.SCTE35_METADATA_ARRIVED,data:t};e.postMessage(n)}function y(t){var n={msg:o.a.PES_PRIVATE_DATA_DESCRIPTOR,data:t};e.postMessage(n)}function b(t){var n={msg:o.a.PES_PRIVATE_DATA_ARRIVED,data:t};e.postMessage(n)}function x(t){var n={msg:o.a.STATISTICS_INFO,data:t};e.postMessage(n)}function S(t,n){e.postMessage({msg:o.a.IO_ERROR,data:{type:t,info:n}})}function C(t,n){e.postMessage({msg:o.a.DEMUX_ERROR,data:{type:t,info:n}})}function w(t){e.postMessage({msg:o.a.RECOMMEND_SEEKPOINT,data:t})}i.a.install(),e.addEventListener(`message`,(function(i){switch(i.data.cmd){case`init`:(t=new a.a(i.data.param[0],i.data.param[1])).on(o.a.IO_ERROR,S.bind(this)),t.on(o.a.DEMUX_ERROR,C.bind(this)),t.on(o.a.INIT_SEGMENT,s.bind(this)),t.on(o.a.MEDIA_SEGMENT,c.bind(this)),t.on(o.a.LOADING_COMPLETE,l.bind(this)),t.on(o.a.RECOVERED_EARLY_EOF,u.bind(this)),t.on(o.a.MEDIA_INFO,d.bind(this)),t.on(o.a.METADATA_ARRIVED,f.bind(this)),t.on(o.a.SCRIPTDATA_ARRIVED,p.bind(this)),t.on(o.a.TIMED_ID3_METADATA_ARRIVED,m.bind(this)),t.on(o.a.SYNCHRONOUS_KLV_METADATA_ARRIVED,h.bind(this)),t.on(o.a.ASYNCHRONOUS_KLV_METADATA_ARRIVED,g.bind(this)),t.on(o.a.SMPTE2038_METADATA_ARRIVED,_.bind(this)),t.on(o.a.SCTE35_METADATA_ARRIVED,v.bind(this)),t.on(o.a.PES_PRIVATE_DATA_DESCRIPTOR,y.bind(this)),t.on(o.a.PES_PRIVATE_DATA_ARRIVED,b.bind(this)),t.on(o.a.STATISTICS_INFO,x.bind(this)),t.on(o.a.RECOMMEND_SEEKPOINT,w.bind(this));break;case`destroy`:t&&=(t.destroy(),null),e.postMessage({msg:`destroyed`});break;case`start`:t.start();break;case`stop`:t.stop();break;case`seek`:t.seek(i.data.param);break;case`pause`:t.pause();break;case`resume`:t.resume();break;case`logging_config`:var T=i.data.param;r.a.applyConfig(T),!0===T.enableCallback?r.a.addLogListener(n):r.a.removeLogListener(n)}}))}},function(e,t,n){e.exports=n(25).default},function(e,t,n){(function(t,n){e.exports=function(){function e(e){return typeof e==`function`}var r=Array.isArray?Array.isArray:function(e){return Object.prototype.toString.call(e)===`[object Array]`},i=0,a=void 0,o=void 0,s=function(e,t){m[i]=e,m[i+1]=t,(i+=2)===2&&(o?o(h):b())},c=typeof window<`u`?window:void 0,l=c||{},u=l.MutationObserver||l.WebKitMutationObserver,d=typeof self>`u`&&t!==void 0&&{}.toString.call(t)===`[object process]`,f=typeof Uint8ClampedArray<`u`&&typeof importScripts<`u`&&typeof MessageChannel<`u`;function p(){var e=setTimeout;return function(){return e(h,1)}}var m=Array(1e3);function h(){for(var e=0;e<i;e+=2)(0,m[e])(m[e+1]),m[e]=void 0,m[e+1]=void 0;i=0}var g,_,v,y,b=void 0;function x(e,t){var n=this,r=new this.constructor(w);r[C]===void 0&&P(r);var i=n._state;if(i){var a=arguments[i-1];s((function(){return M(i,r,a,n._result)}))}else A(n,r,e,t);return r}function S(e){if(e&&typeof e==`object`&&e.constructor===this)return e;var t=new this(w);return E(t,e),t}d?b=function(){return t.nextTick(h)}:u?(_=0,v=new u(h),y=document.createTextNode(``),v.observe(y,{characterData:!0}),b=function(){y.data=_=++_%2}):f?((g=new MessageChannel).port1.onmessage=h,b=function(){return g.port2.postMessage(0)}):b=c===void 0?function(){try{var e=Function(`return this`)().require(`vertx`);return(a=e.runOnLoop||e.runOnContext)===void 0?p():function(){a(h)}}catch{return p()}}():p();var C=Math.random().toString(36).substring(2);function w(){}function T(t,n,r){n.constructor===t.constructor&&r===x&&n.constructor.resolve===S?function(e,t){t._state===1?O(e,t._result):t._state===2?k(e,t._result):A(t,void 0,(function(t){return E(e,t)}),(function(t){return k(e,t)}))}(t,n):r===void 0?O(t,n):e(r)?function(e,t,n){s((function(e){var r=!1,i=function(e,t,n,r){try{e.call(t,n,r)}catch(e){return e}}(n,t,(function(n){r||(r=!0,t===n?O(e,n):E(e,n))}),(function(t){r||(r=!0,k(e,t))}),e._label);!r&&i&&(r=!0,k(e,i))}),e)}(t,n,r):O(t,n)}function E(e,t){if(e===t)k(e,TypeError(`You cannot resolve a promise with itself`));else if(i=typeof(r=t),r===null||i!==`object`&&i!==`function`)O(e,t);else{var n=void 0;try{n=t.then}catch(t){k(e,t);return}T(e,t,n)}var r,i}function D(e){e._onerror&&e._onerror(e._result),j(e)}function O(e,t){e._state===void 0&&(e._result=t,e._state=1,e._subscribers.length!==0&&s(j,e))}function k(e,t){e._state===void 0&&(e._state=2,e._result=t,s(D,e))}function A(e,t,n,r){var i=e._subscribers,a=i.length;e._onerror=null,i[a]=t,i[a+1]=n,i[a+2]=r,a===0&&e._state&&s(j,e)}function j(e){var t=e._subscribers,n=e._state;if(t.length!==0){for(var r=void 0,i=void 0,a=e._result,o=0;o<t.length;o+=3)r=t[o],i=t[o+n],r?M(n,r,i,a):i(a);e._subscribers.length=0}}function M(t,n,r,i){var a=e(r),o=void 0,s=void 0,c=!0;if(a){try{o=r(i)}catch(e){c=!1,s=e}if(n===o)return void k(n,TypeError(`A promises callback cannot return that same promise.`))}else o=i;n._state!==void 0||(a&&c?E(n,o):!1===c?k(n,s):t===1?O(n,o):t===2&&k(n,o))}var N=0;function P(e){e[C]=N++,e._state=void 0,e._result=void 0,e._subscribers=[]}var F=function(){function e(e,t){this._instanceConstructor=e,this.promise=new e(w),this.promise[C]||P(this.promise),r(t)?(this.length=t.length,this._remaining=t.length,this._result=Array(this.length),this.length===0?O(this.promise,this._result):(this.length=this.length||0,this._enumerate(t),this._remaining===0&&O(this.promise,this._result))):k(this.promise,Error(`Array Methods must be provided an Array`))}return e.prototype._enumerate=function(e){for(var t=0;this._state===void 0&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,r=n.resolve;if(r===S){var i=void 0,a=void 0,o=!1;try{i=e.then}catch(e){o=!0,a=e}if(i===x&&e._state!==void 0)this._settledAt(e._state,t,e._result);else if(typeof i!=`function`)this._remaining--,this._result[t]=e;else if(n===I){var s=new n(w);o?k(s,a):T(s,e,i),this._willSettleAt(s,t)}else this._willSettleAt(new n((function(t){return t(e)})),t)}else this._willSettleAt(r(e),t)},e.prototype._settledAt=function(e,t,n){var r=this.promise;r._state===void 0&&(this._remaining--,e===2?k(r,n):this._result[t]=n),this._remaining===0&&O(r,this._result)},e.prototype._willSettleAt=function(e,t){var n=this;A(e,void 0,(function(e){return n._settledAt(1,t,e)}),(function(e){return n._settledAt(2,t,e)}))},e}(),I=function(){function t(e){this[C]=N++,this._result=this._state=void 0,this._subscribers=[],w!==e&&(typeof e!=`function`&&function(){throw TypeError(`You must pass a resolver function as the first argument to the promise constructor`)}(),this instanceof t?function(e,t){try{t((function(t){E(e,t)}),(function(t){k(e,t)}))}catch(t){k(e,t)}}(this,e):function(){throw TypeError(`Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.`)}())}return t.prototype.catch=function(e){return this.then(null,e)},t.prototype.finally=function(t){var n=this.constructor;return e(t)?this.then((function(e){return n.resolve(t()).then((function(){return e}))}),(function(e){return n.resolve(t()).then((function(){throw e}))})):this.then(t,t)},t}();return I.prototype.then=x,I.all=function(e){return new F(this,e).promise},I.race=function(e){var t=this;return r(e)?new t((function(n,r){for(var i=e.length,a=0;a<i;a++)t.resolve(e[a]).then(n,r)})):new t((function(e,t){return t(TypeError(`You must pass an array to race.`))}))},I.resolve=S,I.reject=function(e){var t=new this(w);return k(t,e),t},I._setScheduler=function(e){o=e},I._setAsap=function(e){s=e},I._asap=s,I.polyfill=function(){var e=void 0;if(n!==void 0)e=n;else if(typeof self<`u`)e=self;else try{e=Function(`return this`)()}catch{throw Error(`polyfill failed because global object is unavailable in this environment`)}var t=e.Promise;if(t){var r=null;try{r=Object.prototype.toString.call(t.resolve())}catch{}if(r===`[object Promise]`&&!t.cast)return}e.Promise=I},I.Promise=I,I}()}).call(this,n(22),n(23))},function(e,t){var n,r,i=e.exports={};function a(){throw Error(`setTimeout has not been defined`)}function o(){throw Error(`clearTimeout has not been defined`)}function s(e){if(n===setTimeout)return setTimeout(e,0);if((n===a||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch{try{return n.call(null,e,0)}catch{return n.call(this,e,0)}}}(function(){try{n=typeof setTimeout==`function`?setTimeout:a}catch{n=a}try{r=typeof clearTimeout==`function`?clearTimeout:o}catch{r=o}})();var c,l=[],u=!1,d=-1;function f(){u&&c&&(u=!1,c.length?l=c.concat(l):d=-1,l.length&&p())}function p(){if(!u){var e=s(f);u=!0;for(var t=l.length;t;){for(c=l,l=[];++d<t;)c&&c[d].run();d=-1,t=l.length}c=null,u=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===o||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch{try{return r.call(null,e)}catch{return r.call(this,e)}}}(e)}}function m(e,t){this.fun=e,this.array=t}function h(){}i.nextTick=function(e){var t=Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.push(new m(e,t)),l.length!==1||u||s(p)},m.prototype.run=function(){this.fun.apply(null,this.array)},i.title=`browser`,i.browser=!0,i.env={},i.argv=[],i.version=``,i.versions={},i.on=h,i.addListener=h,i.once=h,i.off=h,i.removeListener=h,i.removeAllListeners=h,i.emit=h,i.prependListener=h,i.prependOnceListener=h,i.listeners=function(e){return[]},i.binding=function(e){throw Error(`process.binding is not supported`)},i.cwd=function(){return`/`},i.chdir=function(e){throw Error(`process.chdir is not supported`)},i.umask=function(){return 0}},function(e,t){var n=function(){return this}();try{n||=Function(`return this`)()}catch{typeof window==`object`&&(n=window)}e.exports=n},function(e,t,n){n.r(t);var r=n(0),i=n(8),a=n(3),o=n(7),s=n(16),c=n(17),l=n(1),u=n(4),d=n(10);t.default=function(e){var t=`PlayerEngineWorker`,n=function(t,n){e.postMessage({msg:`logcat_callback`,type:t,logcat:n})}.bind(void 0),f=null,p=null,m=null,h=null,g=!1,_=!1,v=0,y=0,b=!1;function x(){m&&=(m.shutdown(),m.destroy(),null)}function S(){if(f==null||p==null)throw new a.a(`Worker not initialized`);if(h)throw new a.a(`Transmuxer has been initialized`);_||(!p.deferLoadAfterSourceOpen||g?((h=new c.a(f,p)).on(l.a.INIT_SEGMENT,(function(e,t){m.appendInitSegment(t)})),h.on(l.a.MEDIA_SEGMENT,(function(t,n){m.appendMediaSegment(n),e.postMessage({msg:`buffered_position_changed`,buffered_position_milliseconds:n.info.endDts})})),h.on(l.a.LOADING_COMPLETE,(function(){m.endOfStream(),e.postMessage({msg:`player_event`,event:u.a.LOADING_COMPLETE})})),h.on(l.a.RECOVERED_EARLY_EOF,(function(){e.postMessage({msg:`player_event`,event:u.a.RECOVERED_EARLY_EOF})})),h.on(l.a.IO_ERROR,(function(t,n){e.postMessage({msg:`player_event`,event:u.a.ERROR,error_type:d.b.NETWORK_ERROR,error_detail:t,info:n})})),h.on(l.a.DEMUX_ERROR,(function(t,n){e.postMessage({msg:`player_event`,event:u.a.ERROR,error_type:d.b.MEDIA_ERROR,error_detail:t,info:n})})),h.on(l.a.MEDIA_INFO,(function(e){O(l.a.MEDIA_INFO,e)})),h.on(l.a.STATISTICS_INFO,(function(e){O(l.a.STATISTICS_INFO,e)})),h.on(l.a.RECOMMEND_SEEKPOINT,(function(t){(function(t){e.postMessage({msg:`transmuxing_event`,event:l.a.RECOMMEND_SEEKPOINT,milliseconds:t})})(t)})),h.on(l.a.METADATA_ARRIVED,(function(e){k(u.a.METADATA_ARRIVED,e)})),h.on(l.a.SCRIPTDATA_ARRIVED,(function(e){k(u.a.SCRIPTDATA_ARRIVED,e)})),h.on(l.a.TIMED_ID3_METADATA_ARRIVED,(function(e){k(u.a.TIMED_ID3_METADATA_ARRIVED,e)})),h.on(l.a.SYNCHRONOUS_KLV_METADATA_ARRIVED,(function(e){k(u.a.SYNCHRONOUS_KLV_METADATA_ARRIVED,e)})),h.on(l.a.ASYNCHRONOUS_KLV_METADATA_ARRIVED,(function(e){k(u.a.ASYNCHRONOUS_KLV_METADATA_ARRIVED,e)})),h.on(l.a.SMPTE2038_METADATA_ARRIVED,(function(e){k(u.a.SMPTE2038_METADATA_ARRIVED,e)})),h.on(l.a.SCTE35_METADATA_ARRIVED,(function(e){k(u.a.SCTE35_METADATA_ARRIVED,e)})),h.on(l.a.PES_PRIVATE_DATA_DESCRIPTOR,(function(e){k(u.a.PES_PRIVATE_DATA_DESCRIPTOR,e)})),h.on(l.a.PES_PRIVATE_DATA_ARRIVED,(function(e){k(u.a.PES_PRIVATE_DATA_ARRIVED,e)})),h.open()):_=!0)}function C(){m&&m.flush(),h&&=(h.close(),h.destroy(),null)}function w(){g=!0,_&&(_=!1,S())}function T(){e.postMessage({msg:`mse_event`,event:o.a.UPDATE_END})}function E(){r.a.v(t,`MSE SourceBuffer is full, report to main thread`),e.postMessage({msg:`mse_event`,event:o.a.BUFFER_FULL})}function D(t){e.postMessage({msg:`player_event`,event:u.a.ERROR,error_type:d.b.MEDIA_ERROR,error_detail:d.b.MEDIA_MSE_ERROR,info:t})}function O(t,n){e.postMessage({msg:`transmuxing_event`,event:t,info:n})}function k(t,n){e.postMessage({msg:`player_event`,event:t,extraData:n})}e.addEventListener(`message`,(function(a){if(!b){var c=a.data;switch(c.cmd){case`logging_config`:var l=c;i.a.applyConfig(l.logging_config),!0===l.logging_config.enableCallback?i.a.addLogListener(n):i.a.removeLogListener(n);break;case`init`:f=(l=c).media_data_source,p=l.config;break;case`destroy`:(function(){h&&C(),m&&x(),b=!0,e.postMessage({msg:`destroyed`})})();break;case`initialize_mse`:(function(){r.a.v(t,`Initializing MediaSource in DedicatedWorker`),(m=new s.a(p)).on(o.a.SOURCE_OPEN,w.bind(this)),m.on(o.a.UPDATE_END,T.bind(this)),m.on(o.a.BUFFER_FULL,E.bind(this)),m.on(o.a.ERROR,D.bind(this)),m.initialize({getCurrentTime:function(){return v},getReadyState:function(){return y}});var n=m.getHandle();e.postMessage({msg:`mse_init`,handle:n},[n])})();break;case`shutdown_mse`:x();break;case`load`:S();break;case`unload`:C();break;case`unbuffered_seek`:l=c,m.flush(),h.seek(l.milliseconds);break;case`timeupdate`:v=(l=c).current_time;break;case`readystatechange`:y=(l=c).ready_state;break;case`pause_transmuxer`:h.pause();break;case`resume_transmuxer`:h.resume()}}}))}},function(e,t,n){n.r(t);var r=n(15),i=n(14),a={enableWorker:!1,enableWorkerForMSE:!1,enableStashBuffer:!0,stashInitialSize:void 0,isLive:!1,liveBufferLatencyChasing:!1,liveBufferLatencyChasingOnPaused:!1,liveBufferLatencyMaxLatency:1.5,liveBufferLatencyMinRemain:.5,liveSync:!1,liveSyncMaxLatency:1.2,liveSyncTargetLatency:.8,liveSyncPlaybackRate:1.2,lazyLoad:!0,lazyLoadMaxDuration:180,lazyLoadRecoverDuration:30,deferLoadAfterSourceOpen:!0,autoCleanupMaxBackwardDuration:180,autoCleanupMinBackwardDuration:120,statisticsInfoReportInterval:600,fixAudioTimestampGap:!0,accurateSeek:!1,seekType:`range`,seekParamStart:`bstart`,seekParamEnd:`bend`,rangeLoadZeroStart:!1,customSeekHandler:void 0,reuseRedirectedURL:!1,headers:void 0,customLoader:void 0};function o(){return Object.assign({},a)}var s=function(){function e(){}return e.supportMSEH264Playback=function(){var e=self.MediaSource&&self.MediaSource.isTypeSupported(`video/mp4; codecs="avc1.42E01E,mp4a.40.2"`),t=self.ManagedMediaSource&&self.ManagedMediaSource.isTypeSupported(`video/mp4; codecs="avc1.42E01E,mp4a.40.2"`);return e||t},e.supportMSEH265Playback=function(){var e=self.MediaSource&&self.MediaSource.isTypeSupported(`video/mp4; codecs="hvc1.1.6.L93.B0"`),t=self.ManagedMediaSource&&self.ManagedMediaSource.isTypeSupported(`video/mp4; codecs="hvc1.1.6.L93.B0"`);return e||t},e.supportNetworkStreamIO=function(){var e=new i.a({},o()),t=e.loaderType;return e.destroy(),t==`fetch-stream-loader`||t==`xhr-moz-chunked-loader`},e.getNetworkLoaderTypeName=function(){var e=new i.a({},o()),t=e.loaderType;return e.destroy(),t},e.supportNativeMediaPlayback=function(t){e.videoElement??=window.document.createElement(`video`);var n=e.videoElement.canPlayType(t);return n===`probably`||n==`maybe`},e.getFeatureList=function(){var t={msePlayback:!1,mseLivePlayback:!1,mseH265Playback:!1,networkStreamIO:!1,networkLoaderName:``,nativeMP4H264Playback:!1,nativeMP4H265Playback:!1,nativeWebmVP8Playback:!1,nativeWebmVP9Playback:!1};return t.msePlayback=e.supportMSEH264Playback(),t.networkStreamIO=e.supportNetworkStreamIO(),t.networkLoaderName=e.getNetworkLoaderTypeName(),t.mseLivePlayback=t.msePlayback&&t.networkStreamIO,t.mseH265Playback=e.supportMSEH265Playback(),t.nativeMP4H264Playback=e.supportNativeMediaPlayback(`video/mp4; codecs="avc1.42001E, mp4a.40.2"`),t.nativeMP4H265Playback=e.supportNativeMediaPlayback(`video/mp4; codecs="hvc1.1.6.L93.B0"`),t.nativeWebmVP8Playback=e.supportNativeMediaPlayback(`video/webm; codecs="vp8.0, vorbis"`),t.nativeWebmVP9Playback=e.supportNativeMediaPlayback(`video/webm; codecs="vp9"`),t},e}(),c=n(2),l=n(0),u=n(9),d=n.n(u),f=n(16),p=n(4),m=n(17),h=n(7),g=n(10),_=n(3),v=n(1),y=n(5),b=n(11),x=function(){function e(e,t,n){this.TAG=`SeekingHandler`,this._config=null,this._media_element=null,this._always_seek_keyframe=!1,this._on_unbuffered_seek=null,this._request_set_current_time=!1,this._seek_request_record_clocktime=null,this._idr_sample_list=new b.a,this.e=null,this._config=e,this._media_element=t,this._on_unbuffered_seek=n,this.e={onMediaSeeking:this._onMediaSeeking.bind(this)},this._always_seek_keyframe=!!(y.a.chrome&&(y.a.version.major<50||y.a.version.major===50&&y.a.version.build<2661)||y.a.msedge||y.a.msie),this._always_seek_keyframe&&(this._config.accurateSeek=!1),this._media_element.addEventListener(`seeking`,this.e.onMediaSeeking)}return e.prototype.destroy=function(){this._idr_sample_list.clear(),this._idr_sample_list=null,this._media_element.removeEventListener(`seeking`,this.e.onMediaSeeking),this._media_element=null,this._on_unbuffered_seek=null},e.prototype.seek=function(e){var t=this._isPositionBuffered(e),n=!1;if(e<1&&this._media_element.buffered.length>0){var r=this._media_element.buffered.start(0);(r<1&&e<r||y.a.safari)&&(n=!0,e=y.a.safari?.1:r)}if(n)this.directSeek(e);else if(t)if(this._always_seek_keyframe){var i=this._getNearestKeyframe(Math.floor(1e3*e));i!=null&&(e=i.dts/1e3),this.directSeek(e)}else this.directSeek(e);else this._idr_sample_list.clear(),this._on_unbuffered_seek(Math.floor(1e3*e)),this._config.accurateSeek&&this.directSeek(e)},e.prototype.directSeek=function(e){this._request_set_current_time=!0,this._media_element.currentTime=e},e.prototype.appendSyncPoints=function(e){this._idr_sample_list.appendArray(e)},e.prototype._onMediaSeeking=function(t){if(this._request_set_current_time)this._request_set_current_time=!1;else{var n=this._media_element.currentTime,r=this._media_element.buffered;if(n<1&&r.length>0){var i=r.start(0);if(i<1&&n<i||y.a.safari){var a=y.a.safari?.1:i;this.directSeek(a);return}}if(this._isPositionBuffered(n)){if(this._always_seek_keyframe){var o=this._getNearestKeyframe(Math.floor(1e3*n));o!=null&&(n=o.dts/1e3,this.directSeek(n))}}else this._seek_request_record_clocktime=e._getClockTime(),window.setTimeout(this._pollAndApplyUnbufferedSeek.bind(this),50)}},e.prototype._pollAndApplyUnbufferedSeek=function(){if(this._seek_request_record_clocktime!=null)if(this._seek_request_record_clocktime<=e._getClockTime()-100){var t=this._media_element.currentTime;this._seek_request_record_clocktime=null,this._isPositionBuffered(t)||(this._idr_sample_list.clear(),this._on_unbuffered_seek(Math.floor(1e3*t)),this._config.accurateSeek&&this.directSeek(t))}else window.setTimeout(this._pollAndApplyUnbufferedSeek.bind(this),50)},e.prototype._isPositionBuffered=function(e){for(var t=this._media_element.buffered,n=0;n<t.length;n++){var r=t.start(n),i=t.end(n);if(e>=r&&e<i)return!0}return!1},e.prototype._getNearestKeyframe=function(e){return this._idr_sample_list.getLastSyncPointBeforeDts(e)},e._getClockTime=function(){return self.performance&&self.performance.now?self.performance.now():Date.now()},e}(),S=function(){function e(e,t,n,r){this.TAG=`LoadingController`,this._config=null,this._media_element=null,this._on_pause_transmuxer=null,this._on_resume_transmuxer=null,this._paused=!1,this.e=null,this._config=e,this._media_element=t,this._on_pause_transmuxer=n,this._on_resume_transmuxer=r,this.e={onMediaTimeUpdate:this._onMediaTimeUpdate.bind(this)}}return e.prototype.destroy=function(){this._media_element.removeEventListener(`timeupdate`,this.e.onMediaTimeUpdate),this.e=null,this._media_element=null,this._config=null,this._on_pause_transmuxer=null,this._on_resume_transmuxer=null},e.prototype.notifyBufferedPositionChanged=function(e){!this._config.isLive&&this._config.lazyLoad&&(e==null?this._suspendTransmuxerIfNeeded():this._suspendTransmuxerIfBufferedPositionExceeded(e))},e.prototype._onMediaTimeUpdate=function(e){this._paused&&this._resumeTransmuxerIfNeeded()},e.prototype._suspendTransmuxerIfNeeded=function(){for(var e=this._media_element.buffered,t=this._media_element.currentTime,n=0,r=0;r<e.length;r++){var i=e.start(r),a=e.end(r);if(i<=t&&t<a){n=a;break}}n>0&&this._suspendTransmuxerIfBufferedPositionExceeded(n)},e.prototype._suspendTransmuxerIfBufferedPositionExceeded=function(e){e>=this._media_element.currentTime+this._config.lazyLoadMaxDuration&&!this._paused&&(l.a.v(this.TAG,`Maximum buffering duration exceeded, suspend transmuxing task`),this.suspendTransmuxer(),this._media_element.addEventListener(`timeupdate`,this.e.onMediaTimeUpdate))},e.prototype.suspendTransmuxer=function(){this._paused=!0,this._on_pause_transmuxer()},e.prototype._resumeTransmuxerIfNeeded=function(){for(var e=this._media_element.buffered,t=this._media_element.currentTime,n=this._config.lazyLoadRecoverDuration,r=!1,i=0;i<e.length;i++){var a=e.start(i),o=e.end(i);if(t>=a&&t<o){t>=o-n&&(r=!0);break}}r&&(l.a.v(this.TAG,`Continue loading from paused position`),this.resumeTransmuxer(),this._media_element.removeEventListener(`timeupdate`,this.e.onMediaTimeUpdate))},e.prototype.resumeTransmuxer=function(){this._paused=!1,this._on_resume_transmuxer()},e}(),C=function(){function e(e,t){this.TAG=`StartupStallJumper`,this._media_element=null,this._on_direct_seek=null,this._canplay_received=!1,this.e=null,this._media_element=e,this._on_direct_seek=t,this.e={onMediaCanPlay:this._onMediaCanPlay.bind(this),onMediaStalled:this._onMediaStalled.bind(this),onMediaProgress:this._onMediaProgress.bind(this)},this._media_element.addEventListener(`canplay`,this.e.onMediaCanPlay),this._media_element.addEventListener(`stalled`,this.e.onMediaStalled),this._media_element.addEventListener(`progress`,this.e.onMediaProgress)}return e.prototype.destroy=function(){this._media_element.removeEventListener(`canplay`,this.e.onMediaCanPlay),this._media_element.removeEventListener(`stalled`,this.e.onMediaStalled),this._media_element.removeEventListener(`progress`,this.e.onMediaProgress),this._media_element=null,this._on_direct_seek=null},e.prototype._onMediaCanPlay=function(e){this._canplay_received=!0,this._media_element.removeEventListener(`canplay`,this.e.onMediaCanPlay)},e.prototype._onMediaStalled=function(e){this._detectAndFixStuckPlayback(!0)},e.prototype._onMediaProgress=function(e){this._detectAndFixStuckPlayback()},e.prototype._detectAndFixStuckPlayback=function(e){var t=this._media_element,n=t.buffered;e||!this._canplay_received||t.readyState<2?n.length>0&&t.currentTime<n.start(0)&&(l.a.w(this.TAG,`Playback seems stuck at ${t.currentTime}, seek to ${n.start(0)}`),this._on_direct_seek(n.start(0)),this._media_element.removeEventListener(`progress`,this.e.onMediaProgress)):this._media_element.removeEventListener(`progress`,this.e.onMediaProgress)},e}(),w=function(){function e(e,t,n){this._config=null,this._media_element=null,this._on_direct_seek=null,this._config=e,this._media_element=t,this._on_direct_seek=n}return e.prototype.destroy=function(){this._on_direct_seek=null,this._media_element=null,this._config=null},e.prototype.notifyBufferedRangeUpdate=function(){this._chaseLiveLatency()},e.prototype._chaseLiveLatency=function(){var e=this._media_element.buffered,t=this._media_element.currentTime,n=this._media_element.paused;if(this._config.isLive&&this._config.liveBufferLatencyChasing&&e.length!=0&&(this._config.liveBufferLatencyChasingOnPaused||!n)){var r=e.end(e.length-1);if(r>this._config.liveBufferLatencyMaxLatency&&r-t>this._config.liveBufferLatencyMaxLatency){var i=r-this._config.liveBufferLatencyMinRemain;this._on_direct_seek(i)}}},e}(),T=function(){function e(e,t){this._config=null,this._media_element=null,this.e=null,this._config=e,this._media_element=t,this.e={onMediaTimeUpdate:this._onMediaTimeUpdate.bind(this)},this._media_element.addEventListener(`timeupdate`,this.e.onMediaTimeUpdate)}return e.prototype.destroy=function(){this._media_element.removeEventListener(`timeupdate`,this.e.onMediaTimeUpdate),this._media_element=null,this._config=null},e.prototype._onMediaTimeUpdate=function(e){if(this._config.isLive&&this._config.liveSync){var t=this._getCurrentLatency();if(t>this._config.liveSyncMaxLatency){var n=Math.min(2,Math.max(1,this._config.liveSyncPlaybackRate));this._media_element.playbackRate=n}else t>this._config.liveSyncTargetLatency||this._media_element.playbackRate!==1&&this._media_element.playbackRate!==0&&(this._media_element.playbackRate=1)}},e.prototype._getCurrentLatency=function(){if(!this._media_element)return 0;var e=this._media_element.buffered,t=this._media_element.currentTime;return e.length==0?0:e.end(e.length-1)-t},e}(),E=function(){function e(e,t){this.TAG=`PlayerEngineMainThread`,this._emitter=new u,this._media_element=null,this._mse_controller=null,this._transmuxer=null,this._pending_seek_time=null,this._seeking_handler=null,this._loading_controller=null,this._startup_stall_jumper=null,this._live_latency_chaser=null,this._live_latency_synchronizer=null,this._mse_source_opened=!1,this._has_pending_load=!1,this._loaded_metadata_received=!1,this._media_info=null,this._statistics_info=null,this.e=null,this._media_data_source=e,this._config=o(),typeof t==`object`&&Object.assign(this._config,t),!0===e.isLive&&(this._config.isLive=!0),this.e={onMediaLoadedMetadata:this._onMediaLoadedMetadata.bind(this)}}return e.prototype.destroy=function(){this._emitter.emit(p.a.DESTROYING),this._transmuxer&&this.unload(),this._media_element&&this.detachMediaElement(),this.e=null,this._media_data_source=null,this._emitter.removeAllListeners(),this._emitter=null},e.prototype.on=function(e,t){var n=this;this._emitter.addListener(e,t),e===p.a.MEDIA_INFO&&this._media_info?Promise.resolve().then((function(){return n._emitter.emit(p.a.MEDIA_INFO,n.mediaInfo)})):e==p.a.STATISTICS_INFO&&this._statistics_info&&Promise.resolve().then((function(){return n._emitter.emit(p.a.STATISTICS_INFO,n.statisticsInfo)}))},e.prototype.off=function(e,t){this._emitter.removeListener(e,t)},e.prototype.attachMediaElement=function(e){var t=this;this._media_element=e,e.src=``,e.removeAttribute(`src`),e.srcObject=null,e.load(),e.addEventListener(`loadedmetadata`,this.e.onMediaLoadedMetadata),this._mse_controller=new f.a(this._config),this._mse_controller.on(h.a.UPDATE_END,this._onMSEUpdateEnd.bind(this)),this._mse_controller.on(h.a.BUFFER_FULL,this._onMSEBufferFull.bind(this)),this._mse_controller.on(h.a.SOURCE_OPEN,this._onMSESourceOpen.bind(this)),this._mse_controller.on(h.a.ERROR,this._onMSEError.bind(this)),this._mse_controller.on(h.a.START_STREAMING,this._onMSEStartStreaming.bind(this)),this._mse_controller.on(h.a.END_STREAMING,this._onMSEEndStreaming.bind(this)),this._mse_controller.initialize({getCurrentTime:function(){return t._media_element.currentTime},getReadyState:function(){return t._media_element.readyState}}),this._mse_controller.isManagedMediaSource()?(e.disableRemotePlayback=!0,e.srcObject=this._mse_controller.getObject()):e.src=this._mse_controller.getObjectURL()},e.prototype.detachMediaElement=function(){this._media_element&&(this._mse_controller.shutdown(),this._media_element.removeEventListener(`loadedmetadata`,this.e.onMediaLoadedMetadata),this._media_element.src=``,this._media_element.removeAttribute(`src`),this._media_element.srcObject=null,this._media_element.load(),this._media_element=null,this._mse_controller.revokeObjectURL()),this._mse_controller&&=(this._mse_controller.destroy(),null)},e.prototype.load=function(){var e=this;if(!this._media_element)throw new _.a(`HTMLMediaElement must be attached before load()!`);if(this._transmuxer)throw new _.a(`load() has been called, please call unload() first!`);this._has_pending_load||(!this._config.deferLoadAfterSourceOpen||this._mse_source_opened?(this._transmuxer=new m.a(this._media_data_source,this._config),this._transmuxer.on(v.a.INIT_SEGMENT,(function(t,n){e._mse_controller.appendInitSegment(n)})),this._transmuxer.on(v.a.MEDIA_SEGMENT,(function(t,n){e._mse_controller.appendMediaSegment(n),!e._config.isLive&&t===`video`&&n.data&&n.data.byteLength>0&&`info`in n&&e._seeking_handler.appendSyncPoints(n.info.syncPoints),e._loading_controller.notifyBufferedPositionChanged(n.info.endDts/1e3)})),this._transmuxer.on(v.a.LOADING_COMPLETE,(function(){e._mse_controller.endOfStream(),e._emitter.emit(p.a.LOADING_COMPLETE)})),this._transmuxer.on(v.a.RECOVERED_EARLY_EOF,(function(){e._emitter.emit(p.a.RECOVERED_EARLY_EOF)})),this._transmuxer.on(v.a.IO_ERROR,(function(t,n){e._emitter.emit(p.a.ERROR,g.b.NETWORK_ERROR,t,n)})),this._transmuxer.on(v.a.DEMUX_ERROR,(function(t,n){e._emitter.emit(p.a.ERROR,g.b.MEDIA_ERROR,t,n)})),this._transmuxer.on(v.a.MEDIA_INFO,(function(t){e._media_info=t,e._emitter.emit(p.a.MEDIA_INFO,Object.assign({},t))})),this._transmuxer.on(v.a.STATISTICS_INFO,(function(t){e._statistics_info=e._fillStatisticsInfo(t),e._emitter.emit(p.a.STATISTICS_INFO,Object.assign({},t))})),this._transmuxer.on(v.a.RECOMMEND_SEEKPOINT,(function(t){e._media_element&&!e._config.accurateSeek&&e._seeking_handler.directSeek(t/1e3)})),this._transmuxer.on(v.a.METADATA_ARRIVED,(function(t){e._emitter.emit(p.a.METADATA_ARRIVED,t)})),this._transmuxer.on(v.a.SCRIPTDATA_ARRIVED,(function(t){e._emitter.emit(p.a.SCRIPTDATA_ARRIVED,t)})),this._transmuxer.on(v.a.TIMED_ID3_METADATA_ARRIVED,(function(t){e._emitter.emit(p.a.TIMED_ID3_METADATA_ARRIVED,t)})),this._transmuxer.on(v.a.SYNCHRONOUS_KLV_METADATA_ARRIVED,(function(t){e._emitter.emit(p.a.SYNCHRONOUS_KLV_METADATA_ARRIVED,t)})),this._transmuxer.on(v.a.ASYNCHRONOUS_KLV_METADATA_ARRIVED,(function(t){e._emitter.emit(p.a.ASYNCHRONOUS_KLV_METADATA_ARRIVED,t)})),this._transmuxer.on(v.a.SMPTE2038_METADATA_ARRIVED,(function(t){e._emitter.emit(p.a.SMPTE2038_METADATA_ARRIVED,t)})),this._transmuxer.on(v.a.SCTE35_METADATA_ARRIVED,(function(t){e._emitter.emit(p.a.SCTE35_METADATA_ARRIVED,t)})),this._transmuxer.on(v.a.PES_PRIVATE_DATA_DESCRIPTOR,(function(t){e._emitter.emit(p.a.PES_PRIVATE_DATA_DESCRIPTOR,t)})),this._transmuxer.on(v.a.PES_PRIVATE_DATA_ARRIVED,(function(t){e._emitter.emit(p.a.PES_PRIVATE_DATA_ARRIVED,t)})),this._seeking_handler=new x(this._config,this._media_element,this._onRequiredUnbufferedSeek.bind(this)),this._loading_controller=new S(this._config,this._media_element,this._onRequestPauseTransmuxer.bind(this),this._onRequestResumeTransmuxer.bind(this)),this._startup_stall_jumper=new C(this._media_element,this._onRequestDirectSeek.bind(this)),this._config.isLive&&this._config.liveBufferLatencyChasing&&(this._live_latency_chaser=new w(this._config,this._media_element,this._onRequestDirectSeek.bind(this))),this._config.isLive&&this._config.liveSync&&(this._live_latency_synchronizer=new T(this._config,this._media_element)),this._media_element.readyState>0&&this._seeking_handler.directSeek(0),this._transmuxer.open()):this._has_pending_load=!0)},e.prototype.unload=function(){var e,t,n,r,i,a,o,s,c;(e=this._media_element)==null||e.pause(),(t=this._live_latency_synchronizer)==null||t.destroy(),this._live_latency_synchronizer=null,(n=this._live_latency_chaser)==null||n.destroy(),this._live_latency_chaser=null,(r=this._startup_stall_jumper)==null||r.destroy(),this._startup_stall_jumper=null,(i=this._loading_controller)==null||i.destroy(),this._loading_controller=null,(a=this._seeking_handler)==null||a.destroy(),this._seeking_handler=null,(o=this._mse_controller)==null||o.flush(),(s=this._transmuxer)==null||s.close(),(c=this._transmuxer)==null||c.destroy(),this._transmuxer=null},e.prototype.play=function(){return this._media_element.play()},e.prototype.pause=function(){this._media_element.pause()},e.prototype.seek=function(e){this._media_element&&this._seeking_handler?this._seeking_handler.seek(e):this._pending_seek_time=e},Object.defineProperty(e.prototype,`mediaInfo`,{get:function(){return Object.assign({},this._media_info)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`statisticsInfo`,{get:function(){return Object.assign({},this._statistics_info)},enumerable:!1,configurable:!0}),e.prototype._onMSESourceOpen=function(){this._mse_source_opened=!0,this._has_pending_load&&(this._has_pending_load=!1,this.load())},e.prototype._onMSEUpdateEnd=function(){this._config.isLive&&this._config.liveBufferLatencyChasing&&this._live_latency_chaser&&this._live_latency_chaser.notifyBufferedRangeUpdate(),this._loading_controller.notifyBufferedPositionChanged()},e.prototype._onMSEBufferFull=function(){l.a.v(this.TAG,`MSE SourceBuffer is full, suspend transmuxing task`),this._loading_controller.suspendTransmuxer()},e.prototype._onMSEError=function(e){this._emitter.emit(p.a.ERROR,g.b.MEDIA_ERROR,g.a.MEDIA_MSE_ERROR,e)},e.prototype._onMSEStartStreaming=function(){this._loaded_metadata_received&&(this._config.isLive||(l.a.v(this.TAG,`Resume transmuxing task due to ManagedMediaSource onStartStreaming`),this._loading_controller.resumeTransmuxer()))},e.prototype._onMSEEndStreaming=function(){this._config.isLive||(l.a.v(this.TAG,`Suspend transmuxing task due to ManagedMediaSource onEndStreaming`),this._loading_controller.suspendTransmuxer())},e.prototype._onMediaLoadedMetadata=function(e){this._loaded_metadata_received=!0,this._pending_seek_time!=null&&(this._seeking_handler.seek(this._pending_seek_time),this._pending_seek_time=null)},e.prototype._onRequestDirectSeek=function(e){this._seeking_handler.directSeek(e)},e.prototype._onRequiredUnbufferedSeek=function(e){this._mse_controller.flush(),this._transmuxer.seek(e)},e.prototype._onRequestPauseTransmuxer=function(){this._transmuxer.pause()},e.prototype._onRequestResumeTransmuxer=function(){this._transmuxer.resume()},e.prototype._fillStatisticsInfo=function(e){if(e.playerType=`MSEPlayer`,!(this._media_element instanceof HTMLVideoElement))return e;var t=!0,n=0,r=0;if(this._media_element.getVideoPlaybackQuality){var i=this._media_element.getVideoPlaybackQuality();n=i.totalVideoFrames,r=i.droppedVideoFrames}else this._media_element.webkitDecodedFrameCount==null?t=!1:(n=this._media_element.webkitDecodedFrameCount,r=this._media_element.webkitDroppedFrameCount);return t&&(e.decodedFrames=n,e.droppedFrames=r),e},e}(),D=n(18),O=n(8),k=function(){function e(e,t){this.TAG=`PlayerEngineDedicatedThread`,this._emitter=new u,this._media_element=null,this._worker_destroying=!1,this._seeking_handler=null,this._loading_controller=null,this._startup_stall_jumper=null,this._live_latency_chaser=null,this._live_latency_synchronizer=null,this._pending_seek_time=null,this._media_info=null,this._statistics_info=null,this.e=null,this._media_data_source=e,this._config=o(),typeof t==`object`&&Object.assign(this._config,t),!0===e.isLive&&(this._config.isLive=!0),this.e={onLoggingConfigChanged:this._onLoggingConfigChanged.bind(this),onMediaLoadedMetadata:this._onMediaLoadedMetadata.bind(this),onMediaTimeUpdate:this._onMediaTimeUpdate.bind(this),onMediaReadyStateChanged:this._onMediaReadyStateChange.bind(this)},O.a.registerListener(this.e.onLoggingConfigChanged),this._worker=D(24,{all:!0}),this._worker.addEventListener(`message`,this._onWorkerMessage.bind(this)),this._worker.postMessage({cmd:`init`,media_data_source:this._media_data_source,config:this._config}),this._worker.postMessage({cmd:`logging_config`,logging_config:O.a.getConfig()})}return e.isSupported=function(){return!!self.Worker&&(!(!self.MediaSource||!(`canConstructInDedicatedWorker`in self.MediaSource)||!0!==self.MediaSource.canConstructInDedicatedWorker)||!(!self.ManagedMediaSource||!(`canConstructInDedicatedWorker`in self.ManagedMediaSource)||!0!==self.ManagedMediaSource.canConstructInDedicatedWorker))},e.prototype.destroy=function(){this._emitter.emit(p.a.DESTROYING),this.unload(),this.detachMediaElement(),this._worker_destroying=!0,this._worker.postMessage({cmd:`destroy`}),O.a.removeListener(this.e.onLoggingConfigChanged),this.e=null,this._media_data_source=null,this._emitter.removeAllListeners(),this._emitter=null},e.prototype.on=function(e,t){var n=this;this._emitter.addListener(e,t),e===p.a.MEDIA_INFO&&this._media_info?Promise.resolve().then((function(){return n._emitter.emit(p.a.MEDIA_INFO,n.mediaInfo)})):e==p.a.STATISTICS_INFO&&this._statistics_info&&Promise.resolve().then((function(){return n._emitter.emit(p.a.STATISTICS_INFO,n.statisticsInfo)}))},e.prototype.off=function(e,t){this._emitter.removeListener(e,t)},e.prototype.attachMediaElement=function(e){this._media_element=e,this._media_element.src=``,this._media_element.removeAttribute(`src`),this._media_element.srcObject=null,this._media_element.load(),this._media_element.addEventListener(`loadedmetadata`,this.e.onMediaLoadedMetadata),this._media_element.addEventListener(`timeupdate`,this.e.onMediaTimeUpdate),this._media_element.addEventListener(`readystatechange`,this.e.onMediaReadyStateChanged),this._worker.postMessage({cmd:`initialize_mse`})},e.prototype.detachMediaElement=function(){this._worker.postMessage({cmd:`shutdown_mse`}),this._media_element&&=(this._media_element.removeEventListener(`loadedmetadata`,this.e.onMediaLoadedMetadata),this._media_element.removeEventListener(`timeupdate`,this.e.onMediaTimeUpdate),this._media_element.removeEventListener(`readystatechange`,this.e.onMediaReadyStateChanged),this._media_element.src=``,this._media_element.removeAttribute(`src`),this._media_element.srcObject=null,this._media_element.load(),null)},e.prototype.load=function(){this._worker.postMessage({cmd:`load`}),this._seeking_handler=new x(this._config,this._media_element,this._onRequiredUnbufferedSeek.bind(this)),this._loading_controller=new S(this._config,this._media_element,this._onRequestPauseTransmuxer.bind(this),this._onRequestResumeTransmuxer.bind(this)),this._startup_stall_jumper=new C(this._media_element,this._onRequestDirectSeek.bind(this)),this._config.isLive&&this._config.liveBufferLatencyChasing&&(this._live_latency_chaser=new w(this._config,this._media_element,this._onRequestDirectSeek.bind(this))),this._config.isLive&&this._config.liveSync&&(this._live_latency_synchronizer=new T(this._config,this._media_element)),this._media_element.readyState>0&&this._seeking_handler.directSeek(0)},e.prototype.unload=function(){var e,t,n,r,i,a;(e=this._media_element)==null||e.pause(),this._worker.postMessage({cmd:`unload`}),(t=this._live_latency_synchronizer)==null||t.destroy(),this._live_latency_synchronizer=null,(n=this._live_latency_chaser)==null||n.destroy(),this._live_latency_chaser=null,(r=this._startup_stall_jumper)==null||r.destroy(),this._startup_stall_jumper=null,(i=this._loading_controller)==null||i.destroy(),this._loading_controller=null,(a=this._seeking_handler)==null||a.destroy(),this._seeking_handler=null},e.prototype.play=function(){return this._media_element.play()},e.prototype.pause=function(){this._media_element.pause()},e.prototype.seek=function(e){this._media_element&&this._seeking_handler?this._seeking_handler.seek(e):this._pending_seek_time=e},Object.defineProperty(e.prototype,`mediaInfo`,{get:function(){return Object.assign({},this._media_info)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`statisticsInfo`,{get:function(){return Object.assign({},this._statistics_info)},enumerable:!1,configurable:!0}),e.prototype._onLoggingConfigChanged=function(e){var t;(t=this._worker)==null||t.postMessage({cmd:`logging_config`,logging_config:e})},e.prototype._onMSEUpdateEnd=function(){this._config.isLive&&this._config.liveBufferLatencyChasing&&this._live_latency_chaser&&this._live_latency_chaser.notifyBufferedRangeUpdate(),this._loading_controller.notifyBufferedPositionChanged()},e.prototype._onMSEBufferFull=function(){l.a.v(this.TAG,`MSE SourceBuffer is full, suspend transmuxing task`),this._loading_controller.suspendTransmuxer()},e.prototype._onMediaLoadedMetadata=function(e){this._pending_seek_time!=null&&(this._seeking_handler.seek(this._pending_seek_time),this._pending_seek_time=null)},e.prototype._onRequestDirectSeek=function(e){this._seeking_handler.directSeek(e)},e.prototype._onRequiredUnbufferedSeek=function(e){this._worker.postMessage({cmd:`unbuffered_seek`,milliseconds:e})},e.prototype._onRequestPauseTransmuxer=function(){this._worker.postMessage({cmd:`pause_transmuxer`})},e.prototype._onRequestResumeTransmuxer=function(){this._worker.postMessage({cmd:`resume_transmuxer`})},e.prototype._onMediaTimeUpdate=function(e){this._worker.postMessage({cmd:`timeupdate`,current_time:e.target.currentTime})},e.prototype._onMediaReadyStateChange=function(e){this._worker.postMessage({cmd:`readystatechange`,ready_state:e.target.readyState})},e.prototype._onWorkerMessage=function(e){var t,n=e.data,r=n.msg;if(r==`destroyed`||this._worker_destroying)return this._worker_destroying=!1,(t=this._worker)==null||t.terminate(),void(this._worker=null);switch(r){case`mse_init`:var i=n;`ManagedMediaSource`in self&&!(`MediaSource`in self)&&(this._media_element.disableRemotePlayback=!0),this._media_element.srcObject=i.handle;break;case`mse_event`:(i=n).event==h.a.UPDATE_END?this._onMSEUpdateEnd():i.event==h.a.BUFFER_FULL&&this._onMSEBufferFull();break;case`transmuxing_event`:if((i=n).event==v.a.MEDIA_INFO){var a=n;this._media_info=a.info,this._emitter.emit(p.a.MEDIA_INFO,Object.assign({},a.info))}else if(i.event==v.a.STATISTICS_INFO){var o=n;this._statistics_info=this._fillStatisticsInfo(o.info),this._emitter.emit(p.a.STATISTICS_INFO,Object.assign({},o.info))}else if(i.event==v.a.RECOMMEND_SEEKPOINT){var s=n;this._media_element&&!this._config.accurateSeek&&this._seeking_handler.directSeek(s.milliseconds/1e3)}break;case`player_event`:if((i=n).event==p.a.ERROR){var c=n;this._emitter.emit(p.a.ERROR,c.error_type,c.error_detail,c.info)}else if(`extraData`in i){var u=n;this._emitter.emit(u.event,u.extraData)}break;case`logcat_callback`:i=n,l.a.emitter.emit(`log`,i.type,i.logcat);break;case`buffered_position_changed`:i=n,this._loading_controller.notifyBufferedPositionChanged(i.buffered_position_milliseconds/1e3)}},e.prototype._fillStatisticsInfo=function(e){if(e.playerType=`MSEPlayer`,!(this._media_element instanceof HTMLVideoElement))return e;var t=!0,n=0,r=0;if(this._media_element.getVideoPlaybackQuality){var i=this._media_element.getVideoPlaybackQuality();n=i.totalVideoFrames,r=i.droppedVideoFrames}else this._media_element.webkitDecodedFrameCount==null?t=!1:(n=this._media_element.webkitDecodedFrameCount,r=this._media_element.webkitDroppedFrameCount);return t&&(e.decodedFrames=n,e.droppedFrames=r),e},e}(),A=function(){function e(e,t){this.TAG=`MSEPlayer`,this._type=`MSEPlayer`,this._media_element=null,this._player_engine=null;var n=e.type.toLowerCase();if(n!==`mse`&&n!==`mpegts`&&n!==`m2ts`&&n!==`flv`)throw new _.b(`MSEPlayer requires an mpegts/m2ts/flv MediaDataSource input!`);if(t&&t.enableWorkerForMSE&&k.isSupported())try{this._player_engine=new k(e,t)}catch{l.a.e(this.TAG,`Error while initializing PlayerEngineDedicatedThread, fallback to PlayerEngineMainThread`),this._player_engine=new E(e,t)}else this._player_engine=new E(e,t)}return e.prototype.destroy=function(){this._player_engine.destroy(),this._player_engine=null,this._media_element=null},e.prototype.on=function(e,t){this._player_engine.on(e,t)},e.prototype.off=function(e,t){this._player_engine.off(e,t)},e.prototype.attachMediaElement=function(e){this._media_element=e,this._player_engine.attachMediaElement(e)},e.prototype.detachMediaElement=function(){this._media_element=null,this._player_engine.detachMediaElement()},e.prototype.load=function(){this._player_engine.load()},e.prototype.unload=function(){this._player_engine.unload()},e.prototype.play=function(){return this._player_engine.play()},e.prototype.pause=function(){this._player_engine.pause()},Object.defineProperty(e.prototype,`type`,{get:function(){return this._type},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`buffered`,{get:function(){return this._media_element.buffered},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`duration`,{get:function(){return this._media_element.duration},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`volume`,{get:function(){return this._media_element.volume},set:function(e){this._media_element.volume=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`muted`,{get:function(){return this._media_element.muted},set:function(e){this._media_element.muted=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`currentTime`,{get:function(){return this._media_element?this._media_element.currentTime:0},set:function(e){this._player_engine.seek(e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`mediaInfo`,{get:function(){return this._player_engine.mediaInfo},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`statisticsInfo`,{get:function(){return this._player_engine.statisticsInfo},enumerable:!1,configurable:!0}),e}(),j=function(){function e(e,t){this.TAG=`NativePlayer`,this._type=`NativePlayer`,this._emitter=new d.a,this._config=o(),typeof t==`object`&&Object.assign(this._config,t);var n=e.type.toLowerCase();if(n===`mse`||n===`mpegts`||n===`m2ts`||n===`flv`)throw new _.b(`NativePlayer does't support mse/mpegts/m2ts/flv MediaDataSource input!`);if(e.hasOwnProperty(`segments`))throw new _.b(`NativePlayer(${e.type}) doesn't support multipart playback!`);this.e={onvLoadedMetadata:this._onvLoadedMetadata.bind(this)},this._pendingSeekTime=null,this._statisticsReporter=null,this._mediaDataSource=e,this._mediaElement=null}return e.prototype.destroy=function(){this._emitter.emit(p.a.DESTROYING),this._mediaElement&&(this.unload(),this.detachMediaElement()),this.e=null,this._mediaDataSource=null,this._emitter.removeAllListeners(),this._emitter=null},e.prototype.on=function(e,t){var n=this;e===p.a.MEDIA_INFO?this._mediaElement!=null&&this._mediaElement.readyState!==0&&Promise.resolve().then((function(){n._emitter.emit(p.a.MEDIA_INFO,n.mediaInfo)})):e===p.a.STATISTICS_INFO&&this._mediaElement!=null&&this._mediaElement.readyState!==0&&Promise.resolve().then((function(){n._emitter.emit(p.a.STATISTICS_INFO,n.statisticsInfo)})),this._emitter.addListener(e,t)},e.prototype.off=function(e,t){this._emitter.removeListener(e,t)},e.prototype.attachMediaElement=function(e){if(this._mediaElement=e,e.addEventListener(`loadedmetadata`,this.e.onvLoadedMetadata),this._pendingSeekTime!=null)try{e.currentTime=this._pendingSeekTime,this._pendingSeekTime=null}catch{}},e.prototype.detachMediaElement=function(){this._mediaElement&&=(this._mediaElement.src=``,this._mediaElement.removeAttribute(`src`),this._mediaElement.removeEventListener(`loadedmetadata`,this.e.onvLoadedMetadata),null),this._statisticsReporter!=null&&(window.clearInterval(this._statisticsReporter),this._statisticsReporter=null)},e.prototype.load=function(){if(!this._mediaElement)throw new _.a(`HTMLMediaElement must be attached before load()!`);this._mediaElement.src=this._mediaDataSource.url,this._mediaElement.readyState>0&&(this._mediaElement.currentTime=0),this._mediaElement.preload=`auto`,this._mediaElement.load(),this._statisticsReporter=window.setInterval(this._reportStatisticsInfo.bind(this),this._config.statisticsInfoReportInterval)},e.prototype.unload=function(){this._mediaElement&&(this._mediaElement.src=``,this._mediaElement.removeAttribute(`src`)),this._statisticsReporter!=null&&(window.clearInterval(this._statisticsReporter),this._statisticsReporter=null)},e.prototype.play=function(){return this._mediaElement.play()},e.prototype.pause=function(){this._mediaElement.pause()},Object.defineProperty(e.prototype,`type`,{get:function(){return this._type},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`buffered`,{get:function(){return this._mediaElement.buffered},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`duration`,{get:function(){return this._mediaElement.duration},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`volume`,{get:function(){return this._mediaElement.volume},set:function(e){this._mediaElement.volume=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`muted`,{get:function(){return this._mediaElement.muted},set:function(e){this._mediaElement.muted=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`currentTime`,{get:function(){return this._mediaElement?this._mediaElement.currentTime:0},set:function(e){this._mediaElement?this._mediaElement.currentTime=e:this._pendingSeekTime=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`mediaInfo`,{get:function(){var e={mimeType:(this._mediaElement instanceof HTMLAudioElement?`audio/`:`video/`)+this._mediaDataSource.type};return this._mediaElement&&(e.duration=Math.floor(1e3*this._mediaElement.duration),this._mediaElement instanceof HTMLVideoElement&&(e.width=this._mediaElement.videoWidth,e.height=this._mediaElement.videoHeight)),e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,`statisticsInfo`,{get:function(){var e={playerType:this._type,url:this._mediaDataSource.url};if(!(this._mediaElement instanceof HTMLVideoElement))return e;var t=!0,n=0,r=0;if(this._mediaElement.getVideoPlaybackQuality){var i=this._mediaElement.getVideoPlaybackQuality();n=i.totalVideoFrames,r=i.droppedVideoFrames}else this._mediaElement.webkitDecodedFrameCount==null?t=!1:(n=this._mediaElement.webkitDecodedFrameCount,r=this._mediaElement.webkitDroppedFrameCount);return t&&(e.decodedFrames=n,e.droppedFrames=r),e},enumerable:!1,configurable:!0}),e.prototype._onvLoadedMetadata=function(e){this._pendingSeekTime!=null&&(this._mediaElement.currentTime=this._pendingSeekTime,this._pendingSeekTime=null),this._emitter.emit(p.a.MEDIA_INFO,this.mediaInfo)},e.prototype._reportStatisticsInfo=function(){this._emitter.emit(p.a.STATISTICS_INFO,this.statisticsInfo)},e}();r.a.install();var M={createPlayer:function(e,t){var n=e;if(typeof n!=`object`||!n)throw new _.b(`MediaDataSource must be an javascript object!`);if(!n.hasOwnProperty(`type`))throw new _.b(`MediaDataSource must has type field to indicate video file type!`);switch(n.type){case`mse`:case`mpegts`:case`m2ts`:case`flv`:return new A(n,t);default:return new j(n,t)}},isSupported:function(){return s.supportMSEH264Playback()},getFeatureList:function(){return s.getFeatureList()}};M.BaseLoader=c.a,M.LoaderStatus=c.c,M.LoaderErrors=c.b,M.Events=p.a,M.ErrorTypes=g.b,M.ErrorDetails=g.a,M.MSEPlayer=A,M.NativePlayer=j,M.LoggingControl=O.a,Object.defineProperty(M,`version`,{enumerable:!0,get:function(){return`1.8.0`}}),t.default=M}])}))})),fd=e=>e.toLocaleTimeString(`pt-BR`,{hour:`2-digit`,minute:`2-digit`}),pd=(e,t)=>{let n=Math.round((t.getTime()-e.getTime())/6e4);if(n<60)return`${n}min`;let r=Math.floor(n/60),i=n%60;return i>0?`${r}h${i}min`:`${r}h`};const md=(0,Q.memo)(function({channel:e,isVisible:t,onOpenGuide:n}){let[r,i]=(0,Q.useState)(null),[a,o]=(0,Q.useState)(!1),[s,c]=(0,Q.useState)([]),[l,u]=(0,Q.useState)(!0),[,d]=(0,Q.useState)(0),f=(0,Q.useCallback)(()=>{if(e&&(i(ld(e.id)),a)){let t=cd(e.id),n=new Date;c(t.programs.filter(e=>e.startTime>n).slice(0,5))}},[e,a]);if((0,Q.useEffect)(()=>{od();let t=Zu(t=>{e&&t===e.id&&(console.log(`[ProgramInfo] EPG atualizado para ${t}`),f(),u(!1),d(e=>e+1))});return()=>t()},[e,f]),(0,Q.useEffect)(()=>{if(!e)return;u(!0),ud(e.id).then(e=>{i(e),u(!1)}),f();let t=setInterval(f,3e4);return()=>clearInterval(t)},[e,f]),(0,Q.useEffect)(()=>{if(a&&e){let t=cd(e.id),n=new Date;c(t.programs.filter(e=>e.startTime>n).slice(0,5))}},[a,e]),!r?.current)return(0,$.jsx)(`div`,{className:`program-info ${t?`visible`:``}`,children:(0,$.jsxs)(`div`,{className:`program-content`,children:[(0,$.jsxs)(`div`,{className:`current-program`,children:[(0,$.jsxs)(`div`,{className:`program-now-badge`,children:[(0,$.jsx)(`span`,{className:`live-dot`}),l?`CARREGANDO...`:`AO VIVO`]}),(0,$.jsxs)(`div`,{className:`program-details`,children:[(0,$.jsx)(`h3`,{className:`program-title`,children:l?`Buscando programao...`:`Transmisso ao vivo`}),(0,$.jsx)(`p`,{className:`program-description`,children:l?`Aguarde...`:`Sem informao de programao`})]})]}),(0,$.jsx)(`div`,{className:`program-actions`,children:(0,$.jsxs)(`button`,{className:`program-btn guide-btn`,onClick:n,title:`Guia de programao`,children:[(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`rect`,{x:`3`,y:`4`,width:`18`,height:`18`,rx:`2`}),(0,$.jsx)(`path`,{d:`M3 10h18M9 4v18`})]}),(0,$.jsx)(`span`,{children:`Guia`})]})})]})});let{current:p,next:m,progress:h}=r;return(0,$.jsxs)(`div`,{className:`program-info ${t?`visible`:``} ${a?`expanded`:``}`,children:[(0,$.jsx)(`div`,{className:`program-progress-bar`,children:(0,$.jsx)(`div`,{className:`program-progress-fill`,style:{width:`${h}%`}})}),(0,$.jsxs)(`div`,{className:`program-content`,children:[(0,$.jsxs)(`div`,{className:`current-program`,children:[(0,$.jsxs)(`div`,{className:`program-now-badge`,children:[(0,$.jsx)(`span`,{className:`live-dot`}),`AGORA`]}),(0,$.jsxs)(`div`,{className:`program-details`,children:[(0,$.jsx)(`h3`,{className:`program-title`,children:p.title}),(0,$.jsxs)(`div`,{className:`program-meta`,children:[(0,$.jsxs)(`span`,{className:`program-time`,children:[fd(p.startTime),` - `,fd(p.endTime)]}),(0,$.jsx)(`span`,{className:`program-duration`,children:pd(p.startTime,p.endTime)}),p.category&&(0,$.jsx)(`span`,{className:`program-category`,children:p.category}),p.rating&&(0,$.jsx)(`span`,{className:`program-rating rating-${p.rating}`,children:p.rating})]}),p.description&&(0,$.jsx)(`p`,{className:`program-description`,children:p.description})]})]}),m&&(0,$.jsxs)(`div`,{className:`next-program`,children:[(0,$.jsx)(`div`,{className:`program-next-badge`,children:`A SEGUIR`}),(0,$.jsxs)(`div`,{className:`program-details`,children:[(0,$.jsx)(`h4`,{className:`program-title-small`,children:m.title}),(0,$.jsx)(`span`,{className:`program-time-small`,children:fd(m.startTime)})]})]}),(0,$.jsxs)(`div`,{className:`program-actions`,children:[(0,$.jsx)(`button`,{className:`program-btn expand-btn`,onClick:()=>o(!a),title:a?`Recolher`:`Ver mais`,children:(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:a?(0,$.jsx)(`path`,{d:`M18 15l-6-6-6 6`}):(0,$.jsx)(`path`,{d:`M6 9l6 6 6-6`})})}),(0,$.jsxs)(`button`,{className:`program-btn guide-btn`,onClick:n,title:`Guia de programao`,children:[(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`rect`,{x:`3`,y:`4`,width:`18`,height:`18`,rx:`2`}),(0,$.jsx)(`path`,{d:`M3 10h18M9 4v18`})]}),(0,$.jsx)(`span`,{children:`Guia`})]})]})]}),a&&(0,$.jsxs)(`div`,{className:`upcoming-programs`,children:[(0,$.jsx)(`h4`,{className:`upcoming-title`,children:`Prximos Programas`}),(0,$.jsx)(`div`,{className:`upcoming-list`,children:s.slice(1).map(e=>(0,$.jsxs)(`div`,{className:`upcoming-item`,children:[(0,$.jsx)(`span`,{className:`upcoming-time`,children:fd(e.startTime)}),(0,$.jsxs)(`div`,{className:`upcoming-info`,children:[(0,$.jsx)(`span`,{className:`upcoming-name`,children:e.title}),e.category&&(0,$.jsx)(`span`,{className:`upcoming-category`,children:e.category})]}),(0,$.jsx)(`span`,{className:`upcoming-duration`,children:pd(e.startTime,e.endTime)})]},e.id))})]})]})});var hd=e(dd(),1);const gd=(0,Q.memo)(function({channel:e,isTheaterMode:t,onToggleTheater:n,onOpenGuide:r}){let i=(0,Q.useRef)(null),a=(0,Q.useRef)(null),o=(0,Q.useRef)(null),s=(0,Q.useRef)(null),c=(0,Q.useRef)(!1),[l,u]=(0,Q.useState)(!0),[d,f]=(0,Q.useState)(!1),[p,m]=(0,Q.useState)(!1),[h,g]=(0,Q.useState)(()=>{let e=localStorage.getItem(`tv-volume`);return e?parseFloat(e):1}),_=(0,Q.useRef)(h),v=(0,Q.useRef)(d),y=(0,Q.useRef)(!1);(0,Q.useEffect)(()=>{_.current=h},[h]),(0,Q.useEffect)(()=>{v.current=d},[d]),(0,Q.useEffect)(()=>{y.current=p},[p]);let[b,x]=(0,Q.useState)(!1),[S,C]=(0,Q.useState)(!1),[w,T]=(0,Q.useState)(!1),[E,D]=(0,Q.useState)({isConnected:!1,deviceName:null,method:null}),[O,k]=(0,Q.useState)(!1),[A,j]=(0,Q.useState)(null),[M,N]=(0,Q.useState)(!1),[P,F]=(0,Q.useState)(!1),[I,L]=(0,Q.useState)(null),[R,z]=(0,Q.useState)(!0),[B,V]=(0,Q.useState)(null),ee=(0,Q.useRef)(null),H=(0,Q.useRef)(!1),te=(0,Q.useRef)(0);(0,Q.useEffect)(()=>{if(!e||!i.current)return;let t=i.current;if(F(!0),L(null),c.current=!1,te.current=0,o.current&&=(o.current.destroy(),null),s.current&&=(s.current.destroy(),null),e.url.endsWith(`.ts`)||e.url.includes(`.ts?`))if(hd.default.isSupported()){let n=e.url.trim();console.log(`[VideoPlayer] Initializing MPEGTS player for:`,n);let r=hd.default.createPlayer({type:`mpegts`,isLive:!0,url:n,cors:!0},{enableWorker:!0,lazyLoadMaxDuration:180,seekType:`range`});r.attachMediaElement(t),r.load();let a=()=>{if(!i.current)return;let e=i.current;console.log(`[VideoPlayer] Attempting play...`),e.play().then(()=>{console.log(`[VideoPlayer] Play success!`),u(!0),L(null)}).catch(t=>{console.log(`[VideoPlayer] Play failed (autoplay?), trying muted...`,t),e.muted=!0,f(!0),m(!0),e.play().then(()=>{console.log(`[VideoPlayer] Play success (muted)!`),u(!0),L(null)}).catch(e=>{console.error(`[VideoPlayer] Play failed completely:`,e)})})};return r.on(hd.default.Events.ERROR,(e,t)=>{console.error(`MPEGTS Error: ${e} - ${t}`),e===hd.default.ErrorTypes.NETWORK_ERROR?(te.current++,te.current>3?(L(`Erro de rede: ${t}`),F(!1)):r.load()):(L(`Erro de reproduo: ${t}`),F(!1))}),r.on(hd.default.Events.LOADING_COMPLETE,()=>{F(!1)}),t.addEventListener(`canplay`,()=>{F(!1),t.volume=_.current,t.muted||=v.current,a()},{once:!0}),s.current=r,a(),()=>{s.current&&=(s.current.destroy(),null)}}else{L(`Navegador no suporta mpegts.js`),F(!1);return}if(ku.isSupported()){let n=new ku({enableWorker:!0,lowLatencyMode:!0,backBufferLength:90});n.loadSource(Au(e.url)),n.attachMedia(t),n.on(ku.Events.MANIFEST_PARSED,()=>{F(!1),te.current=0,t.volume=_.current,t.muted=!1,t.play().catch(()=>{t.muted=!0,f(!0),m(!0),t.play().catch(()=>{})})}),n.on(ku.Events.ERROR,(e,t)=>{if(t.fatal){if(te.current++,te.current>3){L(`Erro ao carregar o canal. Tente novamente.`),F(!1);return}t.type===ku.ErrorTypes.NETWORK_ERROR?n.startLoad():t.type===ku.ErrorTypes.MEDIA_ERROR?n.recoverMediaError():(L(`Erro ao carregar o canal. Tente novamente.`),F(!1))}}),n.on(ku.Events.FRAG_LOADED,()=>{L(null),te.current=0}),n.on(ku.Events.LEVEL_LOADED,()=>{L(null),te.current=0}),o.current=n}else t.canPlayType(`application/vnd.apple.mpegurl`)?(t.src=Au(e.url),t.addEventListener(`loadedmetadata`,()=>{F(!1),t.volume=_.current,t.muted=!1,t.play().catch(()=>{t.muted=!0,f(!0),m(!0),t.play().catch(()=>{})})})):(L(`Seu navegador no suporta reproduo de vdeo HLS.`),F(!1));return()=>{o.current&&=(o.current.destroy(),null)}},[e]),(0,Q.useEffect)(()=>{i.current&&(i.current.volume=h,i.current.muted=d),localStorage.setItem(`tv-volume`,h.toString())},[h,d]),(0,Q.useEffect)(()=>{let t=i.current;if(!t)return;let n=()=>{u(!0),L(null),c.current=!1},r=()=>{u(!1),!c.current&&e&&t.readyState>=2&&t.play().catch(()=>{t.muted=!0,f(!0),m(!0),t.play().catch(()=>{})})},a=()=>F(!0),o=()=>{F(!1),L(null),t.paused&&e&&!c.current&&t.play().catch(()=>{t.muted=!0,f(!0),m(!0),t.play().catch(()=>{})})},s=()=>{F(!1),L(null),te.current=0},l=0,d=()=>{let e=Date.now();e-l<1e3||(l=e,L(e=>e&&null),te.current=0)};return t.addEventListener(`play`,n),t.addEventListener(`pause`,r),t.addEventListener(`waiting`,a),t.addEventListener(`canplay`,o),t.addEventListener(`playing`,s),t.addEventListener(`timeupdate`,d),()=>{t.removeEventListener(`play`,n),t.removeEventListener(`pause`,r),t.removeEventListener(`waiting`,a),t.removeEventListener(`canplay`,o),t.removeEventListener(`playing`,s),t.removeEventListener(`timeupdate`,d)}},[e]),(0,Q.useEffect)(()=>{if(!p)return;let e=()=>{let e=i.current;e&&y.current&&(e.muted=!1,f(!1),m(!1))};return document.addEventListener(`click`,e,{once:!0}),document.addEventListener(`keydown`,e,{once:!0}),document.addEventListener(`touchstart`,e,{once:!0}),()=>{document.removeEventListener(`click`,e),document.removeEventListener(`keydown`,e),document.removeEventListener(`touchstart`,e)}},[p]),(0,Q.useEffect)(()=>{let e=()=>{C(!!document.fullscreenElement)};return document.addEventListener(`fullscreenchange`,e),()=>document.removeEventListener(`fullscreenchange`,e)},[]),(0,Q.useEffect)(()=>{let e=i.current;if(!e)return;let t=()=>T(!0),n=()=>T(!1);return e.addEventListener(`enterpictureinpicture`,t),e.addEventListener(`leavepictureinpicture`,n),()=>{e.removeEventListener(`enterpictureinpicture`,t),e.removeEventListener(`leavepictureinpicture`,n)}},[]),(0,Q.useEffect)(()=>{let e=i.current;if(!e)return;let t=()=>{if(e.videoWidth&&e.videoHeight){let t=e.videoHeight,n=``;n=t>=2160?`4K`:t>=1440?`2K`:t>=1080?`1080p`:t>=720?`720p`:t>=480?`480p`:t>=360?`360p`:`${t}p`,V(n)}else V(null)};e.addEventListener(`loadedmetadata`,t),e.addEventListener(`resize`,t);let n=setInterval(t,2e3);return t(),()=>{e.removeEventListener(`loadedmetadata`,t),e.removeEventListener(`resize`,t),clearInterval(n)}},[e]),(0,Q.useEffect)(()=>{let e=Mu.onStateChange(e=>{D(e)});return D(Mu.getState()),e},[]);let ne=(0,Q.useCallback)(()=>{let e=i.current;e&&(e.paused?(c.current=!1,e.play()):(c.current=!0,e.pause()))},[]),re=(0,Q.useCallback)(()=>{m(!1),f(e=>!e)},[]),ie=(0,Q.useCallback)(async()=>{let e=a.current;if(e)try{document.fullscreenElement?await document.exitFullscreen():await e.requestFullscreen()}catch(e){console.error(`Fullscreen error:`,e)}},[]),ae=(0,Q.useCallback)(async()=>{let e=i.current;if(e)try{document.pictureInPictureElement?await document.exitPictureInPicture():document.pictureInPictureEnabled&&await e.requestPictureInPicture()}catch(e){console.error(`PiP error:`,e)}},[]),oe=(0,Q.useCallback)(async()=>{if(E.isConnected){Mu.stopCasting(),j(`Transmisso encerrada`),setTimeout(()=>j(null),3e3);return}k(!0)},[E.isConnected]),se=(0,Q.useCallback)(async t=>{if(!e)return;if(t===`openExternal`){N(!0);return}let n=await Mu.cast(t,e.url,e.name,i.current||void 0,e.logo);j(n.message),setTimeout(()=>j(null),4e3),(n.success||t===`copyLink`||t===`share`)&&k(!1)},[e]),U=(0,Q.useCallback)(e=>{Mu.openInExternalPlayer(e),j(`Abrindo player externo...`),setTimeout(()=>j(null),3e3),N(!1),k(!1)},[]),ce=(0,Q.useCallback)(()=>{x(e=>!e)},[]),W=(0,Q.useCallback)(e=>{let t=parseFloat(e.target.value);g(t),t>0&&f(!1)},[]),le=(0,Q.useCallback)(()=>{o.current&&e&&(L(null),F(!0),o.current.loadSource(e.url))},[e]);(0,Q.useEffect)(()=>{H.current=l},[l]);let G=(0,Q.useCallback)(()=>{z(!0),ee.current&&clearTimeout(ee.current),ee.current=window.setTimeout(()=>{H.current&&z(!1)},5e3)},[]);(0,Q.useEffect)(()=>{let e=e=>{switch(([`ArrowUp`,`ArrowDown`,`ArrowLeft`,`ArrowRight`,`Space`,`Enter`,`Escape`].includes(e.key)||e.key.length===1)&&G(),e.key){case`f`:e.preventDefault(),ie();break;case`m`:e.preventDefault(),re();break;case`c`:e.preventDefault(),oe();break;case`ArrowUp`:e.preventDefault(),g(e=>Math.min(1,e+.1));break;case`ArrowDown`:e.preventDefault(),g(e=>Math.max(0,e-.1));break;case`Escape`:document.fullscreenElement&&document.exitFullscreen();break}};return document.addEventListener(`keydown`,e),()=>document.removeEventListener(`keydown`,e)},[G,ne,ie,re,oe]),(0,Q.useEffect)(()=>{e&&G()},[e,G]),(0,Q.useEffect)(()=>{let e=a.current;if(!e)return;let t=()=>{G()};return e.addEventListener(`dpad-enter`,t),()=>e.removeEventListener(`dpad-enter`,t)},[G]);let ue=(0,Q.useCallback)(()=>{R?(z(!1),ee.current&&clearTimeout(ee.current)):G()},[R,G]),K=(0,Q.useCallback)(()=>{ie()},[ie]);return(0,$.jsx)(`div`,{ref:a,className:`video-player-container ${t?`theater`:``} ${R?`show-controls`:``}`,onMouseMove:G,onMouseLeave:()=>l&&z(!1),children:e?(0,$.jsxs)($.Fragment,{children:[(0,$.jsx)(md,{channel:e,isVisible:R,onOpenGuide:r}),(0,$.jsx)(`video`,{ref:i,className:`video-element ${b?`mirrored`:``}`,playsInline:!0,onClick:ue,onDoubleClick:K}),R&&!P&&!I&&(0,$.jsx)(`button`,{className:`center-play-btn`,onClick:()=>{G(),ne()},"data-focusable":`true`,"data-focus-key":`btn-play-center`,"aria-label":l?`Pausar vdeo`:`Reproduzir vdeo`,children:l?(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`currentColor`,children:[(0,$.jsx)(`rect`,{x:`6`,y:`4`,width:`4`,height:`16`,rx:`1`}),(0,$.jsx)(`rect`,{x:`14`,y:`4`,width:`4`,height:`16`,rx:`1`})]}):(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`currentColor`,children:(0,$.jsx)(`path`,{d:`M8 5v14l11-7z`})})}),P&&(0,$.jsxs)(`div`,{className:`loading-overlay`,children:[(0,$.jsxs)(`div`,{className:`loader`,children:[(0,$.jsx)(`div`,{className:`loader-ring`}),(0,$.jsx)(`div`,{className:`loader-ring`}),(0,$.jsx)(`div`,{className:`loader-ring`})]}),(0,$.jsxs)(`p`,{children:[`Carregando `,e.name,`...`]})]}),I&&(0,$.jsxs)(`div`,{className:`error-overlay`,children:[(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`circle`,{cx:`12`,cy:`12`,r:`10`}),(0,$.jsx)(`path`,{d:`M12 8v4M12 16h.01`})]}),(0,$.jsx)(`p`,{children:I}),(0,$.jsx)(`button`,{onClick:le,className:`retry-btn`,children:`Tentar novamente`})]}),(0,$.jsxs)(`div`,{className:`video-controls`,onMouseMove:G,children:[(0,$.jsxs)(`div`,{className:`controls-left`,children:[(0,$.jsxs)(`div`,{className:`volume-control`,children:[(0,$.jsx)(`button`,{className:`control-btn`,onClick:()=>{G(),re()},title:d?`Ativar som (M)`:`Mudo (M)`,"data-focusable":`true`,"data-focus-key":`btn-mute`,children:d||h===0?(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:(0,$.jsx)(`path`,{d:`M11 5L6 9H2v6h4l5 4V5zM23 9l-6 6M17 9l6 6`})}):(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:(0,$.jsx)(`path`,{d:`M11 5L6 9H2v6h4l5 4V5zM19.07 4.93a10 10 0 010 14.14M15.54 8.46a5 5 0 010 7.07`})})}),(0,$.jsx)(`input`,{type:`range`,min:`0`,max:`1`,step:`0.01`,value:d?0:h,onChange:e=>{G(),W(e)},className:`volume-slider`,title:`Volume: ${Math.round(h*100)}%`,"data-focusable":`true`,"data-focus-key":`volume-slider`})]}),(0,$.jsxs)(`div`,{className:`channel-indicator`,children:[(0,$.jsx)(`span`,{className:`live-badge`,children:`AO VIVO`}),(0,$.jsxs)(`div`,{className:`channel-info`,children:[(0,$.jsx)(`span`,{className:`channel-name`,children:e.name}),B&&(0,$.jsx)(`span`,{className:`video-resolution`,children:B})]})]})]}),(0,$.jsxs)(`div`,{className:`controls-right`,children:[(0,$.jsx)(`button`,{className:`control-btn ${b?`active`:``}`,onClick:()=>{G(),ce()},title:`Espelhar vdeo (R)`,"data-focusable":`true`,"data-focus-key":`btn-mirror`,children:(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`path`,{d:`M8 3H5a2 2 0 00-2 2v14a2 2 0 002 2h3M16 3h3a2 2 0 012 2v14a2 2 0 01-2 2h-3M12 3v18`}),(0,$.jsx)(`path`,{d:`M8 12l4-4 4 4M8 12l4 4 4-4`})]})}),(0,$.jsx)(`button`,{className:`control-btn ${w?`active`:``}`,onClick:()=>{G(),ae()},title:`Picture in Picture (P)`,"data-focusable":`true`,"data-focus-key":`btn-pip`,children:(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`rect`,{x:`2`,y:`3`,width:`20`,height:`14`,rx:`2`}),(0,$.jsx)(`rect`,{x:`11`,y:`9`,width:`9`,height:`6`,rx:`1`})]})}),(0,$.jsx)(`button`,{className:`control-btn cast-btn ${E.isConnected?`active casting`:``}`,onClick:()=>{G(),oe()},title:E.isConnected?`Transmitindo para ${E.deviceName}`:`Transmitir (C)`,"data-focusable":`true`,"data-focus-key":`btn-cast`,children:(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`path`,{d:`M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6`}),(0,$.jsx)(`circle`,{cx:`2`,cy:`20`,r:`2`,fill:`currentColor`})]})}),(0,$.jsx)(`button`,{className:`control-btn ${t?`active`:``}`,onClick:()=>{G(),n()},title:`Modo Teatro (T)`,"data-focusable":`true`,"data-focus-key":`btn-theater`,children:(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:(0,$.jsx)(`rect`,{x:`2`,y:`6`,width:`20`,height:`12`,rx:`2`})})}),(0,$.jsx)(`button`,{className:`control-btn ${S?`active`:``}`,onClick:()=>{G(),ie()},title:`Tela cheia (F)`,"data-focusable":`true`,"data-focus-key":`btn-fullscreen`,children:S?(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:(0,$.jsx)(`path`,{d:`M8 3v3a2 2 0 01-2 2H3M21 8h-3a2 2 0 01-2-2V3M3 16h3a2 2 0 012 2v3M16 21v-3a2 2 0 012-2h3`})}):(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:(0,$.jsx)(`path`,{d:`M8 3H5a2 2 0 00-2 2v3M21 8V5a2 2 0 00-2-2h-3M3 16v3a2 2 0 002 2h3M16 21h3a2 2 0 002-2v-3`})})})]})]}),A&&(0,$.jsxs)(`div`,{className:`cast-message`,children:[(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`path`,{d:`M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6`}),(0,$.jsx)(`circle`,{cx:`2`,cy:`20`,r:`2`,fill:`currentColor`})]}),(0,$.jsx)(`span`,{children:A})]}),E.isConnected&&(0,$.jsxs)(`div`,{className:`cast-active-indicator`,children:[(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`path`,{d:`M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6`}),(0,$.jsx)(`circle`,{cx:`2`,cy:`20`,r:`2`,fill:`currentColor`})]}),(0,$.jsxs)(`span`,{children:[`Transmitindo para `,E.deviceName]}),(0,$.jsx)(`button`,{onClick:()=>Mu.stopCasting(),children:`Parar`})]}),O&&(0,$.jsx)(`div`,{className:`cast-modal-overlay`,onClick:()=>{k(!1),N(!1)},children:(0,$.jsxs)(`div`,{className:`cast-modal`,onClick:e=>e.stopPropagation(),children:[M?(0,$.jsxs)($.Fragment,{children:[(0,$.jsx)(`h3`,{children:`Abrir em player externo`}),(0,$.jsx)(`p`,{children:`Escolha um player para abrir o stream`}),(0,$.jsxs)(`div`,{className:`cast-options external-players`,children:[Mu.getExternalPlayerLinks(e.url).map(e=>(0,$.jsxs)(`button`,{className:`cast-option`,onClick:()=>U(e.url),children:[(0,$.jsx)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:(0,$.jsx)(`polygon`,{points:`5 3 19 12 5 21 5 3`})}),(0,$.jsx)(`span`,{children:e.name}),(0,$.jsx)(`small`,{children:e.platforms.join(`, `)})]},e.name)),(0,$.jsxs)(`button`,{className:`cast-option copy-url`,onClick:()=>se(`copyLink`),children:[(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`rect`,{x:`9`,y:`9`,width:`13`,height:`13`,rx:`2`,ry:`2`}),(0,$.jsx)(`path`,{d:`M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1`})]}),(0,$.jsx)(`span`,{children:`Copiar URL do stream`}),(0,$.jsx)(`small`,{children:`Para colar manualmente no player`})]})]}),(0,$.jsx)(`button`,{className:`cast-modal-back`,onClick:()=>N(!1),children:` Voltar`})]}):(0,$.jsxs)($.Fragment,{children:[(0,$.jsx)(`h3`,{children:`Transmitir para dispositivo`}),(0,$.jsxs)(`p`,{children:[`Escolha como deseja transmitir "`,e.name,`"`]}),(0,$.jsx)(`div`,{className:`cast-options`,children:Mu.getAvailableMethods().map(e=>(0,$.jsxs)(`button`,{className:`cast-option`,onClick:()=>se(e.method),children:[e.icon===`chromecast`&&(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`path`,{d:`M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6`}),(0,$.jsx)(`circle`,{cx:`2`,cy:`20`,r:`2`,fill:`currentColor`})]}),e.icon===`airplay`&&(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`path`,{d:`M5 17H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-1`}),(0,$.jsx)(`polygon`,{points:`12 15 17 21 7 21 12 15`})]}),e.icon===`tv`&&(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`rect`,{x:`2`,y:`3`,width:`20`,height:`14`,rx:`2`}),(0,$.jsx)(`path`,{d:`M8 21h8M12 17v4`})]}),e.icon===`share`&&(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`circle`,{cx:`18`,cy:`5`,r:`3`}),(0,$.jsx)(`circle`,{cx:`6`,cy:`12`,r:`3`}),(0,$.jsx)(`circle`,{cx:`18`,cy:`19`,r:`3`}),(0,$.jsx)(`line`,{x1:`8.59`,y1:`13.51`,x2:`15.42`,y2:`17.49`}),(0,$.jsx)(`line`,{x1:`15.41`,y1:`6.51`,x2:`8.59`,y2:`10.49`})]}),e.icon===`copy`&&(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`rect`,{x:`9`,y:`9`,width:`13`,height:`13`,rx:`2`,ry:`2`}),(0,$.jsx)(`path`,{d:`M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1`})]}),e.icon===`external`&&(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`2`,children:[(0,$.jsx)(`path`,{d:`M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6`}),(0,$.jsx)(`polyline`,{points:`15 3 21 3 21 9`}),(0,$.jsx)(`line`,{x1:`10`,y1:`14`,x2:`21`,y2:`3`})]}),(0,$.jsx)(`span`,{children:e.name}),(0,$.jsx)(`small`,{children:e.description})]},e.method))})]}),(0,$.jsx)(`button`,{className:`cast-modal-close`,onClick:()=>{k(!1),N(!1)},children:`Cancelar`})]})})]}):(0,$.jsx)(`div`,{className:`no-channel`,children:(0,$.jsxs)(`div`,{className:`no-channel-content`,children:[(0,$.jsxs)(`svg`,{viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,strokeWidth:`1.5`,children:[(0,$.jsx)(`rect`,{x:`2`,y:`4`,width:`20`,height:`16`,rx:`2`}),(0,$.jsx)(`path`,{d:`M10 9l5 3-5 3V9z`})]}),(0,$.jsx)(`h2`,{children:`Selecione um canal`}),(0,$.jsx)(`p`,{children:`Escolha um canal na lista ao lado para comear a assistir`})]})})})});export{Zu as a,cd as i,dd as n,Nu as o,od as r,ku as s,gd as t};